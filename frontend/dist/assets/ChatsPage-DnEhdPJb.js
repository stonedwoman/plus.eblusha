const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-C2mnFpee.js","assets/index-Dzj6CUod.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BSSLuA4h.css","assets/index-DpPLIr_7.js","assets/index-DqkCZ1FC.css"])))=>i.map(i=>d[i]);
import{e as vr,f as Eo,g as br,h as ga,n as vn,d as ae,i as Ao,_ as Ha,s as _e,u as Jn,j as To,k as ma,o as Do,l as No,m as ya,p as xa,q as va,t as Lo,v as zo,w as Po,x as Uo,y as Ho,z as Wo,A as Bo,B as $o,D as _o,E as Oo,F as Fo,G as Xo,H as Yo,I as Go,J as qo,K as Vo,L as Wr,M as ba,P as Ko,Q as Qo,R as Jo,S as Zo,T as ec,U as wa}from"./index-Dzj6CUod.js";import{r as a,j as e,b as mr,c as tc}from"./vendor-query-D8-W16Rz.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nc=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),rc=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(l,h,y)=>y?y.toUpperCase():h.toLowerCase()),ja=s=>{const l=rc(s);return l.charAt(0).toUpperCase()+l.slice(1)},Wa=(...s)=>s.filter((l,h,y)=>!!l&&l.trim()!==""&&y.indexOf(l)===h).join(" ").trim(),ic=s=>{for(const l in s)if(l.startsWith("aria-")||l==="role"||l==="title")return!0};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var sc={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ac=a.forwardRef(({color:s="currentColor",size:l=24,strokeWidth:h=2,absoluteStrokeWidth:y,className:m="",children:S,iconNode:x,...M},Q)=>a.createElement("svg",{ref:Q,...sc,width:l,height:l,stroke:s,strokeWidth:y?Number(h)*24/Number(l):h,className:Wa("lucide",m),...!S&&!ic(M)&&{"aria-hidden":"true"},...M},[...x.map(([T,_])=>a.createElement(T,_)),...Array.isArray(S)?S:[S]]));/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=(s,l)=>{const h=a.forwardRef(({className:y,...m},S)=>a.createElement(ac,{ref:S,iconNode:l,className:Wa(`lucide-${nc(ja(s))}`,`lucide-${s}`,y),...m}));return h.displayName=ja(s),h};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oc=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],cc=xe("arrow-left",oc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lc=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],dc=xe("bell-ring",lc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uc=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],hc=xe("check",uc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fc=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],pc=xe("chevron-left",fc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gc=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],mc=xe("chevron-right",gc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yc=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ca=xe("circle-check-big",yc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xc=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],vc=xe("circle-plus",xc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bc=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],us=xe("cloud-upload",bc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wc=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],jc=xe("copy",wc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cc=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],yr=xe("ellipsis-vertical",Cc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],kc=xe("lock-open",Sc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ic=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Sa=xe("lock",Ic);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mc=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],hs=xe("log-out",Mc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rc=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],ka=xe("maximize-2",Rc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ec=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Ac=xe("mic",Ec);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tc=[["path",{d:"M5 12h14",key:"1ays0h"}]],Dc=xe("minus",Tc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nc=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],Lc=xe("paperclip",Nc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zc=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],fs=xe("phone-off",zc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pc=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],ps=xe("phone",Pc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uc=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Hc=xe("reply",Uc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wc=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ia=xe("rotate-ccw",Wc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bc=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ma=xe("send",Bc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $c=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Ra=xe("square-pen",$c);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _c=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Oc=xe("square",_c);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fc=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ea=xe("trash-2",Fc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xc=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],Aa=xe("undo-2",Xc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ta=xe("user-plus",Yc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],qc=xe("users",Gc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vc=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],gs=xe("video",Vc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kc=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Lt=xe("x",Kc);async function Da(s={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const l=s.audio!==!1,h=!!s.video;if(!l&&!h)return{ok:!0};const y={audio:l,video:h};let m=null;try{return m=await navigator.mediaDevices.getUserMedia(y),{ok:!0}}catch(S){return{ok:!1,error:S??new Error("Unknown media error")}}finally{m&&m.getTracks().forEach(S=>{try{S.stop()}catch{}})}}function Ti(s){if(!s)return null;if(s.startsWith("blob:")||s.startsWith("data:")||s.startsWith("/"))return s;let l;try{l=new URL(s)}catch{return s}if(l.pathname.startsWith("/api/files/"))return`${l.pathname}${l.search||""}${l.hash||""}`;const h=l.pathname.split("/").filter(Boolean).map(m=>encodeURIComponent(decodeURIComponent(m))).join("/");if(!h)return s;const y=`${l.search||""}${l.hash||""}`;return`/api/files/${h}${y}`}function Qc(s){let l=0;for(let x=0;x<s.length;x++)l=s.charCodeAt(x)+((l<<5)-l);const h=Math.abs(l),y=24+h%18-9,m=60+h%15,S=30+h%12;return`hsl(${y} ${m}% ${S}%)`}const Jc=3,ms=[500,1500,3e3];function et({name:s,size:l=40,id:h=s,presence:y,avatarUrl:m}){const S=Qc(h),x=(s||"?").trim().charAt(0).toUpperCase(),M=!!m?.startsWith("emoji:"),Q=M?m.slice(6):null,[T,_]=a.useState(!1),[W,J]=a.useState(0),[he,D]=a.useState(null),G=a.useRef(null),P=a.useMemo(()=>{if(!m||M)return m??null;if(m.startsWith("data:")||typeof window>"u")return m;const pe=Ti(m);if(pe&&pe!==m)return pe;try{if(m.startsWith("http://")||m.startsWith("https://"))return m;const ge=window.location,re=new URL(m,ge.origin);return re.host===ge.host&&re.protocol!==ge.protocol&&(re.protocol=ge.protocol),re.toString()}catch{return m}},[m,M]),fe=a.useMemo(()=>{if(!y)return null;switch(y){case"ONLINE":return"#22c55e";case"IN_CALL":return"#ef4444";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[y]);a.useEffect(()=>{_(!1),J(0),D(null),G.current&&(clearTimeout(G.current),G.current=null)},[m]),a.useEffect(()=>{P&&!M&&D(P)},[P,M]);const Se=()=>{if(W<Jc&&P&&!M){const pe=ms[W]||ms[ms.length-1];G.current=setTimeout(()=>{try{if(P.startsWith("data:"))D(P);else{const ge=new URL(P,typeof window<"u"?window.location.origin:void 0);ge.searchParams.set("_retry",String(W+1)),ge.searchParams.set("_t",String(Date.now())),D(ge.toString())}J(ge=>ge+1)}catch(ge){console.warn("[Avatar] Failed to parse URL for retry:",P,ge),D(P),J(re=>re+1)}},pe)}else _(!0)};a.useEffect(()=>()=>{G.current&&clearTimeout(G.current)},[]);const ot=he&&!M&&!T;return e.jsxs("div",{style:{width:l,height:l,borderRadius:"50%",background:S,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[ot?e.jsx("img",{src:he,alt:s,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:Se,onLoad:()=>{W>0&&J(0)}}):M?e.jsx("span",{style:{fontSize:Math.floor(l*.6)},children:Q}):x,fe&&e.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(l*.28)),height:Math.max(8,Math.floor(l*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:fe}})]})}const ys=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],xs=[4,8,14],Kt=24,on=80;function Zc({open:s,image:l,onClose:h,onApply:y}){const[m,S]=a.useState(null),[x,M]=a.useState({width:0,height:0}),[Q,T]=a.useState(1),[_,W]=a.useState({x:0,y:0}),[J,he]=a.useState({width:0,height:0}),[D,G]=a.useState({x:0,y:0,width:0,height:0}),[P,fe]=a.useState("crop"),[Se,ot]=a.useState(ys[0]),[pe,ge]=a.useState(xs[1]),[re,We]=a.useState([]),[Ae,Te]=a.useState(null),[zt,wt]=a.useState(()=>typeof window<"u"&&window.innerWidth<=768),[Ce,tt]=a.useState(!1),nt=a.useRef(null),ct=a.useRef(null),Re=a.useRef(null),Z=a.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),Ee=a.useRef(null),Yt=a.useRef(null),Qt=a.useRef(null),jt=s&&!!l&&!!m&&x.width>0&&x.height>0;a.useEffect(()=>{const g=()=>wt(window.innerWidth<=768);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]);const lt=async()=>{if(!m||!Re.current||Ce)return;tt(!0);const g=D.width/D.height,L=Math.max(D.x,_.x),E=Math.max(D.y,_.y),V=Math.min(D.x+D.width,_.x+J.width),I=Math.min(D.y+D.height,_.y+J.height),q=V-L,te=I-E,B=m.naturalWidth/J.width,Ne=m.naturalHeight/J.height;let Le=(L-_.x)*B,ke=(E-_.y)*Ne,ze=q*B,rt=te*Ne;ze/rt>g?ze=rt*g:rt=ze/g;const Jt=m.naturalWidth,R=m.naturalHeight;let Ct=Math.max(0,Le),yt=Math.max(0,ke),Xe=Math.max(1,Math.min(ze,Jt-Ct)),we=Math.max(1,Math.min(rt,R-yt));const Un=Xe/we;Math.abs(Un-g)>.01&&(Un>g?Xe=we*g:we=Xe/g,Xe=Math.max(1,Math.min(Xe,Jt-Ct)),we=Math.max(1,Math.min(we,R-yt)));const Rt=document.createElement("canvas"),Ut=Math.max(1,Math.round(Xe)),St=Math.max(1,Math.round(we));Rt.width=Ut,Rt.height=St;const ve=Rt.getContext("2d");if(!ve){tt(!1);return}ve.drawImage(m,Ct,yt,Xe,we,0,0,Ut,St);const ut=Ut/q,Et=St/te;ve.lineCap="round",ve.lineJoin="round";const wn=[...re,...Ae?[Ae]:[]];for(const ht of wn){if(!ht.points.length)continue;ve.strokeStyle=ht.color,ve.lineWidth=ht.size*((ut+Et)/2),ve.beginPath();const ft=ht.points[0],Ye=(ft.x-L)*ut,Pe=(ft.y-E)*Et;ve.moveTo(Ye,Pe);for(let At=1;At<ht.points.length;At++){const vt=ht.points[At];ve.lineTo((vt.x-L)*ut,(vt.y-E)*Et)}ve.stroke()}const xt=new Image;xt.src=Rt.toDataURL(),await new Promise(ht=>{xt.onload=()=>{S(xt);const ft=xt.naturalWidth/xt.naturalHeight;let Ye,Pe;if(zt){const kt=window.innerWidth,jn=window.innerHeight-200-60,Wn=kt;ft>Wn/jn?(Ye=Wn,Pe=Wn/ft):(Pe=jn,Ye=jn*ft)}else{const kt=Math.min(window.innerWidth-64,720),je=Math.min(window.innerHeight-200,520);ft>kt/je?(Ye=Math.max(280,kt),Pe=Ye/ft):(Pe=Math.max(220,je),Ye=Pe*ft)}M({width:Ye,height:Pe});const At=Ye/xt.naturalWidth;T(At),he({width:Ye,height:Pe}),W({x:0,y:0});const vt=2,er=Math.max(on,Ye-vt*2),Zt=Math.max(on,Pe-vt*2);G({x:vt,y:vt,width:er,height:Zt});const Hn=Ye/Ut,jr=Pe/St,Cr=wn.map(kt=>({...kt,points:kt.points.map(je=>{const qt=(je.x-L)*ut,Sr=(je.y-E)*Et,jn=qt*Hn,Wn=Sr*jr;return{x:jn,y:Wn}})}));We(Cr.filter(kt=>kt.points.every(je=>je.x>=0&&je.x<=Ye&&je.y>=0&&je.y<=Pe))),Te(null),setTimeout(()=>{z()},0);const Or=performance.now(),tr=300,hn=kt=>{const je=kt-Or;Math.min(je/tr,1)<1?Qt.current=requestAnimationFrame(hn):(tt(!1),Qt.current=null,setTimeout(()=>{z()},0))};Qt.current=requestAnimationFrame(hn),ht()}})};a.useEffect(()=>()=>{Qt.current&&cancelAnimationFrame(Qt.current)},[]),a.useEffect(()=>{if(!s||!l){S(null),We([]),Te(null),tt(!1);return}const g=new Image;return g.crossOrigin="anonymous",g.onload=()=>{if(S(g),zt){const L=window.innerWidth,q=window.innerHeight-200-60,te=L;let B=g.naturalWidth,Ne=g.naturalHeight;const Le=te/B,ke=q/Ne,ze=Math.min(Le,ke);B=g.naturalWidth*ze,Ne=g.naturalHeight*ze,M({width:te,height:q}),T(ze),he({width:B,height:Ne});const rt={x:(te-B)/2,y:(q-Ne)/2};W(rt);const Gt=2;G({x:Gt,y:Gt,width:te-Gt*2,height:q-Gt*2})}else{const L=Math.min(window.innerWidth-64,720),E=Math.min(window.innerHeight-200,520);let V=g.naturalWidth,I=g.naturalHeight;if(V>L){const ke=L/V;V*=ke,I*=ke}if(I>E){const ke=E/I;V*=ke,I*=ke}V=Math.max(280,V),I=Math.max(220,I),M({width:V,height:I});const q=Math.max(V/g.naturalWidth,I/g.naturalHeight);T(q);const te=g.naturalWidth*q,B=g.naturalHeight*q;he({width:te,height:B});const Ne={x:(V-te)/2,y:(I-B)/2};W(Ne);const Le=2;G({x:Le,y:Le,width:V-Le*2,height:I-Le*2})}We([]),Te(null),fe("crop"),tt(!1)},g.src=l.previewUrl,Yt.current=()=>{g.src=""},()=>{Yt.current?.(),Yt.current=null}},[s,l?.id,l?.previewUrl,zt]),a.useEffect(()=>{s||(We([]),Te(null),tt(!1))},[s]);const z=()=>{const g=ct.current;if(!g||x.width===0||x.height===0)return;const L=g.getContext("2d");if(!L)return;const E=window.devicePixelRatio||1;(g.width!==x.width*E||g.height!==x.height*E)&&(g.width=x.width*E,g.height=x.height*E,g.style.width=`${x.width}px`,g.style.height=`${x.height}px`),L.save(),L.scale(E,E),L.clearRect(0,0,x.width,x.height);const V=Ae?[...re,Ae]:re;L.lineCap="round",L.lineJoin="round";for(const I of V)if(I.points.length!==0){L.strokeStyle=I.color,L.lineWidth=I.size,L.beginPath(),L.moveTo(I.points[0].x,I.points[0].y);for(let q=1;q<I.points.length;q++)L.lineTo(I.points[q].x,I.points[q].y);L.stroke()}L.restore()};a.useEffect(()=>{z()},[re,Ae,x.width,x.height]),a.useEffect(()=>{const g=L=>{s&&L.key==="Escape"&&(L.preventDefault(),h())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[s,h]);const X=(g,L,E)=>{const I=Kt/2;return Math.abs(g-E.x)<I&&Math.abs(L-E.y)<I?"nw":Math.abs(g-(E.x+E.width))<I&&Math.abs(L-E.y)<I?"ne":Math.abs(g-E.x)<I&&Math.abs(L-(E.y+E.height))<I?"sw":Math.abs(g-(E.x+E.width))<I&&Math.abs(L-(E.y+E.height))<I?"se":Math.abs(g-E.x)<I&&L>=E.y&&L<=E.y+E.height?"w":Math.abs(g-(E.x+E.width))<I&&L>=E.y&&L<=E.y+E.height?"e":Math.abs(L-E.y)<I&&g>=E.x&&g<=E.x+E.width?"n":Math.abs(L-(E.y+E.height))<I&&g>=E.x&&g<=E.x+E.width?"s":g>=E.x&&g<=E.x+E.width&&L>=E.y&&L<=E.y+E.height?"move":null},oe=g=>{const q=x.width-2,te=x.height-2,B=Math.max(2,Math.min(q-g.width,g.x)),Ne=Math.max(2,Math.min(te-g.height,g.y)),Le=Math.max(on,Math.min(q-B,g.width)),ke=Math.max(on,Math.min(te-Ne,g.height));return{x:B,y:Ne,width:Le,height:ke}},ye=g=>{if(P!=="crop"||Ce||!nt.current)return;g.preventDefault();const L=nt.current.getBoundingClientRect(),E=g.clientX-L.left,V=g.clientY-L.top,I=X(E,V,D);I&&(nt.current.setPointerCapture(g.pointerId),Z.current={type:I==="move"?"move":"resize",handle:I!=="move"?I:void 0,startX:g.clientX,startY:g.clientY,initial:{...D}})},Ge=g=>{if(P!=="crop"||!Z.current.type||Ce||(g.preventDefault(),!nt.current?.getBoundingClientRect()))return;const E=g.clientX-Z.current.startX,V=g.clientY-Z.current.startY,I=E,q=V;if(Z.current.type==="move"){const te={x:Z.current.initial.x+I,y:Z.current.initial.y+q,width:Z.current.initial.width,height:Z.current.initial.height};G(oe(te))}else if(Z.current.type==="resize"&&Z.current.handle){const te=Z.current.handle;let B={...Z.current.initial};te==="nw"?(B.x=Z.current.initial.x+I,B.y=Z.current.initial.y+q,B.width=Z.current.initial.width-I,B.height=Z.current.initial.height-q):te==="ne"?(B.y=Z.current.initial.y+q,B.width=Z.current.initial.width+I,B.height=Z.current.initial.height-q):te==="sw"?(B.x=Z.current.initial.x+I,B.width=Z.current.initial.width-I,B.height=Z.current.initial.height+q):te==="se"?(B.width=Z.current.initial.width+I,B.height=Z.current.initial.height+q):te==="n"?(B.y=Z.current.initial.y+q,B.height=Z.current.initial.height-q):te==="s"?B.height=Z.current.initial.height+q:te==="w"?(B.x=Z.current.initial.x+I,B.width=Z.current.initial.width-I):te==="e"&&(B.width=Z.current.initial.width+I),B.width<on&&((te==="nw"||te==="w"||te==="sw")&&(B.x=Z.current.initial.x+Z.current.initial.width-on),B.width=on),B.height<on&&((te==="nw"||te==="n"||te==="ne")&&(B.y=Z.current.initial.y+Z.current.initial.height-on),B.height=on),G(oe(B))}},De=async g=>{const L=Z.current.type!==null;Z.current.type&&nt.current?.hasPointerCapture(g.pointerId)&&nt.current.releasePointerCapture(g.pointerId),Z.current.type=null,L&&P==="crop"&&!Ce&&await lt()},Be=g=>{if(P!=="draw"||!ct.current||Ce)return;g.preventDefault();const L=ct.current.getBoundingClientRect(),E={x:g.clientX-L.left,y:g.clientY-L.top},V={color:Se,size:pe,points:[E]};Ee.current=g.pointerId,ct.current.setPointerCapture(g.pointerId),Te(V)},qe=g=>{if(P!=="draw"||Ee.current!==g.pointerId||!ct.current)return;g.preventDefault();const L=ct.current.getBoundingClientRect(),E={x:g.clientX-L.left,y:g.clientY-L.top};Te(V=>!V||V.points.length&&V.points[V.points.length-1].x===E.x&&V.points[V.points.length-1].y===E.y?V:{...V,points:[...V.points,E]})},dt=g=>{P!=="draw"||Ee.current!==g.pointerId||(Ee.current=null,ct.current?.hasPointerCapture(g.pointerId)&&ct.current.releasePointerCapture(g.pointerId),Te(L=>{if(!L)return null;if(L.points.length<2){const E={...L,points:[...L.points,L.points[0]]};We(V=>[...V,E])}else We(E=>[...E,L]);return null}))},Pt=()=>{We(g=>g.slice(0,-1))},dn=()=>{We([]),Te(null)},Zn=async()=>{if(!m||Ce)return;const g=new Image;g.crossOrigin="anonymous",await new Promise(L=>{g.onload=()=>{if(S(g),zt){const E=window.innerWidth,te=window.innerHeight-200-60,B=E;let Ne=g.naturalWidth,Le=g.naturalHeight;const ke=B/Ne,ze=te/Le,rt=Math.min(ke,ze),Gt=Ne*rt,Jt=Le*rt;M({width:B,height:te}),T(rt),he({width:Gt,height:Jt});const R={x:(B-Gt)/2,y:(te-Jt)/2};W(R);const Ct=2;G({x:Ct,y:Ct,width:B-Ct*2,height:te-Ct*2})}else{const E=Math.min(window.innerWidth-64,720),V=Math.min(window.innerHeight-200,520);let I=g.naturalWidth,q=g.naturalHeight;if(I>E){const ze=E/I;I*=ze,q*=ze}if(q>V){const ze=V/q;I*=ze,q*=ze}I=Math.max(280,I),q=Math.max(220,q),M({width:I,height:q});const te=Math.max(I/g.naturalWidth,q/g.naturalHeight);T(te);const B=g.naturalWidth*te,Ne=g.naturalHeight*te;he({width:B,height:Ne});const Le={x:(I-B)/2,y:(q-Ne)/2};W(Le);const ke=2;G({x:ke,y:ke,width:I-ke*2,height:q-ke*2})}We([]),Te(null),L()},g.src=l.previewUrl})},wr=async()=>{if(!l||!m)return;const g=D.width/D.height,L=Math.max(D.x,_.x),E=Math.max(D.y,_.y),V=Math.min(D.x+D.width,_.x+J.width),I=Math.min(D.y+D.height,_.y+J.height),q=V-L,te=I-E,B=m.naturalWidth/J.width,Ne=m.naturalHeight/J.height,Le=(L-_.x)*B,ke=(E-_.y)*Ne;let ze=q*B,rt=te*Ne;ze/rt>g?ze=rt*g:rt=ze/g;const Jt=m.naturalWidth,R=m.naturalHeight;let Ct=Math.max(0,Le),yt=Math.max(0,ke),Xe=Math.max(1,Math.min(ze,Jt-Ct)),we=Math.max(1,Math.min(rt,R-yt));const Un=Xe/we;Math.abs(Un-g)>.01&&(Un>g?Xe=we*g:we=Xe/g,Xe=Math.max(1,Math.min(Xe,Jt-Ct)),we=Math.max(1,Math.min(we,R-yt)));const Rt=Math.max(1,Math.round(Xe)),Ut=Math.max(1,Math.round(we)),St=document.createElement("canvas");St.width=Rt,St.height=Ut;const ve=St.getContext("2d");if(!ve)return;ve.drawImage(m,Ct,yt,Xe,we,0,0,Rt,Ut);const ut=Rt/q,Et=Ut/te,wn=[...re,...Ae?[Ae]:[]];ve.lineCap="round",ve.lineJoin="round";for(const Pe of wn){if(!Pe.points.length)continue;ve.strokeStyle=Pe.color,ve.lineWidth=Pe.size*((ut+Et)/2),ve.beginPath();const At=Pe.points[0],vt=(At.x-L)*ut,er=(At.y-E)*Et;ve.moveTo(vt,er);for(let Zt=1;Zt<Pe.points.length;Zt++){const Hn=Pe.points[Zt];ve.lineTo((Hn.x-L)*ut,(Hn.y-E)*Et)}ve.stroke()}const xt=await new Promise(Pe=>St.toBlob(At=>Pe(At),"image/png",.96));if(!xt)return;const ht=l.fileName?.replace(/\.[^.]+$/,"")||l.file.name.replace(/\.[^.]+$/,"")||"image",ft=new File([xt],`${ht}-edited.png`,{type:"image/png"}),Ye=URL.createObjectURL(xt);y({file:ft,previewUrl:Ye})},bn=()=>{if(P!=="crop"||Ce)return null;const{x:g,y:L,width:E,height:V}=D,I={position:"absolute",width:Kt,height:Kt,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{...I,left:g-Kt/2,top:L-Kt/2,cursor:"nwse-resize"}}),e.jsx("div",{style:{...I,left:g+E-Kt/2,top:L-Kt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...I,left:g-Kt/2,top:L+V-Kt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...I,left:g+E-Kt/2,top:L+V-Kt/2,cursor:"nwse-resize"}})]})};if(!s||!l)return null;if(zt)return vr.createPortal(e.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[e.jsx("button",{onClick:h,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"Отмена"}),e.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Редактирование"}),e.jsx("button",{onClick:wr,disabled:!jt||Ce,style:{background:!jt||Ce?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:jt&&!Ce?"pointer":"not-allowed"},children:"Сохранить"})]}),e.jsxs("div",{ref:nt,onPointerDown:ye,onPointerMove:Ge,onPointerUp:De,onPointerLeave:De,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:_.x,top:_.y,width:J.width,height:J.height,userSelect:"none",pointerEvents:"none",transition:Ce?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ct,style:{position:"absolute",inset:0,pointerEvents:P==="draw"?"auto":"none"},onPointerDown:Be,onPointerMove:qe,onPointerUp:dt,onPointerLeave:dt}),e.jsx("canvas",{ref:Re,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),P==="crop"&&!Ce&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${D.x}px 100%,
                    ${D.x}px ${D.y}px,
                    ${D.x+D.width}px ${D.y}px,
                    ${D.x+D.width}px ${D.y+D.height}px,
                    ${D.x}px ${D.y+D.height}px,
                    ${D.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:D.x,top:D.y,width:D.width,height:D.height,border:"2px solid #fff",pointerEvents:"none"}}),bn()]})]}),e.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>fe("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:P==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"Обрезать"}),e.jsxs("button",{onClick:()=>fe("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:P==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[e.jsx(Ra,{size:18}),"Рисовать"]})]}),e.jsxs("button",{onClick:Zn,disabled:Ce,style:{padding:"10px",borderRadius:10,border:"none",background:Ce?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:Ce?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:Ce?"not-allowed":"pointer"},children:[e.jsx(Ia,{size:16}),"Сбросить"]}),P==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Цвет кисти"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:ys.map(g=>e.jsx("button",{onClick:()=>ot(g),style:{width:40,height:40,borderRadius:"50%",border:Se===g?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:g,cursor:"pointer",flexShrink:0},"aria-label":`Выбрать цвет ${g}`},g))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Толщина"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:xs.map(g=>e.jsx("button",{onClick:()=>ge(g),style:{width:48,height:48,borderRadius:12,border:pe===g?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:pe===g?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{onClick:Pt,disabled:re.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:re.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:re.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:re.length===0?"not-allowed":"pointer"},children:[e.jsx(Aa,{size:16}),"Отменить"]}),e.jsx("button",{onClick:dn,disabled:re.length===0&&!Ae,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:re.length===0&&!Ae?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:re.length===0&&!Ae?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:re.length===0&&!Ae?"not-allowed":"pointer"},children:"Очистить"})]})]})]})]}),document.body);const un=e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:e.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Редактирование изображения",e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:l.fileName||l.file.name})]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:h,"aria-label":"Закрыть редактор",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{ref:nt,onPointerDown:ye,onPointerMove:Ge,onPointerUp:De,onPointerLeave:De,style:{position:"relative",width:x.width,height:x.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:P==="crop"?"default":"crosshair"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:_.x,top:_.y,width:J.width,height:J.height,userSelect:"none",pointerEvents:"none",transition:Ce?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ct,style:{position:"absolute",inset:0,pointerEvents:P==="draw"?"auto":"none"},onPointerDown:Be,onPointerMove:qe,onPointerUp:dt,onPointerLeave:dt}),e.jsx("canvas",{ref:Re,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),P==="crop"&&!Ce&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${D.x}px 100%,
                    ${D.x}px ${D.y}px,
                    ${D.x+D.width}px ${D.y}px,
                    ${D.x+D.width}px ${D.y+D.height}px,
                    ${D.x}px ${D.y+D.height}px,
                    ${D.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:D.x,top:D.y,width:D.width,height:D.height,border:"2px solid #fff",pointerEvents:"none"}}),bn()]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:P==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>fe("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"Обрезать"}),e.jsxs("button",{className:P==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>fe("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ra,{size:16}),"Рисовать"]}),e.jsxs("button",{className:"btn btn-ghost",onClick:Zn,disabled:Ce,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ia,{size:16}),"Сбросить"]}),P==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost",onClick:Pt,disabled:re.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Aa,{size:16}),"Отменить штрих"]}),e.jsx("button",{className:"btn btn-ghost",onClick:dn,disabled:re.length===0&&!Ae,style:{display:"inline-flex",alignItems:"center",gap:6},children:"Очистить рисунок"})]})]}),P==="draw"&&e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Цвет кисти"}),e.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:ys.map(g=>e.jsx("button",{onClick:()=>ot(g),style:{width:28,height:28,borderRadius:"50%",border:Se===g?"2px solid #fff":"2px solid transparent",background:g,cursor:"pointer"},"aria-label":`Выбрать цвет ${g}`},g))})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Толщина"}),e.jsx("div",{style:{display:"flex",gap:8},children:xs.map(g=>e.jsx("button",{onClick:()=>ge(g),className:pe===g?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[e.jsx("button",{className:"btn btn-ghost",onClick:h,children:"Отмена"}),e.jsxs("button",{className:"btn btn-primary",onClick:wr,disabled:!jt||Ce,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[e.jsx(hc,{size:16}),"Сохранить"]})]})]})});return vr.createPortal(un,document.body)}function Ln(s,l,h){return Math.min(h,Math.max(l,s))}function el({open:s,items:l,index:h,onClose:y,onIndexChange:m}){const S=a.useRef(null),x=a.useRef(null),[M,Q]=a.useState({}),[T,_]=a.useState({w:0,h:0}),[W,J]=a.useState(1),[he,D]=a.useState(0),[G,P]=a.useState(0),fe=a.useRef(null),Se=a.useRef(null),ot=a.useRef(0),pe=a.useRef(0),ge=a.useRef(null),re=l.length,We=re>1,Ae=l[h]||"",Te=Ae?M[Ae]:void 0,zt=a.useMemo(()=>re<=1?24:T.w<=768?72:Math.max(140,Math.round(T.h*.2)),[re,T.w,T.h]),wt=a.useMemo(()=>{if(!Te||!T.w||!T.h)return{scale:1,maxX:0,maxY:0};const z=56,X=zt,oe=28,ye=Math.max(0,T.w-oe*2),Ge=Math.max(0,T.h-z-X-oe*2),Be=Math.min(ye/Te.w,Ge/Te.h,1)*W,qe=Te.w*Be,dt=Te.h*Be,Pt=Math.max(0,(qe-ye)/2),dn=Math.max(0,(dt-Ge)/2);return{scale:Be,maxX:Pt,maxY:dn}},[Te,T.w,T.h,W,zt]),Ce=()=>{We&&m((h-1+re)%re)},tt=()=>{We&&m((h+1)%re)},nt=()=>{J(1),D(0),P(0)};a.useEffect(()=>{if(!s)return;const z=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=z}},[s]),a.useLayoutEffect(()=>{if(!s)return;const z=()=>{const X=window.innerWidth,oe=window.innerHeight;_({w:X,h:oe})};return z(),window.addEventListener("resize",z),()=>window.removeEventListener("resize",z)},[s]),a.useEffect(()=>{s&&nt()},[s,Ae]),a.useEffect(()=>{if(!s)return;const z=X=>{X.key==="Escape"&&y(),X.key==="ArrowLeft"&&Ce(),X.key==="ArrowRight"&&tt(),(X.key==="+"||X.key==="=")&&J(oe=>Ln(oe*1.15,1,6)),X.key==="-"&&J(oe=>Ln(oe/1.15,1,6)),X.key==="0"&&nt()};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[s,h,re,Ae,y]),a.useEffect(()=>{s&&(D(z=>Ln(z,-wt.maxX,wt.maxX)),P(z=>Ln(z,-wt.maxY,wt.maxY)))},[s,wt.maxX,wt.maxY]);const ct=z=>{if(!s)return;z.preventDefault();const X=x.current?.getBoundingClientRect()??null,oe=!!X&&z.clientX>=X.left&&z.clientX<=X.right&&z.clientY>=X.top&&z.clientY<=X.bottom,ye=z.deltaMode===1?z.deltaY*16:z.deltaMode===2?z.deltaY*T.h:z.deltaY;if(!oe){if(!We)return;const Be=performance.now(),qe=260,dt=90;if(ot.current+=ye,Be-pe.current<qe||Math.abs(ot.current)<dt)return;pe.current=Be;const Pt=ot.current>0?1:-1;ot.current=0,Pt>0?tt():Ce();return}const De=Math.exp(-ye*8e-5);J(Be=>Ln(Be*De,1,6))},Re=z=>{if(z.button!==0)return;z.currentTarget.setPointerCapture(z.pointerId);const X=W>1.01,oe=x.current?.getBoundingClientRect()??null,ye=!!oe&&z.clientX>=oe.left&&z.clientX<=oe.right&&z.clientY>=oe.top&&z.clientY<=oe.bottom;fe.current={active:!0,startX:z.clientX,startY:z.clientY,startTx:he,startTy:G,mode:X?"pan":"swipe",startedInsideImg:ye}},Z=z=>{const X=fe.current;if(!X?.active)return;const oe=z.clientX-X.startX,ye=z.clientY-X.startY;if(X.mode==="pan"){D(Ln(X.startTx+oe,-wt.maxX,wt.maxX)),P(Ln(X.startTy+ye,-wt.maxY,wt.maxY));return}},Ee=z=>{const X=fe.current;if(fe.current=null,!X?.active)return;const oe=z.clientX-X.startX,ye=z.clientY-X.startY;if(X.mode==="swipe"){if(Math.abs(ye)>110&&Math.abs(oe)<90){y();return}if(Math.abs(oe)>70&&Math.abs(ye)<60){oe<0?tt():Ce();return}}const Ge=8,De=Math.abs(oe)<=Ge&&Math.abs(ye)<=Ge;if(De&&X.startedInsideImg){const Be=performance.now(),qe=ge.current,dt=280,Pt=18;if(qe&&Be-qe.ts<=dt&&Math.abs(qe.x-z.clientX)<=Pt&&Math.abs(qe.y-z.clientY)<=Pt){ge.current=null,W<=1.01?J(2):nt();return}ge.current={ts:Be,x:z.clientX,y:z.clientY};return}De&&!X.startedInsideImg&&(W>1.01?nt():y())},Yt=z=>{if(z.touches.length!==2){Se.current=null;return}z.preventDefault();const X=z.touches[0],oe=z.touches[1],ye=X.clientX-oe.clientX,Ge=X.clientY-oe.clientY,De=Math.sqrt(ye*ye+Ge*Ge),Be=Se.current;if(Se.current=De,!Be)return;const qe=De>Be?1.03:1/1.03;J(dt=>Ln(dt*qe,1,6))},Qt=()=>{W<=1.01?J(2):nt()};if(!s)return null;const jt=(()=>{if(re<=13)return l.map((De,Be)=>({u:De,i:Be}));const X=Math.floor(13/2);let oe=h-X,ye=h+X;if(oe<0&&(ye+=-oe,oe=0),ye>re-1){const De=ye-(re-1);oe=Math.max(0,oe-De),ye=re-1}const Ge=[];for(let De=oe;De<=ye;De++)Ge.push({u:l[De],i:De});return Ge})(),lt=e.jsxs("div",{className:"imglb-root",ref:S,onWheel:ct,style:{"--imglb-thumbs-h":`${zt}px`},children:[e.jsx("div",{className:"imglb-backdrop",onClick:y}),e.jsxs("div",{className:"imglb-topbar",children:[e.jsx("div",{className:"imglb-spacer","aria-hidden":"true"}),e.jsxs("div",{className:"imglb-title",children:[h+1," / ",re]}),e.jsx("button",{className:"imglb-btn",onClick:y,"aria-label":"Закрыть",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{className:"imglb-stage",onPointerDown:Re,onPointerMove:Z,onPointerUp:Ee,onPointerCancel:()=>{fe.current=null},onTouchMove:Yt,onDoubleClick:Qt,children:[We&&e.jsx("button",{className:"imglb-nav imglb-nav-left",onClick:Ce,"aria-label":"Назад",children:e.jsx(pc,{size:24})}),e.jsx("div",{className:"imglb-media",onClick:z=>z.stopPropagation(),children:e.jsx("div",{className:"imglb-pan",style:{transform:`translate3d(${he}px, ${G}px, 0)`},children:e.jsx("img",{ref:x,className:"imglb-img",src:Ae,alt:"preview",draggable:!1,style:{width:Te?.w?`${Te.w}px`:void 0,height:Te?.h?`${Te.h}px`:void 0,transform:`scale(${wt.scale})`},onLoad:z=>{const X=z.currentTarget,oe=X.naturalWidth||1,ye=X.naturalHeight||1;Q(Ge=>({...Ge,[Ae]:{w:oe,h:ye}}))}})})}),We&&e.jsx("button",{className:"imglb-nav imglb-nav-right",onClick:tt,"aria-label":"Вперёд",children:e.jsx(mc,{size:24})})]}),re>1&&e.jsx("div",{className:"imglb-thumbs",onClick:z=>z.stopPropagation(),children:e.jsx("div",{className:"imglb-thumbs-inner",children:jt.map(({u:z,i:X})=>e.jsx("button",{type:"button",className:X===h?"imglb-thumb is-active":"imglb-thumb",onClick:()=>m(X),"aria-label":`Открыть ${X+1}`,children:e.jsx("img",{src:z,alt:"",draggable:!1})},`${z}-${X}`))})})]});return vr.createPortal(lt,document.body)}const Br=Eo(s=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:l=>s({incoming:l}),startOutgoing:(l,h)=>s({activeConvId:l,incoming:null,initialVideo:!!h,initialAudio:!0}),startIncoming:l=>s({incoming:l}),endCall:()=>s({activeConvId:null,incoming:null,initialVideo:!1})}));/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function tl(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function js(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Ni(s,...l){if(!tl(s))throw new Error("Uint8Array expected");if(l.length>0&&!l.includes(s.length))throw new Error("Uint8Array expected of length "+l+", got length="+s.length)}function Cs(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");js(s.outputLen),js(s.blockLen)}function Di(s,l=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(l&&s.finished)throw new Error("Hash#digest() has already been called")}function nl(s,l){Ni(s);const h=l.outputLen;if(s.length<h)throw new Error("digestInto() expects output buffer of length at least "+h)}function $r(...s){for(let l=0;l<s.length;l++)s[l].fill(0)}function vs(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function cn(s,l){return s<<32-l|s>>>l}function rl(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function _r(s){return typeof s=="string"&&(s=rl(s)),Ni(s),s}class Ba{}function il(s){const l=y=>s().update(_r(y)).digest(),h=s();return l.outputLen=h.outputLen,l.blockLen=h.blockLen,l.create=()=>s(),l}class $a extends Ba{constructor(l,h){super(),this.finished=!1,this.destroyed=!1,Cs(l);const y=_r(h);if(this.iHash=l.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const m=this.blockLen,S=new Uint8Array(m);S.set(y.length>m?l.create().update(y).digest():y);for(let x=0;x<S.length;x++)S[x]^=54;this.iHash.update(S),this.oHash=l.create();for(let x=0;x<S.length;x++)S[x]^=106;this.oHash.update(S),$r(S)}update(l){return Di(this),this.iHash.update(l),this}digestInto(l){Di(this),Ni(l,this.outputLen),this.finished=!0,this.iHash.digestInto(l),this.oHash.update(l),this.oHash.digestInto(l),this.destroy()}digest(){const l=new Uint8Array(this.oHash.outputLen);return this.digestInto(l),l}_cloneInto(l){l||(l=Object.create(Object.getPrototypeOf(this),{}));const{oHash:h,iHash:y,finished:m,destroyed:S,blockLen:x,outputLen:M}=this;return l=l,l.finished=m,l.destroyed=S,l.blockLen=x,l.outputLen=M,l.oHash=h._cloneInto(l.oHash),l.iHash=y._cloneInto(l.iHash),l}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ss=(s,l,h)=>new $a(s,l).update(h).digest();Ss.create=(s,l)=>new $a(s,l);function sl(s,l,h){return Cs(s),h===void 0&&(h=new Uint8Array(s.outputLen)),Ss(s,_r(h),_r(l))}const bs=Uint8Array.from([0]),Na=Uint8Array.of();function al(s,l,h,y=32){Cs(s),js(y);const m=s.outputLen;if(y>255*m)throw new Error("Length should be <= 255*HashLen");const S=Math.ceil(y/m);h===void 0&&(h=Na);const x=new Uint8Array(S*m),M=Ss.create(s,l),Q=M._cloneInto(),T=new Uint8Array(M.outputLen);for(let _=0;_<S;_++)bs[0]=_+1,Q.update(_===0?Na:T).update(h).update(bs).digestInto(T),x.set(T,m*_),M._cloneInto(Q);return M.destroy(),Q.destroy(),$r(T,bs),x.slice(0,y)}const ol=(s,l,h,y,m)=>al(s,sl(s,l,h),y,m);function cl(s,l,h,y){if(typeof s.setBigUint64=="function")return s.setBigUint64(l,h,y);const m=BigInt(32),S=BigInt(4294967295),x=Number(h>>m&S),M=Number(h&S),Q=y?4:0,T=y?0:4;s.setUint32(l+Q,x,y),s.setUint32(l+T,M,y)}function ll(s,l,h){return s&l^~s&h}function dl(s,l,h){return s&l^s&h^l&h}class ul extends Ba{constructor(l,h,y,m){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=l,this.outputLen=h,this.padOffset=y,this.isLE=m,this.buffer=new Uint8Array(l),this.view=vs(this.buffer)}update(l){Di(this),l=_r(l),Ni(l);const{view:h,buffer:y,blockLen:m}=this,S=l.length;for(let x=0;x<S;){const M=Math.min(m-this.pos,S-x);if(M===m){const Q=vs(l);for(;m<=S-x;x+=m)this.process(Q,x);continue}y.set(l.subarray(x,x+M),this.pos),this.pos+=M,x+=M,this.pos===m&&(this.process(h,0),this.pos=0)}return this.length+=l.length,this.roundClean(),this}digestInto(l){Di(this),nl(l,this),this.finished=!0;const{buffer:h,view:y,blockLen:m,isLE:S}=this;let{pos:x}=this;h[x++]=128,$r(this.buffer.subarray(x)),this.padOffset>m-x&&(this.process(y,0),x=0);for(let W=x;W<m;W++)h[W]=0;cl(y,m-8,BigInt(this.length*8),S),this.process(y,0);const M=vs(l),Q=this.outputLen;if(Q%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const T=Q/4,_=this.get();if(T>_.length)throw new Error("_sha2: outputLen bigger than state");for(let W=0;W<T;W++)M.setUint32(4*W,_[W],S)}digest(){const{buffer:l,outputLen:h}=this;this.digestInto(l);const y=l.slice(0,h);return this.destroy(),y}_cloneInto(l){l||(l=new this.constructor),l.set(...this.get());const{blockLen:h,buffer:y,length:m,finished:S,destroyed:x,pos:M}=this;return l.destroyed=x,l.finished=S,l.length=m,l.pos=M,m%h&&l.buffer.set(y),l}clone(){return this._cloneInto()}}const zn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),hl=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Pn=new Uint32Array(64);class fl extends ul{constructor(l=32){super(64,l,8,!1),this.A=zn[0]|0,this.B=zn[1]|0,this.C=zn[2]|0,this.D=zn[3]|0,this.E=zn[4]|0,this.F=zn[5]|0,this.G=zn[6]|0,this.H=zn[7]|0}get(){const{A:l,B:h,C:y,D:m,E:S,F:x,G:M,H:Q}=this;return[l,h,y,m,S,x,M,Q]}set(l,h,y,m,S,x,M,Q){this.A=l|0,this.B=h|0,this.C=y|0,this.D=m|0,this.E=S|0,this.F=x|0,this.G=M|0,this.H=Q|0}process(l,h){for(let W=0;W<16;W++,h+=4)Pn[W]=l.getUint32(h,!1);for(let W=16;W<64;W++){const J=Pn[W-15],he=Pn[W-2],D=cn(J,7)^cn(J,18)^J>>>3,G=cn(he,17)^cn(he,19)^he>>>10;Pn[W]=G+Pn[W-7]+D+Pn[W-16]|0}let{A:y,B:m,C:S,D:x,E:M,F:Q,G:T,H:_}=this;for(let W=0;W<64;W++){const J=cn(M,6)^cn(M,11)^cn(M,25),he=_+J+ll(M,Q,T)+hl[W]+Pn[W]|0,G=(cn(y,2)^cn(y,13)^cn(y,22))+dl(y,m,S)|0;_=T,T=Q,Q=M,M=x+he|0,x=S,S=m,m=y,y=he+G|0}y=y+this.A|0,m=m+this.B|0,S=S+this.C|0,x=x+this.D|0,M=M+this.E|0,Q=Q+this.F|0,T=T+this.G|0,_=_+this.H|0,this.set(y,m,S,x,M,Q,T,_)}roundClean(){$r(Pn)}destroy(){this.set(0,0,0,0,0,0,0,0),$r(this.buffer)}}const pl=il(()=>new fl),gl=pl,ml=new TextEncoder,yl=new TextDecoder;function Xt(s){if(!s)return new Uint8Array;const l=s.replace(/-/g,"+").replace(/_/g,"/"),h=l.length%4===0?"":"=".repeat(4-l.length%4),y=atob(l+h),m=y.length,S=new Uint8Array(m);for(let x=0;x<m;x+=1)S[x]=y.charCodeAt(x);return S}function xr(s){let l="";for(let h=0;h<s.length;h+=1)l+=String.fromCharCode(s[h]);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function La(s){return ml.encode(s)}function xl(s){return yl.decode(s)}const za="eb_e2ee_sessions_v1";class vl{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(l){return!!this.sessions[l]}getSession(l){return this.sessions[l]??null}async ensureSession(l){if(!l.isSecret||l.secretStatus!=="ACTIVE")return null;const h=this.sessions[l.id];if(h)return h;const y=br(),m=ga();if(!y||!m||!l.secretInitiatorDeviceId||!l.secretPeerDeviceId||!(l.secretInitiatorDeviceId===y.deviceId))return null;const x=l.secretPeerDeviceId;return x?this.createInitiatorSession(l,y.deviceId,x,m):null}processHandshakes(l,h){if(!l.isSecret||!h||h.length===0)return!1;const y=br();if(!y)return!1;let m=!1;for(const S of h){const M=(S?.metadata??{}).e2ee;if(!M||M.kind!=="handshake")continue;const Q=M.payload;if(!Q||Q.recipientDeviceId!==y.deviceId)continue;const T=this.sessions[l.id];if(T&&T.peerDeviceId===Q.initiatorDeviceId&&T.prekeyId===Q.prekeyId)continue;this.handlePeerHandshake(l,Q)&&(m=!0)}return m&&this.bumpVersion(),m}transformMessage(l,h){if(!h)return h;const y=h.metadata??{},m=y.e2ee;if(!m||m.kind!=="ciphertext")return h;const S=this.sessions[l];if(!S)return{...h,content:"🔐 Зашифровано",metadata:{...y,e2ee:{...m,decrypted:!1}}};try{const x=Xt(S.key),M=Xt(m.nonce),Q=Xt(h.content||""),T=vn.secretbox.open(Q,M,x);if(!T)throw new Error("Failed to decrypt");return{...h,content:xl(T),metadata:{...y,e2ee:{...m,decrypted:!0}}}}catch(x){return console.warn("Failed to decrypt message",x),{...h,content:"🔐 Ошибка расшифровки",metadata:{...y,e2ee:{...m,decrypted:!1,error:!0}}}}}async encryptPayload(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Xt(y.key),S=vn.randomBytes(24),x=La(h.content??""),M=vn.secretbox(x,S,m);return{conversationId:l.id,type:h.type,content:xr(M),replyToId:h.replyToId,metadata:{...h.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:xr(S)}}}}async encryptBinary(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Xt(y.key),S=vn.randomBytes(24);return{cipher:vn.secretbox(h,S,m),nonce:xr(S)}}decryptBinary(l,h,y){const m=this.sessions[l];if(!m)throw new Error("E2EE session is not ready");const S=Xt(m.key),x=Xt(y);return vn.secretbox.open(h,x,S)}async createInitiatorSession(l,h,y,m){try{const S=await ae.post("/devices/prekeys/claim",{deviceId:y}),x=S.data?.identityKey,M=S.data?.prekey;if(!x||!M?.publicKey||!M?.keyId)throw new Error("Invalid prekey response");const Q=vn.scalarMult(Xt(m.secretKey),Xt(M.publicKey)),T=vn.randomBytes(32),_=`eblusha:e2ee:${l.id}:${h}->${y}:${M.keyId}`,W=this.deriveKey(Q,T,_),J={conversationId:l.id,key:xr(W),localDeviceId:h,peerDeviceId:y,role:"initiator",prekeyId:M.keyId,hkdfInfo:_,handshakeSalt:xr(T),createdAt:Date.now()};return this.sessions[l.id]=J,this.persist(),await this.sendHandshakeMessage(l.id,{version:1,kind:"handshake",conversationId:l.id,initiatorDeviceId:h,recipientDeviceId:y,prekeyId:M.keyId,handshakeSalt:J.handshakeSalt,hkdfInfo:_,initiatorIdentityKey:m.publicKey,createdAt:Date.now()}),J}catch(S){return console.error("Failed to initialize E2EE session",S),delete this.sessions[l.id],this.persist(),null}}handlePeerHandshake(l,h){if(!h?.prekeyId||!h?.initiatorIdentityKey||!h.hkdfInfo||!h.handshakeSalt||!ga())return!1;const m=br();if(!m)return!1;const S=Ao(h.prekeyId);if(!S)return console.warn("Missing prekey secret for handshake",h.prekeyId),!1;try{const x=vn.scalarMult(Xt(S),Xt(h.initiatorIdentityKey)),M=this.deriveKey(x,Xt(h.handshakeSalt),h.hkdfInfo),Q={conversationId:l.id,key:xr(M),localDeviceId:m.deviceId,peerDeviceId:h.initiatorDeviceId,role:"peer",prekeyId:h.prekeyId,hkdfInfo:h.hkdfInfo,handshakeSalt:h.handshakeSalt,createdAt:Date.now()};return this.sessions[l.id]=Q,this.persist(),!0}catch(x){return console.error("Failed to handle handshake payload",x),!1}}async sendHandshakeMessage(l,h){await ae.post("/conversations/send",{conversationId:l,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:h}}})}deriveKey(l,h,y){return ol(gl,l,h,La(y),32)}clearSession(l){this.sessions[l]&&(delete this.sessions[l],this.persist())}load(){try{const l=localStorage.getItem(za);l&&(this.sessions=JSON.parse(l))}catch{this.sessions={}}}persist(){try{localStorage.setItem(za,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const ln=new vl;class bl{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(l={}){this.callbacks=l}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const l={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,l),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const h=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,h.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(h){console.error("Failed to setup audio analysis:",h)}this.mediaRecorder.ondataavailable=h=>{h.data.size>0&&this.audioChunks.push(h.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(h=>h.stop())},this.mediaRecorder.onerror=h=>{const y=new Error("MediaRecorder error");this.callbacks.onError?.(y)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(l){const h=l instanceof Error?l:new Error("Failed to start recording");throw this.callbacks.onError?.(h),h}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(l=>l.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let l=0;const h=50,y=m=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}if(typeof m=="number"){if(m-l<h){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}l=m}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(he){console.warn("Analyser error:",he);return}let S=0,x=0;for(let he=0;he<this.dataArray.length;he++){const D=Math.abs(this.dataArray[he]-128);S=Math.max(S,D),x+=D}const M=x/this.dataArray.length,T=(S*.7+M*.3)/128*100,_=Math.min(100,T*2.5),J=Math.max(15,_);this.callbacks.onAmplitudeUpdate?.(J),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y))};this.amplitudeTimer=window.requestAnimationFrame(y)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const l=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const h of l)if(MediaRecorder.isTypeSupported(h))return h;return""}cleanup(){this.cancel()}}async function wl(s,l=60){try{const y=await(await fetch(s)).arrayBuffer(),m=new(window.AudioContext||window.webkitAudioContext),x=(await m.decodeAudioData(y)).getChannelData(0),M=Math.floor(x.length/l),Q=[];for(let T=0;T<l;T++){let _=0,W=0;const J=T*M,he=Math.min(J+M,x.length);for(let fe=J;fe<he;fe++){const Se=Math.abs(x[fe]);_+=Se,W=Math.max(W,Se)}const D=_/(he-J),G=Math.max(D,W*.7),P=Math.max(20,Math.min(100,G*200));Q.push(P)}return m.close(),Q}catch(h){return console.error("Failed to generate waveform:",h),Array(l).fill(0).map(()=>Math.random()*40+30)}}const ws=new Map;async function jl(s,l=60){const h=`${s}:${l}`;if(ws.has(h))return ws.get(h);const y=await wl(s,l);return ws.set(h,y),y}const Cl=a.lazy(()=>Ha(()=>import("./CallOverlay-C2mnFpee.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(s=>({default:s.CallOverlay}))),Sl=()=>Ha(()=>import("./CallOverlay-C2mnFpee.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),Pa="eblusha:last-active-conversation",kl=3e4,Il=10;function Ml({url:s,duration:l}){const[h,y]=a.useState(!1),[m,S]=a.useState(0),[x,M]=a.useState([]),[Q,T]=a.useState(!0),_=a.useRef(null),W=Ti(s)||s;a.useEffect(()=>{let G=!1;return T(!0),jl(W,60).then(P=>{G||(M(P),T(!1))}).catch(P=>{console.error("Failed to load waveform:",P),G||T(!1)}),()=>{G=!0}},[W]),a.useEffect(()=>{const G=_.current;if(!G)return;const P=()=>S(G.currentTime),fe=()=>{y(!1),S(0)},Se=()=>y(!0),ot=()=>y(!1);return G.addEventListener("timeupdate",P),G.addEventListener("ended",fe),G.addEventListener("play",Se),G.addEventListener("pause",ot),()=>{G.removeEventListener("timeupdate",P),G.removeEventListener("ended",fe),G.removeEventListener("play",Se),G.removeEventListener("pause",ot)}},[]);const J=()=>{const G=_.current;G&&(h?G.pause():G.play().catch(P=>{console.error("Failed to play audio:",P)}))},he=G=>{const P=Math.floor(G/60),fe=Math.floor(G%60);return`${P}:${fe.toString().padStart(2,"0")}`},D=x.length>0?Math.floor(m/l*x.length):0;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[e.jsx("audio",{ref:_,src:W,preload:"metadata"}),e.jsx("button",{type:"button",onClick:J,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":h?"Пауза":"Воспроизвести",children:h?e.jsx(Oc,{size:16,fill:"currentColor"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[Q?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map((G,P)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${P*.1}s`}},P))}):x.length>0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:x.map((G,P)=>{const fe=P<=D,Se=Math.max(4,G/100*20);return e.jsx("div",{style:{width:2,height:`${Se}px`,background:fe?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},P)})}):e.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Загрузка..."}),e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[he(m)," / ",he(l)]})})]})]})}function Rl(){const[s,l]=a.useState(null),[h,y]=a.useState(null),[m,S]=a.useState(null),[x,M]=a.useState(null),Q=a.useRef(null);a.useEffect(()=>{Q.current=x},[x]);const T=a.useRef(null),[_,W]=a.useState(""),[J,he]=a.useState(null),D=a.useRef(null),G=a.useRef(null),P=a.useRef(null),fe=a.useRef(null),Se=a.useRef(null),ot=a.useRef(!1),pe=a.useRef(null),ge=a.useRef(null),re=a.useRef(!1),We=a.useRef(null),Ae=a.useRef(null),[Te,zt]=a.useState(!1),[wt,Ce]=a.useState(1),[tt,nt]=a.useState(!1),ct=a.useRef(null);a.useRef({pinTimer:null});const[Re,Z]=a.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Ee,Yt]=a.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Qt=a.useRef(null),[jt,lt]=a.useState(()=>({open:!1,anchor:null})),z=a.useRef(null),X=a.useRef(null),[oe,ye]=a.useState(!1),[Ge,De]=a.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Be,qe]=a.useState({open:!1,messageId:null}),[dt,Pt]=a.useState(!1),[dn,Zn]=a.useState([]),[wr,bn]=a.useState(!1),[un,g]=a.useState("friends"),[L,E]=a.useState(["","","",""]),V=[a.useRef(null),a.useRef(null),a.useRef(null),a.useRef(null)],[I,q]=a.useState(null),[te,B]=a.useState(null),[Ne,Le]=a.useState(!1),ke=a.useRef(0),[ze,rt]=a.useState(!1),[Gt,Jt]=a.useState(!1),[R,Ct]=a.useState(!1),yt=a.useRef(R),[Xe,we]=a.useState("list");a.useEffect(()=>{yt.current=R},[R]);const[Un,Rt]=a.useState(!1),Ut=a.useRef(null);a.useRef(null);const St=a.useRef(new Map),ve=a.useRef(!0),ut=a.useRef(!1),Et=a.useRef(0),wn=a.useRef(null),xt=a.useRef(new Set),ht=a.useRef(null);a.useRef(null);const ft=a.useRef(null),Ye=a.useRef(0),[Pe,At]=a.useState(!1),[vt,er]=a.useState(""),[Zt,Hn]=a.useState([]),[jr,Cr]=a.useState(!1),[Or,tr]=a.useState(null),[hn,kt]=a.useState(null),[je,qt]=a.useState(null),[Sr,jn]=a.useState(null),[Wn,Cn]=a.useState(!1),Li=a.useRef(null),Bn=a.useRef(null),_a=a.useRef(null),zi=a.useRef(null),[Ve,en]=a.useState({x:0,y:0,scale:1}),[ks,Pi]=a.useState(!1),[Oa,Fr]=a.useState(!1),[Ui,Fa]=a.useState(["","","",""]),Hi=[a.useRef(null),a.useRef(null),a.useRef(null),a.useRef(null)],[Sn,Wi]=a.useState(null),[Xa,Bi]=a.useState(!1),[$i,Ya]=a.useState(""),[Ga,Xr]=a.useState(!1),[nr,Yr]=a.useState(!1),[_i,Gr]=a.useState(null),[Ht,qr]=a.useState(null),Vr=a.useRef(null),[Ie,kn]=a.useState({x:0,y:0,scale:1}),[Is,Kr]=a.useState(0),$n=a.useRef(null),Oi=a.useRef(null),Ms=a.useRef(null),pt=a.useRef(null),_n=a.useRef(null),In=a.useRef(null),Qr=a.useRef(null),gt=a.useRef(null),On=a.useRef(null),Jr=a.useRef(null),Rs=a.useRef(null),[Me,tn]=a.useState({x:0,y:0,scale:1}),[Wt,Zr]=a.useState(null),[ei,ti]=a.useState(null),[Es,Fi]=a.useState(!1),[As,Xi]=a.useState(!1),[ni,rr]=a.useState(null),[Yi,Gi]=a.useState({open:!1,index:0,items:[]}),[qa,ri]=a.useState(!1),[Va,ir]=a.useState(0),[El,qi]=a.useState(!1),[sr,kr]=a.useState(null),[Ts,Ir]=a.useState({}),[Fn,ii]=a.useState({}),Mr=a.useRef(new Set),ar=a.useRef(new Set),[fn,Rr]=a.useState([]),[si,nn]=a.useState(null),[ai,Ds]=a.useState(0),pn=a.useRef(null),[Ns,Vi]=a.useState(!1),[Ls,Ki]=a.useState(0),[Er,Qi]=a.useState([]),or=a.useRef(null),Ar=a.useRef(null),[zs,Ps]=a.useState(150);a.useEffect(()=>{if(R){Ps(60);return}const t=()=>{if(!Ar.current)return;const r=Ar.current.clientWidth,c=Math.floor(r/4);Ps(Math.max(100,c))};t();const n=new ResizeObserver(t);return Ar.current&&n.observe(Ar.current),()=>{n.disconnect()}},[R]),a.useEffect(()=>{Sl().catch(()=>{})},[]);const Us=a.useRef(null);a.useEffect(()=>{Us.current=s},[s]);const oi=a.useRef([]);a.useEffect(()=>{oi.current=fn},[fn]);const Xn=a.useCallback(t=>{if(t)try{URL.revokeObjectURL(t)}catch{}},[]),Ji=a.useCallback(()=>{nn(null),Rr(t=>t.length?(t.forEach(n=>Xn(n.previewUrl)),[]):t)},[Xn,nn]),Tr=a.useCallback((t,n)=>{!t||!t.type.startsWith("image/")||Rr(r=>{if(r.length>=Il)return alert("Можно редактировать не более 10 изображений за раз."),r;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,c=URL.createObjectURL(t),o={id:i,file:t,previewUrl:c,edited:!1,fileName:t.name||"image.png",source:n};return[...r,o]})},[]),Ka=a.useCallback(t=>{Rr(n=>{const r=n.find(i=>i.id===t);return r&&Xn(r.previewUrl),n.filter(i=>i.id!==t)}),nn(n=>n===t?null:n)},[Xn,nn]),Qa=a.useCallback((t,n,r)=>{Rr(i=>i.map(c=>c.id!==t?c:(Xn(c.previewUrl),{...c,file:n,previewUrl:r,edited:!0,fileName:n.name||c.fileName})))},[Xn]),Hs=mr({queryKey:["my-devices"],queryFn:async()=>(await ae.get("/devices")).data.devices}),[Al,Ws]=a.useState(null),[Ja,ci]=a.useState(()=>_e.connected),[Za,Bs]=a.useState(null),[$s,eo]=a.useState({}),[_s,li]=a.useState({}),[Os,di]=a.useState({}),[Fs,Xs]=a.useState({}),[to,Dr]=a.useState(!1),[Ys,Nr]=a.useState({}),[Gs,qs]=a.useState(!1),[Zi,ui]=a.useState(!1),Vs=a.useRef(null),N=Jn(t=>t.session?.user),Lr=a.useRef(null);if(Lr.current===null&&typeof window<"u")try{const t=localStorage.getItem("eb_user");if(t){const n=JSON.parse(t);n&&typeof n.id=="string"&&(Lr.current=n.id)}}catch{Lr.current=null}a.useEffect(()=>{N?.id&&(Lr.current=N.id)},[N?.id]);const Tt=N?.id??Lr.current??null,Y=Br(),F=tc(),hi=a.useMemo(()=>s?Ts[s]||[]:[],[s,Ts]),fi=a.useMemo(()=>si?fn.find(t=>t.id===si)??null:null,[fn,si]);a.useRef(null),a.useRef(null);const[gn,It]=a.useState({}),[Tl,no]=a.useState(0),Yn=a.useRef(null);a.useEffect(()=>{Yn.current=h},[h]);const ro=a.useRef({}),es=a.useRef({}),cr=a.useRef({});a.useEffect(()=>()=>{typeof window>"u"||(Object.values(cr.current).forEach(t=>{typeof t=="number"&&window.clearTimeout(t)}),T.current&&window.clearTimeout(T.current),qn())},[]),a.useEffect(()=>{if(!x)return;const t=setInterval(()=>{M(n=>n?{...n}:null)},1e3);return()=>clearInterval(t)},[x]);const pi=a.useCallback(t=>{if(!t)return null;const n=F.getQueryData(["conversations"]);return Array.isArray(n)?n.find(i=>i?.conversation?.id===t)?.conversation??null:null},[F]),lr=a.useCallback(t=>{const n=pi(t);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[pi]),Mn=a.useCallback(t=>{if(!t)return;const n=cr.current[t];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete cr.current[t]),delete es.current[t]},[]),gi=a.useCallback(t=>{t&&lr(t)&&(es.current[t]=Date.now()+kl)},[lr]),ts=a.useCallback((t,n,r)=>{if(!t){n();return}if(r?.force){Mn(t),n();return}const i=es.current[t];if(!i){n();return}const c=Date.now();if(c>=i){Mn(t),n();return}const o=i-c,d=cr.current[t];if(typeof d=="number"&&typeof window<"u"&&window.clearTimeout(d),typeof window>"u"){n();return}cr.current[t]=window.setTimeout(()=>{delete cr.current[t],Mn(t),n()},o)},[Mn]),ns=a.useCallback((t,n)=>{const r=t?"камере и микрофону":"микрофону",i=typeof n=="object"&&n&&"name"in n?String(n.name):"";return i==="NotAllowedError"||i==="SecurityError"?`Браузер запретил доступ к ${r}. Разрешите его в адресной строке и попробуйте снова.`:i==="NotFoundError"?t?"Браузер не нашёл камеру или микрофон. Подключите устройство и попробуйте ещё раз.":"Браузер не нашёл микрофон. Подключите устройство и попробуйте ещё раз.":i==="NotReadableError"||i==="TrackStartError"?"Камера или микрофон уже используются другим приложением или вкладкой.":`Не удалось получить доступ к ${r}. Проверьте настройки браузера и попробуйте снова.`},[]),mi=a.useCallback(async t=>{try{const n=await Da({audio:!0,video:t});return n.ok?(kr(null),!0):(kr(ns(t,n.error)),!1)}catch(n){return kr(ns(t,n)),!1}},[ns]),yi=a.useCallback(async t=>{const n=Y.incoming;if(!n||!await mi(t))return;const r=n.conversationId;gi(r),To(r,t),Y.startOutgoing(r,t),It(i=>{const c=i[r],o=N?.id;return c?.active?o&&c.participants&&!c.participants.includes(o)?{...i,[r]:{...c,participants:[...c.participants,o]}}:i:{...i,[r]:{startedAt:Date.now(),active:!0,participants:o?[o]:[]}}}),y(r),S(i=>i===r?null:i),Y.setIncoming(null),_t()},[gi,Y,N?.id,mi]),rs=a.useCallback(()=>{const t=Y.incoming;t&&(ma(t.conversationId),Y.setIncoming(null),_t())},[Y]);a.useEffect(()=>{if(typeof window>"u")return;const t={accept:async(n,r)=>Y.incoming?.conversationId!==n?!1:(await yi(r),!0),decline:n=>Y.incoming?.conversationId!==n?!1:(rs(),!0)};return window.__nativeCallOverlayBridge=t,()=>{window.__nativeCallOverlayBridge===t&&delete window.__nativeCallOverlayBridge}},[Y.incoming?.conversationId,yi,rs]),a.useEffect(()=>{const t=window.setInterval(()=>no(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(t)},[]),a.useEffect(()=>{if(!sr||typeof window>"u")return;const t=window.setTimeout(()=>kr(null),9e3);return()=>window.clearTimeout(t)},[sr]),a.useEffect(()=>{const t=()=>{const n=window.innerWidth<=768;Ct(n),yt.current=n,n?s||we("list"):we("conversation")};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]),a.useEffect(()=>{R&&we(s?"conversation":"list")},[R,s]),a.useEffect(()=>{const t=(()=>{try{const c=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(c==="1"||c==="true")return!0;const o=window.localStorage.getItem("lk-debug-callstatus");return o==="1"||o==="true"}catch{return!1}})(),n=i=>{t&&console.log("[CallStatus] Single:",i),It(c=>{const o=F.getQueryData(["conversations"]),d=Array.isArray(o)?o.find(w=>w.conversation.id===i.conversationId)?.conversation:null,f=c[i.conversationId],u=Br.getState().activeConvId;if(!(!!(d&&(d.isGroup||(d.participants?.length??0)>2))||!!f&&(f.participants?f.participants.length>1:!0)||u===i.conversationId))return c;const j=i.participants||[];if(i.active){const w=typeof i.startedAt=="number"&&i.startedAt>0?i.startedAt:f?.startedAt??Date.now();return{...c,[i.conversationId]:{active:!0,startedAt:w,participants:j,endedAt:null,elapsedMs:typeof i.elapsedMs=="number"?i.elapsedMs:void 0}}}const v=f?.active?Date.now():f?.endedAt??null;return{...c,[i.conversationId]:{active:!1,startedAt:f?.startedAt??null,endedAt:v,participants:[],elapsedMs:void 0}}})},r=i=>{t&&console.log("[CallStatus] Bulk:",i),It(c=>{const o={...c},d=F.getQueryData(["conversations"]);for(const[f,u]of Object.entries(i.statuses||{})){const p=Array.isArray(d)?d.find(A=>A.conversation.id===f)?.conversation:null,j=c[f],v=Br.getState().activeConvId;if(!(!!(p&&(p.isGroup||(p.participants?.length??0)>2))||!!j&&(j.participants?j.participants.length>1:!0)||v===f))continue;const C=u.participants||[];if(u.active){const A=typeof u.startedAt=="number"&&u.startedAt>0?u.startedAt:j?.startedAt??Date.now();o[f]={active:!0,startedAt:A,participants:C,endedAt:null,elapsedMs:typeof u.elapsedMs=="number"?u.elapsedMs:void 0};continue}const b=j?.active?Date.now():j?.endedAt??null;o[f]={active:!1,startedAt:j?.startedAt??null,endedAt:b,participants:[],elapsedMs:void 0}}return o})};return Do(n),No(r),()=>{_e.off("call:status",n),_e.off("call:status:bulk",r)}},[]),a.useEffect(()=>{if(!Re.open)return;const t=Vs.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=Re.x,o=Re.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),o+i.height>r-8&&(o=Math.max(8,r-i.height-8)),(c!==Re.x||o!==Re.y)&&Z(d=>({...d,x:c,y:o}))},[Re.open,Re.x,Re.y]),a.useEffect(()=>{if(!Ee.open)return;const t=Qt.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=Ee.x,o=Ee.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),o+i.height>r-8&&(o=Math.max(8,r-i.height-8)),(c!==Ee.x||o!==Ee.y)&&Yt(d=>({...d,x:c,y:o}))},[Ee.open,Ee.x,Ee.y]),a.useEffect(()=>{if(!jt.open||!jt.anchor)return;const t=z.current;if(!t)return;const n=jt.anchor.getBoundingClientRect(),r=window.innerWidth,i=window.visualViewport?window.visualViewport.height:window.innerHeight;t.style.display="flex";const c=t.getBoundingClientRect();let o=n.right-c.width,d=n.bottom+8;o<8&&(o=8),o+c.width>r-8&&(o=r-c.width-8),d+c.height>i-8&&(d=n.top-c.height-8),d<8&&(d=8),t.style.left=`${o}px`,t.style.top=`${d}px`},[jt.open,jt.anchor]),a.useEffect(()=>{s||lt({open:!1,anchor:null})},[s]);function dr(t){l(n=>{try{n&&n!==t&&(ie.data||[]).find(c=>c.conversation.id===n)?.conversation?.isSecret&&F.removeQueries({queryKey:["messages",n]})}catch{}return t}),R&&we("conversation"),oi.current.length&&Ji()}async function Ks(){let t=br();return t||(t=await Jo()),t||null}async function Qs(t){if(Gs)return;qs(!0);const n=2;let r=0;const i=async()=>{if(r>=n)throw new Error("Не удалось подготовить устройство для секретного чата. Попробуйте позже.");r+=1,await Qo()};try{for(;;){const c=await Ks();if(!c){alert("Не удалось инициализировать устройство для секретного чата");return}try{const o={participantIds:[t],isGroup:!1,isSecret:!0,initiatorDeviceId:c.deviceId};console.log("[SecretChat] Creating with payload:",o),await ae.post("/conversations",o),F.invalidateQueries({queryKey:["conversations"]});return}catch(o){console.error("[SecretChat] Creation error:",o?.response?.data||o);const d=o?.response?.data?.message,f=o?.response?.data?.errors;if(f&&console.error("[SecretChat] Validation errors:",f),o?.response?.status===400&&typeof d=="string"&&d.toLowerCase().includes("invalid initiator device")){await i();continue}const p=f?`Ошибка валидации: ${f.map(j=>`${j.path.join(".")}: ${j.message}`).join(", ")}`:d||"Не удалось отправить запрос на секретный чат";throw new Error(p)}}}catch(c){console.error("Failed to start secret conversation:",c);const o=c?.message||c?.response?.data?.message||"Не удалось отправить запрос на секретный чат";alert(o)}finally{qs(!1)}}const Js=async t=>{ui(!0);try{Zo(t),Nr(n=>{const r={...n};return delete r[t],r}),F.invalidateQueries({queryKey:["conversations"]})}finally{ui(!1)}},io=async t=>{ui(!0);try{const n=await Ks();if(!n){alert("Не удалось инициализировать устройство для секретного чата");return}ec(t,n.deviceId),F.invalidateQueries({queryKey:["conversations"]}),dr(t)}catch(n){console.error("Failed to accept secret chat:",n),alert("Не удалось принять секретный чат")}finally{ui(!1)}};async function Zs(t,n){if(!t)return;const r={...n,content:n.content??void 0};if(t.isSecret){const i=await ln.encryptPayload(t,r);await ae.post("/conversations/send",i);return}await ae.post("/conversations/send",{conversationId:t.id,...r})}const ur=()=>{Pt(!1),Zn([]),bn(!1),g("friends"),E(["","","",""]),q(null),B(null),Le(!1)},so=async()=>{if(!s||dn.length===0){ur();return}bn(!0);try{await ae.post(`/conversations/${s}/participants`,{participantIds:dn}),F.invalidateQueries({queryKey:["conversations"]}),ie.refetch(),ur()}catch(t){console.error("Error adding participants:",t),alert(t.response?.data?.message||"Не удалось добавить участников")}finally{bn(!1)}},ao=async()=>{if(!(!s||!I)){bn(!0);try{await ae.post(`/conversations/${s}/participants`,{participantIds:[I.id]}),F.invalidateQueries({queryKey:["conversations"]}),ie.refetch(),ur()}catch(t){console.error("Error adding participant by EBLID:",t),alert(t.response?.data?.message||"Не удалось добавить участника")}finally{bn(!1)}}},oo=(t,n)=>{if(!/^\d?$/.test(n))return;const r=[...L];r[t]=n,E(r),n&&t<3&&V[t+1].current?.focus(),!n&&t>0&&V[t-1].current?.focus();const i=r.join("");if(i.length===4&&/^\d{4}$/.test(i)){const c=Date.now();ke.current=c,Le(!0),B(null),ae.get("/contacts/search",{params:{query:i}}).then(o=>{if(ke.current!==c)return;const d=o.data.results?.[0]??null;q(d),B(d?null:"Пользователь не найден")}).catch(()=>{ke.current===c&&(q(null),B("Не удалось выполнить поиск"))}).finally(()=>{ke.current===c&&Le(!1)})}else q(null),B(null),Le(!1)};function co(){if(R){if(s)try{(ie.data||[]).find(r=>r.conversation.id===s)?.conversation?.isSecret&&F.removeQueries({queryKey:["messages",s]})}catch{}we("list"),l(null),Rt(!1)}oi.current.length&&Ji()}const Vt=mr({queryKey:["me-info"],queryFn:async()=>(await ae.get("/status/me")).data.user}),ie=mr({queryKey:["conversations"],queryFn:async()=>(await ae.get("/conversations")).data.conversations}),$e=mr({queryKey:["messages",s],enabled:!!s,queryFn:async()=>(await ae.get(`/conversations/${s}/messages`)).data.messages,refetchInterval:s?15e3:!1});a.useEffect(()=>{$e.error?.response?.status===403&&s&&(console.warn("[ChatsPage] Lost access to conversation, closing view",s),F.removeQueries({queryKey:["messages",s]}),l(null))},[$e.error,s,F]);const bt=mr({queryKey:["accepted-contacts"],queryFn:async()=>(await ae.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),Bt=mr({queryKey:["incoming-contacts"],queryFn:async()=>(await ae.get("/contacts",{params:{filter:"incoming"}})).data.contacts});a.useEffect(()=>{if(s&&!(typeof window>"u"))try{window.localStorage.setItem(Pa,s)}catch{}},[s]),a.useEffect(()=>{if(typeof window>"u"||s)return;const t=ie.data;if(!(!t||t.length===0)&&!(yt.current&&Xe!=="conversation"))try{const n=window.localStorage.getItem(Pa);if(!n)return;t.some(i=>i?.conversation?.id===n)&&dr(n)}catch{}},[s,ie.data,Xe]);const is=()=>{if(At(!1),er(""),Hn([]),Cr(!1),hn)try{URL.revokeObjectURL(hn)}catch{}if(kt(null),je)try{URL.revokeObjectURL(je)}catch{}qt(null),tr(null),jn(null),en({x:0,y:0,scale:1}),Cn(!1)};a.useEffect(()=>{const t=X.current;if(!t)return;const n=()=>{const{scrollTop:r,scrollHeight:i,clientHeight:c}=t,o=r>2,d=i-r-c>2;rt(o),Jt(d)};return n(),t.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{t.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[ie.data?.length]),a.useEffect(()=>{try{const t=(ie.data||[]).map(n=>n.conversation.id);try{const r=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(r==="1"||r==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",t)}catch{}t.length>0&&ya(t);for(const n of t)try{xa(n)}catch{}}catch{}},[ie.data]);const k=a.useMemo(()=>ie.data?.find(t=>t.conversation.id===s)?.conversation,[ie.data,s]);a.useEffect(()=>()=>{Mr.current.forEach(t=>URL.revokeObjectURL(t)),Mr.current.clear(),ar.current.clear()},[]),a.useEffect(()=>{Mr.current.forEach(t=>URL.revokeObjectURL(t)),Mr.current.clear(),ar.current.clear(),ii({})},[k?.id]);const zr=a.useMemo(()=>br()?.deviceId??null,[ai]),xi=a.useMemo(()=>{const t={};for(const n of Hs.data||[])t[n.id]=n;return t},[Hs.data]),vi=a.useCallback(t=>{if(!t?.isSecret)return null;const n=[t.secretInitiatorDeviceId,t.secretPeerDeviceId];for(const r of n){if(!r)continue;const i=xi[r];if(i?.userId&&N?.id&&i.userId===N.id)return r}if(N?.id){if(t.createdById===N.id&&t.secretInitiatorDeviceId)return t.secretInitiatorDeviceId;if(t.createdById!==N.id&&t.secretPeerDeviceId)return t.secretPeerDeviceId}return null},[xi,N?.id]),hr=a.useMemo(()=>vi(k),[k,vi]),ea=a.useMemo(()=>{if(!hr)return;const t=xi[hr]?.name;if(t&&t.trim())return t;const n=br();if(n&&n.deviceId===hr&&n.name)return n.name},[hr,xi,ai]),ta=a.useCallback(t=>{if(!t)return!1;const n=(ie.data||[]).find(i=>i?.conversation?.id===t)?.conversation;if(!n?.isSecret)return!1;const r=vi(n);return!!(r&&zr&&r!==zr)},[ie.data,zr,vi]),bi=!!(k?.isSecret&&(k.secretStatus??"ACTIVE")!=="ACTIVE"),fr=a.useMemo(()=>k?.isSecret?ln.hasSession(k.id):!0,[k?.id,k?.isSecret,ai]),lo=!!(k?.isSecret&&!bi&&!fr&&hr&&zr&&hr!==zr);a.useEffect(()=>{if(!k?.isSecret||k.secretStatus!=="ACTIVE")return;let t=!1;return ln.ensureSession(k).then(n=>{!t&&n&&Ds(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{t=!0}},[k?.id,k?.secretStatus,k?.isSecret]),a.useEffect(()=>{if(!k?.isSecret||!$e.data||$e.data.length===0)return;ln.processHandshakes(k,$e.data)&&Ds(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[$e.data,k?.id,k?.isSecret,k?.secretStatus]);const $t=a.useMemo(()=>$e.data?k?.isSecret?$e.data.filter(t=>{const r=(t?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(t=>ln.transformMessage(k.id,t)):$e.data:[],[$e.data,k?.id,k?.isSecret,ai]),na=a.useCallback(t=>{if(!k?.id)return;const n=t?.metadata?.e2ee;!n||n.kind!=="ciphertext"||!n.nonce||!ln.hasSession(k.id)||ar.current.has(t.url)||Fn[t.url]?.status==="ready"||(ar.current.add(t.url),ii(i=>({...i,[t.url]:{status:"pending"}})),(async()=>{try{const i=Ti(t.url)||t.url,c=await fetch(i,{credentials:"omit"});if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const o=new Uint8Array(await c.arrayBuffer()),d=ln.decryptBinary(k.id,o,n.nonce);if(!d)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const f=new Blob([d],{type:n.originalType||t.metadata?.mime||t.metadata?.contentType||"application/octet-stream"}),u=URL.createObjectURL(f);Mr.current.add(u),ar.current.delete(t.url),ii(p=>({...p,[t.url]:{status:"ready",url:u}}))}catch(i){ar.current.delete(t.url),ii(c=>{const o={...c};return i?.message?.includes("E2EE session is not ready")?delete o[t.url]:o[t.url]={status:"error"},o})}})())},[k?.id,Fn]),wi=a.useCallback(t=>{if(!t)return null;const n=Ti(t.url);if(!k?.isSecret)return n;const r=t.metadata?.e2ee;if(!r||r.kind!=="ciphertext")return n;const i=Fn[t.url];return i?.status==="ready"&&i.url?i.url:null},[Fn,k?.isSecret]);a.useEffect(()=>{if(!k?.isSecret||!fr)return;($t||[]).flatMap(n=>n.attachments||[]).forEach(n=>{n?.metadata?.e2ee?.kind==="ciphertext"&&na(n)})},[$t,k?.id,k?.isSecret,fr,na]),a.useEffect(()=>{const t=new Set((ie.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));Nr(n=>{let r=!1;const i={...n};for(const c of Object.keys(i))t.has(c)||(delete i[c],r=!0);return r?i:n})},[ie.data]);const pr=a.useMemo(()=>{if(!k||k.isGroup||k.isSecret||!N?.id)return null;const t=Ua(k.participants||[]);if(!t)return null;const n=ie.data||[];for(const r of n){const i=r.conversation;if(!i?.isSecret||(i.secretStatus??"ACTIVE")!=="PENDING"||Ua(i.participants||[])!==t)continue;const o=(i.participants||[]).find(f=>f.user.id===i.createdById)?.user,d=Ys[i.id]?.from?.name??o?.displayName??o?.username??"Собеседник";return{conversationId:i.id,isInitiator:i.createdById===N.id,initiatorName:d}}return null},[k,ie.data,N?.id,Ys]),ra=a.useMemo(()=>{const t={};if(k)for(const n of k.participants)t[n.user.id]=n.user;return N&&!t[N.id]&&(t[N.id]=N),t},[k,N]),ss=a.useMemo(()=>k?(k.participants||[]).map(t=>t.user.id):[],[k]),ia=a.useMemo(()=>{if(!k||!bt.data)return[];const t=new Set(ss);return bt.data.filter(n=>!t.has(n.friend.id))},[k,bt.data,ss]),ji={alreadyInChat:I?ss.includes(I.id):!1,isSelf:I?I.id===N?.id:!1};a.useEffect(()=>{dt&&un==="eblid"&&V[0].current?.focus()},[dt,un]),a.useEffect(()=>{const t=n=>{eo(r=>{const i=(n.status||"").toString().toUpperCase();return r[n.userId]===i?r:{...r,[n.userId]:i}}),F.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(o=>o.user.id===n.userId?{...o,user:{...o.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="IN_CALL"||n.status==="OFFLINE"?new Date().toISOString():o.user.lastSeenAt}}:o)}})))};return va(t),()=>{_e.off("presence:update",t)}},[F]);const Gn=a.useCallback(t=>{const n=t?.id,r=typeof n=="string"?n:null,c=((r?$s[r]:void 0)??t?.status??"OFFLINE").toString().toUpperCase();return c==="IN_CALL"?"IN_CALL":c==="ONLINE"?"ONLINE":c==="BACKGROUND"?"BACKGROUND":c==="AWAY"?"AWAY":"OFFLINE"},[$s]),Ci=a.useRef(_e.connected);a.useEffect(()=>{const t=()=>{try{const c=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",c+"px")}catch{}F.invalidateQueries({queryKey:["me-info"]}),ci(_e.connected)};window.addEventListener("focus",t);const n=()=>{ci(!0);const c=Ci.current;if(Ci.current=!0,c)try{const o=(ie.data||[]).map(d=>d.conversation.id);for(const d of o)try{xa(d)}catch{}o.length>0&&ya(o)}catch{}},r=()=>{ci(!1),Ci.current=!1};_e.on("connect",n),_e.on("disconnect",r),ci(_e.connected),_e.connected&&(Ci.current=!0);const i=()=>{F.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",i),()=>{_e.off("connect",n),_e.off("disconnect",r),document.removeEventListener("visibilitychange",i),window.removeEventListener("focus",t)}},[F]),a.useEffect(()=>{const t=n=>{if(N?.id&&n.userId===N.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="IN_CALL"||r==="OFFLINE")&&Bs(r)}};return va(t),()=>{_e.off("presence:update",t)}},[N?.id]),a.useEffect(()=>{const t=(Vt.data?.status||"").toString().toUpperCase();(t==="ONLINE"||t==="AWAY"||t==="BACKGROUND"||t==="IN_CALL"||t==="OFFLINE")&&Bs(t)},[Vt.data]),a.useEffect(()=>{const t=n=>{F.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(c=>c.user.id===n.userId?{...c,user:{...c.user,avatarUrl:n.avatarUrl??c.user.avatarUrl,displayName:n.displayName??c.user.displayName}}:c)}}))),n.userId===N?.id&&Vt.refetch()};return Lo(t),()=>{_e.off("profile:update",t)}},[F,N?.id]);function uo(t){return"#191d23"}a.useEffect(()=>{if(!s)return;const t=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const i=n.clipboardData?.items;if(i)for(let c=0;c<i.length;c++){const o=i[c];if(o.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const d=o.getAsFile();d&&Tr(d,"paste");break}}};return window.addEventListener("paste",t,!0),()=>{window.removeEventListener("paste",t,!0)}},[s,Tr]),a.useEffect(()=>{ie.refetch(),zo(),Po(()=>ie.refetch()),Uo(r=>{const i=r?.conversationId;if(!i){ie.refetch();return}Nr(o=>{if(!o[i])return o;const d={...o};return delete d[i],d}),Ir(o=>{if(!o[i])return o;const d={...o};return delete d[i],d}),ln.clearSession(i),F.removeQueries({queryKey:["messages",i]}),F.setQueryData(["conversations"],o=>Array.isArray(o)?o.filter(d=>d?.conversation?.id!==i):o),Us.current===i&&(l(o=>o===i?null:o),Rt(!1),oi.current.length&&Ji(),yt.current&&we("list")),ie.refetch()}),Ho(()=>{ie.refetch()}),Wo(()=>{ie.refetch()});const t=Bo(r=>{Nr(i=>({...i,[r.conversationId]:r})),ie.refetch()}),n=$o(r=>{Nr(i=>{const c={...i};return delete c[r.conversationId],c}),F.invalidateQueries({queryKey:["conversations"]}),dr(r.conversationId)});_o(({conversationId:r,from:i,video:c})=>{if(!(fe.current&&fe.current===r)){_t();try{const o=F.getQueryData(["conversations"]),d=Array.isArray(o)?o.find(p=>p.conversation.id===r)?.conversation:null,f=!!(d&&(d.isGroup||(d.participants?.length??0)>2));ro.current[r]=i.id;const u=Yn.current===r;if(f||u||i?.id&&N?.id&&i.id===N.id)return}catch{}fe.current=r,Y.startIncoming({conversationId:r,from:i,video:c});try{const o=sa();o&&(o.currentTime=0,o.loop=!0,o.volume=.9,o.play().catch(()=>{}))}catch(o){console.error("Error starting ringtone:",o)}P.current=window.setTimeout(()=>{ma(r),_t(),Y.setIncoming(null)},25e3)}}),Oo(({conversationId:r,by:i,video:c})=>{if(Mn(r),M(u=>u?.conversationId===r?(T.current&&(window.clearTimeout(T.current),T.current=null),qn(),null):u),i?.id===N?.id){(Y.incoming?.conversationId===r||fe.current===r)&&(_t(),Y.setIncoming(null),P.current&&(window.clearTimeout(P.current),P.current=null),fe.current=null);return}const o=Yn.current===r,d=Br.getState().activeConvId===r,f=Q.current?.conversationId===r;if(!o&&!d&&!f){(Br.getState().incoming?.conversationId===r||fe.current===r)&&(_t(),Y.setIncoming(null),P.current&&(window.clearTimeout(P.current),P.current=null),fe.current=null);return}if(It(u=>u[r]?.active?u:{...u,[r]:{startedAt:Date.now(),active:!0,participants:[N?.id||""].filter(Boolean)}}),Y.activeConvId!==r){const u=!!c;Y.startOutgoing(r,u)}y(r),S(u=>u===r?null:u),_t()}),Fo(({conversationId:r})=>{M(c=>c?.conversationId===r?(T.current&&(window.clearTimeout(T.current),T.current=null),qn(),Si(),null):c);const i=()=>{It(c=>{const o=c[r];if(o){if(o.active)return{...c,[r]:{...o,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}return c}),Yn.current===r&&(y(c=>c===r?null:c),S(c=>c===r?null:c),Y.endCall()),Y.setIncoming(null),_t(),Mn(r)};lr(r)?ts(r,i,{force:!0}):i()}),Xo(({conversationId:r})=>{try{const c=F.getQueryData(["conversations"]),o=Array.isArray(c)?c.find(f=>f.conversation.id===r)?.conversation:null;if(!!(o&&(o.isGroup||(o.participants?.length??0)>2)))return}catch{}if(m===r)return;if(lr(r)){const c=gn[r];if((Yn.current===r||Y.activeConvId===r)&&c?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",r);return}}const i=()=>{M(c=>c?.conversationId===r?(T.current&&(window.clearTimeout(T.current),T.current=null),qn(),null):c),It(c=>{const o=c[r];if(o?.active)return{...c,[r]:{...o,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}),Yn.current===r&&(y(c=>c===r?null:c),S(c=>c===r?null:c),Y.endCall()),Y.setIncoming(null),_t(),Mn(r)};lr(r)?ts(r,i,{force:!0}):i()}),Yo(({conversationId:r})=>{F.invalidateQueries({queryKey:["messages",r]}),F.refetchQueries({queryKey:["messages",r]})});try{ge.current||(ge.current=new Audio("/notify.mp3"),ge.current.preload="auto",ge.current.volume=.9);const r=async()=>{try{if(ge.current&&!re.current&&(ge.current.volume=0,await ge.current.play(),ge.current.pause(),ge.current.currentTime=0,ge.current.volume=.9,re.current=!0),!ot.current){const i=sa();if(i){const c=i.volume;i.volume=0,await i.play().catch(()=>{}),i.pause(),i.currentTime=0,i.volume=c,ot.current=!0}}}catch{}re.current&&ot.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{t?.(),n?.()}},[]),a.useEffect(()=>{Go(()=>{Bt.refetch()}),qo(()=>{bt.refetch(),ie.refetch(),Bt.refetch()}),Vo(()=>{bt.refetch(),Bt.refetch()})},[]),a.useEffect(()=>{if(!Ht)return;const t=$n.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,v=p.clientY-u.clientY;return Math.sqrt(j*j+v*v)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,v,w)=>{const C=u-j,b=p-v;return C*C+b*b<=w*w},o=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,v=p.height,w=j/2,C=v/2,b=i/2;if(u.touches.length===1){const A=u.touches[0],U=A.clientX-p.left,H=A.clientY-p.top;if(!c(U,H,w,C,b))return;pt.current={touches:[A],initialDistance:0,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}else if(u.touches.length===2){const A=u.touches[0],U=u.touches[1],H=r(A,U),ce=H.x-p.left,de=H.y-p.top;if(!c(ce,de,w,C,b))return;const ue=n(A,U);pt.current={touches:[A,U],initialDistance:ue,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}},d=u=>{pt.current&&(u.preventDefault(),_n.current!==null&&cancelAnimationFrame(_n.current),_n.current=requestAnimationFrame(()=>{if(!pt.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,v=p.height,w=j/2,C=v/2,b=u.touches.length,A=pt.current.touches.length;if(b===1&&A===1){const U=u.touches[0],H=pt.current.touches[0],ce=U.clientX-H.clientX,de=U.clientY-H.clientY;kn(ue=>{let K=pt.current.initialX+ce,se=pt.current.initialY+de;const O=Oi.current;if(O){const ne=ue.scale,le=O.naturalWidth*ne,Ue=O.naturalHeight*ne,Ke=w+i/2,He=w-i/2-le,mt=C+i/2,mn=C-i/2-Ue;K=Math.max(He,Math.min(Ke,K)),se=Math.max(mn,Math.min(mt,se))}return{...ue,x:K,y:se}})}else if(b===2&&A===2){const U=u.touches[0],H=u.touches[1],de=n(U,H)/pt.current.initialDistance,ue=Math.max(.1,Math.min(10,pt.current.initialScale*de)),K=Oi.current;if(K){const se=K.naturalWidth,O=K.naturalHeight,ne=pt.current.initialX+se*pt.current.initialScale/2,le=pt.current.initialY+O*pt.current.initialScale/2,Ue=ne-w,Ke=le-C,He=ue/pt.current.initialScale,mt=w+Ue*He,mn=C+Ke*He,Pr=mt-se*ue/2,yn=mn-O*ue/2;kn({x:Pr,y:yn,scale:ue})}}_n.current=null}))},f=()=>{_n.current!==null&&(cancelAnimationFrame(_n.current),_n.current=null),pt.current=null};return t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",o),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[Ht,Ie.scale,Ie.x,Ie.y]),a.useEffect(()=>{if(!Wt)return;const t=In.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,v=p.clientY-u.clientY;return Math.sqrt(j*j+v*v)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,v,w)=>{const C=u-j,b=p-v;return C*C+b*b<=w*w},o=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,v=p.height,w=j/2,C=v/2,b=i/2;if(u.touches.length===1){const A=u.touches[0],U=A.clientX-p.left,H=A.clientY-p.top;if(!c(U,H,w,C,b))return;gt.current={touches:[A],initialDistance:0,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},u.preventDefault()}else if(u.touches.length===2){const A=u.touches[0],U=u.touches[1],H=r(A,U),ce=H.x-p.left,de=H.y-p.top;if(!c(ce,de,w,C,b))return;const ue=n(A,U);gt.current={touches:[A,U],initialDistance:ue,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},u.preventDefault()}},d=u=>{gt.current&&(u.preventDefault(),On.current!==null&&cancelAnimationFrame(On.current),On.current=requestAnimationFrame(()=>{if(!gt.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,v=p.height,w=j/2,C=v/2,b=u.touches.length,A=gt.current.touches.length;if(b===1&&A===1){const U=u.touches[0],H=gt.current.touches[0],ce=U.clientX-H.clientX,de=U.clientY-H.clientY;tn(ue=>{let K=gt.current.initialX+ce,se=gt.current.initialY+de;const O=Qr.current;if(O){const ne=ue.scale,le=O.naturalWidth*ne,Ue=O.naturalHeight*ne,Ke=w+i/2,He=w-i/2-le,mt=C+i/2,mn=C-i/2-Ue;K=Math.max(He,Math.min(Ke,K)),se=Math.max(mn,Math.min(mt,se))}return{...ue,x:K,y:se}})}else if(b===2&&A===2){const U=u.touches[0],H=u.touches[1],de=n(U,H)/gt.current.initialDistance,ue=Math.max(.1,Math.min(10,gt.current.initialScale*de)),K=Qr.current;if(K){const se=K.naturalWidth,O=K.naturalHeight,ne=gt.current.initialX+se*gt.current.initialScale/2,le=gt.current.initialY+O*gt.current.initialScale/2,Ue=ne-w,Ke=le-C,He=ue/gt.current.initialScale,mt=w+Ue*He,mn=C+Ke*He,Pr=mt-se*ue/2,yn=mn-O*ue/2;tn({x:Pr,y:yn,scale:ue})}}On.current=null}))},f=()=>{On.current!==null&&(cancelAnimationFrame(On.current),On.current=null),gt.current=null};return t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",o),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[Wt,Me.scale,Me.x,Me.y]);const sa=a.useCallback(()=>{if(typeof window>"u")return null;if(!Se.current){const t=new Audio("/ring.mp3");t.preload="auto",t.loop=!0,t.volume=.9,Se.current=t}return Se.current},[]);function _t(){try{if(P.current&&clearTimeout(P.current),P.current=null,Se.current)try{Se.current.pause(),Se.current.currentTime=0}catch{}fe.current=null}catch{}}const ho=a.useCallback(()=>{if(typeof window>"u")return null;if(!We.current){const t=new Audio("/dialing.mp3");t.preload="auto",t.loop=!0,t.volume=.7,We.current=t}return We.current},[]);function aa(){try{const t=ho();t&&(t.currentTime=0,t.loop=!0,t.volume=.7,t.play().catch(()=>{}))}catch(t){console.error("Error starting dialing sound:",t)}}function qn(){try{if(We.current)try{We.current.pause(),We.current.currentTime=0}catch{}}catch{}}const fo=a.useCallback(()=>{if(typeof window>"u")return null;if(!Ae.current){const t=new Audio("/notify.mp3");t.preload="auto",t.volume=.6,Ae.current=t}return Ae.current},[]);function Si(){try{const t=fo();t&&(t.currentTime=0,t.volume=.6,t.play().catch(()=>{}))}catch(t){console.error("Error playing end call sound:",t)}}a.useEffect(()=>{const t=async i=>{if(!(i.conversationId===s)){F.invalidateQueries({queryKey:["conversations"]});return}if(!s)return;const d=i.message??i;d&&d.id&&(Ir(f=>{const u=f[s]||[];if(u.length===0)return f;const p=(d.attachments||[]).map(v=>v.url).sort(),j=u.filter(v=>{if(v.senderId!==d.senderId)return!0;const w=v.attachments.map(C=>C.url).sort();return w.length===p.length?!w.every((b,A)=>{const U=p[A];return b===U||b.startsWith("blob:")&&U&&!U.startsWith("blob:")}):!0});if(j.length===u.length)return f;if(j.length===0){const{[s]:v,...w}=f;return w}return{...f,[s]:j}}),da(s,d)),$e.refetch()},n=i=>{i.conversationId===s&&(zt(!0),ct.current&&window.clearTimeout(ct.current),ct.current=window.setTimeout(()=>zt(!1),2e3))},r=i=>{if(!s||i.conversationId!==s){F.invalidateQueries({queryKey:["conversations"]});return}i.message?Co(s,i.message):$e.refetch()};return _e.on("message:new",t),_e.on("conversation:typing",n),_e.on("message:reaction",r),()=>{_e.off("message:new",t),_e.off("conversation:typing",n),_e.off("message:reaction",r)}},[s]),a.useEffect(()=>{const t=async n=>{if(ta(n.conversationId))return;const r=n.senderId===N?.id,i=n.conversationId===s,c=document.visibilityState==="visible";if(!r&&(!i||!c)&&ge.current&&re.current&&(ge.current.currentTime=0,ge.current.play().catch(()=>{})),i){n.message&&n.message.id&&da(s,n.message),$e.refetch().catch(()=>{});return}};return _e.on("message:notify",t),()=>{_e.off("message:notify",t)}},[s,N?.id,$e,ta]),a.useLayoutEffect(()=>{if(!s){wn.current=null,Et.current=0;return}wn.current!==s&&(wn.current=s,Et.current=0);const t=($t?.length??0)+hi.length,n=Et.current;if(Et.current=t,!pe.current||t===0||t<=n)return;const r=[...$t||[],...hi],i=r[r.length-1],c=i?.senderId&&N?.id?i.senderId===N.id:!1;(c||!ut.current||ve.current)&&requestAnimationFrame(()=>{const d=pe.current;d&&(d.scrollTop=d.scrollHeight,ve.current=!0,c&&(ut.current=!1))})},[s,hi,$t,N?.id]),a.useEffect(()=>{if(!s)return;const t=pe.current;if(!t)return;const n=()=>{t&&(t.scrollTop=t.scrollHeight,ve.current=!0,ut.current=!1)};if(yt.current){n();const r=window.setTimeout(n,50),i=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(i)}}n()},[s]),a.useEffect(()=>{if(!yt.current)return;const t=pe.current;if(!t)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===D.current&&(t.scrollTop=t.scrollHeight,ve.current=!0,ut.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[s]),a.useEffect(()=>{},[]),a.useEffect(()=>{if(!Te||!yt.current)return;const t=pe.current,n=window.setInterval(()=>{Ce(r=>r%3+1),t&&t.scrollHeight-t.scrollTop-t.clientHeight<80&&(t.scrollTop=t.scrollHeight)},500);return()=>window.clearInterval(n)},[Te]),a.useEffect(()=>{const t=pe.current;if(!t)return;let n=0,r=t.scrollTop;const i=()=>{n&&cancelAnimationFrame(n);const c=t.scrollTop;Math.abs(c-r)>1&&(ut.current=!0),n=requestAnimationFrame(()=>{const d=t.scrollHeight-t.scrollTop-t.clientHeight<8;ve.current=d,Rt(!d),d&&window.setTimeout(()=>{t.scrollHeight-t.scrollTop-t.clientHeight<40&&(ut.current=!1)},100),r=t.scrollTop})};return t.addEventListener("scroll",i,{passive:!0}),i(),()=>{t.removeEventListener("scroll",i),n&&cancelAnimationFrame(n)}},[s]),a.useEffect(()=>{const t=()=>{if(!pe.current)return;const n=pe.current.clientWidth;nt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]);function po(t,n){if(!/^\d?$/.test(n))return;const r=[...Ui];r[t]=n,Fa(r),n&&t<3&&Hi[t+1].current?.focus(),!n&&t>0&&Hi[t-1].current?.focus();const i=r.join("");i.length===4&&/^\d{4}$/.test(i)?(async()=>{try{const c=await ae.get("/contacts/search",{params:{query:i}});Wi(c.data.results?.[0]??null)}catch{Wi(null)}})():Wi(null)}async function go(){Fr(!0);try{const t=await ae.get("/status/me");Ya(t.data.user?.eblid??"")}catch{}}async function mo(){const t=Ui.join("");if(/^\d{4}$/.test(t)){Bi(!0);try{await ae.post("/contacts/add",{identifier:t}),Bi(!1)}catch{Bi(!1)}}}function ki(){if(!s||!$e.data||!N?.id)return;const t=$e.data.filter(n=>n.senderId!==N.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===N.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);t.length!==0&&ae.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{F.invalidateQueries({queryKey:["messages",s]})}).catch(()=>{})}a.useEffect(()=>{document.hasFocus()&&ki(),s&&(ae.post("/messages/mark-conversation-read",{conversationId:s}).catch(()=>{}),F.setQueryData(["conversations"],t=>t&&t.map(n=>n.conversation.id===s?{...n,unreadCount:0}:n)))},[s]),a.useEffect(()=>{document.hasFocus()&&ki()},[$e.data]),a.useEffect(()=>{const t=()=>ki(),n=()=>{document.visibilityState==="visible"&&ki()};return window.addEventListener("focus",t),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",t),document.removeEventListener("visibilitychange",n)}},[s,$e.data]);function yo(){ht.current||(ht.current=window.setTimeout(()=>{const t=Array.from(xt.current);xt.current.clear(),ht.current&&clearTimeout(ht.current),ht.current=null,t.length&&ae.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{s&&F.invalidateQueries({queryKey:["messages",s]})}).catch(()=>{})},250))}a.useEffect(()=>{if(!s||!$e.data||!N?.id)return;Ut.current?.disconnect();const t=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const i=r.target,c=i.dataset.mid;if(!c)continue;const o=$e.data.find(f=>f.id===c);!o||o.senderId===N.id||(o.receipts||[]).some(f=>f.userId===N.id&&(f.status==="READ"||f.status==="SEEN"))||(xt.current.add(c),t.unobserve(i))}xt.current.size&&yo()},{root:pe.current,threshold:[.25]});Ut.current=t;for(const n of $e.data){if(n.senderId===N.id||(n.receipts||[]).some(c=>c.userId===N.id&&(c.status==="READ"||c.status==="SEEN")))continue;const i=St.current.get(n.id);i&&t.observe(i)}return()=>{t.disconnect()}},[s,$e.data,N?.id]),a.useEffect(()=>{const t=()=>{if(!pe.current)return;const n=pe.current.clientWidth;nt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]);async function as(t,n="",r){if(!s||t.length===0)return;const i=!!k?.isSecret;if(i){if(bi){alert("Секретный чат больше не активен, отправка вложений отключена.");return}if(!fr){alert("Секретный чат ещё не готов к вложениям, подождите установления защищённой сессии.");return}}ri(!0),ir(0);try{const c=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,o=[],d=t.reduce((j,v)=>j+v.size,0);for(const j of t)if(j.type.startsWith("image/")){const v=URL.createObjectURL(j),{width:w,height:C}=await xo(v);o.push({url:v,type:"IMAGE",width:w,height:C,progress:0,__pending:!0})}else o.push({url:j.name,type:"FILE",__pending:!0,progress:0});Ir(j=>({...j,[s]:[...j[s]||[],{id:c,createdAt:Date.now(),senderId:N?.id||"me",attachments:o,content:n}]}));const f=[];let u=0;for(let j=0;j<t.length;j++){const v=t[j],w=o[j];let C=v,b;if(i&&k){const de=new Uint8Array(await v.arrayBuffer()),ue=await ln.encryptBinary(k,de);C=new Blob([ue.cipher],{type:"application/octet-stream"}),b={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:ue.nonce,originalName:v.name,originalType:v.type,originalSize:v.size}}const A=new FormData;A.append("file",C,i?`${v.name||"file"}.enc`:v.name);const H={url:await new Promise((de,ue)=>{const K=new XMLHttpRequest;K.open("POST","/api/upload");try{const se=Jn.getState().session?.accessToken;se&&K.setRequestHeader("Authorization",`Bearer ${se}`)}catch{}K.upload.onprogress=se=>{if(se.lengthComputable){const O=Math.round((u+se.loaded)/d*100);ir(O),Ir(ne=>{const Ue=(ne[s]||[]).map(He=>({...He,attachments:He.attachments.map(mt=>({...mt}))})),Ke=Ue[Ue.length-1];if(Ke){const He=Ke.attachments.findIndex(mt=>mt.__pending&&mt.type===(v.type.startsWith("image/")?"IMAGE":"FILE")&&(!mt.width||mt.url.startsWith("blob:")));He>=0&&(Ke.attachments[He].progress=O)}return{...ne,[s]:Ue}})}},K.onreadystatechange=()=>{if(K.readyState===4)if(K.status>=200&&K.status<300)try{const se=JSON.parse(K.responseText);de(se.url)}catch(se){ue(se)}else ue(new Error("upload failed"))},K.send(A)}),type:v.type.startsWith("image/")?"IMAGE":"FILE"},ce={};w&&w.type==="IMAGE"&&w.width&&w.height&&(ce.width=w.width,ce.height=w.height),b&&(ce.e2ee=b),Object.keys(ce).length>0&&(H.metadata=ce),f.push(H),u+=v.size,ir(Math.round(u/d*100))}const p=f.every(j=>j.type==="IMAGE")?"IMAGE":"FILE";await ae.post("/conversations/send",{conversationId:s,type:p,content:n,attachments:f,replyToId:r}),Ir(j=>{const w=(j[s]||[]).filter(C=>C.id!==c);if(w.length===0){const{[s]:C,...b}=j;return b}return{...j,[s]:w}}),F.invalidateQueries({queryKey:["messages",s]})}catch(c){console.error("Failed to upload attachments",c)}ri(!1)}async function xo(t){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=t})}const vo=async()=>{if(s&&!Ns)try{if(!(await Da({audio:!0})).ok){alert("Необходимо разрешение на использование микрофона для записи голосовых сообщений");return}_t(),Qi([]);const n=new bl({onStateChange:r=>{Vi(r==="recording"),r!=="recording"&&or.current&&(clearInterval(or.current),or.current=null)},onDurationUpdate:r=>{Ki(r)},onAmplitudeUpdate:r=>{Qi(i=>{const c=R?60:zs,o=[...i,r];return o.length>c?o.slice(-c):o})},onError:r=>{console.error("Voice recording error:",r),alert("Ошибка записи голосового сообщения"),oa()}});pn.current=n,await n.start()}catch(t){console.error("Failed to start voice recording:",t),alert("Не удалось начать запись голосового сообщения")}},oa=()=>{if(!pn.current)return;const t=pn.current,n=t.getDuration(),r=t.stop();pn.current=null,Vi(!1),Ki(0),r&&s&&wo(r,n)},bo=()=>{pn.current&&(pn.current.cancel(),pn.current=null),or.current&&(clearInterval(or.current),or.current=null),Vi(!1),Ki(0),Qi([])},wo=async(t,n)=>{if(!s)return;const r=!!k?.isSecret;if(r){if(bi){alert("Секретный чат больше не активен, отправка голосовых сообщений отключена.");return}if(!fr){alert("Секретный чат ещё не готов к голосовым сообщениям, подождите установления защищённой сессии.");return}}ri(!0),ir(0);try{const i=new File([t],"voice-message.webm",{type:t.type||"audio/webm"});let c=i,o;if(r&&k){const p=new Uint8Array(await i.arrayBuffer()),j=await ln.encryptBinary(k,p);c=new Blob([j.cipher],{type:"application/octet-stream"}),o={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:j.nonce,originalName:i.name,originalType:i.type,originalSize:i.size}}const d=new FormData;d.append("file",c,r?`${i.name}.enc`:i.name);const u={url:await new Promise((p,j)=>{const v=new XMLHttpRequest;v.open("POST","/api/upload");try{const w=Jn.getState().session?.accessToken;w&&v.setRequestHeader("Authorization",`Bearer ${w}`)}catch{}v.upload.onprogress=w=>{if(w.lengthComputable){const C=Math.round(w.loaded/w.total*100);ir(C)}},v.onreadystatechange=()=>{if(v.readyState===4)if(v.status>=200&&v.status<300)try{const w=JSON.parse(v.responseText);p(w.url)}catch(w){j(w)}else j(new Error("upload failed"))},v.send(d)}),type:"AUDIO",size:i.size,...o?{metadata:{e2ee:o}}:{}};await ae.post("/conversations/send",{conversationId:s,type:"AUDIO",metadata:{duration:n},attachments:[u],replyToId:J?.id}),he(null),F.invalidateQueries({queryKey:["messages",s]})}catch(i){console.error("Failed to send voice message",i),alert("Не удалось отправить голосовое сообщение")}finally{ri(!1),ir(0)}};a.useEffect(()=>()=>{pn.current&&pn.current.cleanup()},[]),a.useEffect(()=>{let t=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Ws(Math.round(performance.now()-r))}catch{Ws(null)}};return n(),t=window.setInterval(n,15e3),()=>{t&&clearInterval(t)}},[]),a.useEffect(()=>{let t=null;const n=()=>F.invalidateQueries({queryKey:["conversations"]});return t=window.setInterval(n,2e4),()=>{t&&clearInterval(t)}},[F]);const jo=a.useMemo(()=>{const t=new Set;try{const n=ie.data||[],r=new Map;for(const i of n){const c=i?.conversation;c?.id&&r.set(c.id,c)}for(const[i,c]of Object.entries(gn||{})){if(!c?.active)continue;const o=r.get(i);if(!!!(o&&(o.isGroup||(o.participants?.length??0)>2)))continue;const f=c.participants||[];for(const u of f)t.add(u)}}catch{}return t},[gn,ie.data]);function os(t){const n=t?.id?Gn(t):t?.status??"OFFLINE",r=t.lastSeenAt?new Date(t.lastSeenAt):null;if(n==="ONLINE")return"ОНЛАЙН";if(n==="BACKGROUND")return"В ФОНЕ";if(n==="IN_CALL"){const j=typeof t?.id=="string"?t.id:null;return j&&jo.has(j)?"В БЕСЕДЕ":"В ЗВОНКЕ"}if(!r)return"оффлайн";const c=new Date().getTime()-r.getTime(),o=Math.floor(c/6e4);if(o<1)return"был(а) онлайн только что";if(o<60)return`был(а) онлайн ${o} мин назад`;const d=Math.floor(o/60);if(d<24)return`был(а) онлайн ${d} ч назад`;const f={hour:"2-digit",minute:"2-digit"},u=r.toLocaleDateString(),p=r.toLocaleTimeString([],f);return`был(а) онлайн ${u} в ${p}`}function cs(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/3600),i=Math.floor(n%3600/60),c=n%60;return r>0?`${r}:${String(i).padStart(2,"0")}:${String(c).padStart(2,"0")}`:`${i}:${String(c).padStart(2,"0")}`}function ca(t){const n=t?"conversations-list slider-panel":"conversations-list";return e.jsxs("aside",{className:n,children:[e.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{className:"logo",children:[e.jsx("span",{children:"Е"}),e.jsx("span",{className:"b",children:"Б"}),e.jsx("span",{children:"луша"})]}),e.jsx("div",{className:"subtitle",children:"Здесь мы общаемся"})]})}),e.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx("div",{ref:X,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:ie.data?.slice().sort((r,i)=>{const c=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(i.conversation.messages?.[0]?.createdAt?new Date(i.conversation.messages[0].createdAt).getTime():0)-c}).filter(r=>{const i=r.conversation;return!(i.isSecret&&(i.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const i=r.conversation,c=i.participants.filter(C=>Tt?C.user.id!==Tt:!0).map(C=>C.user),o=c.map(C=>C.displayName??C.username).join(", ")||"Диалог",d=i.title??o,f=i.isGroup||i.participants.length>2,u=!!i.isSecret;c.map(C=>C.displayName??C.username).join(", ");const p=s===i.id,v=!!gn[i.id]?.active,w=h===i.id;return e.jsxs("div",{onContextMenu:C=>{C.preventDefault(),C.stopPropagation(),!t&&Yt({open:!0,x:C.clientX,y:C.clientY,conversationId:i.id})},onClick:()=>dr(i.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...v?{background:w?"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)":"linear-gradient(135deg, rgba(217, 119, 6, 0.10) 0%, rgba(227, 139, 10, 0.12) 100%)",borderColor:"var(--brand-600)",...w?p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.22), 0 6px 16px rgba(227,139,10,0.14)"}:p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.16)"}}:{}},children:[f?e.jsx(et,{name:d?.trim()?.charAt(0)||"Г",id:i.id,avatarUrl:i.avatarUrl&&i.avatarUrl.trim()?i.avatarUrl:void 0,presence:v?"IN_CALL":void 0}):e.jsx(et,{name:c[0]?.displayName??c[0]?.username??"D",id:c[0]?.id??i.id,presence:v?"IN_CALL":Gn(c[0]),avatarUrl:c[0]?.avatarUrl&&c[0].avatarUrl.trim()?c[0].avatarUrl:void 0}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:d}),!f&&u&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:e.jsx(Sa,{size:12,color:"#22c55e"})})]}),e.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} непрочитанных`:(()=>{const C=gn[i.id];if(C?.active){const b=C.startedAt?Date.now()-C.startedAt:typeof C.elapsedMs=="number"?C.elapsedMs:0;return e.jsx("span",{children:cs(b)})}else if(C&&C.endedAt){const b=C.endedAt,U=Date.now()-b,H=Math.floor(U/6e4);if(H<1)return e.jsx("span",{children:"Завершен только что"});if(H<60)return e.jsxs("span",{children:["Завершен ",H," мин назад"]});const ce=Math.floor(H/60);if(ce<24)return e.jsxs("span",{children:["Завершен ",ce," ч назад"]});const de=new Date(b),ue=de.toLocaleDateString(),K=de.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Завершен ",ue," в ",K]})}return f?null:os(c[0]??{})})()})]}),t&&e.jsx("button",{type:"button","aria-label":"Меню беседы",title:"Меню",onClick:C=>{C.preventDefault(),C.stopPropagation();const b=C.currentTarget.getBoundingClientRect();Yt({open:!0,x:Math.round(b.right-8),y:Math.round(b.bottom+6),conversationId:i.id})},style:{flexShrink:0,width:36,height:36,borderRadius:10,border:"1px solid transparent",background:"transparent",color:"var(--text-muted)",display:"inline-flex",alignItems:"center",justifyContent:"center",marginLeft:8,WebkitTapHighlightColor:"transparent"},children:e.jsx(yr,{size:20})})]},i.id)})}),ze&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),Gt&&e.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),e.jsxs("div",{className:"conv-footer",children:[e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:12},children:[e.jsxs("div",{onClick:()=>At(!0),className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(vc,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Беседа"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Групповой чат"})]})]}),e.jsxs("div",{onClick:go,className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:Bt.data&&Bt.data.length>0?e.jsx(dc,{size:22}):bt.data&&bt.data.length>0?e.jsx(qc,{size:22}):e.jsx(Ta,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Контакты"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:Bt.data&&Bt.data.length>0?"Новый запрос в друзья":bt.data&&bt.data.length>0?"Список контактов":"Добавить контакт"})]})]})]}),e.jsxs("div",{className:"tile",onClick:()=>Xr(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const i=(()=>{const v=N?.id;if(x?.conversationId||h||m||Y.activeConvId)return!0;if(v)try{for(const w of Object.values(gn||{}))if(w?.active&&Array.isArray(w.participants)&&w.participants.includes(v))return!0}catch{}return!1})()?"IN_CALL":Za??Vt.data?.status,c=Ja?"ONLINE":"OFFLINE",o=(i??c??"OFFLINE").toString().toUpperCase(),d=["ONLINE","AWAY","BACKGROUND","IN_CALL","OFFLINE"],f=o,u=c,p=d.includes(f)?f:u,j=Vt.data?.avatarUrl??N?.avatarUrl??void 0;return e.jsx(et,{name:N?.displayName??N?.username??"Me",id:N?.id??"me",presence:p,avatarUrl:j})})(),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:N?.displayName??N?.username??"Я"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Vt.data?.eblid??"— — — —"]})]})]})]})]})]})}function la(t){const n=t?"messages-pane slider-panel":"messages-pane",r=bi,i=fr;let c="";return k?.isSecret&&(r?c="Секретный чат станет доступен после подтверждения собеседника.":lo?c=ea?`Секретный чат подключён на устройстве «${ea}»`:"Секретный чат подключён на другом устройстве.":i||(c="Готовим защищённое подключение...")),e.jsxs("section",{className:n,children:[e.jsxs("header",{style:{...s?gn[s]?.active||m===s?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:R?"column":"row",justifyContent:R?"flex-start":"space-between",alignItems:R?"stretch":"center",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:R?"100%":"auto",padding:R?"0 8px":"0"},children:[t&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:co,children:e.jsx(cc,{size:18})}),k?(()=>{const o=k.participants.filter(v=>Tt?v.user.id!==Tt:!0).map(v=>v.user),d=o.map(v=>v.displayName??v.username).join(", ")||"Диалог",f=k.title??d,u=k.isGroup||k.participants.length>2;k.isSecret;const p=gn[k.id],j=p?.active;return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>ye(!0),style:{cursor:"pointer"},children:e.jsx(et,{name:f?.trim()?.charAt(0)||"Г",id:k.id,size:60,avatarUrl:k.avatarUrl&&k.avatarUrl.trim()?k.avatarUrl:void 0,presence:j?"IN_CALL":void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0,order:R?1:2},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),R&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:v=>{lt({open:!0,anchor:v.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(yr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:j?e.jsx(e.Fragment,{children:(()=>{const v=p.participants||[],w=k.participants||[],C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsxs(e.Fragment,{children:[p.active&&e.jsx("span",{children:cs(C)}),w.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[p.startedAt&&" • ",w.map((b,A)=>{const U=b.user,H=v.length>0&&v.includes(U.id);return e.jsxs("span",{style:{fontWeight:H?700:400,color:H?"var(--brand-600)":"var(--text-muted)"},children:[A>0&&", ",U.displayName??U.username,H&&" ✓"]},U.id)})]})]})})()}):p&&p.endedAt?(()=>{const v=p.endedAt,C=Date.now()-v,b=Math.floor(C/6e4);let A="";if(b<1)A="Завершен только что";else if(b<60)A=`Завершен ${b} мин назад`;else{const H=Math.floor(b/60);if(H<24)A=`Завершен ${H} ч назад`;else{const ce=new Date(v),de=ce.toLocaleDateString(),ue=ce.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});A=`Завершен ${de} в ${ue}`}}const U=k.participants||[];return e.jsxs(e.Fragment,{children:[e.jsx("span",{children:A}),U.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" • ",U.map((H,ce)=>{const de=H.user;return e.jsxs("span",{children:[ce>0&&", ",de.displayName??de.username]},de.id)})]})]})})():o.map(v=>v.displayName??v.username).join(", ")})]})]}):(()=>{const v=o[0];return e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(et,{name:v?.displayName??v?.username??"D",id:v?.id??k.id,avatarUrl:v?.avatarUrl&&v.avatarUrl.trim()?v.avatarUrl:void 0,presence:p?.active?"IN_CALL":Gn(v),size:60})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),R&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:w=>{lt({open:!0,anchor:w.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(yr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const w=m===s;if((p?.active||w)&&p){const C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsx("span",{children:cs(C)})}if(p&&p.endedAt&&!w){const C=p.endedAt,A=Date.now()-C,U=Math.floor(A/6e4);if(U<1)return e.jsx("span",{children:"Завершен только что"});if(U<60)return e.jsxs("span",{children:["Завершен ",U," мин назад"]});const H=Math.floor(U/60);if(H<24)return e.jsxs("span",{children:["Завершен ",H," ч назад"]});const ce=new Date(C),de=ce.toLocaleDateString(),ue=ce.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Завершен ",de," в ",ue]})}return v?os(v):""})()})]})]})})()})():e.jsx("div",{children:"Выберите чат"})]}),to&&k&&!!k.isSecret&&(k.participants?.length??0)<=2&&typeof document<"u"&&vr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:R?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Dr(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:R?16:20,borderRadius:R?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:R?"center":"left"},onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:R?"column":"row",gap:R?8:0},children:[e.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Завершить секретный чат?"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Dr(!1),style:{alignSelf:R?"flex-end":void 0},children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Сообщения этого секретного чата будут удалены у всех участников. Это действие необратимо."}),e.jsxs("div",{style:{display:"flex",justifyContent:R?"center":"flex-end",alignItems:"center",flexDirection:R?"column":"row",gap:R?12:8},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>Dr(!1),style:R?{width:"100%"}:void 0,children:"Отменить"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:R?"100%":void 0},onClick:async()=>{if(s)try{await ae.delete(`/conversations/${s}`),F.invalidateQueries({queryKey:["conversations"]}),F.removeQueries({queryKey:["messages",s]}),Dr(!1),l(null)}catch(o){console.error("Failed to end secret conversation:",o)}},children:"Завершить"})]})]})}),document.body),s&&(()=>{const o=gn[s],d=o?.active,f=k?.isGroup||(k?.participants.length??0)>2,u=m===s,p=h===s&&!u,j=N?.id,v=f&&d&&j&&o?.participants?.includes(j),w=!f&&(u||h===s||Y.activeConvId===s||d&&(Y.activeConvId===s||h===s)),C=v||w,b={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:R?"8px 12px":"12px 16px",flex:R?1:"auto",minWidth:R?0:"auto",fontSize:R?"14px":"15px",fontWeight:R?500:600,height:R?"42px":"46px",minHeight:R?"42px":"46px",boxSizing:"border-box"},A={display:"flex",alignItems:"center",gap:8,width:R?"100%":"auto",padding:R?"0 8px":"0",justifyContent:R?"center":"flex-end",marginLeft:R?0:"auto"},U={display:"inline-flex",alignItems:"center",justifyContent:"center",width:R?42:44,height:R?42:44,minWidth:R?42:44,padding:0,margin:0,borderRadius:999},H=async()=>{if(s&&await mi(!1))try{gi(s),wa(s,!1),Y.startOutgoing(s,!1),It(O=>{const ne=O[s],le=N?.id;return ne?.active?le&&ne.participants&&!ne.participants.includes(le)?{...O,[s]:{...ne,participants:[...ne.participants,le]}}:O:{...O,[s]:{startedAt:Date.now(),active:!0,participants:le?[le]:[]}}});const K=ie.data?.find(O=>O.conversation.id===s)?.conversation;if(K?.isGroup||(K?.participants?.length??0)>2)y(s),S(O=>O===s?null:O);else{const O=s;M({conversationId:O,startedAt:Date.now(),video:!1}),aa(),T.current&&window.clearTimeout(T.current),T.current=window.setTimeout(()=>{M(ne=>ne?.conversationId===O?(qn(),Si(),Wr(O),It(le=>{const Ue=le[O];if(Ue?.active)return{...le,[O]:{...Ue,active:!1,endedAt:Date.now()}};const{[O]:Ke,...He}=le;return He}),Y.endCall(),null):ne),T.current=null},3e4)}}catch(K){console.error("Error starting call:",K)}},ce=async()=>{if(s&&await mi(!0))try{gi(s),wa(s,!0),Y.startOutgoing(s,!0),It(O=>{const ne=O[s],le=N?.id;return ne?.active?le&&ne.participants&&!ne.participants.includes(le)?{...O,[s]:{...ne,participants:[...ne.participants,le]}}:O:{...O,[s]:{startedAt:Date.now(),active:!0,participants:le?[le]:[]}}});const K=ie.data?.find(O=>O.conversation.id===s)?.conversation;if(K?.isGroup||(K?.participants?.length??0)>2)y(s),S(O=>O===s?null:O);else{const O=s;M({conversationId:O,startedAt:Date.now(),video:!0}),aa(),T.current&&window.clearTimeout(T.current),T.current=window.setTimeout(()=>{M(ne=>ne?.conversationId===O?(qn(),Si(),Wr(O),It(le=>{const Ue=le[O];if(Ue?.active)return{...le,[O]:{...Ue,active:!1,endedAt:Date.now()}};const{[O]:Ke,...He}=le;return He}),Y.endCall(),null):ne),T.current=null},3e4)}}catch(K){console.error("Error starting call:",K)}},de=()=>{s&&(y(s),S(null))},ue=()=>d||u?C?e.jsxs(e.Fragment,{children:[!p&&e.jsxs("button",{className:"btn btn-secondary",onClick:de,style:b,children:[e.jsx(ka,{size:R?16:18}),R?"Развернуть":" Развернуть"]}),e.jsxs("button",{className:"btn",onClick:()=>{const K=k?.participants?.length??0,se=K<=2,O=k?.isGroup||K>2;if(se&&h)Wr(h),It(ne=>{const le=ne[h];return le?.active?{...ne,[h]:{...le,active:!1,endedAt:Date.now()}}:ne});else if(O&&h){try{Ko(h)}catch{}It(ne=>{const le=ne[h];if(!le||!le.participants)return ne;const Ue=N?.id;return!Ue||!le.participants.includes(Ue)?ne:{...ne,[h]:{...le,participants:le.participants.filter(Ke=>Ke!==Ue)}}})}y(null),S(null),Y.endCall(),_t()},style:{...b,background:"#ef4444",color:"#fff"},children:[e.jsx(fs,{size:R?16:18}),R?"Сбросить":" Сбросить"]}),!R&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{lt({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(yr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(k?.isGroup||(k?.participants?.length??0)>2){y(s),S(se=>se===s?null:se),Y.startOutgoing(s,!1);try{ba(s,!1)}catch{}}else y(s),S(se=>se===s?null:se),Y.startOutgoing(s,!1)},style:b,children:[e.jsx(ps,{size:R?16:18}),R?"Подключиться":" Подключиться"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(k?.isGroup||(k?.participants?.length??0)>2){y(s),S(se=>se===s?null:se),Y.startOutgoing(s,!0);try{ba(s,!0)}catch{}}else y(s),S(se=>se===s?null:se),Y.startOutgoing(s,!0)},style:b,children:[e.jsx(gs,{size:R?16:18}),R?"Подключиться с видео":" Подключиться с видео"]}),!R&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{lt({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(yr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{H()},style:b,children:[e.jsx(ps,{size:R?16:18}),R?" Начать звонок":" Звонок"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{ce()},style:b,children:[e.jsx(gs,{size:R?16:18}),R?" Начать с видео":" Видео"]}),!R&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{lt({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(yr,{size:22})})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:A,children:ue()}),sr&&e.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:R?"100%":420,width:R?"100%":"auto"},children:[e.jsx("span",{style:{flex:1},children:sr}),e.jsx("button",{type:"button",onClick:()=>kr(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:e.jsx(Lt,{size:14})})]})]})})()]}),!k?.isSecret&&pr&&e.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:R?"column":"row",gap:12,alignItems:R?"stretch":"center"},children:pr.isInitiator?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1},children:"Ждём подтверждения собеседника, чтобы начать секретный чат."}),e.jsx("div",{style:{display:"flex",gap:8},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Js(pr.conversationId),disabled:Zi,style:{color:"#f87171"},children:"Отменить"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[pr.initiatorName," предлагает начать секретный чат на этом устройстве."]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>io(pr.conversationId),disabled:Zi,children:"Принять"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>Js(pr.conversationId),disabled:Zi,style:{color:"#bae6fd"},children:"Отказаться"})]})]})}),e.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),e.jsx("div",{ref:pe,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:s?k?.isSecret&&(!i||r)?e.jsx("div",{className:"messages-empty",children:c}):(()=>{const o=($t?[...$t]:[]).filter(u=>!u.deletedAt).sort((u,p)=>new Date(u.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),d=hi,f=[...o||[],...d];return f?f.map((u,p)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const j=f[p-1],v=f[p+1],w=!v||v.senderId!==u.senderId,C=!!j&&j.senderId===u.senderId,b=u.senderId===N?.id,H=`${tt?"msg left":b?"msg me":"msg them"} ${C?"compact":"gap"}`,ce=tt?"msg-bubble left":b?"msg-bubble me":"msg-bubble them",de=w?`${ce} ${b&&!tt?"tail-right":"tail-left"}`:ce,ue=ra[u.senderId],K=ue?.displayName??ue?.username??(b?N?.displayName??N?.username??"Me":"User"),se=ue?.id??(b?N?.id??"me":"user"),O=b?"#303845":uo(u.senderId),ne="#f1f3f6",le=tt&&w,Ue=tt,Ke=u.createdAt?new Date(u.createdAt):null,He=Ke?Ke.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",mt=(k?.participants||[]).map($=>$.user.id).filter($=>Tt?$!==Tt:!0),mn=u.receipts||[],Pr=b&&mt.some($=>mn.some(me=>me.userId===$&&(me.status==="READ"||me.status==="SEEN"))),yn=b&&Pr?"✓":"",Ii=($,me)=>{Z({open:!0,x:$,y:me,messageId:u.id})},So=$=>{$.preventDefault(),Ii($.clientX,$.clientY)},ko=()=>{const $=u.replyTo?.id;if(!$)return;const me=St.current.get($);me&&me.scrollIntoView({behavior:"smooth",block:"center"})},ua=(u.attachments||[]).filter($=>$?.type==="IMAGE").map($=>wi($)).filter($=>!!$),ha=$=>{const me=ua.findIndex(it=>it===$);Gi({open:!0,index:me>=0?me:0,items:ua})},Io=R?{}:{onContextMenu:So,...{onPointerDown:$=>{const me=window.setTimeout(()=>Ii($.clientX,$.clientY),450),it=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",it),window.removeEventListener("pointermove",Rn)},Rn=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",it),window.removeEventListener("pointermove",Rn)};window.addEventListener("pointerup",it,{passive:!0}),window.addEventListener("pointermove",Rn,{passive:!0})}}};return e.jsxs("div",{className:H,...Io,children:[Ue&&(le?e.jsx(et,{name:K,id:se,avatarUrl:(()=>{const $=ra[u.senderId]?.avatarUrl;return $&&$.trim()?$:void 0})()}):e.jsx("div",{className:"avatar-spacer"})),e.jsxs("div",{className:de,"data-mid":u.id,ref:$=>{if(!$){St.current.delete(u.id);return}St.current.set(u.id,$),Ut.current?.observe($)},style:{"--bubble-bg":O,"--bubble-fg":ne},onClick:$=>{if(!R||$.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const it=typeof window.getSelection=="function"?window.getSelection():null;it&&it.toString()||Ii($.clientX,$.clientY)},onContextMenu:$=>{if($.target.closest(".reaction-emoji")){$.preventDefault(),$.stopPropagation();return}Ii($.clientX,$.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const $={};for(const me of u.reactions)$[me.emoji]||($[me.emoji]={count:0,hasMine:!1}),$[me.emoji].count++,me.userId===N?.id&&($[me.emoji].hasMine=!0);return e.jsx("div",{style:{position:"absolute",bottom:-18,right:b?8:void 0,left:b?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries($).map(([me,it],Rn)=>{const rn=me==="❤️"?"#ef4444":"#ffc46b";return e.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async Vn=>{Vn.preventDefault(),Vn.stopPropagation();try{it.hasMine?await ae.post("/messages/unreact",{messageId:u.id,emoji:me}):await ae.post("/messages/react",{messageId:u.id,emoji:me}),s&&F.invalidateQueries({queryKey:["messages",s]})}catch(ls){console.error("Error toggling reaction:",ls)}},onMouseDown:Vn=>{Vn.stopPropagation()},style:{fontSize:12,color:rn,display:"inline-block",animation:`reactionBounce 0.6s ease ${Rn*.1}s`,cursor:"pointer",opacity:it.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[me,it.count>1?` ${it.count}`:""]},me)})})})(),u.replyTo&&e.jsxs("div",{onClick:ko,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:b?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["Ответ на: ",u.replyTo.content??"сообщение"]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(()=>{const $=u.attachments||[],me=$.filter(Qe=>Qe?.type==="IMAGE"),it=typeof u.content=="string"?u.content.trim().length>0:!!u.content,Rn=$.some(Qe=>Qe?.type&&Qe.type!=="IMAGE"),Mi=me.length>0&&!it&&!Rn,rn=[];let Vn=!1;$.forEach((Qe,be)=>{if(Qe?.type==="IMAGE"){Vn||(rn.push({kind:"imageGroup",atts:me}),Vn=!0);return}rn.push({kind:"single",att:Qe,idx:be})});const ls=Qe=>{if(!Qe.length)return null;if(Qe.length===1){const ee=Qe[0],Ze=0,st=ee.metadata??{},Oe=wi(ee),Fe=!!(k?.isSecret&&st?.e2ee?.kind==="ciphertext"),at=Fe?Fn[ee.url]:void 0,Mt=Fe&&!Oe&&(!at||at.status==="pending"),Nt=Fe&&at?.status==="error",Kn=typeof window<"u"?window.innerWidth:1280,An=Kn<=768?Math.max(320,Math.floor(Kn/2)):Math.min(600,Math.max(320,Math.floor(Kn/3))),Ri=`${ee.url||Ze}`,Ur=Fs[Ri],Tn=Ur?.width||ee.width||ee.metadata?.width||An,gr=Ur?.height||ee.height||ee.metadata?.height||Math.round(Tn*.75),sn=gr/Tn||.75,xn=An;let Ft=An;sn<.5?Ft=Math.max(Math.round(An*.6),200):sn<.7&&(Ft=Math.max(Math.round(An*.75),200));const Mo=Tn>xn?xn/Tn:1,Ro=gr>Ft?Ft/gr:1,fa=Math.min(Mo,Ro,1);let Dn=Tn*fa,an=gr*fa;Dn>xn&&(Dn=xn,an=Dn*sn),an>Ft&&(an=Ft,Dn=an/sn),Dn=Math.round(Dn),an=Math.round(an);const Qn=`${ee.url||Ze}`,ds=!!_s[Qn],pa=!!Os[Qn],Ei=ee.__pending||Mt||!ds&&!pa;return e.jsxs("div",{style:{maxWidth:"100%",maxHeight:an,width:Ei?Math.min(Dn,typeof window<"u"?window.innerWidth-100:Dn):"fit-content",height:Ei?an:"auto",minWidth:0,minHeight:Ei?an:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Mi&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:He}),!!yn&&e.jsx("span",{children:yn})]}),Ei&&e.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),Mt?e.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Расшифровка изображения..."}):typeof ee.progress=="number"&&ee.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ee.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Nt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось расшифровать изображение"}),pa&&!Nt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось загрузить изображение"}),Oe&&!Nt&&e.jsx("img",{src:Oe,alt:"img",style:{maxWidth:"100%",maxHeight:an,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:ee.__pending?.85:1,display:ds?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:Hr=>{const Ai=Hr.target;if(!ee.width&&!st?.width&&Ai.naturalWidth&&Ai.naturalHeight&&Xs(Nn=>({...Nn,[Qn]:{width:Ai.naturalWidth,height:Ai.naturalHeight}})),di(Nn=>({...Nn,[Qn]:!1})),li(Nn=>({...Nn,[Qn]:!0})),pe.current&&ve.current){const Nn=pe.current;Nn.scrollTop=Nn.scrollHeight}},onError:()=>{di(Hr=>({...Hr,[Qn]:!0})),li(Hr=>({...Hr,[Qn]:!0}))},onClick:()=>{!ee.__pending&&!Mt&&Oe&&ha(Oe)}}),ds&&!Mt&&typeof ee.progress=="number"&&ee.progress<100&&e.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:e.jsx("div",{style:{width:`${ee.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`images-single-${ee.url||Ze}`)}const be=Qe.slice(0,4),Je=Qe.length-be.length,Dt=(ee,Ze)=>{const st=ee?.metadata??{},Oe=`${ee?.url||Ze}`,Fe=Fs[Oe],at=Fe?.width||ee?.width||st?.width,Mt=Fe?.height||ee?.height||st?.height,Nt=typeof at=="number"&&typeof Mt=="number"&&at>0&&Mt>0?Mt/at:1;return Math.max(.2,Math.min(5,Number.isFinite(Nt)?Nt:1))},Ot=(ee,Ze,st)=>{const Oe=ee.metadata??{},Fe=wi(ee),at=!!(k?.isSecret&&Oe?.e2ee?.kind==="ciphertext"),Mt=at?Fn[ee.url]:void 0,Nt=at&&!Fe&&(!Mt||Mt.status==="pending"),Kn=at&&Mt?.status==="error",En=`${ee.url||Ze}`,An=!!_s[En],Ri=!!Os[En],Ur=ee.__pending||Nt||!An&&!Ri,Tn=ee.__pending||Nt||Kn||!Fe,gr=Dt(ee,Ze);return e.jsxs("button",{type:"button",className:"msg-media-tile",style:{aspectRatio:1/gr},disabled:Tn,onClick:()=>{!Tn&&Fe&&ha(Fe)},children:[Fe&&e.jsx("img",{src:Fe,alt:"img",style:{opacity:An&&!Ur?1:.001},onLoad:sn=>{const xn=sn.target;!ee.width&&!Oe?.width&&xn.naturalWidth&&xn.naturalHeight&&Xs(Ft=>({...Ft,[En]:{width:xn.naturalWidth,height:xn.naturalHeight}})),di(Ft=>({...Ft,[En]:!1})),li(Ft=>({...Ft,[En]:!0}))},onError:()=>{di(sn=>({...sn,[En]:!0})),li(sn=>({...sn,[En]:!0}))}}),Ur&&e.jsxs("div",{className:"msg-media-overlay",children:[e.jsx("div",{className:"msg-media-overlay-shimmer"}),Nt?e.jsx("div",{style:{position:"relative",zIndex:2,color:"var(--text-muted)",fontSize:12},children:"Расшифровка..."}):typeof ee.progress=="number"&&ee.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ee.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),(Kn||Ri)&&e.jsx("div",{className:"msg-media-overlay",style:{background:"rgba(15, 23, 42, 0.55)"},children:e.jsx("div",{style:{position:"relative",zIndex:2,color:"#f87171",fontSize:12,padding:10,textAlign:"center"},children:Kn?"Ошибка расшифровки":"Ошибка загрузки"})}),st&&e.jsxs("div",{className:"msg-media-more",children:["+",Je]})]},`${ee.url||Ze}`)};return e.jsxs("div",{className:"msg-media-grid",children:[Mi&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:He}),!!yn&&e.jsx("span",{children:yn})]}),be.length===2&&(()=>{const ee=Dt(be[0],0),st=Dt(be[1],1),Oe=ee;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${st} 1 0`,minWidth:0},children:Ot(be[0],0,!1)}),e.jsx("div",{style:{flex:`${Oe} 1 0`,minWidth:0},children:Ot(be[1],1,Je>0&&be.length-1===1)})]})})(),be.length===3&&(()=>{const ee=Dt(be[0],0),Ze=Dt(be[1],1),st=Dt(be[2],2),Oe=Ze+st,Fe=ee;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${Oe} 1 0`,minWidth:0},children:Ot(be[0],0,!1)}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${Fe} 1 0`},children:[Ot(be[1],1,!1),Ot(be[2],2,Je>0&&be.length-1===2)]})]})})(),be.length>=4&&(()=>{const ee=Dt(be[0],0),Ze=Dt(be[1],1),st=Dt(be[2],2),Oe=Dt(be[3],3),Fe=Ze+Oe,at=ee+st;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"msg-media-col",style:{flex:`${Fe} 1 0`},children:[Ot(be[0],0,!1),Ot(be[2],2,!1)]}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${at} 1 0`},children:[Ot(be[1],1,!1),Ot(be[3],3,Je>0)]})]})})()]},"images-mosaic")};return e.jsx(e.Fragment,{children:rn.map((Qe,be)=>{if(Qe.kind==="imageGroup")return e.jsx(a.Fragment,{children:ls(Qe.atts)},"images-group");const Je=Qe.att,Dt=Qe.idx,Ot=Je.metadata??{},ee=wi(Je),Ze=!!(k?.isSecret&&Ot?.e2ee?.kind==="ciphertext"),st=Ze?Fn[Je.url]:void 0,Oe=Ze&&!ee&&(!st||st.status==="pending"),Fe=Ze&&st?.status==="error",at=Ot?.e2ee?.originalName||Je.url?.split("/").pop()||"вложение";if(Je.type==="AUDIO"){const Mt=u.metadata?.duration||0,Nt=ee||Je.url;return e.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:Oe?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[e.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{style:{fontSize:13},children:"Расшифровка аудио..."})]}):Fe?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать аудио"}):Nt?e.jsx(Ml,{url:Nt,duration:Mt}):e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Голосовое сообщение"})},`${Je.url}-${Dt}-${be}`)}return e.jsxs("div",{style:{marginTop:8},children:[Je.__pending||Oe?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Файл: ",at,Oe&&" (расшифровка...)"]}):Fe?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать файл"}):e.jsxs("a",{href:ee||Je.url,target:"_blank",rel:"noreferrer",download:at,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Файл: ",at]}),typeof Je.progress=="number"&&Je.progress<100&&e.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:e.jsx("div",{style:{width:`${Je.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${Je.url}-${Dt}-${be}`)})})})()]}),(()=>{const $=u.attachments||[],me=typeof u.content=="string"?u.content.trim().length>0:!!u.content,it=$.some(rn=>rn?.type&&rn.type!=="IMAGE");return $.some(rn=>rn?.type==="IMAGE")&&!me&&!it?null:e.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[He," ",yn]})})()]})]},u.id)}):null})():e.jsx("div",{className:"messages-empty",children:"Сообщения появятся здесь"})}),s&&e.jsx("button",{className:Un?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{pe.current&&pe.current.scrollTo({top:pe.current.scrollHeight,behavior:"smooth"}),ve.current=!0,ut.current=!1,Rt(!1)},children:"↓"}),e.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:o=>{o.preventDefault(),qi(!0)},onDragLeave:()=>qi(!1),onDrop:async o=>{o.preventDefault(),qi(!1);const d=Array.from(o.dataTransfer.files||[]);if(!d.length||!s)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>Tr(p,"upload")),u.length&&await as(u)},children:k?.isSecret&&(!i||r)?e.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:c}):e.jsxs(e.Fragment,{children:[J&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsx(Hc,{size:16,color:"var(--text-muted)"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ответ на:"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:J.preview}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>he(null),style:{marginLeft:"auto",flexShrink:0},children:e.jsx(Lt,{size:16})})]}),fn.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Изображения перед отправкой"}),e.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:fn.map(o=>e.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[e.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{si===o.id&&nn(null),Ka(o.id)},"aria-label":"Удалить изображение",children:e.jsx(Lt,{size:14})}),e.jsx("button",{type:"button",onClick:()=>nn(o.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Редактировать изображение",children:e.jsx("img",{src:o.previewUrl,alt:o.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:o.fileName}),e.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>nn(o.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Редактировать"}),o.edited&&e.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"Отредактировано"})]})]},o.id))})]}),e.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:G,onChange:async o=>{const d=Array.from(o.target.files||[]);if(!s||d.length===0)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>Tr(p,"upload")),u.length&&await as(u),o.target.value=""}}),Ns?e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),e.jsx("div",{ref:Ar,style:{width:"100%",...R?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const u=R?60:zs;return Er.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(u).fill(0).map((p,j)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${j*.1}s`,flexShrink:0}},j))}):e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:Er.length>u?`translateX(-${(Er.length-u)*4}px)`:"translateX(0)",transition:"none"},children:Er.slice(-u).map((p,j)=>{const v=Math.max(4,p/100*20);return e.jsx("div",{style:{width:2,height:`${v}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${Er.length-u+j}-${j}`)})})})()}),e.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor(Ls/60),":",(Ls%60).toString().padStart(2,"0")]})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:bo,style:{flexShrink:0},"aria-label":"Отменить запись",children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:oa,style:{flexShrink:0},"aria-label":"Отправить голосовое сообщение",children:e.jsx(Ma,{size:16})})]}):e.jsxs("form",{autoComplete:"off",onSubmit:async o=>{if(o.preventDefault(),!s)return;const d=_.trim();if(fn.length>0){const f=fn.map(u=>({file:u.file,previewUrl:u.previewUrl}));Rr([]),nn(null),f.forEach(u=>Xn(u.previewUrl)),await as(f.map(u=>u.file),d||"",J?.id),W(""),he(null)}else d&&(await Zs(k,{type:"TEXT",content:d,replyToId:J?.id}),W(""),he(null));F.invalidateQueries({queryKey:["messages",s]}),setTimeout(()=>{pe.current&&(pe.current.scrollTop=pe.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>G.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:R?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Прикрепить файлы",children:[e.jsx(Lc,{size:16}),!R&&e.jsx("span",{children:"Загрузить"})]}),e.jsx("input",{type:"text",placeholder:fn.length>0?"Добавьте подпись к изображениям...":"Напишите сообщение...",value:_,onChange:o=>W(o.target.value),onPaste:o=>{if(!s)return;const d=o.clipboardData?.items;if(d)for(let f=0;f<d.length;f++){const u=d[f];if(u.type.indexOf("image")!==-1){o.preventDefault();const p=u.getAsFile();p&&Tr(p,"paste");break}}},ref:D,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:vo,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:R?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Записать голосовое сообщение",children:[e.jsx(Ac,{size:16}),!R&&e.jsx("span",{children:"Голос"})]}),e.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:R?0:6,height:46,minHeight:46,padding:"0 12px"},children:[e.jsx(Ma,{size:16}),!R&&e.jsx("span",{children:"Отправить"})]})]}),qa&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:e.jsx("div",{style:{width:`${Va}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),e.jsx(a.Suspense,{fallback:null,children:h&&e.jsx(Cl,{open:!!h,conversationId:h,minimized:m===h,peerAvatarUrl:(()=>{const d=(h?ie.data?.find(f=>f.conversation.id===h)?.conversation:k)?.participants||[];return d.length===2?d.find(u=>Tt?u.user.id!==Tt:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const d=(h?ie.data?.find(u=>u.conversation.id===h)?.conversation:k)?.participants||[],f={};for(const u of d){const p=u.user,j=p.displayName??p.username??p.id;f[j]=p.avatarUrl??null}return N&&(f[N.displayName??N.username??N.id]=Vt.data?.avatarUrl??N.avatarUrl??null),f})(),avatarsById:(()=>{const d=(h?ie.data?.find(u=>u.conversation.id===h)?.conversation:k)?.participants||[],f={};for(const u of d){const p=u.user;f[p.id]=p.avatarUrl??null}return N&&(f[N.id]=Vt.data?.avatarUrl??N.avatarUrl??null),f})(),localUserId:N?.id??null,isGroup:!!(h?ie.data?.find(d=>d.conversation.id===h)?.conversation:k)?.isGroup,onMinimize:()=>{if(h){const o=h;S(o);const d=pi(o);!!!(d?.isGroup||(d?.participants?.length??0)>2)&&Y.activeConvId!==o&&Y.startOutgoing(o,Y.initialVideo),h!==o&&y(o)}},onClose:o=>{const d=h??Yn.current;if(!d||m===d)return;const f=()=>{const u=pi(d),p=u?.participants?.length??0,j=!!(u?.isGroup||p>2);!j&&Wr(d),It(w=>{const C=w[d];if(!C)return w;if(j){const b=(C.participants||[]).filter(A=>Tt?A!==Tt:!0);return{...w,[d]:{...C,participants:b}}}return C.active?{...w,[d]:{...C,active:!1,endedAt:Date.now()}}:w}),y(w=>w===d?null:w),S(w=>w===d?null:w),Y.endCall(),_t()};!o?.manual&&lr(d)?ts(d,f):(Mn(d),f())},initialVideo:Y.initialVideo,initialAudio:Y.initialAudio})}),e.jsx(Zc,{open:!!fi,image:fi,onClose:()=>nn(null),onApply:({file:o,previewUrl:d})=>{fi&&(Qa(fi.id,o,d),nn(null))}}),x&&(()=>{const o=ie.data?.find(b=>b.conversation.id===x.conversationId)?.conversation,d=o?.isGroup||(o?.participants?.length??0)>2;if(d)return null;let f="Неизвестный",u,p=x.conversationId;if(d)f=o?.title??"Группа",u=o?.avatarUrl,p=x.conversationId;else{const b=o?.participants?.find(A=>A.user.id!==N?.id)?.user;if(b)f=b.displayName??b.username??b.id??"Неизвестный",u=b.avatarUrl,p=b.id;else{const A=bt.data?.find(U=>(U.conversationIds||[]).includes(x.conversationId));A?.friend&&(f=A.friend.displayName??A.friend.username??A.friend.id??"Неизвестный",u=A.friend.avatarUrl,p=A.friend.id)}}const j=Math.floor((Date.now()-x.startedAt)/1e3),v=Math.floor(j/60),w=j%60,C=`${v}:${w.toString().padStart(2,"0")}`;return vr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700},children:x.video?"Видеозвонок":"Звонок"}),!x.minimized&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{M(b=>b?{...b,minimized:!0}:null)},style:{padding:8},children:e.jsx(Dc,{size:18})})]}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[e.jsx(et,{name:f,id:p,size:64,avatarUrl:u}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:f}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"дозвон…"})]}),e.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:C})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{T.current&&(window.clearTimeout(T.current),T.current=null),qn(),Si(),Wr(x.conversationId),M(null),It(b=>{const A=b[x.conversationId];if(A?.active)return{...b,[x.conversationId]:{...A,active:!1,endedAt:Date.now()}};const{[x.conversationId]:U,...H}=b;return H}),Y.endCall()},children:[e.jsx(fs,{size:18}),e.jsx("span",{children:"Сбросить"})]}),x.minimized&&e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{M(b=>b?{...b,minimized:!1}:null)},children:[e.jsx(ka,{size:18}),e.jsx("span",{children:"Развернуть"})]})]})]})}),document.body)})(),Y.incoming&&vr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:12},children:Y.incoming.video?"Входящий видеозвонок":"Входящий аудиозвонок"}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[e.jsx(et,{name:Y.incoming.from.name??Y.incoming.from.id,id:Y.incoming.from.id,size:64,avatarUrl:Y.incoming.from.avatarUrl??ie.data?.find(o=>o.conversation.id===Y.incoming.conversationId)?.conversation?.participants?.find(o=>o.user.id===Y.incoming.from.id)?.user?.avatarUrl??bt.data?.find(o=>o.friend?.id===Y.incoming.from.id)?.friend?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:Y.incoming.from.name??Y.incoming.from.id}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"звонит…"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{yi(!1)},children:[e.jsx(ps,{size:18}),e.jsx("span",{children:"Ответить"})]}),e.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{yi(!0)},children:[e.jsx(gs,{size:18}),e.jsx("span",{children:"Ответить с видео"})]})]}),e.jsx("div",{style:{display:"flex"},children:e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{rs()},children:[e.jsx(fs,{size:18}),e.jsx("span",{children:"Отмена"})]})}),sr&&e.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:sr})]})]})}),document.body)]})}function da(t,n){n&&F.setQueryData(["messages",t],r=>{const i=Array.isArray(r)?[...r]:[];return i.some(c=>c.id===n.id)||(i.push(n),i.sort((c,o)=>new Date(c.createdAt||0).getTime()-new Date(o.createdAt||0).getTime())),i})}function Co(t,n){n&&F.setQueryData(["messages",t],r=>{if(!Array.isArray(r))return r;const i=r.findIndex(o=>o.id===n.id);if(i===-1)return r;const c=[...r];return c[i]={...c[i],...n},c})}return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:R?"chats-page mobile-slider":"chats-page",children:R?e.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${Xe==="conversation"?"-100vw":"0"})`},onTouchStart:t=>{const n=t.touches[0];ft.current={x:n.clientX,y:n.clientY},Ye.current=0},onTouchMove:t=>{if(!ft.current)return;const n=t.touches[0];Ye.current=n.clientX-ft.current.x},onTouchEnd:()=>{const t=Ye.current;ft.current=null,!(Math.abs(t)<50)&&(t<0&&s&&we("conversation"),t>0&&we("list"))},children:[ca(!0),la(!0)]}):e.jsxs(e.Fragment,{children:[ca(!1),la(!1)]})}),Ga&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Профиль"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Xr(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(et,{name:N?.displayName??N?.username??"Me",id:N?.id??"me",avatarUrl:Ht??Vt.data?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:N?.displayName??N?.username}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Vt.data?.eblid??"— — — —"]})]})]}),e.jsx("input",{ref:Ms,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){Gr(n);try{qr(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Ht&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),e.jsxs("div",{onClick:()=>Ms.current?.click(),onDragOver:t=>{t.preventDefault(),Xi(!0)},onDragLeave:()=>Xi(!1),onDrop:t=>{t.preventDefault(),Xi(!1);const n=t.dataTransfer.files?.[0];if(n){Gr(n);try{qr(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(As?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:As?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),Ht&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:$n,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ie.scale*(1+n))),i=$n.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Ie.scale,f=c-(c-Ie.x)*d,u=o-(o-Ie.y)*d;kn({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=$n.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,v=p-o;if(j*j+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,b={...Ie},A=H=>{H.preventDefault();const ce=H.clientX-w,de=H.clientY-C;kn({...b,x:b.x+ce,y:b.y+de})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Oi,src:Ht,alt:"preview",style:{position:"absolute",left:Ie.x,top:Ie.y,transform:`scale(${Ie.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=$n.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,v=o/f,w=Math.max(j,v)*1.2,C=u-d*w/2,b=p-f*w/2;kn({x:C,y:b,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Ie.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>kn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:10,step:.05,value:Ie.scale,onChange:t=>kn(n=>({...n,scale:parseFloat(t.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>kn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:e.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:R?"Два пальца для масштаба, один для перемещения":"Перетащите для перемещения, колесико мыши для масштаба"})})]}),e.jsx("canvas",{ref:Vr,width:240,height:240,style:{display:"none"}})]}),_i&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{Gr(null),Ht&&URL.revokeObjectURL(Ht),qr(null)},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:nr,onClick:async()=>{if(_i){Yr(!0),Kr(0);try{let t=null;if(Vr.current&&Ht){const i=await new Promise(b=>{const A=new Image;A.onload=()=>b(A),A.src=Ht}),c=Vr.current.getContext("2d"),o=240;c.clearRect(0,0,o,o),c.save(),c.beginPath(),c.arc(o/2,o/2,o/2,0,Math.PI*2),c.closePath(),c.clip();const d=$n.current?.clientWidth??320,f=$n.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-o/2,y:u.y-o/2,w:o,h:o},j=(p.x-Ie.x)/Ie.scale,v=(p.y-Ie.y)/Ie.scale,w=p.w/Ie.scale,C=p.h/Ie.scale;c.drawImage(i,j,v,w,C,0,0,o,o),c.restore(),t=await new Promise(b=>Vr.current.toBlob(A=>b(A),"image/png"))}const n=new FormData;n.append("file",t??_i);const r=await new Promise((i,c)=>{const o=new XMLHttpRequest;o.open("POST","/api/upload");try{const d=Jn.getState().session?.accessToken;d&&o.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}o.upload.onprogress=d=>{d.lengthComputable&&Kr(Math.round(100*d.loaded/d.total))},o.onreadystatechange=()=>{if(o.readyState===4)if(o.status>=200&&o.status<300)try{const d=JSON.parse(o.responseText);i(d.url)}catch(d){c(d)}else c(new Error("upload failed"))},o.send(n)});await ae.patch("/status/me",{avatarUrl:r}),Gr(null),Ht&&URL.revokeObjectURL(Ht),qr(null),Vt.refetch()}catch{}Yr(!1),rr("Готово"),setTimeout(()=>rr(null),2200)}},children:nr?"Загрузка...":"Загрузить"})]}),nr&&e.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Is}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ni&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[e.jsx(Ca,{size:16}),e.jsx("span",{children:ni})]}),e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:e.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await ae.post("/auth/logout")}catch{}Jn.getState().setSession(null),Xr(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[e.jsx(hs,{size:18}),e.jsx("span",{children:"Выйти из Еблуши"})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Xr(!1),children:"Закрыть"})})]})}),Wn&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>Cn(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Аватар группы"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Cn(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(et,{name:vt.trim()||"?",id:"new-group-avatar-preview",avatarUrl:hn??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:vt||"Новая группа"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),e.jsx("input",{ref:Li,type:"file",accept:"image/*",style:{display:"none"},onChange:t=>{const n=t.target.files?.[0];if(n){if(tr(n),je)try{URL.revokeObjectURL(je)}catch{}try{const r=URL.createObjectURL(n);qt(r)}catch{qt(null)}en({x:0,y:0,scale:1})}}}),!je&&e.jsx(e.Fragment,{children:e.jsxs("div",{onClick:()=>Li.current?.click(),onDragOver:t=>{t.preventDefault(),Pi(!0)},onDragLeave:()=>Pi(!1),onDrop:t=>{t.preventDefault(),Pi(!1);const n=t.dataTransfer.files?.[0];if(n){if(tr(n),je)try{URL.revokeObjectURL(je)}catch{}try{const r=URL.createObjectURL(n);qt(r)}catch{qt(null)}en({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(ks?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:ks?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})}),je&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:Bn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ve.scale*(1+n))),i=Bn.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Ve.scale,f=c-(c-Ve.x)*d,u=o-(o-Ve.y)*d;en({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=Bn.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,v=p-o;if(j*j+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,b={...Ve},A=H=>{H.preventDefault();const ce=H.clientX-w,de=H.clientY-C;en({...b,x:b.x+ce,y:b.y+de})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:_a,src:je,alt:"preview",style:{position:"absolute",left:Ve.x,top:Ve.y,transform:`scale(${Ve.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=Bn.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,v=o/f,w=Math.max(j,v)*1.2,C=u-d*w/2,b=p-f*w/2;en({x:C,y:b,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Масштаб"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>en(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Ve.scale,onChange:t=>{const n=parseFloat(t.target.value),r=Bn.current?.getBoundingClientRect();if(!r){en(u=>({...u,scale:n}));return}const i=r.width/2,c=r.height/2,o=n/Ve.scale,d=i-(i-Ve.x)*o,f=c-(c-Ve.y)*o;en({x:d,y:f,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>en(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:zi,width:240,height:240,style:{display:"none"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>{Cn(!1)},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:!je,onClick:async()=>{if(!je||!zi.current){Cn(!1);return}try{const t=await new Promise(C=>{const b=new Image;b.onload=()=>C(b),b.src=je}),n=zi.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const i=240;r.clearRect(0,0,i,i),r.save(),r.beginPath(),r.arc(i/2,i/2,i/2,0,Math.PI*2),r.closePath(),r.clip();const c=Bn.current?.clientWidth??320,o=Bn.current?.clientHeight??320,d={x:c/2,y:o/2},f={x:d.x-i/2,y:d.y-i/2,w:i,h:i},u=(f.x-Ve.x)/Ve.scale,p=(f.y-Ve.y)/Ve.scale,j=f.w/Ve.scale,v=f.h/Ve.scale;r.drawImage(t,u,p,j,v,0,0,i,i),r.restore();const w=await new Promise(C=>n.toBlob(b=>C(b),"image/png"));if(w){if(hn)try{URL.revokeObjectURL(hn)}catch{}const C=URL.createObjectURL(w);jn(w),kt(C)}}catch{}finally{Cn(!1)}},children:"Сохранить"})]})]})}),Pe&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:is,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700},children:"Создать групповой чат"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:is,children:e.jsx(Lt,{size:16})})]}),(()=>{const t=vt.trim(),n=t||"?";return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[e.jsx("input",{placeholder:"Название",value:vt,onChange:r=>er(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),e.jsx("input",{ref:Li,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const i=r.target.files?.[0];if(i){if(tr(i),je)try{URL.revokeObjectURL(je)}catch{}try{const c=URL.createObjectURL(i);qt(c)}catch{qt(null)}Cn(!0)}}}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>Cn(!0),title:"Выбрать аватар группы",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:e.jsx(et,{name:n,id:"new-group-avatar",avatarUrl:hn??void 0,size:40})})]})})(),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Выберите участников"}),e.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:bt.data?.map(t=>{const n=t.friend,r=Zt.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Hn(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[e.jsx(et,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Выбрано":"Нажмите, чтобы выбрать"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},t.id)})}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:e.jsx("button",{className:"btn btn-primary",disabled:Zt.length===0||jr,onClick:async()=>{if(!(Zt.length===0||jr)){Cr(!0);try{const t=await ae.post("/conversations",{participantIds:Zt,title:vt||void 0,isGroup:!0}),n=t.data?.conversation?.id;if(n&&(Sr||Or))try{const r=new FormData;r.append("file",Sr??Or);const i=await new Promise((c,o)=>{const d=new XMLHttpRequest;d.open("POST","/api/upload");try{const f=Jn.getState().session?.accessToken;f&&d.setRequestHeader("Authorization",`Bearer ${f}`)}catch{}d.onreadystatechange=()=>{if(d.readyState===4)if(d.status>=200&&d.status<300)try{const f=JSON.parse(d.responseText);c(f.url)}catch(f){o(f)}else o(new Error(`upload failed: ${d.status} ${d.statusText}`))},d.onerror=()=>o(new Error("Network error during upload")),d.send(r)});await ae.patch(`/conversations/${n}`,{avatarUrl:i})}catch(r){console.error("Error setting group avatar:",r)}F.invalidateQueries({queryKey:["conversations"]}),t.data?.conversation?.id&&dr(t.data.conversation.id),is()}catch(t){console.error("Error creating group:",t),alert(t?.response?.data?.message||"Не удалось создать беседу")}finally{Cr(!1)}}},children:jr?"Создание...":"Создать"})})]})}),Oa&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("div",{style:{fontWeight:700},children:"Контакты"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Fr(!1),children:e.jsx(Lt,{size:16})})]}),Bt.data&&Bt.data.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Новые запросы"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:Bt.data.map(t=>e.jsxs("div",{className:"tile",children:[e.jsx(et,{name:t.friend.displayName??t.friend.username,id:t.friend.id,presence:t.friend.status,avatarUrl:t.friend.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:t.friend.displayName??t.friend.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"хочет добавить вас"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ae.post("/contacts/respond",{contactId:t.id,action:"reject"}),Bt.refetch()},children:"Отклонить"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{await ae.post("/contacts/respond",{contactId:t.id,action:"accept"}),bt.refetch(),Bt.refetch(),ie.refetch()},children:"Добавить"})]})]},t.id))})]}),e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"Поиск по EBLID"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(t=>e.jsx("input",{ref:Hi[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:Ui[t],onChange:n=>po(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},t))}),Sn&&e.jsxs("div",{className:"tile",style:{marginBottom:12},children:[e.jsx(et,{name:Sn.displayName??Sn.username,id:Sn.id,presence:Gn(Sn),avatarUrl:Sn.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:Sn.displayName??Sn.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Найден по EBLID"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("button",{disabled:Xa,className:"btn btn-primary",onClick:mo,children:"Добавить"})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Мой EBLID:"}),e.jsx("div",{style:{fontWeight:700},children:$i||"— — — —"}),e.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{$i&&navigator.clipboard.writeText($i)},title:"Скопировать EBLID",children:e.jsx(jc,{size:16})})]}),e.jsx("div",{style:{marginTop:16,fontWeight:700},children:"Мои друзья"}),e.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(bt.data||[]).map(t=>{const n=t.friend;return e.jsxs("div",{className:"tile",children:[e.jsx(et,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Контакт"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ae.post("/contacts/remove",{contactId:t.id}),bt.refetch()},children:"Удалить"}),e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await Qs(n.id),Fr(!1),F.invalidateQueries({queryKey:["conversations"]})},children:"Секретный чат"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{const r=await ae.post("/conversations",{participantIds:[n.id],isGroup:!1});Fr(!1),dr(r.data.conversation.id),F.invalidateQueries({queryKey:["conversations"]})},children:"Открыть чат"})]})]},t.id)})})]})}),Re.open&&Re.messageId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Z({open:!1,x:0,y:0,messageId:null}),children:e.jsxs("div",{ref:Vs,className:"msg-menu",style:{position:"absolute",left:Re.x,top:Re.y,color:"#ffffff"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["👍","❤️","👎","🔥","🤝","😆"].map((t,n)=>{const i=t==="❤️"?"#ef4444":"#ffffff";return e.jsx("button",{onClick:async()=>{try{const c=Re.messageId;(($t||[]).find(f=>f.id===c)?.reactions||[]).some(f=>f.userId===N?.id&&f.emoji===t)?await ae.post("/messages/unreact",{messageId:c,emoji:t}):await ae.post("/messages/react",{messageId:c,emoji:t}),s&&F.invalidateQueries({queryKey:["messages",s]})}catch{}Z({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:i,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${n*.05}s both`},onMouseEnter:c=>{c.currentTarget.style.transform="scale(1.2)"},onMouseLeave:c=>{c.currentTarget.style.transform="scale(1)"},children:t},t)})}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const t=Re.messageId,n=($t||[]).find(r=>r.id===t);he({id:t,preview:(n?.content??"").slice(0,100)}),Z({open:!1,x:0,y:0,messageId:null})},children:"Цитировать"}),(()=>{const t=Re.messageId;return($t||[]).find(i=>i.id===t)?.senderId===N?.id?e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await ae.post("/messages/delete",{messageId:Re.messageId}),s&&F.invalidateQueries({queryKey:["messages",s]})}catch{}Z({open:!1,x:0,y:0,messageId:null})},children:"Удалить"}):null})(),e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const t=Re.messageId,n=($t||[]).find(r=>r.id===t);try{await navigator.clipboard.writeText(n?.content||"")}catch{}Z({open:!1,x:0,y:0,messageId:null})},children:"Копировать"}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{qe({open:!0,messageId:Re.messageId}),Z({open:!1,x:0,y:0,messageId:null})},children:"Переслать"})]})}),e.jsx(el,{open:Yi.open,items:Yi.items,index:Yi.index,onClose:()=>Gi(t=>({...t,open:!1})),onIndexChange:t=>Gi(n=>({...n,index:t}))}),Be.open&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>qe({open:!1,messageId:null}),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Переслать сообщение"}),e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(ie.data||[]).map(t=>{const n=t.conversation,i=n.participants.filter(o=>Tt?o.user.id!==Tt:!0).map(o=>o.user).map(o=>o.displayName??o.username).join(", ")||"Диалог",c=n.title??i;return e.jsx("div",{className:"tile",onClick:async()=>{const o=Be.messageId,d=($t||[]).find(f=>f.id===o);d&&(await Zs(n,{type:"TEXT",content:`↪ ${d.content??""}`,replyToId:void 0}),qe({open:!1,messageId:null}))},children:e.jsx("div",{style:{fontWeight:600},children:c})},n.id)})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>qe({open:!1,messageId:null}),children:"Отмена"})})]})}),dt&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:ur,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Добавить участников"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:ur,children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Из друзей"},{key:"eblid",label:"По EBLID"}].map(t=>{const n=un===t.key;return e.jsx("button",{className:"btn btn-ghost",onClick:()=>g(t.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:t.label},t.key)})}),e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:un==="friends"?"Выберите контакты, которых нужно пригласить в эту беседу.":"Введите EBLID пользователя, чтобы пригласить его в беседу."}),un==="friends"?e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:ia.length===0?e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Все ваши контакты уже находятся в этой беседе."}):ia.map(t=>{const n=t.friend,r=dn.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Zn(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[e.jsx(et,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:os(n)})]}),e.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},t.id)})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(t=>e.jsx("input",{ref:V[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:L[t],onChange:n=>oo(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},t))}),Ne&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ищем пользователя…"}),I&&e.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[e.jsx(et,{name:I.displayName??I.username,id:I.id,presence:I.status,avatarUrl:I.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:I.displayName??I.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:ji.alreadyInChat?"Уже в беседе":ji.isSelf?"Это вы":"Найден по EBLID"})]})]}),!I&&te&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:te})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[e.jsx("button",{className:"btn btn-secondary",onClick:ur,children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:wr||(un==="friends"?dn.length===0:!I||ji.alreadyInChat||ji.isSelf),onClick:un==="friends"?so:ao,children:wr?"Добавление...":"Добавить"})]})]})}),Ee.open&&Ee.conversationId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Yt({open:!1,x:0,y:0,conversationId:null}),children:e.jsx("div",{ref:Qt,className:"msg-menu",style:{position:"absolute",left:Ee.x,top:Ee.y},onClick:t=>t.stopPropagation(),children:(()=>{const n=(ie.data||[]).find(c=>c.conversation.id===Ee.conversationId)?.conversation||(s===Ee.conversationId?k:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),i=async()=>{try{r?await ae.delete(`/conversations/${Ee.conversationId}/participants/me`):await ae.delete(`/conversations/${Ee.conversationId}`),F.invalidateQueries({queryKey:["conversations"]}),s===Ee.conversationId&&(l(null),R&&we("list"))}catch{}Yt({open:!1,x:0,y:0,conversationId:null})};return e.jsxs("button",{onClick:i,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?e.jsx(hs,{size:16}):e.jsx(Ea,{size:16}),r?"Выйти из беседы":"Удалить беседу"]})})()})}),jt.open&&jt.anchor&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>lt({open:!1,anchor:null}),children:e.jsx("div",{ref:z,className:"msg-menu",style:{position:"fixed"},onClick:t=>t.stopPropagation(),children:(()=>{const t=k.isGroup||(k.participants?.length??0)>2,n=!!k.isSecret&&!t,r=!t&&k.participants?.find(i=>i.user.id!==Tt)?.user;return t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{Zn([]),g("friends"),E(["","","",""]),q(null),B(null),Le(!1),Pt(!0),lt({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Ta,{size:16}),"Добавить участников"]}),e.jsxs("button",{onClick:async()=>{if(s){try{await ae.delete(`/conversations/${s}/participants/me`),F.invalidateQueries({queryKey:["conversations"]}),l(null),R&&we("list")}catch(i){console.error("Failed to leave conversation:",i)}lt({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(hs,{size:16}),"Выйти из беседы"]})]}):e.jsxs(e.Fragment,{children:[n?e.jsxs("button",{onClick:()=>{Dr(!0),lt({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(kc,{size:16}),"Завершить секретный чат"]}):e.jsxs("button",{onClick:async()=>{r?.id&&await Qs(r.id),lt({open:!1,anchor:null})},disabled:Gs,style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Sa,{size:16}),"Начать секретный чат"]}),e.jsxs("button",{onClick:async()=>{if(s){try{await ae.delete(`/conversations/${s}`),F.invalidateQueries({queryKey:["conversations"]}),F.removeQueries({queryKey:["messages",s]}),l(null),R&&we("list")}catch(i){console.error("Failed to delete conversation:",i)}lt({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(Ea,{size:16}),"Удалить чат"]})]})})()})}),oe&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>ye(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Изменить аватар группы"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>ye(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(et,{name:k.title?.trim()?.charAt(0)||"Г",id:k.id,avatarUrl:Wt??k.avatarUrl??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:k.title||"Группа"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),e.jsx("input",{ref:Rs,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){ti(n);try{Zr(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Wt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),e.jsxs("div",{onClick:()=>Rs.current?.click(),onDragOver:t=>{t.preventDefault(),Fi(!0)},onDragLeave:()=>Fi(!1),onDrop:t=>{t.preventDefault(),Fi(!1);const n=t.dataTransfer.files?.[0];if(n){ti(n);try{Zr(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Es?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Es?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),Wt&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:In,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Me.scale*(1+n))),i=In.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Me.scale,f=c-(c-Me.x)*d,u=o-(o-Me.y)*d;tn({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=In.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,v=p-o;if(j*j+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,b={...Me},A=H=>{H.preventDefault();const ce=H.clientX-w,de=H.clientY-C;tn({...b,x:b.x+ce,y:b.y+de})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Qr,src:Wt,alt:"preview",style:{position:"absolute",left:Me.x,top:Me.y,transform:`scale(${Me.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=In.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,v=o/f,w=Math.max(j,v)*1.2,C=u-d*w/2,b=p-f*w/2;tn({x:C,y:b,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Me.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>tn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:10,step:.01,value:Me.scale,onChange:t=>{const n=parseFloat(t.target.value);tn(r=>{const i=In.current?.getBoundingClientRect();if(!i)return{...r,scale:n};const c=i.width,o=i.height,d=c/2,f=o/2,u=Qr.current;if(u){const p=u.naturalWidth,j=u.naturalHeight,v=r.x+p*r.scale/2,w=r.y+j*r.scale/2,C=v-d,b=w-f,A=n/r.scale,U=d+C*A,H=f+b*A,ce=U-p*n/2,de=H-j*n/2;return{x:ce,y:de,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>tn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:Jr,width:240,height:240,style:{display:"none"}})]}),ei&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{ti(null),Wt&&URL.revokeObjectURL(Wt),Zr(null),tn({x:0,y:0,scale:1})},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:nr,onClick:async()=>{if(!(!ei||!k)){Yr(!0),Kr(0);try{let t=null;if(Jr.current&&Wt){const i=await new Promise(b=>{const A=new Image;A.onload=()=>b(A),A.src=Wt}),c=Jr.current.getContext("2d");if(!c)throw new Error("Could not get 2d context from canvas");const o=240;c.clearRect(0,0,o,o),c.save(),c.beginPath(),c.arc(o/2,o/2,o/2,0,Math.PI*2),c.closePath(),c.clip();const d=In.current?.clientWidth??320,f=In.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-o/2,y:u.y-o/2,w:o,h:o},j=(p.x-Me.x)/Me.scale,v=(p.y-Me.y)/Me.scale,w=p.w/Me.scale,C=p.h/Me.scale;c.drawImage(i,j,v,w,C,0,0,o,o),c.restore(),t=await new Promise(b=>Jr.current.toBlob(A=>b(A),"image/png"))}if(!t&&!ei)throw new Error("No file to upload");const n=new FormData;n.append("file",t??ei);const r=await new Promise((i,c)=>{const o=new XMLHttpRequest;o.open("POST","/api/upload");try{const d=Jn.getState().session?.accessToken;d&&o.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}o.upload.onprogress=d=>{d.lengthComputable&&Kr(Math.round(100*d.loaded/d.total))},o.onreadystatechange=()=>{if(o.readyState===4)if(o.status>=200&&o.status<300)try{const d=JSON.parse(o.responseText);i(d.url)}catch(d){c(d)}else c(new Error(`upload failed: ${o.status} ${o.statusText}`))},o.onerror=()=>{c(new Error("Network error during upload"))},o.send(n)});await ae.patch(`/conversations/${k.id}`,{avatarUrl:r}),F.setQueryData(["conversations"],i=>Array.isArray(i)?i.map(c=>c.conversation?.id===k.id?{...c,conversation:{...c.conversation,avatarUrl:r}}:c):i),F.invalidateQueries({queryKey:["conversations"]}),await ie.refetch(),ti(null),Wt&&URL.revokeObjectURL(Wt),Zr(null),tn({x:0,y:0,scale:1}),ye(!1),rr("Готово"),setTimeout(()=>rr(null),2200)}catch(t){console.error("Error uploading group avatar:",t),rr(`Ошибка: ${t instanceof Error?t.message:"Неизвестная ошибка"}`),setTimeout(()=>rr(null),3e3)}finally{Yr(!1)}}},children:nr?"Загрузка...":"Загрузить"})]}),nr&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Is}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ni&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[e.jsx(Ca,{size:16}),e.jsx("span",{children:ni})]})]})})]})}function Ua(s){return(s??[]).map(l=>l.user.id).sort().join(",")}const zl=Object.freeze(Object.defineProperty({__proto__:null,default:Rl},Symbol.toStringTag,{value:"Module"}));export{zl as C,Lt as X};
