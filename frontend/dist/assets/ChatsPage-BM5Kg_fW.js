const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-CPJ0uwCi.js","assets/index-DM0uD_O-.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-DAyo_qm0.css","assets/index-DpPLIr_7.js","assets/index-DqkCZ1FC.css"])))=>i.map(i=>d[i]);
import{e as br,f as Eo,g as wr,h as ga,n as gn,d as oe,i as Ao,_ as Wa,s as _e,u as Jn,j as To,k as ma,o as Do,l as No,m as ya,p as xa,q as va,t as Lo,v as zo,w as Po,x as Uo,y as Wo,z as Ho,A as Bo,B as $o,D as _o,E as Oo,F as Fo,G as Xo,H as Yo,I as Go,J as qo,K as Vo,L as $r,M as ba,P as Ko,Q as Qo,R as Jo,S as Zo,T as ec,U as wa}from"./index-DM0uD_O-.js";import{r as a,j as e,b as yr,c as tc}from"./vendor-query-D8-W16Rz.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nc=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),rc=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(l,h,y)=>y?y.toUpperCase():h.toLowerCase()),ja=s=>{const l=rc(s);return l.charAt(0).toUpperCase()+l.slice(1)},Ha=(...s)=>s.filter((l,h,y)=>!!l&&l.trim()!==""&&y.indexOf(l)===h).join(" ").trim(),ic=s=>{for(const l in s)if(l.startsWith("aria-")||l==="role"||l==="title")return!0};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var sc={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ac=a.forwardRef(({color:s="currentColor",size:l=24,strokeWidth:h=2,absoluteStrokeWidth:y,className:m="",children:S,iconNode:x,...R},Q)=>a.createElement("svg",{ref:Q,...sc,width:l,height:l,stroke:s,strokeWidth:y?Number(h)*24/Number(l):h,className:Ha("lucide",m),...!S&&!ic(R)&&{"aria-hidden":"true"},...R},[...x.map(([D,$])=>a.createElement(D,$)),...Array.isArray(S)?S:[S]]));/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=(s,l)=>{const h=a.forwardRef(({className:y,...m},S)=>a.createElement(ac,{ref:S,iconNode:l,className:Ha(`lucide-${nc(ja(s))}`,`lucide-${s}`,y),...m}));return h.displayName=ja(s),h};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oc=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],cc=ye("arrow-left",oc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lc=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],dc=ye("bell-ring",lc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uc=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],hc=ye("check",uc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fc=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],pc=ye("chevron-left",fc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gc=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],mc=ye("chevron-right",gc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yc=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ca=ye("circle-check-big",yc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xc=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],vc=ye("circle-plus",xc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bc=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],us=ye("cloud-upload",bc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wc=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],jc=ye("copy",wc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Cc=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],xr=ye("ellipsis-vertical",Cc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],kc=ye("lock-open",Sc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ic=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Sa=ye("lock",Ic);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rc=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],hs=ye("log-out",Rc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mc=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],ka=ye("maximize-2",Mc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ec=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Ac=ye("mic",Ec);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tc=[["path",{d:"M5 12h14",key:"1ays0h"}]],Dc=ye("minus",Tc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nc=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],Lc=ye("paperclip",Nc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zc=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],fs=ye("phone-off",zc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pc=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],ps=ye("phone",Pc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uc=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Wc=ye("reply",Uc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hc=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Ia=ye("rotate-ccw",Hc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bc=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ra=ye("send",Bc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $c=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Ma=ye("square-pen",$c);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _c=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Oc=ye("square",_c);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fc=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ea=ye("trash-2",Fc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xc=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],Aa=ye("undo-2",Xc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ta=ye("user-plus",Yc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],qc=ye("users",Gc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vc=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],gs=ye("video",Vc);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kc=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Lt=ye("x",Kc);async function Da(s={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const l=s.audio!==!1,h=!!s.video;if(!l&&!h)return{ok:!0};const y={audio:l,video:h};let m=null;try{return m=await navigator.mediaDevices.getUserMedia(y),{ok:!0}}catch(S){return{ok:!1,error:S??new Error("Unknown media error")}}finally{m&&m.getTracks().forEach(S=>{try{S.stop()}catch{}})}}function Ni(s){if(!s)return null;if(s.startsWith("blob:")||s.startsWith("data:")||s.startsWith("/"))return s;let l;try{l=new URL(s)}catch{return s}if(l.pathname.startsWith("/api/files/"))return`${l.pathname}${l.search||""}${l.hash||""}`;const h=l.pathname.split("/").filter(Boolean).map(m=>encodeURIComponent(decodeURIComponent(m))).join("/");if(!h)return s;const y=`${l.search||""}${l.hash||""}`;return`/api/files/${h}${y}`}function Qc(s){let l=0;for(let x=0;x<s.length;x++)l=s.charCodeAt(x)+((l<<5)-l);const h=Math.abs(l),y=24+h%18-9,m=60+h%15,S=30+h%12;return`hsl(${y} ${m}% ${S}%)`}const Jc=3,ms=[500,1500,3e3];function tt({name:s,size:l=40,id:h=s,presence:y,avatarUrl:m}){const S=Qc(h),x=(s||"?").trim().charAt(0).toUpperCase(),R=!!m?.startsWith("emoji:"),Q=R?m.slice(6):null,[D,$]=a.useState(!1),[H,J]=a.useState(0),[fe,T]=a.useState(null),Y=a.useRef(null),P=a.useMemo(()=>{if(!m||R)return m??null;if(m.startsWith("data:")||typeof window>"u")return m;const ge=Ni(m);if(ge&&ge!==m)return ge;try{if(m.startsWith("http://")||m.startsWith("https://"))return m;const me=window.location,re=new URL(m,me.origin);return re.host===me.host&&re.protocol!==me.protocol&&(re.protocol=me.protocol),re.toString()}catch{return m}},[m,R]),pe=a.useMemo(()=>{if(!y)return null;switch(y){case"ONLINE":return"#22c55e";case"IN_CALL":return"#ef4444";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[y]);a.useEffect(()=>{$(!1),J(0),T(null),Y.current&&(clearTimeout(Y.current),Y.current=null)},[m]),a.useEffect(()=>{P&&!R&&T(P)},[P,R]);const Se=()=>{if(H<Jc&&P&&!R){const ge=ms[H]||ms[ms.length-1];Y.current=setTimeout(()=>{try{if(P.startsWith("data:"))T(P);else{const me=new URL(P);me.searchParams.set("_retry",String(H+1)),me.searchParams.set("_t",String(Date.now())),T(me.toString())}J(me=>me+1)}catch(me){console.warn("[Avatar] Failed to parse URL for retry:",P,me),T(P),J(re=>re+1)}},ge)}else $(!0)};a.useEffect(()=>()=>{Y.current&&clearTimeout(Y.current)},[]);const at=fe&&!R&&!D;return e.jsxs("div",{style:{width:l,height:l,borderRadius:"50%",background:S,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[at?e.jsx("img",{src:fe,alt:s,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:Se,onLoad:()=>{H>0&&J(0)}}):R?e.jsx("span",{style:{fontSize:Math.floor(l*.6)},children:Q}):x,pe&&e.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(l*.28)),height:Math.max(8,Math.floor(l*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:pe}})]})}const ys=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],xs=[4,8,14],qt=24,sn=80;function Zc({open:s,image:l,onClose:h,onApply:y}){const[m,S]=a.useState(null),[x,R]=a.useState({width:0,height:0}),[Q,D]=a.useState(1),[$,H]=a.useState({x:0,y:0}),[J,fe]=a.useState({width:0,height:0}),[T,Y]=a.useState({x:0,y:0,width:0,height:0}),[P,pe]=a.useState("crop"),[Se,at]=a.useState(ys[0]),[ge,me]=a.useState(xs[1]),[re,We]=a.useState([]),[Ae,Te]=a.useState(null),[Fe,Ln]=a.useState(()=>typeof window<"u"&&window.innerWidth<=768),[Ce,Ve]=a.useState(!1),Rt=a.useRef(null),ot=a.useRef(null),Me=a.useRef(null),Z=a.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),Ee=a.useRef(null),Ft=a.useRef(null),Vt=a.useRef(null),wt=s&&!!l&&!!m&&x.width>0&&x.height>0;a.useEffect(()=>{const g=()=>Ln(window.innerWidth<=768);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]);const L=async()=>{if(!m||!Me.current||Ce)return;Ve(!0);const g=T.width/T.height,z=Math.max(T.x,$.x),E=Math.max(T.y,$.y),V=Math.min(T.x+T.width,$.x+J.width),I=Math.min(T.y+T.height,$.y+J.height),G=V-z,te=I-E,B=m.naturalWidth/J.width,De=m.naturalHeight/J.height;let Ne=(z-$.x)*B,ke=(E-$.y)*De,Le=G*B,nt=te*De;Le/nt>g?Le=nt*g:nt=Le/g;const Kt=m.naturalWidth,M=m.naturalHeight;let jt=Math.max(0,Ne),yt=Math.max(0,ke),Ge=Math.max(1,Math.min(Le,Kt-jt)),we=Math.max(1,Math.min(nt,M-yt));const Un=Ge/we;Math.abs(Un-g)>.01&&(Un>g?Ge=we*g:we=Ge/g,Ge=Math.max(1,Math.min(Ge,Kt-jt)),we=Math.max(1,Math.min(we,M-yt)));const Mt=document.createElement("canvas"),zt=Math.max(1,Math.round(Ge)),Ct=Math.max(1,Math.round(we));Mt.width=zt,Mt.height=Ct;const ve=Mt.getContext("2d");if(!ve){Ve(!1);return}ve.drawImage(m,jt,yt,Ge,we,0,0,zt,Ct);const lt=zt/G,Et=Ct/te;ve.lineCap="round",ve.lineJoin="round";const yn=[...re,...Ae?[Ae]:[]];for(const dt of yn){if(!dt.points.length)continue;ve.strokeStyle=dt.color,ve.lineWidth=dt.size*((lt+Et)/2),ve.beginPath();const ut=dt.points[0],qe=(ut.x-z)*lt,ze=(ut.y-E)*Et;ve.moveTo(qe,ze);for(let At=1;At<dt.points.length;At++){const vt=dt.points[At];ve.lineTo((vt.x-z)*lt,(vt.y-E)*Et)}ve.stroke()}const xt=new Image;xt.src=Mt.toDataURL(),await new Promise(dt=>{xt.onload=()=>{S(xt);const ut=xt.naturalWidth/xt.naturalHeight;let qe,ze;if(Fe){const St=window.innerWidth,xn=window.innerHeight-200-60,Hn=St;ut>Hn/xn?(qe=Hn,ze=Hn/ut):(ze=xn,qe=xn*ut)}else{const St=Math.min(window.innerWidth-64,720),je=Math.min(window.innerHeight-200,520);ut>St/je?(qe=Math.max(280,St),ze=qe/ut):(ze=Math.max(220,je),qe=ze*ut)}R({width:qe,height:ze});const At=qe/xt.naturalWidth;D(At),fe({width:qe,height:ze}),H({x:0,y:0});const vt=2,er=Math.max(sn,qe-vt*2),Qt=Math.max(sn,ze-vt*2);Y({x:vt,y:vt,width:er,height:Qt});const Wn=qe/zt,Cr=ze/Ct,Sr=yn.map(St=>({...St,points:St.points.map(je=>{const Yt=(je.x-z)*lt,kr=(je.y-E)*Et,xn=Yt*Wn,Hn=kr*Cr;return{x:xn,y:Hn}})}));We(Sr.filter(St=>St.points.every(je=>je.x>=0&&je.x<=qe&&je.y>=0&&je.y<=ze))),Te(null),setTimeout(()=>{_()},0);const Xr=performance.now(),tr=300,ln=St=>{const je=St-Xr;Math.min(je/tr,1)<1?Vt.current=requestAnimationFrame(ln):(Ve(!1),Vt.current=null,setTimeout(()=>{_()},0))};Vt.current=requestAnimationFrame(ln),dt()}})};a.useEffect(()=>()=>{Vt.current&&cancelAnimationFrame(Vt.current)},[]),a.useEffect(()=>{if(!s||!l){S(null),We([]),Te(null),Ve(!1);return}const g=new Image;return g.crossOrigin="anonymous",g.onload=()=>{if(S(g),Fe){const z=window.innerWidth,G=window.innerHeight-200-60,te=z;let B=g.naturalWidth,De=g.naturalHeight;const Ne=te/B,ke=G/De,Le=Math.min(Ne,ke);B=g.naturalWidth*Le,De=g.naturalHeight*Le,R({width:te,height:G}),D(Le),fe({width:B,height:De});const nt={x:(te-B)/2,y:(G-De)/2};H(nt);const Xt=2;Y({x:Xt,y:Xt,width:te-Xt*2,height:G-Xt*2})}else{const z=Math.min(window.innerWidth-64,720),E=Math.min(window.innerHeight-200,520);let V=g.naturalWidth,I=g.naturalHeight;if(V>z){const ke=z/V;V*=ke,I*=ke}if(I>E){const ke=E/I;V*=ke,I*=ke}V=Math.max(280,V),I=Math.max(220,I),R({width:V,height:I});const G=Math.max(V/g.naturalWidth,I/g.naturalHeight);D(G);const te=g.naturalWidth*G,B=g.naturalHeight*G;fe({width:te,height:B});const De={x:(V-te)/2,y:(I-B)/2};H(De);const Ne=2;Y({x:Ne,y:Ne,width:V-Ne*2,height:I-Ne*2})}We([]),Te(null),pe("crop"),Ve(!1)},g.src=l.previewUrl,Ft.current=()=>{g.src=""},()=>{Ft.current?.(),Ft.current=null}},[s,l?.id,l?.previewUrl,Fe]),a.useEffect(()=>{s||(We([]),Te(null),Ve(!1))},[s]);const _=()=>{const g=ot.current;if(!g||x.width===0||x.height===0)return;const z=g.getContext("2d");if(!z)return;const E=window.devicePixelRatio||1;(g.width!==x.width*E||g.height!==x.height*E)&&(g.width=x.width*E,g.height=x.height*E,g.style.width=`${x.width}px`,g.style.height=`${x.height}px`),z.save(),z.scale(E,E),z.clearRect(0,0,x.width,x.height);const V=Ae?[...re,Ae]:re;z.lineCap="round",z.lineJoin="round";for(const I of V)if(I.points.length!==0){z.strokeStyle=I.color,z.lineWidth=I.size,z.beginPath(),z.moveTo(I.points[0].x,I.points[0].y);for(let G=1;G<I.points.length;G++)z.lineTo(I.points[G].x,I.points[G].y);z.stroke()}z.restore()};a.useEffect(()=>{_()},[re,Ae,x.width,x.height]),a.useEffect(()=>{const g=z=>{s&&z.key==="Escape"&&(z.preventDefault(),h())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[s,h]);const ce=(g,z,E)=>{const I=qt/2;return Math.abs(g-E.x)<I&&Math.abs(z-E.y)<I?"nw":Math.abs(g-(E.x+E.width))<I&&Math.abs(z-E.y)<I?"ne":Math.abs(g-E.x)<I&&Math.abs(z-(E.y+E.height))<I?"sw":Math.abs(g-(E.x+E.width))<I&&Math.abs(z-(E.y+E.height))<I?"se":Math.abs(g-E.x)<I&&z>=E.y&&z<=E.y+E.height?"w":Math.abs(g-(E.x+E.width))<I&&z>=E.y&&z<=E.y+E.height?"e":Math.abs(z-E.y)<I&&g>=E.x&&g<=E.x+E.width?"n":Math.abs(z-(E.y+E.height))<I&&g>=E.x&&g<=E.x+E.width?"s":g>=E.x&&g<=E.x+E.width&&z>=E.y&&z<=E.y+E.height?"move":null},xe=g=>{const G=x.width-2,te=x.height-2,B=Math.max(2,Math.min(G-g.width,g.x)),De=Math.max(2,Math.min(te-g.height,g.y)),Ne=Math.max(sn,Math.min(G-B,g.width)),ke=Math.max(sn,Math.min(te-De,g.height));return{x:B,y:De,width:Ne,height:ke}},He=g=>{if(P!=="crop"||Ce||!Rt.current)return;g.preventDefault();const z=Rt.current.getBoundingClientRect(),E=g.clientX-z.left,V=g.clientY-z.top,I=ce(E,V,T);I&&(Rt.current.setPointerCapture(g.pointerId),Z.current={type:I==="move"?"move":"resize",handle:I!=="move"?I:void 0,startX:g.clientX,startY:g.clientY,initial:{...T}})},Oe=g=>{if(P!=="crop"||!Z.current.type||Ce||(g.preventDefault(),!Rt.current?.getBoundingClientRect()))return;const E=g.clientX-Z.current.startX,V=g.clientY-Z.current.startY,I=E,G=V;if(Z.current.type==="move"){const te={x:Z.current.initial.x+I,y:Z.current.initial.y+G,width:Z.current.initial.width,height:Z.current.initial.height};Y(xe(te))}else if(Z.current.type==="resize"&&Z.current.handle){const te=Z.current.handle;let B={...Z.current.initial};te==="nw"?(B.x=Z.current.initial.x+I,B.y=Z.current.initial.y+G,B.width=Z.current.initial.width-I,B.height=Z.current.initial.height-G):te==="ne"?(B.y=Z.current.initial.y+G,B.width=Z.current.initial.width+I,B.height=Z.current.initial.height-G):te==="sw"?(B.x=Z.current.initial.x+I,B.width=Z.current.initial.width-I,B.height=Z.current.initial.height+G):te==="se"?(B.width=Z.current.initial.width+I,B.height=Z.current.initial.height+G):te==="n"?(B.y=Z.current.initial.y+G,B.height=Z.current.initial.height-G):te==="s"?B.height=Z.current.initial.height+G:te==="w"?(B.x=Z.current.initial.x+I,B.width=Z.current.initial.width-I):te==="e"&&(B.width=Z.current.initial.width+I),B.width<sn&&((te==="nw"||te==="w"||te==="sw")&&(B.x=Z.current.initial.x+Z.current.initial.width-sn),B.width=sn),B.height<sn&&((te==="nw"||te==="n"||te==="ne")&&(B.y=Z.current.initial.y+Z.current.initial.height-sn),B.height=sn),Y(xe(B))}},Be=async g=>{const z=Z.current.type!==null;Z.current.type&&Rt.current?.hasPointerCapture(g.pointerId)&&Rt.current.releasePointerCapture(g.pointerId),Z.current.type=null,z&&P==="crop"&&!Ce&&await L()},ct=g=>{if(P!=="draw"||!ot.current||Ce)return;g.preventDefault();const z=ot.current.getBoundingClientRect(),E={x:g.clientX-z.left,y:g.clientY-z.top},V={color:Se,size:ge,points:[E]};Ee.current=g.pointerId,ot.current.setPointerCapture(g.pointerId),Te(V)},gt=g=>{if(P!=="draw"||Ee.current!==g.pointerId||!ot.current)return;g.preventDefault();const z=ot.current.getBoundingClientRect(),E={x:g.clientX-z.left,y:g.clientY-z.top};Te(V=>!V||V.points.length&&V.points[V.points.length-1].x===E.x&&V.points[V.points.length-1].y===E.y?V:{...V,points:[...V.points,E]})},mt=g=>{P!=="draw"||Ee.current!==g.pointerId||(Ee.current=null,ot.current?.hasPointerCapture(g.pointerId)&&ot.current.releasePointerCapture(g.pointerId),Te(z=>{if(!z)return null;if(z.points.length<2){const E={...z,points:[...z.points,z.points[0]]};We(V=>[...V,E])}else We(E=>[...E,z]);return null}))},zn=()=>{We(g=>g.slice(0,-1))},Pn=()=>{We([]),Te(null)},Zn=async()=>{if(!m||Ce)return;const g=new Image;g.crossOrigin="anonymous",await new Promise(z=>{g.onload=()=>{if(S(g),Fe){const E=window.innerWidth,te=window.innerHeight-200-60,B=E;let De=g.naturalWidth,Ne=g.naturalHeight;const ke=B/De,Le=te/Ne,nt=Math.min(ke,Le),Xt=De*nt,Kt=Ne*nt;R({width:B,height:te}),D(nt),fe({width:Xt,height:Kt});const M={x:(B-Xt)/2,y:(te-Kt)/2};H(M);const jt=2;Y({x:jt,y:jt,width:B-jt*2,height:te-jt*2})}else{const E=Math.min(window.innerWidth-64,720),V=Math.min(window.innerHeight-200,520);let I=g.naturalWidth,G=g.naturalHeight;if(I>E){const Le=E/I;I*=Le,G*=Le}if(G>V){const Le=V/G;I*=Le,G*=Le}I=Math.max(280,I),G=Math.max(220,G),R({width:I,height:G});const te=Math.max(I/g.naturalWidth,G/g.naturalHeight);D(te);const B=g.naturalWidth*te,De=g.naturalHeight*te;fe({width:B,height:De});const Ne={x:(I-B)/2,y:(G-De)/2};H(Ne);const ke=2;Y({x:ke,y:ke,width:I-ke*2,height:G-ke*2})}We([]),Te(null),z()},g.src=l.previewUrl})},jr=async()=>{if(!l||!m)return;const g=T.width/T.height,z=Math.max(T.x,$.x),E=Math.max(T.y,$.y),V=Math.min(T.x+T.width,$.x+J.width),I=Math.min(T.y+T.height,$.y+J.height),G=V-z,te=I-E,B=m.naturalWidth/J.width,De=m.naturalHeight/J.height,Ne=(z-$.x)*B,ke=(E-$.y)*De;let Le=G*B,nt=te*De;Le/nt>g?Le=nt*g:nt=Le/g;const Kt=m.naturalWidth,M=m.naturalHeight;let jt=Math.max(0,Ne),yt=Math.max(0,ke),Ge=Math.max(1,Math.min(Le,Kt-jt)),we=Math.max(1,Math.min(nt,M-yt));const Un=Ge/we;Math.abs(Un-g)>.01&&(Un>g?Ge=we*g:we=Ge/g,Ge=Math.max(1,Math.min(Ge,Kt-jt)),we=Math.max(1,Math.min(we,M-yt)));const Mt=Math.max(1,Math.round(Ge)),zt=Math.max(1,Math.round(we)),Ct=document.createElement("canvas");Ct.width=Mt,Ct.height=zt;const ve=Ct.getContext("2d");if(!ve)return;ve.drawImage(m,jt,yt,Ge,we,0,0,Mt,zt);const lt=Mt/G,Et=zt/te,yn=[...re,...Ae?[Ae]:[]];ve.lineCap="round",ve.lineJoin="round";for(const ze of yn){if(!ze.points.length)continue;ve.strokeStyle=ze.color,ve.lineWidth=ze.size*((lt+Et)/2),ve.beginPath();const At=ze.points[0],vt=(At.x-z)*lt,er=(At.y-E)*Et;ve.moveTo(vt,er);for(let Qt=1;Qt<ze.points.length;Qt++){const Wn=ze.points[Qt];ve.lineTo((Wn.x-z)*lt,(Wn.y-E)*Et)}ve.stroke()}const xt=await new Promise(ze=>Ct.toBlob(At=>ze(At),"image/png",.96));if(!xt)return;const dt=l.fileName?.replace(/\.[^.]+$/,"")||l.file.name.replace(/\.[^.]+$/,"")||"image",ut=new File([xt],`${dt}-edited.png`,{type:"image/png"}),qe=URL.createObjectURL(xt);y({file:ut,previewUrl:qe})},mn=()=>{if(P!=="crop"||Ce)return null;const{x:g,y:z,width:E,height:V}=T,I={position:"absolute",width:qt,height:qt,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{...I,left:g-qt/2,top:z-qt/2,cursor:"nwse-resize"}}),e.jsx("div",{style:{...I,left:g+E-qt/2,top:z-qt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...I,left:g-qt/2,top:z+V-qt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...I,left:g+E-qt/2,top:z+V-qt/2,cursor:"nwse-resize"}})]})};if(!s||!l)return null;if(Fe)return br.createPortal(e.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[e.jsx("button",{onClick:h,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"Отмена"}),e.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Редактирование"}),e.jsx("button",{onClick:jr,disabled:!wt||Ce,style:{background:!wt||Ce?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:wt&&!Ce?"pointer":"not-allowed"},children:"Сохранить"})]}),e.jsxs("div",{ref:Rt,onPointerDown:He,onPointerMove:Oe,onPointerUp:Be,onPointerLeave:Be,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:$.x,top:$.y,width:J.width,height:J.height,userSelect:"none",pointerEvents:"none",transition:Ce?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ot,style:{position:"absolute",inset:0,pointerEvents:P==="draw"?"auto":"none"},onPointerDown:ct,onPointerMove:gt,onPointerUp:mt,onPointerLeave:mt}),e.jsx("canvas",{ref:Me,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),P==="crop"&&!Ce&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${T.x}px 100%,
                    ${T.x}px ${T.y}px,
                    ${T.x+T.width}px ${T.y}px,
                    ${T.x+T.width}px ${T.y+T.height}px,
                    ${T.x}px ${T.y+T.height}px,
                    ${T.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:T.x,top:T.y,width:T.width,height:T.height,border:"2px solid #fff",pointerEvents:"none"}}),mn()]})]}),e.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>pe("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:P==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"Обрезать"}),e.jsxs("button",{onClick:()=>pe("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:P==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[e.jsx(Ma,{size:18}),"Рисовать"]})]}),e.jsxs("button",{onClick:Zn,disabled:Ce,style:{padding:"10px",borderRadius:10,border:"none",background:Ce?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:Ce?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:Ce?"not-allowed":"pointer"},children:[e.jsx(Ia,{size:16}),"Сбросить"]}),P==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Цвет кисти"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:ys.map(g=>e.jsx("button",{onClick:()=>at(g),style:{width:40,height:40,borderRadius:"50%",border:Se===g?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:g,cursor:"pointer",flexShrink:0},"aria-label":`Выбрать цвет ${g}`},g))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Толщина"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:xs.map(g=>e.jsx("button",{onClick:()=>me(g),style:{width:48,height:48,borderRadius:12,border:ge===g?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:ge===g?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{onClick:zn,disabled:re.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:re.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:re.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:re.length===0?"not-allowed":"pointer"},children:[e.jsx(Aa,{size:16}),"Отменить"]}),e.jsx("button",{onClick:Pn,disabled:re.length===0&&!Ae,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:re.length===0&&!Ae?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:re.length===0&&!Ae?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:re.length===0&&!Ae?"not-allowed":"pointer"},children:"Очистить"})]})]})]})]}),document.body);const cn=e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:e.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Редактирование изображения",e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:l.fileName||l.file.name})]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:h,"aria-label":"Закрыть редактор",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{ref:Rt,onPointerDown:He,onPointerMove:Oe,onPointerUp:Be,onPointerLeave:Be,style:{position:"relative",width:x.width,height:x.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:P==="crop"?"default":"crosshair"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:$.x,top:$.y,width:J.width,height:J.height,userSelect:"none",pointerEvents:"none",transition:Ce?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ot,style:{position:"absolute",inset:0,pointerEvents:P==="draw"?"auto":"none"},onPointerDown:ct,onPointerMove:gt,onPointerUp:mt,onPointerLeave:mt}),e.jsx("canvas",{ref:Me,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),P==="crop"&&!Ce&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${T.x}px 100%,
                    ${T.x}px ${T.y}px,
                    ${T.x+T.width}px ${T.y}px,
                    ${T.x+T.width}px ${T.y+T.height}px,
                    ${T.x}px ${T.y+T.height}px,
                    ${T.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:T.x,top:T.y,width:T.width,height:T.height,border:"2px solid #fff",pointerEvents:"none"}}),mn()]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:P==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>pe("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"Обрезать"}),e.jsxs("button",{className:P==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>pe("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ma,{size:16}),"Рисовать"]}),e.jsxs("button",{className:"btn btn-ghost",onClick:Zn,disabled:Ce,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ia,{size:16}),"Сбросить"]}),P==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost",onClick:zn,disabled:re.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Aa,{size:16}),"Отменить штрих"]}),e.jsx("button",{className:"btn btn-ghost",onClick:Pn,disabled:re.length===0&&!Ae,style:{display:"inline-flex",alignItems:"center",gap:6},children:"Очистить рисунок"})]})]}),P==="draw"&&e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Цвет кисти"}),e.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:ys.map(g=>e.jsx("button",{onClick:()=>at(g),style:{width:28,height:28,borderRadius:"50%",border:Se===g?"2px solid #fff":"2px solid transparent",background:g,cursor:"pointer"},"aria-label":`Выбрать цвет ${g}`},g))})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Толщина"}),e.jsx("div",{style:{display:"flex",gap:8},children:xs.map(g=>e.jsx("button",{onClick:()=>me(g),className:ge===g?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[e.jsx("button",{className:"btn btn-ghost",onClick:h,children:"Отмена"}),e.jsxs("button",{className:"btn btn-primary",onClick:jr,disabled:!wt||Ce,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[e.jsx(hc,{size:16}),"Сохранить"]})]})]})});return br.createPortal(cn,document.body)}function Tn(s,l,h){return Math.min(h,Math.max(l,s))}function el({open:s,items:l,index:h,onClose:y,onIndexChange:m}){const S=a.useRef(null),x=a.useRef(null),[R,Q]=a.useState({}),[D,$]=a.useState({w:0,h:0}),[H,J]=a.useState(1),[fe,T]=a.useState(0),[Y,P]=a.useState(0),pe=a.useRef(null),Se=a.useRef(null),at=a.useRef(0),ge=a.useRef(0),me=a.useRef(null),re=l.length,We=re>1,Ae=l[h]||"",Te=Ae?R[Ae]:void 0,Fe=a.useMemo(()=>{if(!Te||!D.w||!D.h)return{scale:1,maxX:0,maxY:0};const L=56,_=re>1?82:24,ce=28,xe=Math.max(0,D.w-ce*2),He=Math.max(0,D.h-L-_-ce*2),Be=Math.min(xe/Te.w,He/Te.h,1)*H,ct=Te.w*Be,gt=Te.h*Be,mt=Math.max(0,(ct-xe)/2),zn=Math.max(0,(gt-He)/2);return{scale:Be,maxX:mt,maxY:zn}},[Te,D.w,D.h,H,re]),Ln=()=>{We&&m((h-1+re)%re)},Ce=()=>{We&&m((h+1)%re)},Ve=()=>{J(1),T(0),P(0)};a.useEffect(()=>{if(!s)return;const L=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=L}},[s]),a.useLayoutEffect(()=>{if(!s)return;const L=()=>{const _=window.innerWidth,ce=window.innerHeight;$({w:_,h:ce})};return L(),window.addEventListener("resize",L),()=>window.removeEventListener("resize",L)},[s]),a.useEffect(()=>{s&&Ve()},[s,Ae]),a.useEffect(()=>{if(!s)return;const L=_=>{_.key==="Escape"&&y(),_.key==="ArrowLeft"&&Ln(),_.key==="ArrowRight"&&Ce(),(_.key==="+"||_.key==="=")&&J(ce=>Tn(ce*1.15,1,6)),_.key==="-"&&J(ce=>Tn(ce/1.15,1,6)),_.key==="0"&&Ve()};return window.addEventListener("keydown",L),()=>window.removeEventListener("keydown",L)},[s,h,re,Ae,y]),a.useEffect(()=>{s&&(T(L=>Tn(L,-Fe.maxX,Fe.maxX)),P(L=>Tn(L,-Fe.maxY,Fe.maxY)))},[s,Fe.maxX,Fe.maxY]);const Rt=L=>{if(!s)return;L.preventDefault();const _=x.current?.getBoundingClientRect()??null,ce=!!_&&L.clientX>=_.left&&L.clientX<=_.right&&L.clientY>=_.top&&L.clientY<=_.bottom,xe=L.deltaMode===1?L.deltaY*16:L.deltaMode===2?L.deltaY*D.h:L.deltaY;if(!ce){if(!We)return;const Be=performance.now(),ct=260,gt=90;if(at.current+=xe,Be-ge.current<ct||Math.abs(at.current)<gt)return;ge.current=Be;const mt=at.current>0?1:-1;at.current=0,mt>0?Ce():Ln();return}const Oe=Math.exp(-xe*8e-5);J(Be=>Tn(Be*Oe,1,6))},ot=L=>{if(L.button!==0)return;L.currentTarget.setPointerCapture(L.pointerId);const _=H>1.01,ce=x.current?.getBoundingClientRect()??null,xe=!!ce&&L.clientX>=ce.left&&L.clientX<=ce.right&&L.clientY>=ce.top&&L.clientY<=ce.bottom;pe.current={active:!0,startX:L.clientX,startY:L.clientY,startTx:fe,startTy:Y,mode:_?"pan":"swipe",startedInsideImg:xe}},Me=L=>{const _=pe.current;if(!_?.active)return;const ce=L.clientX-_.startX,xe=L.clientY-_.startY;if(_.mode==="pan"){T(Tn(_.startTx+ce,-Fe.maxX,Fe.maxX)),P(Tn(_.startTy+xe,-Fe.maxY,Fe.maxY));return}},Z=L=>{const _=pe.current;if(pe.current=null,!_?.active)return;const ce=L.clientX-_.startX,xe=L.clientY-_.startY;if(_.mode==="swipe"){if(Math.abs(xe)>110&&Math.abs(ce)<90){y();return}if(Math.abs(ce)>70&&Math.abs(xe)<60){ce<0?Ce():Ln();return}}const He=8,Oe=Math.abs(ce)<=He&&Math.abs(xe)<=He;if(Oe&&_.startedInsideImg){const Be=performance.now(),ct=me.current,gt=280,mt=18;if(ct&&Be-ct.ts<=gt&&Math.abs(ct.x-L.clientX)<=mt&&Math.abs(ct.y-L.clientY)<=mt){me.current=null,H<=1.01?J(2):Ve();return}me.current={ts:Be,x:L.clientX,y:L.clientY};return}Oe&&!_.startedInsideImg&&(H>1.01?Ve():y())},Ee=L=>{if(L.touches.length!==2){Se.current=null;return}L.preventDefault();const _=L.touches[0],ce=L.touches[1],xe=_.clientX-ce.clientX,He=_.clientY-ce.clientY,Oe=Math.sqrt(xe*xe+He*He),Be=Se.current;if(Se.current=Oe,!Be)return;const ct=Oe>Be?1.03:1/1.03;J(gt=>Tn(gt*ct,1,6))},Ft=()=>{H<=1.01?J(2):Ve()};if(!s)return null;const Vt=(()=>{if(re<=13)return l.map((Oe,Be)=>({u:Oe,i:Be}));const _=Math.floor(13/2);let ce=h-_,xe=h+_;if(ce<0&&(xe+=-ce,ce=0),xe>re-1){const Oe=xe-(re-1);ce=Math.max(0,ce-Oe),xe=re-1}const He=[];for(let Oe=ce;Oe<=xe;Oe++)He.push({u:l[Oe],i:Oe});return He})(),wt=e.jsxs("div",{className:"imglb-root",ref:S,onWheel:Rt,children:[e.jsx("div",{className:"imglb-backdrop",onClick:y}),e.jsxs("div",{className:"imglb-topbar",children:[e.jsx("div",{className:"imglb-spacer","aria-hidden":"true"}),e.jsxs("div",{className:"imglb-title",children:[h+1," / ",re]}),e.jsx("button",{className:"imglb-btn",onClick:y,"aria-label":"Закрыть",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{className:"imglb-stage",onPointerDown:ot,onPointerMove:Me,onPointerUp:Z,onPointerCancel:()=>{pe.current=null},onTouchMove:Ee,onDoubleClick:Ft,children:[We&&e.jsx("button",{className:"imglb-nav imglb-nav-left",onClick:Ln,"aria-label":"Назад",children:e.jsx(pc,{size:24})}),e.jsx("div",{className:"imglb-media",onClick:L=>L.stopPropagation(),children:e.jsx("div",{className:"imglb-pan",style:{transform:`translate3d(${fe}px, ${Y}px, 0)`},children:e.jsx("img",{ref:x,className:"imglb-img",src:Ae,alt:"preview",draggable:!1,style:{width:Te?.w?`${Te.w}px`:void 0,height:Te?.h?`${Te.h}px`:void 0,transform:`scale(${Fe.scale})`},onLoad:L=>{const _=L.currentTarget,ce=_.naturalWidth||1,xe=_.naturalHeight||1;Q(He=>({...He,[Ae]:{w:ce,h:xe}}))}})})}),We&&e.jsx("button",{className:"imglb-nav imglb-nav-right",onClick:Ce,"aria-label":"Вперёд",children:e.jsx(mc,{size:24})})]}),re>1&&e.jsx("div",{className:"imglb-thumbs",onClick:L=>L.stopPropagation(),children:e.jsx("div",{className:"imglb-thumbs-inner",children:Vt.map(({u:L,i:_})=>e.jsx("button",{type:"button",className:_===h?"imglb-thumb is-active":"imglb-thumb",onClick:()=>m(_),"aria-label":`Открыть ${_+1}`,children:e.jsx("img",{src:L,alt:"",draggable:!1})},`${L}-${_}`))})})]});return br.createPortal(wt,document.body)}const _r=Eo(s=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:l=>s({incoming:l}),startOutgoing:(l,h)=>s({activeConvId:l,incoming:null,initialVideo:!!h,initialAudio:!0}),startIncoming:l=>s({incoming:l}),endCall:()=>s({activeConvId:null,incoming:null,initialVideo:!1})}));/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function tl(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function js(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function zi(s,...l){if(!tl(s))throw new Error("Uint8Array expected");if(l.length>0&&!l.includes(s.length))throw new Error("Uint8Array expected of length "+l+", got length="+s.length)}function Cs(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");js(s.outputLen),js(s.blockLen)}function Li(s,l=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(l&&s.finished)throw new Error("Hash#digest() has already been called")}function nl(s,l){zi(s);const h=l.outputLen;if(s.length<h)throw new Error("digestInto() expects output buffer of length at least "+h)}function Or(...s){for(let l=0;l<s.length;l++)s[l].fill(0)}function vs(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function an(s,l){return s<<32-l|s>>>l}function rl(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function Fr(s){return typeof s=="string"&&(s=rl(s)),zi(s),s}class Ba{}function il(s){const l=y=>s().update(Fr(y)).digest(),h=s();return l.outputLen=h.outputLen,l.blockLen=h.blockLen,l.create=()=>s(),l}class $a extends Ba{constructor(l,h){super(),this.finished=!1,this.destroyed=!1,Cs(l);const y=Fr(h);if(this.iHash=l.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const m=this.blockLen,S=new Uint8Array(m);S.set(y.length>m?l.create().update(y).digest():y);for(let x=0;x<S.length;x++)S[x]^=54;this.iHash.update(S),this.oHash=l.create();for(let x=0;x<S.length;x++)S[x]^=106;this.oHash.update(S),Or(S)}update(l){return Li(this),this.iHash.update(l),this}digestInto(l){Li(this),zi(l,this.outputLen),this.finished=!0,this.iHash.digestInto(l),this.oHash.update(l),this.oHash.digestInto(l),this.destroy()}digest(){const l=new Uint8Array(this.oHash.outputLen);return this.digestInto(l),l}_cloneInto(l){l||(l=Object.create(Object.getPrototypeOf(this),{}));const{oHash:h,iHash:y,finished:m,destroyed:S,blockLen:x,outputLen:R}=this;return l=l,l.finished=m,l.destroyed=S,l.blockLen=x,l.outputLen=R,l.oHash=h._cloneInto(l.oHash),l.iHash=y._cloneInto(l.iHash),l}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ss=(s,l,h)=>new $a(s,l).update(h).digest();Ss.create=(s,l)=>new $a(s,l);function sl(s,l,h){return Cs(s),h===void 0&&(h=new Uint8Array(s.outputLen)),Ss(s,Fr(h),Fr(l))}const bs=Uint8Array.from([0]),Na=Uint8Array.of();function al(s,l,h,y=32){Cs(s),js(y);const m=s.outputLen;if(y>255*m)throw new Error("Length should be <= 255*HashLen");const S=Math.ceil(y/m);h===void 0&&(h=Na);const x=new Uint8Array(S*m),R=Ss.create(s,l),Q=R._cloneInto(),D=new Uint8Array(R.outputLen);for(let $=0;$<S;$++)bs[0]=$+1,Q.update($===0?Na:D).update(h).update(bs).digestInto(D),x.set(D,m*$),R._cloneInto(Q);return R.destroy(),Q.destroy(),Or(D,bs),x.slice(0,y)}const ol=(s,l,h,y,m)=>al(s,sl(s,l,h),y,m);function cl(s,l,h,y){if(typeof s.setBigUint64=="function")return s.setBigUint64(l,h,y);const m=BigInt(32),S=BigInt(4294967295),x=Number(h>>m&S),R=Number(h&S),Q=y?4:0,D=y?0:4;s.setUint32(l+Q,x,y),s.setUint32(l+D,R,y)}function ll(s,l,h){return s&l^~s&h}function dl(s,l,h){return s&l^s&h^l&h}class ul extends Ba{constructor(l,h,y,m){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=l,this.outputLen=h,this.padOffset=y,this.isLE=m,this.buffer=new Uint8Array(l),this.view=vs(this.buffer)}update(l){Li(this),l=Fr(l),zi(l);const{view:h,buffer:y,blockLen:m}=this,S=l.length;for(let x=0;x<S;){const R=Math.min(m-this.pos,S-x);if(R===m){const Q=vs(l);for(;m<=S-x;x+=m)this.process(Q,x);continue}y.set(l.subarray(x,x+R),this.pos),this.pos+=R,x+=R,this.pos===m&&(this.process(h,0),this.pos=0)}return this.length+=l.length,this.roundClean(),this}digestInto(l){Li(this),nl(l,this),this.finished=!0;const{buffer:h,view:y,blockLen:m,isLE:S}=this;let{pos:x}=this;h[x++]=128,Or(this.buffer.subarray(x)),this.padOffset>m-x&&(this.process(y,0),x=0);for(let H=x;H<m;H++)h[H]=0;cl(y,m-8,BigInt(this.length*8),S),this.process(y,0);const R=vs(l),Q=this.outputLen;if(Q%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const D=Q/4,$=this.get();if(D>$.length)throw new Error("_sha2: outputLen bigger than state");for(let H=0;H<D;H++)R.setUint32(4*H,$[H],S)}digest(){const{buffer:l,outputLen:h}=this;this.digestInto(l);const y=l.slice(0,h);return this.destroy(),y}_cloneInto(l){l||(l=new this.constructor),l.set(...this.get());const{blockLen:h,buffer:y,length:m,finished:S,destroyed:x,pos:R}=this;return l.destroyed=x,l.finished=S,l.length=m,l.pos=R,m%h&&l.buffer.set(y),l}clone(){return this._cloneInto()}}const Dn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),hl=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Nn=new Uint32Array(64);class fl extends ul{constructor(l=32){super(64,l,8,!1),this.A=Dn[0]|0,this.B=Dn[1]|0,this.C=Dn[2]|0,this.D=Dn[3]|0,this.E=Dn[4]|0,this.F=Dn[5]|0,this.G=Dn[6]|0,this.H=Dn[7]|0}get(){const{A:l,B:h,C:y,D:m,E:S,F:x,G:R,H:Q}=this;return[l,h,y,m,S,x,R,Q]}set(l,h,y,m,S,x,R,Q){this.A=l|0,this.B=h|0,this.C=y|0,this.D=m|0,this.E=S|0,this.F=x|0,this.G=R|0,this.H=Q|0}process(l,h){for(let H=0;H<16;H++,h+=4)Nn[H]=l.getUint32(h,!1);for(let H=16;H<64;H++){const J=Nn[H-15],fe=Nn[H-2],T=an(J,7)^an(J,18)^J>>>3,Y=an(fe,17)^an(fe,19)^fe>>>10;Nn[H]=Y+Nn[H-7]+T+Nn[H-16]|0}let{A:y,B:m,C:S,D:x,E:R,F:Q,G:D,H:$}=this;for(let H=0;H<64;H++){const J=an(R,6)^an(R,11)^an(R,25),fe=$+J+ll(R,Q,D)+hl[H]+Nn[H]|0,Y=(an(y,2)^an(y,13)^an(y,22))+dl(y,m,S)|0;$=D,D=Q,Q=R,R=x+fe|0,x=S,S=m,m=y,y=fe+Y|0}y=y+this.A|0,m=m+this.B|0,S=S+this.C|0,x=x+this.D|0,R=R+this.E|0,Q=Q+this.F|0,D=D+this.G|0,$=$+this.H|0,this.set(y,m,S,x,R,Q,D,$)}roundClean(){Or(Nn)}destroy(){this.set(0,0,0,0,0,0,0,0),Or(this.buffer)}}const pl=il(()=>new fl),gl=pl,ml=new TextEncoder,yl=new TextDecoder;function Ot(s){if(!s)return new Uint8Array;const l=s.replace(/-/g,"+").replace(/_/g,"/"),h=l.length%4===0?"":"=".repeat(4-l.length%4),y=atob(l+h),m=y.length,S=new Uint8Array(m);for(let x=0;x<m;x+=1)S[x]=y.charCodeAt(x);return S}function vr(s){let l="";for(let h=0;h<s.length;h+=1)l+=String.fromCharCode(s[h]);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function La(s){return ml.encode(s)}function xl(s){return yl.decode(s)}const za="eb_e2ee_sessions_v1";class vl{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(l){return!!this.sessions[l]}getSession(l){return this.sessions[l]??null}async ensureSession(l){if(!l.isSecret||l.secretStatus!=="ACTIVE")return null;const h=this.sessions[l.id];if(h)return h;const y=wr(),m=ga();if(!y||!m||!l.secretInitiatorDeviceId||!l.secretPeerDeviceId||!(l.secretInitiatorDeviceId===y.deviceId))return null;const x=l.secretPeerDeviceId;return x?this.createInitiatorSession(l,y.deviceId,x,m):null}processHandshakes(l,h){if(!l.isSecret||!h||h.length===0)return!1;const y=wr();if(!y)return!1;let m=!1;for(const S of h){const R=(S?.metadata??{}).e2ee;if(!R||R.kind!=="handshake")continue;const Q=R.payload;if(!Q||Q.recipientDeviceId!==y.deviceId)continue;const D=this.sessions[l.id];if(D&&D.peerDeviceId===Q.initiatorDeviceId&&D.prekeyId===Q.prekeyId)continue;this.handlePeerHandshake(l,Q)&&(m=!0)}return m&&this.bumpVersion(),m}transformMessage(l,h){if(!h)return h;const y=h.metadata??{},m=y.e2ee;if(!m||m.kind!=="ciphertext")return h;const S=this.sessions[l];if(!S)return{...h,content:"🔐 Зашифровано",metadata:{...y,e2ee:{...m,decrypted:!1}}};try{const x=Ot(S.key),R=Ot(m.nonce),Q=Ot(h.content||""),D=gn.secretbox.open(Q,R,x);if(!D)throw new Error("Failed to decrypt");return{...h,content:xl(D),metadata:{...y,e2ee:{...m,decrypted:!0}}}}catch(x){return console.warn("Failed to decrypt message",x),{...h,content:"🔐 Ошибка расшифровки",metadata:{...y,e2ee:{...m,decrypted:!1,error:!0}}}}}async encryptPayload(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Ot(y.key),S=gn.randomBytes(24),x=La(h.content??""),R=gn.secretbox(x,S,m);return{conversationId:l.id,type:h.type,content:vr(R),replyToId:h.replyToId,metadata:{...h.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:vr(S)}}}}async encryptBinary(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Ot(y.key),S=gn.randomBytes(24);return{cipher:gn.secretbox(h,S,m),nonce:vr(S)}}decryptBinary(l,h,y){const m=this.sessions[l];if(!m)throw new Error("E2EE session is not ready");const S=Ot(m.key),x=Ot(y);return gn.secretbox.open(h,x,S)}async createInitiatorSession(l,h,y,m){try{const S=await oe.post("/devices/prekeys/claim",{deviceId:y}),x=S.data?.identityKey,R=S.data?.prekey;if(!x||!R?.publicKey||!R?.keyId)throw new Error("Invalid prekey response");const Q=gn.scalarMult(Ot(m.secretKey),Ot(R.publicKey)),D=gn.randomBytes(32),$=`eblusha:e2ee:${l.id}:${h}->${y}:${R.keyId}`,H=this.deriveKey(Q,D,$),J={conversationId:l.id,key:vr(H),localDeviceId:h,peerDeviceId:y,role:"initiator",prekeyId:R.keyId,hkdfInfo:$,handshakeSalt:vr(D),createdAt:Date.now()};return this.sessions[l.id]=J,this.persist(),await this.sendHandshakeMessage(l.id,{version:1,kind:"handshake",conversationId:l.id,initiatorDeviceId:h,recipientDeviceId:y,prekeyId:R.keyId,handshakeSalt:J.handshakeSalt,hkdfInfo:$,initiatorIdentityKey:m.publicKey,createdAt:Date.now()}),J}catch(S){return console.error("Failed to initialize E2EE session",S),delete this.sessions[l.id],this.persist(),null}}handlePeerHandshake(l,h){if(!h?.prekeyId||!h?.initiatorIdentityKey||!h.hkdfInfo||!h.handshakeSalt||!ga())return!1;const m=wr();if(!m)return!1;const S=Ao(h.prekeyId);if(!S)return console.warn("Missing prekey secret for handshake",h.prekeyId),!1;try{const x=gn.scalarMult(Ot(S),Ot(h.initiatorIdentityKey)),R=this.deriveKey(x,Ot(h.handshakeSalt),h.hkdfInfo),Q={conversationId:l.id,key:vr(R),localDeviceId:m.deviceId,peerDeviceId:h.initiatorDeviceId,role:"peer",prekeyId:h.prekeyId,hkdfInfo:h.hkdfInfo,handshakeSalt:h.handshakeSalt,createdAt:Date.now()};return this.sessions[l.id]=Q,this.persist(),!0}catch(x){return console.error("Failed to handle handshake payload",x),!1}}async sendHandshakeMessage(l,h){await oe.post("/conversations/send",{conversationId:l,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:h}}})}deriveKey(l,h,y){return ol(gl,l,h,La(y),32)}clearSession(l){this.sessions[l]&&(delete this.sessions[l],this.persist())}load(){try{const l=localStorage.getItem(za);l&&(this.sessions=JSON.parse(l))}catch{this.sessions={}}}persist(){try{localStorage.setItem(za,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const on=new vl;class bl{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(l={}){this.callbacks=l}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const l={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,l),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const h=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,h.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(h){console.error("Failed to setup audio analysis:",h)}this.mediaRecorder.ondataavailable=h=>{h.data.size>0&&this.audioChunks.push(h.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(h=>h.stop())},this.mediaRecorder.onerror=h=>{const y=new Error("MediaRecorder error");this.callbacks.onError?.(y)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(l){const h=l instanceof Error?l:new Error("Failed to start recording");throw this.callbacks.onError?.(h),h}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(l=>l.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let l=0;const h=50,y=m=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}if(typeof m=="number"){if(m-l<h){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}l=m}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(fe){console.warn("Analyser error:",fe);return}let S=0,x=0;for(let fe=0;fe<this.dataArray.length;fe++){const T=Math.abs(this.dataArray[fe]-128);S=Math.max(S,T),x+=T}const R=x/this.dataArray.length,D=(S*.7+R*.3)/128*100,$=Math.min(100,D*2.5),J=Math.max(15,$);this.callbacks.onAmplitudeUpdate?.(J),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y))};this.amplitudeTimer=window.requestAnimationFrame(y)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const l=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const h of l)if(MediaRecorder.isTypeSupported(h))return h;return""}cleanup(){this.cancel()}}async function wl(s,l=60){try{const y=await(await fetch(s)).arrayBuffer(),m=new(window.AudioContext||window.webkitAudioContext),x=(await m.decodeAudioData(y)).getChannelData(0),R=Math.floor(x.length/l),Q=[];for(let D=0;D<l;D++){let $=0,H=0;const J=D*R,fe=Math.min(J+R,x.length);for(let pe=J;pe<fe;pe++){const Se=Math.abs(x[pe]);$+=Se,H=Math.max(H,Se)}const T=$/(fe-J),Y=Math.max(T,H*.7),P=Math.max(20,Math.min(100,Y*200));Q.push(P)}return m.close(),Q}catch(h){return console.error("Failed to generate waveform:",h),Array(l).fill(0).map(()=>Math.random()*40+30)}}const ws=new Map;async function jl(s,l=60){const h=`${s}:${l}`;if(ws.has(h))return ws.get(h);const y=await wl(s,l);return ws.set(h,y),y}const Cl=a.lazy(()=>Wa(()=>import("./CallOverlay-CPJ0uwCi.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(s=>({default:s.CallOverlay}))),Sl=()=>Wa(()=>import("./CallOverlay-CPJ0uwCi.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),Pa="eblusha:last-active-conversation",kl=3e4,Il=10;function Rl({url:s,duration:l}){const[h,y]=a.useState(!1),[m,S]=a.useState(0),[x,R]=a.useState([]),[Q,D]=a.useState(!0),$=a.useRef(null),H=Ni(s)||s;a.useEffect(()=>{let Y=!1;return D(!0),jl(H,60).then(P=>{Y||(R(P),D(!1))}).catch(P=>{console.error("Failed to load waveform:",P),Y||D(!1)}),()=>{Y=!0}},[H]),a.useEffect(()=>{const Y=$.current;if(!Y)return;const P=()=>S(Y.currentTime),pe=()=>{y(!1),S(0)},Se=()=>y(!0),at=()=>y(!1);return Y.addEventListener("timeupdate",P),Y.addEventListener("ended",pe),Y.addEventListener("play",Se),Y.addEventListener("pause",at),()=>{Y.removeEventListener("timeupdate",P),Y.removeEventListener("ended",pe),Y.removeEventListener("play",Se),Y.removeEventListener("pause",at)}},[]);const J=()=>{const Y=$.current;Y&&(h?Y.pause():Y.play().catch(P=>{console.error("Failed to play audio:",P)}))},fe=Y=>{const P=Math.floor(Y/60),pe=Math.floor(Y%60);return`${P}:${pe.toString().padStart(2,"0")}`},T=x.length>0?Math.floor(m/l*x.length):0;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[e.jsx("audio",{ref:$,src:H,preload:"metadata"}),e.jsx("button",{type:"button",onClick:J,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":h?"Пауза":"Воспроизвести",children:h?e.jsx(Oc,{size:16,fill:"currentColor"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[Q?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map((Y,P)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${P*.1}s`}},P))}):x.length>0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:x.map((Y,P)=>{const pe=P<=T,Se=Math.max(4,Y/100*20);return e.jsx("div",{style:{width:2,height:`${Se}px`,background:pe?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},P)})}):e.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Загрузка..."}),e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[fe(m)," / ",fe(l)]})})]})]})}function Ml(){const[s,l]=a.useState(null),[h,y]=a.useState(null),[m,S]=a.useState(null),[x,R]=a.useState(null),Q=a.useRef(null);a.useEffect(()=>{Q.current=x},[x]);const D=a.useRef(null),[$,H]=a.useState(""),[J,fe]=a.useState(null),T=a.useRef(null),Y=a.useRef(null),P=a.useRef(null),pe=a.useRef(null),Se=a.useRef(null),at=a.useRef(!1),ge=a.useRef(null),me=a.useRef(null),re=a.useRef(!1),We=a.useRef(null),Ae=a.useRef(null),[Te,Fe]=a.useState(!1),[Ln,Ce]=a.useState(1),[Ve,Rt]=a.useState(!1),ot=a.useRef(null);a.useRef({pinTimer:null});const[Me,Z]=a.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Ee,Ft]=a.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Vt=a.useRef(null),[wt,L]=a.useState(()=>({open:!1,anchor:null})),_=a.useRef(null),ce=a.useRef(null),[xe,He]=a.useState(!1),[Oe,Be]=a.useState(()=>({open:!1,x:0,y:0,messageId:null})),[ct,gt]=a.useState({open:!1,messageId:null}),[mt,zn]=a.useState(!1),[Pn,Zn]=a.useState([]),[jr,mn]=a.useState(!1),[cn,g]=a.useState("friends"),[z,E]=a.useState(["","","",""]),V=[a.useRef(null),a.useRef(null),a.useRef(null),a.useRef(null)],[I,G]=a.useState(null),[te,B]=a.useState(null),[De,Ne]=a.useState(!1),ke=a.useRef(0),[Le,nt]=a.useState(!1),[Xt,Kt]=a.useState(!1),[M,jt]=a.useState(!1),yt=a.useRef(M),[Ge,we]=a.useState("list");a.useEffect(()=>{yt.current=M},[M]);const[Un,Mt]=a.useState(!1),zt=a.useRef(null);a.useRef(null);const Ct=a.useRef(new Map),ve=a.useRef(!0),lt=a.useRef(!1),Et=a.useRef(0),yn=a.useRef(null),xt=a.useRef(new Set),dt=a.useRef(null);a.useRef(null);const ut=a.useRef(null),qe=a.useRef(0),[ze,At]=a.useState(!1),[vt,er]=a.useState(""),[Qt,Wn]=a.useState([]),[Cr,Sr]=a.useState(!1),[Xr,tr]=a.useState(null),[ln,St]=a.useState(null),[je,Yt]=a.useState(null),[kr,xn]=a.useState(null),[Hn,vn]=a.useState(!1),Pi=a.useRef(null),Bn=a.useRef(null),_a=a.useRef(null),Ui=a.useRef(null),[Ke,Jt]=a.useState({x:0,y:0,scale:1}),[ks,Wi]=a.useState(!1),[Oa,Yr]=a.useState(!1),[Hi,Fa]=a.useState(["","","",""]),Bi=[a.useRef(null),a.useRef(null),a.useRef(null),a.useRef(null)],[bn,$i]=a.useState(null),[Xa,_i]=a.useState(!1),[Oi,Ya]=a.useState(""),[Ga,Gr]=a.useState(!1),[nr,qr]=a.useState(!1),[Fi,Vr]=a.useState(null),[Pt,Kr]=a.useState(null),Qr=a.useRef(null),[Ie,wn]=a.useState({x:0,y:0,scale:1}),[Is,Jr]=a.useState(0),$n=a.useRef(null),Xi=a.useRef(null),Rs=a.useRef(null),ht=a.useRef(null),_n=a.useRef(null),jn=a.useRef(null),Zr=a.useRef(null),ft=a.useRef(null),On=a.useRef(null),ei=a.useRef(null),Ms=a.useRef(null),[Re,Zt]=a.useState({x:0,y:0,scale:1}),[Ut,ti]=a.useState(null),[ni,ri]=a.useState(null),[Es,Yi]=a.useState(!1),[As,Gi]=a.useState(!1),[ii,rr]=a.useState(null),[Ir,ir]=a.useState({open:!1,index:0,items:[]}),[qa,si]=a.useState(!1),[Va,sr]=a.useState(0),[El,qi]=a.useState(!1),[ar,Rr]=a.useState(null),[Ts,Mr]=a.useState({}),[Fn,ai]=a.useState({}),Er=a.useRef(new Set),or=a.useRef(new Set),[dn,Ar]=a.useState([]),[oi,en]=a.useState(null),[ci,Ds]=a.useState(0),un=a.useRef(null),[Ns,Vi]=a.useState(!1),[Ls,Ki]=a.useState(0),[Tr,Qi]=a.useState([]),cr=a.useRef(null),Dr=a.useRef(null),[zs,Ps]=a.useState(150);a.useEffect(()=>{if(M){Ps(60);return}const t=()=>{if(!Dr.current)return;const r=Dr.current.clientWidth,c=Math.floor(r/4);Ps(Math.max(100,c))};t();const n=new ResizeObserver(t);return Dr.current&&n.observe(Dr.current),()=>{n.disconnect()}},[M]),a.useEffect(()=>{Sl().catch(()=>{})},[]);const Us=a.useRef(null);a.useEffect(()=>{Us.current=s},[s]);const li=a.useRef([]);a.useEffect(()=>{li.current=dn},[dn]);const Xn=a.useCallback(t=>{if(t)try{URL.revokeObjectURL(t)}catch{}},[]),Ji=a.useCallback(()=>{en(null),Ar(t=>t.length?(t.forEach(n=>Xn(n.previewUrl)),[]):t)},[Xn,en]),Nr=a.useCallback((t,n)=>{!t||!t.type.startsWith("image/")||Ar(r=>{if(r.length>=Il)return alert("Можно редактировать не более 10 изображений за раз."),r;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,c=URL.createObjectURL(t),o={id:i,file:t,previewUrl:c,edited:!1,fileName:t.name||"image.png",source:n};return[...r,o]})},[]),Ka=a.useCallback(t=>{Ar(n=>{const r=n.find(i=>i.id===t);return r&&Xn(r.previewUrl),n.filter(i=>i.id!==t)}),en(n=>n===t?null:n)},[Xn,en]),Qa=a.useCallback((t,n,r)=>{Ar(i=>i.map(c=>c.id!==t?c:(Xn(c.previewUrl),{...c,file:n,previewUrl:r,edited:!0,fileName:n.name||c.fileName})))},[Xn]),Ws=yr({queryKey:["my-devices"],queryFn:async()=>(await oe.get("/devices")).data.devices}),[Al,Hs]=a.useState(null),[Ja,di]=a.useState(()=>_e.connected),[Za,Bs]=a.useState(null),[$s,eo]=a.useState({}),[_s,ui]=a.useState({}),[Os,hi]=a.useState({}),[Fs,Xs]=a.useState({}),[to,Lr]=a.useState(!1),[Ys,zr]=a.useState({}),[Gs,qs]=a.useState(!1),[Zi,fi]=a.useState(!1),Vs=a.useRef(null),N=Jn(t=>t.session?.user),Pr=a.useRef(null);if(Pr.current===null&&typeof window<"u")try{const t=localStorage.getItem("eb_user");if(t){const n=JSON.parse(t);n&&typeof n.id=="string"&&(Pr.current=n.id)}}catch{Pr.current=null}a.useEffect(()=>{N?.id&&(Pr.current=N.id)},[N?.id]);const Tt=N?.id??Pr.current??null,q=_r(),X=tc(),pi=a.useMemo(()=>s?Ts[s]||[]:[],[s,Ts]),gi=a.useMemo(()=>oi?dn.find(t=>t.id===oi)??null:null,[dn,oi]);a.useRef(null),a.useRef(null);const[Cn,kt]=a.useState({}),[Tl,no]=a.useState(0),Yn=a.useRef(null);a.useEffect(()=>{Yn.current=h},[h]);const ro=a.useRef({}),es=a.useRef({}),lr=a.useRef({});a.useEffect(()=>()=>{typeof window>"u"||(Object.values(lr.current).forEach(t=>{typeof t=="number"&&window.clearTimeout(t)}),D.current&&window.clearTimeout(D.current),qn())},[]),a.useEffect(()=>{if(!x)return;const t=setInterval(()=>{R(n=>n?{...n}:null)},1e3);return()=>clearInterval(t)},[x]);const mi=a.useCallback(t=>{if(!t)return null;const n=X.getQueryData(["conversations"]);return Array.isArray(n)?n.find(i=>i?.conversation?.id===t)?.conversation??null:null},[X]),dr=a.useCallback(t=>{const n=mi(t);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[mi]),Sn=a.useCallback(t=>{if(!t)return;const n=lr.current[t];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete lr.current[t]),delete es.current[t]},[]),yi=a.useCallback(t=>{t&&dr(t)&&(es.current[t]=Date.now()+kl)},[dr]),ts=a.useCallback((t,n,r)=>{if(!t){n();return}if(r?.force){Sn(t),n();return}const i=es.current[t];if(!i){n();return}const c=Date.now();if(c>=i){Sn(t),n();return}const o=i-c,d=lr.current[t];if(typeof d=="number"&&typeof window<"u"&&window.clearTimeout(d),typeof window>"u"){n();return}lr.current[t]=window.setTimeout(()=>{delete lr.current[t],Sn(t),n()},o)},[Sn]),ns=a.useCallback((t,n)=>{const r=t?"камере и микрофону":"микрофону",i=typeof n=="object"&&n&&"name"in n?String(n.name):"";return i==="NotAllowedError"||i==="SecurityError"?`Браузер запретил доступ к ${r}. Разрешите его в адресной строке и попробуйте снова.`:i==="NotFoundError"?t?"Браузер не нашёл камеру или микрофон. Подключите устройство и попробуйте ещё раз.":"Браузер не нашёл микрофон. Подключите устройство и попробуйте ещё раз.":i==="NotReadableError"||i==="TrackStartError"?"Камера или микрофон уже используются другим приложением или вкладкой.":`Не удалось получить доступ к ${r}. Проверьте настройки браузера и попробуйте снова.`},[]),xi=a.useCallback(async t=>{try{const n=await Da({audio:!0,video:t});return n.ok?(Rr(null),!0):(Rr(ns(t,n.error)),!1)}catch(n){return Rr(ns(t,n)),!1}},[ns]),vi=a.useCallback(async t=>{const n=q.incoming;if(!n||!await xi(t))return;const r=n.conversationId;yi(r),To(r,t),q.startOutgoing(r,t),kt(i=>{const c=i[r],o=N?.id;return c?.active?o&&c.participants&&!c.participants.includes(o)?{...i,[r]:{...c,participants:[...c.participants,o]}}:i:{...i,[r]:{startedAt:Date.now(),active:!0,participants:o?[o]:[]}}}),y(r),S(i=>i===r?null:i),q.setIncoming(null),Bt()},[yi,q,N?.id,xi]),rs=a.useCallback(()=>{const t=q.incoming;t&&(ma(t.conversationId),q.setIncoming(null),Bt())},[q]);a.useEffect(()=>{if(typeof window>"u")return;const t={accept:async(n,r)=>q.incoming?.conversationId!==n?!1:(await vi(r),!0),decline:n=>q.incoming?.conversationId!==n?!1:(rs(),!0)};return window.__nativeCallOverlayBridge=t,()=>{window.__nativeCallOverlayBridge===t&&delete window.__nativeCallOverlayBridge}},[q.incoming?.conversationId,vi,rs]),a.useEffect(()=>{const t=window.setInterval(()=>no(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(t)},[]),a.useEffect(()=>{if(!ar||typeof window>"u")return;const t=window.setTimeout(()=>Rr(null),9e3);return()=>window.clearTimeout(t)},[ar]),a.useEffect(()=>{const t=()=>{const n=window.innerWidth<=768;jt(n),yt.current=n,n?s||we("list"):we("conversation")};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]),a.useEffect(()=>{M&&we(s?"conversation":"list")},[M,s]),a.useEffect(()=>{const t=(()=>{try{const c=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(c==="1"||c==="true")return!0;const o=window.localStorage.getItem("lk-debug-callstatus");return o==="1"||o==="true"}catch{return!1}})(),n=i=>{t&&console.log("[CallStatus] Single:",i),kt(c=>{const o=X.getQueryData(["conversations"]),d=Array.isArray(o)?o.find(w=>w.conversation.id===i.conversationId)?.conversation:null,f=c[i.conversationId],u=_r.getState().activeConvId;if(!(!!(d&&(d.isGroup||(d.participants?.length??0)>2))||!!f&&(f.participants?f.participants.length>1:!0)||u===i.conversationId))return c;const j=i.participants||[];if(i.active){const w=typeof i.startedAt=="number"&&i.startedAt>0?i.startedAt:f?.startedAt??Date.now();return{...c,[i.conversationId]:{active:!0,startedAt:w,participants:j,endedAt:null,elapsedMs:typeof i.elapsedMs=="number"?i.elapsedMs:void 0}}}const b=f?.active?Date.now():f?.endedAt??null;return{...c,[i.conversationId]:{active:!1,startedAt:f?.startedAt??null,endedAt:b,participants:[],elapsedMs:void 0}}})},r=i=>{t&&console.log("[CallStatus] Bulk:",i),kt(c=>{const o={...c},d=X.getQueryData(["conversations"]);for(const[f,u]of Object.entries(i.statuses||{})){const p=Array.isArray(d)?d.find(A=>A.conversation.id===f)?.conversation:null,j=c[f],b=_r.getState().activeConvId;if(!(!!(p&&(p.isGroup||(p.participants?.length??0)>2))||!!j&&(j.participants?j.participants.length>1:!0)||b===f))continue;const C=u.participants||[];if(u.active){const A=typeof u.startedAt=="number"&&u.startedAt>0?u.startedAt:j?.startedAt??Date.now();o[f]={active:!0,startedAt:A,participants:C,endedAt:null,elapsedMs:typeof u.elapsedMs=="number"?u.elapsedMs:void 0};continue}const v=j?.active?Date.now():j?.endedAt??null;o[f]={active:!1,startedAt:j?.startedAt??null,endedAt:v,participants:[],elapsedMs:void 0}}return o})};return Do(n),No(r),()=>{_e.off("call:status",n),_e.off("call:status:bulk",r)}},[]),a.useEffect(()=>{if(!Me.open)return;const t=Vs.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=Me.x,o=Me.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),o+i.height>r-8&&(o=Math.max(8,r-i.height-8)),(c!==Me.x||o!==Me.y)&&Z(d=>({...d,x:c,y:o}))},[Me.open,Me.x,Me.y]),a.useEffect(()=>{if(!Ee.open)return;const t=Vt.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=Ee.x,o=Ee.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),o+i.height>r-8&&(o=Math.max(8,r-i.height-8)),(c!==Ee.x||o!==Ee.y)&&Ft(d=>({...d,x:c,y:o}))},[Ee.open,Ee.x,Ee.y]),a.useEffect(()=>{if(!wt.open||!wt.anchor)return;const t=_.current;if(!t)return;const n=wt.anchor.getBoundingClientRect(),r=window.innerWidth,i=window.visualViewport?window.visualViewport.height:window.innerHeight;t.style.display="flex";const c=t.getBoundingClientRect();let o=n.right-c.width,d=n.bottom+8;o<8&&(o=8),o+c.width>r-8&&(o=r-c.width-8),d+c.height>i-8&&(d=n.top-c.height-8),d<8&&(d=8),t.style.left=`${o}px`,t.style.top=`${d}px`},[wt.open,wt.anchor]),a.useEffect(()=>{s||L({open:!1,anchor:null})},[s]);function ur(t){l(n=>{try{n&&n!==t&&(ie.data||[]).find(c=>c.conversation.id===n)?.conversation?.isSecret&&X.removeQueries({queryKey:["messages",n]})}catch{}return t}),M&&we("conversation"),li.current.length&&Ji()}async function Ks(){let t=wr();return t||(t=await Jo()),t||null}async function Qs(t){if(Gs)return;qs(!0);const n=2;let r=0;const i=async()=>{if(r>=n)throw new Error("Не удалось подготовить устройство для секретного чата. Попробуйте позже.");r+=1,await Qo()};try{for(;;){const c=await Ks();if(!c){alert("Не удалось инициализировать устройство для секретного чата");return}try{const o={participantIds:[t],isGroup:!1,isSecret:!0,initiatorDeviceId:c.deviceId};console.log("[SecretChat] Creating with payload:",o),await oe.post("/conversations",o),X.invalidateQueries({queryKey:["conversations"]});return}catch(o){console.error("[SecretChat] Creation error:",o?.response?.data||o);const d=o?.response?.data?.message,f=o?.response?.data?.errors;if(f&&console.error("[SecretChat] Validation errors:",f),o?.response?.status===400&&typeof d=="string"&&d.toLowerCase().includes("invalid initiator device")){await i();continue}const p=f?`Ошибка валидации: ${f.map(j=>`${j.path.join(".")}: ${j.message}`).join(", ")}`:d||"Не удалось отправить запрос на секретный чат";throw new Error(p)}}}catch(c){console.error("Failed to start secret conversation:",c);const o=c?.message||c?.response?.data?.message||"Не удалось отправить запрос на секретный чат";alert(o)}finally{qs(!1)}}const Js=async t=>{fi(!0);try{Zo(t),zr(n=>{const r={...n};return delete r[t],r}),X.invalidateQueries({queryKey:["conversations"]})}finally{fi(!1)}},io=async t=>{fi(!0);try{const n=await Ks();if(!n){alert("Не удалось инициализировать устройство для секретного чата");return}ec(t,n.deviceId),X.invalidateQueries({queryKey:["conversations"]}),ur(t)}catch(n){console.error("Failed to accept secret chat:",n),alert("Не удалось принять секретный чат")}finally{fi(!1)}};async function Zs(t,n){if(!t)return;const r={...n,content:n.content??void 0};if(t.isSecret){const i=await on.encryptPayload(t,r);await oe.post("/conversations/send",i);return}await oe.post("/conversations/send",{conversationId:t.id,...r})}const hr=()=>{zn(!1),Zn([]),mn(!1),g("friends"),E(["","","",""]),G(null),B(null),Ne(!1)},so=async()=>{if(!s||Pn.length===0){hr();return}mn(!0);try{await oe.post(`/conversations/${s}/participants`,{participantIds:Pn}),X.invalidateQueries({queryKey:["conversations"]}),ie.refetch(),hr()}catch(t){console.error("Error adding participants:",t),alert(t.response?.data?.message||"Не удалось добавить участников")}finally{mn(!1)}},ao=async()=>{if(!(!s||!I)){mn(!0);try{await oe.post(`/conversations/${s}/participants`,{participantIds:[I.id]}),X.invalidateQueries({queryKey:["conversations"]}),ie.refetch(),hr()}catch(t){console.error("Error adding participant by EBLID:",t),alert(t.response?.data?.message||"Не удалось добавить участника")}finally{mn(!1)}}},oo=(t,n)=>{if(!/^\d?$/.test(n))return;const r=[...z];r[t]=n,E(r),n&&t<3&&V[t+1].current?.focus(),!n&&t>0&&V[t-1].current?.focus();const i=r.join("");if(i.length===4&&/^\d{4}$/.test(i)){const c=Date.now();ke.current=c,Ne(!0),B(null),oe.get("/contacts/search",{params:{query:i}}).then(o=>{if(ke.current!==c)return;const d=o.data.results?.[0]??null;G(d),B(d?null:"Пользователь не найден")}).catch(()=>{ke.current===c&&(G(null),B("Не удалось выполнить поиск"))}).finally(()=>{ke.current===c&&Ne(!1)})}else G(null),B(null),Ne(!1)};function co(){if(M){if(s)try{(ie.data||[]).find(r=>r.conversation.id===s)?.conversation?.isSecret&&X.removeQueries({queryKey:["messages",s]})}catch{}we("list"),l(null),Mt(!1)}li.current.length&&Ji()}const Gt=yr({queryKey:["me-info"],queryFn:async()=>(await oe.get("/status/me")).data.user}),ie=yr({queryKey:["conversations"],queryFn:async()=>(await oe.get("/conversations")).data.conversations}),$e=yr({queryKey:["messages",s],enabled:!!s,queryFn:async()=>(await oe.get(`/conversations/${s}/messages`)).data.messages,refetchInterval:s?15e3:!1});a.useEffect(()=>{$e.error?.response?.status===403&&s&&(console.warn("[ChatsPage] Lost access to conversation, closing view",s),X.removeQueries({queryKey:["messages",s]}),l(null))},[$e.error,s,X]);const bt=yr({queryKey:["accepted-contacts"],queryFn:async()=>(await oe.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),Wt=yr({queryKey:["incoming-contacts"],queryFn:async()=>(await oe.get("/contacts",{params:{filter:"incoming"}})).data.contacts});a.useEffect(()=>{if(s&&!(typeof window>"u"))try{window.localStorage.setItem(Pa,s)}catch{}},[s]),a.useEffect(()=>{if(typeof window>"u"||s)return;const t=ie.data;if(!(!t||t.length===0)&&!(yt.current&&Ge!=="conversation"))try{const n=window.localStorage.getItem(Pa);if(!n)return;t.some(i=>i?.conversation?.id===n)&&ur(n)}catch{}},[s,ie.data,Ge]);const is=()=>{if(At(!1),er(""),Wn([]),Sr(!1),ln)try{URL.revokeObjectURL(ln)}catch{}if(St(null),je)try{URL.revokeObjectURL(je)}catch{}Yt(null),tr(null),xn(null),Jt({x:0,y:0,scale:1}),vn(!1)};a.useEffect(()=>{const t=ce.current;if(!t)return;const n=()=>{const{scrollTop:r,scrollHeight:i,clientHeight:c}=t,o=r>2,d=i-r-c>2;nt(o),Kt(d)};return n(),t.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{t.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[ie.data?.length]),a.useEffect(()=>{try{const t=(ie.data||[]).map(n=>n.conversation.id);try{const r=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(r==="1"||r==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",t)}catch{}t.length>0&&ya(t);for(const n of t)try{xa(n)}catch{}}catch{}},[ie.data]);const k=a.useMemo(()=>ie.data?.find(t=>t.conversation.id===s)?.conversation,[ie.data,s]);a.useEffect(()=>()=>{Er.current.forEach(t=>URL.revokeObjectURL(t)),Er.current.clear(),or.current.clear()},[]),a.useEffect(()=>{Er.current.forEach(t=>URL.revokeObjectURL(t)),Er.current.clear(),or.current.clear(),ai({})},[k?.id]);const Ur=a.useMemo(()=>wr()?.deviceId??null,[ci]),bi=a.useMemo(()=>{const t={};for(const n of Ws.data||[])t[n.id]=n;return t},[Ws.data]),wi=a.useCallback(t=>{if(!t?.isSecret)return null;const n=[t.secretInitiatorDeviceId,t.secretPeerDeviceId];for(const r of n){if(!r)continue;const i=bi[r];if(i?.userId&&N?.id&&i.userId===N.id)return r}if(N?.id){if(t.createdById===N.id&&t.secretInitiatorDeviceId)return t.secretInitiatorDeviceId;if(t.createdById!==N.id&&t.secretPeerDeviceId)return t.secretPeerDeviceId}return null},[bi,N?.id]),fr=a.useMemo(()=>wi(k),[k,wi]),ea=a.useMemo(()=>{if(!fr)return;const t=bi[fr]?.name;if(t&&t.trim())return t;const n=wr();if(n&&n.deviceId===fr&&n.name)return n.name},[fr,bi,ci]),ta=a.useCallback(t=>{if(!t)return!1;const n=(ie.data||[]).find(i=>i?.conversation?.id===t)?.conversation;if(!n?.isSecret)return!1;const r=wi(n);return!!(r&&Ur&&r!==Ur)},[ie.data,Ur,wi]),ji=!!(k?.isSecret&&(k.secretStatus??"ACTIVE")!=="ACTIVE"),pr=a.useMemo(()=>k?.isSecret?on.hasSession(k.id):!0,[k?.id,k?.isSecret,ci]),lo=!!(k?.isSecret&&!ji&&!pr&&fr&&Ur&&fr!==Ur);a.useEffect(()=>{if(!k?.isSecret||k.secretStatus!=="ACTIVE")return;let t=!1;return on.ensureSession(k).then(n=>{!t&&n&&Ds(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{t=!0}},[k?.id,k?.secretStatus,k?.isSecret]),a.useEffect(()=>{if(!k?.isSecret||!$e.data||$e.data.length===0)return;on.processHandshakes(k,$e.data)&&Ds(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[$e.data,k?.id,k?.isSecret,k?.secretStatus]);const Ht=a.useMemo(()=>$e.data?k?.isSecret?$e.data.filter(t=>{const r=(t?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(t=>on.transformMessage(k.id,t)):$e.data:[],[$e.data,k?.id,k?.isSecret,ci]),na=a.useCallback(t=>{if(!k?.id)return;const n=t?.metadata?.e2ee;!n||n.kind!=="ciphertext"||!n.nonce||!on.hasSession(k.id)||or.current.has(t.url)||Fn[t.url]?.status==="ready"||(or.current.add(t.url),ai(i=>({...i,[t.url]:{status:"pending"}})),(async()=>{try{const i=Ni(t.url)||t.url,c=await fetch(i,{credentials:"omit"});if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const o=new Uint8Array(await c.arrayBuffer()),d=on.decryptBinary(k.id,o,n.nonce);if(!d)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const f=new Blob([d],{type:n.originalType||t.metadata?.mime||t.metadata?.contentType||"application/octet-stream"}),u=URL.createObjectURL(f);Er.current.add(u),or.current.delete(t.url),ai(p=>({...p,[t.url]:{status:"ready",url:u}}))}catch(i){or.current.delete(t.url),ai(c=>{const o={...c};return i?.message?.includes("E2EE session is not ready")?delete o[t.url]:o[t.url]={status:"error"},o})}})())},[k?.id,Fn]),Ci=a.useCallback(t=>{if(!t)return null;const n=Ni(t.url);if(!k?.isSecret)return n;const r=t.metadata?.e2ee;if(!r||r.kind!=="ciphertext")return n;const i=Fn[t.url];return i?.status==="ready"&&i.url?i.url:null},[Fn,k?.isSecret]);a.useEffect(()=>{if(!k?.isSecret||!pr)return;(Ht||[]).flatMap(n=>n.attachments||[]).forEach(n=>{n?.metadata?.e2ee?.kind==="ciphertext"&&na(n)})},[Ht,k?.id,k?.isSecret,pr,na]),a.useEffect(()=>{const t=new Set((ie.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));zr(n=>{let r=!1;const i={...n};for(const c of Object.keys(i))t.has(c)||(delete i[c],r=!0);return r?i:n})},[ie.data]);const gr=a.useMemo(()=>{if(!k||k.isGroup||k.isSecret||!N?.id)return null;const t=Ua(k.participants||[]);if(!t)return null;const n=ie.data||[];for(const r of n){const i=r.conversation;if(!i?.isSecret||(i.secretStatus??"ACTIVE")!=="PENDING"||Ua(i.participants||[])!==t)continue;const o=(i.participants||[]).find(f=>f.user.id===i.createdById)?.user,d=Ys[i.id]?.from?.name??o?.displayName??o?.username??"Собеседник";return{conversationId:i.id,isInitiator:i.createdById===N.id,initiatorName:d}}return null},[k,ie.data,N?.id,Ys]),ra=a.useMemo(()=>{const t={};if(k)for(const n of k.participants)t[n.user.id]=n.user;return N&&!t[N.id]&&(t[N.id]=N),t},[k,N]),ss=a.useMemo(()=>k?(k.participants||[]).map(t=>t.user.id):[],[k]),ia=a.useMemo(()=>{if(!k||!bt.data)return[];const t=new Set(ss);return bt.data.filter(n=>!t.has(n.friend.id))},[k,bt.data,ss]),Si={alreadyInChat:I?ss.includes(I.id):!1,isSelf:I?I.id===N?.id:!1};a.useEffect(()=>{mt&&cn==="eblid"&&V[0].current?.focus()},[mt,cn]),a.useEffect(()=>{const t=n=>{eo(r=>{const i=(n.status||"").toString().toUpperCase();return r[n.userId]===i?r:{...r,[n.userId]:i}}),X.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(o=>o.user.id===n.userId?{...o,user:{...o.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="IN_CALL"||n.status==="OFFLINE"?new Date().toISOString():o.user.lastSeenAt}}:o)}})))};return va(t),()=>{_e.off("presence:update",t)}},[X]);const Gn=a.useCallback(t=>{const n=t?.id,r=typeof n=="string"?n:null,c=((r?$s[r]:void 0)??t?.status??"OFFLINE").toString().toUpperCase();return c==="IN_CALL"?"IN_CALL":c==="ONLINE"?"ONLINE":c==="BACKGROUND"?"BACKGROUND":c==="AWAY"?"AWAY":"OFFLINE"},[$s]),ki=a.useRef(_e.connected);a.useEffect(()=>{const t=()=>{try{const c=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",c+"px")}catch{}X.invalidateQueries({queryKey:["me-info"]}),di(_e.connected)};window.addEventListener("focus",t);const n=()=>{di(!0);const c=ki.current;if(ki.current=!0,c)try{const o=(ie.data||[]).map(d=>d.conversation.id);for(const d of o)try{xa(d)}catch{}o.length>0&&ya(o)}catch{}},r=()=>{di(!1),ki.current=!1};_e.on("connect",n),_e.on("disconnect",r),di(_e.connected),_e.connected&&(ki.current=!0);const i=()=>{X.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",i),()=>{_e.off("connect",n),_e.off("disconnect",r),document.removeEventListener("visibilitychange",i),window.removeEventListener("focus",t)}},[X]),a.useEffect(()=>{const t=n=>{if(N?.id&&n.userId===N.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="IN_CALL"||r==="OFFLINE")&&Bs(r)}};return va(t),()=>{_e.off("presence:update",t)}},[N?.id]),a.useEffect(()=>{const t=(Gt.data?.status||"").toString().toUpperCase();(t==="ONLINE"||t==="AWAY"||t==="BACKGROUND"||t==="IN_CALL"||t==="OFFLINE")&&Bs(t)},[Gt.data]),a.useEffect(()=>{if(!Ir.open)return;const t=n=>{n.key==="Escape"&&ir(r=>({...r,open:!1})),n.key==="ArrowLeft"&&ir(r=>({...r,index:(r.index-1+r.items.length)%r.items.length})),n.key==="ArrowRight"&&ir(r=>({...r,index:(r.index+1)%r.items.length}))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ir.open]),a.useEffect(()=>{const t=n=>{X.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(c=>c.user.id===n.userId?{...c,user:{...c.user,avatarUrl:n.avatarUrl??c.user.avatarUrl,displayName:n.displayName??c.user.displayName}}:c)}}))),n.userId===N?.id&&Gt.refetch()};return Lo(t),()=>{_e.off("profile:update",t)}},[X,N?.id]);function uo(t){return"#191d23"}a.useEffect(()=>{if(!s)return;const t=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const i=n.clipboardData?.items;if(i)for(let c=0;c<i.length;c++){const o=i[c];if(o.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const d=o.getAsFile();d&&Nr(d,"paste");break}}};return window.addEventListener("paste",t,!0),()=>{window.removeEventListener("paste",t,!0)}},[s,Nr]),a.useEffect(()=>{ie.refetch(),zo(),Po(()=>ie.refetch()),Uo(r=>{const i=r?.conversationId;if(!i){ie.refetch();return}zr(o=>{if(!o[i])return o;const d={...o};return delete d[i],d}),Mr(o=>{if(!o[i])return o;const d={...o};return delete d[i],d}),on.clearSession(i),X.removeQueries({queryKey:["messages",i]}),X.setQueryData(["conversations"],o=>Array.isArray(o)?o.filter(d=>d?.conversation?.id!==i):o),Us.current===i&&(l(o=>o===i?null:o),Mt(!1),li.current.length&&Ji(),yt.current&&we("list")),ie.refetch()}),Wo(()=>{ie.refetch()}),Ho(()=>{ie.refetch()});const t=Bo(r=>{zr(i=>({...i,[r.conversationId]:r})),ie.refetch()}),n=$o(r=>{zr(i=>{const c={...i};return delete c[r.conversationId],c}),X.invalidateQueries({queryKey:["conversations"]}),ur(r.conversationId)});_o(({conversationId:r,from:i,video:c})=>{if(!(pe.current&&pe.current===r)){Bt();try{const o=X.getQueryData(["conversations"]),d=Array.isArray(o)?o.find(p=>p.conversation.id===r)?.conversation:null,f=!!(d&&(d.isGroup||(d.participants?.length??0)>2));ro.current[r]=i.id;const u=Yn.current===r;if(f||u||i?.id&&N?.id&&i.id===N.id)return}catch{}pe.current=r,q.startIncoming({conversationId:r,from:i,video:c});try{const o=sa();o&&(o.currentTime=0,o.loop=!0,o.volume=.9,o.play().catch(()=>{}))}catch(o){console.error("Error starting ringtone:",o)}P.current=window.setTimeout(()=>{ma(r),Bt(),q.setIncoming(null)},25e3)}}),Oo(({conversationId:r,by:i,video:c})=>{if(Sn(r),R(u=>u?.conversationId===r?(D.current&&(window.clearTimeout(D.current),D.current=null),qn(),null):u),i?.id===N?.id){(q.incoming?.conversationId===r||pe.current===r)&&(Bt(),q.setIncoming(null),P.current&&(window.clearTimeout(P.current),P.current=null),pe.current=null);return}const o=Yn.current===r,d=_r.getState().activeConvId===r,f=Q.current?.conversationId===r;if(!o&&!d&&!f){(_r.getState().incoming?.conversationId===r||pe.current===r)&&(Bt(),q.setIncoming(null),P.current&&(window.clearTimeout(P.current),P.current=null),pe.current=null);return}if(kt(u=>u[r]?.active?u:{...u,[r]:{startedAt:Date.now(),active:!0,participants:[N?.id||""].filter(Boolean)}}),q.activeConvId!==r){const u=!!c;q.startOutgoing(r,u)}y(r),S(u=>u===r?null:u),Bt()}),Fo(({conversationId:r})=>{R(c=>c?.conversationId===r?(D.current&&(window.clearTimeout(D.current),D.current=null),qn(),Ii(),null):c);const i=()=>{kt(c=>{const o=c[r];if(o){if(o.active)return{...c,[r]:{...o,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}return c}),Yn.current===r&&(y(c=>c===r?null:c),S(c=>c===r?null:c),q.endCall()),q.setIncoming(null),Bt(),Sn(r)};dr(r)?ts(r,i,{force:!0}):i()}),Xo(({conversationId:r})=>{try{const c=X.getQueryData(["conversations"]),o=Array.isArray(c)?c.find(f=>f.conversation.id===r)?.conversation:null;if(!!(o&&(o.isGroup||(o.participants?.length??0)>2)))return}catch{}if(m===r)return;if(dr(r)){const c=Cn[r];if((Yn.current===r||q.activeConvId===r)&&c?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",r);return}}const i=()=>{R(c=>c?.conversationId===r?(D.current&&(window.clearTimeout(D.current),D.current=null),qn(),null):c),kt(c=>{const o=c[r];if(o?.active)return{...c,[r]:{...o,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}),Yn.current===r&&(y(c=>c===r?null:c),S(c=>c===r?null:c),q.endCall()),q.setIncoming(null),Bt(),Sn(r)};dr(r)?ts(r,i,{force:!0}):i()}),Yo(({conversationId:r})=>{X.invalidateQueries({queryKey:["messages",r]}),X.refetchQueries({queryKey:["messages",r]})});try{me.current||(me.current=new Audio("/notify.mp3"),me.current.preload="auto",me.current.volume=.9);const r=async()=>{try{if(me.current&&!re.current&&(me.current.volume=0,await me.current.play(),me.current.pause(),me.current.currentTime=0,me.current.volume=.9,re.current=!0),!at.current){const i=sa();if(i){const c=i.volume;i.volume=0,await i.play().catch(()=>{}),i.pause(),i.currentTime=0,i.volume=c,at.current=!0}}}catch{}re.current&&at.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{t?.(),n?.()}},[]),a.useEffect(()=>{Go(()=>{Wt.refetch()}),qo(()=>{bt.refetch(),ie.refetch(),Wt.refetch()}),Vo(()=>{bt.refetch(),Wt.refetch()})},[]),a.useEffect(()=>{if(!Pt)return;const t=$n.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,b=p.clientY-u.clientY;return Math.sqrt(j*j+b*b)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,b,w)=>{const C=u-j,v=p-b;return C*C+v*v<=w*w},o=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,b=p.height,w=j/2,C=b/2,v=i/2;if(u.touches.length===1){const A=u.touches[0],U=A.clientX-p.left,W=A.clientY-p.top;if(!c(U,W,w,C,v))return;ht.current={touches:[A],initialDistance:0,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}else if(u.touches.length===2){const A=u.touches[0],U=u.touches[1],W=r(A,U),le=W.x-p.left,ue=W.y-p.top;if(!c(le,ue,w,C,v))return;const he=n(A,U);ht.current={touches:[A,U],initialDistance:he,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}},d=u=>{ht.current&&(u.preventDefault(),_n.current!==null&&cancelAnimationFrame(_n.current),_n.current=requestAnimationFrame(()=>{if(!ht.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,b=p.height,w=j/2,C=b/2,v=u.touches.length,A=ht.current.touches.length;if(v===1&&A===1){const U=u.touches[0],W=ht.current.touches[0],le=U.clientX-W.clientX,ue=U.clientY-W.clientY;wn(he=>{let K=ht.current.initialX+le,se=ht.current.initialY+ue;const O=Xi.current;if(O){const ne=he.scale,de=O.naturalWidth*ne,Pe=O.naturalHeight*ne,Qe=w+i/2,Ue=w-i/2-de,pt=C+i/2,hn=C-i/2-Pe;K=Math.max(Ue,Math.min(Qe,K)),se=Math.max(hn,Math.min(pt,se))}return{...he,x:K,y:se}})}else if(v===2&&A===2){const U=u.touches[0],W=u.touches[1],ue=n(U,W)/ht.current.initialDistance,he=Math.max(.1,Math.min(10,ht.current.initialScale*ue)),K=Xi.current;if(K){const se=K.naturalWidth,O=K.naturalHeight,ne=ht.current.initialX+se*ht.current.initialScale/2,de=ht.current.initialY+O*ht.current.initialScale/2,Pe=ne-w,Qe=de-C,Ue=he/ht.current.initialScale,pt=w+Pe*Ue,hn=C+Qe*Ue,Wr=pt-se*he/2,fn=hn-O*he/2;wn({x:Wr,y:fn,scale:he})}}_n.current=null}))},f=()=>{_n.current!==null&&(cancelAnimationFrame(_n.current),_n.current=null),ht.current=null};return t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",o),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[Pt,Ie.scale,Ie.x,Ie.y]),a.useEffect(()=>{if(!Ut)return;const t=jn.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,b=p.clientY-u.clientY;return Math.sqrt(j*j+b*b)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,b,w)=>{const C=u-j,v=p-b;return C*C+v*v<=w*w},o=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,b=p.height,w=j/2,C=b/2,v=i/2;if(u.touches.length===1){const A=u.touches[0],U=A.clientX-p.left,W=A.clientY-p.top;if(!c(U,W,w,C,v))return;ft.current={touches:[A],initialDistance:0,initialScale:Re.scale,initialX:Re.x,initialY:Re.y},u.preventDefault()}else if(u.touches.length===2){const A=u.touches[0],U=u.touches[1],W=r(A,U),le=W.x-p.left,ue=W.y-p.top;if(!c(le,ue,w,C,v))return;const he=n(A,U);ft.current={touches:[A,U],initialDistance:he,initialScale:Re.scale,initialX:Re.x,initialY:Re.y},u.preventDefault()}},d=u=>{ft.current&&(u.preventDefault(),On.current!==null&&cancelAnimationFrame(On.current),On.current=requestAnimationFrame(()=>{if(!ft.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,b=p.height,w=j/2,C=b/2,v=u.touches.length,A=ft.current.touches.length;if(v===1&&A===1){const U=u.touches[0],W=ft.current.touches[0],le=U.clientX-W.clientX,ue=U.clientY-W.clientY;Zt(he=>{let K=ft.current.initialX+le,se=ft.current.initialY+ue;const O=Zr.current;if(O){const ne=he.scale,de=O.naturalWidth*ne,Pe=O.naturalHeight*ne,Qe=w+i/2,Ue=w-i/2-de,pt=C+i/2,hn=C-i/2-Pe;K=Math.max(Ue,Math.min(Qe,K)),se=Math.max(hn,Math.min(pt,se))}return{...he,x:K,y:se}})}else if(v===2&&A===2){const U=u.touches[0],W=u.touches[1],ue=n(U,W)/ft.current.initialDistance,he=Math.max(.1,Math.min(10,ft.current.initialScale*ue)),K=Zr.current;if(K){const se=K.naturalWidth,O=K.naturalHeight,ne=ft.current.initialX+se*ft.current.initialScale/2,de=ft.current.initialY+O*ft.current.initialScale/2,Pe=ne-w,Qe=de-C,Ue=he/ft.current.initialScale,pt=w+Pe*Ue,hn=C+Qe*Ue,Wr=pt-se*he/2,fn=hn-O*he/2;Zt({x:Wr,y:fn,scale:he})}}On.current=null}))},f=()=>{On.current!==null&&(cancelAnimationFrame(On.current),On.current=null),ft.current=null};return t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",o),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[Ut,Re.scale,Re.x,Re.y]);const sa=a.useCallback(()=>{if(typeof window>"u")return null;if(!Se.current){const t=new Audio("/ring.mp3");t.preload="auto",t.loop=!0,t.volume=.9,Se.current=t}return Se.current},[]);function Bt(){try{if(P.current&&clearTimeout(P.current),P.current=null,Se.current)try{Se.current.pause(),Se.current.currentTime=0}catch{}pe.current=null}catch{}}const ho=a.useCallback(()=>{if(typeof window>"u")return null;if(!We.current){const t=new Audio("/dialing.mp3");t.preload="auto",t.loop=!0,t.volume=.7,We.current=t}return We.current},[]);function aa(){try{const t=ho();t&&(t.currentTime=0,t.loop=!0,t.volume=.7,t.play().catch(()=>{}))}catch(t){console.error("Error starting dialing sound:",t)}}function qn(){try{if(We.current)try{We.current.pause(),We.current.currentTime=0}catch{}}catch{}}const fo=a.useCallback(()=>{if(typeof window>"u")return null;if(!Ae.current){const t=new Audio("/notify.mp3");t.preload="auto",t.volume=.6,Ae.current=t}return Ae.current},[]);function Ii(){try{const t=fo();t&&(t.currentTime=0,t.volume=.6,t.play().catch(()=>{}))}catch(t){console.error("Error playing end call sound:",t)}}a.useEffect(()=>{const t=async i=>{if(!(i.conversationId===s)){X.invalidateQueries({queryKey:["conversations"]});return}if(!s)return;const d=i.message??i;d&&d.id&&(Mr(f=>{const u=f[s]||[];if(u.length===0)return f;const p=(d.attachments||[]).map(b=>b.url).sort(),j=u.filter(b=>{if(b.senderId!==d.senderId)return!0;const w=b.attachments.map(C=>C.url).sort();return w.length===p.length?!w.every((v,A)=>{const U=p[A];return v===U||v.startsWith("blob:")&&U&&!U.startsWith("blob:")}):!0});if(j.length===u.length)return f;if(j.length===0){const{[s]:b,...w}=f;return w}return{...f,[s]:j}}),da(s,d)),$e.refetch()},n=i=>{i.conversationId===s&&(Fe(!0),ot.current&&window.clearTimeout(ot.current),ot.current=window.setTimeout(()=>Fe(!1),2e3))},r=i=>{if(!s||i.conversationId!==s){X.invalidateQueries({queryKey:["conversations"]});return}i.message?Co(s,i.message):$e.refetch()};return _e.on("message:new",t),_e.on("conversation:typing",n),_e.on("message:reaction",r),()=>{_e.off("message:new",t),_e.off("conversation:typing",n),_e.off("message:reaction",r)}},[s]),a.useEffect(()=>{const t=async n=>{if(ta(n.conversationId))return;const r=n.senderId===N?.id,i=n.conversationId===s,c=document.visibilityState==="visible";if(!r&&(!i||!c)&&me.current&&re.current&&(me.current.currentTime=0,me.current.play().catch(()=>{})),i){n.message&&n.message.id&&da(s,n.message),$e.refetch().catch(()=>{});return}};return _e.on("message:notify",t),()=>{_e.off("message:notify",t)}},[s,N?.id,$e,ta]),a.useLayoutEffect(()=>{if(!s){yn.current=null,Et.current=0;return}yn.current!==s&&(yn.current=s,Et.current=0);const t=(Ht?.length??0)+pi.length,n=Et.current;if(Et.current=t,!ge.current||t===0||t<=n)return;const r=[...Ht||[],...pi],i=r[r.length-1],c=i?.senderId&&N?.id?i.senderId===N.id:!1;(c||!lt.current||ve.current)&&requestAnimationFrame(()=>{const d=ge.current;d&&(d.scrollTop=d.scrollHeight,ve.current=!0,c&&(lt.current=!1))})},[s,pi,Ht,N?.id]),a.useEffect(()=>{if(!s)return;const t=ge.current;if(!t)return;const n=()=>{t&&(t.scrollTop=t.scrollHeight,ve.current=!0,lt.current=!1)};if(yt.current){n();const r=window.setTimeout(n,50),i=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(i)}}n()},[s]),a.useEffect(()=>{if(!yt.current)return;const t=ge.current;if(!t)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===T.current&&(t.scrollTop=t.scrollHeight,ve.current=!0,lt.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[s]),a.useEffect(()=>{},[]),a.useEffect(()=>{if(!Te||!yt.current)return;const t=ge.current,n=window.setInterval(()=>{Ce(r=>r%3+1),t&&t.scrollHeight-t.scrollTop-t.clientHeight<80&&(t.scrollTop=t.scrollHeight)},500);return()=>window.clearInterval(n)},[Te]),a.useEffect(()=>{const t=ge.current;if(!t)return;let n=0,r=t.scrollTop;const i=()=>{n&&cancelAnimationFrame(n);const c=t.scrollTop;Math.abs(c-r)>1&&(lt.current=!0),n=requestAnimationFrame(()=>{const d=t.scrollHeight-t.scrollTop-t.clientHeight<8;ve.current=d,Mt(!d),d&&window.setTimeout(()=>{t.scrollHeight-t.scrollTop-t.clientHeight<40&&(lt.current=!1)},100),r=t.scrollTop})};return t.addEventListener("scroll",i,{passive:!0}),i(),()=>{t.removeEventListener("scroll",i),n&&cancelAnimationFrame(n)}},[s]),a.useEffect(()=>{const t=()=>{if(!ge.current)return;const n=ge.current.clientWidth;Rt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]);function po(t,n){if(!/^\d?$/.test(n))return;const r=[...Hi];r[t]=n,Fa(r),n&&t<3&&Bi[t+1].current?.focus(),!n&&t>0&&Bi[t-1].current?.focus();const i=r.join("");i.length===4&&/^\d{4}$/.test(i)?(async()=>{try{const c=await oe.get("/contacts/search",{params:{query:i}});$i(c.data.results?.[0]??null)}catch{$i(null)}})():$i(null)}async function go(){Yr(!0);try{const t=await oe.get("/status/me");Ya(t.data.user?.eblid??"")}catch{}}async function mo(){const t=Hi.join("");if(/^\d{4}$/.test(t)){_i(!0);try{await oe.post("/contacts/add",{identifier:t}),_i(!1)}catch{_i(!1)}}}function Ri(){if(!s||!$e.data||!N?.id)return;const t=$e.data.filter(n=>n.senderId!==N.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===N.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);t.length!==0&&oe.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{X.invalidateQueries({queryKey:["messages",s]})}).catch(()=>{})}a.useEffect(()=>{document.hasFocus()&&Ri(),s&&(oe.post("/messages/mark-conversation-read",{conversationId:s}).catch(()=>{}),X.setQueryData(["conversations"],t=>t&&t.map(n=>n.conversation.id===s?{...n,unreadCount:0}:n)))},[s]),a.useEffect(()=>{document.hasFocus()&&Ri()},[$e.data]),a.useEffect(()=>{const t=()=>Ri(),n=()=>{document.visibilityState==="visible"&&Ri()};return window.addEventListener("focus",t),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",t),document.removeEventListener("visibilitychange",n)}},[s,$e.data]);function yo(){dt.current||(dt.current=window.setTimeout(()=>{const t=Array.from(xt.current);xt.current.clear(),dt.current&&clearTimeout(dt.current),dt.current=null,t.length&&oe.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{s&&X.invalidateQueries({queryKey:["messages",s]})}).catch(()=>{})},250))}a.useEffect(()=>{if(!s||!$e.data||!N?.id)return;zt.current?.disconnect();const t=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const i=r.target,c=i.dataset.mid;if(!c)continue;const o=$e.data.find(f=>f.id===c);!o||o.senderId===N.id||(o.receipts||[]).some(f=>f.userId===N.id&&(f.status==="READ"||f.status==="SEEN"))||(xt.current.add(c),t.unobserve(i))}xt.current.size&&yo()},{root:ge.current,threshold:[.25]});zt.current=t;for(const n of $e.data){if(n.senderId===N.id||(n.receipts||[]).some(c=>c.userId===N.id&&(c.status==="READ"||c.status==="SEEN")))continue;const i=Ct.current.get(n.id);i&&t.observe(i)}return()=>{t.disconnect()}},[s,$e.data,N?.id]),a.useEffect(()=>{const t=()=>{if(!ge.current)return;const n=ge.current.clientWidth;Rt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[s]);async function as(t,n="",r){if(!s||t.length===0)return;const i=!!k?.isSecret;if(i){if(ji){alert("Секретный чат больше не активен, отправка вложений отключена.");return}if(!pr){alert("Секретный чат ещё не готов к вложениям, подождите установления защищённой сессии.");return}}si(!0),sr(0);try{const c=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,o=[],d=t.reduce((j,b)=>j+b.size,0);for(const j of t)if(j.type.startsWith("image/")){const b=URL.createObjectURL(j),{width:w,height:C}=await xo(b);o.push({url:b,type:"IMAGE",width:w,height:C,progress:0,__pending:!0})}else o.push({url:j.name,type:"FILE",__pending:!0,progress:0});Mr(j=>({...j,[s]:[...j[s]||[],{id:c,createdAt:Date.now(),senderId:N?.id||"me",attachments:o,content:n}]}));const f=[];let u=0;for(let j=0;j<t.length;j++){const b=t[j],w=o[j];let C=b,v;if(i&&k){const ue=new Uint8Array(await b.arrayBuffer()),he=await on.encryptBinary(k,ue);C=new Blob([he.cipher],{type:"application/octet-stream"}),v={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:he.nonce,originalName:b.name,originalType:b.type,originalSize:b.size}}const A=new FormData;A.append("file",C,i?`${b.name||"file"}.enc`:b.name);const W={url:await new Promise((ue,he)=>{const K=new XMLHttpRequest;K.open("POST","/api/upload");try{const se=Jn.getState().session?.accessToken;se&&K.setRequestHeader("Authorization",`Bearer ${se}`)}catch{}K.upload.onprogress=se=>{if(se.lengthComputable){const O=Math.round((u+se.loaded)/d*100);sr(O),Mr(ne=>{const Pe=(ne[s]||[]).map(Ue=>({...Ue,attachments:Ue.attachments.map(pt=>({...pt}))})),Qe=Pe[Pe.length-1];if(Qe){const Ue=Qe.attachments.findIndex(pt=>pt.__pending&&pt.type===(b.type.startsWith("image/")?"IMAGE":"FILE")&&(!pt.width||pt.url.startsWith("blob:")));Ue>=0&&(Qe.attachments[Ue].progress=O)}return{...ne,[s]:Pe}})}},K.onreadystatechange=()=>{if(K.readyState===4)if(K.status>=200&&K.status<300)try{const se=JSON.parse(K.responseText);ue(se.url)}catch(se){he(se)}else he(new Error("upload failed"))},K.send(A)}),type:b.type.startsWith("image/")?"IMAGE":"FILE"},le={};w&&w.type==="IMAGE"&&w.width&&w.height&&(le.width=w.width,le.height=w.height),v&&(le.e2ee=v),Object.keys(le).length>0&&(W.metadata=le),f.push(W),u+=b.size,sr(Math.round(u/d*100))}const p=f.every(j=>j.type==="IMAGE")?"IMAGE":"FILE";await oe.post("/conversations/send",{conversationId:s,type:p,content:n,attachments:f,replyToId:r}),Mr(j=>{const w=(j[s]||[]).filter(C=>C.id!==c);if(w.length===0){const{[s]:C,...v}=j;return v}return{...j,[s]:w}}),X.invalidateQueries({queryKey:["messages",s]})}catch(c){console.error("Failed to upload attachments",c)}si(!1)}async function xo(t){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=t})}const vo=async()=>{if(s&&!Ns)try{if(!(await Da({audio:!0})).ok){alert("Необходимо разрешение на использование микрофона для записи голосовых сообщений");return}Bt(),Qi([]);const n=new bl({onStateChange:r=>{Vi(r==="recording"),r!=="recording"&&cr.current&&(clearInterval(cr.current),cr.current=null)},onDurationUpdate:r=>{Ki(r)},onAmplitudeUpdate:r=>{Qi(i=>{const c=M?60:zs,o=[...i,r];return o.length>c?o.slice(-c):o})},onError:r=>{console.error("Voice recording error:",r),alert("Ошибка записи голосового сообщения"),oa()}});un.current=n,await n.start()}catch(t){console.error("Failed to start voice recording:",t),alert("Не удалось начать запись голосового сообщения")}},oa=()=>{if(!un.current)return;const t=un.current,n=t.getDuration(),r=t.stop();un.current=null,Vi(!1),Ki(0),r&&s&&wo(r,n)},bo=()=>{un.current&&(un.current.cancel(),un.current=null),cr.current&&(clearInterval(cr.current),cr.current=null),Vi(!1),Ki(0),Qi([])},wo=async(t,n)=>{if(!s)return;const r=!!k?.isSecret;if(r){if(ji){alert("Секретный чат больше не активен, отправка голосовых сообщений отключена.");return}if(!pr){alert("Секретный чат ещё не готов к голосовым сообщениям, подождите установления защищённой сессии.");return}}si(!0),sr(0);try{const i=new File([t],"voice-message.webm",{type:t.type||"audio/webm"});let c=i,o;if(r&&k){const p=new Uint8Array(await i.arrayBuffer()),j=await on.encryptBinary(k,p);c=new Blob([j.cipher],{type:"application/octet-stream"}),o={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:j.nonce,originalName:i.name,originalType:i.type,originalSize:i.size}}const d=new FormData;d.append("file",c,r?`${i.name}.enc`:i.name);const u={url:await new Promise((p,j)=>{const b=new XMLHttpRequest;b.open("POST","/api/upload");try{const w=Jn.getState().session?.accessToken;w&&b.setRequestHeader("Authorization",`Bearer ${w}`)}catch{}b.upload.onprogress=w=>{if(w.lengthComputable){const C=Math.round(w.loaded/w.total*100);sr(C)}},b.onreadystatechange=()=>{if(b.readyState===4)if(b.status>=200&&b.status<300)try{const w=JSON.parse(b.responseText);p(w.url)}catch(w){j(w)}else j(new Error("upload failed"))},b.send(d)}),type:"AUDIO",size:i.size,...o?{metadata:{e2ee:o}}:{}};await oe.post("/conversations/send",{conversationId:s,type:"AUDIO",metadata:{duration:n},attachments:[u],replyToId:J?.id}),fe(null),X.invalidateQueries({queryKey:["messages",s]})}catch(i){console.error("Failed to send voice message",i),alert("Не удалось отправить голосовое сообщение")}finally{si(!1),sr(0)}};a.useEffect(()=>()=>{un.current&&un.current.cleanup()},[]),a.useEffect(()=>{let t=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Hs(Math.round(performance.now()-r))}catch{Hs(null)}};return n(),t=window.setInterval(n,15e3),()=>{t&&clearInterval(t)}},[]),a.useEffect(()=>{let t=null;const n=()=>X.invalidateQueries({queryKey:["conversations"]});return t=window.setInterval(n,2e4),()=>{t&&clearInterval(t)}},[X]);const jo=a.useMemo(()=>{const t=new Set;try{const n=ie.data||[],r=new Map;for(const i of n){const c=i?.conversation;c?.id&&r.set(c.id,c)}for(const[i,c]of Object.entries(Cn||{})){if(!c?.active)continue;const o=r.get(i);if(!!!(o&&(o.isGroup||(o.participants?.length??0)>2)))continue;const f=c.participants||[];for(const u of f)t.add(u)}}catch{}return t},[Cn,ie.data]);function os(t){const n=t?.id?Gn(t):t?.status??"OFFLINE",r=t.lastSeenAt?new Date(t.lastSeenAt):null;if(n==="ONLINE")return"ОНЛАЙН";if(n==="BACKGROUND")return"В ФОНЕ";if(n==="IN_CALL"){const j=typeof t?.id=="string"?t.id:null;return j&&jo.has(j)?"В БЕСЕДЕ":"В ЗВОНКЕ"}if(!r)return"оффлайн";const c=new Date().getTime()-r.getTime(),o=Math.floor(c/6e4);if(o<1)return"был(а) онлайн только что";if(o<60)return`был(а) онлайн ${o} мин назад`;const d=Math.floor(o/60);if(d<24)return`был(а) онлайн ${d} ч назад`;const f={hour:"2-digit",minute:"2-digit"},u=r.toLocaleDateString(),p=r.toLocaleTimeString([],f);return`был(а) онлайн ${u} в ${p}`}function cs(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/3600),i=Math.floor(n%3600/60),c=n%60;return r>0?`${r}:${String(i).padStart(2,"0")}:${String(c).padStart(2,"0")}`:`${i}:${String(c).padStart(2,"0")}`}function ca(t){const n=t?"conversations-list slider-panel":"conversations-list";return e.jsxs("aside",{className:n,children:[e.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{className:"logo",children:[e.jsx("span",{children:"Е"}),e.jsx("span",{className:"b",children:"Б"}),e.jsx("span",{children:"луша"})]}),e.jsx("div",{className:"subtitle",children:"Здесь мы общаемся"})]})}),e.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx("div",{ref:ce,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:ie.data?.slice().sort((r,i)=>{const c=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(i.conversation.messages?.[0]?.createdAt?new Date(i.conversation.messages[0].createdAt).getTime():0)-c}).filter(r=>{const i=r.conversation;return!(i.isSecret&&(i.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const i=r.conversation,c=i.participants.filter(C=>Tt?C.user.id!==Tt:!0).map(C=>C.user),o=c.map(C=>C.displayName??C.username).join(", ")||"Диалог",d=i.title??o,f=i.isGroup||i.participants.length>2,u=!!i.isSecret;c.map(C=>C.displayName??C.username).join(", ");const p=s===i.id,b=!!Cn[i.id]?.active,w=h===i.id;return e.jsxs("div",{onContextMenu:C=>{C.preventDefault(),C.stopPropagation(),!t&&Ft({open:!0,x:C.clientX,y:C.clientY,conversationId:i.id})},onClick:()=>ur(i.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...b?{background:w?"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)":"linear-gradient(135deg, rgba(217, 119, 6, 0.10) 0%, rgba(227, 139, 10, 0.12) 100%)",borderColor:"var(--brand-600)",...w?p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.22), 0 6px 16px rgba(227,139,10,0.14)"}:p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.16)"}}:{}},children:[f?e.jsx(tt,{name:d?.trim()?.charAt(0)||"Г",id:i.id,avatarUrl:i.avatarUrl&&i.avatarUrl.trim()?i.avatarUrl:void 0,presence:b?"IN_CALL":void 0}):e.jsx(tt,{name:c[0]?.displayName??c[0]?.username??"D",id:c[0]?.id??i.id,presence:b?"IN_CALL":Gn(c[0]),avatarUrl:c[0]?.avatarUrl&&c[0].avatarUrl.trim()?c[0].avatarUrl:void 0}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:d}),!f&&u&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:e.jsx(Sa,{size:12,color:"#22c55e"})})]}),e.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} непрочитанных`:(()=>{const C=Cn[i.id];if(C?.active){const v=C.startedAt?Date.now()-C.startedAt:typeof C.elapsedMs=="number"?C.elapsedMs:0;return e.jsx("span",{children:cs(v)})}else if(C&&C.endedAt){const v=C.endedAt,U=Date.now()-v,W=Math.floor(U/6e4);if(W<1)return e.jsx("span",{children:"Завершен только что"});if(W<60)return e.jsxs("span",{children:["Завершен ",W," мин назад"]});const le=Math.floor(W/60);if(le<24)return e.jsxs("span",{children:["Завершен ",le," ч назад"]});const ue=new Date(v),he=ue.toLocaleDateString(),K=ue.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Завершен ",he," в ",K]})}return f?null:os(c[0]??{})})()})]}),t&&e.jsx("button",{type:"button","aria-label":"Меню беседы",title:"Меню",onClick:C=>{C.preventDefault(),C.stopPropagation();const v=C.currentTarget.getBoundingClientRect();Ft({open:!0,x:Math.round(v.right-8),y:Math.round(v.bottom+6),conversationId:i.id})},style:{flexShrink:0,width:36,height:36,borderRadius:10,border:"1px solid transparent",background:"transparent",color:"var(--text-muted)",display:"inline-flex",alignItems:"center",justifyContent:"center",marginLeft:8,WebkitTapHighlightColor:"transparent"},children:e.jsx(xr,{size:20})})]},i.id)})}),Le&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),Xt&&e.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),e.jsxs("div",{className:"conv-footer",children:[e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:12},children:[e.jsxs("div",{onClick:()=>At(!0),className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(vc,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Беседа"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Групповой чат"})]})]}),e.jsxs("div",{onClick:go,className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:Wt.data&&Wt.data.length>0?e.jsx(dc,{size:22}):bt.data&&bt.data.length>0?e.jsx(qc,{size:22}):e.jsx(Ta,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Контакты"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:Wt.data&&Wt.data.length>0?"Новый запрос в друзья":bt.data&&bt.data.length>0?"Список контактов":"Добавить контакт"})]})]})]}),e.jsxs("div",{className:"tile",onClick:()=>Gr(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const r=Za??Gt.data?.status,i=Ja?"ONLINE":"OFFLINE",c=(r??i??"OFFLINE").toString().toUpperCase(),o=["ONLINE","AWAY","BACKGROUND","IN_CALL","OFFLINE"],d=c,f=i,u=o.includes(d)?d:f,p=Gt.data?.avatarUrl??N?.avatarUrl??void 0;return e.jsx(tt,{name:N?.displayName??N?.username??"Me",id:N?.id??"me",presence:u,avatarUrl:p})})(),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:N?.displayName??N?.username??"Я"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Gt.data?.eblid??"— — — —"]})]})]})]})]})]})}function la(t){const n=t?"messages-pane slider-panel":"messages-pane",r=ji,i=pr;let c="";return k?.isSecret&&(r?c="Секретный чат станет доступен после подтверждения собеседника.":lo?c=ea?`Секретный чат подключён на устройстве «${ea}»`:"Секретный чат подключён на другом устройстве.":i||(c="Готовим защищённое подключение...")),e.jsxs("section",{className:n,children:[e.jsxs("header",{style:{...s?Cn[s]?.active||m===s?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:M?"column":"row",justifyContent:M?"flex-start":"space-between",alignItems:M?"stretch":"center",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:M?"100%":"auto",padding:M?"0 8px":"0"},children:[t&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:co,children:e.jsx(cc,{size:18})}),k?(()=>{const o=k.participants.filter(b=>Tt?b.user.id!==Tt:!0).map(b=>b.user),d=o.map(b=>b.displayName??b.username).join(", ")||"Диалог",f=k.title??d,u=k.isGroup||k.participants.length>2;k.isSecret;const p=Cn[k.id],j=p?.active;return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>He(!0),style:{cursor:"pointer"},children:e.jsx(tt,{name:f?.trim()?.charAt(0)||"Г",id:k.id,size:60,avatarUrl:k.avatarUrl&&k.avatarUrl.trim()?k.avatarUrl:void 0,presence:j?"IN_CALL":void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0,order:M?1:2},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:b=>{L({open:!0,anchor:b.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(xr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:j?e.jsx(e.Fragment,{children:(()=>{const b=p.participants||[],w=k.participants||[],C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsxs(e.Fragment,{children:[p.active&&e.jsx("span",{children:cs(C)}),w.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[p.startedAt&&" • ",w.map((v,A)=>{const U=v.user,W=b.length>0&&b.includes(U.id);return e.jsxs("span",{style:{fontWeight:W?700:400,color:W?"var(--brand-600)":"var(--text-muted)"},children:[A>0&&", ",U.displayName??U.username,W&&" ✓"]},U.id)})]})]})})()}):p&&p.endedAt?(()=>{const b=p.endedAt,C=Date.now()-b,v=Math.floor(C/6e4);let A="";if(v<1)A="Завершен только что";else if(v<60)A=`Завершен ${v} мин назад`;else{const W=Math.floor(v/60);if(W<24)A=`Завершен ${W} ч назад`;else{const le=new Date(b),ue=le.toLocaleDateString(),he=le.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});A=`Завершен ${ue} в ${he}`}}const U=k.participants||[];return e.jsxs(e.Fragment,{children:[e.jsx("span",{children:A}),U.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" • ",U.map((W,le)=>{const ue=W.user;return e.jsxs("span",{children:[le>0&&", ",ue.displayName??ue.username]},ue.id)})]})]})})():o.map(b=>b.displayName??b.username).join(", ")})]})]}):(()=>{const b=o[0];return e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(tt,{name:b?.displayName??b?.username??"D",id:b?.id??k.id,avatarUrl:b?.avatarUrl&&b.avatarUrl.trim()?b.avatarUrl:void 0,presence:p?.active?"IN_CALL":Gn(b),size:60})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:w=>{L({open:!0,anchor:w.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(xr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const w=m===s;if((p?.active||w)&&p){const C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsx("span",{children:cs(C)})}if(p&&p.endedAt&&!w){const C=p.endedAt,A=Date.now()-C,U=Math.floor(A/6e4);if(U<1)return e.jsx("span",{children:"Завершен только что"});if(U<60)return e.jsxs("span",{children:["Завершен ",U," мин назад"]});const W=Math.floor(U/60);if(W<24)return e.jsxs("span",{children:["Завершен ",W," ч назад"]});const le=new Date(C),ue=le.toLocaleDateString(),he=le.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Завершен ",ue," в ",he]})}return b?os(b):""})()})]})]})})()})():e.jsx("div",{children:"Выберите чат"})]}),to&&k&&!!k.isSecret&&(k.participants?.length??0)<=2&&typeof document<"u"&&br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:M?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Lr(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:M?16:20,borderRadius:M?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:M?"center":"left"},onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:M?"column":"row",gap:M?8:0},children:[e.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Завершить секретный чат?"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Lr(!1),style:{alignSelf:M?"flex-end":void 0},children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Сообщения этого секретного чата будут удалены у всех участников. Это действие необратимо."}),e.jsxs("div",{style:{display:"flex",justifyContent:M?"center":"flex-end",alignItems:"center",flexDirection:M?"column":"row",gap:M?12:8},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>Lr(!1),style:M?{width:"100%"}:void 0,children:"Отменить"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:M?"100%":void 0},onClick:async()=>{if(s)try{await oe.delete(`/conversations/${s}`),X.invalidateQueries({queryKey:["conversations"]}),X.removeQueries({queryKey:["messages",s]}),Lr(!1),l(null)}catch(o){console.error("Failed to end secret conversation:",o)}},children:"Завершить"})]})]})}),document.body),s&&(()=>{const o=Cn[s],d=o?.active,f=k?.isGroup||(k?.participants.length??0)>2,u=m===s,p=h===s&&!u,j=N?.id,b=f&&d&&j&&o?.participants?.includes(j),w=!f&&(u||h===s||q.activeConvId===s||d&&(q.activeConvId===s||h===s)),C=b||w,v={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:M?"8px 12px":"12px 16px",flex:M?1:"auto",minWidth:M?0:"auto",fontSize:M?"14px":"15px",fontWeight:M?500:600,height:M?"42px":"46px",minHeight:M?"42px":"46px",boxSizing:"border-box"},A={display:"flex",alignItems:"center",gap:8,width:M?"100%":"auto",padding:M?"0 8px":"0",justifyContent:M?"center":"flex-end",marginLeft:M?0:"auto"},U={display:"inline-flex",alignItems:"center",justifyContent:"center",width:M?42:44,height:M?42:44,minWidth:M?42:44,padding:0,margin:0,borderRadius:999},W=async()=>{if(s&&await xi(!1))try{yi(s),wa(s,!1),q.startOutgoing(s,!1),kt(O=>{const ne=O[s],de=N?.id;return ne?.active?de&&ne.participants&&!ne.participants.includes(de)?{...O,[s]:{...ne,participants:[...ne.participants,de]}}:O:{...O,[s]:{startedAt:Date.now(),active:!0,participants:de?[de]:[]}}});const K=ie.data?.find(O=>O.conversation.id===s)?.conversation;if(K?.isGroup||(K?.participants?.length??0)>2)y(s),S(O=>O===s?null:O);else{const O=s;R({conversationId:O,startedAt:Date.now(),video:!1}),aa(),D.current&&window.clearTimeout(D.current),D.current=window.setTimeout(()=>{R(ne=>ne?.conversationId===O?(qn(),Ii(),$r(O),kt(de=>{const Pe=de[O];if(Pe?.active)return{...de,[O]:{...Pe,active:!1,endedAt:Date.now()}};const{[O]:Qe,...Ue}=de;return Ue}),q.endCall(),null):ne),D.current=null},3e4)}}catch(K){console.error("Error starting call:",K)}},le=async()=>{if(s&&await xi(!0))try{yi(s),wa(s,!0),q.startOutgoing(s,!0),kt(O=>{const ne=O[s],de=N?.id;return ne?.active?de&&ne.participants&&!ne.participants.includes(de)?{...O,[s]:{...ne,participants:[...ne.participants,de]}}:O:{...O,[s]:{startedAt:Date.now(),active:!0,participants:de?[de]:[]}}});const K=ie.data?.find(O=>O.conversation.id===s)?.conversation;if(K?.isGroup||(K?.participants?.length??0)>2)y(s),S(O=>O===s?null:O);else{const O=s;R({conversationId:O,startedAt:Date.now(),video:!0}),aa(),D.current&&window.clearTimeout(D.current),D.current=window.setTimeout(()=>{R(ne=>ne?.conversationId===O?(qn(),Ii(),$r(O),kt(de=>{const Pe=de[O];if(Pe?.active)return{...de,[O]:{...Pe,active:!1,endedAt:Date.now()}};const{[O]:Qe,...Ue}=de;return Ue}),q.endCall(),null):ne),D.current=null},3e4)}}catch(K){console.error("Error starting call:",K)}},ue=()=>{s&&(y(s),S(null))},he=()=>d||u?C?e.jsxs(e.Fragment,{children:[!p&&e.jsxs("button",{className:"btn btn-secondary",onClick:ue,style:v,children:[e.jsx(ka,{size:M?16:18}),M?"Развернуть":" Развернуть"]}),e.jsxs("button",{className:"btn",onClick:()=>{const K=k?.participants?.length??0,se=K<=2,O=k?.isGroup||K>2;if(se&&h)$r(h),kt(ne=>{const de=ne[h];return de?.active?{...ne,[h]:{...de,active:!1,endedAt:Date.now()}}:ne});else if(O&&h){try{Ko(h)}catch{}kt(ne=>{const de=ne[h];if(!de||!de.participants)return ne;const Pe=N?.id;return!Pe||!de.participants.includes(Pe)?ne:{...ne,[h]:{...de,participants:de.participants.filter(Qe=>Qe!==Pe)}}})}y(null),S(null),q.endCall(),Bt()},style:{...v,background:"#ef4444",color:"#fff"},children:[e.jsx(fs,{size:M?16:18}),M?"Сбросить":" Сбросить"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{L({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(xr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(k?.isGroup||(k?.participants?.length??0)>2){y(s),S(se=>se===s?null:se),q.startOutgoing(s,!1);try{ba(s,!1)}catch{}}else y(s),S(se=>se===s?null:se),q.startOutgoing(s,!1)},style:v,children:[e.jsx(ps,{size:M?16:18}),M?"Подключиться":" Подключиться"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(k?.isGroup||(k?.participants?.length??0)>2){y(s),S(se=>se===s?null:se),q.startOutgoing(s,!0);try{ba(s,!0)}catch{}}else y(s),S(se=>se===s?null:se),q.startOutgoing(s,!0)},style:v,children:[e.jsx(gs,{size:M?16:18}),M?"Подключиться с видео":" Подключиться с видео"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{L({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(xr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{W()},style:v,children:[e.jsx(ps,{size:M?16:18}),M?" Начать звонок":" Звонок"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{le()},style:v,children:[e.jsx(gs,{size:M?16:18}),M?" Начать с видео":" Видео"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:K=>{L({open:!0,anchor:K.currentTarget})},style:U,children:e.jsx(xr,{size:22})})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:A,children:he()}),ar&&e.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:M?"100%":420,width:M?"100%":"auto"},children:[e.jsx("span",{style:{flex:1},children:ar}),e.jsx("button",{type:"button",onClick:()=>Rr(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:e.jsx(Lt,{size:14})})]})]})})()]}),!k?.isSecret&&gr&&e.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:M?"column":"row",gap:12,alignItems:M?"stretch":"center"},children:gr.isInitiator?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1},children:"Ждём подтверждения собеседника, чтобы начать секретный чат."}),e.jsx("div",{style:{display:"flex",gap:8},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Js(gr.conversationId),disabled:Zi,style:{color:"#f87171"},children:"Отменить"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[gr.initiatorName," предлагает начать секретный чат на этом устройстве."]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>io(gr.conversationId),disabled:Zi,children:"Принять"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>Js(gr.conversationId),disabled:Zi,style:{color:"#bae6fd"},children:"Отказаться"})]})]})}),e.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),e.jsx("div",{ref:ge,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:s?k?.isSecret&&(!i||r)?e.jsx("div",{className:"messages-empty",children:c}):(()=>{const o=(Ht?[...Ht]:[]).filter(u=>!u.deletedAt).sort((u,p)=>new Date(u.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),d=pi,f=[...o||[],...d];return f?f.map((u,p)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const j=f[p-1],b=f[p+1],w=!b||b.senderId!==u.senderId,C=!!j&&j.senderId===u.senderId,v=u.senderId===N?.id,W=`${Ve?"msg left":v?"msg me":"msg them"} ${C?"compact":"gap"}`,le=Ve?"msg-bubble left":v?"msg-bubble me":"msg-bubble them",ue=w?`${le} ${v&&!Ve?"tail-right":"tail-left"}`:le,he=ra[u.senderId],K=he?.displayName??he?.username??(v?N?.displayName??N?.username??"Me":"User"),se=he?.id??(v?N?.id??"me":"user"),O=v?"#303845":uo(u.senderId),ne="#f1f3f6",de=Ve&&w,Pe=Ve,Qe=u.createdAt?new Date(u.createdAt):null,Ue=Qe?Qe.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",pt=(k?.participants||[]).map(F=>F.user.id).filter(F=>Tt?F!==Tt:!0),hn=u.receipts||[],Wr=v&&pt.some(F=>hn.some(ae=>ae.userId===F&&(ae.status==="READ"||ae.status==="SEEN"))),fn=v&&Wr?"✓":"",Mi=(F,ae)=>{Z({open:!0,x:F,y:ae,messageId:u.id})},So=F=>{F.preventDefault(),Mi(F.clientX,F.clientY)},ko=()=>{const F=u.replyTo?.id;if(!F)return;const ae=Ct.current.get(F);ae&&ae.scrollIntoView({behavior:"smooth",block:"center"})},ua=f.filter(F=>(F.attachments||[]).some(ae=>ae.type==="IMAGE")).flatMap(F=>F.attachments.filter(ae=>ae.type==="IMAGE").map(ae=>Ci(ae)).filter(ae=>!!ae)),ha=F=>{const ae=ua.findIndex(rt=>rt===F);ir({open:!0,index:ae>=0?ae:0,items:ua})},Io=M?{}:{onContextMenu:So,...{onPointerDown:F=>{const ae=window.setTimeout(()=>Mi(F.clientX,F.clientY),450),rt=()=>{window.clearTimeout(ae),window.removeEventListener("pointerup",rt),window.removeEventListener("pointermove",kn)},kn=()=>{window.clearTimeout(ae),window.removeEventListener("pointerup",rt),window.removeEventListener("pointermove",kn)};window.addEventListener("pointerup",rt,{passive:!0}),window.addEventListener("pointermove",kn,{passive:!0})}}};return e.jsxs("div",{className:W,...Io,children:[Pe&&(de?e.jsx(tt,{name:K,id:se,avatarUrl:(()=>{const F=ra[u.senderId]?.avatarUrl;return F&&F.trim()?F:void 0})()}):e.jsx("div",{className:"avatar-spacer"})),e.jsxs("div",{className:ue,"data-mid":u.id,ref:F=>{if(!F){Ct.current.delete(u.id);return}Ct.current.set(u.id,F),zt.current?.observe(F)},style:{"--bubble-bg":O,"--bubble-fg":ne},onClick:F=>{if(!M||F.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const rt=typeof window.getSelection=="function"?window.getSelection():null;rt&&rt.toString()||Mi(F.clientX,F.clientY)},onContextMenu:F=>{if(F.target.closest(".reaction-emoji")){F.preventDefault(),F.stopPropagation();return}Mi(F.clientX,F.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const F={};for(const ae of u.reactions)F[ae.emoji]||(F[ae.emoji]={count:0,hasMine:!1}),F[ae.emoji].count++,ae.userId===N?.id&&(F[ae.emoji].hasMine=!0);return e.jsx("div",{style:{position:"absolute",bottom:-18,right:v?8:void 0,left:v?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(F).map(([ae,rt],kn)=>{const tn=ae==="❤️"?"#ef4444":"#ffc46b";return e.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async Vn=>{Vn.preventDefault(),Vn.stopPropagation();try{rt.hasMine?await oe.post("/messages/unreact",{messageId:u.id,emoji:ae}):await oe.post("/messages/react",{messageId:u.id,emoji:ae}),s&&X.invalidateQueries({queryKey:["messages",s]})}catch(ls){console.error("Error toggling reaction:",ls)}},onMouseDown:Vn=>{Vn.stopPropagation()},style:{fontSize:12,color:tn,display:"inline-block",animation:`reactionBounce 0.6s ease ${kn*.1}s`,cursor:"pointer",opacity:rt.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[ae,rt.count>1?` ${rt.count}`:""]},ae)})})})(),u.replyTo&&e.jsxs("div",{onClick:ko,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:v?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["Ответ на: ",u.replyTo.content??"сообщение"]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(()=>{const F=u.attachments||[],ae=F.filter(Je=>Je?.type==="IMAGE"),rt=typeof u.content=="string"?u.content.trim().length>0:!!u.content,kn=F.some(Je=>Je?.type&&Je.type!=="IMAGE"),Ei=ae.length>0&&!rt&&!kn,tn=[];let Vn=!1;F.forEach((Je,be)=>{if(Je?.type==="IMAGE"){Vn||(tn.push({kind:"imageGroup",atts:ae}),Vn=!0);return}tn.push({kind:"single",att:Je,idx:be})});const ls=Je=>{if(!Je.length)return null;if(Je.length===1){const ee=Je[0],et=0,it=ee.metadata??{},Xe=Ci(ee),Ye=!!(k?.isSecret&&it?.e2ee?.kind==="ciphertext"),st=Ye?Fn[ee.url]:void 0,It=Ye&&!Xe&&(!st||st.status==="pending"),Nt=Ye&&st?.status==="error",Kn=typeof window<"u"?window.innerWidth:1280,Rn=Kn<=768?Math.max(320,Math.floor(Kn/2)):Math.min(600,Math.max(320,Math.floor(Kn/3))),Ai=`${ee.url||et}`,Hr=Fs[Ai],Mn=Hr?.width||ee.width||ee.metadata?.width||Rn,mr=Hr?.height||ee.height||ee.metadata?.height||Math.round(Mn*.75),nn=mr/Mn||.75,pn=Rn;let _t=Rn;nn<.5?_t=Math.max(Math.round(Rn*.6),200):nn<.7&&(_t=Math.max(Math.round(Rn*.75),200));const Ro=Mn>pn?pn/Mn:1,Mo=mr>_t?_t/mr:1,fa=Math.min(Ro,Mo,1);let En=Mn*fa,rn=mr*fa;En>pn&&(En=pn,rn=En*nn),rn>_t&&(rn=_t,En=rn/nn),En=Math.round(En),rn=Math.round(rn);const Qn=`${ee.url||et}`,ds=!!_s[Qn],pa=!!Os[Qn],Ti=ee.__pending||It||!ds&&!pa;return e.jsxs("div",{style:{maxWidth:"100%",maxHeight:rn,width:Ti?Math.min(En,typeof window<"u"?window.innerWidth-100:En):"fit-content",height:Ti?rn:"auto",minWidth:0,minHeight:Ti?rn:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Ei&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:Ue}),!!fn&&e.jsx("span",{children:fn})]}),Ti&&e.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),It?e.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Расшифровка изображения..."}):typeof ee.progress=="number"&&ee.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ee.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Nt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось расшифровать изображение"}),pa&&!Nt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось загрузить изображение"}),Xe&&!Nt&&e.jsx("img",{src:Xe,alt:"img",style:{maxWidth:"100%",maxHeight:rn,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:ee.__pending?.85:1,display:ds?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:Br=>{const Di=Br.target;if(!ee.width&&!it?.width&&Di.naturalWidth&&Di.naturalHeight&&Xs(An=>({...An,[Qn]:{width:Di.naturalWidth,height:Di.naturalHeight}})),hi(An=>({...An,[Qn]:!1})),ui(An=>({...An,[Qn]:!0})),ge.current&&ve.current){const An=ge.current;An.scrollTop=An.scrollHeight}},onError:()=>{hi(Br=>({...Br,[Qn]:!0})),ui(Br=>({...Br,[Qn]:!0}))},onClick:()=>{!ee.__pending&&!It&&Xe&&ha(Xe)}}),ds&&!It&&typeof ee.progress=="number"&&ee.progress<100&&e.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:e.jsx("div",{style:{width:`${ee.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`images-single-${ee.url||et}`)}const be=Je.slice(0,4),Ze=Je.length-be.length,Dt=(ee,et)=>{const it=ee?.metadata??{},Xe=`${ee?.url||et}`,Ye=Fs[Xe],st=Ye?.width||ee?.width||it?.width,It=Ye?.height||ee?.height||it?.height,Nt=typeof st=="number"&&typeof It=="number"&&st>0&&It>0?It/st:1;return Math.max(.2,Math.min(5,Number.isFinite(Nt)?Nt:1))},$t=(ee,et,it)=>{const Xe=ee.metadata??{},Ye=Ci(ee),st=!!(k?.isSecret&&Xe?.e2ee?.kind==="ciphertext"),It=st?Fn[ee.url]:void 0,Nt=st&&!Ye&&(!It||It.status==="pending"),Kn=st&&It?.status==="error",In=`${ee.url||et}`,Rn=!!_s[In],Ai=!!Os[In],Hr=ee.__pending||Nt||!Rn&&!Ai,Mn=ee.__pending||Nt||Kn||!Ye,mr=Dt(ee,et);return e.jsxs("button",{type:"button",className:"msg-media-tile",style:{aspectRatio:1/mr},disabled:Mn,onClick:()=>{!Mn&&Ye&&ha(Ye)},children:[Ye&&e.jsx("img",{src:Ye,alt:"img",style:{opacity:Rn&&!Hr?1:.001},onLoad:nn=>{const pn=nn.target;!ee.width&&!Xe?.width&&pn.naturalWidth&&pn.naturalHeight&&Xs(_t=>({..._t,[In]:{width:pn.naturalWidth,height:pn.naturalHeight}})),hi(_t=>({..._t,[In]:!1})),ui(_t=>({..._t,[In]:!0}))},onError:()=>{hi(nn=>({...nn,[In]:!0})),ui(nn=>({...nn,[In]:!0}))}}),Hr&&e.jsxs("div",{className:"msg-media-overlay",children:[e.jsx("div",{className:"msg-media-overlay-shimmer"}),Nt?e.jsx("div",{style:{position:"relative",zIndex:2,color:"var(--text-muted)",fontSize:12},children:"Расшифровка..."}):typeof ee.progress=="number"&&ee.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ee.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),(Kn||Ai)&&e.jsx("div",{className:"msg-media-overlay",style:{background:"rgba(15, 23, 42, 0.55)"},children:e.jsx("div",{style:{position:"relative",zIndex:2,color:"#f87171",fontSize:12,padding:10,textAlign:"center"},children:Kn?"Ошибка расшифровки":"Ошибка загрузки"})}),it&&e.jsxs("div",{className:"msg-media-more",children:["+",Ze]})]},`${ee.url||et}`)};return e.jsxs("div",{className:"msg-media-grid",children:[Ei&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:Ue}),!!fn&&e.jsx("span",{children:fn})]}),be.length===2&&(()=>{const ee=Dt(be[0],0),it=Dt(be[1],1),Xe=ee;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${it} 1 0`,minWidth:0},children:$t(be[0],0,!1)}),e.jsx("div",{style:{flex:`${Xe} 1 0`,minWidth:0},children:$t(be[1],1,Ze>0&&be.length-1===1)})]})})(),be.length===3&&(()=>{const ee=Dt(be[0],0),et=Dt(be[1],1),it=Dt(be[2],2),Xe=et+it,Ye=ee;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${Xe} 1 0`,minWidth:0},children:$t(be[0],0,!1)}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${Ye} 1 0`},children:[$t(be[1],1,!1),$t(be[2],2,Ze>0&&be.length-1===2)]})]})})(),be.length>=4&&(()=>{const ee=Dt(be[0],0),et=Dt(be[1],1),it=Dt(be[2],2),Xe=Dt(be[3],3),Ye=et+Xe,st=ee+it;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"msg-media-col",style:{flex:`${Ye} 1 0`},children:[$t(be[0],0,!1),$t(be[2],2,!1)]}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${st} 1 0`},children:[$t(be[1],1,!1),$t(be[3],3,Ze>0)]})]})})()]},"images-mosaic")};return e.jsx(e.Fragment,{children:tn.map((Je,be)=>{if(Je.kind==="imageGroup")return e.jsx(a.Fragment,{children:ls(Je.atts)},"images-group");const Ze=Je.att,Dt=Je.idx,$t=Ze.metadata??{},ee=Ci(Ze),et=!!(k?.isSecret&&$t?.e2ee?.kind==="ciphertext"),it=et?Fn[Ze.url]:void 0,Xe=et&&!ee&&(!it||it.status==="pending"),Ye=et&&it?.status==="error",st=$t?.e2ee?.originalName||Ze.url?.split("/").pop()||"вложение";if(Ze.type==="AUDIO"){const It=u.metadata?.duration||0,Nt=ee||Ze.url;return e.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:Xe?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[e.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{style:{fontSize:13},children:"Расшифровка аудио..."})]}):Ye?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать аудио"}):Nt?e.jsx(Rl,{url:Nt,duration:It}):e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Голосовое сообщение"})},`${Ze.url}-${Dt}-${be}`)}return e.jsxs("div",{style:{marginTop:8},children:[Ze.__pending||Xe?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Файл: ",st,Xe&&" (расшифровка...)"]}):Ye?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать файл"}):e.jsxs("a",{href:ee||Ze.url,target:"_blank",rel:"noreferrer",download:st,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Файл: ",st]}),typeof Ze.progress=="number"&&Ze.progress<100&&e.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:e.jsx("div",{style:{width:`${Ze.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${Ze.url}-${Dt}-${be}`)})})})()]}),(()=>{const F=u.attachments||[],ae=typeof u.content=="string"?u.content.trim().length>0:!!u.content,rt=F.some(tn=>tn?.type&&tn.type!=="IMAGE");return F.some(tn=>tn?.type==="IMAGE")&&!ae&&!rt?null:e.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[Ue," ",fn]})})()]})]},u.id)}):null})():e.jsx("div",{className:"messages-empty",children:"Сообщения появятся здесь"})}),s&&e.jsx("button",{className:Un?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{ge.current&&ge.current.scrollTo({top:ge.current.scrollHeight,behavior:"smooth"}),ve.current=!0,lt.current=!1,Mt(!1)},children:"↓"}),e.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:o=>{o.preventDefault(),qi(!0)},onDragLeave:()=>qi(!1),onDrop:async o=>{o.preventDefault(),qi(!1);const d=Array.from(o.dataTransfer.files||[]);if(!d.length||!s)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>Nr(p,"upload")),u.length&&await as(u)},children:k?.isSecret&&(!i||r)?e.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:c}):e.jsxs(e.Fragment,{children:[J&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsx(Wc,{size:16,color:"var(--text-muted)"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ответ на:"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:J.preview}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>fe(null),style:{marginLeft:"auto",flexShrink:0},children:e.jsx(Lt,{size:16})})]}),dn.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Изображения перед отправкой"}),e.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:dn.map(o=>e.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[e.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{oi===o.id&&en(null),Ka(o.id)},"aria-label":"Удалить изображение",children:e.jsx(Lt,{size:14})}),e.jsx("button",{type:"button",onClick:()=>en(o.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Редактировать изображение",children:e.jsx("img",{src:o.previewUrl,alt:o.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:o.fileName}),e.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>en(o.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Редактировать"}),o.edited&&e.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"Отредактировано"})]})]},o.id))})]}),e.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:Y,onChange:async o=>{const d=Array.from(o.target.files||[]);if(!s||d.length===0)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>Nr(p,"upload")),u.length&&await as(u),o.target.value=""}}),Ns?e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),e.jsx("div",{ref:Dr,style:{width:"100%",...M?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const u=M?60:zs;return Tr.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(u).fill(0).map((p,j)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${j*.1}s`,flexShrink:0}},j))}):e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:Tr.length>u?`translateX(-${(Tr.length-u)*4}px)`:"translateX(0)",transition:"none"},children:Tr.slice(-u).map((p,j)=>{const b=Math.max(4,p/100*20);return e.jsx("div",{style:{width:2,height:`${b}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${Tr.length-u+j}-${j}`)})})})()}),e.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor(Ls/60),":",(Ls%60).toString().padStart(2,"0")]})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:bo,style:{flexShrink:0},"aria-label":"Отменить запись",children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:oa,style:{flexShrink:0},"aria-label":"Отправить голосовое сообщение",children:e.jsx(Ra,{size:16})})]}):e.jsxs("form",{autoComplete:"off",onSubmit:async o=>{if(o.preventDefault(),!s)return;const d=$.trim();if(dn.length>0){const f=dn.map(u=>({file:u.file,previewUrl:u.previewUrl}));Ar([]),en(null),f.forEach(u=>Xn(u.previewUrl)),await as(f.map(u=>u.file),d||"",J?.id),H(""),fe(null)}else d&&(await Zs(k,{type:"TEXT",content:d,replyToId:J?.id}),H(""),fe(null));X.invalidateQueries({queryKey:["messages",s]}),setTimeout(()=>{ge.current&&(ge.current.scrollTop=ge.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>Y.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Прикрепить файлы",children:[e.jsx(Lc,{size:16}),!M&&e.jsx("span",{children:"Загрузить"})]}),e.jsx("input",{type:"text",placeholder:dn.length>0?"Добавьте подпись к изображениям...":"Напишите сообщение...",value:$,onChange:o=>H(o.target.value),onPaste:o=>{if(!s)return;const d=o.clipboardData?.items;if(d)for(let f=0;f<d.length;f++){const u=d[f];if(u.type.indexOf("image")!==-1){o.preventDefault();const p=u.getAsFile();p&&Nr(p,"paste");break}}},ref:T,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:vo,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Записать голосовое сообщение",children:[e.jsx(Ac,{size:16}),!M&&e.jsx("span",{children:"Голос"})]}),e.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,height:46,minHeight:46,padding:"0 12px"},children:[e.jsx(Ra,{size:16}),!M&&e.jsx("span",{children:"Отправить"})]})]}),qa&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:e.jsx("div",{style:{width:`${Va}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),e.jsx(a.Suspense,{fallback:null,children:h&&e.jsx(Cl,{open:!!h,conversationId:h,minimized:m===h,peerAvatarUrl:(()=>{const d=(h?ie.data?.find(f=>f.conversation.id===h)?.conversation:k)?.participants||[];return d.length===2?d.find(u=>Tt?u.user.id!==Tt:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const d=(h?ie.data?.find(u=>u.conversation.id===h)?.conversation:k)?.participants||[],f={};for(const u of d){const p=u.user,j=p.displayName??p.username??p.id;f[j]=p.avatarUrl??null}return N&&(f[N.displayName??N.username??N.id]=Gt.data?.avatarUrl??N.avatarUrl??null),f})(),avatarsById:(()=>{const d=(h?ie.data?.find(u=>u.conversation.id===h)?.conversation:k)?.participants||[],f={};for(const u of d){const p=u.user;f[p.id]=p.avatarUrl??null}return N&&(f[N.id]=Gt.data?.avatarUrl??N.avatarUrl??null),f})(),localUserId:N?.id??null,isGroup:!!(h?ie.data?.find(d=>d.conversation.id===h)?.conversation:k)?.isGroup,onMinimize:()=>{if(h){const o=h;S(o);const d=mi(o);!!!(d?.isGroup||(d?.participants?.length??0)>2)&&q.activeConvId!==o&&q.startOutgoing(o,q.initialVideo),h!==o&&y(o)}},onClose:o=>{const d=h??Yn.current;if(!d||m===d)return;const f=()=>{const u=mi(d),p=u?.participants?.length??0,j=!!(u?.isGroup||p>2);!j&&$r(d),kt(w=>{const C=w[d];if(!C)return w;if(j){const v=(C.participants||[]).filter(A=>Tt?A!==Tt:!0);return{...w,[d]:{...C,participants:v}}}return C.active?{...w,[d]:{...C,active:!1,endedAt:Date.now()}}:w}),y(w=>w===d?null:w),S(w=>w===d?null:w),q.endCall(),Bt()};!o?.manual&&dr(d)?ts(d,f):(Sn(d),f())},initialVideo:q.initialVideo,initialAudio:q.initialAudio})}),e.jsx(Zc,{open:!!gi,image:gi,onClose:()=>en(null),onApply:({file:o,previewUrl:d})=>{gi&&(Qa(gi.id,o,d),en(null))}}),x&&(()=>{const o=ie.data?.find(v=>v.conversation.id===x.conversationId)?.conversation,d=o?.isGroup||(o?.participants?.length??0)>2;if(d)return null;let f="Неизвестный",u,p=x.conversationId;if(d)f=o?.title??"Группа",u=o?.avatarUrl,p=x.conversationId;else{const v=o?.participants?.find(A=>A.user.id!==N?.id)?.user;if(v)f=v.displayName??v.username??v.id??"Неизвестный",u=v.avatarUrl,p=v.id;else{const A=bt.data?.find(U=>(U.conversationIds||[]).includes(x.conversationId));A?.friend&&(f=A.friend.displayName??A.friend.username??A.friend.id??"Неизвестный",u=A.friend.avatarUrl,p=A.friend.id)}}const j=Math.floor((Date.now()-x.startedAt)/1e3),b=Math.floor(j/60),w=j%60,C=`${b}:${w.toString().padStart(2,"0")}`;return br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700},children:x.video?"Видеозвонок":"Звонок"}),!x.minimized&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{R(v=>v?{...v,minimized:!0}:null)},style:{padding:8},children:e.jsx(Dc,{size:18})})]}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[e.jsx(tt,{name:f,id:p,size:64,avatarUrl:u}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:f}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"дозвон…"})]}),e.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:C})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{D.current&&(window.clearTimeout(D.current),D.current=null),qn(),Ii(),$r(x.conversationId),R(null),kt(v=>{const A=v[x.conversationId];if(A?.active)return{...v,[x.conversationId]:{...A,active:!1,endedAt:Date.now()}};const{[x.conversationId]:U,...W}=v;return W}),q.endCall()},children:[e.jsx(fs,{size:18}),e.jsx("span",{children:"Сбросить"})]}),x.minimized&&e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{R(v=>v?{...v,minimized:!1}:null)},children:[e.jsx(ka,{size:18}),e.jsx("span",{children:"Развернуть"})]})]})]})}),document.body)})(),q.incoming&&br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:12},children:q.incoming.video?"Входящий видеозвонок":"Входящий аудиозвонок"}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[e.jsx(tt,{name:q.incoming.from.name??q.incoming.from.id,id:q.incoming.from.id,size:64,avatarUrl:q.incoming.from.avatarUrl??ie.data?.find(o=>o.conversation.id===q.incoming.conversationId)?.conversation?.participants?.find(o=>o.user.id===q.incoming.from.id)?.user?.avatarUrl??bt.data?.find(o=>o.friend?.id===q.incoming.from.id)?.friend?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:q.incoming.from.name??q.incoming.from.id}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"звонит…"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{vi(!1)},children:[e.jsx(ps,{size:18}),e.jsx("span",{children:"Ответить"})]}),e.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{vi(!0)},children:[e.jsx(gs,{size:18}),e.jsx("span",{children:"Ответить с видео"})]})]}),e.jsx("div",{style:{display:"flex"},children:e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{rs()},children:[e.jsx(fs,{size:18}),e.jsx("span",{children:"Отмена"})]})}),ar&&e.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:ar})]})]})}),document.body)]})}function da(t,n){n&&X.setQueryData(["messages",t],r=>{const i=Array.isArray(r)?[...r]:[];return i.some(c=>c.id===n.id)||(i.push(n),i.sort((c,o)=>new Date(c.createdAt||0).getTime()-new Date(o.createdAt||0).getTime())),i})}function Co(t,n){n&&X.setQueryData(["messages",t],r=>{if(!Array.isArray(r))return r;const i=r.findIndex(o=>o.id===n.id);if(i===-1)return r;const c=[...r];return c[i]={...c[i],...n},c})}return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:M?"chats-page mobile-slider":"chats-page",children:M?e.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${Ge==="conversation"?"-100vw":"0"})`},onTouchStart:t=>{const n=t.touches[0];ut.current={x:n.clientX,y:n.clientY},qe.current=0},onTouchMove:t=>{if(!ut.current)return;const n=t.touches[0];qe.current=n.clientX-ut.current.x},onTouchEnd:()=>{const t=qe.current;ut.current=null,!(Math.abs(t)<50)&&(t<0&&s&&we("conversation"),t>0&&we("list"))},children:[ca(!0),la(!0)]}):e.jsxs(e.Fragment,{children:[ca(!1),la(!1)]})}),Ga&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Профиль"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Gr(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(tt,{name:N?.displayName??N?.username??"Me",id:N?.id??"me",avatarUrl:Pt??Gt.data?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:N?.displayName??N?.username}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Gt.data?.eblid??"— — — —"]})]})]}),e.jsx("input",{ref:Rs,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){Vr(n);try{Kr(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Pt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),e.jsxs("div",{onClick:()=>Rs.current?.click(),onDragOver:t=>{t.preventDefault(),Gi(!0)},onDragLeave:()=>Gi(!1),onDrop:t=>{t.preventDefault(),Gi(!1);const n=t.dataTransfer.files?.[0];if(n){Vr(n);try{Kr(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(As?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:As?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),Pt&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:$n,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ie.scale*(1+n))),i=$n.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Ie.scale,f=c-(c-Ie.x)*d,u=o-(o-Ie.y)*d;wn({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=$n.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,b=p-o;if(j*j+b*b>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,v={...Ie},A=W=>{W.preventDefault();const le=W.clientX-w,ue=W.clientY-C;wn({...v,x:v.x+le,y:v.y+ue})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Xi,src:Pt,alt:"preview",style:{position:"absolute",left:Ie.x,top:Ie.y,transform:`scale(${Ie.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=$n.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,b=o/f,w=Math.max(j,b)*1.2,C=u-d*w/2,v=p-f*w/2;wn({x:C,y:v,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Ie.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>wn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:10,step:.05,value:Ie.scale,onChange:t=>wn(n=>({...n,scale:parseFloat(t.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>wn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:e.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:M?"Два пальца для масштаба, один для перемещения":"Перетащите для перемещения, колесико мыши для масштаба"})})]}),e.jsx("canvas",{ref:Qr,width:240,height:240,style:{display:"none"}})]}),Fi&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{Vr(null),Pt&&URL.revokeObjectURL(Pt),Kr(null)},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:nr,onClick:async()=>{if(Fi){qr(!0),Jr(0);try{let t=null;if(Qr.current&&Pt){const i=await new Promise(v=>{const A=new Image;A.onload=()=>v(A),A.src=Pt}),c=Qr.current.getContext("2d"),o=240;c.clearRect(0,0,o,o),c.save(),c.beginPath(),c.arc(o/2,o/2,o/2,0,Math.PI*2),c.closePath(),c.clip();const d=$n.current?.clientWidth??320,f=$n.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-o/2,y:u.y-o/2,w:o,h:o},j=(p.x-Ie.x)/Ie.scale,b=(p.y-Ie.y)/Ie.scale,w=p.w/Ie.scale,C=p.h/Ie.scale;c.drawImage(i,j,b,w,C,0,0,o,o),c.restore(),t=await new Promise(v=>Qr.current.toBlob(A=>v(A),"image/png"))}const n=new FormData;n.append("file",t??Fi);const r=await new Promise((i,c)=>{const o=new XMLHttpRequest;o.open("POST","/api/upload");try{const d=Jn.getState().session?.accessToken;d&&o.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}o.upload.onprogress=d=>{d.lengthComputable&&Jr(Math.round(100*d.loaded/d.total))},o.onreadystatechange=()=>{if(o.readyState===4)if(o.status>=200&&o.status<300)try{const d=JSON.parse(o.responseText);i(d.url)}catch(d){c(d)}else c(new Error("upload failed"))},o.send(n)});await oe.patch("/status/me",{avatarUrl:r}),Vr(null),Pt&&URL.revokeObjectURL(Pt),Kr(null),Gt.refetch()}catch{}qr(!1),rr("Готово"),setTimeout(()=>rr(null),2200)}},children:nr?"Загрузка...":"Загрузить"})]}),nr&&e.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Is}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ii&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[e.jsx(Ca,{size:16}),e.jsx("span",{children:ii})]}),e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:e.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await oe.post("/auth/logout")}catch{}Jn.getState().setSession(null),Gr(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[e.jsx(hs,{size:18}),e.jsx("span",{children:"Выйти из Еблуши"})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Gr(!1),children:"Закрыть"})})]})}),Hn&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>vn(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Аватар группы"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>vn(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(tt,{name:vt.trim()||"?",id:"new-group-avatar-preview",avatarUrl:ln??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:vt||"Новая группа"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),e.jsx("input",{ref:Pi,type:"file",accept:"image/*",style:{display:"none"},onChange:t=>{const n=t.target.files?.[0];if(n){if(tr(n),je)try{URL.revokeObjectURL(je)}catch{}try{const r=URL.createObjectURL(n);Yt(r)}catch{Yt(null)}Jt({x:0,y:0,scale:1})}}}),!je&&e.jsx(e.Fragment,{children:e.jsxs("div",{onClick:()=>Pi.current?.click(),onDragOver:t=>{t.preventDefault(),Wi(!0)},onDragLeave:()=>Wi(!1),onDrop:t=>{t.preventDefault(),Wi(!1);const n=t.dataTransfer.files?.[0];if(n){if(tr(n),je)try{URL.revokeObjectURL(je)}catch{}try{const r=URL.createObjectURL(n);Yt(r)}catch{Yt(null)}Jt({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(ks?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:ks?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})}),je&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:Bn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ke.scale*(1+n))),i=Bn.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Ke.scale,f=c-(c-Ke.x)*d,u=o-(o-Ke.y)*d;Jt({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=Bn.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,b=p-o;if(j*j+b*b>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,v={...Ke},A=W=>{W.preventDefault();const le=W.clientX-w,ue=W.clientY-C;Jt({...v,x:v.x+le,y:v.y+ue})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:_a,src:je,alt:"preview",style:{position:"absolute",left:Ke.x,top:Ke.y,transform:`scale(${Ke.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=Bn.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,b=o/f,w=Math.max(j,b)*1.2,C=u-d*w/2,v=p-f*w/2;Jt({x:C,y:v,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Масштаб"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Jt(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Ke.scale,onChange:t=>{const n=parseFloat(t.target.value),r=Bn.current?.getBoundingClientRect();if(!r){Jt(u=>({...u,scale:n}));return}const i=r.width/2,c=r.height/2,o=n/Ke.scale,d=i-(i-Ke.x)*o,f=c-(c-Ke.y)*o;Jt({x:d,y:f,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Jt(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:Ui,width:240,height:240,style:{display:"none"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>{vn(!1)},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:!je,onClick:async()=>{if(!je||!Ui.current){vn(!1);return}try{const t=await new Promise(C=>{const v=new Image;v.onload=()=>C(v),v.src=je}),n=Ui.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const i=240;r.clearRect(0,0,i,i),r.save(),r.beginPath(),r.arc(i/2,i/2,i/2,0,Math.PI*2),r.closePath(),r.clip();const c=Bn.current?.clientWidth??320,o=Bn.current?.clientHeight??320,d={x:c/2,y:o/2},f={x:d.x-i/2,y:d.y-i/2,w:i,h:i},u=(f.x-Ke.x)/Ke.scale,p=(f.y-Ke.y)/Ke.scale,j=f.w/Ke.scale,b=f.h/Ke.scale;r.drawImage(t,u,p,j,b,0,0,i,i),r.restore();const w=await new Promise(C=>n.toBlob(v=>C(v),"image/png"));if(w){if(ln)try{URL.revokeObjectURL(ln)}catch{}const C=URL.createObjectURL(w);xn(w),St(C)}}catch{}finally{vn(!1)}},children:"Сохранить"})]})]})}),ze&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:is,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700},children:"Создать групповой чат"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:is,children:e.jsx(Lt,{size:16})})]}),(()=>{const t=vt.trim(),n=t||"?";return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[e.jsx("input",{placeholder:"Название",value:vt,onChange:r=>er(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),e.jsx("input",{ref:Pi,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const i=r.target.files?.[0];if(i){if(tr(i),je)try{URL.revokeObjectURL(je)}catch{}try{const c=URL.createObjectURL(i);Yt(c)}catch{Yt(null)}vn(!0)}}}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>vn(!0),title:"Выбрать аватар группы",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:e.jsx(tt,{name:n,id:"new-group-avatar",avatarUrl:ln??void 0,size:40})})]})})(),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Выберите участников"}),e.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:bt.data?.map(t=>{const n=t.friend,r=Qt.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Wn(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[e.jsx(tt,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Выбрано":"Нажмите, чтобы выбрать"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},t.id)})}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:e.jsx("button",{className:"btn btn-primary",disabled:Qt.length===0||Cr,onClick:async()=>{if(!(Qt.length===0||Cr)){Sr(!0);try{const t=await oe.post("/conversations",{participantIds:Qt,title:vt||void 0,isGroup:!0}),n=t.data?.conversation?.id;if(n&&(kr||Xr))try{const r=new FormData;r.append("file",kr??Xr);const i=await new Promise((c,o)=>{const d=new XMLHttpRequest;d.open("POST","/api/upload");try{const f=Jn.getState().session?.accessToken;f&&d.setRequestHeader("Authorization",`Bearer ${f}`)}catch{}d.onreadystatechange=()=>{if(d.readyState===4)if(d.status>=200&&d.status<300)try{const f=JSON.parse(d.responseText);c(f.url)}catch(f){o(f)}else o(new Error(`upload failed: ${d.status} ${d.statusText}`))},d.onerror=()=>o(new Error("Network error during upload")),d.send(r)});await oe.patch(`/conversations/${n}`,{avatarUrl:i})}catch(r){console.error("Error setting group avatar:",r)}X.invalidateQueries({queryKey:["conversations"]}),t.data?.conversation?.id&&ur(t.data.conversation.id),is()}catch(t){console.error("Error creating group:",t),alert(t?.response?.data?.message||"Не удалось создать беседу")}finally{Sr(!1)}}},children:Cr?"Создание...":"Создать"})})]})}),Oa&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("div",{style:{fontWeight:700},children:"Контакты"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Yr(!1),children:e.jsx(Lt,{size:16})})]}),Wt.data&&Wt.data.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Новые запросы"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:Wt.data.map(t=>e.jsxs("div",{className:"tile",children:[e.jsx(tt,{name:t.friend.displayName??t.friend.username,id:t.friend.id,presence:t.friend.status,avatarUrl:t.friend.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:t.friend.displayName??t.friend.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"хочет добавить вас"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await oe.post("/contacts/respond",{contactId:t.id,action:"reject"}),Wt.refetch()},children:"Отклонить"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{await oe.post("/contacts/respond",{contactId:t.id,action:"accept"}),bt.refetch(),Wt.refetch(),ie.refetch()},children:"Добавить"})]})]},t.id))})]}),e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"Поиск по EBLID"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(t=>e.jsx("input",{ref:Bi[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:Hi[t],onChange:n=>po(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},t))}),bn&&e.jsxs("div",{className:"tile",style:{marginBottom:12},children:[e.jsx(tt,{name:bn.displayName??bn.username,id:bn.id,presence:Gn(bn),avatarUrl:bn.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:bn.displayName??bn.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Найден по EBLID"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("button",{disabled:Xa,className:"btn btn-primary",onClick:mo,children:"Добавить"})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Мой EBLID:"}),e.jsx("div",{style:{fontWeight:700},children:Oi||"— — — —"}),e.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{Oi&&navigator.clipboard.writeText(Oi)},title:"Скопировать EBLID",children:e.jsx(jc,{size:16})})]}),e.jsx("div",{style:{marginTop:16,fontWeight:700},children:"Мои друзья"}),e.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(bt.data||[]).map(t=>{const n=t.friend;return e.jsxs("div",{className:"tile",children:[e.jsx(tt,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Контакт"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await oe.post("/contacts/remove",{contactId:t.id}),bt.refetch()},children:"Удалить"}),e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await Qs(n.id),Yr(!1),X.invalidateQueries({queryKey:["conversations"]})},children:"Секретный чат"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{const r=await oe.post("/conversations",{participantIds:[n.id],isGroup:!1});Yr(!1),ur(r.data.conversation.id),X.invalidateQueries({queryKey:["conversations"]})},children:"Открыть чат"})]})]},t.id)})})]})}),Me.open&&Me.messageId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Z({open:!1,x:0,y:0,messageId:null}),children:e.jsxs("div",{ref:Vs,className:"msg-menu",style:{position:"absolute",left:Me.x,top:Me.y,color:"#ffffff"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["👍","❤️","👎","🔥","🤝","😆"].map((t,n)=>{const i=t==="❤️"?"#ef4444":"#ffffff";return e.jsx("button",{onClick:async()=>{try{const c=Me.messageId;((Ht||[]).find(f=>f.id===c)?.reactions||[]).some(f=>f.userId===N?.id&&f.emoji===t)?await oe.post("/messages/unreact",{messageId:c,emoji:t}):await oe.post("/messages/react",{messageId:c,emoji:t}),s&&X.invalidateQueries({queryKey:["messages",s]})}catch{}Z({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:i,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${n*.05}s both`},onMouseEnter:c=>{c.currentTarget.style.transform="scale(1.2)"},onMouseLeave:c=>{c.currentTarget.style.transform="scale(1)"},children:t},t)})}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const t=Me.messageId,n=(Ht||[]).find(r=>r.id===t);fe({id:t,preview:(n?.content??"").slice(0,100)}),Z({open:!1,x:0,y:0,messageId:null})},children:"Цитировать"}),(()=>{const t=Me.messageId;return(Ht||[]).find(i=>i.id===t)?.senderId===N?.id?e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await oe.post("/messages/delete",{messageId:Me.messageId}),s&&X.invalidateQueries({queryKey:["messages",s]})}catch{}Z({open:!1,x:0,y:0,messageId:null})},children:"Удалить"}):null})(),e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const t=Me.messageId,n=(Ht||[]).find(r=>r.id===t);try{await navigator.clipboard.writeText(n?.content||"")}catch{}Z({open:!1,x:0,y:0,messageId:null})},children:"Копировать"}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{gt({open:!0,messageId:Me.messageId}),Z({open:!1,x:0,y:0,messageId:null})},children:"Переслать"})]})}),e.jsx(el,{open:Ir.open,items:Ir.items,index:Ir.index,onClose:()=>ir(t=>({...t,open:!1})),onIndexChange:t=>ir(n=>({...n,index:t}))}),ct.open&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>gt({open:!1,messageId:null}),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Переслать сообщение"}),e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(ie.data||[]).map(t=>{const n=t.conversation,i=n.participants.filter(o=>Tt?o.user.id!==Tt:!0).map(o=>o.user).map(o=>o.displayName??o.username).join(", ")||"Диалог",c=n.title??i;return e.jsx("div",{className:"tile",onClick:async()=>{const o=ct.messageId,d=(Ht||[]).find(f=>f.id===o);d&&(await Zs(n,{type:"TEXT",content:`↪ ${d.content??""}`,replyToId:void 0}),gt({open:!1,messageId:null}))},children:e.jsx("div",{style:{fontWeight:600},children:c})},n.id)})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>gt({open:!1,messageId:null}),children:"Отмена"})})]})}),mt&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:hr,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Добавить участников"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:hr,children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Из друзей"},{key:"eblid",label:"По EBLID"}].map(t=>{const n=cn===t.key;return e.jsx("button",{className:"btn btn-ghost",onClick:()=>g(t.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:t.label},t.key)})}),e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:cn==="friends"?"Выберите контакты, которых нужно пригласить в эту беседу.":"Введите EBLID пользователя, чтобы пригласить его в беседу."}),cn==="friends"?e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:ia.length===0?e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Все ваши контакты уже находятся в этой беседе."}):ia.map(t=>{const n=t.friend,r=Pn.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Zn(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[e.jsx(tt,{name:n.displayName??n.username,id:n.id,presence:Gn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:os(n)})]}),e.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},t.id)})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(t=>e.jsx("input",{ref:V[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:z[t],onChange:n=>oo(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},t))}),De&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ищем пользователя…"}),I&&e.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[e.jsx(tt,{name:I.displayName??I.username,id:I.id,presence:I.status,avatarUrl:I.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:I.displayName??I.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Si.alreadyInChat?"Уже в беседе":Si.isSelf?"Это вы":"Найден по EBLID"})]})]}),!I&&te&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:te})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[e.jsx("button",{className:"btn btn-secondary",onClick:hr,children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:jr||(cn==="friends"?Pn.length===0:!I||Si.alreadyInChat||Si.isSelf),onClick:cn==="friends"?so:ao,children:jr?"Добавление...":"Добавить"})]})]})}),Ee.open&&Ee.conversationId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Ft({open:!1,x:0,y:0,conversationId:null}),children:e.jsx("div",{ref:Vt,className:"msg-menu",style:{position:"absolute",left:Ee.x,top:Ee.y},onClick:t=>t.stopPropagation(),children:(()=>{const n=(ie.data||[]).find(c=>c.conversation.id===Ee.conversationId)?.conversation||(s===Ee.conversationId?k:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),i=async()=>{try{r?await oe.delete(`/conversations/${Ee.conversationId}/participants/me`):await oe.delete(`/conversations/${Ee.conversationId}`),X.invalidateQueries({queryKey:["conversations"]}),s===Ee.conversationId&&(l(null),M&&we("list"))}catch{}Ft({open:!1,x:0,y:0,conversationId:null})};return e.jsxs("button",{onClick:i,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?e.jsx(hs,{size:16}):e.jsx(Ea,{size:16}),r?"Выйти из беседы":"Удалить беседу"]})})()})}),wt.open&&wt.anchor&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>L({open:!1,anchor:null}),children:e.jsx("div",{ref:_,className:"msg-menu",style:{position:"fixed"},onClick:t=>t.stopPropagation(),children:(()=>{const t=k.isGroup||(k.participants?.length??0)>2,n=!!k.isSecret&&!t,r=!t&&k.participants?.find(i=>i.user.id!==Tt)?.user;return t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{Zn([]),g("friends"),E(["","","",""]),G(null),B(null),Ne(!1),zn(!0),L({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Ta,{size:16}),"Добавить участников"]}),e.jsxs("button",{onClick:async()=>{if(s){try{await oe.delete(`/conversations/${s}/participants/me`),X.invalidateQueries({queryKey:["conversations"]}),l(null),M&&we("list")}catch(i){console.error("Failed to leave conversation:",i)}L({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(hs,{size:16}),"Выйти из беседы"]})]}):e.jsxs(e.Fragment,{children:[n?e.jsxs("button",{onClick:()=>{Lr(!0),L({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(kc,{size:16}),"Завершить секретный чат"]}):e.jsxs("button",{onClick:async()=>{r?.id&&await Qs(r.id),L({open:!1,anchor:null})},disabled:Gs,style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Sa,{size:16}),"Начать секретный чат"]}),e.jsxs("button",{onClick:async()=>{if(s){try{await oe.delete(`/conversations/${s}`),X.invalidateQueries({queryKey:["conversations"]}),X.removeQueries({queryKey:["messages",s]}),l(null),M&&we("list")}catch(i){console.error("Failed to delete conversation:",i)}L({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(Ea,{size:16}),"Удалить чат"]})]})})()})}),xe&&k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>He(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Изменить аватар группы"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>He(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(tt,{name:k.title?.trim()?.charAt(0)||"Г",id:k.id,avatarUrl:Ut??k.avatarUrl??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:k.title||"Группа"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),e.jsx("input",{ref:Ms,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){ri(n);try{ti(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Ut&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),e.jsxs("div",{onClick:()=>Ms.current?.click(),onDragOver:t=>{t.preventDefault(),Yi(!0)},onDragLeave:()=>Yi(!1),onDrop:t=>{t.preventDefault(),Yi(!1);const n=t.dataTransfer.files?.[0];if(n){ri(n);try{ti(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Es?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Es?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(us,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),Ut&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),e.jsxs("div",{ref:jn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Re.scale*(1+n))),i=jn.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,o=t.clientY-i.top,d=r/Re.scale,f=c-(c-Re.x)*d,u=o-(o-Re.y)*d;Zt({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=jn.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,o=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,b=p-o;if(j*j+b*b>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const w=t.clientX,C=t.clientY,v={...Re},A=W=>{W.preventDefault();const le=W.clientX-w,ue=W.clientY-C;Zt({...v,x:v.x+le,y:v.y+ue})},U=()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",U)};window.addEventListener("pointermove",A,{passive:!1}),window.addEventListener("pointerup",U,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Zr,src:Ut,alt:"preview",style:{position:"absolute",left:Re.x,top:Re.y,transform:`scale(${Re.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=jn.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,o=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=o/d,b=o/f,w=Math.max(j,b)*1.2,C=u-d*w/2,v=p-f*w/2;Zt({x:C,y:v,scale:w})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Re.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Zt(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"−"}),e.jsx("input",{type:"range",min:.1,max:10,step:.01,value:Re.scale,onChange:t=>{const n=parseFloat(t.target.value);Zt(r=>{const i=jn.current?.getBoundingClientRect();if(!i)return{...r,scale:n};const c=i.width,o=i.height,d=c/2,f=o/2,u=Zr.current;if(u){const p=u.naturalWidth,j=u.naturalHeight,b=r.x+p*r.scale/2,w=r.y+j*r.scale/2,C=b-d,v=w-f,A=n/r.scale,U=d+C*A,W=f+v*A,le=U-p*n/2,ue=W-j*n/2;return{x:le,y:ue,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Zt(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:ei,width:240,height:240,style:{display:"none"}})]}),ni&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{ri(null),Ut&&URL.revokeObjectURL(Ut),ti(null),Zt({x:0,y:0,scale:1})},children:"Отмена"}),e.jsx("button",{className:"btn btn-primary",disabled:nr,onClick:async()=>{if(!(!ni||!k)){qr(!0),Jr(0);try{let t=null;if(ei.current&&Ut){const i=await new Promise(v=>{const A=new Image;A.onload=()=>v(A),A.src=Ut}),c=ei.current.getContext("2d");if(!c)throw new Error("Could not get 2d context from canvas");const o=240;c.clearRect(0,0,o,o),c.save(),c.beginPath(),c.arc(o/2,o/2,o/2,0,Math.PI*2),c.closePath(),c.clip();const d=jn.current?.clientWidth??320,f=jn.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-o/2,y:u.y-o/2,w:o,h:o},j=(p.x-Re.x)/Re.scale,b=(p.y-Re.y)/Re.scale,w=p.w/Re.scale,C=p.h/Re.scale;c.drawImage(i,j,b,w,C,0,0,o,o),c.restore(),t=await new Promise(v=>ei.current.toBlob(A=>v(A),"image/png"))}if(!t&&!ni)throw new Error("No file to upload");const n=new FormData;n.append("file",t??ni);const r=await new Promise((i,c)=>{const o=new XMLHttpRequest;o.open("POST","/api/upload");try{const d=Jn.getState().session?.accessToken;d&&o.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}o.upload.onprogress=d=>{d.lengthComputable&&Jr(Math.round(100*d.loaded/d.total))},o.onreadystatechange=()=>{if(o.readyState===4)if(o.status>=200&&o.status<300)try{const d=JSON.parse(o.responseText);i(d.url)}catch(d){c(d)}else c(new Error(`upload failed: ${o.status} ${o.statusText}`))},o.onerror=()=>{c(new Error("Network error during upload"))},o.send(n)});await oe.patch(`/conversations/${k.id}`,{avatarUrl:r}),X.setQueryData(["conversations"],i=>Array.isArray(i)?i.map(c=>c.conversation?.id===k.id?{...c,conversation:{...c.conversation,avatarUrl:r}}:c):i),X.invalidateQueries({queryKey:["conversations"]}),await ie.refetch(),ri(null),Ut&&URL.revokeObjectURL(Ut),ti(null),Zt({x:0,y:0,scale:1}),He(!1),rr("Готово"),setTimeout(()=>rr(null),2200)}catch(t){console.error("Error uploading group avatar:",t),rr(`Ошибка: ${t instanceof Error?t.message:"Неизвестная ошибка"}`),setTimeout(()=>rr(null),3e3)}finally{qr(!1)}}},children:nr?"Загрузка...":"Загрузить"})]}),nr&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Is}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ii&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[e.jsx(Ca,{size:16}),e.jsx("span",{children:ii})]})]})})]})}function Ua(s){return(s??[]).map(l=>l.user.id).sort().join(",")}const zl=Object.freeze(Object.defineProperty({__proto__:null,default:Ml},Symbol.toStringTag,{value:"Module"}));export{zl as C,Lt as X};
