import{r as h}from"./vendor-query-D8-W16Rz.js";var $s={};function Cu(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var Eu=Object.defineProperty,wu=(n,e,t)=>e in n?Eu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Qs=(n,e,t)=>wu(n,typeof e!="symbol"?e+"":e,t);class Ce{constructor(){Qs(this,"_locking"),Qs(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),i}}function Z(n,e){if(!n)throw new Error(e)}const Pu=34028234663852886e22,Ru=-34028234663852886e22,_u=4294967295,Iu=2147483647,xu=-2147483648;function Jn(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>Iu||n<xu)throw new Error("invalid int 32: "+n)}function yr(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>_u||n<0)throw new Error("invalid uint 32: "+n)}function Oa(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>Pu||n<Ru))throw new Error("invalid float 32: "+n)}const Ma=Symbol("@bufbuild/protobuf/enum-type");function Ou(n){const e=n[Ma];return Z(e,"missing enum type on enum object"),e}function Aa(n,e,t,i){n[Ma]=Da(e,t.map(r=>({no:r.no,name:r.name,localName:n[r.no]})))}function Da(n,e,t){const i=Object.create(null),r=Object.create(null),s=[];for(const o of e){const a=Na(o);s.push(a),i[o.name]=a,r[o.no]=a}return{typeName:n,values:s,findName(o){return i[o]},findNumber(o){return r[o]}}}function Mu(n,e,t){const i={};for(const r of e){const s=Na(r);i[s.localName]=s.no,i[s.no]=s.localName}return Aa(i,n,e),i}function Na(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}class rs{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(t);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,t){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(t);return r.readMessage(i,e,s,this),this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e?.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function Au(n,e,t,i){var r;const s=(r=i?.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),o={[s]:function(a){n.util.initFields(this),n.util.initPartial(a,this)}}[s];return Object.setPrototypeOf(o.prototype,new rs),Object.assign(o,{runtime:n,typeName:e,fields:n.util.newFieldList(t),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return n.util.equals(o,a,c)}}),o}function Du(){let n=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(n|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}let t=this.buf[this.pos++];if(n|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[n,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}throw new Error("invalid varint")}function $i(n,e,t){for(let s=0;s<28;s=s+7){const o=n>>>s,a=!(!(o>>>7)&&e==0),c=(a?o|128:o)&255;if(t.push(c),!a)return}const i=n>>>28&15|(e&7)<<4,r=e>>3!=0;if(t.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const o=e>>>s,a=!!(o>>>7),c=(a?o|128:o)&255;if(t.push(c),!a)return}t.push(e>>>31&1)}}const $n=4294967296;function Ys(n){const e=n[0]==="-";e&&(n=n.slice(1));const t=1e6;let i=0,r=0;function s(o,a){const c=Number(n.slice(o,a));r*=t,i=i*t+c,i>=$n&&(r=r+(i/$n|0),i=i%$n)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?Ua(i,r):ss(i,r)}function Nu(n,e){let t=ss(n,e);const i=t.hi&2147483648;i&&(t=Ua(t.lo,t.hi));const r=La(t.lo,t.hi);return i?"-"+r:r}function La(n,e){if({lo:n,hi:e}=Lu(n,e),e<=2097151)return String($n*e+n);const t=n&16777215,i=(n>>>24|e<<8)&16777215,r=e>>16&65535;let s=t+i*6777216+r*6710656,o=i+r*8147497,a=r*2;const c=1e7;return s>=c&&(o+=Math.floor(s/c),s%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+Xs(o)+Xs(s)}function Lu(n,e){return{lo:n>>>0,hi:e>>>0}}function ss(n,e){return{lo:n|0,hi:e|0}}function Ua(n,e){return e=~e,n?n=~n+1:e+=1,ss(n,e)}const Xs=n=>{const e=String(n);return"0000000".slice(e.length)+e};function Zs(n,e){if(n>=0){for(;n>127;)e.push(n&127|128),n=n>>>7;e.push(n)}else{for(let t=0;t<9;t++)e.push(n&127|128),n=n>>7;e.push(1)}}function Uu(){let n=this.buf[this.pos++],e=n&127;if((n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<7,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<14,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<21,(n&128)==0)return this.assertBounds(),e;n=this.buf[this.pos++],e|=(n&15)<<28;for(let t=5;(n&128)!==0&&t<10;t++)n=this.buf[this.pos++];if((n&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function Fu(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof $s!="object"||$s.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>a||l<o)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return n.setBigInt64(0,this.parse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(c){return n.setBigInt64(0,this.uParse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigInt64(0,!0)},uDec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigUint64(0,!0)}}}const t=r=>Z(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>Z(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),Ys(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),Ys(r)},dec(r,s){return Nu(r,s)},uDec(r,s){return La(r,s)}}}const Q=Fu();var M;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(M||(M={}));var Pt;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(Pt||(Pt={}));function vt(n,e,t){if(e===t)return!0;if(n==M.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}switch(n){case M.UINT64:case M.FIXED64:case M.INT64:case M.SFIXED64:case M.SINT64:return e==t}return!1}function sn(n,e){switch(n){case M.BOOL:return!1;case M.UINT64:case M.FIXED64:case M.INT64:case M.SFIXED64:case M.SINT64:return e==0?Q.zero:"0";case M.DOUBLE:case M.FLOAT:return 0;case M.BYTES:return new Uint8Array(0);case M.STRING:return"";default:return 0}}function Fa(n,e){switch(n){case M.BOOL:return e===!1;case M.STRING:return e==="";case M.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var te;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(te||(te={}));class ju{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(yr(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Jn(e),Zs(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Oa(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){yr(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Jn(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Jn(e),e=(e<<1^e>>31)>>>0,Zs(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=Q.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=Q.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=Q.enc(e);return $i(t.lo,t.hi,this.buf),this}sint64(e){let t=Q.enc(e),i=t.hi>>31,r=t.lo<<1^i,s=(t.hi<<1|t.lo>>>31)^i;return $i(r,s,this.buf),this}uint64(e){let t=Q.uEnc(e);return $i(t.lo,t.hi,this.buf),this}}class Bu{constructor(e,t){this.varint64=Du,this.uint32=Uu,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e,t){let i=this.pos;switch(e){case te.Varint:for(;this.buf[this.pos++]&128;);break;case te.Bit64:this.pos+=4;case te.Bit32:this.pos+=4;break;case te.LengthDelimited:let r=this.uint32();this.pos+=r;break;case te.StartGroup:for(;;){const[s,o]=this.tag();if(o===te.EndGroup){if(t!==void 0&&s!==t)throw new Error("invalid end group tag");break}this.skip(o,s)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return Q.dec(...this.varint64())}uint64(){return Q.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(e&1);return e=(e>>>1|(t&1)<<31)^i,t=t>>>1^i,Q.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return Q.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return Q.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function Vu(n,e,t,i){let r;return{typeName:e,extendee:t,get field(){if(!r){const s=typeof i=="function"?i():i;s.name=e.split(".").pop(),s.jsonName="[".concat(e,"]"),r=n.util.newFieldList([s]).list()[0]}return r},runtime:n}}function ja(n){const e=n.field.localName,t=Object.create(null);return t[e]=qu(n),[t,()=>t[e]]}function qu(n){const e=n.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return sn(e.T,e.L);case"message":const t=e.T,i=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function Wu(n,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=n.length-1;t>=0;--t)if(n[t].no==e.no)return[n[t]];return[]}return n.filter(t=>t.no===e.no)}let st="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),_i=[];for(let n=0;n<st.length;n++)_i[st[n].charCodeAt(0)]=n;_i[45]=st.indexOf("+");_i[95]=st.indexOf("/");const Ba={dec(n){let e=n.length*3/4;n[n.length-2]=="="?e-=2:n[n.length-1]=="="&&(e-=1);let t=new Uint8Array(e),i=0,r=0,s,o=0;for(let a=0;a<n.length;a++){if(s=_i[n.charCodeAt(a)],s===void 0)switch(n[a]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:o=s,r=1;break;case 1:t[i++]=o<<2|(s&48)>>4,o=s,r=2;break;case 2:t[i++]=(o&15)<<4|(s&60)>>2,o=s,r=3;break;case 3:t[i++]=(o&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,i)},enc(n){let e="",t=0,i,r=0;for(let s=0;s<n.length;s++)switch(i=n[s],t){case 0:e+=st[i>>2],r=(i&3)<<4,t=1;break;case 1:e+=st[r|i>>4],r=(i&15)<<2,t=2;break;case 2:e+=st[r|i>>6],e+=st[i&63],t=0;break}return t&&(e+=st[r],e+="=",t==1&&(e+="=")),e}};function zu(n,e,t){qa(e,n);const i=e.runtime.bin.makeReadOptions(t),r=Wu(n.getType().runtime.bin.listUnknownFields(n),e.field),[s,o]=ja(e);for(const a of r)e.runtime.bin.readField(s,i.readerFactory(a.data),e.field,a.wireType,i);return o()}function Hu(n,e,t,i){qa(e,n);const r=e.runtime.bin.makeReadOptions(i),s=e.runtime.bin.makeWriteOptions(i);if(Va(n,e)){const l=n.getType().runtime.bin.listUnknownFields(n).filter(u=>u.no!=e.field.no);n.getType().runtime.bin.discardUnknownFields(n);for(const u of l)n.getType().runtime.bin.onUnknownField(n,u.no,u.wireType,u.data)}const o=s.writerFactory();let a=e.field;!a.opt&&!a.repeated&&(a.kind=="enum"||a.kind=="scalar")&&(a=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(a,t,o,s);const c=r.readerFactory(o.finish());for(;c.pos<c.len;){const[l,u]=c.tag(),d=c.skip(u,l);n.getType().runtime.bin.onUnknownField(n,l,u,d)}}function Va(n,e){const t=n.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(n).find(i=>i.no==e.field.no)}function qa(n,e){Z(n.extendee.typeName==e.getType().typeName,"extension ".concat(n.typeName," can only be applied to message ").concat(n.extendee.typeName))}function Wa(n,e){const t=n.localName;if(n.repeated)return e[t].length>0;if(n.oneof)return e[n.oneof.localName].case===t;switch(n.kind){case"enum":case"scalar":return n.opt||n.req?e[t]!==void 0:n.kind=="enum"?e[t]!==n.T.values[0].no:!Fa(n.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function eo(n,e){const t=n.localName,i=!n.opt&&!n.req;if(n.repeated)e[t]=[];else if(n.oneof)e[n.oneof.localName]={case:void 0};else switch(n.kind){case"map":e[t]={};break;case"enum":e[t]=i?n.T.values[0].no:void 0;break;case"scalar":e[t]=i?sn(n.T,n.L):void 0;break;case"message":e[t]=void 0;break}}function ot(n,e){if(n===null||typeof n!="object"||!Object.getOwnPropertyNames(rs.prototype).every(i=>i in n&&typeof n[i]=="function"))return!1;const t=n.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function za(n,e){return ot(e)||!n.fieldWrapper?e:n.fieldWrapper.wrapField(e)}M.DOUBLE,M.FLOAT,M.INT64,M.UINT64,M.INT32,M.UINT32,M.BOOL,M.STRING,M.BYTES;const to={ignoreUnknownFields:!1},no={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Ku(n){return n?Object.assign(Object.assign({},to),n):to}function Gu(n){return n?Object.assign(Object.assign({},no),n):no}const ci=Symbol(),Qn=Symbol();function Ju(){return{makeReadOptions:Ku,makeWriteOptions:Gu,readMessage(n,e,t,i){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(n.typeName," from JSON: ").concat(Je(e)));i=i??new n;const r=new Map,s=t.typeRegistry;for(const[o,a]of Object.entries(e)){const c=n.fields.findJsonName(o);if(c){if(c.oneof){if(a===null&&c.kind=="scalar")continue;const l=r.get(c.oneof);if(l!==void 0)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(l,'", "').concat(o,'"'));r.set(c.oneof,o)}io(i,a,c,t,n)}else{let l=!1;if(s?.findExtension&&o.startsWith("[")&&o.endsWith("]")){const u=s.findExtension(o.substring(1,o.length-1));if(u&&u.extendee.typeName==n.typeName){l=!0;const[d,f]=ja(u);io(d,a,u.field,t,u),Hu(i,u,f(),t)}}if(!l&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return i},writeMessage(n,e){const t=n.getType(),i={};let r;try{for(r of t.fields.byNumber()){if(!Wa(r,n)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!Qu(r))continue}const o=r.oneof?n[r.oneof.localName].value:n[r.localName],a=ro(r,o,e);a!==void 0&&(i[e.useProtoFieldName?r.name:r.jsonName]=a)}const s=e.typeRegistry;if(s?.findExtensionFor)for(const o of t.runtime.bin.listUnknownFields(n)){const a=s.findExtensionFor(t.typeName,o.no);if(a&&Va(n,a)){const c=zu(n,a,e),l=ro(a.field,c,e);l!==void 0&&(i[a.field.jsonName]=l)}}}catch(s){const o=r?"cannot encode field ".concat(t.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),a=s instanceof Error?s.message:String(s);throw new Error(o+(a.length>0?": ".concat(a):""))}return i},readScalar(n,e,t){return En(n,e,t??Pt.BIGINT,!0)},writeScalar(n,e,t){if(e!==void 0&&(t||Fa(n,e)))return Yn(n,e)},debug:Je}}function Je(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function io(n,e,t,i,r){let s=t.localName;if(t.repeated){if(Z(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(e)));const o=n[s];for(const a of e){if(a===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(a)));switch(t.kind){case"message":o.push(t.T.fromJson(a,i));break;case"enum":const c=Qi(t.T,a,i.ignoreUnknownFields,!0);c!==Qn&&o.push(c);break;case"scalar":try{o.push(En(t.T,a,t.L,!0))}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(a));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(e)));const o=n[s];for(const[a,c]of Object.entries(e)){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: map value null"));let l;try{l=$u(t.K,a)}catch(u){let d="cannot decode map key for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(e));throw u instanceof Error&&u.message.length>0&&(d+=": ".concat(u.message)),new Error(d)}switch(t.V.kind){case"message":o[l]=t.V.T.fromJson(c,i);break;case"enum":const u=Qi(t.V.T,c,i.ignoreUnknownFields,!0);u!==Qn&&(o[l]=u);break;case"scalar":try{o[l]=En(t.V.T,c,Pt.BIGINT,!0)}catch(d){let f="cannot decode map value for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(e));throw d instanceof Error&&d.message.length>0&&(f+=": ".concat(d.message)),new Error(f)}break}}}else switch(t.oneof&&(n=n[t.oneof.localName]={case:s},s="value"),t.kind){case"message":const o=t.T;if(e===null&&o.typeName!="google.protobuf.Value")return;let a=n[s];ot(a)?a.fromJson(e,i):(n[s]=a=o.fromJson(e,i),o.fieldWrapper&&!t.oneof&&(n[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=Qi(t.T,e,i.ignoreUnknownFields,!1);switch(c){case ci:eo(t,n);break;case Qn:break;default:n[s]=c;break}break;case"scalar":try{const l=En(t.T,e,t.L,!1);switch(l){case ci:eo(t,n);break;default:n[s]=l;break}}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Je(e));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}function $u(n,e){if(n===M.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return En(n,e,Pt.BIGINT,!0).toString()}function En(n,e,t,i){if(e===null)return i?sn(n,t):ci;switch(n){case M.DOUBLE:case M.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return n==M.FLOAT&&Oa(r),r;case M.INT32:case M.FIXED32:case M.SFIXED32:case M.SINT32:case M.UINT32:let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return n==M.UINT32||n==M.FIXED32?yr(s):Jn(s),s;case M.INT64:case M.SFIXED64:case M.SINT64:if(typeof e!="number"&&typeof e!="string")break;const o=Q.parse(e);return t?o.toString():o;case M.FIXED64:case M.UINT64:if(typeof e!="number"&&typeof e!="string")break;const a=Q.uParse(e);return t?a.toString():a;case M.BOOL:if(typeof e!="boolean")break;return e;case M.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case M.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return Ba.dec(e)}throw new Error}function Qi(n,e,t,i){if(e===null)return n.typeName=="google.protobuf.NullValue"?0:i?n.values[0].no:ci;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=n.findName(e);if(r!==void 0)return r.no;if(t)return Qn;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(Je(e)))}function Qu(n){return n.repeated||n.kind=="map"?!0:!(n.oneof||n.kind=="message"||n.opt||n.req)}function ro(n,e,t){if(n.kind=="map"){Z(typeof e=="object"&&e!=null);const i={},r=Object.entries(e);switch(n.V.kind){case"scalar":for(const[o,a]of r)i[o.toString()]=Yn(n.V.T,a);break;case"message":for(const[o,a]of r)i[o.toString()]=a.toJson(t);break;case"enum":const s=n.V.T;for(const[o,a]of r)i[o.toString()]=Yi(s,a,t.enumAsInteger);break}return t.emitDefaultValues||r.length>0?i:void 0}if(n.repeated){Z(Array.isArray(e));const i=[];switch(n.kind){case"scalar":for(let r=0;r<e.length;r++)i.push(Yn(n.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)i.push(Yi(n.T,e[r],t.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)i.push(e[r].toJson(t));break}return t.emitDefaultValues||i.length>0?i:void 0}switch(n.kind){case"scalar":return Yn(n.T,e);case"enum":return Yi(n.T,e,t.enumAsInteger);case"message":return za(n.T,e).toJson(t)}}function Yi(n,e,t){var i;if(Z(typeof e=="number"),n.typeName=="google.protobuf.NullValue")return null;if(t)return e;const r=n.findNumber(e);return(i=r?.name)!==null&&i!==void 0?i:e}function Yn(n,e){switch(n){case M.INT32:case M.SFIXED32:case M.SINT32:case M.FIXED32:case M.UINT32:return Z(typeof e=="number"),e;case M.FLOAT:case M.DOUBLE:return Z(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case M.STRING:return Z(typeof e=="string"),e;case M.BOOL:return Z(typeof e=="boolean"),e;case M.UINT64:case M.FIXED64:case M.INT64:case M.SFIXED64:case M.SINT64:return Z(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case M.BYTES:return Z(e instanceof Uint8Array),Ba.enc(e)}}const Kt=Symbol("@bufbuild/protobuf/unknown-fields"),so={readUnknownFields:!0,readerFactory:n=>new Bu(n)},oo={writeUnknownFields:!0,writerFactory:()=>new ju};function Yu(n){return n?Object.assign(Object.assign({},so),n):so}function Xu(n){return n?Object.assign(Object.assign({},oo),n):oo}function Zu(){return{makeReadOptions:Yu,makeWriteOptions:Xu,listUnknownFields(n){var e;return(e=n[Kt])!==null&&e!==void 0?e:[]},discardUnknownFields(n){delete n[Kt]},writeUnknownFields(n,e){const i=n[Kt];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(n,e,t,i){const r=n;Array.isArray(r[Kt])||(r[Kt]=[]),r[Kt].push({no:e,wireType:t,data:i})},readMessage(n,e,t,i,r){const s=n.getType(),o=r?e.len:e.pos+t;let a,c;for(;e.pos<o&&([a,c]=e.tag(),!(r===!0&&c==te.EndGroup));){const l=s.fields.find(a);if(!l){const u=e.skip(c,a);i.readUnknownFields&&this.onUnknownField(n,a,c,u);continue}ao(n,e,l,c,i)}if(r&&(c!=te.EndGroup||a!==t))throw new Error("invalid end group tag")},readField:ao,writeMessage(n,e,t){const i=n.getType();for(const r of i.fields.byNumber()){if(!Wa(r,n)){if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?n[r.oneof.localName].value:n[r.localName];co(r,s,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(n,e),e},writeField(n,e,t,i){e!==void 0&&co(n,e,t,i)}}}function ao(n,e,t,i,r){let{repeated:s,localName:o}=t;switch(t.oneof&&(n=n[t.oneof.localName],n.case!=o&&delete n.value,n.case=o,o="value"),t.kind){case"scalar":case"enum":const a=t.kind=="enum"?M.INT32:t.T;let c=li;if(t.kind=="scalar"&&t.L>0&&(c=td),s){let f=n[o];if(i==te.LengthDelimited&&a!=M.STRING&&a!=M.BYTES){let g=e.uint32()+e.pos;for(;e.pos<g;)f.push(c(e,a))}else f.push(c(e,a))}else n[o]=c(e,a);break;case"message":const l=t.T;s?n[o].push(Xn(e,new l,r,t)):ot(n[o])?Xn(e,n[o],r,t):(n[o]=Xn(e,new l,r,t),l.fieldWrapper&&!t.oneof&&!t.repeated&&(n[o]=l.fieldWrapper.unwrapField(n[o])));break;case"map":let[u,d]=ed(t,e,r);n[o][u]=d;break}}function Xn(n,e,t,i){const r=e.getType().runtime.bin,s=i?.delimited;return r.readMessage(e,n,s?i.no:n.uint32(),t,s),e}function ed(n,e,t){const i=e.uint32(),r=e.pos+i;let s,o;for(;e.pos<r;){const[a]=e.tag();switch(a){case 1:s=li(e,n.K);break;case 2:switch(n.V.kind){case"scalar":o=li(e,n.V.T);break;case"enum":o=e.int32();break;case"message":o=Xn(e,new n.V.T,t,void 0);break}break}}if(s===void 0&&(s=sn(n.K,Pt.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),o===void 0)switch(n.V.kind){case"scalar":o=sn(n.V.T,Pt.BIGINT);break;case"enum":o=n.V.T.values[0].no;break;case"message":o=new n.V.T;break}return[s,o]}function td(n,e){const t=li(n,e);return typeof t=="bigint"?t.toString():t}function li(n,e){switch(e){case M.STRING:return n.string();case M.BOOL:return n.bool();case M.DOUBLE:return n.double();case M.FLOAT:return n.float();case M.INT32:return n.int32();case M.INT64:return n.int64();case M.UINT64:return n.uint64();case M.FIXED64:return n.fixed64();case M.BYTES:return n.bytes();case M.FIXED32:return n.fixed32();case M.SFIXED32:return n.sfixed32();case M.SFIXED64:return n.sfixed64();case M.SINT64:return n.sint64();case M.UINT32:return n.uint32();case M.SINT32:return n.sint32()}}function co(n,e,t,i){Z(e!==void 0);const r=n.repeated;switch(n.kind){case"scalar":case"enum":let s=n.kind=="enum"?M.INT32:n.T;if(r)if(Z(Array.isArray(e)),n.packed)id(t,s,n.no,e);else for(const o of e)wn(t,s,n.no,o);else wn(t,s,n.no,e);break;case"message":if(r){Z(Array.isArray(e));for(const o of e)lo(t,i,n,o)}else lo(t,i,n,e);break;case"map":Z(typeof e=="object"&&e!=null);for(const[o,a]of Object.entries(e))nd(t,i,n,o,a);break}}function nd(n,e,t,i,r){n.tag(t.no,te.LengthDelimited),n.fork();let s=i;switch(t.K){case M.INT32:case M.FIXED32:case M.UINT32:case M.SFIXED32:case M.SINT32:s=Number.parseInt(i);break;case M.BOOL:Z(i=="true"||i=="false"),s=i=="true";break}switch(wn(n,t.K,1,s),t.V.kind){case"scalar":wn(n,t.V.T,2,r);break;case"enum":wn(n,M.INT32,2,r);break;case"message":Z(r!==void 0),n.tag(2,te.LengthDelimited).bytes(r.toBinary(e));break}n.join()}function lo(n,e,t,i){const r=za(t.T,i);t.delimited?n.tag(t.no,te.StartGroup).raw(r.toBinary(e)).tag(t.no,te.EndGroup):n.tag(t.no,te.LengthDelimited).bytes(r.toBinary(e))}function wn(n,e,t,i){Z(i!==void 0);let[r,s]=Ha(e);n.tag(t,r)[s](i)}function id(n,e,t,i){if(!i.length)return;n.tag(t,te.LengthDelimited).fork();let[,r]=Ha(e);for(let s=0;s<i.length;s++)n[r](i[s]);n.join()}function Ha(n){let e=te.Varint;switch(n){case M.BYTES:case M.STRING:e=te.LengthDelimited;break;case M.DOUBLE:case M.FIXED64:case M.SFIXED64:e=te.Bit64;break;case M.FIXED32:case M.SFIXED32:case M.FLOAT:e=te.Bit32;break}const t=M[n].toLowerCase();return[e,t]}function rd(){return{setEnumType:Aa,initPartial(n,e){if(n===void 0)return;const t=e.getType();for(const i of t.fields.byMember()){const r=i.localName,s=e,o=n;if(o[r]!=null)switch(i.kind){case"oneof":const a=o[r].case;if(a===void 0)continue;const c=i.findField(a);let l=o[r].value;c&&c.kind=="message"&&!ot(l,c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===M.BYTES&&(l=pn(l)),s[r]={case:a,value:l};break;case"scalar":case"enum":let u=o[r];i.T===M.BYTES&&(u=i.repeated?u.map(pn):pn(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===M.BYTES)for(const[p,g]of Object.entries(o[r]))s[r][p]=pn(g);else Object.assign(s[r],o[r]);break;case"message":const f=i.V.T;for(const p of Object.keys(o[r])){let g=o[r][p];f.fieldWrapper||(g=new f(g)),s[r][p]=g}break}break;case"message":const d=i.T;if(i.repeated)s[r]=o[r].map(f=>ot(f,d)?f:new d(f));else{const f=o[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=pn(f):s[r]=f:s[r]=ot(f,d)?f:new d(f)}break}}},equals(n,e,t){return e===t?!0:!e||!t?!1:n.fields.byMember().every(i=>{const r=e[i.localName],s=t[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((o,a)=>i.T.equals(o,s[a]));case"scalar":return r.every((o,a)=>vt(i.T,o,s[a]));case"enum":return r.every((o,a)=>vt(M.INT32,o,s[a]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":let o=r,a=s;return i.T.fieldWrapper&&(o!==void 0&&!ot(o)&&(o=i.T.fieldWrapper.wrapField(o)),a!==void 0&&!ot(a)&&(a=i.T.fieldWrapper.wrapField(a))),i.T.equals(o,a);case"enum":return vt(M.INT32,r,s);case"scalar":return vt(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const c=i.findField(r.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(r.value,s.value);case"enum":return vt(M.INT32,r.value,s.value);case"scalar":return vt(c.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const l=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const u=i.V.T;return l.every(f=>u.equals(r[f],s[f]));case"enum":return l.every(f=>vt(M.INT32,r[f],s[f]));case"scalar":const d=i.V.T;return l.every(f=>vt(d,r[f],s[f]))}break}})},clone(n){const e=n.getType(),t=new e,i=t;for(const r of e.fields.byMember()){const s=n[r.localName];let o;if(r.repeated)o=s.map(qn);else if(r.kind=="map"){o=i[r.localName];for(const[a,c]of Object.entries(s))o[a]=qn(c)}else r.kind=="oneof"?o=r.findField(s.case)?{case:s.case,value:qn(s.value)}:{case:void 0}:o=qn(s);i[r.localName]=o}for(const r of e.runtime.bin.listUnknownFields(n))e.runtime.bin.onUnknownField(i,r.no,r.wireType,r.data);return t}}}function qn(n){if(n===void 0)return n;if(ot(n))return n.clone();if(n instanceof Uint8Array){const e=new Uint8Array(n.byteLength);return e.set(n),e}return n}function pn(n){return n instanceof Uint8Array?n:new Uint8Array(n)}function sd(n,e,t){return{syntax:n,json:Ju(),bin:Zu(),util:Object.assign(Object.assign({},rd()),{newFieldList:e,initFields:t}),makeMessageType(i,r,s){return Au(this,i,r,s)},makeEnum:Mu,makeEnumType:Da,getEnumType:Ou,makeExtension(i,r,s){return Vu(this,i,r,s)}}}class od{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const i of this.list())t[i.jsonName]=t[i.name]=i;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const i of this.list())t[i.no]=i;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())i.oneof?i.oneof!==t&&(t=i.oneof,e.push(t)):e.push(i)}return this.members}}function Ka(n,e){const t=Ga(n);return e?t:hd(dd(t))}function ad(n){return Ka(n,!1)}const cd=Ga;function Ga(n){let e=!1;const t=[];for(let i=0;i<n.length;i++){let r=n.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const ld=new Set(["constructor","toString","toJSON","valueOf"]),ud=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Ja=n=>"".concat(n,"$"),dd=n=>ud.has(n)?Ja(n):n,hd=n=>ld.has(n)?Ja(n):n;class fd{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=ad(e)}addField(e){Z(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function pd(n,e){var t,i,r,s,o,a;const c=[];let l;for(const u of typeof n=="function"?n():n){const d=u;if(d.localName=Ka(u.name,u.oneof!==void 0),d.jsonName=(t=u.jsonName)!==null&&t!==void 0?t:cd(u.name),d.repeated=(i=u.repeated)!==null&&i!==void 0?i:!1,u.kind=="scalar"&&(d.L=(r=u.L)!==null&&r!==void 0?r:Pt.BIGINT),d.delimited=(s=u.delimited)!==null&&s!==void 0?s:!1,d.req=(o=u.req)!==null&&o!==void 0?o:!1,d.opt=(a=u.opt)!==null&&a!==void 0?a:!1,u.packed===void 0&&(d.packed=u.kind=="enum"||u.kind=="scalar"&&u.T!=M.BYTES&&u.T!=M.STRING),u.oneof!==void 0){const f=typeof u.oneof=="string"?u.oneof:u.oneof.name;(!l||l.name!=f)&&(l=new fd(f)),d.oneof=l,l.addField(d)}c.push(d)}return c}const E=sd("proto3",n=>new od(n,e=>pd(e)),n=>{for(const e of n.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,i=n;if(e.repeated){i[t]=[];continue}switch(e.kind){case"oneof":i[t]={case:void 0};break;case"enum":i[t]=0;break;case"map":i[t]={};break;case"scalar":i[t]=sn(e.T,e.L);break}}});class Se extends rs{constructor(e){super(),this.seconds=Q.zero,this.nanos=0,E.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(E.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=Q.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Se.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Se({seconds:Q.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Se().fromBinary(e,t)}static fromJson(e,t){return new Se().fromJson(e,t)}static fromJsonString(e,t){return new Se().fromJsonString(e,t)}static equals(e,t){return E.util.equals(Se,e,t)}}Se.runtime=E;Se.typeName="google.protobuf.Timestamp";Se.fields=E.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const md=E.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Se},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:gd,repeated:!0},{no:5,name:"events",kind:"message",T:bd,repeated:!0}]),gd=E.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:vd,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),vd=E.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Se},{no:3,name:"value",kind:"scalar",T:2}]),bd=E.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Se},{no:7,name:"normalized_end_timestamp",kind:"message",T:Se,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),$a=E.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),Ne=E.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),ne=E.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),os=E.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Tn=E.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),_n=E.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Fe=E.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),At=E.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),yd=E.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),le=E.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Ii=E.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:ui,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:cc}]),ui=E.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),kd=E.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:E.getEnumType(ne),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),Ut=E.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:E.getEnumType(Yt)},{no:4,name:"tracks",kind:"message",T:Jt,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:kd},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:E.getEnumType(In)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:E.getEnumType(Fe)},{no:18,name:"kind_details",kind:"enum",T:E.getEnumType(Sd),repeated:!0}]),Yt=E.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),In=E.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),Sd=E.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),oe=E.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),Td=E.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Tt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:E.getEnumType(Qa)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),Jt=E.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:E.getEnumType(Ne)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:E.getEnumType(ne)},{no:10,name:"layers",kind:"message",T:Tt,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:Td,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:E.getEnumType(oe)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:cc},{no:19,name:"audio_features",kind:"enum",T:E.getEnumType(le),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:E.getEnumType($a)}]),Tt=E.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:E.getEnumType(os)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),Qa=E.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),me=E.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:E.getEnumType(B)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:as,oneof:"value"},{no:3,name:"speaker",kind:"message",T:Cd,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:ec,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Ed,oneof:"value"},{no:8,name:"metrics",kind:"message",T:md,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:di,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:cs,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:ls,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:us,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:hi,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:fi,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:pi,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:Ya,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),B=E.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),Ya=E.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:E.getEnumType(oe)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),Xa=E.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:as,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:di,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:cs,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:ls,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:us,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:hi,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:fi,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:pi,oneof:"value"}]),Cd=E.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:Za,repeated:!0}]),Za=E.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),as=E.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),ec=E.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Ed=E.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:wd,repeated:!0}]),wd=E.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),di=E.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),cs=E.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),ls=E.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),us=E.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:tc,oneof:"value"}]),tc=E.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),nc=E.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ic=E.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:E.getEnumType(rc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),rc=E.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),sc=E.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:E.getEnumType(oc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),oc=E.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),ac=E.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:uo},{no:2,name:"screen",kind:"message",T:uo},{no:3,name:"resume_connection",kind:"enum",T:E.getEnumType(_n)},{no:4,name:"disabled_codecs",kind:"message",T:Pd},{no:5,name:"force_relay",kind:"enum",T:E.getEnumType(_n)}]),uo=E.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:E.getEnumType(_n)}]),Pd=E.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:ui,repeated:!0},{no:2,name:"publish",kind:"message",T:ui,repeated:!0}]),cc=E.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),kr=E.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),lc=E.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:E.getEnumType(kr)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),uc=E.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),hi=E.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:E.getEnumType(oe)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:lc,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:uc,oneof:"content_header"}],{localName:"DataStream_Header"}),fi=E.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),pi=E.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),Rd=E.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Le=E.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Sr=E.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),_d=E.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Id=E.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:Rt,oneof:"message"},{no:2,name:"answer",kind:"message",T:Rt,oneof:"message"},{no:3,name:"trickle",kind:"message",T:xi,oneof:"message"},{no:4,name:"add_track",kind:"message",T:xn,oneof:"message"},{no:5,name:"mute",kind:"message",T:Oi,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Mi,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:dc,oneof:"message"},{no:8,name:"leave",kind:"message",T:Ai,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:fc,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:gc,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:ms,oneof:"message"},{no:13,name:"simulate",kind:"message",T:Ge,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:fs,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:yc,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:hs,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:hc,oneof:"message"}]),ho=E.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:xd,oneof:"message"},{no:2,name:"answer",kind:"message",T:Rt,oneof:"message"},{no:3,name:"offer",kind:"message",T:Rt,oneof:"message"},{no:4,name:"trickle",kind:"message",T:xi,oneof:"message"},{no:5,name:"update",kind:"message",T:Ad,oneof:"message"},{no:6,name:"track_published",kind:"message",T:ds,oneof:"message"},{no:8,name:"leave",kind:"message",T:Ai,oneof:"message"},{no:9,name:"mute",kind:"message",T:Oi,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Dd,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Nd,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Ud,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:jd,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Vd,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:Wd,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Md,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Od,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Hd,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Jd,oneof:"message"},{no:22,name:"request_response",kind:"message",T:$d,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Qd,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:zd,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:eh,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:qd,oneof:"message"}]),Tr=E.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Tt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:E.getEnumType(Qa)}]),xn=E.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:E.getEnumType(Ne)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:E.getEnumType(ne)},{no:9,name:"layers",kind:"message",T:Tt,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Tr,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:E.getEnumType(oe)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:E.getEnumType($a)},{no:17,name:"audio_features",kind:"enum",T:E.getEnumType(le),repeated:!0}]),xi=E.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:E.getEnumType(Le)},{no:3,name:"final",kind:"scalar",T:8}]),Oi=E.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),xd=E.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Ii},{no:2,name:"participant",kind:"message",T:Ut},{no:3,name:"other_participants",kind:"message",T:Ut,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:pc,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ac},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ic},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:ui,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Od=E.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:pc,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ac},{no:3,name:"server_info",kind:"message",T:ic},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),ds=E.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Jt}]),Md=E.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Rt=E.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),Ad=E.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:Ut,repeated:!0}]),Mi=E.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:nc,repeated:!0}]),dc=E.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:E.getEnumType(os)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),hs=E.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:E.getEnumType(le),repeated:!0}]),hc=E.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Ai=E.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:E.getEnumType(Fe)},{no:3,name:"action",kind:"enum",T:E.getEnumType(Xt)},{no:4,name:"regions",kind:"message",T:Kd}]),Xt=E.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),fc=E.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:Tt,repeated:!0}]),fs=E.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),pc=E.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),Dd=E.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:Za,repeated:!0}]),Nd=E.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Ii}]),Ld=E.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:E.getEnumType(Tn)},{no:3,name:"score",kind:"scalar",T:2}]),Ud=E.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:Ld,repeated:!0}]),Fd=E.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:E.getEnumType(Sr)}]),jd=E.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:Fd,repeated:!0}]),ps=E.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:E.getEnumType(os)},{no:2,name:"enabled",kind:"scalar",T:8}]),Bd=E.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:ps,repeated:!0}]),Vd=E.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:ps,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:Bd,repeated:!0}]),qd=E.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:Rd,repeated:!0}]),mc=E.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),gc=E.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:mc,repeated:!0}]),Wd=E.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),zd=E.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Ii},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:Ut},{no:4,name:"other_participants",kind:"message",T:Ut,repeated:!0}]),ms=E.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:Rt},{no:2,name:"subscription",kind:"message",T:Mi},{no:3,name:"publish_tracks",kind:"message",T:ds,repeated:!0},{no:4,name:"data_channels",kind:"message",T:bc,repeated:!0},{no:5,name:"offer",kind:"message",T:Rt},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:vc,repeated:!0}]),vc=E.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),bc=E.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:E.getEnumType(Le)}]),Ge=E.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:E.getEnumType(_d),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),yc=E.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Hd=E.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),Kd=E.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:Gd,repeated:!0}]),Gd=E.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),Jd=E.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:E.getEnumType(yd)}]),$d=E.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:E.getEnumType(gs)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:xi,oneof:"request"},{no:5,name:"add_track",kind:"message",T:xn,oneof:"request"},{no:6,name:"mute",kind:"message",T:Oi,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:fs,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:hs,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:hc,oneof:"request"}]),gs=E.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),Qd=E.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),kc=E.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),Yd=E.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:sc},{no:2,name:"connection_settings",kind:"message",T:kc},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:xn,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:Rt},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:E.getEnumType(At)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:ms}]),Xd=E.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:E.getEnumType(Zd)},{no:2,name:"join_request",kind:"scalar",T:12}]),Zd=E.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),eh=E.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function th(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Zn={exports:{}},nh=Zn.exports,fo;function ih(){return fo||(fo=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(nh,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,k){var b=m[k];if(typeof b.bind=="function")return b.bind(m);try{return Function.prototype.bind.call(b,m)}catch{return function(){return Function.prototype.apply.apply(b,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),k=0;k<r.length;k++){var b=r[k];this[b]=k<m?e:this.methodFactory(b,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function f(m,k,b){return l(m)||d.apply(this,arguments)}function p(m,k){var b=this,w,R,S,y="loglevel";typeof m=="string"?y+=":"+m:typeof m=="symbol"&&(y=void 0);function T(A){var U=(r[A]||"silent").toUpperCase();if(!(typeof window===t||!y)){try{window.localStorage[y]=U;return}catch{}try{window.document.cookie=encodeURIComponent(y)+"="+U+";"}catch{}}}function I(){var A;if(!(typeof window===t||!y)){try{A=window.localStorage[y]}catch{}if(typeof A===t)try{var U=window.document.cookie,K=encodeURIComponent(y),$=U.indexOf(K+"=");$!==-1&&(A=/^([^;]+)/.exec(U.slice($+K.length+1))[1])}catch{}return b.levels[A]===void 0&&(A=void 0),A}}function D(){if(!(typeof window===t||!y)){try{window.localStorage.removeItem(y)}catch{}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function x(A){var U=A;if(typeof U=="string"&&b.levels[U.toUpperCase()]!==void 0&&(U=b.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=b.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+A)}b.name=m,b.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},b.methodFactory=k||f,b.getLevel=function(){return S??R??w},b.setLevel=function(A,U){return S=x(A),U!==!1&&T(S),u.call(b)},b.setDefaultLevel=function(A){R=x(A),I()||b.setLevel(A,!1)},b.resetLevel=function(){S=null,D(),u.call(b)},b.enableAll=function(A){b.setLevel(b.levels.TRACE,A)},b.disableAll=function(A){b.setLevel(b.levels.SILENT,A)},b.rebuild=function(){if(o!==b&&(w=x(o.getLevel())),u.call(b),o===b)for(var A in s)s[A].rebuild()},w=x(o?o.getLevel():"WARN");var O=I();O!=null&&(S=x(O)),u.call(b)}o=new p,o.getLogger=function(k){if(typeof k!="symbol"&&typeof k!="string"||k==="")throw new TypeError("You must supply a name when creating a logger.");var b=s[k];return b||(b=s[k]=new p(k,o.methodFactory)),b};var g=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=g),o},o.getLoggers=function(){return s},o.default=o,o})})(Zn)),Zn.exports}var Di=ih(),Cr;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(Cr||(Cr={}));var je;(function(n){n.Default="livekit",n.Room="livekit-room",n.TokenSource="livekit-token-source",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(je||(je={}));let F=Di.getLogger("livekit");const rh=Object.values(je).map(n=>Di.getLogger(n));F.setDefaultLevel(Cr.info);function lt(n){const e=Di.getLogger(n);return e.setDefaultLevel(F.getLevel()),e}function Ab(n,e){for(const t of rh)t.setLevel(n)}const sh=Di.getLogger("lk-e2ee"),mn=7e3,oh=[0,300,4*300,9*300,16*300,mn,mn,mn,mn,mn];class ah{constructor(e){this._retryDelays=e!==void 0?[...e]:oh}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function ch(n,e){var t={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(n);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(n,i[r])&&(t[i[r]]=n[i[r]]);return t}function v(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,e||[])).next())})}function po(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function at(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof po=="function"?po(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}var Wn={exports:{}},mo;function lh(){if(mo)return Wn.exports;mo=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(y,T,I){return Function.prototype.apply.call(y,T,I)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(y){return Object.getOwnPropertyNames(y).concat(Object.getOwnPropertySymbols(y))}:t=function(y){return Object.getOwnPropertyNames(y)};function i(S){console&&console.warn&&console.warn(S)}var r=Number.isNaN||function(y){return y!==y};function s(){s.init.call(this)}Wn.exports=s,Wn.exports.once=b,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(S){if(typeof S!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof S)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(S){if(typeof S!="number"||S<0||r(S))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+S+".");o=S}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(y){if(typeof y!="number"||y<0||r(y))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+y+".");return this._maxListeners=y,this};function c(S){return S._maxListeners===void 0?s.defaultMaxListeners:S._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(y){for(var T=[],I=1;I<arguments.length;I++)T.push(arguments[I]);var D=y==="error",x=this._events;if(x!==void 0)D=D&&x.error===void 0;else if(!D)return!1;if(D){var O;if(T.length>0&&(O=T[0]),O instanceof Error)throw O;var A=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw A.context=O,A}var U=x[y];if(U===void 0)return!1;if(typeof U=="function")e(U,this,T);else for(var K=U.length,$=g(U,K),I=0;I<K;++I)e($[I],this,T);return!0};function l(S,y,T,I){var D,x,O;if(a(T),x=S._events,x===void 0?(x=S._events=Object.create(null),S._eventsCount=0):(x.newListener!==void 0&&(S.emit("newListener",y,T.listener?T.listener:T),x=S._events),O=x[y]),O===void 0)O=x[y]=T,++S._eventsCount;else if(typeof O=="function"?O=x[y]=I?[T,O]:[O,T]:I?O.unshift(T):O.push(T),D=c(S),D>0&&O.length>D&&!O.warned){O.warned=!0;var A=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(y)+" listeners added. Use emitter.setMaxListeners() to increase limit");A.name="MaxListenersExceededWarning",A.emitter=S,A.type=y,A.count=O.length,i(A)}return S}s.prototype.addListener=function(y,T){return l(this,y,T,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(y,T){return l(this,y,T,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(S,y,T){var I={fired:!1,wrapFn:void 0,target:S,type:y,listener:T},D=u.bind(I);return D.listener=T,I.wrapFn=D,D}s.prototype.once=function(y,T){return a(T),this.on(y,d(this,y,T)),this},s.prototype.prependOnceListener=function(y,T){return a(T),this.prependListener(y,d(this,y,T)),this},s.prototype.removeListener=function(y,T){var I,D,x,O,A;if(a(T),D=this._events,D===void 0)return this;if(I=D[y],I===void 0)return this;if(I===T||I.listener===T)--this._eventsCount===0?this._events=Object.create(null):(delete D[y],D.removeListener&&this.emit("removeListener",y,I.listener||T));else if(typeof I!="function"){for(x=-1,O=I.length-1;O>=0;O--)if(I[O]===T||I[O].listener===T){A=I[O].listener,x=O;break}if(x<0)return this;x===0?I.shift():m(I,x),I.length===1&&(D[y]=I[0]),D.removeListener!==void 0&&this.emit("removeListener",y,A||T)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(y){var T,I,D;if(I=this._events,I===void 0)return this;if(I.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):I[y]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete I[y]),this;if(arguments.length===0){var x=Object.keys(I),O;for(D=0;D<x.length;++D)O=x[D],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(T=I[y],typeof T=="function")this.removeListener(y,T);else if(T!==void 0)for(D=T.length-1;D>=0;D--)this.removeListener(y,T[D]);return this};function f(S,y,T){var I=S._events;if(I===void 0)return[];var D=I[y];return D===void 0?[]:typeof D=="function"?T?[D.listener||D]:[D]:T?k(D):g(D,D.length)}s.prototype.listeners=function(y){return f(this,y,!0)},s.prototype.rawListeners=function(y){return f(this,y,!1)},s.listenerCount=function(S,y){return typeof S.listenerCount=="function"?S.listenerCount(y):p.call(S,y)},s.prototype.listenerCount=p;function p(S){var y=this._events;if(y!==void 0){var T=y[S];if(typeof T=="function")return 1;if(T!==void 0)return T.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function g(S,y){for(var T=new Array(y),I=0;I<y;++I)T[I]=S[I];return T}function m(S,y){for(;y+1<S.length;y++)S[y]=S[y+1];S.pop()}function k(S){for(var y=new Array(S.length),T=0;T<y.length;++T)y[T]=S[T].listener||S[T];return y}function b(S,y){return new Promise(function(T,I){function D(O){S.removeListener(y,x),I(O)}function x(){typeof S.removeListener=="function"&&S.removeListener("error",D),T([].slice.call(arguments))}R(S,y,x,{once:!0}),y!=="error"&&w(S,D,{once:!0})})}function w(S,y,T){typeof S.on=="function"&&R(S,"error",y,T)}function R(S,y,T,I){if(typeof S.on=="function")I.once?S.once(y,T):S.on(y,T);else if(typeof S.addEventListener=="function")S.addEventListener(y,function D(x){I.once&&S.removeEventListener(y,D),T(x)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof S)}return Wn.exports}var et=lh();let Sc=!0,Tc=!0;function Cn(n,e,t){const i=n.match(e);return i&&i.length>=t&&parseFloat(i[t],10)}function Wt(n,e,t){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=l=>{const u=t(l);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function uh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Sc=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function dh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Tc=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Cc(){if(typeof window=="object"){if(Sc)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function vs(n,e){Tc&&console.warn(n+" is deprecated, please use "+e+" instead.")}function hh(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const i=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(i)return{browser:"chrome",version:parseInt(i.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(Cn(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(Cn(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(Cn(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype,e._safariVersion=Cn(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function go(n){return Object.prototype.toString.call(n)==="[object Object]"}function Ec(n){return go(n)?Object.keys(n).reduce(function(e,t){const i=go(n[t]),r=i?Ec(n[t]):n[t],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[t]:r})},{}):n}function Er(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Er(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{Er(n,n.get(r),t)})}))}function vo(n,e,t){const i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return n.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)}),s.forEach(o=>{n.forEach(a=>{a.type===i&&a.trackId===o.id&&Er(n,a,r)})}),r}const bo=Cc;function wc(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const i=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof a[l]=="object"?a[l]:{ideal:a[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(f,p){return f?f+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(u.ideal!==void 0){c.optional=c.optional||[];let f={};typeof u.ideal=="number"?(f[d("min",l)]=u.ideal,c.optional.push(f),f={},f[d("max",l)]=u.ideal,c.optional.push(f)):(f[d("",l)]=u.ideal,c.optional.push(f))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(f=>{u[f]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(f,l)]=u[f])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},r=function(a,c){if(e.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const l=function(u,d,f){d in u&&!(f in u)&&(u[f]=u[d],delete u[d])};a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=i(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete a.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return t.mediaDevices.enumerateDevices().then(f=>{f=f.filter(g=>g.kind==="videoinput");let p=f.find(g=>d.some(m=>g.label.toLowerCase().includes(m)));return!p&&f.length&&d.includes("back")&&(p=f[f.length-1]),p&&(a.video.deviceId=l.exact?{exact:p.deviceId}:{ideal:p.deviceId}),a.video=i(a.video),bo("chrome: "+JSON.stringify(a)),c(a)})}a.video=i(a.video)}return bo("chrome: "+JSON.stringify(a)),c(a)},s=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(a,c,l){r(a,u=>{t.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(t.getUserMedia=o.bind(t),t.mediaDevices.getUserMedia){const a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return r(c,l=>a(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function Pc(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function Rc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):s={track:r.track};const o=new Event("track");o.track=r.track,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.id):s={track:r};const o=new Event("track");o.track=r,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Wt(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function _c(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,c){let l=r.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){s.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],t.apply(this,[s]),s.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(o=>{const a=this._senders.find(c=>c.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Ic(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(o=>o._pc=this),s});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(o=>vo(o,s.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Wt(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>vo(s,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const i=arguments[0];let r,s,o;return this.getSenders().forEach(a=>{a.track===i&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(s?o=!0:s=a),a.track===i)),o||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function xc(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(o);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),r.apply(this,arguments)}}function Oc(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return xc(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(p=>p.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new n.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const f=[].slice.call(arguments,1);if(f.length!==1||!f[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const g=this._streams[d.id];if(g)g.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new n.MediaStream([u]);this._streams[d.id]=m,this._reverseStreams[m.id]=d,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const p=l._reverseStreams[f],g=l._streams[p.id];d=d.replace(new RegExp(g.id,"g"),p.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function o(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const p=l._reverseStreams[f],g=l._streams[p.id];d=d.replace(new RegExp(p.id,"g"),g.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],d={[l](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[g=>{const m=s(this,g);f[0].apply(null,[m])},g=>{f[1]&&f[1].apply(null,g)},arguments[2]]):u.apply(this,arguments).then(g=>s(this,g))}};n.RTCPeerConnection.prototype[l]=d[l]});const a=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let f;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(m=>u.track===m)&&(f=this._streams[p])}),f&&(f.getTracks().length===1?this.removeStream(this._reverseStreams[f.id]):f.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function wr(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function Mc(n,e){Wt(n,"negotiationneeded",t=>{const i=t.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return t})}var yo=Object.freeze({__proto__:null,fixNegotiationNeeded:Mc,shimAddTrackRemoveTrack:Oc,shimAddTrackRemoveTrackWithNative:xc,shimGetSendersWithDtmf:_c,shimGetUserMedia:wc,shimMediaStream:Pc,shimOnTrack:Rc,shimPeerConnection:wr,shimSenderReceiverGetStats:Ic});function Ac(n,e){const t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,s,o){vs("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function fh(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(i)})}function Dc(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Pr(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=o[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[s,o,a]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!o)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(o,a)}}function Nc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Lc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Wt(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Uc(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){vs("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Fc(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function jc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:o}=s,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return s})}function Bc(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Vc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function qc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var ko=Object.freeze({__proto__:null,shimAddTransceiver:jc,shimCreateAnswer:qc,shimCreateOffer:Vc,shimGetDisplayMedia:fh,shimGetParameters:Bc,shimGetUserMedia:Ac,shimOnTrack:Dc,shimPeerConnection:Pr,shimRTCDataChannel:Fc,shimReceiverGetStats:Lc,shimRemoveStream:Uc,shimSenderGetStats:Nc});function Wc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},n.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];return s&&s.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function zc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const o=new Event("addstream");o.stream=s,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function Hc(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],f=t.apply(this,[d]);return u?(f.then(l,u),Promise.resolve()):f},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],f=i.apply(this,[d]);return u?(f.then(l,u),Promise.resolve()):f};let a=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=a,a=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=a,a=function(c,l,u){const d=o.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=a}function Kc(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(Gc(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function Gc(n){return n&&n.video!==void 0?Object.assign({},n,{video:Ec(n.video)}):n}function Jc(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let o=0;o<i.iceServers.length;o++){let a=i.iceServers[o];a.urls===void 0&&a.url?(vs("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,s.push(a)):s.push(i.iceServers[o])}i.iceServers=s}return new e(i,r)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function $c(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Qc(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function Yc(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var So=Object.freeze({__proto__:null,shimAudioContext:Yc,shimCallbacksAPI:Hc,shimConstraints:Gc,shimCreateOfferLegacy:Qc,shimGetUserMedia:Kc,shimLocalStreamsAPI:Wc,shimRTCIceServerUrls:Jc,shimRemoteStreamsAPI:zc,shimTrackEventTransceiver:$c}),Xi={exports:{}},To;function ph(){return To||(To=1,(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;t.indexOf("a=candidate:")===0?i=t.substring(12).split(" "):i=t.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(t){const i=[];i.push(t.foundation);const r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);const s=t.type;return i.push("typ"),i.push(s),s!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const i={};let r;const s=t.substring(t.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(o=>{t.parameters[o]!==void 0?s.push(o+"="+t.parameters[o]):s.push(o)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){const i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){const i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},s=t.indexOf(":",i);return s>-1?(r.attribute=t.substring(i+1,s),r.value=t.substring(s+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){const i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(t){const i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(t)[0].split(" ");i.profile=s[2];for(let a=3;a<s.length;a++){const c=s[a],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(a=>{i.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(a=>{o.forEach(c=>{a.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let s=0;return i.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(t){const i=[],r=e.parseRtpParameters(t),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(t,"a=ssrc:").map(f=>e.parseSsrcMedia(f)).filter(f=>f.attribute==="cname"),c=a.length>0&&a[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(f=>f.substring(17).split(" ").map(g=>parseInt(g,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(f=>{if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(f.parameters.apt,10)};c&&l&&(p.rtx={ssrc:l}),i.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(t,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-2e3*8:d=void 0,i.forEach(f=>{f.maxBitrate=d})),i},e.parseRtcpParameters=function(t){const i={},r=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=e.matchPrefix(t,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(t){const i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,i){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let s;const o=i!==void 0?i:2;return t?s=t:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){const r=e.splitLines(t);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(Xi)),Xi.exports}var Xc=ph(),Zt=th(Xc),mh=Cu({__proto__:null,default:Zt},[Xc]);function ei(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=Zt.parseCandidate(i.candidate);for(const o in s)o in r||Object.defineProperty(r,o,{value:s[o]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},n.RTCIceCandidate.prototype=e.prototype,Wt(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Rr(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Wt(n,"icecandidate",e=>{if(e.candidate){const t=Zt.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function ti(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(a){if(!a||!a.sdp)return!1;const c=Zt.splitSections(a.sdp);return c.shift(),c.some(l=>{const u=Zt.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(a){let c=65536;return e.browser==="firefox"&&(e.version<57?a===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(a,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=Zt.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},o=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const f={};Object.defineProperty(f,"maxMessageSize",{get(){return d}}),this._sctp=f}return o.apply(this,arguments)}}function ni(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},Wt(n,"datachannel",i=>(e(i.channel,i.target),i))}function _r(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Ir(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return t.apply(this,arguments)}}function ii(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ri(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>t.apply(this,[o]))})}var gh=Object.freeze({__proto__:null,removeExtmapAllowMixed:Ir,shimAddIceCandidateNullOrEmpty:ii,shimConnectionState:_r,shimMaxMessageSize:ti,shimParameterlessSetLocalDescription:ri,shimRTCIceCandidate:ei,shimRTCIceCandidateRelayProtocol:Rr,shimSendThrowTypeError:ni});function vh(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=Cc,i=hh(n),r={browserDetails:i,commonShim:gh,extractVersion:Cn,disableLog:uh,disableWarnings:dh,sdp:mh};switch(i.browser){case"chrome":if(!yo||!wr||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=yo,ii(n,i),ri(n),wc(n,i),Pc(n),wr(n,i),Rc(n),Oc(n,i),_c(n),Ic(n),Mc(n,i),ei(n),Rr(n),_r(n),ti(n,i),ni(n),Ir(n,i);break;case"firefox":if(!ko||!Pr||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=ko,ii(n,i),ri(n),Ac(n,i),Pr(n,i),Dc(n),Uc(n),Nc(n),Lc(n),Fc(n),jc(n),Bc(n),Vc(n),qc(n),ei(n),_r(n),ti(n,i),ni(n);break;case"safari":if(!So||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=So,ii(n,i),ri(n),Jc(n),Qc(n),Hc(n),Wc(n),zc(n),$c(n),Kc(n),Yc(n),ei(n),Rr(n),ti(n,i),ni(n),Ir(n,i);break;default:t("Unsupported browser!");break}return r}vh({window:typeof window>"u"?void 0:window});const bh=10,gn="lk_e2ee",yh="LKFrameEncryptionKey",kh={sharedKey:!1,ratchetSalt:yh,ratchetWindowSize:8,failureTolerance:bh,keyringSize:16};var Ct;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(Ct||(Ct={}));var Co;(function(n){n.KeyRatcheted="keyRatcheted"})(Co||(Co={}));var St;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(St||(St={}));var Eo;(function(n){n.Error="cryptorError"})(Eo||(Eo={}));function Sh(){return Th()||xr()}function xr(){return typeof window.RTCRtpScriptTransform<"u"}function Th(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}function Ch(n){var e,t,i,r,s;if(((e=n.value)===null||e===void 0?void 0:e.case)!=="sipDtmf"&&((t=n.value)===null||t===void 0?void 0:t.case)!=="metrics"&&((i=n.value)===null||i===void 0?void 0:i.case)!=="speaker"&&((r=n.value)===null||r===void 0?void 0:r.case)!=="transcription"&&((s=n.value)===null||s===void 0?void 0:s.case)!=="encryptedPacket")return new Xa({value:n.value})}class Db extends et.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,i,r)=>{F.debug("key ratcheted event received",{ratchetResult:t,participantId:i,keyIndex:r})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},kh),e),this.on(Ct.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,i){const r={key:e,participantIdentity:t,keyIndex:i};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(i??0),r),this.emit(Ct.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Ct.RatchetRequest,e,t)}}class dt extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}var z;(function(n){n[n.NotAllowed=0]="NotAllowed",n[n.ServerUnreachable=1]="ServerUnreachable",n[n.InternalError=2]="InternalError",n[n.Cancelled=3]="Cancelled",n[n.LeaveRequest=4]="LeaveRequest",n[n.Timeout=5]="Timeout"})(z||(z={}));class H extends dt{constructor(e,t,i,r){super(1,e),this.name="ConnectionError",this.status=i,this.reason=t,this.context=r,this.reasonName=z[t]}}class bs extends dt{constructor(e){super(21,e??"device is unsupported"),this.name="DeviceUnsupportedError"}}class ct extends dt{constructor(e){super(20,e??"track is invalid"),this.name="TrackInvalidError"}}class Eh extends dt{constructor(e){super(10,e??"unsupported server"),this.name="UnsupportedServer"}}class se extends dt{constructor(e){super(12,e??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class Or extends dt{constructor(e){super(13,e??"unable to negotiate"),this.name="NegotiationError"}}class wo extends dt{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Po extends dt{constructor(e,t){super(15,e),this.reason=t,this.reasonName=typeof t=="string"?t:gs[t]}}var pe;(function(n){n[n.AlreadyOpened=0]="AlreadyOpened",n[n.AbnormalEnd=1]="AbnormalEnd",n[n.DecodeFailed=2]="DecodeFailed",n[n.LengthExceeded=3]="LengthExceeded",n[n.Incomplete=4]="Incomplete",n[n.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",n[n.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(pe||(pe={}));class xe extends dt{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=pe[t]}}var On;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(On||(On={}));(function(n){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?n.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?n.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=e})(On||(On={}));var Ro;(function(n){n[n.InvalidKey=0]="InvalidKey",n[n.MissingKey=1]="MissingKey",n[n.InternalError=2]="InternalError"})(Ro||(Ro={}));var P;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.Moved="moved",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.ParticipantAttributesChanged="participantAttributesChanged",n.ParticipantActive="participantActive",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged",n.ChatMessage="chatMessage",n.LocalTrackSubscribed="localTrackSubscribed",n.MetricsReceived="metricsReceived"})(P||(P={}));var _;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackCpuConstrained="localTrackCpuConstrained",n.LocalSenderCreated="localSenderCreated",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.TrackCpuConstrained="trackCpuConstrained",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded",n.AttributesChanged="attributesChanged",n.LocalTrackSubscribed="localTrackSubscribed",n.ChatMessage="chatMessage",n.Active="active"})(_||(_={}));var L;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackSubscribed="localTrackSubscribed",n.Offline="offline",n.SignalRequestResponse="signalRequestResponse",n.SignalConnected="signalConnected",n.RoomMoved="roomMoved"})(L||(L={}));var N;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.CpuConstrained="cpuConstrained",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed",n.TrackProcessorUpdate="trackProcessorUpdate",n.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",n.TranscriptionReceived="transcriptionReceived",n.TimeSyncUpdate="timeSyncUpdate",n.PreConnectBufferFlushed="preConnectBufferFlushed"})(N||(N={}));function wh(n){return typeof n>"u"?n:typeof structuredClone=="function"?typeof n=="object"&&n!==null?structuredClone(Object.assign({},n)):structuredClone(n):JSON.parse(JSON.stringify(n))}const Ph=/version\/(\d+(\.?_?\d+)+)/i;let Zi;function ge(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if(Zi===void 0||e){const i=Rh.find(r=>{let{test:s}=r;return s.test(t)});Zi=i?.describe(t)}return Zi}const Rh=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:si(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:er(n)}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:si(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0,osVersion:er(n)}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:si(Ph,n),os:n.includes("mobile/")?"iOS":"macOS",osVersion:er(n)}}}];function si(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(n);return i&&i.length>=t&&i[t]||""}function er(n){return n.includes("mac os")?si(/\(.+?(\d+_\d+(:?_\d+)?)/,n,1).replace(/_/g,"."):void 0}var _h="2.15.13";const Ih=_h,xh=16;class he{}he.setTimeout=function(){return setTimeout(...arguments)};he.setInterval=function(){return setInterval(...arguments)};he.clearTimeout=function(){return clearTimeout(...arguments)};he.clearInterval=function(){return clearInterval(...arguments)};const Oh=5e3,vn=[];var Re;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH"})(Re||(Re={}));class C extends et.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=C.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=F,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),Oh):this.handleAppVisibilityChanged()},this.log=lt((r=i.loggerName)!==null&&r!==void 0?r:je.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=C.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),V(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===C.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===C.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(vn.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&vn.splice(vn.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),$t(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?N.AudioPlaybackStarted:N.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?N.AudioPlaybackFailed:N.VideoPlaybackFailed,s):s.name==="AbortError"?F.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):F.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(o=>o.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(N.ElementAttached,e),e}detach(e){try{if(e){en(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(N.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(i=>{en(this.mediaStreamTrack,i),t.push(i),this.recycleElement(i),this.emit(N.ElementDetached,i)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=lt(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),vn.forEach(i=>{i.parentElement||(t=!1)}),t&&vn.push(e)}}handleAppVisibilityChanged(){return v(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===C.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Te()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Te()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function $t(n,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let i;n.kind==="audio"?i=t.getAudioTracks():i=t.getVideoTracks(),i.includes(n)||(i.forEach(r=>{t.removeTrack(r)}),t.addTrack(n)),(!jt()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(jt()||Ft())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function en(n,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(n),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(n){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=n.Kind||(n.Kind={}));let t;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(t=n.Source||(n.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=n.StreamState||(n.StreamState={}));function r(l){switch(l){case e.Audio:return Ne.AUDIO;case e.Video:return Ne.VIDEO;default:return Ne.DATA}}n.kindToProto=r;function s(l){switch(l){case Ne.AUDIO:return e.Audio;case Ne.VIDEO:return e.Video;default:return e.Unknown}}n.kindFromProto=s;function o(l){switch(l){case t.Camera:return ne.CAMERA;case t.Microphone:return ne.MICROPHONE;case t.ScreenShare:return ne.SCREEN_SHARE;case t.ScreenShareAudio:return ne.SCREEN_SHARE_AUDIO;default:return ne.UNKNOWN}}n.sourceToProto=o;function a(l){switch(l){case ne.CAMERA:return t.Camera;case ne.MICROPHONE:return t.Microphone;case ne.SCREEN_SHARE:return t.ScreenShare;case ne.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}n.sourceFromProto=a;function c(l){switch(l){case Sr.ACTIVE:return i.Active;case Sr.PAUSED:return i.Paused;default:return i.Unknown}}n.streamStateFromProto=c})(C||(C={}));class G{constructor(e,t,i,r,s){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&i!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:i,maxFramerate:r,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Mh=["vp8","h264"],Ah=["vp8","h264","vp9","av1","h265"];function Dh(n){return!!Mh.find(e=>e===n)}const Nh=Dh;var _o;(function(n){n[n.PREFER_REGRESSION=0]="PREFER_REGRESSION",n[n.SIMULCAST=1]="SIMULCAST",n[n.REGRESSION=2]="REGRESSION"})(_o||(_o={}));var Mr;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:24e3},n.music={maxBitrate:48e3},n.musicStereo={maxBitrate:64e3},n.musicHighQuality={maxBitrate:96e3},n.musicHighQualityStereo={maxBitrate:128e3}})(Mr||(Mr={}));const Mn={h90:new G(160,90,9e4,20),h180:new G(320,180,16e4,20),h216:new G(384,216,18e4,20),h360:new G(640,360,45e4,20),h540:new G(960,540,8e5,25),h720:new G(1280,720,17e5,30),h1080:new G(1920,1080,3e6,30),h1440:new G(2560,1440,5e6,30),h2160:new G(3840,2160,8e6,30)},Ar={h120:new G(160,120,7e4,20),h180:new G(240,180,125e3,20),h240:new G(320,240,14e4,20),h360:new G(480,360,33e4,20),h480:new G(640,480,5e5,20),h540:new G(720,540,6e5,25),h720:new G(960,720,13e5,30),h1080:new G(1440,1080,23e5,30),h1440:new G(1920,1440,38e5,30)},ys={h360fps3:new G(640,360,2e5,3,"medium"),h360fps15:new G(640,360,4e5,15,"medium"),h720fps5:new G(1280,720,8e5,5,"medium"),h720fps15:new G(1280,720,15e5,15,"medium"),h720fps30:new G(1280,720,2e6,30,"medium"),h1080fps15:new G(1920,1080,25e5,15,"medium"),h1080fps30:new G(1920,1080,5e6,30,"medium"),original:new G(0,0,7e6,30,"medium")},Lh="|",Io="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Uh(n){const e=n.split(Lh);return e.length>1?[e[0],n.substr(e[0].length+1)]:[n,""]}function ve(n){return v(this,void 0,void 0,function*(){return new Promise(e=>he.setTimeout(e,n))})}function Dr(){return"addTransceiver"in RTCPeerConnection.prototype}function Nr(){return"addTrack"in RTCPeerConnection.prototype}function Fh(){if(!("getCapabilities"in RTCRtpSender)||jt()||Ft())return!1;const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/av1"){e=!0;break}}return e}function jh(){if(!("getCapabilities"in RTCRtpSender)||Ft())return!1;if(jt()){const t=ge();if(t?.version&&Be(t.version,"16")<0||t?.os==="iOS"&&t?.osVersion&&Be(t.osVersion,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/vp9"){e=!0;break}}return e}function $e(n){return n==="av1"||n==="vp9"}function Lr(n){return!document||An()?!1:(n||(n=document.createElement("audio")),"setSinkId"in n)}function Bh(){return typeof RTCPeerConnection>"u"?!1:Dr()||Nr()}function Ft(){var n;return((n=ge())===null||n===void 0?void 0:n.name)==="Firefox"}function xo(){const n=ge();return!!n&&n.name==="Chrome"&&n.os!=="iOS"}function jt(){var n;return((n=ge())===null||n===void 0?void 0:n.name)==="Safari"}function An(){const n=ge();return n?.name==="Safari"||n?.os==="iOS"}function Vh(){const n=ge();return n?.name==="Safari"&&n.version.startsWith("17.")||n?.os==="iOS"&&!!n?.osVersion&&Be(n.osVersion,"17")>=0}function qh(n){return n||(n=ge()),n?.name==="Safari"&&Be(n.version,"18.3")>0||n?.os==="iOS"&&!!n?.osVersion&&Be(n.osVersion,"18.3")>0}function Zc(){var n,e;return Te()?(e=(n=navigator.userAgentData)===null||n===void 0?void 0:n.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function Wh(){const n=ge(),e="17.2";if(n)return n.name!=="Safari"&&n.os!=="iOS"||n.os==="iOS"&&n.osVersion&&Be(n.osVersion,e)>=0?!0:n.name==="Safari"&&Be(n.version,e)>=0}function Te(){return typeof document<"u"}function Xe(){return navigator.product=="ReactNative"}function Ur(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function el(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function tl(){if(!Xe())return;let n=el();if(n)return n.platform}function Oo(){if(Te())return window.devicePixelRatio;if(Xe()){let n=el();if(n)return n.devicePixelRatio}return 1}function Be(n,e){const t=n.split("."),i=e.split("."),r=Math.min(t.length,i.length);for(let s=0;s<r;++s){const o=parseInt(t[s],10),a=parseInt(i[s],10);if(o>a)return 1;if(o<a)return-1;if(s===r-1&&o===a)return 0}return n===""&&e!==""?-1:e===""?1:t.length==i.length?0:t.length<i.length?-1:1}function zh(n){for(const e of n)e.target.handleResize(e)}function Hh(n){for(const e of n)e.target.handleVisibilityChanged(e)}let tr=null;const Mo=()=>(tr||(tr=new ResizeObserver(zh)),tr);let nr=null;const Ao=()=>(nr||(nr=new IntersectionObserver(Hh,{root:null,rootMargin:"0px"})),nr);function Kh(){var n;const e=new sc({sdk:oc.JS,protocol:xh,version:Ih});return Xe()&&(e.os=(n=tl())!==null&&n!==void 0?n:""),e}function Do(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=n,r.height=e;const s=r.getContext("2d");s?.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(n/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const o=r.captureStream(),[a]=o.getTracks();if(!a)throw Error("Could not get empty media stream video track");return a.enabled=t,a}let bn;function ir(){if(!bn){const n=new AudioContext,e=n.createOscillator(),t=n.createGain();t.gain.setValueAtTime(0,0);const i=n.createMediaStreamDestination();if(e.connect(t),t.connect(i),e.start(),[bn]=i.stream.getAudioTracks(),!bn)throw Error("Could not get empty media stream audio track");bn.enabled=!1}return bn.clone()}class Oe{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((i,r)=>v(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;this._isResolved=!0,(i=this.onFinally)===null||i===void 0||i.call(this)})}}function Gh(n){return Ah.includes(n)}function Et(n){if(typeof n=="string"||typeof n=="number")return n;if(Array.isArray(n))return n[0];if(n.exact!==void 0)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal!==void 0)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function Jh(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function Fr(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}function $h(n,e){return n.segments.map(t=>{let{id:i,text:r,language:s,startTime:o,endTime:a,final:c}=t;var l;const u=(l=e.get(i))!==null&&l!==void 0?l:Date.now(),d=Date.now();return c?e.delete(i):e.set(i,u),{id:i,text:r,startTime:Number.parseInt(o.toString()),endTime:Number.parseInt(a.toString()),final:c,language:s,firstReceivedTime:u,lastReceivedTime:d}})}function Qh(n){const{id:e,timestamp:t,message:i,editTimestamp:r}=n;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}function No(n){switch(n.reason){case z.LeaveRequest:return n.context;case z.Cancelled:return Fe.CLIENT_INITIATED;case z.NotAllowed:return Fe.USER_REJECTED;case z.ServerUnreachable:return Fe.JOIN_FAILURE;default:return Fe.UNKNOWN_REASON}}function oi(n){return n!==void 0?Number(n):void 0}function Dt(n){return n!==void 0?BigInt(n):void 0}function Nt(n){return!!n&&!(n instanceof MediaStreamTrack)&&n.isLocal}function Qe(n){return!!n&&n.kind==C.Kind.Audio}function It(n){return!!n&&n.kind==C.Kind.Video}function bt(n){return Nt(n)&&It(n)}function it(n){return Nt(n)&&Qe(n)}function jr(n){return!!n&&!n.isLocal}function Yh(n){return!!n&&!n.isLocal}function rr(n){return jr(n)&&It(n)}function Xh(n){return n.isLocal}function Zh(n,e){const t=[];let i=new TextEncoder().encode(n);for(;i.length>e;){let r=e;for(;r>0;){const s=i[r];if(s!==void 0&&(s&192)!==128)break;r--}t.push(i.slice(0,r)),i=i.slice(r)}return i.length>0&&t.push(i),t}function nl(n,e,t){var i,r,s,o;const{optionsWithoutProcessor:a,audioProcessor:c,videoProcessor:l}=sl(n??{}),u=e?.processor,d=t?.processor,f=a??{};return f.audio===!0&&(f.audio={}),f.video===!0&&(f.video={}),f.audio&&(Br(f.audio,e),(i=(s=f.audio).deviceId)!==null&&i!==void 0||(s.deviceId={ideal:"default"}),(c||u)&&(f.audio.processor=c??u)),f.video&&(Br(f.video,t),(r=(o=f.video).deviceId)!==null&&r!==void 0||(o.deviceId={ideal:"default"}),(l||d)&&(f.video.processor=l??d)),f}function Br(n,e){return Object.keys(e).forEach(t=>{n[t]===void 0&&(n[t]=e[t])}),n}function ks(n){var e,t,i,r;const s={};if(n.video)if(typeof n.video=="object"){const o={},a=o,c=n.video;Object.keys(c).forEach(l=>{switch(l){case"resolution":Br(a,c.resolution);break;default:a[l]=c[l]}}),s.video=o,(e=(i=s.video).deviceId)!==null&&e!==void 0||(i.deviceId={ideal:"default"})}else s.video=n.video?{deviceId:{ideal:"default"}}:!1;else s.video=!1;return n.audio?typeof n.audio=="object"?(s.audio=n.audio,(t=(r=s.audio).deviceId)!==null&&t!==void 0||(r.deviceId={ideal:"default"})):s.audio={deviceId:{ideal:"default"}}:s.audio=!1,s}function il(n){return v(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const i=rl();if(i){const r=i.createAnalyser();r.fftSize=2048;const s=r.frequencyBinCount,o=new Uint8Array(s);i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield ve(t),r.getByteTimeDomainData(o);const c=o.some(l=>l!==128&&l!==0);return i.close(),!c}return!1})()})}function rl(){var n;const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e){const t=new e({latencyHint:"interactive"});if(t.state==="suspended"&&typeof window<"u"&&(!((n=window.document)===null||n===void 0)&&n.body)){const i=()=>v(this,void 0,void 0,function*(){var r;try{t.state==="suspended"&&(yield t.resume())}catch(s){console.warn("Error trying to auto-resume audio context",s)}finally{(r=window.document.body)===null||r===void 0||r.removeEventListener("click",i)}});t.addEventListener("statechange",()=>{var r;t.state==="closed"&&((r=window.document.body)===null||r===void 0||r.removeEventListener("click",i))}),window.document.body.addEventListener("click",i)}return t}}function ef(n){return n==="audioinput"?C.Source.Microphone:n==="videoinput"?C.Source.Camera:C.Source.Unknown}function Vr(n){return n===C.Source.Microphone?"audioinput":n===C.Source.Camera?"videoinput":void 0}function tf(n){var e,t;let i=(e=n.video)!==null&&e!==void 0?e:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(i=typeof i=="boolean"?{}:i,jt()?i=Object.assign(Object.assign({},i),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(t=n.audio)!==null&&t!==void 0?t:!1,video:i,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio,preferCurrentTab:n.preferCurrentTab}}function Pn(n){return n.split("/")[1].toLowerCase()}function nf(n){const e=[];return n.forEach(t=>{t.track!==void 0&&e.push(new ds({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function V(n){return"mediaStreamTrack"in n?{trackID:n.sid,source:n.source,muted:n.isMuted,enabled:n.mediaStreamTrack.enabled,kind:n.kind,streamID:n.mediaStreamID,streamTrackID:n.mediaStreamTrack.id}:{trackID:n.trackSid,enabled:n.isEnabled,muted:n.isMuted,trackInfo:Object.assign({mimeType:n.mimeType,name:n.trackName,encrypted:n.isEncrypted,kind:n.kind,source:n.source},n.track?V(n.track):{})}}function rf(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function sf(n,e){var t;n===void 0&&(n={}),e===void 0&&(e={});const i=[...Object.keys(e),...Object.keys(n)],r={};for(const s of i)n[s]!==e[s]&&(r[s]=(t=e[s])!==null&&t!==void 0?t:"");return r}function sl(n){const e=Object.assign({},n);let t,i;return typeof e.audio=="object"&&e.audio.processor&&(t=e.audio.processor,e.audio=Object.assign(Object.assign({},e.audio),{processor:void 0})),typeof e.video=="object"&&e.video.processor&&(i=e.video.processor,e.video=Object.assign(Object.assign({},e.video),{processor:void 0})),{audioProcessor:t,videoProcessor:i,optionsWithoutProcessor:wh(e)}}function of(n){switch(n){case ne.CAMERA:return C.Source.Camera;case ne.MICROPHONE:return C.Source.Microphone;case ne.SCREEN_SHARE:return C.Source.ScreenShare;case ne.SCREEN_SHARE_AUDIO:return C.Source.ScreenShareAudio;default:return C.Source.Unknown}}function Lo(n,e){return n.width*n.height<e.width*e.height}function af(n,e){var t;return(t=n.layers)===null||t===void 0?void 0:t.find(i=>i.quality===e)}class cf extends et.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=i=>{var r,s;const{kind:o,data:a}=i.data;switch(o){case"error":F.error(a.error.message),this.emit(St.EncryptionError,a.error);break;case"initAck":a.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)});break;case"enable":if(a.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)}),this.encryptionEnabled!==a.enabled&&a.participantIdentity===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity))this.emit(St.ParticipantEncryptionStatusChanged,a.enabled,this.room.localParticipant),this.encryptionEnabled=a.enabled;else if(a.participantIdentity){const u=(s=this.room)===null||s===void 0?void 0:s.getParticipantByIdentity(a.participantIdentity);if(!u)throw TypeError("couldn't set encryption status, participant not found".concat(a.participantIdentity));this.emit(St.ParticipantEncryptionStatusChanged,a.enabled,u)}break;case"ratchetKey":this.keyProvider.emit(Ct.KeyRatcheted,a.ratchetResult,a.participantIdentity,a.keyIndex);break;case"decryptDataResponse":const c=this.decryptDataRequests.get(a.uuid);c?.resolve&&c.resolve(a);break;case"encryptDataResponse":const l=this.encryptDataRequests.get(a.uuid);l?.resolve&&l.resolve(a);break}},this.onWorkerError=i=>{F.error("e2ee worker encountered an error:",{error:i.error}),this.emit(St.EncryptionError,i.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!Sh())throw new bs("tried to setup end-to-end encryption on an unsupported browser");if(F.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:sh.getLevel()}};this.worker&&(F.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){F.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?F.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(L.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(P.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==oe.NONE,r.identity)),e.on(P.ConnectionStateChanged,i=>{i===W.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==oe.NONE,r.identity)})})}).on(P.TrackUnsubscribed,(i,r,s)=>{var o;const a={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(o=this.worker)===null||o===void 0||o.postMessage(a)}).on(P.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(P.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(i=>{this.postKey(i)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(_.LocalSenderCreated,(i,r)=>v(this,void 0,void 0,function*(){this.setupE2EESender(r,i)})),e.localParticipant.on(_.LocalTrackPublished,i=>{if(!It(i.track)||!An())return;const r={kind:"updateCodec",data:{trackId:i.track.mediaStreamID,codec:Pn(i.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r)}),t.on(Ct.SetKey,i=>this.postKey(i)).on(Ct.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}encryptData(e){return v(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),i={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},r=new Oe;return r.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,r),this.worker.postMessage(i),r.promise})}handleEncryptedData(e,t,i,r){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const s=crypto.randomUUID(),o={kind:"decryptDataRequest",data:{uuid:s,payload:e,iv:t,participantIdentity:i,keyIndex:r}},a=new Oe;return a.onFinally=()=>{this.decryptDataRequests.delete(s)},this.decryptDataRequests.set(s,a),this.worker.postMessage(o),a.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(o)}postEnable(e,t){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!i?.mimeType||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?Pn(i.mimeType):void 0)}}setupE2EESender(e,t){if(!Nt(e)||!t){t||F.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,i,r){return v(this,void 0,void 0,function*(){if(this.worker){if(xr()&&!xo()){const s={kind:"decode",participantIdentity:i,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(gn in e&&r){const c={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,o=e.readableStream;if(!s||!o){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,o=c.readable}const a={kind:"decode",data:{readableStream:o,writableStream:s,trackId:t,codec:r,participantIdentity:i,isReuse:gn in e}};this.worker.postMessage(a,[o,s])}e[gn]=!0}})}handleSender(e,t,i){var r;if(!(gn in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(xr()&&!xo()){F.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{F.info("initialize encoded streams");const s=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(o,[s.readable,s.writable])}e[gn]=!0}}}const sr="default";class ue{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new ue),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;if(((s=ue.userMediaPromiseMap)===null||s===void 0?void 0:s.size)>0){F.debug("awaiting getUserMedia promise");try{t?yield ue.userMediaPromiseMap.get(t):yield Promise.all(ue.userMediaPromiseMap.values())}catch{F.warn("error waiting for media permissons")}}let o=yield navigator.mediaDevices.enumerateDevices();if(r&&!(jt()&&i.hasDeviceInUse(t))&&(o.filter(c=>c.kind===t).length===0||o.some(c=>{const l=c.label==="",u=t?c.kind===t:!0;return l&&u}))){const c={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}},l=yield navigator.mediaDevices.getUserMedia(c);o=yield navigator.mediaDevices.enumerateDevices(),l.getTracks().forEach(u=>{u.stop()})}return i._previousDevices=o,t&&(o=o.filter(a=>a.kind===t)),o})()})}normalizeDeviceId(e,t,i){return v(this,void 0,void 0,function*(){if(t!==sr)return t;const r=yield this.getDevices(e),s=r.find(a=>a.deviceId===sr);if(!s){F.warn("could not reliably determine default device");return}const o=r.find(a=>a.deviceId!==sr&&a.groupId===(i??s.groupId));if(!o){F.warn("could not reliably determine default device");return}return o?.deviceId})}hasDeviceInUse(e){return e?ue.userMediaPromiseMap.has(e):ue.userMediaPromiseMap.size>0}}ue.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];ue.userMediaPromiseMap=new Map;var Rn;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(Rn||(Rn={}));class lf{constructor(){this.pendingTasks=new Map,this.taskMutex=new Ce,this.nextTaskIndex=0}run(e){return v(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Rn.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=Rn.RUNNING,yield e()}finally{t.status=Rn.COMPLETED,this.pendingTasks.delete(t.id),i()}})}flush(){return v(this,void 0,void 0,function*(){return this.run(()=>v(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class uf{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i,r;if(!((i=t.signal)===null||i===void 0)&&i.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const s=new WebSocket(e,(r=t.protocols)!==null&&r!==void 0?r:[]);s.binaryType="arraybuffer",this.ws=s;const o=function(){let{closeCode:a,reason:c}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.close(a,c)};this.opened=new Promise((a,c)=>{s.onopen=()=>{a({readable:new ReadableStream({start(l){s.onmessage=u=>{let{data:d}=u;return l.enqueue(d)},s.onerror=u=>l.error(u)},cancel:o}),writable:new WritableStream({write(l){s.send(l)},abort(){s.close()},close:o}),protocol:s.protocol,extensions:s.extensions}),s.removeEventListener("error",c)},s.addEventListener("error",c)}),this.closed=new Promise((a,c)=>{const l=()=>v(this,void 0,void 0,function*(){const u=new Promise(f=>{s.readyState!==WebSocket.CLOSED&&s.addEventListener("close",p=>{f(p)},{once:!0})}),d=yield Promise.race([ve(250),u]);d?a(d):c(new Error("Encountered unspecified websocket error without a timely close event"))});s.onclose=u=>{let{code:d,reason:f}=u;a({closeCode:d,reason:f}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),t.signal&&(t.signal.onabort=()=>s.close()),this.close=o}}function df(n,e){const t=new URL(Jh(n));return e.forEach((i,r)=>{t.searchParams.set(r,i)}),ol(t,"rtc")}function hf(n){const e=new URL(Fr(n));return ol(e,"validate")}function ff(n){return n.endsWith("/")?n:"".concat(n,"/")}function ol(n,e){return n.pathname="".concat(ff(n.pathname)).concat(e),n.toString()}function Uo(n){if(typeof n=="string")return ho.fromJson(JSON.parse(n),{ignoreUnknownFields:!0});if(n instanceof ArrayBuffer)return ho.fromBinary(new Uint8Array(n));throw new Error("could not decode websocket message: ".concat(typeof n))}function pf(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Unknown reason";if(!(n instanceof AbortSignal))return e;const t=n.reason;switch(typeof t){case"string":return t;case"object":return t instanceof Error?t.message:e;default:return"toString"in t?t.toString():e}}const mf=["syncState","trickle","offer","answer","simulate","leave"];function gf(n){const e=mf.indexOf(n.case)>=0;return F.trace("request allowed to bypass queue:",{canPass:e,req:n}),e}var Y;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(Y||(Y={}));const vf=250;class Ss{get currentState(){return this.state}get isDisconnected(){return this.state===Y.DISCONNECTING||this.state===Y.DISCONNECTED}get isEstablishingConnection(){return this.state===Y.CONNECTING||this.state===Y.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=Y.DISCONNECTED,this.log=F,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=lt((i=t.loggerName)!==null&&i!==void 0?i:je.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new lf,this.queuedRequests=[],this.closingLock=new Ce,this.connectionLock=new Ce,this.state=Y.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,r){return v(this,void 0,void 0,function*(){return this.state=Y.CONNECTING,this.options=i,yield this.connect(e,t,i,r)})}reconnect(e,t,i,r){return v(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=Y.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}))})}connect(e,t,i,r){return v(this,void 0,void 0,function*(){const s=yield this.connectionLock.lock();this.connectOptions=i;const o=Kh(),a=i.singlePeerConnection?yf(t,o,i):bf(t,o,i),c=df(e,a),l=hf(c);return new Promise((u,d)=>v(this,void 0,void 0,function*(){var f,p;try{let g=!1;const m=S=>v(this,void 0,void 0,function*(){if(g)return;g=!0;const y=S instanceof Event?S.currentTarget:S,T=pf(y,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(T)).catch(I=>{this.log.error(I),this.close()}):this.close(),k(),d(y instanceof AbortSignal?y.reason:y)});r?.addEventListener("abort",m);const k=()=>{clearTimeout(b),r?.removeEventListener("abort",m)},b=setTimeout(()=>{m(new H("room connection has timed out (signal)",z.ServerUnreachable))},i.websocketTimeout),w=(S,y)=>{this.handleSignalConnected(S,b,y)},R=new URL(c);R.searchParams.has("access_token")&&R.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(R),Object.assign({reconnect:i.reconnect,reconnectReason:i.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new uf(c);try{this.ws.closed.then(O=>{this.isEstablishingConnection&&d(new H("Websocket got closed during a (re)connection attempt: ".concat(O.reason),z.InternalError)),O.closeCode!==1e3&&this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:O.reason,code:O.closeCode,wasClean:O.closeCode===1e3,state:this.state}))}).catch(O=>{this.isEstablishingConnection&&d(new H("Websocket error during a (re)connection attempt: ".concat(O),z.InternalError))});const S=yield this.ws.opened.catch(O=>v(this,void 0,void 0,function*(){if(this.state!==Y.CONNECTED){this.state=Y.DISCONNECTED,clearTimeout(b);const A=yield this.handleConnectionError(O,l);d(A);return}this.handleWSError(O),d(O)}));if(clearTimeout(b),!S)return;const y=S.readable.getReader();this.streamWriter=S.writable.getWriter();const T=yield y.read();if(y.releaseLock(),!T.value)throw new H("no message received as first message",z.InternalError);const I=Uo(T.value),D=this.validateFirstMessage(I,(f=i.reconnect)!==null&&f!==void 0?f:!1);if(!D.isValid){d(D.error);return}((p=I.message)===null||p===void 0?void 0:p.case)==="join"&&(this.pingTimeoutDuration=I.message.value.pingTimeout,this.pingIntervalDuration=I.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));const x=D.shouldProcessFirstMessage?I:void 0;w(S,x),u(D.response)}catch(S){d(S)}finally{k()}}finally{s()}}))})}startReadingLoop(e,t){return v(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield ve(this.signalLatency));const{done:i,value:r}=yield e.read();if(i)break;const s=Uo(r);this.handleSignalResponse(s)}})}close(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Close method called on signal client";return(function*(){const r=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=Y.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:i});const s=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([s,ve(vf)])}}catch(s){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:s}))}finally{t&&(e.state=Y.DISCONNECTED),r()}})()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Qt(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Qt(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new xi({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Oi({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return v(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const a=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new fs({requestId:a,metadata:i,name:r,attributes:o})}),a})()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new fc({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new gc({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:Q.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new yc({timestamp:Q.parse(Date.now()),rtt:Q.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new hs({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new Ai({reason:Fe.CLIENT_INITIATED,action:Xt.DISCONNECT})})}sendRequest(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!r&&!gf(t)&&i.state===Y.RECONNECTING){i.queuedRequests.push(()=>v(i,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(r||(yield i.requestQueue.flush()),i.signalLatency&&(yield ve(i.signalLatency)),i.isDisconnected){i.log.debug("skipping signal request (type: ".concat(t.case,") - SignalClient disconnected"));return}if(!i.streamWriter){i.log.error("cannot send signal request before connected, type: ".concat(t?.case),i.logContext);return}const o=new Id({message:t});try{i.useJSON?yield i.streamWriter.write(o.toJsonString()):yield i.streamWriter.write(o.toBinary())}catch(a){i.log.error("error sending signal message",Object.assign(Object.assign({},i.logContext),{error:a}))}})()})}handleSignalResponse(e){var t,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const o=Fo(r.value);this.onAnswer&&this.onAnswer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="offer"){const o=Fo(r.value);this.onOffer&&this.onOffer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="trickle"){const o=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(o,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):r.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(r.value.token),this.onRoomMoved&&this.onRoomMoved(r.value)):r.case==="mediaSectionsRequirement"?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(r.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return v(this,void 0,void 0,function*(){if(this.state===Y.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=he.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&he.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=he.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&he.clearInterval(this.pingInterval)}handleSignalConnected(e,t,i){this.state=Y.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),i)}validateFirstMessage(e,t){var i,r,s,o,a;return((i=e.message)===null||i===void 0?void 0:i.case)==="join"?{isValid:!0,response:e.message.value}:this.state===Y.RECONNECTING&&((r=e.message)===null||r===void 0?void 0:r.case)!=="leave"?((s=e.message)===null||s===void 0?void 0:s.case)==="reconnect"?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&((o=e.message)===null||o===void 0?void 0:o.case)==="leave"?{isValid:!1,error:new H("Received leave request while trying to (re)connect",z.LeaveRequest,void 0,e.message.value.reason)}:t?{isValid:!1,error:new H("Unexpected first message",z.InternalError)}:{isValid:!1,error:new H("did not receive join response, got ".concat((a=e.message)===null||a===void 0?void 0:a.case," instead"),z.InternalError)}}handleConnectionError(e,t){return v(this,void 0,void 0,function*(){try{const i=yield fetch(t);if(i.status.toFixed(0).startsWith("4")){const r=yield i.text();return new H(r,z.NotAllowed,i.status)}else return e instanceof H?e:new H("Encountered unknown websocket error during connection: ".concat(e),z.InternalError,i.status)}catch(i){return i instanceof H?i:new H(i instanceof Error?i.message:"server was not reachable",z.ServerUnreachable)}})}}function Fo(n){const e={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=n.type;break}return e}function Qt(n,e){return new Rt({sdp:n.sdp,type:n.type,id:e})}function bf(n,e,t){var i;const r=new URLSearchParams;return r.set("access_token",n),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",Xe()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),r}function yf(n,e,t){const i=new URLSearchParams;i.set("access_token",n);const r=new Yd({clientInfo:e,connectionSettings:new kc({autoSubscribe:!!t.autoSubscribe,adaptiveStream:!!t.adaptiveStream}),reconnect:!!t.reconnect,participantSid:t.sid?t.sid:void 0});t.reconnectReason&&(r.reconnectReason=t.reconnectReason);const s=new Xd({joinRequest:r.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(s.toBinary()))),i}class jo{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class kf{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const i=Date.now();i-this._lastCleanup>this.ttl/2&&this.cleanup();const r=i+this.ttl;return this._map.set(e,{value:t,expiresAt:r}),this}get(e){const t=this._map.get(e);if(t){if(t.expiresAt<Date.now()){this._map.delete(e);return}return t.value}}has(e){const t=this._map.get(e);return t?t.expiresAt<Date.now()?(this._map.delete(e),!1):!0:!1}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,i]of this._map.entries())i.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e(i.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],i=this.asValueMap();for(const[r,s]of i.entries())t.push(e(s,r,i));return t}asValueMap(){const e=new Map;for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e.set(t,i.value);return e}}var Ae={},or={},ar={exports:{}},Bo;function Ts(){if(Bo)return ar.exports;Bo=1;var n=ar.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(n).forEach(function(e){var t=n[e];t.forEach(function(i){i.reg||(i.reg=/(.*)/),i.format||(i.format="%s")})}),ar.exports}var Vo;function Sf(){return Vo||(Vo=1,(function(n){var e=function(a){return String(Number(a))===a?Number(a):a},t=function(a,c,l,u){if(u&&!l)c[u]=e(a[1]);else for(var d=0;d<l.length;d+=1)a[d+1]!=null&&(c[l[d]]=e(a[d+1]))},i=function(a,c,l){var u=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:u&&!c[a.name]&&(c[a.name]={});var d=a.push?{}:u?c[a.name]:c;t(l.match(a.reg),d,a.names,a.name),a.push&&c[a.push].push(d)},r=Ts(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(a){var c={},l=[],u=c;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var f=d[0],p=d.slice(2);f==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var g=0;g<(r[f]||[]).length;g+=1){var m=r[f][g];if(m.reg.test(p))return i(m,u,p)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=e(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};n.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(a){return a.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},n.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},n.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}})(or)),or}var cr,qo;function Tf(){if(qo)return cr;qo=1;var n=Ts(),e=/%[sdv%]/g,t=function(o){var a=1,c=arguments,l=c.length;return o.replace(e,function(u){if(a>=l)return u;var d=c[a];switch(a+=1,u){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},i=function(o,a,c){var l=a.format instanceof Function?a.format(a.push?c:c[a.name]):a.format,u=[o+"="+l];if(a.names)for(var d=0;d<a.names.length;d+=1){var f=a.names[d];a.name?u.push(c[a.name][f]):u.push(c[a.names[d]])}else u.push(c[a.name]);return t.apply(null,u)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return cr=function(o,a){a=a||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var c=a.outerOrder||r,l=a.innerOrder||s,u=[];return c.forEach(function(d){n[d].forEach(function(f){f.name in o&&o[f.name]!=null?u.push(i(d,f,o)):f.push in o&&o[f.push]!=null&&o[f.push].forEach(function(p){u.push(i(d,f,p))})})}),o.media.forEach(function(d){u.push(i("m",n.m[0],d)),l.forEach(function(f){n[f].forEach(function(p){p.name in d&&d[p.name]!=null?u.push(i(f,p,d)):p.push in d&&d[p.push]!=null&&d[p.push].forEach(function(g){u.push(i(f,p,g))})})})}),u.join(`\r
`)+`\r
`},cr}var Wo;function Cf(){if(Wo)return Ae;Wo=1;var n=Sf(),e=Tf(),t=Ts();return Ae.grammar=t,Ae.write=e,Ae.parse=n.parse,Ae.parseParams=n.parseParams,Ae.parseFmtpConfig=n.parseFmtpConfig,Ae.parsePayloads=n.parsePayloads,Ae.parseRemoteCandidates=n.parseRemoteCandidates,Ae.parseImageAttributes=n.parseImageAttributes,Ae.parseSimulcastStreamList=n.parseSimulcastStreamList,Ae}var yt=Cf();function Cs(n,e,t){var i,r,s;e===void 0&&(e=50),t===void 0&&(t={});var o=(i=t.isImmediate)!=null&&i,a=(r=t.callback)!=null&&r,c=t.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var p=Date.now()-l;if(p+e>=c)return c-p}return e}var f=function(){var p=[].slice.call(arguments),g=this;return new Promise(function(m,k){var b=o&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!o){var R=n.apply(g,p);a&&a(R),u.forEach(function(S){return(0,S.resolve)(R)}),u=[]}},d()),b){var w=n.apply(g,p);return a&&a(w),m(w)}u.push({resolve:m,reject:k})})};return f.cancel=function(p){s!==void 0&&clearTimeout(s),u.forEach(function(g){return(0,g.reject)(p)}),u=[]},f}const Ef=.7,wf=20,tn={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class zo extends et.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super(),this.log=F,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Cs(r=>v(this,void 0,void 0,function*(){this.emit(tn.NegotiationStarted);try{yield this.createAndSendOffer()}catch(s){if(r)r(s);else throw s}}),wf),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=lt((i=t.loggerName)!==null&&i!==void 0?i:je.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new Ce}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var i;t.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,t.candidate))},e.onicecandidateerror=t=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,t)},e.ontrack=t=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return v(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return v(this,void 0,void 0,function*(){var i;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let r;if(e.type==="offer"){let{stereoMids:s,nackMids:o}=Pf(e);this.remoteStereoMids=s,this.remoteNackMids=o}else if(e.type==="answer"){const s=yt.parse((i=e.sdp)!==null&&i!==void 0?i:"");s.media.forEach(o=>{const a=Es(o.mid);o.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||a!=c.transceiver.mid)return!1;let l=0;if(o.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0)return!0;let u=!1;for(const d of o.fmtp)if(d.payload===l){d.config=d.config.split(";").filter(f=>!f.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(d.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),u=!0;break}return u||c.maxbr>0&&o.fmtp.push({payload:l,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),r=yt.write(s)}return yield this.setMungedSDP(e,r,!0),this.pendingCandidates.forEach(s=>{this.pc.addIceCandidate(s)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(tn.NegotiationComplete),e.sdp&&yt.parse(e.sdp).media.forEach(o=>{o.type==="video"&&this.emit(tn.RTPVideoPayloadTypes,o.rtp)})),!0})}createAndSendOffer(e){return v(this,void 0,void 0,function*(){var t;const i=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const a=this._pc.remoteDescription;if(e?.iceRestart&&a)yield this._pc.setRemoteDescription(a);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const r=this.latestOfferId+1;this.latestOfferId=r;const s=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const o=yt.parse((t=s.sdp)!==null&&t!==void 0?t:"");if(o.media.forEach(a=>{Ko(a),a.type==="audio"?Ho(a,["all"],[]):a.type==="video"&&this.trackBitrates.some(c=>{if(!a.msid||!c.cid||!a.msid.includes(c.cid))return!1;let l=0;if(a.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0||($e(c.codec)&&!jt()&&this.ensureVideoDDExtensionForSVC(a,o),c.codec!=="av1"))return!0;const u=Math.round(c.maxbr*Ef);for(const d of a.fmtp)if(d.payload===l){d.config.includes("x-google-start-bitrate")||(d.config+=";x-google-start-bitrate=".concat(u));break}return!0})}),this.latestOfferId>r){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:r}));return}yield this.setMungedSDP(s,yt.write(o)),this.onOffer(s,this.latestOfferId)}finally{i()}})}createAndSetAnswer(){return v(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),i=yt.parse((e=t.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{Ko(r),r.type==="audio"&&Ho(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,yt.write(i)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new se("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new se("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return v(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(a=>{switch(a.type){case"transport":t=a.selectedCandidatePairId;break;case"candidate-pair":t===""&&a.selected&&(t=a.id),i.set(a.id,a);break;case"remote-candidate":r.set(a.id,"".concat(a.address,":").concat(a.port));break}}),t==="")return;const o=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(o!==void 0)return r.get(o)})}setMungedSDP(e,t,i){return v(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:t})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const o={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new Or(s)}})}ensureVideoDDExtensionForSVC(e,t){var i,r;if(!((i=e.ext)===null||i===void 0?void 0:i.some(o=>o.uri===Io))){if(this.ddExtID===0){let o=0;t.media.forEach(a=>{var c;a.type==="video"&&((c=a.ext)===null||c===void 0||c.forEach(l=>{l.value>o&&(o=l.value)}))}),this.ddExtID=o+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:Io})}}}function Ho(n,e,t){const i=Es(n.mid);let r=0;n.rtp.some(s=>s.codec==="opus"?(r=s.payload,!0):!1),r>0&&(n.rtcpFb||(n.rtcpFb=[]),t.includes(i)&&!n.rtcpFb.some(s=>s.payload===r&&s.type==="nack")&&n.rtcpFb.push({payload:r,type:"nack"}),(e.includes(i)||e.length===1&&e[0]==="all")&&n.fmtp.some(s=>s.payload===r?(s.config.includes("stereo=1")||(s.config+=";stereo=1"),!0):!1))}function Pf(n){var e;const t=[],i=[],r=yt.parse((e=n.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(o=>{var a;const c=Es(o.mid);o.type==="audio"&&(o.rtp.some(l=>l.codec==="opus"?(s=l.payload,!0):!1),!((a=o.rtcpFb)===null||a===void 0)&&a.some(l=>l.payload===s&&l.type==="nack")&&i.push(c),o.fmtp.some(l=>l.payload===s?(l.config.includes("sprop-stereo=1")&&t.push(c),!0):!1))}),{stereoMids:t,nackMids:i}}function Ko(n){if(n.connection){const e=n.connection.ip.indexOf(":")>=0;(n.connection.version===4&&e||n.connection.version===6&&!e)&&(n.connection.ip="0.0.0.0",n.connection.version=4)}}function Es(n){return typeof n=="number"?n.toFixed(0):n}const qr="vp8",Rf={audioPreset:Mr.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ys.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:qr,backupCodec:!0,preConnectBuffer:!1},al={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},cl={deviceId:{ideal:"default"},resolution:Mn.h720.resolution},_f={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new ah,disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},ws={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var X;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(X||(X={}));class If{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,i){var r;this.peerConnectionTimeout=ws.peerConnectionTimeout,this.log=F,this.updateState=()=>{var s,o;const a=this.state,c=this.requiredTransports.map(l=>l.getConnectionState());c.every(l=>l==="connected")?this.state=X.CONNECTED:c.some(l=>l==="failed")?this.state=X.FAILED:c.some(l=>l==="connecting")?this.state=X.CONNECTING:c.every(l=>l==="closed")?this.state=X.CLOSED:c.some(l=>l==="closed")?this.state=X.CLOSING:c.every(l=>l==="new")&&(this.state=X.NEW),a!==this.state&&(this.log.debug("pc state change: from ".concat(X[a]," to ").concat(X[this.state]),this.logContext),(s=this.onStateChange)===null||s===void 0||s.call(this,this.state,this.publisher.getConnectionState(),(o=this.subscriber)===null||o===void 0?void 0:o.getConnectionState()))},this.log=lt((r=i.loggerName)!==null&&r!==void 0?r:je.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=t!=="subscriber-primary",this.isSubscriberConnectionRequired=t==="subscriber-primary",this.publisher=new zo(e,i),t!=="publisher-only"&&(this.subscriber=new zo(e,i),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,Le.SUBSCRIBER)},this.subscriber.onDataChannel=s=>{var o;(o=this.onDataChannel)===null||o===void 0||o.call(this,s)},this.subscriber.onTrack=s=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,s)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,Le.PUBLISHER)},this.publisher.onTrack=s=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,s)},this.publisher.onOffer=(s,o)=>{var a;(a=this.onPublisherOffer)===null||a===void 0||a.call(this,s,o)},this.state=X.NEW,this.connectionLock=new Ce,this.remoteOfferLock=new Ce}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return v(this,void 0,void 0,function*(){var e;if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const i of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(i)}catch(r){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:r}))}}yield Promise.all([this.publisher.close(),(e=this.subscriber)===null||e===void 0?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return v(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return v(this,void 0,void 0,function*(){var i;t===Le.PUBLISHER?yield this.publisher.addIceCandidate(e):yield(i=this.subscriber)===null||i===void 0?void 0:i.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return v(this,void 0,void 0,function*(){var i,r,s;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:(i=this.subscriber)===null||i===void 0?void 0:i.getSignallingState().toString()}));const o=yield this.remoteOfferLock.lock();try{return(yield(r=this.subscriber)===null||r===void 0?void 0:r.setRemoteDescription(e,t))?yield(s=this.subscriber)===null||s===void 0?void 0:s.createAndSetAnswer():void 0}finally{o()}})}updateConfiguration(e,t){var i;this.publisher.setConfiguration(e),(i=this.subscriber)===null||i===void 0||i.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return v(this,void 0,void 0,function*(){var i;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,t)))}finally{r()}})}negotiate(e){return v(this,void 0,void 0,function*(){return new Promise((t,i)=>v(this,void 0,void 0,function*(){const r=setTimeout(()=>{i("negotiation timed out")},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i("negotiation aborted")};e.signal.addEventListener("abort",s),this.publisher.once(tn.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(tn.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(o=>{clearTimeout(r),i(o)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const i=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(r=>r.receiver===e);return i?.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Le.PUBLISHER?this.publisher.getConnectedAddress():e===Le.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return v(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(i.getConnectionState()!=="connected")return new Promise((c,l)=>v(s,void 0,void 0,function*(){const u=()=>{this.log.warn("abort transport connection",this.logContext),he.clearTimeout(d),l(new H("room connection has been cancelled",z.Cancelled))};r?.signal.aborted&&u(),r?.signal.addEventListener("abort",u);const d=he.setTimeout(()=>{r?.signal.removeEventListener("abort",u),l(new H("could not establish pc connection",z.InternalError))},o);for(;this.state!==X.CONNECTED;)if(yield ve(50),r?.signal.aborted){l(new H("room connection has been cancelled",z.Cancelled));return}he.clearTimeout(d),r?.signal.removeEventListener("abort",u),c()}))})()})}}class ee extends Error{constructor(e,t,i){super(t),this.code=e,this.message=Go(t,ee.MAX_MESSAGE_BYTES),this.data=i?Go(i,ee.MAX_DATA_BYTES):void 0}static fromProto(e){return new ee(e.code,e.message,e.data)}toProto(){return new tc({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new ee(ee.ErrorCode[e],ee.ErrorMessage[e],t)}}ee.MAX_MESSAGE_BYTES=256;ee.MAX_DATA_BYTES=15360;ee.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};ee.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const ll=15360;function Ps(n){return new TextEncoder().encode(n).length}function Go(n,e){if(Ps(n)<=e)return n;let t=0,i=n.length;const r=new TextEncoder;for(;t<i;){const s=Math.floor((t+i+1)/2);r.encode(n.slice(0,s)).length<=e?t=s:i=s-1}return n.slice(0,t)}const Rs=2e3;function Ni(n,e){if(!e)return 0;let t,i;return"bytesReceived"in n?(t=n.bytesReceived,i=e.bytesReceived):"bytesSent"in n&&(t=n.bytesSent,i=e.bytesSent),t===void 0||i===void 0||n.timestamp===void 0||e.timestamp===void 0?0:(t-i)*8*1e3/(n.timestamp-e.timestamp)}const _s=typeof MediaRecorder<"u";class xf{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const Of=_s?MediaRecorder:xf;class Mf extends Of{constructor(e,t){if(!_s)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let i,r;const s=()=>r===void 0,o=()=>{this.removeEventListener("dataavailable",i),this.removeEventListener("stop",o),this.removeEventListener("error",a),r?.close(),r=void 0},a=c=>{r?.error(c),this.removeEventListener("dataavailable",i),this.removeEventListener("stop",o),this.removeEventListener("error",a),r=void 0};this.byteStream=new ReadableStream({start:c=>{r=c,i=l=>v(this,void 0,void 0,function*(){let u;if(l.data.arrayBuffer){const d=yield l.data.arrayBuffer();u=new Uint8Array(d)}else if(l.data.byteArray)u=l.data.byteArray;else throw new Error("no data available!");s()||c.enqueue(u)}),this.addEventListener("dataavailable",i)},cancel:()=>{o()}}),this.addEventListener("stop",o),this.addEventListener("error",a)}}function Af(){return _s}const Df=1e3,Nf=1e4;class ul extends C{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,t,s),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=Cs(()=>v(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>v(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(N.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new Ce,this.pauseUpstreamLock=new Ce,this.trackChangeLock=new Ce,this.trackChangeLock.lock().then(o=>v(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{o()}})),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==C.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return v(this,void 0,void 0,function*(){var i;if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(s=>{en(this._mediaStreamTrack,s)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let r;if(this.processor&&e){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&($t(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),r=this.processor.processedTrack}this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"&&(yield this.sender.replaceTrack(r??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(s=>{$t(r??e,s)}))})}waitForDimensions(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Df;return(function*(){var i;if(e.kind===C.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=ge())===null||i===void 0?void 0:i.os)==="iOS"&&(yield ve(10));const r=Date.now();for(;Date.now()-r<t;){const s=e.dimensions;if(s)return s;yield ve(50)}throw new ct("unable to get track dimensions after timeout")})()})}setDeviceId(e){return v(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Et(e)||(this._constraints.deviceId=e,this.isMuted)?!0:(yield this.restartTrack(),Et(e)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if(e.source===C.Source.ScreenShare)return;const{deviceId:i,groupId:r}=e._mediaStreamTrack.getSettings(),s=e.kind===C.Kind.Audio?"audioinput":"videoinput";return t?ue.getInstance().normalizeDeviceId(s,i,r):i})()})}mute(){return v(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return v(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return v(this,void 0,void 0,function*(){const i=yield this.trackChangeLock.lock();try{if(!this.sender)throw new ct("unable to replace an unpublished track");let r,s;return typeof t=="boolean"?r=t:t!==void 0&&(r=t.userProvidedTrack,s=t.stopProcessor),this.providedByUser=r??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),s&&this.processor&&(yield this.internalStopProcessor()),this}finally{i()}})}restart(e){return v(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:i,facingMode:r}=e,s=ch(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const o={audio:!1,video:!1};this.kind===C.Kind.Video?o.video=i||r?{deviceId:i,facingMode:r}:!0:o.audio=i?Object.assign({deviceId:i},s):!0,this.attachedElements.forEach(l=>{en(this.mediaStreamTrack,l)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const c=(yield navigator.mediaDevices.getUserMedia(o)).getTracks()[0];return this.kind===C.Kind.Video&&(yield c.applyConstraints(s)),c.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(c),this._constraints=e,this.emit(N.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?N.Muted:N.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return v(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Zc()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return v(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(N.UpstreamPaused,this);const i=ge();if(i?.name==="Safari"&&Be(i.version,"12.0")<0)throw new bs("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return v(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(N.UpstreamResumed,this),((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return v(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;const o=yield i.trackChangeLock.lock();try{i.log.debug("setting up processor",i.logContext);const a=document.createElement(i.kind),c={kind:i.kind,track:i._mediaStreamTrack,element:a,audioContext:i.audioContext};if(yield t.init(c),i.log.debug("processor initialized",i.logContext),i.processor&&(yield i.internalStopProcessor()),i.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if($t(i._mediaStreamTrack,a),a.muted=!0,a.play().catch(l=>{l instanceof DOMException&&l.name==="AbortError"?(i.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},i.logContext),{error:l})),setTimeout(()=>{a.play().catch(u=>{i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{err:u}))})},100)):i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{error:l}))}),i.processor=t,i.processorElement=a,i.processor.processedTrack){for(const l of i.attachedElements)l!==i.processorElement&&r&&(en(i._mediaStreamTrack,l),$t(i.processor.processedTrack,l));yield(s=i.sender)===null||s===void 0?void 0:s.replaceTrack(i.processor.processedTrack)}i.emit(N.TrackProcessorUpdate,i.processor)}finally{o()}})()})}getProcessor(){return this.processor}stopProcessor(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const i=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{i()}})()})}internalStopProcessor(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var i,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(i=e.processor.processedTrack)===null||i===void 0||i.stop(),yield e.processor.destroy(),e.processor=void 0,t||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(N.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!Af()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="video/mp4"),this.localTrackRecorder=new Mf(this,{mimeType:t})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},Nf)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class mi extends ul{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,C.Kind.Audio,t,i,s),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>v(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let o;try{o=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}o&&this.prevStats&&(this._currentBitrate=Ni(o,this.prevStats)),this.prevStats=o}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(N.AudioTrackFeatureUpdate,this,le.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(N.AudioTrackFeatureUpdate,this,le.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return v(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===C.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return v(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Et(this._constraints.deviceId);return this.source===C.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return v(this,void 0,void 0,function*(){let t;if(e){const i=ks({audio:e});typeof i.audio!="boolean"&&(t=i.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return v(this,void 0,void 0,function*(){const i=yield t.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){Te()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},Rs)))}setProcessor(e){return v(this,void 0,void 0,function*(){var t;const i=yield this.trackChangeLock.lock();try{if(!Xe()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(N.TrackProcessorUpdate,this.processor)}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return v(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let i;return t.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return v(this,void 0,void 0,function*(){const e=yield il(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(N.AudioSilenceDetected)),e})}}function Lf(n,e,t){switch(n.kind){case"audio":return new mi(n,e,!1,void 0,t);case"video":return new gi(n,e,!1,t);default:throw new ct("unsupported track type: ".concat(n.kind))}}const Uf=Object.values(Mn),Ff=Object.values(Ar),jf=Object.values(ys),Bf=[Mn.h180,Mn.h360],Vf=[Ar.h180,Ar.h360],qf=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(t=>{var i,r;return new G(Math.floor(n.width/t.scaleResolutionDownBy),Math.floor(n.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=n.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,n.encoding.priority)}),Wr=["q","h","f"];function zr(n,e,t,i){var r,s;let o=i?.videoEncoding;n&&(o=i?.screenShareEncoding);const a=i?.simulcast,c=i?.scalabilityMode,l=i?.videoCodec;if(!o&&!a&&!c||!e||!t)return[{}];o||(o=zf(n,e,t,l),F.debug("using video encoding",o));const u=o.maxFramerate,d=new G(e,t,o.maxBitrate,o.maxFramerate,o.priority);if(c&&$e(l)){const g=new dl(c),m=[];if(g.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const k=ge();if(An()||Xe()||k?.name==="Chrome"&&Be(k?.version,"113")<0){const b=g.suffix=="h"?2:3,w=qh(k);for(let R=0;R<g.spatial;R+=1)m.push({rid:Wr[2-R],maxBitrate:o.maxBitrate/Math.pow(b,R),maxFramerate:d.encoding.maxFramerate,scaleResolutionDownBy:w?Math.pow(2,R):void 0});m[0].scalabilityMode=c}else m.push({maxBitrate:o.maxBitrate,maxFramerate:d.encoding.maxFramerate,scalabilityMode:c});return d.encoding.priority&&(m[0].priority=d.encoding.priority,m[0].networkPriority=d.encoding.priority),F.debug("using svc encoding",{encodings:m}),m}if(!a)return[o];let f=[];n?f=(r=$o(i?.screenShareSimulcastLayers))!==null&&r!==void 0?r:Jo(n,d):f=(s=$o(i?.videoSimulcastLayers))!==null&&s!==void 0?s:Jo(n,d);let p;if(f.length>0){const g=f[0];f.length>1&&([,p]=f);const m=Math.max(e,t);if(m>=960&&p)return lr(e,t,[g,p,d],u);if(m>=480)return lr(e,t,[g,d],u)}return lr(e,t,[d])}function Wf(n,e,t){var i,r,s,o;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&F.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const a=n.mediaStreamTrack.getSettings(),c=(i=a.width)!==null&&i!==void 0?i:(r=n.dimensions)===null||r===void 0?void 0:r.width,l=(s=a.height)!==null&&s!==void 0?s:(o=n.dimensions)===null||o===void 0?void 0:o.height;return n.source===C.Source.ScreenShare&&t.simulcast&&(t.simulcast=!1),zr(n.source===C.Source.ScreenShare,c,l,t)}function zf(n,e,t,i){const r=Hf(n,e,t);let{encoding:s}=r[0];const o=Math.max(e,t);for(let a=0;a<r.length;a+=1){const c=r[a];if(s=c.encoding,c.width>=o)break}if(i)switch(i){case"av1":case"h265":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function Hf(n,e,t){if(n)return jf;const i=e>t?e/t:t/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?Uf:Ff}function Jo(n,e){if(n)return qf(e);const{width:t,height:i}=e,r=t>i?t/i:i/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?Bf:Vf}function lr(n,e,t,i){const r=[];if(t.forEach((s,o)=>{if(o>=Wr.length)return;const a=Math.min(n,e),l={rid:Wr[o],scaleResolutionDownBy:Math.max(1,a/Math.min(s.width,s.height)),maxBitrate:s.encoding.maxBitrate},u=i&&s.encoding.maxFramerate?Math.min(i,s.encoding.maxFramerate):s.encoding.maxFramerate;u&&(l.maxFramerate=u);const d=Ft()||o===0;s.encoding.priority&&d&&(l.priority=s.encoding.priority,l.networkPriority=s.encoding.priority),r.push(l)}),Xe()&&tl()==="ios"){let s;r.forEach(a=>{s?a.maxFramerate&&a.maxFramerate>s&&(s=a.maxFramerate):s=a.maxFramerate});let o=!0;r.forEach(a=>{var c;a.maxFramerate!=s&&(o&&(o=!1,F.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),F.info('Setting framerate of encoding "'.concat((c=a.rid)!==null&&c!==void 0?c:"",'" to ').concat(s)),a.maxFramerate=s)})}return r}function $o(n){if(n)return n.sort((e,t)=>{const{encoding:i}=e,{encoding:r}=t;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class dl{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function Kf(n){return n.source===C.Source.ScreenShare||n.constraints.height&&Et(n.constraints.height)>=1080?"maintain-resolution":"balanced"}const Gf=5e3;class gi extends ul{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,C.Kind.Video,t,i,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>v(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(c){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:c}));return}const o=new Map(s.map(c=>[c.rid,c])),a=s.some(c=>c.qualityLimitationReason==="cpu");if(a!==this.isCpuConstrained&&(this.isCpuConstrained=a,this.isCpuConstrained&&this.emit(N.CpuConstrained)),this.prevStats){let c=0;o.forEach((l,u)=>{var d;const f=(d=this.prevStats)===null||d===void 0?void 0:d.get(u);c+=Ni(l,f)}),this._currentBitrate=c}this.prevStats=o}),this.senderLock=new Ce}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Te())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},Rs))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return v(this,void 0,void 0,function*(){var t,i,r,s,o;yield e.pauseUpstream.call(this);try{for(var a=!0,c=at(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0)s=l.value,a=!1,yield(o=s.sender)===null||o===void 0?void 0:o.replaceTrack(null)}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return v(this,void 0,void 0,function*(){var t,i,r,s,o;yield e.resumeUpstream.call(this);try{for(var a=!0,c=at(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0){s=l.value,a=!1;const u=s;yield(o=u.sender)===null||o===void 0?void 0:o.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return v(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===C.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return v(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===C.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return v(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const o={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},a=i.get(r.remoteId);a&&(o.jitter=a.jitter,o.packetsLost=a.packetsLost,o.roundTripTime=a.roundTripTime),t.push(o)}}),t.sort((r,s)=>{var o,a;return((o=s.frameWidth)!==null&&o!==void 0?o:0)-((a=r.frameWidth)!==null&&a!==void 0?a:0)}),t})}setPublishingQuality(e){const t=[];for(let i=Re.LOW;i<=Re.HIGH;i+=1)t.push(new ps({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers($e(this.codec),t)}restartTrack(e){return v(this,void 0,void 0,function*(){var t,i,r,s,o;let a;if(e){const d=ks({video:e});typeof d.video!="boolean"&&(a=d.video)}yield this.restart(a),this.isCpuConstrained=!1;try{for(var c=!0,l=at(this.simulcastCodecs.values()),u;u=yield l.next(),t=u.done,!t;c=!0){s=u.value,c=!1;const d=s;d.sender&&((o=d.sender.transport)===null||o===void 0?void 0:o.state)!=="closed"&&(d.mediaStreamTrack=this.mediaStreamTrack.clone(),yield d.sender.replaceTrack(d.mediaStreamTrack))}}catch(d){i={error:d}}finally{try{!c&&!t&&(r=l.return)&&(yield r.call(l))}finally{if(i)throw i.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return v(this,arguments,void 0,function(i){var r=this;let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var o,a,c,l,u,d;if(yield t.setProcessor.call(r,i,s),!((u=r.processor)===null||u===void 0)&&u.processedTrack)try{for(var f=!0,p=at(r.simulcastCodecs.values()),g;g=yield p.next(),o=g.done,!o;f=!0)l=g.value,f=!1,yield(d=l.sender)===null||d===void 0?void 0:d.replaceTrack(r.processor.processedTrack)}catch(m){a={error:m}}finally{try{!f&&!o&&(c=p.return)&&(yield c.call(p))}finally{if(a)throw a.error}}})()})}setDegradationPreference(e){return v(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);i&&(i.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},Gf))}setPublishingCodecs(e){return v(this,void 0,void 0,function*(){var t,i,r,s,o,a,c;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers($e(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,i=at(e);r=yield i.next(),s=r.done,!s;t=!0){c=r.value,t=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers($e(u.codec),u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const f of u.qualities)if(f.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield Qo(d.sender,d.encodings,u.qualities,this.senderLock,$e(u.codec),this.log,this.logContext))}}}catch(u){o={error:u}}finally{try{!t&&!s&&(a=i.return)&&(yield a.call(i))}finally{if(o)throw o.error}}return l})}setPublishingLayers(e,t){return v(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield Qo(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))})}prioritizePerformance(){return v(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const t=this.sender.getParameters();t.encodings=t.encodings.map((i,r)=>{var s;return Object.assign(Object.assign({},i),{active:r===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((s=this.mediaStreamTrack.getSettings().height)!==null&&s!==void 0?s:360)/360)),scalabilityMode:r===0&&$e(this.codec)?"L1T3":void 0,maxFramerate:r===0?15:0,maxBitrate:r===0?i.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:t.encodings})),this.encodings=t.encodings,yield this.sender.setParameters(t)}catch(t){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:t})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return v(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),Zc()&&this.isInBackground&&this.source===C.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function Qo(n,e,t,i,r,s,o){return v(this,void 0,void 0,function*(){const a=yield i.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},o),{sender:n,qualities:t,senderEncodings:e}));try{const c=n.getParameters(),{encodings:l}=c;if(!l)return;if(l.length!==e.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},o),{encodings:l,senderEncodings:e}));return}let u=!1;!1&&l[0].scalabilityMode||(r&&t.some(p=>p.enabled)&&t.forEach(p=>p.enabled=!0),l.forEach((f,p)=>{var g;let m=(g=f.rid)!==null&&g!==void 0?g:"";m===""&&(m="q");const k=hl(m),b=t.find(w=>w.quality===k);b&&f.active!==b.enabled&&(u=!0,f.active=b.enabled,s.debug("setting layer ".concat(b.quality," to ").concat(f.active?"enabled":"disabled"),o),Ft()&&(b.enabled?(f.scaleResolutionDownBy=e[p].scaleResolutionDownBy,f.maxBitrate=e[p].maxBitrate,f.maxFrameRate=e[p].maxFrameRate):(f.scaleResolutionDownBy=4,f.maxBitrate=10,f.maxFrameRate=2)))})),u&&(c.encodings=l,s.debug("setting encodings",Object.assign(Object.assign({},o),{encodings:c.encodings})),yield n.setParameters(c))}finally{a()}})}function hl(n){switch(n){case"f":return Re.HIGH;case"h":return Re.MEDIUM;case"q":return Re.LOW;default:return Re.HIGH}}function Yo(n,e,t,i){if(!t)return[new Tt({quality:Re.HIGH,width:n,height:e,bitrate:0,ssrc:0})];if(i){const r=t[0].scalabilityMode,s=new dl(r),o=[],a=s.suffix=="h"?1.5:2,c=s.suffix=="h"?2:3;for(let l=0;l<s.spatial;l+=1)o.push(new Tt({quality:Math.min(Re.HIGH,s.spatial-1)-l,width:Math.ceil(n/Math.pow(a,l)),height:Math.ceil(e/Math.pow(a,l)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(c,l)):0,ssrc:0}));return o}return t.map(r=>{var s,o,a;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=hl((o=r.rid)!==null&&o!==void 0?o:"");return new Tt({quality:l,width:Math.ceil(n/c),height:Math.ceil(e/c),bitrate:(a=r.maxBitrate)!==null&&a!==void 0?a:0,ssrc:0})})}const Xo="_lossy",Zo="_reliable",Jf=2*1e3,ur="leave-reconnect",$f=3e4;var Ie;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(Ie||(Ie={}));class Qf extends et.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=ws.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=Ie.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=F,this.reliableDataSequence=1,this.reliableMessageBuffer=new jo,this.reliableReceivedState=new kf($f),this.midToTrackId={},this.handleDataChannel=i=>v(this,[i],void 0,function(r){var s=this;let{channel:o}=r;return(function*(){if(o){if(o.label===Zo)s.reliableDCSub=o;else if(o.label===Xo)s.lossyDCSub=o;else return;s.log.debug("on data channel ".concat(o.id,", ").concat(o.label),s.logContext),o.onmessage=s.handleDataMessage}})()}),this.handleDataMessage=i=>v(this,void 0,void 0,function*(){var r,s,o,a,c;const l=yield this.dataProcessLock.lock();try{let u;if(i.data instanceof ArrayBuffer)u=i.data;else if(i.data instanceof Blob)u=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const d=me.fromBinary(new Uint8Array(u));if(d.sequence>0&&d.participantSid!==""){const f=this.reliableReceivedState.get(d.participantSid);if(f&&d.sequence<=f)return;this.reliableReceivedState.set(d.participantSid,d.sequence)}if(((r=d.value)===null||r===void 0?void 0:r.case)==="speaker")this.emit(L.ActiveSpeakersUpdate,d.value.value.speakers);else if(((s=d.value)===null||s===void 0?void 0:s.case)==="encryptedPacket"){if(!this.e2eeManager){this.log.error("Received encrypted packet but E2EE not set up",this.logContext);return}const f=yield(o=this.e2eeManager)===null||o===void 0?void 0:o.handleEncryptedData(d.value.value.encryptedValue,d.value.value.iv,d.participantIdentity,d.value.value.keyIndex),p=Xa.fromBinary(f.payload),g=new me({value:p.value,participantIdentity:d.participantIdentity,participantSid:d.participantSid});((a=g.value)===null||a===void 0?void 0:a.case)==="user"&&ea(g,g.value.value),this.emit(L.DataPacketReceived,g,d.value.value.encryptionType)}else((c=d.value)===null||c===void 0?void 0:c.case)==="user"&&ea(d,d.value.value),this.emit(L.DataPacketReceived,d,oe.NONE)}finally{l()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:o}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:o}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?B.LOSSY:B.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(L.Disconnected),this.close()},o=Date.now()-this.reconnectStart;let a=this.getNextRetryDelay({elapsedMs:o,retryCount:this.reconnectAttempts});if(a===null){s(o);return}i===ur&&(a=0),this.log.debug("reconnecting in ".concat(a,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=he.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),a)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===Ie.Connected&&i();const s=()=>{this.off(L.Disconnected,o),i()},o=()=>{this.off(L.Restarted,s),r()};this.once(L.Restarted,s),this.once(L.Disconnected,o)}),this.updateAndEmitDCBufferStatus=i=>{const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(L.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return i===B.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(r.bufferedAmount),r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===Y.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(At.RR_SIGNAL_DISCONNECTED))},this.log=lt((t=e.loggerName)!==null&&t!==void 0?t:je.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new Ss(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new Ce,this.dataProcessLock=new Ce,this.dcBufferStatus=new Map([[B.LOSSY,!0],[B.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(L.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(L.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(L.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(L.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(L.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(L.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(L.StreamStateChanged,i),this.client.onRequestResponse=i=>this.emit(L.SignalRequestResponse,i)}get logContext(){var e,t,i,r,s,o;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,participant:(o=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||o===void 0?void 0:o.identity,pID:this.participantSid}}join(e,t,i,r){return v(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=i,this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const s=yield this.client.join(e,t,i,r);return this._isClosed=!1,this.latestJoinResponse=s,this.subscriberPrimary=s.subscriberPrimary,this.pcManager||(yield this.configure(s)),(!this.subscriberPrimary||s.fastPublish)&&this.negotiate().catch(o=>{F.error(o,this.logContext)}),this.registerOnLineListener(),this.clientConfiguration=s.clientConfiguration,this.emit(L.SignalConnected,s),s}catch(s){if(s instanceof H&&s.reason===z.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,i,r);throw s}})}close(){return v(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(L.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return v(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new jo,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupClient(){return v(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new ct("a track with the same ID has already been published");return new Promise((t,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(new H("publication of local track timed out, no response from server",z.Timeout))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),t(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return v(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return v(this,void 0,void 0,function*(){var t,i;if(this.pcManager&&this.pcManager.currentState!==X.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const r=this.makeRTCConfiguration(e);this.pcManager=new If(r,this.options.singlePeerConnection?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(L.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(s,o)=>{this.client.sendIceCandidate(s,o)},this.pcManager.onPublisherOffer=(s,o)=>{this.client.sendOffer(s,o)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(s,o,a)=>v(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(s),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),s===X.CONNECTED){const u=this.pcState===Ie.New;this.pcState=Ie.Connected,u&&this.emit(L.Connected,e)}else s===X.FAILED&&(this.pcState===Ie.Connected||this.pcState===Ie.Reconnecting)&&(this.pcState=Ie.Disconnected,this.handleDisconnect("peerconnection failed",a==="failed"?At.RR_SUBSCRIBER_FAILED:At.RR_PUBLISHER_FAILED));const c=this.client.isDisconnected||this.client.currentState===Y.RECONNECTING,l=[X.FAILED,X.CLOSING,X.CLOSED].includes(s);c&&l&&!this._isClosed&&this.emit(L.Offline)}),this.pcManager.onTrack=s=>{s.streams.length!==0&&this.emit(L.MediaTrackAdded,s.track,s.streams[0],s.receiver)},Yf((i=e.serverInfo)===null||i===void 0?void 0:i.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,i)=>v(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:i})),this.midToTrackId=i,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,i)=>v(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=i;const r=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);r&&this.client.sendAnswer(r,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(L.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(L.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(L.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(L.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(L.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,i;const r={direction:"recvonly"};for(let s=0;s<e.numAudios;s++)(t=this.pcManager)===null||t===void 0||t.addPublisherTransceiverOfKind("audio",r);for(let s=0;s<e.numVideos;s++)(i=this.pcManager)===null||i===void 0||i.addPublisherTransceiverOfKind("video",r);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",At.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e?.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case Xt.DISCONNECT:this.emit(L.Disconnected,e?.reason),this.close();break;case Xt.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(ur);break;case Xt.RESUME:this.handleDisconnect(ur)}}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const o={urls:s.urls};s.username&&(o.username=s.username),s.credential&&(o.credential=s.credential),r.push(o)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===_n.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(Xo,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(Zo,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,i){return v(this,void 0,void 0,function*(){if(Dr())return yield this.createTransceiverRTCRtpSender(e,t,i);if(Nr())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new se("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,i,r){return v(this,void 0,void 0,function*(){if(Dr())return this.createSimulcastTransceiverSender(e,t,i,r);if(Nr())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new se("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,i){return v(this,void 0,void 0,function*(){if(!this.pcManager)throw new se("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),It(e)&&(e.codec=t.videoCodec);const s={direction:"sendonly",streams:r};return i&&(s.sendEncodings=i),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s)).sender})}createSimulcastTransceiverSender(e,t,i,r){return v(this,void 0,void 0,function*(){if(!this.pcManager)throw new se("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const o=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);if(i.videoCodec)return e.setSimulcastTrackSender(i.videoCodec,o.sender),o.sender})}createRTCRtpSender(e){return v(this,void 0,void 0,function*(){if(!this.pcManager)throw new se("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return v(this,void 0,void 0,function*(){var t,i,r;if(!this._isClosed){if(this.attemptingReconnect){F.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===_n.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:X.NEW)===X.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let o=!0;s instanceof se?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),o=!1):s instanceof Gt||(this.fullReconnectOnNext=!0),o?this.handleDisconnect("reconnect",At.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(L.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return v(this,void 0,void 0,function*(){var t,i,r;try{if(!this.url||!this.token)throw new se("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(L.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Gt;s=yield this.join(e??this.url,this.token,this.signalOpts)}catch(o){throw o instanceof H&&o.reason===z.NotAllowed?new se("could not reconnect, token might be expired"):new Gt}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(L.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==Y.CONNECTED)throw new Gt("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(L.Restarted)}catch(s){const o=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(o){yield this.restartConnection(o);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){return v(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new se("could not reconnect, url or token not saved");if(!this.pcManager)throw new se("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(L.Resuming);let i;try{this.setupSignalClientCallbacks(),i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let s="";throw r instanceof Error&&(s=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof H&&r.reason===z.NotAllowed?new se("could not reconnect, token might be expired"):r instanceof H&&r.reason===z.LeaveRequest?r:new Gt(s)}if(this.emit(L.SignalResumed),i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=i.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==Y.CONNECTED)throw new Gt("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),i?.lastMessageSeq&&this.resendReliableMessagesForResume(i.lastMessageSeq),this.emit(L.Resumed)})}waitForPCInitialConnection(e,t){return v(this,void 0,void 0,function*(){if(!this.pcManager)throw new se("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return v(this,void 0,void 0,function*(){this.pcState=Ie.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield ve(Jf),!this.pcManager)throw new se("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Ie.Connected}catch(e){throw this.pcState=Ie.Disconnected,new H("could not establish PC connection, ".concat(e.message),z.InternalError)}})}publishRpcResponse(e,t,i,r){return v(this,void 0,void 0,function*(){const s=new me({destinationIdentities:[e],kind:B.RELIABLE,value:{case:"rpcResponse",value:new us({requestId:t,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:i??""}})}});yield this.sendDataPacket(s,B.RELIABLE)})}publishRpcAck(e,t){return v(this,void 0,void 0,function*(){const i=new me({destinationIdentities:[e],kind:B.RELIABLE,value:{case:"rpcAck",value:new ls({requestId:t})}});yield this.sendDataPacket(i,B.RELIABLE)})}sendDataPacket(e,t){return v(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const s=Ch(e);if(s){const o=yield this.e2eeManager.encryptData(s.toBinary());e.value={case:"encryptedPacket",value:new Ya({encryptedValue:o.payload,iv:o.iv,keyIndex:o.keyIndex})}}}t===B.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const i=e.toBinary(),r=this.dataChannelForKind(t);if(r){if(t===B.RELIABLE&&this.reliableMessageBuffer.push({data:i,sequence:e.sequence}),this.attemptingReconnect)return;r.send(i)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return v(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(B.RELIABLE);const t=this.dataChannelForKind(B.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(i=>{t.send(i.data)})),this.updateAndEmitDCBufferStatus(B.RELIABLE)})}waitForBufferStatusLow(e){return new Promise((t,i)=>v(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const r=()=>i("Engine closed");for(this.once(L.Closing,r);!this.dcBufferStatus.get(e);)yield ve(10);this.off(L.Closing,r),t()}}))}ensureDataTransportConnected(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var s;if(!i.pcManager)throw new se("PC manager is closed");const o=r?i.pcManager.subscriber:i.pcManager.publisher,a=r?"Subscriber":"Publisher";if(!o)throw new H("".concat(a," connection not set"),z.InternalError);let c=!1;!r&&!i.dataChannelForKind(t,r)&&(i.createDataChannels(),c=!0),!c&&!r&&!i.pcManager.publisher.isICEConnected&&i.pcManager.publisher.getICEConnectionState()!=="checking"&&(c=!0),c&&i.negotiate().catch(d=>{F.error(d,i.logContext)});const l=i.dataChannelForKind(t,r);if(l?.readyState==="open")return;const u=new Date().getTime()+i.peerConnectionTimeout;for(;new Date().getTime()<u;){if(o.isICEConnected&&((s=i.dataChannelForKind(t,r))===null||s===void 0?void 0:s.readyState)==="open")return;yield ve(50)}throw new H("could not establish ".concat(a," connection, state: ").concat(o.getICEConnectionState()),z.InternalError)})()})}ensurePublisherConnected(e){return v(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==X.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return v(this,void 0,void 0,function*(){return new Promise((e,t)=>v(this,void 0,void 0,function*(){if(!this.pcManager){t(new Or("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(L.Closing,r),this.pcManager.publisher.once(tn.RTPVideoPayloadTypes,s=>{const o=new Map;s.forEach(a=>{const c=a.codec.toLowerCase();Gh(c)&&o.set(a.payload,c)}),this.emit(L.RTPVideoMapUpdate,o)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof Or&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",At.RR_UNKNOWN),t(s)}finally{this.off(L.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===B.LOSSY)return this.lossyDCSub;if(e===B.RELIABLE)return this.reliableDCSub}else{if(e===B.LOSSY)return this.lossyDC;if(e===B.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,r,s,o;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const a=this.pcManager.publisher.getLocalDescription(),c=this.pcManager.publisher.getRemoteDescription(),l=(i=this.pcManager.subscriber)===null||i===void 0?void 0:i.getRemoteDescription(),u=(r=this.pcManager.subscriber)===null||r===void 0?void 0:r.getLocalDescription(),d=(o=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&o!==void 0?o:!0,f=new Array,p=new Array;e.forEach(g=>{g.isDesired!==d&&f.push(g.trackSid),g.isEnabled||p.push(g.trackSid)}),this.client.sendSyncState(new ms({answer:this.options.singlePeerConnection?c?Qt({sdp:c.sdp,type:c.type}):void 0:u?Qt({sdp:u.sdp,type:u.type}):void 0,offer:this.options.singlePeerConnection?a?Qt({sdp:a.sdp,type:a.type}):void 0:l?Qt({sdp:l.sdp,type:l.type}):void 0,subscription:new Mi({trackSids:f,subscribe:!d,participantTracks:[]}),publishTracks:nf(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p,datachannelReceiveStates:this.reliableReceivedState.map((g,m)=>new vc({publisherSid:m,lastSeq:g}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(i,r)=>{i?.id!==void 0&&i.id!==null&&e.push(new bc({label:i.label,id:i.id,target:r}))};return t(this.dataChannelForKind(B.LOSSY),Le.PUBLISHER),t(this.dataChannelForKind(B.RELIABLE),Le.PUBLISHER),t(this.dataChannelForKind(B.LOSSY,!0),Le.SUBSCRIBER),t(this.dataChannelForKind(B.RELIABLE,!0),Le.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&he.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Te()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){Te()&&window.removeEventListener("online",this.handleBrowserOnLine)}getTrackIdForReceiver(e){var t;const i=(t=this.pcManager)===null||t===void 0?void 0:t.getMidForReceiver(e);if(i){const r=Object.entries(this.midToTrackId).find(s=>{let[o]=s;return o===i});if(r)return r[1]}}}class Gt extends Error{}function Yf(n){return n!==void 0&&n>13}function ea(n,e){const t=n.participantIdentity?n.participantIdentity:e.participantIdentity;n.participantIdentity=t,e.participantIdentity=t;const i=n.destinationIdentities.length!==0?n.destinationIdentities:e.destinationIdentities;n.destinationIdentities=i,e.destinationIdentities=i}class Hr{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return Ur(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return v(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter(i=>!this.attemptedRegions.find(r=>r.url===i.url));if(t.length>0){const i=t[0];return this.attemptedRegions.push(i),F.debug("next region: ".concat(i.region)),i.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return v(this,void 0,void 0,function*(){const t=yield fetch("".concat(Xf(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});if(t.ok){const i=yield t.json();return this.lastUpdateAt=Date.now(),i}else throw new H("Could not fetch region settings: ".concat(t.statusText),t.status===401?z.NotAllowed:z.InternalError,t.status)})}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}function Xf(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}class fl{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if(e&&this.bytesReceived<this.totalByteSize)throw new xe("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),pe.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new xe("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),pe.LengthExceeded)}}constructor(e,t,i,r){this.reader=t,this.totalByteSize=i,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=r}}class Zf extends fl{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,i)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Oe,i=null,r=null;if(this.signal){const o=this.signal;r=()=>{var a;(a=t.reject)===null||a===void 0||a.call(t,o.reason)},o.addEventListener("abort",r),i=o}const s=()=>{e.releaseLock(),i&&r&&i.removeEventListener("abort",r),this.signal=void 0};return{next:()=>v(this,void 0,void 0,function*(){var o,a;try{const{done:c,value:l}=yield Promise.race([e.read(),t.promise,(a=(o=this.outOfBandFailureRejectingFuture)===null||o===void 0?void 0:o.promise)!==null&&a!==void 0?a:new Promise(()=>{})]);return c?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(l),{done:!1,value:l.content})}catch(c){throw s(),c}}),return(){return v(this,void 0,void 0,function*(){return s(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,o;let a=new Set;const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=at(c),d;d=yield u.next(),i=d.done,!i;l=!0){o=d.value,l=!1;const f=o;a.add(f)}}catch(f){r={error:f}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return Array.from(a)})()})}}class ep extends fl{constructor(e,t,i,r){super(e,t,i,r),this.receivedChunks=new Map}handleChunkReceived(e){var t;const i=oi(e.chunkIndex),r=this.receivedChunks.get(i);if(r&&r.version>e.version)return;this.receivedChunks.set(i,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,s)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let i=new Oe,r=null,s=null;if(this.signal){const a=this.signal;s=()=>{var c;(c=i.reject)===null||c===void 0||c.call(i,a.reason)},a.addEventListener("abort",s),r=a}const o=()=>{e.releaseLock(),r&&s&&r.removeEventListener("abort",s),this.signal=void 0};return{next:()=>v(this,void 0,void 0,function*(){var a,c;try{const{done:l,value:u}=yield Promise.race([e.read(),i.promise,(c=(a=this.outOfBandFailureRejectingFuture)===null||a===void 0?void 0:a.promise)!==null&&c!==void 0?c:new Promise(()=>{})]);if(l)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(u);let d;try{d=t.decode(u.content)}catch(f){throw new xe("Cannot decode datastream chunk ".concat(u.chunkIndex," as text: ").concat(f),pe.DecodeFailed)}return{done:!1,value:d}}}catch(l){throw o(),l}}),return(){return v(this,void 0,void 0,function*(){return o(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return v(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,o;let a="";const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=at(c),d;d=yield u.next(),i=d.done,!i;l=!0)o=d.value,l=!1,a+=o}catch(f){r={error:f}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return a})()})}}class tp{constructor(){this.log=F,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new xe('A text stream handler for topic "'.concat(e,'" has already been set.'),pe.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new xe('A byte stream handler for topic "'.concat(e,'" has already been set.'),pe.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearHandlersAndControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear(),this.byteStreamHandlers.clear(),this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,i,r,s;const o=Array.from(this.textStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e),a=Array.from(this.byteStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e);if(o.length>0||a.length>0){const c=new xe("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),pe.AbnormalEnd);for(const[l,u]of a)(i=(t=u.outOfBandFailureRejectingFuture).reject)===null||i===void 0||i.call(t,c),this.byteStreamControllers.delete(l);for(const[l,u]of o)(s=(r=u.outOfBandFailureRejectingFuture).reject)===null||s===void 0||s.call(r,c),this.textStreamControllers.delete(l)}}handleDataStreamPacket(e,t){return v(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,i){return v(this,void 0,void 0,function*(){var r;if(e.contentHeader.case==="byteHeader"){const s=this.byteStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let o;const a=new Oe;a.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,name:(r=e.contentHeader.value.name)!==null&&r!==void 0?r:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:oi(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(o=u,this.textStreamControllers.has(e.streamId))throw new xe("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),pe.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:c,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});s(new Zf(c,l,oi(e.totalLength),a),{identity:t})}else if(e.contentHeader.case==="textHeader"){const s=this.textStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let o;const a=new Oe;a.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(o=u,this.textStreamControllers.has(e.streamId))throw new xe("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),pe.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:c,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});s(new ep(c,l,oi(e.totalLength),a),{identity:t})}})}handleStreamChunk(e,t){const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new xe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),pe.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e));const r=this.textStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?(r.controller.error(new xe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),pe.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&r.controller.enqueue(e))}handleStreamTrailer(e,t){const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new xe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),pe.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close(),this.textStreamControllers.delete(e.streamId)));const r=this.byteStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?r.controller.error(new xe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),pe.EncryptionTypeMismatch)):(r.info.attributes=Object.assign(Object.assign({},r.info.attributes),e.attributes),r.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class pl{constructor(e,t,i){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=i,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return v(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(e=this.onClose)===null||e===void 0||e.call(this)})}}class np extends pl{}class ip extends pl{}const ta=15e3;class rp{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return v(this,void 0,void 0,function*(){var i;const r=crypto.randomUUID(),o=new TextEncoder().encode(e).byteLength,a=(i=t?.attachments)===null||i===void 0?void 0:i.map(()=>crypto.randomUUID()),c=new Array(a?a.length+1:1).fill(0),l=(d,f)=>{var p;c[f]=d;const g=c.reduce((m,k)=>m+k,0);(p=t?.onProgress)===null||p===void 0||p.call(t,g)},u=yield this.streamText({streamId:r,totalSize:o,destinationIdentities:t?.destinationIdentities,topic:t?.topic,attachedStreamIds:a,attributes:t?.attributes});return yield u.write(e),l(1,0),yield u.close(),t?.attachments&&a&&(yield Promise.all(t.attachments.map((d,f)=>v(this,void 0,void 0,function*(){return this._sendFile(a[f],d,{topic:t.topic,mimeType:d.type,onProgress:p=>{l(p,f+1)}})})))),u.info})}streamText(e){return v(this,void 0,void 0,function*(){var t,i,r;const s=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),o={id:s,mimeType:"text/plain",timestamp:Date.now(),topic:(i=e?.topic)!==null&&i!==void 0?i:"",size:e?.totalSize,attributes:e?.attributes,encryptionType:!((r=this.engine.e2eeManager)===null||r===void 0)&&r.isDataChannelEncryptionEnabled?oe.GCM:oe.NONE},a=new hi({streamId:s,mimeType:o.mimeType,topic:o.topic,timestamp:Dt(o.timestamp),totalLength:Dt(e?.totalSize),attributes:o.attributes,contentHeader:{case:"textHeader",value:new lc({version:e?.version,attachedStreamIds:e?.attachedStreamIds,replyToStreamId:e?.replyToStreamId,operationType:e?.type==="update"?kr.UPDATE:kr.CREATE})}}),c=e?.destinationIdentities,l=new me({destinationIdentities:c,value:{case:"streamHeader",value:a}});yield this.engine.sendDataPacket(l,B.RELIABLE);let u=0;const d=this.engine,f=new WritableStream({write(m){return v(this,void 0,void 0,function*(){for(const k of Zh(m,ta)){yield d.waitForBufferStatusLow(B.RELIABLE);const b=new fi({content:k,streamId:s,chunkIndex:Dt(u)}),w=new me({destinationIdentities:c,value:{case:"streamChunk",value:b}});yield d.sendDataPacket(w,B.RELIABLE),u+=1}})},close(){return v(this,void 0,void 0,function*(){const m=new pi({streamId:s}),k=new me({destinationIdentities:c,value:{case:"streamTrailer",value:m}});yield d.sendDataPacket(k,B.RELIABLE)})},abort(m){console.log("Sink error:",m)}});let p=()=>v(this,void 0,void 0,function*(){yield g.close()});d.once(L.Closing,p);const g=new np(f,o,()=>this.engine.off(L.Closing,p));return g})}sendFile(e,t){return v(this,void 0,void 0,function*(){const i=crypto.randomUUID();return yield this._sendFile(i,e,t),{id:i}})}_sendFile(e,t,i){return v(this,void 0,void 0,function*(){var r;const s=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(r=i?.mimeType)!==null&&r!==void 0?r:t.type,topic:i?.topic,destinationIdentities:i?.destinationIdentities}),o=t.stream().getReader();for(;;){const{done:a,value:c}=yield o.read();if(a)break;yield s.write(c)}return yield s.close(),s.info})}streamBytes(e){return v(this,void 0,void 0,function*(){var t,i,r,s,o,a;const c=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),l=e?.destinationIdentities,u={id:c,mimeType:(i=e?.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(r=e?.topic)!==null&&r!==void 0?r:"",timestamp:Date.now(),attributes:e?.attributes,size:e?.totalSize,name:(s=e?.name)!==null&&s!==void 0?s:"unknown",encryptionType:!((o=this.engine.e2eeManager)===null||o===void 0)&&o.isDataChannelEncryptionEnabled?oe.GCM:oe.NONE},d=new hi({totalLength:Dt((a=u.size)!==null&&a!==void 0?a:0),mimeType:u.mimeType,streamId:c,topic:u.topic,timestamp:Dt(Date.now()),attributes:u.attributes,contentHeader:{case:"byteHeader",value:new uc({name:u.name})}}),f=new me({destinationIdentities:l,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(f,B.RELIABLE);let p=0;const g=new Ce,m=this.engine,k=this.log,b=new WritableStream({write(R){return v(this,void 0,void 0,function*(){const S=yield g.lock();let y=0;try{for(;y<R.byteLength;){const T=R.slice(y,y+ta);yield m.waitForBufferStatusLow(B.RELIABLE);const I=new me({destinationIdentities:l,value:{case:"streamChunk",value:new fi({content:T,streamId:c,chunkIndex:Dt(p)})}});yield m.sendDataPacket(I,B.RELIABLE),p+=1,y+=T.byteLength}}finally{S()}})},close(){return v(this,void 0,void 0,function*(){const R=new pi({streamId:c}),S=new me({destinationIdentities:l,value:{case:"streamTrailer",value:R}});yield m.sendDataPacket(S,B.RELIABLE)})},abort(R){k.error("Sink error:",R)}});return new ip(b,u)})}}class ml extends C{constructor(e,t,i,r,s){super(e,i,s),this.sid=t,this.receiver=r}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?N.Muted:N.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(N.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return v(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),Rs)),rf()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const i=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(i){const{timestamp:r,rtpTimestamp:s}=i;s&&this.rtpTimestamp!==s&&(this.emit(N.TimeSyncUpdate,{timestamp:r,rtpTimestamp:s}),this.rtpTimestamp=s)}};e()}}class gl extends ml{constructor(e,t,i,r,s,o){super(e,t,C.Kind.Audio,i,o),this.monitorReceiver=()=>v(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Ni(a,this.prevStats)),this.prevStats=a}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):i.volume=e;Xe()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(Xe())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return v(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Lr(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&Lr(e)&&e.setSinkId(this.sinkId).catch(i=>{this.log.error("Failed to set sink id on remote audio track",i,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(N.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(N.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return v(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(i=>{i.type==="inbound-rtp"&&(t={type:"audio",streamId:i.id,timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),t})}}const dr=100;class sp extends ml{constructor(e,t,i,r,s){super(e,t,C.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>v(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Ni(o,this.prevStats)),this.prevStats=o}),this.debouncedHandleResize=Cs(()=>{this.updateDimensions()},dr),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e),console.log("setStreamState",e),e===C.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?en(this._mediaStreamTrack,t):$t(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new op(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(i=>i===e);for(const i of t)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const i of t)this.stopObservingElement(i);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return v(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,t={type:"video",streamId:s.id,framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),t&&i!==""&&r.get(i)&&(t.mimeType=r.get(i).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(i=>i.element===e);for(const i of t)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return v(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,i;const r=this.elementInfos.reduce((c,l)=>Math.max(c,l.visibilityChangedAt||0),0),s=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0)||i?this.isInBackground:!1,o=this.elementInfos.some(c=>c.pictureInPicture),a=this.elementInfos.some(c=>c.visible)&&!s||o;if(!(this.lastVisible===a&&!e)){if(!a&&Date.now()-r<dr){he.setTimeout(()=>{this.updateVisibility()},dr);return}this.lastVisible=a,this.emit(N.VisibilityChanged,a,this)}}updateDimensions(){var e,t;let i=0,r=0;const s=this.getPixelDensity();for(const o of this.elementInfos){const a=o.width()*s,c=o.height()*s;a+c>i+r&&(i=a,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:i,height:r},this.emit(N.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?Oo():t||(Oo()>2?2:1)}}class op{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:o}=i;s===this.element&&(this.isIntersecting=o,this.isPiP=yn(this.element),this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i,r,s;(r=(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)===null||r===void 0||r.addEventListener("pagehide",this.onLeavePiP),this.isPiP=yn(this.element),(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=yn(this.element),(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=t??Kr(e),this.isPiP=Te()&&yn(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,i;this.isIntersecting=Kr(this.element),this.isPiP=yn(this.element),this.element.handleResize=()=>{var r;(r=this.handleResize)===null||r===void 0||r.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,Ao().observe(this.element),Mo().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(e=window.documentPictureInPicture)===null||e===void 0||e.addEventListener("enter",this.onEnterPiP),(i=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||i===void 0||i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,i,r,s;(e=Ao())===null||e===void 0||e.unobserve(this.element),(t=Mo())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(i=window.documentPictureInPicture)===null||i===void 0||i.removeEventListener("enter",this.onEnterPiP),(s=(r=window.documentPictureInPicture)===null||r===void 0?void 0:r.window)===null||s===void 0||s.removeEventListener("pagehide",this.onLeavePiP)}}function yn(n){var e,t;return document.pictureInPictureElement===n?!0:!((e=window.documentPictureInPicture)===null||e===void 0)&&e.window?Kr(n,(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window):!1}function Kr(n,e){const t=e||window;let i=n.offsetTop,r=n.offsetLeft;const s=n.offsetWidth,o=n.offsetHeight,{hidden:a}=n,{display:c}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,i+=n.offsetTop,r+=n.offsetLeft;return i<t.pageYOffset+t.innerHeight&&r<t.pageXOffset+t.innerWidth&&i+o>t.pageYOffset&&r+s>t.pageXOffset&&!a&&c!=="none"}class rt extends et.EventEmitter{constructor(e,t,i,r){var s;super(),this.metadataMuted=!1,this.encryption=oe.NONE,this.log=F,this.handleMuted=()=>{this.emit(N.Muted)},this.handleUnmuted=()=>{this.emit(N.Unmuted)},this.log=lt((s=r?.loggerName)!==null&&s!==void 0?s:je.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=i,this.source=C.Source.Unknown}setTrack(e){this.track&&(this.track.off(N.Muted,this.handleMuted),this.track.off(N.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(N.Muted,this.handleMuted),e.on(N.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),V(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==oe.NONE}get audioTrack(){if(Qe(this.track))return this.track}get videoTrack(){if(It(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=C.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===C.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(n){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),(function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"})(n.PermissionStatus||(n.PermissionStatus={}))})(rt||(rt={}));class vi extends rt{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(N.Ended)},this.handleCpuConstrained=()=>{this.track&&It(this.track)&&this.emit(N.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(i)}setTrack(e){this.track&&(this.track.off(N.Ended,this.handleTrackEnded),this.track.off(N.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(N.Ended,this.handleTrackEnded),e.on(N.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return v(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return v(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return v(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return v(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(Qe(this.track)){const t=this.track.getSourceTrackSettings(),i=new Set;return t.autoGainControl&&i.add(le.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&i.add(le.TF_ECHO_CANCELLATION),t.noiseSuppression&&i.add(le.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&i.add(le.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||i.add(le.TF_NO_DTX),this.track.enhancedNoiseCancellation&&i.add(le.TF_ENHANCED_NOISE_CANCELLATION),Array.from(i.values())}else return[]}}function Li(n,e){return v(this,void 0,void 0,function*(){n??(n={});let t=!1;const{audioProcessor:i,videoProcessor:r,optionsWithoutProcessor:s}=sl(n);let o=s.audio,a=s.video;if(i&&typeof s.audio=="object"&&(s.audio.processor=i),r&&typeof s.video=="object"&&(s.video.processor=r),n.audio&&typeof s.audio=="object"&&typeof s.audio.deviceId=="string"){const d=s.audio.deviceId;s.audio.deviceId={exact:d},t=!0,o=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:d}})}if(s.video&&typeof s.video=="object"&&typeof s.video.deviceId=="string"){const d=s.video.deviceId;s.video.deviceId={exact:d},t=!0,a=Object.assign(Object.assign({},s.video),{deviceId:{ideal:d}})}(s.audio===!0||typeof s.audio=="object"&&!s.audio.deviceId)&&(s.audio={deviceId:"default"}),s.video===!0?s.video={deviceId:"default"}:typeof s.video=="object"&&!s.video.deviceId&&(s.video.deviceId="default");const c=nl(s,al,cl),l=ks(c),u=navigator.mediaDevices.getUserMedia(l);s.audio&&(ue.userMediaPromiseMap.set("audioinput",u),u.catch(()=>ue.userMediaPromiseMap.delete("audioinput"))),s.video&&(ue.userMediaPromiseMap.set("videoinput",u),u.catch(()=>ue.userMediaPromiseMap.delete("videoinput")));try{const d=yield u;return yield Promise.all(d.getTracks().map(f=>v(this,void 0,void 0,function*(){const p=f.kind==="audio";let g=p?c.audio:c.video;(typeof g=="boolean"||!g)&&(g={});let m;const k=p?l.audio:l.video;typeof k!="boolean"&&(m=k);const b=f.getSettings().deviceId;m?.deviceId&&Et(m.deviceId)!==b?m.deviceId=b:m||(m={deviceId:b});const w=Lf(f,m,e);return w.kind===C.Kind.Video?w.source=C.Source.Camera:w.kind===C.Kind.Audio&&(w.source=C.Source.Microphone),w.mediaStream=d,Qe(w)&&i?yield w.setProcessor(i):It(w)&&r&&(yield w.setProcessor(r)),w})))}catch(d){if(!t)throw d;return Li(Object.assign(Object.assign({},n),{audio:o,video:a}),e)}})}function ap(n){return v(this,void 0,void 0,function*(){return(yield Li({audio:!1,video:!0}))[0]})}function cp(n){return v(this,void 0,void 0,function*(){return(yield Li({audio:!0,video:!1}))[0]})}var Ue;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(Ue||(Ue={}));function lp(n){switch(n){case Tn.EXCELLENT:return Ue.Excellent;case Tn.GOOD:return Ue.Good;case Tn.POOR:return Ue.Poor;case Tn.LOST:return Ue.Lost;default:return Ue.Unknown}}class vl extends et.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===In.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===Yt.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,i,r,s,o){let a=arguments.length>6&&arguments[6]!==void 0?arguments[6]:In.STANDARD;var c;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Ue.Unknown,this.log=F,this.log=lt((c=o?.loggerName)!==null&&c!==void 0?c:je.Participant),this.loggerOptions=o,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=i,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=a,this._attributes=s??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new Oe,this.once(_.Active,()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0||t.call(e),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(C.Source.Camera);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(C.Source.Microphone);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(C.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===Yt.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==Yt.ACTIVE&&this.emit(_.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,i=this.metadata;this.metadata=e,t&&this.emit(_.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(_.ParticipantNameChanged,e)}_setAttributes(e){const t=sf(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(_.AttributesChanged,t)}setPermissions(e){var t,i,r,s,o,a;const c=this.permissions,l=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((o=this.permissions)===null||o===void 0?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((u,d)=>{var f;return u!==((f=this.permissions)===null||f===void 0?void 0:f.canPublishSources[d])})||e.canSubscribeMetrics!==((a=this.permissions)===null||a===void 0?void 0:a.canSubscribeMetrics);return this.permissions=e,l&&this.emit(_.ParticipantPermissionsChanged,c),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(_.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=lp(e),t!==this._connectionQuality&&this.emit(_.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&((t=(e=this.activeFuture).reject)===null||t===void 0||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>Qe(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(N.Muted,()=>{this.emit(_.TrackMuted,e)}),e.on(N.Unmuted,()=>{this.emit(_.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case C.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case C.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function up(n){var e,t,i;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new mc({participantIdentity:(e=n.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=n.participantSid)!==null&&t!==void 0?t:"",allTracks:(i=n.allowAll)!==null&&i!==void 0?i:!1,trackSids:n.allowedTrackSids||[]})}class dp extends vl{constructor(e,t,i,r,s,o){super(e,t,void 0,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=oe.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Oe)},this.handleReconnected=()=>{var a,c;(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.resolve)===null||c===void 0||c.call(a),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var a,c,l,u,d,f;this.reconnectFuture&&(this.reconnectFuture.promise.catch(p=>this.log.warn(p.message,this.logContext)),(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.reject)===null||c===void 0||c.call(a,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&((u=(l=this.signalConnectedFuture).reject)===null||u===void 0||u.call(l,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),(f=(d=this.activeAgentFuture)===null||d===void 0?void 0:d.reject)===null||f===void 0||f.call(d,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=a=>{var c,l;a.participant&&this.updateInfo(a.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Oe),(l=(c=this.signalConnectedFuture).resolve)===null||l===void 0||l.call(c)},this.handleSignalRequestResponse=a=>{const{requestId:c,reason:l,message:u}=a,d=this.pendingSignalRequests.get(c);d&&(l!==gs.OK&&d.reject(new Po(u,l)),this.pendingSignalRequests.delete(c))},this.handleDataPacket=a=>{switch(a.value.case){case"rpcResponse":let c=a.value.value,l=null,u=null;c.value.case==="payload"?l=c.value.value:c.value.case==="error"&&(u=ee.fromProto(c.value.value)),this.handleIncomingRpcResponse(c.requestId,l,u);break;case"rpcAck":let d=a.value.value;this.handleIncomingRpcAck(d.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(a=>up(a)))},this.onTrackUnmuted=a=>{this.onTrackMuted(a,a.isUpstreamPaused)},this.onTrackMuted=(a,c)=>{if(c===void 0&&(c=!0),!a.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),V(a)));return}this.engine.updateMuteStatus(a.sid,c)},this.onTrackUpstreamPaused=a=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),V(a))),this.onTrackMuted(a,!0)},this.onTrackUpstreamResumed=a=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),V(a))),this.onTrackMuted(a,a.isMuted)},this.onTrackFeatureUpdate=a=>{const c=this.audioTrackPublications.get(a.sid);if(!c){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(a.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(c.trackSid,c.getTrackFeatures())},this.onTrackCpuConstrained=(a,c)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),V(c))),this.emit(_.LocalTrackCpuConstrained,a,c)},this.handleSubscribedQualityUpdate=a=>v(this,void 0,void 0,function*(){var c,l,u,d,f;if(!(!((f=this.roomOptions)===null||f===void 0)&&f.dynacast))return;const p=this.videoTrackPublications.get(a.trackSid);if(!p){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}if(!p.videoTrack)return;const g=yield p.videoTrack.setPublishingCodecs(a.subscribedCodecs);try{for(var m=!0,k=at(g),b;b=yield k.next(),c=b.done,!c;m=!0){d=b.value,m=!1;const w=d;Nh(w)&&(this.log.debug("publish ".concat(w," for ").concat(p.videoTrack.sid),Object.assign(Object.assign({},this.logContext),V(p))),yield this.publishAdditionalCodecForTrack(p.videoTrack,w,p.options))}}catch(w){l={error:w}}finally{try{!m&&!c&&(u=k.return)&&(yield u.call(k))}finally{if(l)throw l.error}}}),this.handleLocalTrackUnpublished=a=>{const c=this.trackPublications.get(a.trackSid);if(!c){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}this.unpublishTrack(c.track)},this.handleTrackEnded=a=>v(this,void 0,void 0,function*(){if(a.source===C.Source.ScreenShare||a.source===C.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),V(a))),this.unpublishTrack(a);else if(a.isUserProvided)yield a.mute();else if(it(a)||bt(a))try{if(Te())try{const c=yield navigator?.permissions.query({name:a.source===C.Source.Camera?"camera":"microphone"});if(c&&c.state==="denied")throw this.log.warn("user has revoked access to ".concat(a.source),Object.assign(Object.assign({},this.logContext),V(a))),c.onchange=()=>{c.state!=="denied"&&(a.isMuted||a.restartTrack(),c.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}a.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),V(a))),it(a)?yield a.restartTrack({deviceId:"default"}):yield a.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),V(a))),yield a.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=s,this.roomOutgoingDataStreamManager=o}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==oe.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(L.RemoteMute,(i,r)=>{const s=this.trackPublications.get(i);!s||!s.track||(r?s.mute():s.unmute())}),!((t=this.signalConnectedFuture)===null||t===void 0)&&t.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(L.Connected,this.handleReconnected).on(L.SignalConnected,this.handleSignalConnected).on(L.SignalRestarted,this.handleReconnected).on(L.SignalResumed,this.handleReconnected).on(L.Restarting,this.handleReconnecting).on(L.Resuming,this.handleReconnecting).on(L.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(L.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(L.Closing,this.handleClosing).on(L.SignalRequestResponse,this.handleSignalRequestResponse).on(L.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return v(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return v(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return v(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return v(this,arguments,void 0,function(t){var i=this;let{metadata:r,name:s,attributes:o}=t;return(function*(){return new Promise((a,c)=>v(i,void 0,void 0,function*(){var l,u;try{let d=!1;const f=yield this.engine.client.sendUpdateLocalMetadata((l=r??this.metadata)!==null&&l!==void 0?l:"",(u=s??this.name)!==null&&u!==void 0?u:"",o),p=performance.now();for(this.pendingSignalRequests.set(f,{resolve:a,reject:g=>{c(g),d=!0},values:{name:s,metadata:r,attributes:o}});performance.now()-p<5e3&&!d;){if((!s||this.name===s)&&(!r||this.metadata===r)&&(!o||Object.entries(o).every(g=>{let[m,k]=g;return this.attributes[m]===k||k===""&&!this.attributes[m]}))){this.pendingSignalRequests.delete(f),a();return}yield ve(50)}c(new Po("Request to update local metadata timed out","TimeoutError"))}catch(d){d instanceof Error&&c(d)}}))})()})}setCameraEnabled(e,t,i){return this.setTrackEnabled(C.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(C.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(C.Source.ScreenShare,e,t,i)}setE2EEEnabled(e){return v(this,void 0,void 0,function*(){this.encryptionType=e?oe.GCM:oe.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,i,r){return v(this,void 0,void 0,function*(){var s,o;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(t)if(a)yield a.unmute();else{let c;if(this.pendingPublishing.has(e)){const l=yield this.waitForPendingPublicationOfSource(e);return l||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield l?.unmute(),l}this.pendingPublishing.add(e);try{switch(e){case C.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case C.Source.Microphone:c=yield this.createTracks({audio:(o=i)!==null&&o!==void 0?o:!0});break;case C.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new ct(e)}}catch(l){throw c?.forEach(u=>{u.stop()}),l instanceof Error&&this.emit(_.MediaDevicesError,l,Vr(e)),this.pendingPublishing.delete(e),l}for(const l of c){const u=Object.assign(Object.assign({},this.roomOptions.publishDefaults),i);e===C.Source.Microphone&&Qe(l)&&u.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),l.startPreConnectBuffer())}try{const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),V(d))),l.push(this.publishTrack(d,r));[a]=yield Promise.all(l)}catch(l){throw c?.forEach(u=>{u.stop()}),l}finally{this.pendingPublishing.delete(e)}}else if(!a?.track&&this.pendingPublishing.has(e)&&(a=yield this.waitForPendingPublicationOfSource(e),a||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),a&&a.track)if(e===C.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const c=this.getTrackPublication(C.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return v(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(C.Source.Camera)||this.pendingPublishing.has(C.Source.Microphone))){this.pendingPublishing.add(C.Source.Camera),this.pendingPublishing.add(C.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(C.Source.Camera),this.pendingPublishing.delete(C.Source.Microphone)}}})}createTracks(e){return v(this,void 0,void 0,function*(){var t,i;e??(e={});const r=nl(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{return(yield Li(r,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(a=>(Qe(a)&&(this.microphoneError=void 0,a.setAudioContext(this.audioContext),a.source=C.Source.Microphone,this.emit(_.AudioStreamAcquired)),It(a)&&(this.cameraError=void 0,a.source=C.Source.Camera),a))}catch(s){throw s instanceof Error&&(e.audio&&(this.microphoneError=s),e.video&&(this.cameraError=s)),s}})}createScreenTracks(e){return v(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new bs("getDisplayMedia not supported");e.resolution===void 0&&!Vh()&&(e.resolution=ys.h1080fps30.resolution);const t=tf(e),i=yield navigator.mediaDevices.getDisplayMedia(t),r=i.getVideoTracks();if(r.length===0)throw new ct("no video track found");const s=new gi(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=C.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const o=[s];if(i.getAudioTracks().length>0){this.emit(_.AudioStreamAcquired);const a=new mi(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=C.Source.ScreenShareAudio,o.push(a)}return o})}publishTrack(e,t){return v(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return v(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var a,c,l,u;it(i)&&i.setAudioContext(s.audioContext),yield(a=s.reconnectFuture)===null||a===void 0?void 0:a.promise,s.republishPromise&&!o&&(yield s.republishPromise),Nt(i)&&s.pendingPublishPromises.has(i)&&(yield s.pendingPublishPromises.get(i));let d;if(i instanceof MediaStreamTrack)d=i.getConstraints();else{d=i.constraints;let b;switch(i.source){case C.Source.Microphone:b="audioinput";break;case C.Source.Camera:b="videoinput"}b&&s.activeDeviceMap.has(b)&&(d=Object.assign(Object.assign({},d),{deviceId:s.activeDeviceMap.get(b)}))}if(i instanceof MediaStreamTrack)switch(i.kind){case"audio":i=new mi(i,d,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":i=new gi(i,d,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new ct("unsupported MediaStreamTrack kind ".concat(i.kind))}else i.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});let f;if(s.trackPublications.forEach(b=>{b.track&&b.track===i&&(f=b)}),f)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),V(f))),f;const p=Object.assign(Object.assign({},s.roomOptions.publishDefaults),r),g="channelCount"in i.mediaStreamTrack.getSettings()&&i.mediaStreamTrack.getSettings().channelCount===2||i.mediaStreamTrack.getConstraints().channelCount===2,m=(c=p.forceStereo)!==null&&c!==void 0?c:g;m&&(p.dtx===void 0&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),V(i))),p.red===void 0&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(l=p.dtx)!==null&&l!==void 0||(p.dtx=!1),(u=p.red)!==null&&u!==void 0||(p.red=!1)),!Wh()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),p.simulcast=!1),p.source&&(i.source=p.source);const k=new Promise((b,w)=>v(s,void 0,void 0,function*(){try{if(this.engine.client.currentState!==Y.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:V(i)}));const R=setTimeout(()=>{w(new wo("publishing rejected as engine not connected within timeout",408))},15e3);yield this.waitUntilEngineConnected(),clearTimeout(R);const S=yield this.publish(i,p,m);b(S)}else try{const R=yield this.publish(i,p,m);b(R)}catch(R){w(R)}}catch(R){w(R)}}));s.pendingPublishPromises.set(i,k);try{return yield k}catch(b){throw b}finally{s.pendingPublishPromises.delete(i)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Oe),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),V(e))),!1;const{canPublish:t,canPublishSources:i}=this.permissions;return t&&(i.length===0||i.map(r=>of(r)).includes(e.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),V(e))),!1)}publish(e,t,i){return v(this,void 0,void 0,function*(){var r,s,o,a,c,l,u,d,f,p;if(!this.hasPermissionsToPublish(e))throw new wo("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(x=>Nt(e)&&x.source===e.source)&&e.source!==C.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),V(e))),t.stopMicTrackOnMute&&Qe(e)&&(e.stopOnMute=!0),e.source===C.Source.ScreenShare&&Ft()&&(t.simulcast=!1),t.videoCodec==="av1"&&!Fh()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!jh()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=qr),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(x=>t.videoCodec===Pn(x.mime))||(t.videoCodec=Pn(this.enabledPublishVideoCodecs[0].mime)));const m=t.videoCodec;e.on(N.Muted,this.onTrackMuted),e.on(N.Unmuted,this.onTrackUnmuted),e.on(N.Ended,this.handleTrackEnded),e.on(N.UpstreamPaused,this.onTrackUpstreamPaused),e.on(N.UpstreamResumed,this.onTrackUpstreamResumed),e.on(N.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const k=[],b=!(!((r=t.dtx)!==null&&r!==void 0)||r),w=e.getSourceTrackSettings();w.autoGainControl&&k.push(le.TF_AUTO_GAIN_CONTROL),w.echoCancellation&&k.push(le.TF_ECHO_CANCELLATION),w.noiseSuppression&&k.push(le.TF_NOISE_SUPPRESSION),w.channelCount&&w.channelCount>1&&k.push(le.TF_STEREO),b&&k.push(le.TF_NO_DTX),it(e)&&e.hasPreConnectBuffer&&k.push(le.TF_PRECONNECT_BUFFER);const R=new xn({cid:e.mediaStreamTrack.id,name:t.name,type:C.kindToProto(e.kind),muted:e.isMuted,source:C.sourceToProto(e.source),disableDtx:b,encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=t.red)!==null&&s!==void 0)||s),stream:t?.stream,backupCodecPolicy:t?.backupCodecPolicy,audioFeatures:k});let S;if(e.kind===C.Kind.Video){let x={width:0,height:0};try{x=yield e.waitForDimensions()}catch{const A=(a=(o=this.roomOptions.videoCaptureDefaults)===null||o===void 0?void 0:o.resolution)!==null&&a!==void 0?a:Mn.h720.resolution;x={width:A.width,height:A.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),V(e)),{dims:x}))}R.width=x.width,R.height=x.height,bt(e)&&($e(m)&&(e.source===C.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),V(e))))),t.scalabilityMode=(c=t.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),R.simulcastCodecs=[new Tr({codec:m,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:qr}),t.backupCodec&&m!==t.backupCodec.codec&&R.encryption===oe.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),R.simulcastCodecs.push(new Tr({codec:t.backupCodec.codec,cid:""})))),S=zr(e.source===C.Source.ScreenShare,R.width,R.height,t),R.layers=Yo(R.width,R.height,S,$e(t.videoCodec))}else e.kind===C.Kind.Audio&&(S=[{maxBitrate:(l=t.audioPreset)===null||l===void 0?void 0:l.maxBitrate,priority:(d=(u=t.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(p=(f=t.audioPreset)===null||f===void 0?void 0:f.priority)!==null&&p!==void 0?p:"high"}]);if(!this.engine||this.engine.isClosed)throw new se("cannot publish track when not connected");const y=()=>v(this,void 0,void 0,function*(){var x,O,A;if(!this.engine.pcManager)throw new se("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,S),this.emit(_.LocalSenderCreated,e.sender,e),bt(e)&&((x=t.degradationPreference)!==null&&x!==void 0||(t.degradationPreference=Kf(e)),e.setDegradationPreference(t.degradationPreference)),S)if(Ft()&&e.kind===C.Kind.Audio){let U;for(const K of this.engine.pcManager.publisher.getTransceivers())if(K.sender===e.sender){U=K;break}U&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:U,codec:"opus",maxbr:!((O=S[0])===null||O===void 0)&&O.maxBitrate?S[0].maxBitrate/1e3:0})}else e.codec&&$e(e.codec)&&(!((A=S[0])===null||A===void 0)&&A.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:R.cid,codec:e.codec,maxbr:S[0].maxBitrate/1e3});yield this.engine.negotiate()});let T;const I=new Promise((x,O)=>v(this,void 0,void 0,function*(){var A;try{T=yield this.engine.addTrack(R),x(T)}catch(U){e.sender&&(!((A=this.engine.pcManager)===null||A===void 0)&&A.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(K=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),V(e)),{error:K}))})),O(U)}}));if(this.enabledPublishVideoCodecs.length>0)T=(yield Promise.all([I,y()]))[0];else{T=yield I;let x;if(T.codecs.forEach(O=>{x===void 0&&(x=O.mimeType)}),x&&e.kind===C.Kind.Video){const O=Pn(x);O!==m&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),V(e)),{codec:O})),t.videoCodec=O,S=zr(e.source===C.Source.ScreenShare,R.width,R.height,t))}yield y()}const D=new vi(e.kind,T,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(D.on(N.CpuConstrained,x=>this.onTrackCpuConstrained(x,D)),D.options=t,e.sid=T.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:S,trackInfo:T})),bt(e)?e.startMonitor(this.engine.client):it(e)&&e.startMonitor(),this.addTrackPublication(D),this.emit(_.LocalTrackPublished,D),it(e)&&T.audioFeatures.includes(le.TF_PRECONNECT_BUFFER)){const x=e.getPreConnectBuffer(),O=e.getPreConnectBufferMimeType();this.on(_.LocalTrackSubscribed,A=>{if(A.trackSid===T.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),V(e))),e.stopPreConnectBuffer()}}),x&&new Promise((U,K)=>v(this,void 0,void 0,function*(){var $,Me,ye,Pe,fe,ke;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),V(e)));const Ht=setTimeout(()=>{K(new Error("agent not active within 10 seconds"))},1e4),Ji=yield this.waitUntilActiveAgentPresent();clearTimeout(Ht),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),V(e)));const Vn=yield this.streamBytes({name:"preconnect-buffer",mimeType:O,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[Ji.identity],attributes:{trackId:D.trackSid,sampleRate:String((fe=w.sampleRate)!==null&&fe!==void 0?fe:"48000"),channels:String((ke=w.channelCount)!==null&&ke!==void 0?ke:"1")}});try{for(var Ot=!0,zt=at(x),mt;mt=yield zt.next(),$=mt.done,!$;Ot=!0){Pe=mt.value,Ot=!1;const Mt=Pe;yield Vn.write(Mt)}}catch(Mt){Me={error:Mt}}finally{try{!Ot&&!$&&(ye=zt.return)&&(yield ye.call(zt))}finally{if(Me)throw Me.error}}yield Vn.close(),U()}catch(Ht){K(Ht)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),V(e)))}).catch(U=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),V(e)),{error:U}))})}return D})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,i){return v(this,void 0,void 0,function*(){var r;if(this.encryptionType!==oe.NONE)return;let s;if(this.trackPublications.forEach(p=>{p.track&&p.track===e&&(s=p)}),!s)throw new ct("track is not published");if(!bt(e))throw new ct("track is not a video track");const o=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),a=Wf(e,t,o);if(!a){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),V(e)));return}const c=e.addSimulcastTrack(t,a);if(!c)return;const l=new xn({cid:c.mediaStreamTrack.id,type:C.kindToProto(e.kind),muted:e.isMuted,source:C.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=Yo(l.width,l.height,a),!this.engine||this.engine.isClosed)throw new se("cannot publish track when not connected");const u=()=>v(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,c,o,a),yield this.engine.negotiate()}),f=(yield Promise.all([this.engine.addTrack(l),u()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:f}))})}unpublishTrack(e,t){return v(this,void 0,void 0,function*(){var i,r;if(Nt(e)){const l=this.pendingPublishPromises.get(e);l&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),V(e))),yield l)}const s=this.getPublicationForTrack(e),o=s?V(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));return}e=s.track,e.off(N.Muted,this.onTrackMuted),e.off(N.Unmuted,this.onTrackUnmuted),e.off(N.Ended,this.handleTrackEnded),e.off(N.UpstreamPaused,this.onTrackUpstreamPaused),e.off(N.UpstreamResumed,this.onTrackUpstreamResumed),e.off(N.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t?e.stop():e.stopMonitor();let a=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<X.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",a=!0);if(this.engine.removeTrack(c)&&(a=!0),bt(e)){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(a=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:l}))}switch(this.trackPublications.delete(s.trackSid),s.kind){case C.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case C.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}return this.emit(_.LocalTrackUnpublished,s),s.setTrack(void 0),a&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return v(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>!!i)})}republishAllTracks(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){i.republishPromise&&(yield i.republishPromise),i.republishPromise=new Promise((s,o)=>v(i,void 0,void 0,function*(){try{const a=[];this.trackPublications.forEach(c=>{c.track&&(t&&(c.options=Object.assign(Object.assign({},c.options),t)),a.push(c))}),yield Promise.all(a.map(c=>v(this,void 0,void 0,function*(){const l=c.track;yield this.unpublishTrack(l,!1),r&&!l.isMuted&&l.source!==C.Source.ScreenShare&&l.source!==C.Source.ScreenShareAudio&&(it(l)||bt(l))&&!l.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:c.trackSid})),yield l.restartTrack()),yield this.publishOrRepublishTrack(l,c.options,!0)}))),s()}catch(a){o(a)}finally{this.republishPromise=void 0}})),yield i.republishPromise})()})}publishData(e){return v(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const s=r.reliable?B.RELIABLE:B.LOSSY,o=r.destinationIdentities,a=r.topic;let c=new as({participantIdentity:i.identity,payload:t,destinationIdentities:o,topic:a});const l=new me({kind:s,value:{case:"user",value:c}});yield i.engine.sendDataPacket(l,s)})()})}publishDtmf(e,t){return v(this,void 0,void 0,function*(){const i=new me({kind:B.RELIABLE,value:{case:"sipDtmf",value:new ec({code:e,digit:t})}});yield this.engine.sendDataPacket(i,B.RELIABLE)})}sendChatMessage(e,t){return v(this,void 0,void 0,function*(){const i={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t?.attachments},r=new me({value:{case:"chatMessage",value:new di(Object.assign(Object.assign({},i),{timestamp:Q.parse(i.timestamp)}))}});return yield this.engine.sendDataPacket(r,B.RELIABLE),this.emit(_.ChatMessage,i),i})}editChatMessage(e,t){return v(this,void 0,void 0,function*(){const i=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),r=new me({value:{case:"chatMessage",value:new di(Object.assign(Object.assign({},i),{timestamp:Q.parse(i.timestamp),editTimestamp:Q.parse(i.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,B.RELIABLE),this.emit(_.ChatMessage,i),i})}sendText(e,t){return v(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return v(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return v(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return v(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){return v(this,arguments,void 0,function(t){var i=this;let{destinationIdentity:r,method:s,payload:o,responseTimeout:a=15e3}=t;return(function*(){return new Promise((u,d)=>v(i,void 0,void 0,function*(){var f,p,g,m;if(Ps(o)>ll){d(ee.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((p=(f=this.engine.latestJoinResponse)===null||f===void 0?void 0:f.serverInfo)===null||p===void 0)&&p.version&&Be((m=(g=this.engine.latestJoinResponse)===null||g===void 0?void 0:g.serverInfo)===null||m===void 0?void 0:m.version,"1.8.0")<0){d(ee.builtIn("UNSUPPORTED_SERVER"));return}const k=Math.max(a,8e3),b=crypto.randomUUID();yield this.publishRpcRequest(r,b,s,o,k);const w=setTimeout(()=>{this.pendingAcks.delete(b),d(ee.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(b),clearTimeout(R)},7e3);this.pendingAcks.set(b,{resolve:()=>{clearTimeout(w)},participantIdentity:r});const R=setTimeout(()=>{this.pendingResponses.delete(b),d(ee.builtIn("RESPONSE_TIMEOUT"))},a);this.pendingResponses.set(b,{resolve:(S,y)=>{clearTimeout(R),this.pendingAcks.has(b)&&(console.warn("RPC response received before ack",b),this.pendingAcks.delete(b),clearTimeout(w)),y?d(y):u(S??"")},participantIdentity:r})}))})()})}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,i){const r=this.pendingResponses.get(e);r?(r.resolve(t,i),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,i,r,s){return v(this,void 0,void 0,function*(){const o=new me({destinationIdentities:[e],kind:B.RELIABLE,value:{case:"rpcRequest",value:new cs({id:t,method:i,payload:r,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(o,B.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:i,resolve:r}]of this.pendingResponses)i===e&&(r(null,ee.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return super.updateInfo(e)?(e.tracks.forEach(t=>{var i,r;const s=this.trackPublications.get(t.sid);if(s){const o=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);o!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),V(s)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(t.sid,o))}}),!0):!1}setActiveAgent(e){var t,i,r,s;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?(i=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||i===void 0||i.call(t,e):(s=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||s===void 0||s.call(r,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Oe),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(it(r)||bt(r))&&r.mediaStreamTrack===e&&(t=i):e===r&&(t=i))}),t}waitForPendingPublicationOfSource(e){return v(this,void 0,void 0,function*(){const i=Date.now();for(;Date.now()<i+1e4;){const r=Array.from(this.pendingPublishPromises.entries()).find(s=>{let[o]=s;return o.source===e});if(r)return r[1];yield ve(20)}})}}class bi extends rt{constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=s=>{this.setTrack(void 0),this.emit(N.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.visible=s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensionsAdaptiveStream=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Mi({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new nc({participantSid:"",trackSids:[this.trackSid]})]});this.emit(N.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?rt.SubscriptionStatus.Unsubscribed:super.isSubscribed?rt.SubscriptionStatus.Subscribed:rt.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?rt.PermissionStatus.Allowed:rt.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled(e){!this.isManualOperationAllowed()||this.requestedDisabled===!e||(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.requestedMaxQuality===e||(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,i;this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((i=this.requestedVideoDimensions)===null||i===void 0?void 0:i.height)===e.height||(rr(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&rr(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:Re.HIGH}setTrack(e){const t=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(N.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(N.VisibilityChanged,this.handleVisibilityChange),r.off(N.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(N.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(N.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(N.VisibilityChanged,this.handleVisibilityChange),e.on(N.Ended,this.handleEnded),this.emit(N.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(N.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?N.Muted:N.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(N.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(N.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return rr(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new dc({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===C.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t)Lo(this.videoDimensionsAdaptiveStream,t)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const i=af(this.trackInfo,this.requestedMaxQuality);i&&Lo(this.videoDimensionsAdaptiveStream,i)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream;t?(e.width=Math.ceil(t.width),e.height=Math.ceil(t.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:Re.HIGH})),e.quality=Re.HIGH)}this.emit(N.UpdateSettings,e)}}class yi extends vl{static fromParticipantInfo(e,t,i){return new yi(e,t.sid,t.identity,t.name,t.metadata,t.attributes,i,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,i,r,s,o,a){let c=arguments.length>7&&arguments[7]!==void 0?arguments[7]:In.STANDARD;super(t,i||"",r,s,o,a,c),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(N.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),V(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(N.UpdateSubscription,t=>{t.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(N.SubscriptionPermissionChanged,t=>{this.emit(_.TrackSubscriptionPermissionChanged,e,t)}),e.on(N.SubscriptionStatusChanged,t=>{this.emit(_.TrackSubscriptionStatusChanged,e,t)}),e.on(N.Subscribed,t=>{this.emit(_.TrackSubscribed,t,e)}),e.on(N.Unsubscribed,t=>{this.emit(_.TrackUnsubscribed,t,e)}),e.on(N.SubscriptionFailed,t=>{this.emit(_.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:C.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrackPublication(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:C.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,r,s,o){let a=this.getTrackPublicationBySid(t);if(a||t.startsWith("TR")||this.trackPublications.forEach(u=>{!a&&e.kind===u.kind.toString()&&(a=u)}),!a){if(o===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(_.TrackSubscriptionFailed,t);return}o===void 0&&(o=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,i,r,s,o-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),V(a))),this.emit(_.TrackSubscriptionFailed,t);return}const c=e.kind==="video";let l;return c?l=new sp(e,t,r,s):l=new gl(e,t,r,this.audioContext,this.audioOutput),l.source=a.source,l.isMuted=a.isMuted,l.setMediaStream(i),l.start(),a.setTrack(l),this.volumeMap.has(a.source)&&jr(l)&&Qe(l)&&l.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,i=new Map;return e.tracks.forEach(r=>{var s,o;let a=this.getTrackPublicationBySid(r.sid);if(a)a.updateInfo(r);else{const c=C.kindFromProto(r.type);if(!c)return;a=new bi(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(o=this.loggerOptions)===null||o===void 0?void 0:o.loggerName}),a.updateInfo(r),i.set(r.sid,a);const l=Array.from(this.trackPublications.values()).find(u=>u.source===a?.source);l&&a.source!==C.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(a.source),Object.assign(Object.assign({},this.logContext),{oldTrack:V(l),newTrack:V(a)})),this.addTrackPublication(a)}t.set(r.sid,a)}),this.trackPublications.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),V(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(_.TrackPublished,r)}),!0}unpublishTrack(e,t){const i=this.trackPublications.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.trackPublications.delete(e),i.kind){case C.Kind.Audio:this.audioTrackPublications.delete(e);break;case C.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(_.TrackUnpublished,i)}setAudioOutput(e){return v(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(i=>{var r;Qe(i.track)&&jr(i.track)&&t.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}var W;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting"})(W||(W={}));const hp=4*1e3;class ut extends et.EventEmitter{get hasE2EESetup(){return this.e2eeManager!==void 0}constructor(e){var t,i,r,s;if(super(),t=this,this.state=W.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=F,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(o,a,c)=>v(this,void 0,void 0,function*(){var l;if(!Bh())throw Xe()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const u=yield this.disconnectLock.lock();if(this.state===W.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),u(),Promise.resolve();if(this.connectFuture)return u(),this.connectFuture.promise;this.setAndEmitConnectionState(W.Connecting),((l=this.regionUrlProvider)===null||l===void 0?void 0:l.getServerUrl().toString())!==o&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),Ur(new URL(o))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new Hr(o,a):this.regionUrlProvider.updateToken(a),this.regionUrlProvider.fetchRegionSettings().then(p=>{var g;(g=this.regionUrlProvider)===null||g===void 0||g.setServerReportedRegions(p)}).catch(p=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:p}))}));const d=(p,g,m)=>v(this,void 0,void 0,function*(){var k,b;this.abortController&&this.abortController.abort();const w=new AbortController;this.abortController=w,u?.();try{yield this.attemptConnection(m??o,a,c,w),this.abortController=void 0,p()}catch(R){if(this.regionUrlProvider&&R instanceof H&&R.reason!==z.Cancelled&&R.reason!==z.NotAllowed){let S=null;try{S=yield this.regionUrlProvider.getNextBestRegionUrl((k=this.abortController)===null||k===void 0?void 0:k.signal)}catch(y){if(y instanceof H&&(y.status===401||y.reason===z.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),g(y);return}}S&&!(!((b=this.abortController)===null||b===void 0)&&b.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(R.message,". Retrying with another region: ").concat(S),this.logContext),this.recreateEngine(),yield d(p,g,S)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,No(R)),g(R))}else{let S=Fe.UNKNOWN_REASON;R instanceof H&&(S=No(R)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,S),g(R)}}}),f=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Oe((p,g)=>{d(p,g,f)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(o,a,c,l,u,d)=>v(this,void 0,void 0,function*(){var f,p,g;const m=yield c.join(o,a,{autoSubscribe:l.autoSubscribe,adaptiveStream:typeof u.adaptiveStream=="object"?!0:u.adaptiveStream,maxRetries:l.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:l.websocketTimeout,singlePeerConnection:u.singlePeerConnection},d.signal);let k=m.serverInfo;if(k||(k={version:m.serverVersion,region:m.serverRegion}),this.serverInfo=k,this.log.debug("connected to Livekit Server ".concat(Object.entries(k).map(b=>{let[w,R]=b;return"".concat(w,": ").concat(R)}).join(", ")),{room:(f=m.room)===null||f===void 0?void 0:f.name,roomSid:(p=m.room)===null||p===void 0?void 0:p.sid,identity:(g=m.participant)===null||g===void 0?void 0:g.identity}),!k.version)throw new Eh("unknown server version");return k.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),u.dynacast=!1),m}),this.applyJoinResponse=o=>{const a=o.participant;if(this.localParticipant.sid=a.sid,this.localParticipant.identity=a.identity,this.localParticipant.setEnabledPublishCodecs(o.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(o.sifTrailer)}catch(c){this.log.error(c instanceof Error?c.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:c}))}this.handleParticipantUpdates([a,...o.otherParticipants]),o.room&&this.handleRoomUpdate(o.room)},this.attemptConnection=(o,a,c,l)=>v(this,void 0,void 0,function*(){var u,d;this.state===W.Reconnecting||this.isResuming||!((u=this.engine)===null||u===void 0)&&u.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((d=this.regionUrlProvider)===null||d===void 0)&&d.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},ws),c),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const f=yield this.connectSignal(o,a,this.engine,this.connOptions,this.options,l);this.applyJoinResponse(f),this.setupLocalParticipantEvents(),this.emit(P.SignalConnected)}catch(f){yield this.engine.close(),this.recreateEngine();const p=new H("could not establish signal connection",z.ServerUnreachable);throw f instanceof Error&&(p.message="".concat(p.message,": ").concat(f.message)),f instanceof H&&(p.reason=f.reason,p.status=f.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:f})),p}if(l.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new H("Connection attempt aborted",z.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,l)}catch(f){throw yield this.engine.close(),this.recreateEngine(),f}Te()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Te()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(W.Connected),this.emit(P.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return v(t,[...a],void 0,function(){var l=this;let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var d,f,p,g;const m=yield l.disconnectLock.lock();try{if(l.state===W.Disconnected){l.log.debug("already disconnected",l.logContext);return}if(l.log.info("disconnect from room",Object.assign({},l.logContext)),l.state===W.Connecting||l.state===W.Reconnecting||l.isResuming){const k="Abort connection attempt due to user initiated disconnect";l.log.warn(k,l.logContext),(d=l.abortController)===null||d===void 0||d.abort(k),(p=(f=l.connectFuture)===null||f===void 0?void 0:f.reject)===null||p===void 0||p.call(f,new H("Client initiated disconnect",z.Cancelled)),l.connectFuture=void 0}!((g=l.engine)===null||g===void 0)&&g.client.isDisconnected||(yield l.engine.client.sendLeave()),l.engine&&(yield l.engine.close()),l.handleDisconnect(u,Fe.CLIENT_INITIATED),l.engine=void 0}finally{m()}})()})},this.onPageLeave=()=>v(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>v(this,void 0,void 0,function*(){const o=[],a=ge();if(a&&a.os==="iOS"){const c="livekit-dummy-audio-el";let l=document.getElementById(c);if(!l){l=document.createElement("audio"),l.id=c,l.autoplay=!0,l.hidden=!0;const u=ir();u.enabled=!0;const d=new MediaStream([u]);l.srcObject=d,document.addEventListener("visibilitychange",()=>{l&&(l.srcObject=document.hidden?null:d,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(l),this.once(P.Disconnected,()=>{l?.remove(),l=null})}o.push(l)}this.remoteParticipants.forEach(c=>{c.audioTrackPublications.forEach(l=>{l.track&&l.track.attachedElements.forEach(u=>{o.push(u)})})});try{yield Promise.all([this.acquireAudioContext(),...o.map(c=>(c.muted=!1,c.play()))]),this.handleAudioPlaybackStarted()}catch(c){throw this.handleAudioPlaybackFailed(c),c}}),this.startVideo=()=>v(this,void 0,void 0,function*(){const o=[];for(const a of this.remoteParticipants.values())a.videoTrackPublications.forEach(c=>{var l;(l=c.track)===null||l===void 0||l.attachedElements.forEach(u=>{o.includes(u)||o.push(u)})});yield Promise.all(o.map(a=>a.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(a=>{a.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const o of this.remoteParticipants.values())this.handleParticipantDisconnected(o.identity,o);this.setAndEmitConnectionState(W.Reconnecting)&&this.emit(P.Reconnecting)},this.handleSignalRestarted=o=>v(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(o.serverRegion),Object.assign(Object.assign({},this.logContext),{region:o.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(o);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(a){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:a}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:o.serverRegion}))}catch{return}this.setAndEmitConnectionState(W.Connected),this.emit(P.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=o=>{o.forEach(a=>{var c;if(a.identity===this.localParticipant.identity){this.localParticipant.updateInfo(a);return}a.identity===""&&(a.identity=(c=this.sidToIdentity.get(a.sid))!==null&&c!==void 0?c:"");let l=this.remoteParticipants.get(a.identity);a.state===Yt.DISCONNECTED?this.handleParticipantDisconnected(a.identity,l):l=this.getOrCreateParticipant(a.identity,a)})},this.handleActiveSpeakersUpdate=o=>{const a=[],c={};o.forEach(l=>{if(c[l.sid]=!0,l.sid===this.localParticipant.sid)this.localParticipant.audioLevel=l.level,this.localParticipant.setIsSpeaking(!0),a.push(this.localParticipant);else{const u=this.getRemoteParticipantBySid(l.sid);u&&(u.audioLevel=l.level,u.setIsSpeaking(!0),a.push(u))}}),c[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(l=>{c[l.sid]||(l.audioLevel=0,l.setIsSpeaking(!1))}),this.activeSpeakers=a,this.emitWhenConnected(P.ActiveSpeakersChanged,a)},this.handleSpeakersChanged=o=>{const a=new Map;this.activeSpeakers.forEach(l=>{const u=this.remoteParticipants.get(l.identity);u&&u.sid!==l.sid||a.set(l.sid,l)}),o.forEach(l=>{let u=this.getRemoteParticipantBySid(l.sid);l.sid===this.localParticipant.sid&&(u=this.localParticipant),u&&(u.audioLevel=l.level,u.setIsSpeaking(l.active),l.active?a.set(l.sid,u):a.delete(l.sid))});const c=Array.from(a.values());c.sort((l,u)=>u.audioLevel-l.audioLevel),this.activeSpeakers=c,this.emitWhenConnected(P.ActiveSpeakersChanged,c)},this.handleStreamStateUpdate=o=>{o.streamStates.forEach(a=>{const c=this.getRemoteParticipantBySid(a.participantSid);if(!c)return;const l=c.getTrackPublicationBySid(a.trackSid);if(!l||!l.track)return;const u=C.streamStateFromProto(a.state);l.track.setStreamState(u),u!==l.track.streamState&&(c.emit(_.TrackStreamStateChanged,l,l.track.streamState),this.emitWhenConnected(P.TrackStreamStateChanged,l,l.track.streamState,c))})},this.handleSubscriptionPermissionUpdate=o=>{const a=this.getRemoteParticipantBySid(o.participantSid);if(!a)return;const c=a.getTrackPublicationBySid(o.trackSid);c&&c.setAllowed(o.allowed)},this.handleSubscriptionError=o=>{const a=Array.from(this.remoteParticipants.values()).find(l=>l.trackPublications.has(o.trackSid));if(!a)return;const c=a.getTrackPublicationBySid(o.trackSid);c&&c.setSubscriptionError(o.err)},this.handleDataPacket=(o,a)=>{const c=this.remoteParticipants.get(o.participantIdentity);if(o.value.case==="user")this.handleUserPacket(c,o.value.value,o.kind,a);else if(o.value.case==="transcription")this.handleTranscription(c,o.value.value);else if(o.value.case==="sipDtmf")this.handleSipDtmf(c,o.value.value);else if(o.value.case==="chatMessage")this.handleChatMessage(c,o.value.value);else if(o.value.case==="metrics")this.handleMetrics(o.value.value,c);else if(o.value.case==="streamHeader"||o.value.case==="streamChunk"||o.value.case==="streamTrailer")this.handleDataStream(o,a);else if(o.value.case==="rpcRequest"){const l=o.value.value;this.handleIncomingRpcRequest(o.participantIdentity,l.id,l.method,l.payload,l.responseTimeoutMs,l.version)}},this.handleUserPacket=(o,a,c,l)=>{this.emit(P.DataReceived,a.payload,o,c,a.topic,l),o?.emit(_.DataReceived,a.payload,c,l)},this.handleSipDtmf=(o,a)=>{this.emit(P.SipDTMFReceived,a,o),o?.emit(_.SipDTMFReceived,a)},this.handleTranscription=(o,a)=>{const c=a.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(a.transcribedParticipantIdentity),l=c?.trackPublications.get(a.trackId),u=$h(a,this.transcriptionReceivedTimes);l?.emit(N.TranscriptionReceived,u),c?.emit(_.TranscriptionReceived,u,l),this.emit(P.TranscriptionReceived,u,c,l)},this.handleChatMessage=(o,a)=>{const c=Qh(a);this.emit(P.ChatMessage,c,o)},this.handleMetrics=(o,a)=>{this.emit(P.MetricsReceived,o,a)},this.handleDataStream=(o,a)=>{this.incomingDataStreamManager.handleDataStreamPacket(o,a)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(P.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=o=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:o})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(P.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(P.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(P.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>v(this,void 0,void 0,function*(){var o;((o=ge())===null||o===void 0?void 0:o.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(P.MediaDevicesChanged)}),this.handleRoomUpdate=o=>{const a=this.roomInfo;this.roomInfo=o,a&&a.metadata!==o.metadata&&this.emitWhenConnected(P.RoomMetadataChanged,o.metadata),a?.activeRecording!==o.activeRecording&&this.emitWhenConnected(P.RecordingStatusChanged,o.activeRecording)},this.handleConnectionQualityUpdate=o=>{o.updates.forEach(a=>{if(a.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(a.quality);return}const c=this.getRemoteParticipantBySid(a.participantSid);c&&c.setConnectionQuality(a.quality)})},this.onLocalParticipantMetadataChanged=o=>{this.emit(P.ParticipantMetadataChanged,o,this.localParticipant)},this.onLocalParticipantNameChanged=o=>{this.emit(P.ParticipantNameChanged,o,this.localParticipant)},this.onLocalAttributesChanged=o=>{this.emit(P.ParticipantAttributesChanged,o,this.localParticipant)},this.onLocalTrackMuted=o=>{this.emit(P.TrackMuted,o,this.localParticipant)},this.onLocalTrackUnmuted=o=>{this.emit(P.TrackUnmuted,o,this.localParticipant)},this.onTrackProcessorUpdate=o=>{var a;(a=o?.onPublish)===null||a===void 0||a.call(o,this)},this.onLocalTrackPublished=o=>v(this,void 0,void 0,function*(){var a,c,l,u,d,f;(a=o.track)===null||a===void 0||a.on(N.TrackProcessorUpdate,this.onTrackProcessorUpdate),(c=o.track)===null||c===void 0||c.on(N.Restarted,this.onLocalTrackRestarted),(d=(u=(l=o.track)===null||l===void 0?void 0:l.getProcessor())===null||u===void 0?void 0:u.onPublish)===null||d===void 0||d.call(u,this),this.emit(P.LocalTrackPublished,o,this.localParticipant),it(o.track)&&(yield o.track.checkForSilence())&&this.emit(P.LocalAudioSilenceDetected,o);const p=yield(f=o.track)===null||f===void 0?void 0:f.getDeviceId(!1),g=Vr(o.source);g&&p&&p!==this.localParticipant.activeDeviceMap.get(g)&&(this.localParticipant.activeDeviceMap.set(g,p),this.emit(P.ActiveDeviceChanged,g,p))}),this.onLocalTrackUnpublished=o=>{var a,c;(a=o.track)===null||a===void 0||a.off(N.TrackProcessorUpdate,this.onTrackProcessorUpdate),(c=o.track)===null||c===void 0||c.off(N.Restarted,this.onLocalTrackRestarted),this.emit(P.LocalTrackUnpublished,o,this.localParticipant)},this.onLocalTrackRestarted=o=>v(this,void 0,void 0,function*(){const a=yield o.getDeviceId(!1),c=Vr(o.source);c&&a&&a!==this.localParticipant.activeDeviceMap.get(c)&&(this.log.debug("local track restarted, setting ".concat(c," ").concat(a," active"),this.logContext),this.localParticipant.activeDeviceMap.set(c,a),this.emit(P.ActiveDeviceChanged,c,a))}),this.onLocalConnectionQualityChanged=o=>{this.emit(P.ConnectionQualityChanged,o,this.localParticipant)},this.onMediaDevicesError=(o,a)=>{this.emit(P.MediaDevicesError,o,a)},this.onLocalParticipantPermissionsChanged=o=>{this.emit(P.ParticipantPermissionsChanged,o,this.localParticipant)},this.onLocalChatMessageSent=o=>{this.emit(P.ChatMessage,o,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},_f),e),this.log=lt((i=this.options.loggerName)!==null&&i!==void 0?i:je.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},al),e?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},cl),e?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Rf),e?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new tp,this.outgoingDataStreamManager=new rp(this.engine,this.log),this.disconnectLock=new Ce,this.localParticipant=new dp("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Et(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Et(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",Et(this.options.audioOutput.deviceId)).catch(o=>this.log.warn("Could not set audio output: ".concat(o.message),this.logContext)),Te()){const o=new AbortController;(s=navigator.mediaDevices)===null||s===void 0||s.addEventListener("devicechange",this.handleDeviceChange,{signal:o.signal}),ut.cleanupRegistry&&ut.cleanupRegistry.register(this,()=>{o.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return v(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;const t=!!this.options.encryption,i=this.options.encryption||this.options.e2ee;i&&("e2eeManager"in i?(this.e2eeManager=i.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new cf(i,t),this.e2eeManager.on(St.ParticipantEncryptionStatusChanged,(r,s)=>{Xh(s)&&(this.isE2EEEnabled=r),this.emit(P.ParticipantEncryptionStatusChanged,r,s)}),this.e2eeManager.on(St.EncryptionError,r=>this.emit(P.EncryptionError,r)),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return v(this,void 0,void 0,function*(){return this.state===W.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((e,t)=>{const i=r=>{r.sid!==""&&(this.engine.off(L.RoomUpdate,i),e(r.sid))};this.engine.on(L.RoomUpdate,i),this.once(P.Disconnected,()=>{this.engine.off(L.RoomUpdate,i),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Qf(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(L.ParticipantUpdate,this.handleParticipantUpdates).on(L.RoomUpdate,this.handleRoomUpdate).on(L.SpeakersChanged,this.handleSpeakersChanged).on(L.StreamStateChanged,this.handleStreamStateUpdate).on(L.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(L.SubscriptionError,this.handleSubscriptionError).on(L.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(L.MediaTrackAdded,(e,t,i)=>{this.onTrackAdded(e,t,i)}).on(L.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(L.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(L.DataPacketReceived,this.handleDataPacket).on(L.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(W.SignalReconnecting)&&this.emit(P.SignalReconnecting)}).on(L.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(W.Connected)&&this.emit(P.Reconnected)}).on(L.SignalResumed,()=>{this.bufferedEvents=[],(this.state===W.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(L.Restarting,this.handleRestarting).on(L.SignalRestarted,this.handleSignalRestarted).on(L.Offline,()=>{this.setAndEmitConnectionState(W.Reconnecting)&&this.emit(P.Reconnecting)}).on(L.DCBufferStatusChanged,(e,t)=>{this.emit(P.DCBufferStatusChanged,e,t)}).on(L.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(i=>{let{trackSid:r}=i;return r===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(_.LocalTrackSubscribed,t),this.emitWhenConnected(P.LocalTrackSubscribed,t,this.localParticipant)}).on(L.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((t,i)=>{this.handleParticipantDisconnected(i,t)}),this.emit(P.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return ue.getInstance().getDevices(e,t)}prepareConnection(e,t){return v(this,void 0,void 0,function*(){if(this.state===W.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(Ur(new URL(e))&&t){this.regionUrlProvider=new Hr(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===W.Disconnected&&(this.regionUrl=i,yield fetch(Fr(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(Fr(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return v(this,void 0,void 0,function*(){let i=()=>v(this,void 0,void 0,function*(){}),r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new Ge({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new Ge({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new Ge({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new Ge({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>v(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new Ge({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>v(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new Ge({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new Ge({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>v(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new Ai({reason:Fe.CLIENT_INITIATED,action:Xt.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new Ge({scenario:{case:"subscriberBandwidth",value:Dt(t)}});break;case"leave-full-reconnect":r=new Ge({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return v(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var a,c,l,u,d,f,p;let g=!0,m=!1;const k=o?{exact:r}:r;if(i==="audioinput"){m=s.localParticipant.audioTrackPublications.size===0;const b=(a=s.getActiveDevice(i))!==null&&a!==void 0?a:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=k;const w=Array.from(s.localParticipant.audioTrackPublications.values()).filter(S=>S.source===C.Source.Microphone);try{g=(yield Promise.all(w.map(S=>{var y;return(y=S.audioTrack)===null||y===void 0?void 0:y.setDeviceId(k)}))).every(S=>S===!0)}catch(S){throw s.options.audioCaptureDefaults.deviceId=b,S}const R=w.some(S=>{var y,T;return(T=(y=S.track)===null||y===void 0?void 0:y.isMuted)!==null&&T!==void 0?T:!1});g&&R&&(m=!0)}else if(i==="videoinput"){m=s.localParticipant.videoTrackPublications.size===0;const b=(c=s.getActiveDevice(i))!==null&&c!==void 0?c:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=k;const w=Array.from(s.localParticipant.videoTrackPublications.values()).filter(S=>S.source===C.Source.Camera);try{g=(yield Promise.all(w.map(S=>{var y;return(y=S.videoTrack)===null||y===void 0?void 0:y.setDeviceId(k)}))).every(S=>S===!0)}catch(S){throw s.options.videoCaptureDefaults.deviceId=b,S}const R=w.some(S=>{var y,T;return(T=(y=S.track)===null||y===void 0?void 0:y.isMuted)!==null&&T!==void 0?T:!1});g&&R&&(m=!0)}else if(i==="audiooutput"){if(m=!0,!Lr()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");s.options.webAudioMix&&(r=(l=yield ue.getInstance().normalizeDeviceId("audiooutput",r))!==null&&l!==void 0?l:""),(u=(p=s.options).audioOutput)!==null&&u!==void 0||(p.audioOutput={});const b=(d=s.getActiveDevice(i))!==null&&d!==void 0?d:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=r;try{s.options.webAudioMix&&((f=s.audioContext)===null||f===void 0||f.setSinkId(r)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(w=>w.setAudioOutput({deviceId:r})))}catch(w){throw s.options.audioOutput.deviceId=b,w}}return m&&(s.localParticipant.activeDeviceMap.set(i,r),s.emit(P.ActiveDeviceChanged,i,r)),g})()})}setupLocalParticipantEvents(){this.localParticipant.on(_.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(_.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(_.AttributesChanged,this.onLocalAttributesChanged).on(_.TrackMuted,this.onLocalTrackMuted).on(_.TrackUnmuted,this.onLocalTrackUnmuted).on(_.LocalTrackPublished,this.onLocalTrackPublished).on(_.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(_.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(_.MediaDevicesError,this.onMediaDevicesError).on(_.AudioStreamAcquired,this.startAudio).on(_.ChatMessage,this.onLocalChatMessageSent).on(_.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===W.Connecting||this.state===W.Reconnecting){const d=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(p=>p.id)}),this.onTrackAdded(e,t,i),f()},f=()=>{this.off(P.Reconnected,d),this.off(P.Connected,d),this.off(P.Disconnected,f)};this.once(P.Reconnected,d),this.once(P.Connected,d),this.once(P.Disconnected,f);return}if(this.state===W.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const r=Uh(t.id),s=r[0];let o=r[1],a=e.id;if(o&&o.startsWith("TR")&&(a=o),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=Array.from(this.remoteParticipants.values()).find(d=>d.sid===s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}if(!a.startsWith("TR")){const d=this.engine.getTrackIdForReceiver(i);if(!d){this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(s),this.logContext);return}a=d}a.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(s,", streamId: ").concat(o,", trackId: ").concat(a),Object.assign(Object.assign({},this.logContext),{rpID:s,streamId:o,trackId:a}));let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={});const u=c.addSubscribedMediaTrack(e,a,t,i,l);u?.isEncrypted&&!this.e2eeManager&&this.emit(P.EncryptionError,new Error("Encrypted ".concat(u.source," track received from participant ").concat(c.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var i;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearHandlersAndControllers(),this.state!==W.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{r.unpublishTrack(s.trackSid)})}),this.localParticipant.trackPublications.forEach(r=>{var s,o,a;r.track&&this.localParticipant.unpublishTrack(r.track,e),e?((s=r.track)===null||s===void 0||s.detach(),(o=r.track)===null||o===void 0||o.stop()):(a=r.track)===null||a===void 0||a.stopMonitor()}),this.localParticipant.off(_.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(_.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(_.AttributesChanged,this.onLocalAttributesChanged).off(_.TrackMuted,this.onLocalTrackMuted).off(_.TrackUnmuted,this.onLocalTrackUnmuted).off(_.LocalTrackPublished,this.onLocalTrackPublished).off(_.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(_.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(_.MediaDevicesError,this.onMediaDevicesError).off(_.AudioStreamAcquired,this.startAudio).off(_.ChatMessage,this.onLocalChatMessageSent).off(_.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Te()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(i=navigator.mediaDevices)===null||i===void 0||i.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(W.Disconnected),this.emit(P.Disconnected,t)}}}handleParticipantDisconnected(e,t){var i;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(r=>{t.unpublishTrack(r.trackSid,!0)}),this.emit(P.ParticipantDisconnected,t),t.setDisconnected(),(i=this.localParticipant)===null||i===void 0||i.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,i,r,s,o){return v(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),o!==1){yield this.engine.publishRpcResponse(e,t,null,ee.builtIn("UNSUPPORTED_VERSION"));return}const a=this.rpcHandlers.get(i);if(!a){yield this.engine.publishRpcResponse(e,t,null,ee.builtIn("UNSUPPORTED_METHOD"));return}let c=null,l=null;try{const u=yield a({requestId:t,callerIdentity:e,payload:r,responseTimeout:s});Ps(u)>ll?(c=ee.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(i))):l=u}catch(u){u instanceof ee?c=u:(console.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),u),c=ee.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,l,c)})}selectDefaultDevices(){return v(this,void 0,void 0,function*(){var e,t,i;const r=ue.getInstance().previousDevices,s=yield ue.getInstance().getDevices(void 0,!1),o=ge();if(o?.name==="Chrome"&&o.os!=="iOS")for(let c of s){const l=r.find(u=>u.deviceId===c.deviceId);l&&l.label!==""&&l.kind===c.kind&&l.label!==c.label&&this.getActiveDevice(c.kind)==="default"&&this.emit(P.ActiveDeviceChanged,c.kind,c.deviceId)}const a=["audiooutput","audioinput","videoinput"];for(let c of a){const l=ef(c),u=this.localParticipant.getTrackPublication(l);if(u&&(!((e=u.track)===null||e===void 0)&&e.isUserProvided))continue;const d=s.filter(p=>p.kind===c),f=this.getActiveDevice(c);if(f===((t=r.filter(p=>p.kind===c)[0])===null||t===void 0?void 0:t.deviceId)&&d.length>0&&((i=d[0])===null||i===void 0?void 0:i.deviceId)!==f){yield this.switchActiveDevice(c,d[0].deviceId);continue}c==="audioinput"&&!An()||c==="videoinput"||d.length>0&&!d.find(p=>p.deviceId===this.getActiveDevice(c))&&(c!=="audiooutput"||!An())&&(yield this.switchActiveDevice(c,d[0].deviceId))}})}acquireAudioContext(){return v(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=rl())!==null&&e!==void 0?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),ve(200)])}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(P.AudioPlaybackStatusChanged,i))})}createParticipant(e,t){var i;let r;return t?r=yi.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new yi(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return t&&r.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),r}const i=this.createParticipant(e,t);return this.remoteParticipants.set(e,i),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(P.ParticipantConnected,i),i.on(_.TrackPublished,r=>{this.emitWhenConnected(P.TrackPublished,r,i)}).on(_.TrackSubscribed,(r,s)=>{r.kind===C.Kind.Audio?(r.on(N.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(N.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===C.Kind.Video&&(r.on(N.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(N.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(P.TrackSubscribed,r,s,i)}).on(_.TrackUnpublished,r=>{this.emit(P.TrackUnpublished,r,i)}).on(_.TrackUnsubscribed,(r,s)=>{this.emit(P.TrackUnsubscribed,r,s,i)}).on(_.TrackMuted,r=>{this.emitWhenConnected(P.TrackMuted,r,i)}).on(_.TrackUnmuted,r=>{this.emitWhenConnected(P.TrackUnmuted,r,i)}).on(_.ParticipantMetadataChanged,r=>{this.emitWhenConnected(P.ParticipantMetadataChanged,r,i)}).on(_.ParticipantNameChanged,r=>{this.emitWhenConnected(P.ParticipantNameChanged,r,i)}).on(_.AttributesChanged,r=>{this.emitWhenConnected(P.ParticipantAttributesChanged,r,i)}).on(_.ConnectionQualityChanged,r=>{this.emitWhenConnected(P.ConnectionQualityChanged,r,i)}).on(_.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(P.ParticipantPermissionsChanged,r,i)}).on(_.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(P.TrackSubscriptionStatusChanged,r,s,i)}).on(_.TrackSubscriptionFailed,(r,s)=>{this.emit(P.TrackSubscriptionFailed,r,i,s)}).on(_.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(P.TrackSubscriptionPermissionChanged,r,s,i)}).on(_.Active,()=>{this.emitWhenConnected(P.ParticipantActive,i),i.kind===In.AGENT&&this.localParticipant.setActiveAgent(i)}),t&&i.updateInfo(t),i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((i,r)=>(i.push(...r.getTrackPublications()),i),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&Yh(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=he.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Fe.STATE_MISMATCH))):e=0},hp)}clearConnectionReconcile(){this.connectionReconcileInterval&&he.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(P.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,i]=e;this.emit(t,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(this.state===W.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===W.Connected)return this.emit(e,...i);return!1}simulateParticipants(e){return v(this,void 0,void 0,function*(){var t,i;const r=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),s=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Ii({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:Q.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new Ut({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(P.SignalConnected),this.emit(P.Connected),this.setAndEmitConnectionState(W.Connected),r.video){const o=new vi(C.Kind.Video,new Jt({source:ne.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO,name:"video-dummy"}),new gi(r.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Do(160*((t=s.aspectRatios[0])!==null&&t!==void 0?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(_.LocalTrackPublished,o)}if(r.audio){const o=new vi(C.Kind.Audio,new Jt({source:ne.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO}),new mi(r.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:ir(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(_.LocalTrackPublished,o)}for(let o=0;o<s.count-1;o+=1){let a=new Ut({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(o),state:Yt.ACTIVE,tracks:[],joinedAt:Q.parse(Date.now())});const c=this.getOrCreateParticipant(a.identity,a);if(s.video){const l=Do(160*((i=s.aspectRatios[o%s.aspectRatios.length])!==null&&i!==void 0?i:1),160,!1,!0),u=new Jt({source:ne.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}if(s.audio){const l=ir(),u=new Jt({source:ne.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}c.updateInfo(a)}})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(e!==P.ActiveSpeakersChanged&&e!==P.TranscriptionReceived){const s=bl(i).filter(o=>o!==void 0);(e===P.TrackSubscribed||e===P.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}ut.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(n=>{n()});function bl(n){return n.map(e=>{if(e)return Array.isArray(e)?bl(e):typeof e=="object"?"logContext"in e?e.logContext:void 0:e})}var De;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(De||(De={}));class xt extends et.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=De.IDLE,this.logs=[],this.options={},this.url=e,this.token=t,this.name=this.constructor.name,this.room=new ut(i.roomOptions),this.connectOptions=i.connectOptions,this.options=i}run(e){return v(this,void 0,void 0,function*(){if(this.status!==De.IDLE)throw Error("check is running already");this.setStatus(De.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==De.SKIPPED&&this.setStatus(this.isSuccess()?De.SUCCESS:De.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(e){return v(this,void 0,void 0,function*(){return this.room.state===W.Connected?this.room:(e||(e=this.url),yield this.room.connect(e,this.token,this.connectOptions),this.room)})}disconnect(){return v(this,void 0,void 0,function*(){this.room&&this.room.state!==W.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(De.SKIPPED)}switchProtocol(e){return v(this,void 0,void 0,function*(){let t=!1,i=!1;if(this.room.on(P.Reconnecting,()=>{t=!0}),this.room.once(P.Reconnected,()=>{i=!0}),this.room.simulateScenario("force-".concat(e)),yield new Promise(s=>setTimeout(s,1e3)),!t)return;const r=Date.now()+1e4;for(;Date.now()<r;){if(i)return;yield ve(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))})}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class fp extends xt{get description(){return"Cloud regions"}perform(){return v(this,void 0,void 0,function*(){const e=new Hr(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[],i=new Set;for(let s=0;s<3;s++){const o=yield e.getNextBestRegionUrl();if(!o)break;if(i.has(o))continue;i.add(o);const a=yield this.checkCloudRegion(o);this.appendMessage("".concat(a.region," RTT: ").concat(a.rtt,"ms, duration: ").concat(a.duration,"ms")),t.push(a)}t.sort((s,o)=>(s.duration-o.duration)*.5+(s.rtt-o.rtt)*.5);const r=t[0];this.bestStats=r,this.appendMessage("best Cloud region: ".concat(r.region))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkCloudRegion(e){return v(this,void 0,void 0,function*(){var t,i;yield this.connect(e),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const r=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!r)throw new Error("Region not found");const s=yield this.room.localParticipant.streamText({topic:"test"}),o=1e3,c=1e6/o,l="A".repeat(o),u=Date.now();for(let g=0;g<c;g++)yield s.write(l);yield s.close();const d=Date.now(),f=yield(i=this.room.engine.pcManager)===null||i===void 0?void 0:i.publisher.getStats(),p={region:r,rtt:1e4,duration:d-u};return f?.forEach(g=>{g.type==="candidate-pair"&&g.nominated&&(p.rtt=g.currentRoundTripTime*1e3)}),yield this.disconnect(),p})}}const hr=1e4;class pp extends xt{get description(){return"Connection via UDP vs TCP"}perform(){return v(this,void 0,void 0,function*(){const e=yield this.checkConnectionProtocol("udp"),t=yield this.checkConnectionProtocol("tcp");this.bestStats=e,e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=t):this.appendMessage("best connection quality via udp");const i=this.bestStats;this.appendMessage("upstream bitrate: ".concat((i.bitrateTotal/i.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((i.rttTotal/i.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((i.jitterTotal/i.count*1e3).toFixed(2)," ms")),i.packetsLost>0&&this.appendWarning("packets lost: ".concat((i.packetsLost/i.packetsSent*100).toFixed(2),"%")),i.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((i.qualityLimitationDurations.bandwidth/(hr/1e3)*100).toFixed(2),"%")),i.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((i.qualityLimitationDurations.cpu/(hr/1e3)*100).toFixed(2),"%"))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkConnectionProtocol(e){return v(this,void 0,void 0,function*(){yield this.connect(),e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280,t.height=720;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");let r=0;const s=()=>{r=(r+1)%360,i.fillStyle="hsl(".concat(r,", 100%, 50%)"),i.fillRect(0,0,t.width,t.height),requestAnimationFrame(s)};s();const a=t.captureStream(30).getVideoTracks()[0],l=(yield this.room.localParticipant.publishTrack(a,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,u={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},d=setInterval(()=>v(this,void 0,void 0,function*(){const f=yield l.getRTCStatsReport();f?.forEach(p=>{p.type==="outbound-rtp"?(u.packetsSent=p.packetsSent,u.qualityLimitationDurations=p.qualityLimitationDurations,u.bitrateTotal+=p.targetBitrate,u.count++):p.type==="remote-inbound-rtp"&&(u.packetsLost=p.packetsLost,u.rttTotal+=p.roundTripTime,u.jitterTotal+=p.jitter)})}),1e3);return yield new Promise(f=>setTimeout(f,hr)),clearInterval(d),a.stop(),t.remove(),yield this.disconnect(),u})}}class mp extends xt{get description(){return"Can publish audio"}perform(){return v(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield cp();if(yield il(i,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),t.localParticipant.publishTrack(i),yield new Promise(a=>setTimeout(a,3e3));const s=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!s)throw new Error("Could not get RTCStats");let o=0;if(s.forEach(a=>{a.type==="outbound-rtp"&&(a.kind==="audio"||!a.kind&&a.mediaType==="audio")&&(o=a.packetsSent)}),o===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(o," audio packets"))})}}class gp extends xt{get description(){return"Can publish video"}perform(){return v(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield ap();yield this.checkForVideo(i.mediaStreamTrack),t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,5e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="video"||!o.kind&&o.mediaType==="video")&&(s+=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}checkForVideo(e){return v(this,void 0,void 0,function*(){const t=new MediaStream;t.addTrack(e.clone());const i=document.createElement("video");i.srcObject=t,i.muted=!0,i.autoplay=!0,i.playsInline=!0,i.setAttribute("playsinline","true"),document.body.appendChild(i),yield new Promise(r=>{i.onplay=()=>{setTimeout(()=>{var s,o,a,c;const l=document.createElement("canvas"),u=e.getSettings(),d=(o=(s=u.width)!==null&&s!==void 0?s:i.videoWidth)!==null&&o!==void 0?o:1280,f=(c=(a=u.height)!==null&&a!==void 0?a:i.videoHeight)!==null&&c!==void 0?c:720;l.width=d,l.height=f;const p=l.getContext("2d");p.drawImage(i,0,0);const m=p.getImageData(0,0,l.width,l.height).data;let k=!0;for(let b=0;b<m.length;b+=4)if(m[b]!==0||m[b+1]!==0||m[b+2]!==0){k=!1;break}k?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),r()},1e3)},i.play()}),t.getTracks().forEach(r=>r.stop()),i.remove()})}}class vp extends xt{get description(){return"Resuming connection after interruption"}perform(){return v(this,void 0,void 0,function*(){var e;const t=yield this.connect();let i=!1,r=!1,s;const o=new Promise(l=>{setTimeout(l,5e3),s=l}),a=()=>{i=!0};t.on(P.SignalReconnecting,a).on(P.Reconnecting,a).on(P.Reconnected,()=>{r=!0,s(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const c=t.engine.client.onClose;if(c&&c(""),yield o,i){if(!r||t.state!==W.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class bp extends xt{get description(){return"Can connect via TURN"}perform(){return v(this,void 0,void 0,function*(){var e,t;const i=new Ss,r=yield i.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1});let s=!1,o=!1,a=!1;for(let c of r.iceServers)for(let l of c.urls)l.startsWith("turn:")?(o=!0,a=!0):l.startsWith("turns:")&&(o=!0,a=!0,s=!0),l.startsWith("stun:")&&(a=!0);a?o&&!s&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield i.close(),!((t=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||t===void 0)&&t.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(c=>setTimeout(c,0)))})}}class yp extends xt{get description(){return"Establishing WebRTC connection"}perform(){return v(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(P.SignalConnected,()=>{var i;const r=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(s,o)=>{if(s.candidate){const a=new RTCIceCandidate(s);let c="".concat(a.protocol," ").concat(a.address,":").concat(a.port," ").concat(a.type);a.address&&(kp(a.address)?c+=" (private)":a.protocol==="tcp"&&a.tcpType==="passive"?(e=!0,c+=" (passive)"):a.protocol==="udp"&&(t=!0)),this.appendMessage(c)}r&&r(s,o)},!((i=this.room.engine.pcManager)===null||i===void 0)&&i.subscriber&&(this.room.engine.pcManager.subscriber.onIceCandidateError=s=>{s instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(s.errorCode," ").concat(s.errorText," ").concat(s.url))})});try{yield this.connect(),F.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function kp(n){const e=n.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class Sp extends xt{get description(){return"Connecting to signal connection via WebSocket"}perform(){return v(this,void 0,void 0,function*(){var e,t,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new Ss;const s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1});this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===rc.Cloud&&(!((t=s.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region)),yield r.close()})}}class Nb extends et.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=i}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:De.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==De.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return v(this,void 0,void 0,function*(){const t=this.getNextCheckId(),i=new e(this.url,this.token,this.options),r=o=>{this.updateCheck(t,o)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(Sp)})}checkWebRTC(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(yp)})}checkTURN(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(bp)})}checkReconnect(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(vp)})}checkPublishAudio(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(mp)})}checkPublishVideo(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(gp)})}checkConnectionProtocol(){return v(this,void 0,void 0,function*(){const e=yield this.createAndRunCheck(pp);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e})}checkCloudRegion(){return v(this,void 0,void 0,function*(){return this.createAndRunCheck(fp)})}}function q(n,e,t){return(e=Cp(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Tp(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Cp(n){var e=Tp(n,"string");return typeof e=="symbol"?e:e+""}new TextEncoder;new TextDecoder;class be extends Error{constructor(e,t){var i;super(e,t),q(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,(i=Error.captureStackTrace)===null||i===void 0||i.call(Error,this,this.constructor)}}q(be,"code","ERR_JOSE_GENERIC");class Ep extends be{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),q(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),q(this,"claim",void 0),q(this,"reason",void 0),q(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}q(Ep,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class wp extends be{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),q(this,"code","ERR_JWT_EXPIRED"),q(this,"claim",void 0),q(this,"reason",void 0),q(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}q(wp,"code","ERR_JWT_EXPIRED");class Pp extends be{constructor(){super(...arguments),q(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}}q(Pp,"code","ERR_JOSE_ALG_NOT_ALLOWED");class Rp extends be{constructor(){super(...arguments),q(this,"code","ERR_JOSE_NOT_SUPPORTED")}}q(Rp,"code","ERR_JOSE_NOT_SUPPORTED");class _p extends be{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"decryption operation failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),q(this,"code","ERR_JWE_DECRYPTION_FAILED")}}q(_p,"code","ERR_JWE_DECRYPTION_FAILED");class Ip extends be{constructor(){super(...arguments),q(this,"code","ERR_JWE_INVALID")}}q(Ip,"code","ERR_JWE_INVALID");class xp extends be{constructor(){super(...arguments),q(this,"code","ERR_JWS_INVALID")}}q(xp,"code","ERR_JWS_INVALID");class Op extends be{constructor(){super(...arguments),q(this,"code","ERR_JWT_INVALID")}}q(Op,"code","ERR_JWT_INVALID");class Mp extends be{constructor(){super(...arguments),q(this,"code","ERR_JWK_INVALID")}}q(Mp,"code","ERR_JWK_INVALID");class Ap extends be{constructor(){super(...arguments),q(this,"code","ERR_JWKS_INVALID")}}q(Ap,"code","ERR_JWKS_INVALID");class Dp extends be{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"no applicable key found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),q(this,"code","ERR_JWKS_NO_MATCHING_KEY")}}q(Dp,"code","ERR_JWKS_NO_MATCHING_KEY");class Np extends be{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"multiple matching keys found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),q(this,Symbol.asyncIterator,void 0),q(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}}q(Np,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");class Lp extends be{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"request timed out",t=arguments.length>1?arguments[1]:void 0;super(e,t),q(this,"code","ERR_JWKS_TIMEOUT")}}q(Lp,"code","ERR_JWKS_TIMEOUT");class Up extends be{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"signature verification failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),q(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}q(Up,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function Fp(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const i=Nt(n)?n.mediaStreamTrack:n,r=i.getSettings();let s={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const o=r.facingMode;F.trace("rawFacingMode",{rawFacingMode:o}),o&&typeof o=="string"&&Vp(o)&&(s={facingMode:o,confidence:"high"})}if(["low","medium"].includes(s.confidence)){F.trace("Try to get facing mode from device label: (".concat(i.label,")"));const o=Bp(i.label);o!==void 0&&(s=o)}return s}const na=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),jp=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function Bp(n){var e;const t=n.trim().toLowerCase();if(t!=="")return na.has(t)?na.get(t):(e=Array.from(jp.entries()).find(i=>{let[r]=i;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function Vp(n){return n===void 0||["user","environment","left","right"].includes(n)}const ki=Math.min,Lt=Math.max,Si=Math.round,zn=Math.floor,Ye=n=>({x:n,y:n}),qp={left:"right",right:"left",bottom:"top",top:"bottom"},Wp={start:"end",end:"start"};function ia(n,e,t){return Lt(n,ki(e,t))}function Ui(n,e){return typeof n=="function"?n(e):n}function Bt(n){return n.split("-")[0]}function Fi(n){return n.split("-")[1]}function yl(n){return n==="x"?"y":"x"}function kl(n){return n==="y"?"height":"width"}function on(n){return["top","bottom"].includes(Bt(n))?"y":"x"}function Sl(n){return yl(on(n))}function zp(n,e,t){t===void 0&&(t=!1);const i=Fi(n),r=Sl(n),s=kl(r);let o=r==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(o=Ti(o)),[o,Ti(o)]}function Hp(n){const e=Ti(n);return[Gr(n),e,Gr(e)]}function Gr(n){return n.replace(/start|end/g,e=>Wp[e])}function Kp(n,e,t){const i=["left","right"],r=["right","left"],s=["top","bottom"],o=["bottom","top"];switch(n){case"top":case"bottom":return t?e?r:i:e?i:r;case"left":case"right":return e?s:o;default:return[]}}function Gp(n,e,t,i){const r=Fi(n);let s=Kp(Bt(n),t==="start",i);return r&&(s=s.map(o=>o+"-"+r),e&&(s=s.concat(s.map(Gr)))),s}function Ti(n){return n.replace(/left|right|bottom|top/g,e=>qp[e])}function Jp(n){return{top:0,right:0,bottom:0,left:0,...n}}function $p(n){return typeof n!="number"?Jp(n):{top:n,right:n,bottom:n,left:n}}function Ci(n){const{x:e,y:t,width:i,height:r}=n;return{width:i,height:r,top:t,left:e,right:e+i,bottom:t+r,x:e,y:t}}function ra(n,e,t){let{reference:i,floating:r}=n;const s=on(e),o=Sl(e),a=kl(o),c=Bt(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,f=i[a]/2-r[a]/2;let p;switch(c){case"top":p={x:u,y:i.y-r.height};break;case"bottom":p={x:u,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:d};break;case"left":p={x:i.x-r.width,y:d};break;default:p={x:i.x,y:i.y}}switch(Fi(e)){case"start":p[o]-=f*(t&&l?-1:1);break;case"end":p[o]+=f*(t&&l?-1:1);break}return p}const Qp=async(n,e,t)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:o}=t,a=s.filter(Boolean),c=await(o.isRTL==null?void 0:o.isRTL(e));let l=await o.getElementRects({reference:n,floating:e,strategy:r}),{x:u,y:d}=ra(l,i,c),f=i,p={},g=0;for(let m=0;m<a.length;m++){const{name:k,fn:b}=a[m],{x:w,y:R,data:S,reset:y}=await b({x:u,y:d,initialPlacement:i,placement:f,strategy:r,middlewareData:p,rects:l,platform:o,elements:{reference:n,floating:e}});u=w??u,d=R??d,p={...p,[k]:{...p[k],...S}},y&&g<=50&&(g++,typeof y=="object"&&(y.placement&&(f=y.placement),y.rects&&(l=y.rects===!0?await o.getElementRects({reference:n,floating:e,strategy:r}):y.rects),{x:u,y:d}=ra(l,f,c)),m=-1)}return{x:u,y:d,placement:f,strategy:r,middlewareData:p}};async function Tl(n,e){var t;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:o,elements:a,strategy:c}=n,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:f=!1,padding:p=0}=Ui(e,n),g=$p(p),m=a[f?d==="floating"?"reference":"floating":d],k=Ci(await s.getClippingRect({element:(t=await(s.isElement==null?void 0:s.isElement(m)))==null||t?m:m.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(a.floating)),boundary:l,rootBoundary:u,strategy:c})),b=d==="floating"?{x:i,y:r,width:o.floating.width,height:o.floating.height}:o.reference,w=await(s.getOffsetParent==null?void 0:s.getOffsetParent(a.floating)),R=await(s.isElement==null?void 0:s.isElement(w))?await(s.getScale==null?void 0:s.getScale(w))||{x:1,y:1}:{x:1,y:1},S=Ci(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:a,rect:b,offsetParent:w,strategy:c}):b);return{top:(k.top-S.top+g.top)/R.y,bottom:(S.bottom-k.bottom+g.bottom)/R.y,left:(k.left-S.left+g.left)/R.x,right:(S.right-k.right+g.right)/R.x}}const Yp=function(n){return n===void 0&&(n={}),{name:"flip",options:n,async fn(e){var t,i;const{placement:r,middlewareData:s,rects:o,initialPlacement:a,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:f,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:g="none",flipAlignment:m=!0,...k}=Ui(n,e);if((t=s.arrow)!=null&&t.alignmentOffset)return{};const b=Bt(r),w=on(a),R=Bt(a)===a,S=await(c.isRTL==null?void 0:c.isRTL(l.floating)),y=f||(R||!m?[Ti(a)]:Hp(a)),T=g!=="none";!f&&T&&y.push(...Gp(a,m,g,S));const I=[a,...y],D=await Tl(e,k),x=[];let O=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&x.push(D[b]),d){const $=zp(r,o,S);x.push(D[$[0]],D[$[1]])}if(O=[...O,{placement:r,overflows:x}],!x.every($=>$<=0)){var A,U;const $=(((A=s.flip)==null?void 0:A.index)||0)+1,Me=I[$];if(Me)return{data:{index:$,overflows:O},reset:{placement:Me}};let ye=(U=O.filter(Pe=>Pe.overflows[0]<=0).sort((Pe,fe)=>Pe.overflows[1]-fe.overflows[1])[0])==null?void 0:U.placement;if(!ye)switch(p){case"bestFit":{var K;const Pe=(K=O.filter(fe=>{if(T){const ke=on(fe.placement);return ke===w||ke==="y"}return!0}).map(fe=>[fe.placement,fe.overflows.filter(ke=>ke>0).reduce((ke,Ot)=>ke+Ot,0)]).sort((fe,ke)=>fe[1]-ke[1])[0])==null?void 0:K[0];Pe&&(ye=Pe);break}case"initialPlacement":ye=a;break}if(r!==ye)return{reset:{placement:ye}}}return{}}}};async function Xp(n,e){const{placement:t,platform:i,elements:r}=n,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),o=Bt(t),a=Fi(t),c=on(t)==="y",l=["left","top"].includes(o)?-1:1,u=s&&c?-1:1,d=Ui(e,n);let{mainAxis:f,crossAxis:p,alignmentAxis:g}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:d.mainAxis||0,crossAxis:d.crossAxis||0,alignmentAxis:d.alignmentAxis};return a&&typeof g=="number"&&(p=a==="end"?g*-1:g),c?{x:p*u,y:f*l}:{x:f*l,y:p*u}}const Zp=function(n){return n===void 0&&(n=0),{name:"offset",options:n,async fn(e){var t,i;const{x:r,y:s,placement:o,middlewareData:a}=e,c=await Xp(e,n);return o===((t=a.offset)==null?void 0:t.placement)&&(i=a.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:o}}}}},em=function(n){return n===void 0&&(n={}),{name:"shift",options:n,async fn(e){const{x:t,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:o=!1,limiter:a={fn:k=>{let{x:b,y:w}=k;return{x:b,y:w}}},...c}=Ui(n,e),l={x:t,y:i},u=await Tl(e,c),d=on(Bt(r)),f=yl(d);let p=l[f],g=l[d];if(s){const k=f==="y"?"top":"left",b=f==="y"?"bottom":"right",w=p+u[k],R=p-u[b];p=ia(w,p,R)}if(o){const k=d==="y"?"top":"left",b=d==="y"?"bottom":"right",w=g+u[k],R=g-u[b];g=ia(w,g,R)}const m=a.fn({...e,[f]:p,[d]:g});return{...m,data:{x:m.x-t,y:m.y-i,enabled:{[f]:s,[d]:o}}}}}};function ji(){return typeof window<"u"}function un(n){return Cl(n)?(n.nodeName||"").toLowerCase():"#document"}function _e(n){var e;return(n==null||(e=n.ownerDocument)==null?void 0:e.defaultView)||window}function tt(n){var e;return(e=(Cl(n)?n.ownerDocument:n.document)||window.document)==null?void 0:e.documentElement}function Cl(n){return ji()?n instanceof Node||n instanceof _e(n).Node:!1}function Ve(n){return ji()?n instanceof Element||n instanceof _e(n).Element:!1}function Ze(n){return ji()?n instanceof HTMLElement||n instanceof _e(n).HTMLElement:!1}function sa(n){return!ji()||typeof ShadowRoot>"u"?!1:n instanceof ShadowRoot||n instanceof _e(n).ShadowRoot}function Un(n){const{overflow:e,overflowX:t,overflowY:i,display:r}=qe(n);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!["inline","contents"].includes(r)}function tm(n){return["table","td","th"].includes(un(n))}function Bi(n){return[":popover-open",":modal"].some(e=>{try{return n.matches(e)}catch{return!1}})}function Is(n){const e=xs(),t=Ve(n)?qe(n):n;return["transform","translate","scale","rotate","perspective"].some(i=>t[i]?t[i]!=="none":!1)||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||["transform","translate","scale","rotate","perspective","filter"].some(i=>(t.willChange||"").includes(i))||["paint","layout","strict","content"].some(i=>(t.contain||"").includes(i))}function nm(n){let e=_t(n);for(;Ze(e)&&!an(e);){if(Is(e))return e;if(Bi(e))return null;e=_t(e)}return null}function xs(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}function an(n){return["html","body","#document"].includes(un(n))}function qe(n){return _e(n).getComputedStyle(n)}function Vi(n){return Ve(n)?{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}:{scrollLeft:n.scrollX,scrollTop:n.scrollY}}function _t(n){if(un(n)==="html")return n;const e=n.assignedSlot||n.parentNode||sa(n)&&n.host||tt(n);return sa(e)?e.host:e}function El(n){const e=_t(n);return an(e)?n.ownerDocument?n.ownerDocument.body:n.body:Ze(e)&&Un(e)?e:El(e)}function Dn(n,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);const r=El(n),s=r===((i=n.ownerDocument)==null?void 0:i.body),o=_e(r);if(s){const a=Jr(o);return e.concat(o,o.visualViewport||[],Un(r)?r:[],a&&t?Dn(a):[])}return e.concat(r,Dn(r,[],t))}function Jr(n){return n.parent&&Object.getPrototypeOf(n.parent)?n.frameElement:null}function wl(n){const e=qe(n);let t=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=Ze(n),s=r?n.offsetWidth:t,o=r?n.offsetHeight:i,a=Si(t)!==s||Si(i)!==o;return a&&(t=s,i=o),{width:t,height:i,$:a}}function Os(n){return Ve(n)?n:n.contextElement}function nn(n){const e=Os(n);if(!Ze(e))return Ye(1);const t=e.getBoundingClientRect(),{width:i,height:r,$:s}=wl(e);let o=(s?Si(t.width):t.width)/i,a=(s?Si(t.height):t.height)/r;return(!o||!Number.isFinite(o))&&(o=1),(!a||!Number.isFinite(a))&&(a=1),{x:o,y:a}}const im=Ye(0);function Pl(n){const e=_e(n);return!xs()||!e.visualViewport?im:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function rm(n,e,t){return e===void 0&&(e=!1),!t||e&&t!==_e(n)?!1:e}function Vt(n,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);const r=n.getBoundingClientRect(),s=Os(n);let o=Ye(1);e&&(i?Ve(i)&&(o=nn(i)):o=nn(n));const a=rm(s,t,i)?Pl(s):Ye(0);let c=(r.left+a.x)/o.x,l=(r.top+a.y)/o.y,u=r.width/o.x,d=r.height/o.y;if(s){const f=_e(s),p=i&&Ve(i)?_e(i):i;let g=f,m=Jr(g);for(;m&&i&&p!==g;){const k=nn(m),b=m.getBoundingClientRect(),w=qe(m),R=b.left+(m.clientLeft+parseFloat(w.paddingLeft))*k.x,S=b.top+(m.clientTop+parseFloat(w.paddingTop))*k.y;c*=k.x,l*=k.y,u*=k.x,d*=k.y,c+=R,l+=S,g=_e(m),m=Jr(g)}}return Ci({width:u,height:d,x:c,y:l})}function Ms(n,e){const t=Vi(n).scrollLeft;return e?e.left+t:Vt(tt(n)).left+t}function Rl(n,e,t){t===void 0&&(t=!1);const i=n.getBoundingClientRect(),r=i.left+e.scrollLeft-(t?0:Ms(n,i)),s=i.top+e.scrollTop;return{x:r,y:s}}function sm(n){let{elements:e,rect:t,offsetParent:i,strategy:r}=n;const s=r==="fixed",o=tt(i),a=e?Bi(e.floating):!1;if(i===o||a&&s)return t;let c={scrollLeft:0,scrollTop:0},l=Ye(1);const u=Ye(0),d=Ze(i);if((d||!d&&!s)&&((un(i)!=="body"||Un(o))&&(c=Vi(i)),Ze(i))){const p=Vt(i);l=nn(i),u.x=p.x+i.clientLeft,u.y=p.y+i.clientTop}const f=o&&!d&&!s?Rl(o,c,!0):Ye(0);return{width:t.width*l.x,height:t.height*l.y,x:t.x*l.x-c.scrollLeft*l.x+u.x+f.x,y:t.y*l.y-c.scrollTop*l.y+u.y+f.y}}function om(n){return Array.from(n.getClientRects())}function am(n){const e=tt(n),t=Vi(n),i=n.ownerDocument.body,r=Lt(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=Lt(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let o=-t.scrollLeft+Ms(n);const a=-t.scrollTop;return qe(i).direction==="rtl"&&(o+=Lt(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:o,y:a}}function cm(n,e){const t=_e(n),i=tt(n),r=t.visualViewport;let s=i.clientWidth,o=i.clientHeight,a=0,c=0;if(r){s=r.width,o=r.height;const l=xs();(!l||l&&e==="fixed")&&(a=r.offsetLeft,c=r.offsetTop)}return{width:s,height:o,x:a,y:c}}function lm(n,e){const t=Vt(n,!0,e==="fixed"),i=t.top+n.clientTop,r=t.left+n.clientLeft,s=Ze(n)?nn(n):Ye(1),o=n.clientWidth*s.x,a=n.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:o,height:a,x:c,y:l}}function oa(n,e,t){let i;if(e==="viewport")i=cm(n,t);else if(e==="document")i=am(tt(n));else if(Ve(e))i=lm(e,t);else{const r=Pl(n);i={x:e.x-r.x,y:e.y-r.y,width:e.width,height:e.height}}return Ci(i)}function _l(n,e){const t=_t(n);return t===e||!Ve(t)||an(t)?!1:qe(t).position==="fixed"||_l(t,e)}function um(n,e){const t=e.get(n);if(t)return t;let i=Dn(n,[],!1).filter(a=>Ve(a)&&un(a)!=="body"),r=null;const s=qe(n).position==="fixed";let o=s?_t(n):n;for(;Ve(o)&&!an(o);){const a=qe(o),c=Is(o);!c&&a.position==="fixed"&&(r=null),(s?!c&&!r:!c&&a.position==="static"&&r&&["absolute","fixed"].includes(r.position)||Un(o)&&!c&&_l(n,o))?i=i.filter(l=>l!==o):r=a,o=_t(o)}return e.set(n,i),i}function dm(n){let{element:e,boundary:t,rootBoundary:i,strategy:r}=n;const s=[...t==="clippingAncestors"?Bi(e)?[]:um(e,this._c):[].concat(t),i],o=s[0],a=s.reduce((c,l)=>{const u=oa(e,l,r);return c.top=Lt(u.top,c.top),c.right=ki(u.right,c.right),c.bottom=ki(u.bottom,c.bottom),c.left=Lt(u.left,c.left),c},oa(e,o,r));return{width:a.right-a.left,height:a.bottom-a.top,x:a.left,y:a.top}}function hm(n){const{width:e,height:t}=wl(n);return{width:e,height:t}}function fm(n,e,t){const i=Ze(e),r=tt(e),s=t==="fixed",o=Vt(n,!0,s,e);let a={scrollLeft:0,scrollTop:0};const c=Ye(0);if(i||!i&&!s)if((un(e)!=="body"||Un(r))&&(a=Vi(e)),i){const f=Vt(e,!0,s,e);c.x=f.x+e.clientLeft,c.y=f.y+e.clientTop}else r&&(c.x=Ms(r));const l=r&&!i&&!s?Rl(r,a):Ye(0),u=o.left+a.scrollLeft-c.x-l.x,d=o.top+a.scrollTop-c.y-l.y;return{x:u,y:d,width:o.width,height:o.height}}function fr(n){return qe(n).position==="static"}function aa(n,e){if(!Ze(n)||qe(n).position==="fixed")return null;if(e)return e(n);let t=n.offsetParent;return tt(n)===t&&(t=t.ownerDocument.body),t}function Il(n,e){const t=_e(n);if(Bi(n))return t;if(!Ze(n)){let r=_t(n);for(;r&&!an(r);){if(Ve(r)&&!fr(r))return r;r=_t(r)}return t}let i=aa(n,e);for(;i&&tm(i)&&fr(i);)i=aa(i,e);return i&&an(i)&&fr(i)&&!Is(i)?t:i||nm(n)||t}const pm=async function(n){const e=this.getOffsetParent||Il,t=this.getDimensions,i=await t(n.floating);return{reference:fm(n.reference,await e(n.floating),n.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}};function mm(n){return qe(n).direction==="rtl"}const gm={convertOffsetParentRelativeRectToViewportRelativeRect:sm,getDocumentElement:tt,getClippingRect:dm,getOffsetParent:Il,getElementRects:pm,getClientRects:om,getDimensions:hm,getScale:nn,isElement:Ve,isRTL:mm};function xl(n,e){return n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height}function vm(n,e){let t=null,i;const r=tt(n);function s(){var a;clearTimeout(i),(a=t)==null||a.disconnect(),t=null}function o(a,c){a===void 0&&(a=!1),c===void 0&&(c=1),s();const l=n.getBoundingClientRect(),{left:u,top:d,width:f,height:p}=l;if(a||e(),!f||!p)return;const g=zn(d),m=zn(r.clientWidth-(u+f)),k=zn(r.clientHeight-(d+p)),b=zn(u),w={rootMargin:-g+"px "+-m+"px "+-k+"px "+-b+"px",threshold:Lt(0,ki(1,c))||1};let R=!0;function S(y){const T=y[0].intersectionRatio;if(T!==c){if(!R)return o();T?o(!1,T):i=setTimeout(()=>{o(!1,1e-7)},1e3)}T===1&&!xl(l,n.getBoundingClientRect())&&o(),R=!1}try{t=new IntersectionObserver(S,{...w,root:r.ownerDocument})}catch{t=new IntersectionObserver(S,w)}t.observe(n)}return o(!0),s}function bm(n,e,t,i){i===void 0&&(i={});const{ancestorScroll:r=!0,ancestorResize:s=!0,elementResize:o=typeof ResizeObserver=="function",layoutShift:a=typeof IntersectionObserver=="function",animationFrame:c=!1}=i,l=Os(n),u=r||s?[...l?Dn(l):[],...Dn(e)]:[];u.forEach(b=>{r&&b.addEventListener("scroll",t,{passive:!0}),s&&b.addEventListener("resize",t)});const d=l&&a?vm(l,t):null;let f=-1,p=null;o&&(p=new ResizeObserver(b=>{let[w]=b;w&&w.target===l&&p&&(p.unobserve(e),cancelAnimationFrame(f),f=requestAnimationFrame(()=>{var R;(R=p)==null||R.observe(e)})),t()}),l&&!c&&p.observe(l),p.observe(e));let g,m=c?Vt(n):null;c&&k();function k(){const b=Vt(n);m&&!xl(m,b)&&t(),m=b,g=requestAnimationFrame(k)}return t(),()=>{var b;u.forEach(w=>{r&&w.removeEventListener("scroll",t),s&&w.removeEventListener("resize",t)}),d?.(),(b=p)==null||b.disconnect(),p=null,c&&cancelAnimationFrame(g)}}const ym=Zp,km=em,Sm=Yp,Tm=(n,e,t)=>{const i=new Map,r={platform:gm,...t},s={...r.platform,_c:i};return Qp(n,e,{...r,platform:s})};var Hn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ol(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var $r={exports:{}},Cm=$r.exports,ca;function Em(){return ca||(ca=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(Cm,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,k){var b=m[k];if(typeof b.bind=="function")return b.bind(m);try{return Function.prototype.bind.call(b,m)}catch{return function(){return Function.prototype.apply.apply(b,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),k=0;k<r.length;k++){var b=r[k];this[b]=k<m?e:this.methodFactory(b,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function f(m,k,b){return l(m)||d.apply(this,arguments)}function p(m,k){var b=this,w,R,S,y="loglevel";typeof m=="string"?y+=":"+m:typeof m=="symbol"&&(y=void 0);function T(A){var U=(r[A]||"silent").toUpperCase();if(!(typeof window===t||!y)){try{window.localStorage[y]=U;return}catch{}try{window.document.cookie=encodeURIComponent(y)+"="+U+";"}catch{}}}function I(){var A;if(!(typeof window===t||!y)){try{A=window.localStorage[y]}catch{}if(typeof A===t)try{var U=window.document.cookie,K=encodeURIComponent(y),$=U.indexOf(K+"=");$!==-1&&(A=/^([^;]+)/.exec(U.slice($+K.length+1))[1])}catch{}return b.levels[A]===void 0&&(A=void 0),A}}function D(){if(!(typeof window===t||!y)){try{window.localStorage.removeItem(y)}catch{}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function x(A){var U=A;if(typeof U=="string"&&b.levels[U.toUpperCase()]!==void 0&&(U=b.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=b.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+A)}b.name=m,b.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},b.methodFactory=k||f,b.getLevel=function(){return S??R??w},b.setLevel=function(A,U){return S=x(A),U!==!1&&T(S),u.call(b)},b.setDefaultLevel=function(A){R=x(A),I()||b.setLevel(A,!1)},b.resetLevel=function(){S=null,D(),u.call(b)},b.enableAll=function(A){b.setLevel(b.levels.TRACE,A)},b.disableAll=function(A){b.setLevel(b.levels.SILENT,A)},b.rebuild=function(){if(o!==b&&(w=x(o.getLevel())),u.call(b),o===b)for(var A in s)s[A].rebuild()},w=x(o?o.getLevel():"WARN");var O=I();O!=null&&(S=x(O)),u.call(b)}o=new p,o.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var k=s[m];return k||(k=s[m]=new p(m,o.methodFactory)),k};var g=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=g),o},o.getLoggers=function(){return s},o.default=o,o})})($r)),$r.exports}var wm=Em();const Pm=Ol(wm);var Qr=function(n,e){return Qr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},Qr(n,e)};function ht(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Qr(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Rm(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,[])).next())})}function Ml(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,o=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(t=0)),t;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,r=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function cn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ln(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,s=[],o;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return s}function Nn(n,e,t){if(arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return n.concat(s||Array.prototype.slice.call(e))}function rn(n){return this instanceof rn?(this.v=n,this):new rn(n)}function _m(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(p){return function(g){return Promise.resolve(g).then(p,d)}}function a(p,g){i[p]&&(r[p]=function(m){return new Promise(function(k,b){s.push([p,m,k,b])>1||c(p,m)})},g&&(r[p]=g(r[p])))}function c(p,g){try{l(i[p](g))}catch(m){f(s[0][3],m)}}function l(p){p.value instanceof rn?Promise.resolve(p.value.v).then(u,d):f(s[0][2],p)}function u(p){c("next",p)}function d(p){c("throw",p)}function f(p,g){p(g),s.shift(),s.length&&c(s[0][0],s[0][1])}}function Im(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof cn=="function"?cn(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}function J(n){return typeof n=="function"}function As(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var pr=As(function(n){return function(e){n(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,i){return i+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Ei(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var Fn=(function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return n.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=cn(o),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var u=this.initialTeardown;if(J(u))try{u()}catch(m){s=m instanceof pr?m.errors:[m]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var f=cn(d),p=f.next();!p.done;p=f.next()){var g=p.value;try{la(g)}catch(m){s=s??[],m instanceof pr?s=Nn(Nn([],ln(s)),ln(m.errors)):s.push(m)}}}catch(m){i={error:m}}finally{try{p&&!p.done&&(r=f.return)&&r.call(f)}finally{if(i)throw i.error}}}if(s)throw new pr(s)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)la(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ei(t,e)},n.prototype.remove=function(e){var t=this._finalizers;t&&Ei(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=(function(){var e=new n;return e.closed=!0,e})(),n})(),Al=Fn.EMPTY;function Dl(n){return n instanceof Fn||n&&"closed"in n&&J(n.remove)&&J(n.add)&&J(n.unsubscribe)}function la(n){J(n)?n():n.unsubscribe()}var xm={Promise:void 0},Om={setTimeout:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setTimeout.apply(void 0,Nn([n,e],ln(t)))},clearTimeout:function(n){return clearTimeout(n)},delegate:void 0};function Nl(n){Om.setTimeout(function(){throw n})}function wi(){}function ai(n){n()}var Ds=(function(n){ht(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,Dl(t)&&t.add(i)):i.destination=Dm,i}return e.create=function(t,i,r){return new Yr(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Fn),Mm=(function(){function n(e){this.partialObserver=e}return n.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){Kn(i)}},n.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){Kn(i)}else Kn(e)},n.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Kn(t)}},n})(),Yr=(function(n){ht(e,n);function e(t,i,r){var s=n.call(this)||this,o;return J(t)||!t?o={next:t??void 0,error:i??void 0,complete:r??void 0}:o=t,s.destination=new Mm(o),s}return e})(Ds);function Kn(n){Nl(n)}function Am(n){throw n}var Dm={closed:!0,next:wi,error:Am,complete:wi},Ns=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ls(n){return n}function Nm(n){return n.length===0?Ls:n.length===1?n[0]:function(e){return n.reduce(function(t,i){return i(t)},e)}}var ce=(function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,s=Um(e)?e:new Yr(e,t,i);return ai(function(){var o=r,a=o.operator,c=o.source;s.add(a?a.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=ua(t),new t(function(r,s){var o=new Yr({next:function(a){try{e(a)}catch(c){s(c),o.unsubscribe()}},error:s,complete:r});i.subscribe(o)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[Ns]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Nm(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=ua(e),new e(function(i,r){var s;t.subscribe(function(o){return s=o},function(o){return r(o)},function(){return i(s)})})},n.create=function(e){return new n(e)},n})();function ua(n){var e;return(e=n??xm.Promise)!==null&&e!==void 0?e:Promise}function Lm(n){return n&&J(n.next)&&J(n.error)&&J(n.complete)}function Um(n){return n&&n instanceof Ds||Lm(n)&&Dl(n)}function Fm(n){return J(n?.lift)}function He(n){return function(e){if(Fm(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function We(n,e,t,i,r){return new jm(n,e,t,i,r)}var jm=(function(n){ht(e,n);function e(t,i,r,s,o,a){var c=n.call(this,t)||this;return c.onFinalize=o,c.shouldUnsubscribe=a,c._next=i?function(l){try{i(l)}catch(u){t.error(u)}}:n.prototype._next,c._error=s?function(l){try{s(l)}catch(u){t.error(u)}finally{this.unsubscribe()}}:n.prototype._error,c._complete=r?function(){try{r()}catch(l){t.error(l)}finally{this.unsubscribe()}}:n.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e})(Ds),Bm=As(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),qt=(function(n){ht(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new da(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new Bm},e.prototype.next=function(t){var i=this;ai(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var o=cn(i.currentObservers),a=o.next();!a.done;a=o.next()){var c=a.value;c.next(t)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;ai(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;ai(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=this,s=r.hasError,o=r.isStopped,a=r.observers;return s||o?Al:(this.currentObservers=null,a.push(t),new Fn(function(){i.currentObservers=null,Ei(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,s=i.thrownError,o=i.isStopped;r?t.error(s):o&&t.complete()},e.prototype.asObservable=function(){var t=new ce;return t.source=this,t},e.create=function(t,i){return new da(t,i)},e})(ce),da=(function(n){ht(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:Al},e})(qt),Ll=(function(n){ht(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,s=t._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e})(qt),Vm={now:function(){return Date.now()}},qm=(function(n){ht(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e})(Fn),ha={setInterval:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setInterval.apply(void 0,Nn([n,e],ln(t)))},clearInterval:function(n){return clearInterval(n)},delegate:void 0},Wm=(function(n){ht(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=t;var s=this.id,o=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(o,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(o,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),ha.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&ha.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,s;try{this.work(t)}catch(o){r=!0,s=o||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Ei(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e})(qm),fa=(function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=Vm.now,n})(),zm=(function(n){ht(e,n);function e(t,i){i===void 0&&(i=fa.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e})(fa),Hm=new zm(Wm);function Km(n){return n&&J(n.schedule)}function Gm(n){return n[n.length-1]}function Us(n){return Km(Gm(n))?n.pop():void 0}var Fs=(function(n){return n&&typeof n.length=="number"&&typeof n!="function"});function Ul(n){return J(n?.then)}function Fl(n){return J(n[Ns])}function jl(n){return Symbol.asyncIterator&&J(n?.[Symbol.asyncIterator])}function Bl(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Jm(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Vl=Jm();function ql(n){return J(n?.[Vl])}function Wl(n){return _m(this,arguments,function(){var e,t,i,r;return Ml(this,function(s){switch(s.label){case 0:e=n.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,rn(e.read())];case 3:return t=s.sent(),i=t.value,r=t.done,r?[4,rn(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,rn(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function zl(n){return J(n?.getReader)}function ft(n){if(n instanceof ce)return n;if(n!=null){if(Fl(n))return $m(n);if(Fs(n))return Qm(n);if(Ul(n))return Ym(n);if(jl(n))return Hl(n);if(ql(n))return Xm(n);if(zl(n))return Zm(n)}throw Bl(n)}function $m(n){return new ce(function(e){var t=n[Ns]();if(J(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Qm(n){return new ce(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function Ym(n){return new ce(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Nl)})}function Xm(n){return new ce(function(e){var t,i;try{for(var r=cn(n),s=r.next();!s.done;s=r.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(a){t={error:a}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function Hl(n){return new ce(function(e){eg(n,e).catch(function(t){return e.error(t)})})}function Zm(n){return Hl(Wl(n))}function eg(n,e){var t,i,r,s;return Rm(this,void 0,void 0,function(){var o,a;return Ml(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=Im(n),c.label=1;case 1:return[4,t.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(o=i.value,e.next(o),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),r={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=t.return)?[4,s.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function wt(n,e,t,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function Kl(n,e){return e===void 0&&(e=0),He(function(t,i){t.subscribe(We(i,function(r){return wt(i,n,function(){return i.next(r)},e)},function(){return wt(i,n,function(){return i.complete()},e)},function(r){return wt(i,n,function(){return i.error(r)},e)}))})}function Gl(n,e){return e===void 0&&(e=0),He(function(t,i){i.add(n.schedule(function(){return t.subscribe(i)},e))})}function tg(n,e){return ft(n).pipe(Gl(e),Kl(e))}function ng(n,e){return ft(n).pipe(Gl(e),Kl(e))}function ig(n,e){return new ce(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function rg(n,e){return new ce(function(t){var i;return wt(t,e,function(){i=n[Vl](),wt(t,e,function(){var r,s,o;try{r=i.next(),s=r.value,o=r.done}catch(a){t.error(a);return}o?t.complete():t.next(s)},0,!0)}),function(){return J(i?.return)&&i.return()}})}function Jl(n,e){if(!n)throw new Error("Iterable cannot be null");return new ce(function(t){wt(t,e,function(){var i=n[Symbol.asyncIterator]();wt(t,e,function(){i.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function sg(n,e){return Jl(Wl(n),e)}function og(n,e){if(n!=null){if(Fl(n))return tg(n,e);if(Fs(n))return ig(n,e);if(Ul(n))return ng(n,e);if(jl(n))return Jl(n,e);if(ql(n))return rg(n,e);if(zl(n))return sg(n,e)}throw Bl(n)}function js(n,e){return e?og(n,e):ft(n)}function pa(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Us(n);return js(n,t)}function ag(n){return n instanceof Date&&!isNaN(n)}var cg=As(function(n){return function(e){e===void 0&&(e=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function lg(n,e){var t=ag(n)?{first:n}:typeof n=="number"?{each:n}:n,i=t.first,r=t.each,s=t.with,o=s===void 0?ug:s,a=t.scheduler,c=a===void 0?Hm:a,l=t.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return He(function(d,f){var p,g,m=null,k=0,b=function(w){g=wt(f,c,function(){try{p.unsubscribe(),ft(o({meta:u,lastValue:m,seen:k})).subscribe(f)}catch(R){f.error(R)}},w)};p=d.subscribe(We(f,function(w){g?.unsubscribe(),k++,f.next(m=w),r>0&&b(r)},void 0,void 0,function(){g!=null&&g.closed||g==null||g.unsubscribe(),m=null})),!k&&b(i!=null?typeof i=="number"?i:+i-c.now():r)})}function ug(n){throw new cg(n)}function ie(n,e){return He(function(t,i){var r=0;t.subscribe(We(i,function(s){i.next(n.call(e,s,r++))}))})}var dg=Array.isArray;function hg(n,e){return dg(e)?n.apply(void 0,Nn([],ln(e))):n(e)}function fg(n){return ie(function(e){return hg(n,e)})}function pg(n,e,t,i,r,s,o,a){var c=[],l=0,u=0,d=!1,f=function(){d&&!c.length&&!l&&e.complete()},p=function(m){return l<i?g(m):c.push(m)},g=function(m){l++;var k=!1;ft(t(m,u++)).subscribe(We(e,function(b){e.next(b)},function(){k=!0},void 0,function(){if(k)try{l--;for(var b=function(){var w=c.shift();o||g(w)};c.length&&l<i;)b();f()}catch(w){e.error(w)}}))};return n.subscribe(We(e,p,function(){d=!0,f()})),function(){}}function Bs(n,e,t){return t===void 0&&(t=1/0),J(e)?Bs(function(i,r){return ie(function(s,o){return e(i,s,r,o)})(ft(n(i,r)))},t):(typeof e=="number"&&(t=e),He(function(i,r){return pg(i,r,n,t)}))}function mg(n){return Bs(Ls,n)}function gg(){return mg(1)}function Pi(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return gg()(js(n,Us(n)))}var vg=["addListener","removeListener"],bg=["addEventListener","removeEventListener"],yg=["on","off"];function Xr(n,e,t,i){if(J(t)&&(i=t,t=void 0),i)return Xr(n,e,t).pipe(fg(i));var r=ln(Tg(n)?bg.map(function(a){return function(c){return n[a](e,c,t)}}):kg(n)?vg.map(ma(n,e)):Sg(n)?yg.map(ma(n,e)):[],2),s=r[0],o=r[1];if(!s&&Fs(n))return Bs(function(a){return Xr(a,e,t)})(ft(n));if(!s)throw new TypeError("Invalid event target");return new ce(function(a){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return a.next(1<l.length?l:l[0])};return s(c),function(){return o(c)}})}function ma(n,e){return function(t){return function(i){return n[t](e,i)}}}function kg(n){return J(n.addListener)&&J(n.removeListener)}function Sg(n){return J(n.on)&&J(n.off)}function Tg(n){return J(n.addEventListener)&&J(n.removeEventListener)}function qi(n,e){return He(function(t,i){var r=0;t.subscribe(We(i,function(s){return n.call(e,s,r++)&&i.next(s)}))})}function Cg(n,e,t,i,r){return function(s,o){var a=t,c=e,l=0;s.subscribe(We(o,function(u){var d=l++;c=a?n(c,u,d):(a=!0,u),o.next(c)},r))}}function Eg(n,e){return e===void 0&&(e=Ls),n=n??wg,He(function(t,i){var r,s=!0;t.subscribe(We(i,function(o){var a=e(o);(s||!n(r,a))&&(s=!1,r=a,i.next(o))}))})}function wg(n,e){return n===e}function ga(n,e){return He(Cg(n,e,arguments.length>=2,!0))}function Pg(n){return He(function(e,t){var i=!1,r=We(t,function(){r?.unsubscribe(),i=!0},wi);ft(n).subscribe(r),e.subscribe(We(t,function(s){return i&&t.next(s)}))})}function Ke(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Us(n);return He(function(i,r){(t?Pi(n,i,t):Pi(n,i)).subscribe(r)})}function va(n){return He(function(e,t){ft(n).subscribe(We(t,function(){return t.complete()},wi)),!t.closed&&e.subscribe(t)})}var Rg=Object.defineProperty,_g=Object.defineProperties,Ig=Object.getOwnPropertyDescriptors,ba=Object.getOwnPropertySymbols,xg=Object.prototype.hasOwnProperty,Og=Object.prototype.propertyIsEnumerable,ya=(n,e,t)=>e in n?Rg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,kt=(n,e)=>{for(var t in e||(e={}))xg.call(e,t)&&ya(n,t,e[t]);if(ba)for(var t of ba(e))Og.call(e,t)&&ya(n,t,e[t]);return n},kn=(n,e)=>_g(n,Ig(e)),ze=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{a(t.next(c))}catch(l){r(l)}},o=c=>{try{a(t.throw(c))}catch(l){r(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(n,e)).next())}),$l="lk";function ae(n){return typeof n>"u"?!1:Mg(n)||Ag(n)}function Mg(n){var e;return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("track")&&typeof((e=n.publication)==null?void 0:e.track)<"u":!1}function Ag(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("publication")&&typeof n.publication<"u":!1}function Ln(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&typeof n.publication>"u":!1}function de(n){if(typeof n=="string"||typeof n=="number")return`${n}`;if(Ln(n))return`${n.participant.identity}_${n.source}_placeholder`;if(ae(n))return`${n.participant.identity}_${n.publication.source}_${n.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${n}`)}function Dg(n,e){return n===void 0||e===void 0?!1:ae(n)&&ae(e)?n.publication.trackSid===e.publication.trackSid:de(n)===de(e)}function Ql(n,e){return typeof e>"u"?!1:ae(n)?e.some(t=>t.participant.identity===n.participant.identity&&ae(t)&&t.publication.trackSid===n.publication.trackSid):Ln(n)?e.some(t=>t.participant.identity===n.participant.identity&&Ln(t)&&t.source===n.source):!1}function Ng(n,e){return Ln(n)&&ae(e)&&e.participant.identity===n.participant.identity&&e.source===n.source}function Lg(){const n=document.createElement("p");n.style.width="100%",n.style.height="200px";const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(n),document.body.appendChild(e);const t=n.offsetWidth;e.style.overflow="scroll";let i=n.offsetWidth;return t===i&&(i=e.clientWidth),document.body.removeChild(e),t-i}function Ug(){return typeof document<"u"}function Fg(n,e,t){return bm(n,e,()=>ze(this,null,function*(){const{x:i,y:r}=yield Tm(n,e,{placement:"top",middleware:[ym(6),Sm(),km({padding:5})]});t?.(i,r)}))}function jg(n,e){return!n.contains(e.target)}var Bg=[P.ConnectionStateChanged,P.RoomMetadataChanged,P.ActiveSpeakersChanged,P.ConnectionQualityChanged,P.ParticipantConnected,P.ParticipantDisconnected,P.ParticipantPermissionsChanged,P.ParticipantMetadataChanged,P.ParticipantNameChanged,P.ParticipantAttributesChanged,P.TrackMuted,P.TrackUnmuted,P.TrackPublished,P.TrackUnpublished,P.TrackStreamStateChanged,P.TrackSubscriptionFailed,P.TrackSubscriptionPermissionChanged,P.TrackSubscriptionStatusChanged],Vg=[...Bg,P.LocalTrackPublished,P.LocalTrackUnpublished];_.TrackPublished,_.TrackUnpublished,_.TrackMuted,_.TrackUnmuted,_.TrackStreamStateChanged,_.TrackSubscribed,_.TrackUnsubscribed,_.TrackSubscriptionPermissionChanged,_.TrackSubscriptionFailed,_.LocalTrackPublished,_.LocalTrackUnpublished;var qg=[_.ConnectionQualityChanged,_.IsSpeakingChanged,_.ParticipantMetadataChanged,_.ParticipantPermissionsChanged,_.TrackMuted,_.TrackUnmuted,_.TrackPublished,_.TrackUnpublished,_.TrackStreamStateChanged,_.TrackSubscriptionFailed,_.TrackSubscriptionPermissionChanged,_.TrackSubscriptionStatusChanged];[...qg,_.LocalTrackPublished,_.LocalTrackUnpublished];var j=Pm.getLogger("lk-components-js");j.setDefaultLevel("WARN");var Wg=[{columns:1,rows:1},{columns:1,rows:2,orientation:"portrait"},{columns:2,rows:1,orientation:"landscape"},{columns:2,rows:2,minWidth:560},{columns:3,rows:3,minWidth:700},{columns:4,rows:4,minWidth:960},{columns:5,rows:5,minWidth:1100}];function Yl(n,e,t,i){if(n.length<1)throw new Error("At least one grid layout definition must be provided.");const r=zg(n);if(t<=0||i<=0)return r[0];let s=0;const o=t/i>1?"landscape":"portrait";let a=r.find((c,l,u)=>{s=l;const d=u.findIndex((f,p)=>{const g=!f.orientation||f.orientation===o,m=p>l,k=f.maxTiles===c.maxTiles;return m&&k&&g})!==-1;return c.maxTiles>=e&&!d});if(a===void 0)if(a=r[r.length-1],a)j.warn(`No layout found for: participantCount: ${e}, width/height: ${t}/${i} fallback to biggest available layout (${a}).`);else throw new Error("No layout or fallback layout found.");if((t<a.minWidth||i<a.minHeight)&&s>0){const c=r[s-1];a=Yl(r.slice(0,s),c.maxTiles,t,i)}return a}function zg(n){return[...n].map(e=>{var t,i;return{name:`${e.columns}x${e.rows}`,columns:e.columns,rows:e.rows,maxTiles:e.columns*e.rows,minWidth:(t=e.minWidth)!=null?t:0,minHeight:(i=e.minHeight)!=null?i:0,orientation:e.orientation}}).sort((e,t)=>e.maxTiles!==t.maxTiles?e.maxTiles-t.maxTiles:e.minWidth!==0||t.minWidth!==0?e.minWidth-t.minWidth:e.minHeight!==0||t.minHeight!==0?e.minHeight-t.minHeight:0)}function Hg(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}var Xl=[],Zl={showChat:!1,unreadMessages:0,showSettings:!1};function eu(n){return typeof n=="object"}function tu(n){return Array.isArray(n)&&n.filter(eu).length>0}function Kg(n,e){return e.audioLevel-n.audioLevel}function Gg(n,e){return n.isSpeaking===e.isSpeaking?0:n.isSpeaking?-1:1}function Jg(n,e){var t,i,r,s;return n.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(t=e.lastSpokeAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=n.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function Zr(n,e){var t,i,r,s;return((i=(t=n.joinedAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function $g(n,e){return ae(n)?ae(e)?0:-1:ae(e)?1:0}function Qg(n,e){const t=n.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return t!==i?t?-1:1:0}function Yg(n){const e=[],t=[],i=[],r=[];n.forEach(a=>{a.participant.isLocal&&a.source===C.Source.Camera?e.push(a):a.source===C.Source.ScreenShare?t.push(a):a.source===C.Source.Camera?i.push(a):r.push(a)});const s=Xg(t),o=Zg(i);return[...e,...s,...o,...r]}function Xg(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),e.sort((i,r)=>Zr(i.participant,r.participant)),t.sort((i,r)=>Zr(i.participant,r.participant)),[...t,...e]}function Zg(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),t.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?Kg(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?Gg(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?Jg(i.participant,r.participant):ae(i)!==ae(r)?$g(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?Qg(i,r):Zr(i.participant,r.participant)),[...e,...t]}function ev(n,e){return n.reduce((t,i,r)=>r%e===0?[...t,[i]]:[...t.slice(0,-1),[...t.slice(-1)[0],i]],[])}function ka(n,e){const t=Math.max(n.length,e.length);return new Array(t).fill([]).map((i,r)=>[n[r],e[r]])}function Ri(n,e,t){return n.filter(i=>!e.map(r=>t(r)).includes(t(i)))}function es(n){return n.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:de(e))}function tv(n,e){return{dropped:Ri(n,e,de),added:Ri(e,n,de)}}function nv(n){return n.added.length!==0||n.dropped.length!==0}function ts(n,e){const t=e.findIndex(i=>de(i)===de(n));if(t===-1)throw new Error(`Element not part of the array: ${de(n)} not in ${es(e)}`);return t}function iv(n,e,t){const i=ts(n,t),r=ts(e,t);return t.splice(i,1,e),t.splice(r,1,n),t}function rv(n,e){const t=ts(n,e);return e.splice(t,1),e}function sv(n,e){return[...e,n]}function mr(n,e){return ev(n,e)}function ov(n,e,t){let i=av(n,e);if(i.length<e.length){const o=Ri(e,i,de);i=[...i,...o]}const r=mr(i,t),s=mr(e,t);if(ka(r,s).forEach(([o,a],c)=>{if(o&&a){const l=mr(i,t)[c],u=tv(l,a);nv(u)&&(j.debug(`Detected visual changes on page: ${c}, current: ${es(o)}, next: ${es(a)}`,{changes:u}),u.added.length===u.dropped.length&&ka(u.added,u.dropped).forEach(([d,f])=>{if(d&&f)i=iv(d,f,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${f}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=rv(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=sv(d,i)}))}}),i.length>e.length){const o=Ri(i,e,de);i=i.filter(a=>!o.map(de).includes(de(a)))}return i}function av(n,e){return n.map(t=>e.find(r=>de(t)===de(r)||typeof t!="number"&&Ln(t)&&ae(r)&&Ng(t,r))??t)}function Ee(n){return`${$l}-${n}`}function cv(n){const e=ns(n),t=Ws(n.participant).pipe(ie(()=>ns(n)),Ke(e));return{className:Ee(n.source===C.Source.Camera||n.source===C.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function ns(n){if(ae(n))return n.publication;{const{source:e,name:t,participant:i}=n;if(e&&t)return i.getTrackPublications().find(r=>r.source===e&&r.trackName===t);if(t)return i.getTrackPublicationByName(t);if(e)return i.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function Vs(n,...e){return new ce(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(Ke(n))}function Wi(n,e){return new ce(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function lv(n){return Wi(n,P.ConnectionStateChanged).pipe(ie(([e])=>e),Ke(n.state))}function uv(n,e,t=!0){const i=new ce(s=>{ut.getLocalDevices(n,t).then(o=>{s.next(o),s.complete()}).catch(o=>{e?.(o),s.next([]),s.complete()})}),r=new ce(s=>{var o;const a=()=>ze(this,null,function*(){try{const c=yield ut.getLocalDevices(n,t);s.next(c)}catch(c){e?.(c)}});if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(o=navigator?.mediaDevices)==null||o.addEventListener("devicechange",a)}return()=>{var c;(c=navigator?.mediaDevices)==null||c.removeEventListener("devicechange",a)}});return Pi(i,r)}function dv(n){return Wi(n,P.DataReceived)}function hv(n){return Vs(n,P.AudioPlaybackStatusChanged).pipe(ie(e=>({canPlayAudio:e.canPlaybackAudio})))}function fv(n){return Vs(n,P.VideoPlaybackStatusChanged).pipe(ie(e=>({canPlayVideo:e.canPlaybackVideo})))}function pv(n,e){return Wi(n,P.ActiveDeviceChanged).pipe(qi(([t])=>t===e),ie(([t,i])=>(j.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:t,deviceId:i}),i)))}function mv(n,e){return Wi(n,P.ParticipantEncryptionStatusChanged).pipe(qi(([,t])=>e?.identity===t?.identity||!t&&e?.identity===n.localParticipant.identity),ie(([t])=>t),Ke(e!=null&&e.isLocal?e.isE2EEEnabled:!!(e!=null&&e.isEncrypted)))}function qs(n,...e){return new ce(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(Ke(n))}function Ws(n){return qs(n,_.TrackMuted,_.TrackUnmuted,_.ParticipantPermissionsChanged,_.TrackPublished,_.TrackUnpublished,_.LocalTrackPublished,_.LocalTrackUnpublished,_.MediaDevicesError,_.TrackSubscriptionStatusChanged).pipe(ie(e=>{const{isMicrophoneEnabled:t,isCameraEnabled:i,isScreenShareEnabled:r}=e,s=e.getTrackPublication(C.Source.Microphone),o=e.getTrackPublication(C.Source.Camera);return{isCameraEnabled:i,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:o,microphoneTrack:s,participant:e}}))}function gv(n){return n?qs(n,_.ParticipantMetadataChanged,_.ParticipantNameChanged).pipe(ie(({name:e,identity:t,metadata:i})=>({name:e,identity:t,metadata:i})),Ke({name:n.name,identity:n.identity,metadata:n.metadata})):void 0}function vv(n){return zs(n,_.ConnectionQualityChanged).pipe(ie(([e])=>e),Ke(n.connectionQuality))}function zs(n,e){return new ce(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function nu(n){var e,t,i,r;return qs(n.participant,_.TrackMuted,_.TrackUnmuted,_.TrackSubscribed,_.TrackUnsubscribed,_.LocalTrackPublished,_.LocalTrackUnpublished).pipe(ie(s=>{var o,a;const c=(o=n.publication)!=null?o:s.getTrackPublication(n.source);return(a=c?.isMuted)!=null?a:!0}),Ke((r=(i=(e=n.publication)==null?void 0:e.isMuted)!=null?i:(t=n.participant.getTrackPublication(n.source))==null?void 0:t.isMuted)!=null?r:!0))}function bv(n){return zs(n,_.IsSpeakingChanged).pipe(ie(([e])=>e))}function yv(n){return zs(n,_.ParticipantPermissionsChanged).pipe(ie(()=>n.permissions),Ke(n.permissions))}function kv(n,e,t,i,r){const{localParticipant:s}=e,o=(u,d)=>{let f=!1;switch(u){case C.Source.Camera:f=d.isCameraEnabled;break;case C.Source.Microphone:f=d.isMicrophoneEnabled;break;case C.Source.ScreenShare:f=d.isScreenShareEnabled;break}return f},a=Ws(s).pipe(ie(u=>o(n,u.participant)),Ke(o(n,s))),c=new qt,l=(u,d)=>ze(this,null,function*(){try{switch(d??(d=t),c.next(!0),n){case C.Source.Camera:return yield s.setCameraEnabled(u??!s.isCameraEnabled,d,i),s.isCameraEnabled;case C.Source.Microphone:return yield s.setMicrophoneEnabled(u??!s.isMicrophoneEnabled,d,i),s.isMicrophoneEnabled;case C.Source.ScreenShare:return yield s.setScreenShareEnabled(u??!s.isScreenShareEnabled,d,i),s.isScreenShareEnabled;default:throw new TypeError("Tried to toggle unsupported source")}}catch(f){if(r&&f instanceof Error){r?.(f);return}else throw f}finally{c.next(!1)}});return{className:Ee("button"),toggle:l,enabledObserver:a,pendingObserver:c.asObservable()}}function Sv(){let n=!1;const e=new qt,t=new qt,i=r=>ze(this,null,function*(){t.next(!0),n=r??!n,e.next(n),t.next(!1)});return{className:Ee("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:t.asObservable()}}function Tv(n,e,t){const i=new Ll(void 0),r=pv(e,n),s=(o,...a)=>ze(this,[o,...a],function*(c,l={}){var u,d,f;if(e){const p=ge();if(n==="audiooutput"&&(p?.name==="Safari"||p?.os==="iOS")){j.warn("Switching audio output device is not supported on Safari and iOS.");return}j.debug(`Switching active device of kind "${n}" with id ${c}.`),yield e.switchActiveDevice(n,c,l.exact);const g=(u=e.getActiveDevice(n))!=null?u:c;g!==c&&c!=="default"&&j.info(`We tried to select the device with id (${c}), but the browser decided to select the device with id (${g}) instead.`);let m;n==="audioinput"?m=(d=e.localParticipant.getTrackPublication(C.Source.Microphone))==null?void 0:d.track:n==="videoinput"&&(m=(f=e.localParticipant.getTrackPublication(C.Source.Camera))==null?void 0:f.track);const k=c==="default"&&!m||c==="default"&&m?.mediaStreamTrack.label.startsWith("Default");i.next(k?c:g)}});return{className:Ee("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function Cv(n){const e=t=>{n.disconnect(t)};return{className:Ee("disconnect-button"),disconnect:e}}function Ev(n){const e=Ee("connection-quality"),t=vv(n);return{className:e,connectionQualityObserver:t}}function wv(n){let e="track-muted-indicator-camera";switch(n.source){case C.Source.Camera:e="track-muted-indicator-camera";break;case C.Source.Microphone:e="track-muted-indicator-microphone";break}const t=Ee(e),i=nu(n);return{className:t,mediaMutedObserver:i}}function Pv(n){return{className:"lk-participant-name",infoObserver:gv(n)}}function Rv(){return{className:Ee("participant-tile")}}var _v={CHAT:"lk.chat"},Iv={CHAT:"lk-chat-topic"};function iu(n,e){return ze(this,arguments,function*(t,i,r={}){const{reliable:s,destinationIdentities:o,topic:a}=r;yield t.publishData(i,{destinationIdentities:o,topic:a,reliable:s})})}function xv(n,e,t){const i=Array.isArray(e)?e:[e],r=dv(n).pipe(qi(([,,,a])=>e===void 0||a!==void 0&&i.includes(a)),ie(([a,c,,l])=>({payload:a,topic:l,from:c})));let s;const o=new ce(a=>{s=a});return{messageObservable:r,isSendingObservable:o,send:(a,...c)=>ze(this,[a,...c],function*(l,u={}){s.next(!0);try{yield iu(n.localParticipant,l,kt({topic:i[0]},u))}finally{s.next(!1)}})}}var Gn=new WeakMap;function Ov(n){return n.ignoreLegacy==!0}var Mv=n=>JSON.parse(new TextDecoder().decode(n)),Av=n=>new TextEncoder().encode(JSON.stringify(n));function Dv(n,e){var t,i,r,s,o,a;const c=()=>{var y,T,I;return((y=n.serverInfo)==null?void 0:y.edition)===1||!!((T=n.serverInfo)!=null&&T.version)&&Be((I=n.serverInfo)==null?void 0:I.version,"1.8.2")>0},l=new qt,u=(t=e?.channelTopic)!=null?t:_v.CHAT,d=(i=e?.channelTopic)!=null?i:Iv.CHAT;let f=!1;Gn.has(n)||(f=!0);const p=(r=Gn.get(n))!=null?r:new Map,g=(s=p.get(u))!=null?s:new qt;p.set(u,g),Gn.set(n,p);const m=(o=e?.messageDecoder)!=null?o:Mv;if(f){n.registerTextStreamHandler(u,(T,I)=>ze(this,null,function*(){const{id:D,timestamp:x}=T.info;js(T).pipe(ga((O,A)=>O+A),ie(O=>({id:D,timestamp:x,message:O,from:n.getParticipantByIdentity(I.identity)}))).subscribe({next:O=>g.next(O)})}));const{messageObservable:y}=xv(n,[d]);y.pipe(ie(T=>{const I=m(T.payload);return Ov(I)?void 0:kn(kt({},I),{from:T.from})}),qi(T=>!!T),va(l)).subscribe(g)}const k=g.pipe(ga((y,T)=>{if("id"in T&&y.find(I=>{var D,x;return((D=I.from)==null?void 0:D.identity)===((x=T.from)==null?void 0:x.identity)&&I.id===T.id})){const I=y.findIndex(D=>D.id===T.id);if(I>-1){const D=y[I];y[I]=kn(kt({},T),{timestamp:D.timestamp,editTimestamp:T.timestamp})}return[...y]}return[...y,T]},[]),va(l)),b=new Ll(!1),w=(a=e?.messageEncoder)!=null?a:Av,R=(y,T)=>ze(this,null,function*(){T||(T={}),T.topic!=null||(T.topic=u),b.next(!0);try{const I={id:(yield n.localParticipant.sendText(y,T)).id,timestamp:Date.now(),message:y},D=kn(kt({},I),{attachedFiles:T.attachments}),x=kn(kt({},D),{from:n.localParticipant,attributes:T.attributes});g.next(x);const O=w(kn(kt({},I),{ignoreLegacy:c()}));try{yield iu(n.localParticipant,O,{reliable:!0,topic:d})}catch(A){j.info("could not send message in legacy chat format",A)}return x}finally{b.next(!1)}});function S(){l.next(),l.complete(),g.complete(),Gn.delete(n),n.unregisterTextStreamHandler(u)}return n.once(P.Disconnected,S),{messageObservable:k,isSendingObservable:b,send:R}}function Nv(){const n=e=>ze(this,null,function*(){j.info("Start Audio for room: ",e),yield e.startAudio()});return{className:Ee("start-audio-button"),roomAudioPlaybackAllowedObservable:hv,handleStartAudioPlayback:n}}function Lv(){const n=e=>ze(this,null,function*(){j.info("Start Video for room: ",e),yield e.startVideo()});return{className:Ee("start-audio-button"),roomVideoPlaybackAllowedObservable:fv,handleStartVideoPlayback:n}}function Uv(){return{className:[Ee("button"),Ee("chat-toggle")].join(" ")}}function Fv(){return{className:[Ee("button"),Ee("focus-toggle-button")].join(" ")}}function jv(){return{className:"lk-room-container"}}function Sa(n,e,t=!0){const i=[n.localParticipant,...Array.from(n.remoteParticipants.values())],r=[];return i.forEach(s=>{e.forEach(o=>{const a=Array.from(s.trackPublications.values()).filter(c=>c.source===o&&(!t||c.track)).map(c=>({participant:s,publication:c,source:c.source}));r.push(...a)})}),{trackReferences:r,participants:i}}function Bv(n,e,t){var i,r;const s=(i=t.additionalRoomEvents)!=null?i:Vg,o=(r=t.onlySubscribed)!=null?r:!0,a=Array.from(new Set([P.ParticipantConnected,P.ParticipantDisconnected,P.ConnectionStateChanged,P.LocalTrackPublished,P.LocalTrackUnpublished,P.TrackPublished,P.TrackUnpublished,P.TrackSubscriptionStatusChanged,...s]).values());return Vs(n,...a).pipe(ie(c=>{const l=Sa(c,e,o);return j.debug(`TrackReference[] was updated. (length ${l.trackReferences.length})`,l),l}),Ke(Sa(n,e,o)))}function Vv(n,e=1e3){if(n===null)return pa(!1);const t=Xr(n,"mousemove",{passive:!0}).pipe(ie(()=>!0)),i=t.pipe(lg({each:e,with:()=>Pi(pa(!1),i.pipe(Pg(t)))}),Eg());return i}function qv(n,e){if(typeof localStorage>"u"){j.error("Local storage is not available.");return}try{if(e){const t=Object.fromEntries(Object.entries(e).filter(([,i])=>i!==""));localStorage.setItem(n,JSON.stringify(t))}}catch(t){j.error(`Error setting item to local storage: ${t}`)}}function Wv(n){if(typeof localStorage>"u"){j.error("Local storage is not available.");return}try{const e=localStorage.getItem(n);if(!e){j.warn(`Item with key ${n} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){j.error(`Error getting item from local storage: ${e}`);return}}function zv(n){return{load:()=>Wv(n),save:e=>qv(n,e)}}var Hv=`${$l}-user-choices`,Sn={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"default",audioDeviceId:"default",username:""},{load:Kv,save:Gv}=zv(Hv);function Jv(n,e=!1){e!==!0&&Gv(n)}function $v(n,e=!1){var t,i,r,s,o;const a={videoEnabled:(t=n?.videoEnabled)!=null?t:Sn.videoEnabled,audioEnabled:(i=n?.audioEnabled)!=null?i:Sn.audioEnabled,videoDeviceId:(r=n?.videoDeviceId)!=null?r:Sn.videoDeviceId,audioDeviceId:(s=n?.audioDeviceId)!=null?s:Sn.audioDeviceId,username:(o=n?.username)!=null?o:Sn.username};if(e)return a;{const c=Kv();return kt(kt({},a),c??{})}}function ru(n,e){if(e.msg==="show_chat")return{...n,showChat:!0,unreadMessages:0};if(e.msg==="hide_chat")return{...n,showChat:!1};if(e.msg==="toggle_chat"){const t={...n,showChat:!n.showChat};return t.showChat===!0&&(t.unreadMessages=0),t}else return e.msg==="unread_msg"?{...n,unreadMessages:e.count}:e.msg==="toggle_settings"?{...n,showSettings:!n.showSettings}:{...n}}function su(n,e){return e.msg==="set_pin"?[e.trackReference]:e.msg==="clear_pin"?[]:{...n}}const zi=h.createContext(void 0);function ou(){const n=h.useContext(zi);if(!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function Qv(n){const e=jn();if(n??(n=e),!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function Yv(){const[n,e]=h.useReducer(su,Xl),[t,i]=h.useReducer(ru,Zl);return{pin:{dispatch:e,state:n},widget:{dispatch:i,state:t}}}function Xv(n){const[e,t]=h.useReducer(su,Xl),[i,r]=h.useReducer(ru,Zl);return n??{pin:{dispatch:t,state:e},widget:{dispatch:r,state:i}}}function jn(){return h.useContext(zi)}const Hs=h.createContext(void 0);function Hi(){return h.useContext(Hs)}function dn(n){const e=Hi(),t=n??e;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}const au=h.createContext(void 0);function cu(){return h.useContext(au)}function Bn(n){const e=cu(),t=Hi(),i=n??e??t?.participant;if(!i)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return i}const Ks=h.createContext(void 0);function Ki(){const n=h.useContext(Ks);if(!n)throw Error("tried to access room context outside of livekit room component");return n}function Gi(){return h.useContext(Ks)}function hn(n){const e=Gi(),t=n??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}const lu=h.createContext(void 0);function Zv(n){return h.useContext(lu)}var Ta={};function uu(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=uu(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function du(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=uu(n))&&(i&&(i+=" "),i+=e);return i}function e0(...n){return(...e)=>{for(const t of n)if(typeof t=="function")try{t(...e)}catch(i){console.error(i)}}}function nt(...n){const e={...n[0]};for(let t=1;t<n.length;t++){const i=n[t];for(const r in i){const s=e[r],o=i[r];typeof s=="function"&&typeof o=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=e0(s,o):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof o=="string"?e[r]=du(s,o):e[r]=o!==void 0?o:s}}return e}function t0(n){return n!==void 0}function pt(...n){return nt(...n.filter(t0))}function hu(n,e,t){return h.Children.map(n,i=>h.isValidElement(i)&&h.Children.only(n)?(i.props.className&&(e??(e={}),e.className=du(i.props.className,e.className),e.style={...i.props.style,...e.style}),h.cloneElement(i,{...e,key:t})):i)}function n0(n){var e,t;if(typeof window<"u"&&typeof process<"u"&&(((e=process==null?void 0:Ta)==null?void 0:e.NODE_ENV)==="dev"||((t=process==null?void 0:Ta)==null?void 0:t.NODE_ENV)==="development")){const i=document.querySelector(".lk-room-container");i&&!getComputedStyle(i).getPropertyValue("--lk-has-imported-styles")&&j.warn("It looks like you're not using the `@livekit/components-styles package`. To render the UI with the default styling, please import it in your layout or page.")}}function i0(n,e){return n==="processor"&&e&&typeof e=="object"&&"name"in e?e.name:n==="e2ee"&&e?"e2ee-enabled":e}const r0={connect:!0,audio:!1,video:!1};function s0(n){const{token:e,serverUrl:t,options:i,room:r,connectOptions:s,connect:o,audio:a,video:c,screen:l,onConnected:u,onDisconnected:d,onError:f,onMediaDeviceFailure:p,onEncryptionError:g,simulateParticipants:m,...k}={...r0,...n};i&&r&&j.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[b,w]=h.useState(),R=h.useRef(o);h.useEffect(()=>{w(r??new ut(i))},[r,JSON.stringify(i,i0)]);const S=h.useMemo(()=>{const{className:y}=jv();return nt(k,{className:y})},[k]);return h.useEffect(()=>{if(!b)return;const y=()=>{const O=b.localParticipant;j.debug("trying to publish local tracks"),Promise.all([O.setMicrophoneEnabled(!!a,typeof a!="boolean"?a:void 0),O.setCameraEnabled(!!c,typeof c!="boolean"?c:void 0),O.setScreenShareEnabled(!!l,typeof l!="boolean"?l:void 0)]).catch(A=>{j.warn(A),f?.(A)})},T=(O,A)=>{const U=On.getFailure(O);p?.(U,A)},I=O=>{g?.(O)},D=O=>{d?.(O)},x=()=>{u?.()};return b.on(P.SignalConnected,y).on(P.MediaDevicesError,T).on(P.EncryptionError,I).on(P.Disconnected,D).on(P.Connected,x),()=>{b.off(P.SignalConnected,y).off(P.MediaDevicesError,T).off(P.EncryptionError,I).off(P.Disconnected,D).off(P.Connected,x)}},[b,a,c,l,f,g,p,u,d]),h.useEffect(()=>{if(b){if(m){b.simulateParticipants({participants:{count:m},publish:{audio:!0,useRealTracks:!0}});return}if(o){if(R.current=!0,j.debug("connecting"),!e){j.debug("no token yet");return}if(!t){j.warn("no livekit url provided"),f?.(Error("no livekit url provided"));return}b.connect(t,e,s).catch(y=>{j.warn(y),R.current===!0&&f?.(y)})}else j.debug("disconnecting because connect is false"),R.current=!1,b.disconnect()}},[o,e,JSON.stringify(s),b,f,t,m]),h.useEffect(()=>{if(b)return()=>{j.info("disconnecting on onmount"),b.disconnect()}},[b]),{room:b,htmlProps:S}}const Lb=h.forwardRef(function(n,e){const{room:t,htmlProps:i}=s0(n);return h.createElement("div",{ref:e,...i},t&&h.createElement(Ks.Provider,{value:t},h.createElement(lu.Provider,{value:n.featureFlags},n.children)))}),o0=n=>{const e=h.useRef(n);return h.useEffect(()=>{e.current=n}),e};function a0(n,e){const t=l0(),i=o0(e);return h.useLayoutEffect(()=>{let r=!1;const s=n.current;if(!s)return;function o(a,c){r||i.current(a,c)}return t?.subscribe(s,o),()=>{r=!0,t?.unsubscribe(s,o)}},[n.current,t,i]),t?.observer}function c0(){let n=!1,e=[];const t=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),n||window.requestAnimationFrame(()=>{const o=new Set;for(let a=0;a<e.length;a++){if(o.has(e[a].target))continue;o.add(e[a].target);const c=t.get(e[a].target);c?.forEach(l=>l(e[a],s))}e=[],n=!1}),n=!0});return{observer:i,subscribe(r,s){i.observe(r);const o=t.get(r)??[];o.push(s),t.set(r,o)},unsubscribe(r,s){const o=t.get(r)??[];if(o.length===1){i.unobserve(r),t.delete(r);return}const a=o.indexOf(s);a!==-1&&o.splice(a,1),t.set(r,o)}}}let Ca;const l0=()=>Ca||(Ca=c0()),fu=n=>{const[e,t]=h.useState({width:0,height:0});h.useLayoutEffect(()=>{if(n.current){const{width:r,height:s}=n.current.getBoundingClientRect();t({width:r,height:s})}},[n.current]);const i=h.useCallback(r=>t(r.contentRect),[]);return a0(n,i),e};function we(n,e,t=!0){const[i,r]=h.useState(e);return h.useEffect(()=>{if(t&&r(e),typeof window>"u"||!n)return;const s=n.subscribe(r);return()=>s.unsubscribe()},[n,t]),i}function u0(n){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[t,i]=h.useState(e(n));function r(){i(e(n))}return h.useEffect(()=>{const s=window.matchMedia(n);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[n]),t}function d0(n={}){const e=Bn(n.participant),{className:t,connectionQualityObserver:i}=h.useMemo(()=>Ev(e),[e]),r=we(i,e.connectionQuality);return{className:t,quality:r}}function Gs(n){const e=hn(n),t=h.useMemo(()=>lv(e),[e]);return we(t,e.state)}function h0(n){const e=Ki(),t=Gs(e);return{buttonProps:h.useMemo(()=>{const{className:i,disconnect:r}=Cv(e);return nt(n,{className:i,onClick:()=>r(n.stopTracks??!0),disabled:t===W.Disconnected})},[e,n,t])}}function f0(n){if(n.publication instanceof vi){const e=n.publication.track;if(e){const{facingMode:t}=Fp(e);return t}}return"undefined"}function p0({trackRef:n,props:e}){const t=dn(n),i=jn(),{className:r}=h.useMemo(()=>Fv(),[]),s=h.useMemo(()=>Ql(t,i?.pin.state),[t,i?.pin.state]);return{mergedProps:h.useMemo(()=>nt(e,{className:r,onClick:o=>{var a,c,l,u,d;(a=e.onClick)==null||a.call(e,o),s?(l=i==null?void 0:(c=i.pin).dispatch)==null||l.call(c,{msg:"clear_pin"}):(d=i==null?void 0:(u=i.pin).dispatch)==null||d.call(u,{msg:"set_pin",trackReference:t})}}),[e,r,t,s,i?.pin]),inFocus:s}}function m0(n,e,t={}){const i=t.gridLayouts??Wg,{width:r,height:s}=fu(n),o=Yl(i,e,r,s);return h.useEffect(()=>{n.current&&o&&(n.current.style.setProperty("--lk-col-count",o?.columns.toString()),n.current.style.setProperty("--lk-row-count",o?.rows.toString()))},[n,o]),{layout:o,containerWidth:r,containerHeight:s}}function Ea(n,e={}){var t,i;const r=typeof n=="string"?e.participant:n.participant,s=Bn(r),o=typeof n=="string"?{participant:s,source:n}:n,[a,c]=h.useState(!!((t=o.publication)!=null&&t.isMuted||(i=s.getTrackPublication(o.source))!=null&&i.isMuted));return h.useEffect(()=>{const l=nu(o).subscribe(c);return()=>l.unsubscribe()},[de(o)]),a}function g0(n){const e=Bn(n),t=h.useMemo(()=>bv(e),[e]);return we(t,e.isSpeaking)}function Ub(n={}){const e=hn(n.room),[t,i]=h.useState(e.localParticipant),[r,s]=h.useState(t.isMicrophoneEnabled),[o,a]=h.useState(t.isCameraEnabled),[c,l]=h.useState(t.isScreenShareEnabled),[u,d]=h.useState(t.lastMicrophoneError),[f,p]=h.useState(t.lastCameraError),[g,m]=h.useState(void 0),[k,b]=h.useState(void 0),w=R=>{a(R.isCameraEnabled),s(R.isMicrophoneEnabled),l(R.isScreenShareEnabled),b(R.cameraTrack),m(R.microphoneTrack),d(R.participant.lastMicrophoneError),p(R.participant.lastCameraError),i(R.participant)};return h.useEffect(()=>{const R=Ws(e.localParticipant).subscribe(w);return()=>R.unsubscribe()},[e]),{isMicrophoneEnabled:r,isScreenShareEnabled:c,isCameraEnabled:o,microphoneTrack:g,cameraTrack:k,lastMicrophoneError:u,lastCameraError:f,localParticipant:t}}function v0(){const n=Ki(),e=h.useMemo(()=>yv(n.localParticipant),[n]);return we(e,n.localParticipant.permissions)}function b0({kind:n,room:e,track:t,requestPermissions:i,onError:r}){const s=Gi(),o=h.useMemo(()=>e??s??new ut,[e,s]),a=h.useMemo(()=>uv(n,r,i),[n,i,r]),c=we(a,[]),[l,u]=h.useState(o?.getActiveDevice(n)??"default"),{className:d,activeDeviceObservable:f,setActiveMediaDevice:p}=h.useMemo(()=>Tv(n,o),[n,o,t]);return h.useEffect(()=>{const g=f.subscribe(m=>{m&&(j.info("setCurrentDeviceId",m),u(m))});return()=>{g?.unsubscribe()}},[f]),{devices:c,className:d,activeDeviceId:l,setActiveMediaDevice:p}}function pu(n,e,t={}){const i=h.useRef([]),r=h.useRef(-1),s=e!==r.current,o=typeof t.customSortFunction=="function"?t.customSortFunction(n):Yg(n);let a=[...o];if(s===!1)try{a=ov(i.current,o,e)}catch(c){j.error("Error while running updatePages(): ",c)}return s?i.current=o:i.current=a,r.current=e,a}function y0(n,e){const[t,i]=h.useState(1),r=Math.max(Math.ceil(e.length/n),1);t>r&&i(r);const s=t*n,o=s-n,a=u=>{i(d=>u==="next"?d===r?d:d+1:d===1?d:d-1)},c=u=>{u>r?i(r):u<1?i(1):i(u)},l=pu(e,n).slice(o,s);return{totalPageCount:r,nextPage:()=>a("next"),prevPage:()=>a("previous"),setPage:c,firstItemIndex:o,lastItemIndex:s,tracks:l,currentPage:t}}function k0({trackRef:n,onParticipantClick:e,disableSpeakingIndicator:t,htmlProps:i}){const r=dn(n),s=h.useMemo(()=>{const{className:f}=Rv();return nt(i,{className:f,onClick:p=>{var g;if((g=i.onClick)==null||g.call(i,p),typeof e=="function"){const m=r.publication??r.participant.getTrackPublication(r.source);e({participant:r.participant,track:m})}}})},[i,e,r.publication,r.source,r.participant]),o=r.participant.getTrackPublication(C.Source.Microphone),a=h.useMemo(()=>({participant:r.participant,source:C.Source.Microphone,publication:o}),[o,r.participant]),c=Ea(r),l=Ea(a),u=g0(r.participant),d=f0(r);return{elementProps:{"data-lk-audio-muted":l,"data-lk-video-muted":c,"data-lk-speaking":t===!0?!1:u,"data-lk-local-participant":r.participant.isLocal,"data-lk-source":r.source,"data-lk-facing-mode":d,...s}}}function S0(n){return n=Qv(n),h.useMemo(()=>n?.pin.state!==void 0&&n.pin.state.length>=1?n.pin.state:[],[n.pin.state])}function T0({room:n,props:e}){const t=hn(n),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=h.useMemo(()=>Nv(),[]),o=h.useMemo(()=>r(t),[t,r]),{canPlayAudio:a}=we(o,{canPlayAudio:t.canPlaybackAudio});return{mergedProps:h.useMemo(()=>nt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayAudio:a}}function C0({room:n,props:e}){const t=hn(n),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=h.useMemo(()=>Lv(),[]),o=h.useMemo(()=>r(t),[t,r]),{canPlayVideo:a}=we(o,{canPlayVideo:t.canPlaybackVideo});return{mergedProps:h.useMemo(()=>nt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayVideo:a}}function E0(n,e={}){const t=h.useRef(null),i=h.useRef(null),r=e.minSwipeDistance??50,s=c=>{i.current=null,t.current=c.targetTouches[0].clientX},o=c=>{i.current=c.targetTouches[0].clientX},a=h.useCallback(()=>{if(!t.current||!i.current)return;const c=t.current-i.current,l=c>r,u=c<-r;l&&e.onLeftSwipe&&e.onLeftSwipe(),u&&e.onRightSwipe&&e.onRightSwipe()},[r,e]);h.useEffect(()=>{const c=n.current;return c&&(c.addEventListener("touchstart",s,{passive:!0}),c.addEventListener("touchmove",o,{passive:!0}),c.addEventListener("touchend",a,{passive:!0})),()=>{c&&(c.removeEventListener("touchstart",s),c.removeEventListener("touchmove",o),c.removeEventListener("touchend",a))}},[n,a])}function w0({props:n}){const{dispatch:e,state:t}=ou().widget,{className:i}=h.useMemo(()=>Uv(),[]);return{mergedProps:h.useMemo(()=>nt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":t!=null&&t.showChat?"true":"false","data-lk-unread-msgs":t?t.unreadMessages<10?t.unreadMessages.toFixed(0):"9+":"0"}),[n,i,e,t])}}function P0(n){var e,t;const i=dn(n),{className:r,mediaMutedObserver:s}=h.useMemo(()=>wv(i),[de(i)]);return{isMuted:we(s,!!((e=i.publication)!=null&&e.isMuted||(t=i.participant.getTrackPublication(i.source))!=null&&t.isMuted)),className:r}}function R0({source:n,onChange:e,initialState:t,captureOptions:i,publishOptions:r,onDeviceError:s,...o}){var a;const c=Gi(),l=(a=c?.localParticipant)==null?void 0:a.getTrackPublication(n),u=h.useRef(!1),{toggle:d,className:f,pendingObserver:p,enabledObserver:g}=h.useMemo(()=>c?kv(n,c,i,r,s):Sv(),[c,n,JSON.stringify(i),r]),m=we(p,!1),k=we(g,t??!!(l!=null&&l.isEnabled));h.useEffect(()=>{e?.(k,u.current),u.current=!1},[k,e]),h.useEffect(()=>{t!==void 0&&(j.debug("forcing initial toggle state",n,t),d(t))},[]);const b=h.useMemo(()=>nt(o,{className:f}),[o,f]),w=h.useCallback(R=>{var S;u.current=!0,d().catch(()=>u.current=!1),(S=o.onClick)==null||S.call(o,R)},[o,d]);return{toggle:d,enabled:k,pending:m,track:l,buttonProps:{...b,"aria-pressed":k,"data-lk-source":n,"data-lk-enabled":k,disabled:m,onClick:w}}}function mu(n=[C.Source.Camera,C.Source.Microphone,C.Source.ScreenShare,C.Source.ScreenShareAudio,C.Source.Unknown],e={}){const t=hn(e.room),[i,r]=h.useState([]),[s,o]=h.useState([]),a=h.useMemo(()=>n.map(c=>eu(c)?c.source:c),[JSON.stringify(n)]);return h.useEffect(()=>{const c=Bv(t,a,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:l,participants:u})=>{j.debug("setting track bundles",l,u),r(l),o(u)});return()=>c.unsubscribe()},[t,JSON.stringify(e.onlySubscribed),JSON.stringify(e.updateOnlyOn),JSON.stringify(n)]),h.useMemo(()=>{if(tu(n)){const c=I0(n,s),l=Array.from(i);return s.forEach(u=>{c.has(u.identity)&&(c.get(u.identity)??[]).forEach(d=>{if(i.find(({participant:p,publication:g})=>u.identity===p.identity&&g.source===d))return;j.debug(`Add ${d} placeholder for participant ${u.identity}.`);const f={participant:u,source:d};l.push(f)})}),l}else return i},[i,s,n])}function _0(n,e){const t=new Set(n);for(const i of e)t.delete(i);return t}function I0(n,e){const t=new Map;if(tu(n)){const i=n.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTrackPublications().map(a=>{var c;return(c=a.track)==null?void 0:c.source}).filter(a=>a!==void 0),o=Array.from(_0(new Set(i),new Set(s)));o.length>0&&t.set(r.identity,o)})}return t}function x0(n){const e=Ki(),t=Gs(e),i=h.useMemo(()=>t===W.Disconnected,[t]),r=h.useMemo(()=>Dv(e,n),[e,n,i]),s=we(r.isSendingObservable,!1),o=we(r.messageObservable,[]);return{send:r.send,chatMessages:o,isSending:s}}function O0(n={}){const[e,t]=h.useState($v(n.defaults,n.preventLoad??!1)),i=h.useCallback(c=>{t(l=>({...l,audioEnabled:c}))},[]),r=h.useCallback(c=>{t(l=>({...l,videoEnabled:c}))},[]),s=h.useCallback(c=>{t(l=>({...l,audioDeviceId:c}))},[]),o=h.useCallback(c=>{t(l=>({...l,videoDeviceId:c}))},[]),a=h.useCallback(c=>{t(l=>({...l,username:c}))},[]);return h.useEffect(()=>{Jv(e,n.preventSave??!1)},[e,n.preventSave]),{userChoices:e,saveAudioInputEnabled:i,saveVideoInputEnabled:r,saveAudioInputDeviceId:s,saveVideoInputDeviceId:o,saveUsername:a}}function M0(n,e={}){const t=Bn(n),i=hn(e.room),r=h.useMemo(()=>mv(i,t),[i,t]);return we(r,t.isLocal?t.isE2EEEnabled:!!(t!=null&&t.isEncrypted))}const gu=h.forwardRef(function(n,e){const{mergedProps:t}=w0({props:n});return h.createElement("button",{ref:e,...t},n.children)}),A0=h.forwardRef(function(n,e){const{buttonProps:t}=h0(n);return h.createElement("button",{ref:e,...t},n.children)}),D0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},h.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),h.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),N0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},h.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),L0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,viewBox:"0 0 24 24",...n},h.createElement("path",{fill:"#FFF",d:"M4.99 3.99a1 1 0 0 0-.697 1.717L10.586 12l-6.293 6.293a1 1 0 1 0 1.414 1.414L12 13.414l6.293 6.293a1 1 0 1 0 1.414-1.414L13.414 12l6.293-6.293a1 1 0 0 0-.727-1.717 1 1 0 0 0-.687.303L12 10.586 5.707 4.293a1 1 0 0 0-.717-.303z"})),U0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none",...n},h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),wa=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),F0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},h.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),j0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M8.961.894C8.875-.298 7.125-.298 7.04.894c-.066.912-1.246 1.228-1.76.472-.67-.99-2.186-.115-1.664.96.399.824-.465 1.688-1.288 1.289-1.076-.522-1.95.994-.961 1.665.756.513.44 1.693-.472 1.759-1.192.086-1.192 1.836 0 1.922.912.066 1.228 1.246.472 1.76-.99.67-.115 2.186.96 1.664.824-.399 1.688.465 1.289 1.288-.522 1.076.994 1.95 1.665.961.513-.756 1.693-.44 1.759.472.086 1.192 1.836 1.192 1.922 0 .066-.912 1.246-1.228 1.76-.472.67.99 2.186.115 1.664-.96-.399-.824.465-1.688 1.288-1.289 1.076.522 1.95-.994.961-1.665-.756-.513-.44-1.693.472-1.759 1.192-.086 1.192-1.836 0-1.922-.912-.066-1.228-1.246-.472-1.76.99-.67.115-2.186-.96-1.664-.824.399-1.688-.465-1.289-1.288.522-1.076-.994-1.95-1.665-.961-.513.756-1.693.44-1.759-.472ZM8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10Z",clipRule:"evenodd"})),B0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),V0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),q0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},h.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),h.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),W0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},h.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),h.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),z0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),H0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("g",{opacity:.25},h.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),K0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("g",{opacity:.25},h.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),h.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),G0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},h.createElement("g",{opacity:.25},h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),h.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),vu=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),J0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},h.createElement("g",{fill:"currentColor"},h.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),h.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),Pa=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 0a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 12a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 8 12Z",clipRule:"evenodd",opacity:.7}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 1.072a.75.75 0 0 1 .274 1.024l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 12 1.072Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 11.464a.75.75 0 0 1 .274 1.025l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 6 11.464Z",clipRule:"evenodd",opacity:.6}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 4a.75.75 0 0 1-.274 1.025l-2.165 1.25a.75.75 0 1 1-.75-1.3l2.165-1.25A.75.75 0 0 1 14.928 4Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 10a.75.75 0 0 1-.275 1.024l-2.165 1.25a.75.75 0 0 1-.75-1.298l2.165-1.25A.75.75 0 0 1 4.536 10Z",clipRule:"evenodd",opacity:.5}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M16 8a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 16 8Z",clipRule:"evenodd"}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 4 8Z",clipRule:"evenodd",opacity:.4}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 12a.75.75 0 0 1-1.024.274l-2.165-1.25a.75.75 0 0 1 .75-1.299l2.165 1.25A.75.75 0 0 1 14.928 12Z",clipRule:"evenodd",opacity:.9}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 6a.75.75 0 0 1-1.025.275l-2.165-1.25a.75.75 0 1 1 .75-1.3l2.165 1.25A.75.75 0 0 1 4.536 6Z",clipRule:"evenodd",opacity:.3}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 14.928a.75.75 0 0 1-1.024-.274l-1.25-2.165a.75.75 0 0 1 1.298-.75l1.25 2.165A.75.75 0 0 1 12 14.928Z",clipRule:"evenodd",opacity:.8}),h.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 4.536a.75.75 0 0 1-1.024-.275l-1.25-2.165a.75.75 0 1 1 1.299-.75l1.25 2.165A.75.75 0 0 1 6 4.536Z",clipRule:"evenodd",opacity:.2})),$0=n=>h.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},h.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},h.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),Q0=h.forwardRef(function({trackRef:n,...e},t){const i=Hi(),{mergedProps:r,inFocus:s}=p0({trackRef:n??i,props:e});return h.createElement(zi.Consumer,null,o=>o!==void 0&&h.createElement("button",{ref:t,...r},e.children?e.children:s?h.createElement($0,null):h.createElement(F0,null)))}),gr=h.forwardRef(function({kind:n,initialSelection:e,onActiveDeviceChange:t,onDeviceListChange:i,onDeviceSelectError:r,exactMatch:s,track:o,requestPermissions:a,onError:c,...l},u){const d=Gi(),f=h.useRef("default"),p=h.useCallback(T=>{d&&d.emit(P.MediaDevicesError,T),c?.(T)},[d,c]),{devices:g,activeDeviceId:m,setActiveMediaDevice:k,className:b}=b0({kind:n,room:d,track:o,requestPermissions:a,onError:p});h.useEffect(()=>{e!==void 0&&k(e)},[k]),h.useEffect(()=>{typeof i=="function"&&i(g)},[i,g]),h.useEffect(()=>{m!==f.current&&t?.(m),f.current=m},[m]);const w=async T=>{try{await k(T,{exact:s??!0})}catch(I){if(I instanceof Error)r?.(I);else throw I}},R=h.useMemo(()=>pt(l,{className:b},{className:"lk-list"}),[b,l]),S=!!g.find(T=>T.label.toLowerCase().startsWith("default"));function y(T,I,D){return T===I||!S&&D===0&&I==="default"}return h.createElement("ul",{ref:u,...R},g.map((T,I)=>h.createElement("li",{key:T.deviceId,id:T.deviceId,"data-lk-active":y(T.deviceId,m,I),"aria-selected":y(T.deviceId,m,I),role:"option"},h.createElement("button",{className:"lk-button",onClick:()=>w(T.deviceId)},T.label))))}),Y0=h.forwardRef(function({label:n,...e},t){const i=Ki(),{mergedProps:r,canPlayAudio:s}=T0({room:i,props:e}),{mergedProps:o,canPlayVideo:a}=C0({room:i,props:r}),{style:c,...l}=o;return c.display=s&&a?"none":"block",h.createElement("button",{ref:t,style:c,...l},n??`Start ${s?"Video":"Audio"}`)});function bu(n,e){switch(n){case C.Source.Microphone:return e?h.createElement(W0,null):h.createElement(q0,null);case C.Source.Camera:return e?h.createElement(N0,null):h.createElement(D0,null);case C.Source.ScreenShare:return e?h.createElement(J0,null):h.createElement(vu,null);default:return}}function X0(n){switch(n){case Ue.Excellent:return h.createElement(z0,null);case Ue.Good:return h.createElement(H0,null);case Ue.Poor:return h.createElement(K0,null);default:return h.createElement(G0,null)}}const vr=h.forwardRef(function({showIcon:n,...e},t){const{buttonProps:i,enabled:r}=R0(e),[s,o]=h.useState(!1);return h.useEffect(()=>{o(!0)},[]),s&&h.createElement("button",{ref:t,...i},(n??!0)&&bu(e.source,r),e.children)}),Z0=h.forwardRef(function(n,e){const{className:t,quality:i}=d0(n),r=h.useMemo(()=>({...pt(n,{className:t}),"data-lk-quality":i}),[i,n,t]);return h.createElement("div",{ref:e,...r},n.children??X0(i))}),Ra=h.forwardRef(function({participant:n,...e},t){const i=Bn(n),{className:r,infoObserver:s}=h.useMemo(()=>Pv(i),[i]),{identity:o,name:a}=we(s,{name:i.name,identity:i.identity,metadata:i.metadata}),c=h.useMemo(()=>pt(e,{className:r,"data-lk-participant-name":a}),[e,r,a]);return h.createElement("span",{ref:t,...c},a!==""?a:o,e.children)}),eb=h.forwardRef(function({trackRef:n,show:e="always",...t},i){const{className:r,isMuted:s}=P0(n),o=e==="always"||e==="muted"&&s||e==="unmuted"&&!s,a=h.useMemo(()=>pt(t,{className:r}),[r,t]);return o?h.createElement("div",{ref:i,...a,"data-lk-muted":s},t.children??bu(n.source,!s)):null}),tb=n=>h.createElement("svg",{width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},h.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),h.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25}));function yu(n,e={}){const[t,i]=h.useState(ns(n)),[r,s]=h.useState(t?.isMuted),[o,a]=h.useState(t?.isSubscribed),[c,l]=h.useState(t?.track),[u,d]=h.useState("landscape"),f=h.useRef(),{className:p,trackObserver:g}=h.useMemo(()=>cv(n),[n.participant.sid??n.participant.identity,n.source,ae(n)&&n.publication.trackSid]);return h.useEffect(()=>{const m=g.subscribe(k=>{j.debug("update track",k),i(k),s(k?.isMuted),a(k?.isSubscribed),l(k?.track)});return()=>m?.unsubscribe()},[g]),h.useEffect(()=>{var m,k;return c&&(f.current&&c.detach(f.current),(m=e.element)!=null&&m.current&&!(n.participant.isLocal&&c?.kind==="audio")&&c.attach(e.element.current)),f.current=(k=e.element)==null?void 0:k.current,()=>{f.current&&c?.detach(f.current)}},[c,e.element]),h.useEffect(()=>{var m,k;if(typeof((m=t?.dimensions)==null?void 0:m.width)=="number"&&typeof((k=t?.dimensions)==null?void 0:k.height)=="number"){const b=t.dimensions.width>t.dimensions.height?"landscape":"portrait";d(b)}},[t]),{publication:t,isMuted:r,isSubscribed:o,track:c,elementProps:pt(e.props,{className:p,"data-lk-local-participant":n.participant.isLocal,"data-lk-source":t?.source,...t?.kind==="video"&&{"data-lk-orientation":u}})}}var br,_a;function nb(){if(_a)return br;_a=1;var n="Expected a function",e=NaN,t="[object Symbol]",i=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,o=/^0o[0-7]+$/i,a=parseInt,c=typeof Hn=="object"&&Hn&&Hn.Object===Object&&Hn,l=typeof self=="object"&&self&&self.Object===Object&&self,u=c||l||Function("return this")(),d=Object.prototype,f=d.toString,p=Math.max,g=Math.min,m=function(){return u.Date.now()};function k(y,T,I){var D,x,O,A,U,K,$=0,Me=!1,ye=!1,Pe=!0;if(typeof y!="function")throw new TypeError(n);T=S(T)||0,b(I)&&(Me=!!I.leading,ye="maxWait"in I,O=ye?p(S(I.maxWait)||0,T):O,Pe="trailing"in I?!!I.trailing:Pe);function fe(re){var gt=D,fn=x;return D=x=void 0,$=re,A=y.apply(fn,gt),A}function ke(re){return $=re,U=setTimeout(mt,T),Me?fe(re):A}function Ot(re){var gt=re-K,fn=re-$,Js=T-gt;return ye?g(Js,O-fn):Js}function zt(re){var gt=re-K,fn=re-$;return K===void 0||gt>=T||gt<0||ye&&fn>=O}function mt(){var re=m();if(zt(re))return Ht(re);U=setTimeout(mt,Ot(re))}function Ht(re){return U=void 0,Pe&&D?fe(re):(D=x=void 0,A)}function Ji(){U!==void 0&&clearTimeout(U),$=0,D=K=x=U=void 0}function Vn(){return U===void 0?A:Ht(m())}function Mt(){var re=m(),gt=zt(re);if(D=arguments,x=this,K=re,gt){if(U===void 0)return ke(K);if(ye)return U=setTimeout(mt,T),fe(K)}return U===void 0&&(U=setTimeout(mt,T)),A}return Mt.cancel=Ji,Mt.flush=Vn,Mt}function b(y){var T=typeof y;return!!y&&(T=="object"||T=="function")}function w(y){return!!y&&typeof y=="object"}function R(y){return typeof y=="symbol"||w(y)&&f.call(y)==t}function S(y){if(typeof y=="number")return y;if(R(y))return e;if(b(y)){var T=typeof y.valueOf=="function"?y.valueOf():y;y=b(T)?T+"":T}if(typeof y!="string")return y===0?y:+y;y=y.replace(i,"");var I=s.test(y);return I||o.test(y)?a(y.slice(2),I?2:8):r.test(y)?e:+y}return br=k,br}var ib=nb();const Ia=Ol(ib);function rb(n){const e=h.useRef(n);e.current=n,h.useEffect(()=>()=>{e.current()},[])}function sb(n,e=500,t){const i=h.useRef();rb(()=>{i.current&&i.current.cancel()});const r=h.useMemo(()=>{const s=Ia(n,e,t),o=(...a)=>s(...a);return o.cancel=()=>{s.cancel()},o.isPending=()=>!!i.current,o.flush=()=>s.flush(),o},[n,e,t]);return h.useEffect(()=>{i.current=Ia(n,e,t)},[n,e,t]),r}function ob(n,e,t){const i=((l,u)=>l===u),r=n instanceof Function?n():n,[s,o]=h.useState(r),a=h.useRef(r),c=sb(o,e,t);return i(a.current,r)||(c(r),a.current=r),[s,c]}function ab({threshold:n=0,root:e=null,rootMargin:t="0%",freezeOnceVisible:i=!1,initialIsIntersecting:r=!1,onChange:s}={}){var o;const[a,c]=h.useState(null),[l,u]=h.useState(()=>({isIntersecting:r,entry:void 0})),d=h.useRef();d.current=s;const f=((o=l.entry)==null?void 0:o.isIntersecting)&&i;h.useEffect(()=>{if(!a||!("IntersectionObserver"in window)||f)return;const m=new IntersectionObserver(k=>{const b=Array.isArray(m.thresholds)?m.thresholds:[m.thresholds];k.forEach(w=>{const R=w.isIntersecting&&b.some(S=>w.intersectionRatio>=S);u({isIntersecting:R,entry:w}),d.current&&d.current(R,w)})},{threshold:n,root:e,rootMargin:t});return m.observe(a),()=>{m.disconnect()}},[a,JSON.stringify(n),e,t,f,i]);const p=h.useRef(null);h.useEffect(()=>{var m;!a&&(m=l.entry)!=null&&m.target&&!i&&!f&&p.current!==l.entry.target&&(p.current=l.entry.target,u({isIntersecting:r,entry:void 0}))},[a,l.entry,i,f,r]);const g=[c,!!l.isIntersecting,l.entry];return g.ref=g[0],g.isIntersecting=g[1],g.entry=g[2],g}const cb=h.forwardRef(function({onTrackClick:n,onClick:e,onSubscriptionStatusChanged:t,trackRef:i,manageSubscription:r,...s},o){const a=dn(i),c=h.useRef(null);h.useImperativeHandle(o,()=>c.current);const l=ab({root:c.current}),[u]=ob(l,3e3);h.useEffect(()=>{r&&a.publication instanceof bi&&u?.isIntersecting===!1&&l?.isIntersecting===!1&&a.publication.setSubscribed(!1)},[u,a,r]),h.useEffect(()=>{r&&a.publication instanceof bi&&l?.isIntersecting===!0&&a.publication.setSubscribed(!0)},[l,a,r]);const{elementProps:d,publication:f,isSubscribed:p}=yu(a,{element:c,props:s});h.useEffect(()=>{t?.(!!p)},[p,t]);const g=m=>{e?.(m),n?.({participant:a?.participant,track:f})};return h.createElement("video",{ref:c,...d,muted:!0,onClick:g})}),ku=h.forwardRef(function({trackRef:n,onSubscriptionStatusChanged:e,volume:t,...i},r){const s=dn(n),o=h.useRef(null);h.useImperativeHandle(r,()=>o.current);const{elementProps:a,isSubscribed:c,track:l,publication:u}=yu(s,{element:o,props:i});return h.useEffect(()=>{e?.(!!c)},[c,e]),h.useEffect(()=>{l===void 0||t===void 0||(l instanceof gl?l.setVolume(t):j.warn("Volume can only be set on remote audio tracks."))},[t,l]),h.useEffect(()=>{u===void 0||i.muted===void 0||(u instanceof bi?u.setEnabled(!i.muted):j.warn("Can only call setEnabled on remote track publications."))},[i.muted,u,l]),h.createElement("audio",{ref:o,...a})});function lb(n){const e=!!cu();return n.participant&&!e?h.createElement(au.Provider,{value:n.participant},n.children):h.createElement(h.Fragment,null,n.children)}function ub(n){const e=!!Hi();return n.trackRef&&!e?h.createElement(Hs.Provider,{value:n.trackRef},n.children):h.createElement(h.Fragment,null,n.children)}const is=h.forwardRef(function({trackRef:n,children:e,onParticipantClick:t,disableSpeakingIndicator:i,...r},s){var o,a;const c=dn(n),{elementProps:l}=k0({htmlProps:r,disableSpeakingIndicator:i,onParticipantClick:t,trackRef:c}),u=M0(c.participant),d=jn(),f=(o=Zv())==null?void 0:o.autoSubscription,p=h.useCallback(g=>{c.source&&!g&&d&&d.pin.dispatch&&Ql(c,d.pin.state)&&d.pin.dispatch({msg:"clear_pin"})},[c,d]);return h.createElement("div",{ref:s,style:{position:"relative"},...l},h.createElement(ub,{trackRef:c},h.createElement(lb,{participant:c.participant},e??h.createElement(h.Fragment,null,ae(c)&&(((a=c.publication)==null?void 0:a.kind)==="video"||c.source===C.Source.Camera||c.source===C.Source.ScreenShare)?h.createElement(cb,{trackRef:c,onSubscriptionStatusChanged:p,manageSubscription:f}):ae(c)&&h.createElement(ku,{trackRef:c,onSubscriptionStatusChanged:p}),h.createElement("div",{className:"lk-participant-placeholder"},h.createElement(tb,null)),h.createElement("div",{className:"lk-participant-metadata"},h.createElement("div",{className:"lk-participant-metadata-item"},c.source===C.Source.Camera?h.createElement(h.Fragment,null,u&&h.createElement(V0,{style:{marginRight:"0.25rem"}}),h.createElement(eb,{trackRef:{participant:c.participant,source:C.Source.Microphone},show:"muted"}),h.createElement(Ra,null)):h.createElement(h.Fragment,null,h.createElement(vu,{style:{marginRight:"0.25rem"}}),h.createElement(Ra,null,"'s screen"))),h.createElement(Z0,{className:"lk-participant-metadata-item"}))),h.createElement(Q0,{trackRef:c}))))});function db(n){const e=pt(n,{className:"lk-focus-layout"});return h.createElement("div",{...e},n.children)}function hb({trackRef:n,...e}){return h.createElement(is,{trackRef:n,...e})}function Su({tracks:n,...e}){return h.createElement(h.Fragment,null,n.map(t=>h.createElement(Hs.Provider,{value:t,key:de(t)},hu(e.children))))}function fb({totalPageCount:n,nextPage:e,prevPage:t,currentPage:i,pagesContainer:r}){const[s,o]=h.useState(!1);return h.useEffect(()=>{let a;return r&&(a=Vv(r.current,2e3).subscribe(o)),()=>{a&&a.unsubscribe()}},[r]),h.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},h.createElement("button",{className:"lk-button",onClick:t},h.createElement(wa,null)),h.createElement("span",{className:"lk-pagination-count"},`${i} of ${n}`),h.createElement("button",{className:"lk-button",onClick:e},h.createElement(wa,null)))}const pb=h.forwardRef(function({totalPageCount:n,currentPage:e},t){const i=new Array(n).fill("").map((r,s)=>s+1===e?h.createElement("span",{"data-lk-active":!0,key:s}):h.createElement("span",{key:s}));return h.createElement("div",{ref:t,className:"lk-pagination-indicator"},i)});function mb({tracks:n,...e}){const t=h.createRef(),i=h.useMemo(()=>pt(e,{className:"lk-grid-layout"}),[e]),{layout:r}=m0(t,n.length),s=y0(r.maxTiles,n);return E0(t,{onLeftSwipe:s.nextPage,onRightSwipe:s.prevPage}),h.createElement("div",{ref:t,"data-lk-pagination":s.totalPageCount>1,...i},h.createElement(Su,{tracks:s.tracks},e.children),n.length>r.maxTiles&&h.createElement(h.Fragment,null,h.createElement(pb,{totalPageCount:s.totalPageCount,currentPage:s.currentPage}),h.createElement(fb,{pagesContainer:t,...s})))}const gb=130,vb=140,bb=1,Tu=16/10,yb=(1-Tu)*-1;function kb({tracks:n,orientation:e,...t}){const i=h.useRef(null),[r,s]=h.useState(0),{width:o,height:a}=fu(i),c=e||(a>=o?"vertical":"horizontal"),l=c==="vertical"?Math.max(o*yb,gb):Math.max(a*Tu,vb),u=Lg(),d=Math.max(c==="vertical"?(a-u)/l:(o-u)/l,bb);let f=Math.round(d);Math.abs(d-r)<.5?f=Math.round(r):r!==d&&s(d);const p=pu(n,f);return h.useLayoutEffect(()=>{i.current&&(i.current.dataset.lkOrientation=c,i.current.style.setProperty("--lk-max-visible-tiles",f.toString()))},[f,c]),h.createElement("aside",{key:c,className:"lk-carousel",ref:i,...t},h.createElement(Su,{tracks:p},t.children))}function Sb({value:n,onPinChange:e,onWidgetChange:t,children:i}){const r=Xv(n);return h.useEffect(()=>{j.debug("PinState Updated",{state:r.pin.state}),e&&r.pin.state&&e(r.pin.state)},[r.pin.state,e]),h.useEffect(()=>{j.debug("Widget Updated",{widgetState:r.widget.state}),t&&r.widget.state&&t(r.widget.state)},[t,r.widget.state]),h.createElement(zi.Provider,{value:r},i)}function Tb({volume:n,muted:e}){const t=mu([C.Source.Microphone,C.Source.ScreenShareAudio,C.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0}).filter(i=>!i.participant.isLocal&&i.publication.kind===C.Kind.Audio);return h.createElement("div",{style:{display:"none"}},t.map(i=>h.createElement(ku,{key:de(i),trackRef:i,volume:n,muted:e})))}function Cb(n){const e=h.useMemo(()=>pt(n,{className:"lk-toast"}),[n]);return h.createElement("div",{...e},n.children)}function Eb(n){const[e,t]=h.useState(void 0),i=Gs(n.room);return h.useEffect(()=>{switch(i){case W.Reconnecting:t(h.createElement(h.Fragment,null,h.createElement(Pa,{className:"lk-spinner"})," Reconnecting"));break;case W.Connecting:t(h.createElement(h.Fragment,null,h.createElement(Pa,{className:"lk-spinner"})," Connecting"));break;case W.Disconnected:t(h.createElement(h.Fragment,null,"Disconnected"));break;default:t(void 0);break}},[i]),e?h.createElement(Cb,{className:"lk-toast-connection-state"},e):h.createElement(h.Fragment,null)}const wb=h.forwardRef(function({entry:n,hideName:e=!1,hideTimestamp:t=!1,messageFormatter:i,...r},s){var o,a,c,l;const u=h.useMemo(()=>i?i(n.message):n.message,[n.message,i]),d=!!n.editTimestamp,f=new Date(n.timestamp),p=typeof navigator<"u"?navigator.language:"en-US",g=((o=n.from)==null?void 0:o.name)??((a=n.from)==null?void 0:a.identity);return h.createElement("li",{ref:s,className:"lk-chat-entry",title:f.toLocaleTimeString(p,{timeStyle:"full"}),"data-lk-message-origin":(c=n.from)!=null&&c.isLocal?"local":"remote",...r},(!t||!e||d)&&h.createElement("span",{className:"lk-meta-data"},!e&&h.createElement("strong",{className:"lk-participant-name"},g),(!t||d)&&h.createElement("span",{className:"lk-timestamp"},d&&"edited ",f.toLocaleTimeString(p,{timeStyle:"short"}))),h.createElement("span",{className:"lk-message-body"},u),h.createElement("span",{className:"lk-message-attachements"},(l=n.attachedFiles)==null?void 0:l.map(m=>m.type.startsWith("image/")&&h.createElement("img",{style:{maxWidth:"300px",maxHeight:"300px"},key:m.name,src:URL.createObjectURL(m),alt:m.name}))))});function Pb({messageFormatter:n,messageDecoder:e,messageEncoder:t,channelTopic:i,...r}){const s=h.useRef(null),o=h.useRef(null),a=h.useMemo(()=>({messageDecoder:e,messageEncoder:t,channelTopic:i}),[e,t,i]),{chatMessages:c,send:l,isSending:u}=x0(a),d=jn(),f=h.useRef(0);async function p(g){g.preventDefault(),o.current&&o.current.value.trim()!==""&&(await l(o.current.value),o.current.value="",o.current.focus())}return h.useEffect(()=>{var g;s&&((g=s.current)==null||g.scrollTo({top:s.current.scrollHeight}))},[s,c]),h.useEffect(()=>{var g,m,k,b,w;if(!d||c.length===0)return;if((g=d.widget.state)!=null&&g.showChat&&c.length>0&&f.current!==((m=c[c.length-1])==null?void 0:m.timestamp)){f.current=(k=c[c.length-1])==null?void 0:k.timestamp;return}const R=c.filter(y=>!f.current||y.timestamp>f.current).length,{widget:S}=d;R>0&&((b=S.state)==null?void 0:b.unreadMessages)!==R&&((w=S.dispatch)==null||w.call(S,{msg:"unread_msg",count:R}))},[c,d?.widget]),h.createElement("div",{...r,className:"lk-chat"},h.createElement("div",{className:"lk-chat-header"},"Messages",d&&h.createElement(gu,{className:"lk-close-button"},h.createElement(L0,null))),h.createElement("ul",{className:"lk-list lk-chat-messages",ref:s},r.children?c.map((g,m)=>hu(r.children,{entry:g,key:g.id??m,messageFormatter:n})):c.map((g,m,k)=>{const b=m>=1&&k[m-1].from===g.from,w=m>=1&&g.timestamp-k[m-1].timestamp<6e4;return h.createElement(wb,{key:g.id??m,hideName:b,hideTimestamp:b===!1?!1:w,entry:g,messageFormatter:n})})),h.createElement("form",{className:"lk-chat-form",onSubmit:p},h.createElement("input",{className:"lk-form-control lk-chat-form-input",disabled:u,ref:o,type:"text",placeholder:"Enter a message...",onInput:g=>g.stopPropagation(),onKeyDown:g=>g.stopPropagation(),onKeyUp:g=>g.stopPropagation()}),h.createElement("button",{type:"submit",className:"lk-button lk-chat-form-button",disabled:u},"Send")))}function xa({kind:n,initialSelection:e,onActiveDeviceChange:t,tracks:i,requestPermissions:r=!1,...s}){const[o,a]=h.useState(!1),[c,l]=h.useState([]),[u,d]=h.useState(!0),[f,p]=h.useState(r),g=(w,R)=>{j.debug("handle device change"),a(!1),t?.(w,R)},m=h.useRef(null),k=h.useRef(null);h.useLayoutEffect(()=>{o&&p(!0)},[o]),h.useLayoutEffect(()=>{let w;return m.current&&k.current&&(c||u)&&(w=Fg(m.current,k.current,(R,S)=>{k.current&&Object.assign(k.current.style,{left:`${R}px`,top:`${S}px`})})),d(!1),()=>{w?.()}},[m,k,c,u]);const b=h.useCallback(w=>{k.current&&w.target!==m.current&&o&&jg(k.current,w)&&a(!1)},[o,k,m]);return h.useEffect(()=>(document.addEventListener("click",b),()=>{document.removeEventListener("click",b)}),[b]),h.createElement(h.Fragment,null,h.createElement("button",{className:"lk-button lk-button-menu","aria-pressed":o,...s,onClick:()=>a(!o),ref:m},s.children),!s.disabled&&h.createElement("div",{className:"lk-device-menu",ref:k,style:{visibility:o?"visible":"hidden"}},n?h.createElement(gr,{initialSelection:e,onActiveDeviceChange:w=>g(n,w),onDeviceListChange:l,kind:n,track:i?.[n],requestPermissions:f}):h.createElement(h.Fragment,null,h.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),h.createElement(gr,{kind:"audioinput",onActiveDeviceChange:w=>g("audioinput",w),onDeviceListChange:l,track:i?.audioinput,requestPermissions:f}),h.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),h.createElement(gr,{kind:"videoinput",onActiveDeviceChange:w=>g("videoinput",w),onDeviceListChange:l,track:i?.videoinput,requestPermissions:f}))))}function Rb(){h.useEffect(()=>{n0()},[])}function _b({props:n}){const{dispatch:e,state:t}=ou().widget,i="lk-button lk-settings-toggle";return{mergedProps:h.useMemo(()=>nt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_settings"})},"aria-pressed":t!=null&&t.showSettings?"true":"false"}),[n,i,e,t])}}const Ib=h.forwardRef(function(n,e){const{mergedProps:t}=_b({props:n});return h.createElement("button",{ref:e,...t},n.children)}),xb=n=>{switch(n){case C.Source.Camera:return 1;case C.Source.Microphone:return 2;case C.Source.ScreenShare:return 3;default:return 0}};function Ob({variation:n,controls:e,saveUserChoices:t=!0,onDeviceError:i,...r}){var s;const[o,a]=h.useState(!1),c=jn();h.useEffect(()=>{var x,O;((x=c?.widget.state)==null?void 0:x.showChat)!==void 0&&a((O=c?.widget.state)==null?void 0:O.showChat)},[(s=c?.widget.state)==null?void 0:s.showChat]);const l=u0(`(max-width: ${o?1e3:760}px)`)?"minimal":"verbose";n??(n=l);const u={leave:!0,...e},d=v0();if(!d)u.camera=!1,u.chat=!1,u.microphone=!1,u.screenShare=!1;else{const x=O=>d.canPublish&&(d.canPublishSources.length===0||d.canPublishSources.includes(xb(O)));u.camera??(u.camera=x(C.Source.Camera)),u.microphone??(u.microphone=x(C.Source.Microphone)),u.screenShare??(u.screenShare=x(C.Source.ScreenShare)),u.chat??(u.chat=d.canPublishData&&e?.chat)}const f=h.useMemo(()=>n==="minimal"||n==="verbose",[n]),p=h.useMemo(()=>n==="textOnly"||n==="verbose",[n]),g=Hg(),[m,k]=h.useState(!1),b=h.useCallback(x=>{k(x)},[k]),w=pt({className:"lk-control-bar"},r),{saveAudioInputEnabled:R,saveVideoInputEnabled:S,saveAudioInputDeviceId:y,saveVideoInputDeviceId:T}=O0({preventSave:!t}),I=h.useCallback((x,O)=>O?R(x):null,[R]),D=h.useCallback((x,O)=>O?S(x):null,[S]);return h.createElement("div",{...w},u.microphone&&h.createElement("div",{className:"lk-button-group"},h.createElement(vr,{source:C.Source.Microphone,showIcon:f,onChange:I,onDeviceError:x=>i?.({source:C.Source.Microphone,error:x})},p&&"Microphone"),h.createElement("div",{className:"lk-button-group-menu"},h.createElement(xa,{kind:"audioinput",onActiveDeviceChange:(x,O)=>y(O??"default")}))),u.camera&&h.createElement("div",{className:"lk-button-group"},h.createElement(vr,{source:C.Source.Camera,showIcon:f,onChange:D,onDeviceError:x=>i?.({source:C.Source.Camera,error:x})},p&&"Camera"),h.createElement("div",{className:"lk-button-group-menu"},h.createElement(xa,{kind:"videoinput",onActiveDeviceChange:(x,O)=>T(O??"default")}))),u.screenShare&&g&&h.createElement(vr,{source:C.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:f,onChange:b,onDeviceError:x=>i?.({source:C.Source.ScreenShare,error:x})},p&&(m?"Stop screen share":"Share screen")),u.chat&&h.createElement(gu,null,f&&h.createElement(U0,null),p&&"Chat"),u.settings&&h.createElement(Ib,null,f&&h.createElement(j0,null),p&&"Settings"),u.leave&&h.createElement(A0,null,f&&h.createElement(B0,null),p&&"Leave"),h.createElement(Y0,null))}function Fb({chatMessageFormatter:n,chatMessageDecoder:e,chatMessageEncoder:t,SettingsComponent:i,...r}){var s,o;const[a,c]=h.useState({showChat:!1,unreadMessages:0,showSettings:!1}),l=h.useRef(null),u=mu([{source:C.Source.Camera,withPlaceholder:!0},{source:C.Source.ScreenShare,withPlaceholder:!1}],{updateOnlyOn:[P.ActiveSpeakersChanged],onlySubscribed:!1}),d=k=>{j.debug("updating widget state",k),c(k)},f=Yv(),p=u.filter(ae).filter(k=>k.publication.source===C.Source.ScreenShare),g=(s=S0(f))==null?void 0:s[0],m=u.filter(k=>!Dg(k,g));return h.useEffect(()=>{var k,b,w,R,S,y;if(p.some(T=>T.publication.isSubscribed)&&l.current===null?(j.debug("Auto set screen share focus:",{newScreenShareTrack:p[0]}),(b=(k=f.pin).dispatch)==null||b.call(k,{msg:"set_pin",trackReference:p[0]}),l.current=p[0]):l.current&&!p.some(T=>{var I,D;return T.publication.trackSid===((D=(I=l.current)==null?void 0:I.publication)==null?void 0:D.trackSid)})&&(j.debug("Auto clearing screen share focus."),(R=(w=f.pin).dispatch)==null||R.call(w,{msg:"clear_pin"}),l.current=null),g&&!ae(g)){const T=u.find(I=>I.participant.identity===g.participant.identity&&I.source===g.source);T!==g&&ae(T)&&((y=(S=f.pin).dispatch)==null||y.call(S,{msg:"set_pin",trackReference:T}))}},[p.map(k=>`${k.publication.trackSid}_${k.publication.isSubscribed}`).join(),(o=g?.publication)==null?void 0:o.trackSid,u]),Rb(),h.createElement("div",{className:"lk-video-conference",...r},Ug()&&h.createElement(Sb,{value:f,onWidgetChange:d},h.createElement("div",{className:"lk-video-conference-inner"},g?h.createElement("div",{className:"lk-focus-layout-wrapper"},h.createElement(db,null,h.createElement(kb,{tracks:m},h.createElement(is,null)),g&&h.createElement(hb,{trackRef:g}))):h.createElement("div",{className:"lk-grid-layout-wrapper"},h.createElement(mb,{tracks:u},h.createElement(is,null))),h.createElement(Ob,{controls:{chat:!0,settings:!!i}})),h.createElement(Pb,{style:{display:a.showChat?"grid":"none"},messageFormatter:n,messageEncoder:t,messageDecoder:e}),i&&h.createElement("div",{className:"lk-settings-menu-modal",style:{display:a.showSettings?"block":"none"}},h.createElement(i,null))),h.createElement(Tb,null),h.createElement(Eb,null))}export{W as C,j as L,Gs as O,P as R,C as T,Lb as W,Fb as a,mi as b,gl as c,Cr as d,Ub as i,Ab as s,gr as u,Ki as z};
