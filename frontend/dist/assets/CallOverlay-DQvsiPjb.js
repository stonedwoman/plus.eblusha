import{r as l,j}from"./vendor-query-D8-W16Rz.js";import{u as H,I as ae,r as I,F as oe,c as le,G as se}from"./index-BqJauJpv.js";import{W as ce,a as ie,z as ue,d as de}from"./index-CD81hMhF.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const f=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const r=await f(),A=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(A))return r;const o=[],h=[],g=[],C=(e,y)=>{const k=e.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(k)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(k)||/(back|rear)/.test(y.toLowerCase())?"back":"other"};r.forEach(e=>{if(e.kind!=="videoinput"){g.push(e);return}const y=C(e.label||"",e.deviceId||"");y==="front"?o.push(e):h.push(e)});const c=[];if(o.length>0&&c.push(o[0]),h.length>0&&c.push(h[0]),c.length===0&&r.some(e=>e.kind==="videoinput")){const e=r.find(y=>y.kind==="videoinput");e&&c.push(e)}return g.forEach(e=>{e.kind!=="videoinput"&&c.push(e)}),c},window.__eblushaEnumeratePatched=!0}function fe({conversationId:f,isGroup:r,onPeerDisconnected:A}){const p=ue(),o=de(),h=H(c=>c.session?.user),g=l.useRef(!1),C=l.useRef(!1);return l.useEffect(()=>{if(!p||!h)return;const c=()=>{g.current=!0,C.current=!1},e=()=>{g.current=!1,C.current=!1};return p.on("connected",c),p.on("disconnected",e),()=>{p.off("connected",c),p.off("disconnected",e)}},[p,h]),l.useEffect(()=>{if(!p||!g.current||!h)return;const c=p.localParticipant;if(!c)return;const e=o.filter(y=>{if(y.identity===c.identity||y.sid===c.sid)return!1;try{return(y.metadata?JSON.parse(y.metadata):{}).userId!==h.id}catch{return!0}});e.length>0&&(C.current=!0),e.length===0&&o.length>0&&p.state==="connected"&&C.current&&(r||o.length===1&&(console.log("[CallOverlay] Peer disconnected in 1:1 call, ending call"),C.current=!1,A()))},[o,p,h,r,A]),null}function we({open:f,conversationId:r,onClose:A,onMinimize:p,minimized:o=!1,initialVideo:h=!1,initialAudio:g=!0,peerAvatarUrl:C=null,avatarsByName:c={},avatarsById:e={},localUserId:y=null,isGroup:k=!1}){const[T,_]=l.useState(null),[M,W]=l.useState(null),[J,X]=l.useState(!g),[K,Q]=l.useState(!!h),[he,Y]=l.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[B,N]=l.useState(!1),q=H(t=>t.session?.user),O=l.useRef(!1),P=l.useMemo(()=>q?.avatarUrl??null,[q?.avatarUrl]),U=l.useCallback(()=>{if(O.current||(O.current=!0),r&&k){try{ae(r)}catch(t){console.error("Error leaving call room:",t)}try{I([r])}catch(t){console.error("Error requesting call status update:",t)}}A()},[r,k,A]),Z=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
  `;if(l.useEffect(()=>{let t=!0;async function b(){if(!f||!r)return;const w=`conv-${r}`,E=await le.post("/livekit/token",{room:w,participantMetadata:{app:"eblusha",userId:q?.id,displayName:q?.displayName??q?.username,avatarUrl:P}});t&&(_(E.data.token),W(E.data.url))}return b(),()=>{t=!1,_(null),W(null)}},[f,r]),l.useEffect(()=>{f&&(Q(!!h),X(!g),N(!1))},[f,h,g]),l.useEffect(()=>{if(!f)return;if(typeof window<"u"&&window.innerWidth<=768){const b=document.body.style.overflow,w=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=b,document.body.style.touchAction=w}}},[f]),l.useEffect(()=>{f||(O.current=!1)},[f]),l.useEffect(()=>{const t=()=>Y(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),l.useEffect(()=>{if(!f)return;const t=document.body;if(!t)return;const b=()=>{t.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(n=>{const i=n.getAttribute("aria-label")||n.getAttribute("title")||"";let s="";const u=i.toLowerCase();u.includes("microphone")?s=i.includes("mute")?"Выключить микрофон":"Включить микрофон":u.includes("camera")?s=i.includes("disable")||u.includes("off")?"Выключить камеру":"Включить камеру":u.includes("screen")?s=u.includes("stop")?"Остановить показ экрана":"Поделиться экраном":u.includes("flip")?s="Сменить камеру":u.includes("participants")?s="Участники":u.includes("settings")?s="Настройки":u.includes("leave")||u.includes("hang")?s="Выйти":u.includes("chat")&&(s="Чат"),s&&(n.setAttribute("aria-label",s),n.setAttribute("title",s))}),t.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(n=>{const i=n;i.style.display="none";try{i.remove()}catch{}});const R=t.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(R&&p){let n=R.querySelector(".eb-minimize-btn");if(!n){n=document.createElement("button"),n.className="eb-minimize-btn lk-button",n.setAttribute("aria-label","Свернуть"),n.setAttribute("title","Свернуть"),n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',n.style.cssText="display: flex; align-items: center; justify-content: center; background: var(--surface-100); color: var(--text-primary); border: 1px solid var(--surface-border); border-radius: 8px; padding: 8px; cursor: pointer; transition: background 0.2s ease;",n.onmouseenter=()=>{n.style.background="var(--surface-200)"},n.onmouseleave=()=>{n.style.background="var(--surface-100)"},n.onclick=s=>{s.stopPropagation(),p()};const i=R.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(i&&i.parentNode){if(!i.__ebLeaveBound){const s=()=>{setTimeout(()=>U(),0)};i.addEventListener("click",s),i.__ebLeaveBound=s}i.parentNode.insertBefore(n,i)}else R.appendChild(n)}}},w=new MutationObserver(()=>b());return w.observe(t,{childList:!0,subtree:!0,attributes:!0}),b(),()=>w.disconnect()},[f,p,U]),l.useEffect(()=>{if(!f)return;const t=document.body;if(!t)return;const b=c||{},w=e||{},E=y||null,F=P||null,R=u=>{let d=0;for(let a=0;a<u.length;a++)d=u.charCodeAt(a)+((d<<5)-d);return`hsl(${Math.abs(d)%360} 70% 45%)`},n=(u,d)=>{const L=R(d),a=u.trim().charAt(0).toUpperCase(),D=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${L}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${a}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(D)}`},i=()=>{t.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(d=>{const L=d.querySelector(".lk-participant-name, [data-lk-participant-name]"),a=d.querySelector(".lk-participant-placeholder");if(!L||!a)return;const D=d.getAttribute("data-lk-participant-identity")?d:d.querySelector("[data-lk-participant-identity]"),S=D?(D.getAttribute("data-lk-participant-identity")||"").trim():"";let x=(L.textContent||L.getAttribute("data-lk-participant-name")||"").trim();if(!x){const v=d.querySelector(".lk-participant-metadata");v?.textContent?.trim()&&(x=v.textContent.trim())}x||(x=S||"");const V=S?w[S]??null:null,$=Object.keys(b).find(v=>v.toLowerCase()===x.toLowerCase()),G=$?b[$]:null,ee=F,te=!!(d.hasAttribute("data-lk-local-participant")||d.hasAttribute("data-lk-local")||d.classList.contains("lk-local-participant")||d.querySelector(".lk-local-indicator")||/\b(you|вы)\b/i.test(x)||S&&E&&S===E);let ne=V??G??(te?ee||(E?w[E]??null:null):null);const re=n(x||S||"U",S||x||"U");a.querySelectorAll("svg").forEach(v=>v.remove()),a.querySelectorAll("svg").forEach(v=>v.style.display="none");let m=a.querySelector("img.eb-ph");m||(m=document.createElement("img"),m.className="eb-ph",a.appendChild(m)),m.src=ne||re,m.alt=x,m.style.width="auto",m.style.height="auto",m.style.maxWidth="85%",m.style.maxHeight="85%",m.style.objectFit="cover",m.style.borderRadius="50%",m.style.display="block",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.background="transparent",a.style.backgroundImage="none",a.style.color="transparent",a.style.fontSize="0",a.style.overflow="hidden";try{a.style.borderRadius="50%"}catch{}Array.from(a.childNodes).forEach(v=>{v.nodeType===Node.TEXT_NODE&&(v.textContent="")})})},s=new MutationObserver(i);return s.observe(t,{childList:!0,subtree:!0}),i(),()=>s.disconnect()},[f,c,e,y,P]),!f||!r||!T||!M)return null;const z=j.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:o?"transparent":"rgba(10,12,16,0.55)",backdropFilter:o?"none":"blur(4px) saturate(110%)",display:o?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:o?"none":"auto"},children:j.jsxs("div",{"data-lk-theme":"default",style:{width:o?0:"90vw",height:o?0:"80vh",maxWidth:o?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:o?"none":"var(--shadow-sharp)",opacity:o?0:1,visibility:o?"hidden":"visible"},className:"call-container",children:[j.jsx("style",{children:Z}),j.jsxs(ce,{serverUrl:M,token:T,connect:!0,video:K,audio:!J,onConnected:()=>{N(!0);try{r&&k&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:r,video:h}),se(r,h),I([r]))}catch(t){console.error("Error joining call room:",t)}},onDisconnected:t=>{console.log("[CallOverlay] onDisconnected:",t,"wasConnected:",B,"isGroup:",k);const b=B;N(!1),b?U():k||U()},children:[j.jsx(fe,{conversationId:r,isGroup:k,onPeerDisconnected:()=>{U()}}),j.jsx("div",{style:{width:"100%",height:"100%"},children:j.jsx(ie,{})})]})]})});return oe.createPortal(z,document.body)}export{we as CallOverlay};
