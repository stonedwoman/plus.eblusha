const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-C0eo98lY.js","assets/index-DNIsCwDY.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/web-DwVm1pDb.js","assets/incoming-call-plugin.web-CpUrBxE1.js"])))=>i.map(i=>d[i]);
import{l as A}from"./vendor-socket-CA1CrNgP.js";import{r as k,_ as S,C as c}from"./index-DNIsCwDY.js";import"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-crypto-C7xP7Q7Y.js";class M{socket=null;wsUrl;accessToken=null;reconnectAttempts=0;maxReconnectAttempts=5;constructor(e){this.wsUrl=e}connect(e){if(this.socket?.connected){console.log("[SocketService] Already connected");return}this.accessToken=e,console.log("[SocketService] Connecting to:",this.wsUrl),console.log("[SocketService] Token length:",e?.length||0),this.socket=A(this.wsUrl,{autoConnect:!1,transports:["websocket","polling"],auth:{token:e},query:{token:e}}),this.setupEventHandlers(),this.socket.connect(),console.log("[SocketService] Connection initiated")}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.accessToken=null,this.reconnectAttempts=0}updateToken(e){this.accessToken=e,this.socket&&(this.socket.auth={token:e},this.socket.io.opts.query={token:e})}isConnected(){return this.socket?.connected??!1}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{console.log("[SocketService] ‚úÖ Connected successfully"),this.reconnectAttempts=0}),this.socket.on("disconnect",e=>{console.log("[SocketService] ‚ùå Disconnected:",e)}),this.socket.on("connect_error",e=>{console.error("[SocketService] ‚ùå Connection error:",e),console.error("[SocketService] Error message:",e.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&console.error("[SocketService] Max reconnect attempts reached")}),this.socket.io.on("reconnect_attempt",()=>{this.accessToken&&(this.socket.auth={token:this.accessToken},this.socket.io.opts.query={token:this.accessToken})}))}onMessageNew(e){return this.socket?(this.socket.on("message:new",e),()=>this.socket?.off("message:new",e)):()=>{}}onMessageNotify(e){return this.socket?(this.socket.on("message:notify",e),()=>this.socket?.off("message:notify",e)):()=>{}}onConversationTyping(e){return this.socket?(this.socket.on("conversation:typing",e),()=>this.socket?.off("conversation:typing",e)):()=>{}}onMessageReaction(e){return this.socket?(this.socket.on("message:reaction",e),()=>this.socket?.off("message:reaction",e)):()=>{}}onReceiptsUpdate(e){return this.socket?(this.socket.on("receipts:update",e),()=>this.socket?.off("receipts:update",e)):()=>{}}onConversationNew(e){return this.socket?(this.socket.on("conversations:new",e),()=>this.socket?.off("conversations:new",e)):()=>{}}onConversationUpdated(e){return this.socket?(this.socket.on("conversations:updated",e),()=>this.socket?.off("conversations:updated",e)):()=>{}}onConversationDeleted(e){return this.socket?(this.socket.on("conversations:deleted",e),()=>this.socket?.off("conversations:deleted",e)):()=>{}}onConversationMemberRemoved(e){return this.socket?(this.socket.on("conversations:member:removed",e),()=>this.socket?.off("conversations:member:removed",e)):()=>{}}onPresenceUpdate(e){return this.socket?(this.socket.on("presence:update",e),()=>this.socket?.off("presence:update",e)):()=>{}}onContactRequest(e){return this.socket?(this.socket.on("contacts:request:new",e),()=>this.socket?.off("contacts:request:new",e)):()=>{}}onContactAccepted(e){return this.socket?(this.socket.on("contacts:request:accepted",e),()=>this.socket?.off("contacts:request:accepted",e)):()=>{}}onContactRemoved(e){return this.socket?(this.socket.on("contacts:removed",e),()=>this.socket?.off("contacts:removed",e)):()=>{}}onProfileUpdate(e){return this.socket?(this.socket.on("profile:update",e),()=>this.socket?.off("profile:update",e)):()=>{}}onCallIncoming(e){return this.socket?(this.socket.on("call:incoming",e),()=>this.socket?.off("call:incoming",e)):()=>{}}onCallAccepted(e){return this.socket?(this.socket.on("call:accepted",e),()=>this.socket?.off("call:accepted",e)):()=>{}}onCallDeclined(e){return this.socket?(this.socket.on("call:declined",e),()=>this.socket?.off("call:declined",e)):()=>{}}onCallEnded(e){return this.socket?(this.socket.on("call:ended",e),()=>this.socket?.off("call:ended",e)):()=>{}}onCallStatus(e){return this.socket?(this.socket.on("call:status",e),()=>this.socket?.off("call:status",e)):()=>{}}onCallStatusBulk(e){return this.socket?(this.socket.on("call:status:bulk",e),()=>this.socket?.off("call:status:bulk",e)):()=>{}}emitConversationTyping(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:typing");return}this.socket.emit("conversation:typing",e)}emitCallInvite(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:invite");return}this.socket.emit("call:invite",e)}emitCallAccept(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:accept");return}this.socket.emit("call:accept",e)}emitCallDecline(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:decline");return}this.socket.emit("call:decline",e)}emitCallEnd(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:end");return}this.socket.emit("call:end",e)}emitCallRoomJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:join");return}this.socket.emit("call:room:join",e)}emitCallRoomLeave(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:leave");return}this.socket.emit("call:room:leave",e)}emitCallStatusRequest(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:status:request");return}this.socket.emit("call:status:request",e)}emitConversationJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:join");return}this.socket.emit("conversation:join",e)}}let g=null;function v(n){if(!g){if(!n)throw new Error("SocketService requires wsUrl for first initialization");g=new M(n)}return g}var w;(function(n){n[n.Sunday=1]="Sunday",n[n.Monday=2]="Monday",n[n.Tuesday=3]="Tuesday",n[n.Wednesday=4]="Wednesday",n[n.Thursday=5]="Thursday",n[n.Friday=6]="Friday",n[n.Saturday=7]="Saturday"})(w||(w={}));const u=k("LocalNotifications",{web:()=>S(()=>import("./web-C0eo98lY.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(n=>new n.LocalNotificationsWeb)}),b=k("App",{web:()=>S(()=>import("./web-DwVm1pDb.js"),__vite__mapDeps([7,1,2,3,4,5,6])).then(n=>new n.AppWeb)});class P{notificationIds=new Set;conversationNotifications=new Map;async initialize(){if(console.log("[NotificationService] üöÄ Initializing notification service..."),console.log("[NotificationService] Platform:",c.getPlatform()),console.log("[NotificationService] Is native:",c.isNativePlatform()),!c.isPluginAvailable("LocalNotifications")){console.error("[NotificationService] ‚ùå LocalNotifications plugin is not available on this platform");return}try{const e=await u.checkPermissions();if(console.log("[NotificationService] Current permission:",e.display),e.display!=="granted"){console.log("[NotificationService] Requesting notification permission...");const t=await u.requestPermissions();if(console.log("[NotificationService] Permission result:",t.display),t.display!=="granted"){console.warn("[NotificationService] ‚ùå Notification permission not granted");return}}console.log("[NotificationService] ‚úÖ Notification permission granted")}catch(e){console.error("[NotificationService] ‚ùå Error initializing notifications:",e);return}u.addListener("localNotificationActionPerformed",e=>{const t=e.notification.extra;t?.conversationId&&this.handleNotificationClick(t)}),b.addListener("appStateChange",e=>{e.isActive&&this.onAppBecameActive()})}async showMessageNotification(e,t,s,r){console.log("[NotificationService] üì® showMessageNotification called:",{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,messageText:t,senderName:s});const l=await b.getState();if(console.log("[NotificationService] App state:",l.isActive?"active":"background"),l.isActive){console.log("[NotificationService] App is active, skipping notification");return}const f=Date.now()%2147483647,o=e.conversationId,i=this.conversationNotifications.get(o);if(i){await this.updateConversationNotification(i,o,t||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",s||"–ö—Ç–æ-—Ç–æ",r);return}const a=s||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",h=t||"–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";console.log("[NotificationService] üì§ Scheduling notification:",{notificationId:f,title:a,body:h,conversationId:o});const p=c.isPluginAvailable("LocalNotifications"),d=c.Plugins||{},I="LocalNotifications"in d;if(console.log("[NotificationService] Plugin available check (isPluginAvailable):",p),console.log("[NotificationService] Plugin available check (in Plugins):",I),console.log("[NotificationService] Available plugins:",Object.keys(d)),console.log("[NotificationService] LocalNotifications plugin object:",d.LocalNotifications),!p&&!I){console.error("[NotificationService] ‚ùå LocalNotifications plugin is not available"),console.error("[NotificationService] Platform:",c.getPlatform()),console.error("[NotificationService] Is native:",c.isNativePlatform());return}try{console.log("[NotificationService] Attempting to schedule notification..."),await(d.LocalNotifications||u).schedule({notifications:[{title:a,body:h,id:f,sound:"notify.mp3",attachments:r?[{id:"avatar",url:r}]:void 0,extra:{conversationId:o,messageId:e.messageId,senderId:e.senderId,avatarUrl:r},actionTypeId:"MESSAGE",group:`conversation_${o}`,groupSummary:!1}]}),console.log("[NotificationService] ‚úÖ Notification scheduled successfully"),this.notificationIds.add(f),this.conversationNotifications.set(o,f)}catch(N){console.error("[NotificationService] ‚ùå Error scheduling notification:",N)}}async updateConversationNotification(e,t,s,r,l){await u.schedule({notifications:[{title:r,body:s,id:e,sound:void 0,extra:{conversationId:t,senderId:void 0,avatarUrl:l},actionTypeId:"MESSAGE",group:`conversation_${t}`,groupSummary:!1}]})}async showIncomingCallNotification(e,t,s,r){const l=Date.now()%2147483647,f=s?"–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫":"–∑–≤–æ–Ω–æ–∫";return await u.schedule({notifications:[{title:`–í—Ö–æ–¥—è—â–∏–π ${f}`,body:`${t} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`,id:l,sound:"ring.mp3",ongoing:!0,extra:{conversationId:e,callType:s?"video":"audio",callerName:t,avatarUrl:r},actionTypeId:"INCOMING_CALL"}]}),this.notificationIds.add(l),l}async cancelCallNotification(e){await u.cancel({notifications:[{id:e}]}),this.notificationIds.delete(e)}async cancelConversationNotifications(e){const t=this.conversationNotifications.get(e);t&&(await u.cancel({notifications:[{id:t}]}),this.notificationIds.delete(t),this.conversationNotifications.delete(e))}async clearAll(){const e=Array.from(this.notificationIds);e.length>0&&await u.cancel({notifications:e.map(t=>({id:t}))}),this.notificationIds.clear(),this.conversationNotifications.clear()}handleNotificationClick(e){console.log("[NotificationService] Notification clicked:",e)}onAppBecameActive(){console.log("[NotificationService] App became active")}}let m=null;function C(){return m||(m=new P),m}class H{socketService=v();notificationService=C();callbacks;typingTimers=new Map;constructor(e){this.callbacks=e}initialize(){console.log("[MessageHandler] üöÄ Initializing message handlers...");const e=[],t=this.socketService.onMessageNew(async o=>{console.log("[MessageHandler] üì® message:new:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(t);const s=this.socketService.onMessageNotify(async o=>{console.log("[MessageHandler] üîî message:notify:",o);const i=this.callbacks.isConversationActive?.(o.conversationId)??!1;i||await this.handleMessageNotification(o),i&&o.message&&this.callbacks.onMessageReceived?.(o),this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(s);const r=this.socketService.onConversationTyping(o=>{console.log("[MessageHandler] conversation:typing:",o);const i=`${o.conversationId}_${o.userId}`,a=this.typingTimers.get(i);if(a&&clearTimeout(a),o.typing){this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!0);const h=setTimeout(()=>{this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(i)},2e3);this.typingTimers.set(i,h)}else this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(i)});e.push(r);const l=this.socketService.onMessageReaction(async o=>{console.log("[MessageHandler] message:reaction:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?o.message&&this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(l);const f=this.socketService.onReceiptsUpdate(o=>{console.log("[MessageHandler] receipts:update:",o),this.callbacks.isConversationActive?.(o.conversationId)});return e.push(f),console.log("[MessageHandler] ‚úÖ All handlers subscribed, total:",e.length),()=>{console.log("[MessageHandler] Unsubscribing all handlers"),e.forEach(o=>o()),this.typingTimers.forEach(o=>clearTimeout(o)),this.typingTimers.clear()}}async handleMessageNotification(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);let s="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";e.message&&(e.message.content?s=e.message.content:e.message.attachments?.length&&(e.message.attachments[0].type==="IMAGE"?s="üì∑ –§–æ—Ç–æ":s="üìé –§–∞–π–ª")),await this.notificationService.showMessageNotification(e,s,t?.senderName||t?.title,t?.avatarUrl)}catch(t){console.error("[MessageHandler] Error handling message notification:",t)}}sendTyping(e,t){this.socketService.emitConversationTyping({conversationId:e,typing:t})}}const T=k("IncomingCall",{web:()=>S(()=>import("./incoming-call-plugin.web-CpUrBxE1.js"),__vite__mapDeps([8,1,2,3,4,5,6])).then(n=>new n.IncomingCallWeb)});class E{socketService=v();notificationService=C();callbacks;activeIncomingCalls=new Map;callNotificationIds=new Map;autoDeclineTimers=new Map;constructor(e){this.callbacks=e}initialize(){const e=[],t=this.socketService.onCallIncoming(async i=>{console.log("[CallHandler] üìû call:incoming:",i),this.activeIncomingCalls.set(i.conversationId,i),await this.handleIncomingCall(i);const a=setTimeout(()=>{console.log("[CallHandler] Auto-declining call after 25 seconds"),this.declineCall(i.conversationId)},25e3);this.autoDeclineTimers.set(i.conversationId,a),this.callbacks.onIncomingCall?.(i)});e.push(t);const s=this.socketService.onCallAccepted(i=>{console.log("[CallHandler] call:accepted:",i);const a=this.autoDeclineTimers.get(i.conversationId);a&&(clearTimeout(a),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallAccepted?.(i)});e.push(s);const r=this.socketService.onCallDeclined(i=>{console.log("[CallHandler] call:declined:",i);const a=this.autoDeclineTimers.get(i.conversationId);a&&(clearTimeout(a),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallDeclined?.(i)});e.push(r);const l=this.socketService.onCallEnded(i=>{console.log("[CallHandler] call:ended:",i);const a=this.autoDeclineTimers.get(i.conversationId);a&&(clearTimeout(a),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallEnded?.(i)});e.push(l);const f=this.socketService.onCallStatus(i=>{console.log("[CallHandler] call:status:",i),this.callbacks.onCallStatusUpdate?.(i.conversationId,i)});e.push(f);const o=this.socketService.onCallStatusBulk(i=>{console.log("[CallHandler] call:status:bulk:",i);for(const[a,h]of Object.entries(i.statuses))this.callbacks.onCallStatusUpdate?.(a,h)});return e.push(o),()=>{e.forEach(i=>i()),this.autoDeclineTimers.forEach(i=>clearTimeout(i)),this.autoDeclineTimers.clear()}}async handleIncomingCall(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId),s=await this.notificationService.showIncomingCallNotification(e.conversationId,e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",e.video,t?.avatarUrl);this.callNotificationIds.set(e.conversationId,s),await this.openIncomingCallScreen(e)}catch(t){console.error("[CallHandler] Error handling incoming call:",t)}}async openIncomingCallScreen(e){if(c.isNativePlatform())try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);await T.showIncomingCall({conversationId:e.conversationId,callerName:e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",isVideo:e.video,avatarUrl:t?.avatarUrl})}catch(t){console.error("[CallHandler] Error opening incoming call screen:",t)}}async closeIncomingCallScreen(e){const t=this.callNotificationIds.get(e);if(t&&(await this.notificationService.cancelCallNotification(t),this.callNotificationIds.delete(e)),this.activeIncomingCalls.delete(e),c.isNativePlatform())try{await T.closeIncomingCall()}catch(s){console.error("[CallHandler] Error closing incoming call screen:",s)}}acceptCall(e,t){if(!this.activeIncomingCalls.get(e)){console.warn("[CallHandler] No active incoming call for:",e);return}const r=this.autoDeclineTimers.get(e);r&&(clearTimeout(r),this.autoDeclineTimers.delete(e)),this.socketService.emitCallAccept({conversationId:e,video:t}),this.closeIncomingCallScreen(e)}declineCall(e){const t=this.autoDeclineTimers.get(e);t&&(clearTimeout(t),this.autoDeclineTimers.delete(e)),this.socketService.emitCallDecline({conversationId:e}),this.closeIncomingCallScreen(e)}endCall(e){this.socketService.emitCallEnd({conversationId:e})}joinCallRoom(e,t){this.socketService.emitCallRoomJoin({conversationId:e,video:t})}leaveCallRoom(e){this.socketService.emitCallRoomLeave({conversationId:e})}requestCallStatuses(e){this.socketService.emitCallStatusRequest({conversationIds:e})}}typeof window<"u"&&c.isNativePlatform()?(console.log("[Capacitor] ‚úÖ Native platform detected, initializing services..."),console.log("[Capacitor] Platform:",c.getPlatform()),console.log("[Capacitor] Plugins:",c.Plugins?Object.keys(c.Plugins):"not loaded"),C().initialize().then(()=>{console.log("[Capacitor] ‚úÖ Notification service initialized successfully")}).catch(e=>{console.error("[Capacitor] ‚ùå Failed to initialize notification service:",e),console.error("[Capacitor] Error stack:",e?.stack)})):console.log("[Capacitor] Web platform detected, skipping native initialization");function U(n,e){if(console.log("[Capacitor] initializeSocketConnection called, isNative:",c.isNativePlatform()),!c.isNativePlatform()){console.warn("[Capacitor] initializeSocketConnection called on web platform");return}console.log("[Capacitor] Creating SocketService with URL:",n);const t=v(n);console.log("[Capacitor] Connecting socket with token length:",e?.length||0),t.connect(e)}function y(n){if(console.log("[Capacitor] initializeMessageHandlers called, isNative:",c.isNativePlatform()),!c.isNativePlatform())return console.warn("[Capacitor] initializeMessageHandlers called on web platform"),()=>{};console.log("[Capacitor] Creating MessageHandler");const t=new H(n).initialize();return console.log("[Capacitor] ‚úÖ MessageHandler initialized"),t}function q(n){return c.isNativePlatform()?new E(n).initialize():(console.warn("[Capacitor] initializeCallHandlers called on web platform"),()=>{})}function j(n){if(!c.isNativePlatform()){console.warn("[Capacitor] updateSocketToken called on web platform");return}v().updateToken(n)}export{C as getNotificationService,v as getSocketService,q as initializeCallHandlers,y as initializeMessageHandlers,U as initializeSocketConnection,j as updateSocketToken};
