import{r as c,j as S}from"./vendor-query-D8-W16Rz.js";import{u as re,M as ne,j as H,I as oe,c as le,K as se}from"./index-CTDysv5v.js";import{W as ie,a as ce}from"./index-BGpmfXXY.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const u=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const o=await u(),L=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(L))return o;const d=[],y=[],E=[],T=(r,m)=>{const k=r.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(k)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(k)||/(back|rear)/.test(m.toLowerCase())?"back":"other"};o.forEach(r=>{if(r.kind!=="videoinput"){E.push(r);return}const m=T(r.label||"",r.deviceId||"");m==="front"?d.push(r):y.push(r)});const b=[];if(d.length>0&&b.push(d[0]),y.length>0&&b.push(y[0]),b.length===0&&o.some(r=>r.kind==="videoinput")){const r=o.find(m=>m.kind==="videoinput");r&&b.push(r)}return E.forEach(r=>{r.kind!=="videoinput"&&b.push(r)}),b},window.__eblushaEnumeratePatched=!0}function ve({open:u,conversationId:o,onClose:L,onMinimize:q,minimized:d=!1,initialVideo:y=!1,initialAudio:E=!0,peerAvatarUrl:T=null,avatarsByName:b={},avatarsById:r={},localUserId:m=null,isGroup:k=!1}){const[_,M]=c.useState(null),[W,B]=c.useState(null),[I,K]=c.useState(!E),[X,J]=c.useState(!!y),[ue,Q]=c.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[F,D]=c.useState(!1),j=re(e=>e.session?.user),N=c.useRef(!1),O=c.useMemo(()=>j?.avatarUrl??null,[j?.avatarUrl]),R=c.useCallback(e=>{if(N.current||(N.current=!0),o&&k){try{ne(o)}catch(f){console.error("Error leaving call room:",f)}try{H([o])}catch(f){console.error("Error requesting call status update:",f)}}L(e)},[o,k,L]),Y=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
  `;if(c.useEffect(()=>{let e=!0;async function f(){if(!u||!o)return;const v=`conv-${o}`,w=await le.post("/livekit/token",{room:v,participantMetadata:{app:"eblusha",userId:j?.id,displayName:j?.displayName??j?.username,avatarUrl:O}});e&&(M(w.data.token),B(w.data.url))}return f(),()=>{e=!1,M(null),B(null)}},[u,o]),c.useEffect(()=>{u&&(J(!!y),K(!E),D(!1))},[u,y,E]),c.useEffect(()=>{if(!u)return;if(typeof window<"u"&&window.innerWidth<=768){const f=document.body.style.overflow,v=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=f,document.body.style.touchAction=v}}},[u]),c.useEffect(()=>{u||(N.current=!1)},[u]),c.useEffect(()=>{const e=()=>Q(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),c.useEffect(()=>{if(!u)return;const e=document.body;if(!e)return;const f=()=>{e.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(t=>{const l=t.getAttribute("aria-label")||t.getAttribute("title")||"";let n="";const s=l.toLowerCase();s.includes("microphone")?n=l.includes("mute")?"Выключить микрофон":"Включить микрофон":s.includes("camera")?n=l.includes("disable")||s.includes("off")?"Выключить камеру":"Включить камеру":s.includes("screen")?n=s.includes("stop")?"Остановить показ экрана":"Поделиться экраном":s.includes("flip")?n="Сменить камеру":s.includes("participants")?n="Участники":s.includes("settings")?n="Настройки":s.includes("leave")||s.includes("hang")?n="Выйти":s.includes("chat")&&(n="Чат"),n&&(t.setAttribute("aria-label",n),t.setAttribute("title",n))}),e.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(t=>{const l=t;l.style.display="none";try{l.remove()}catch{}});const C=e.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(C&&q){let t=C.querySelector(".eb-minimize-btn");if(!t){t=document.createElement("button"),t.className="eb-minimize-btn lk-button",t.setAttribute("aria-label","Свернуть"),t.setAttribute("title","Свернуть"),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',t.style.cssText="display: flex; align-items: center; justify-content: center; background: var(--surface-100); color: var(--text-primary); border: 1px solid var(--surface-border); border-radius: 8px; padding: 8px; cursor: pointer; transition: background 0.2s ease;",t.onmouseenter=()=>{t.style.background="var(--surface-200)"},t.onmouseleave=()=>{t.style.background="var(--surface-100)"},t.onclick=n=>{n.stopPropagation(),q()};const l=C.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(l&&l.parentNode){if(!l.__ebLeaveBound){const n=()=>{setTimeout(()=>R({manual:!0}),0)};l.addEventListener("click",n),l.__ebLeaveBound=n}l.parentNode.insertBefore(t,l)}else C.appendChild(t)}}},v=new MutationObserver(()=>f());return v.observe(e,{childList:!0,subtree:!0,attributes:!0}),f(),()=>v.disconnect()},[u,q,R]),c.useEffect(()=>{if(!u)return;const e=document.body;if(!e)return;const f=b||{},v=r||{},w=m||null,P=O||null,C=s=>{let i=0;for(let a=0;a<s.length;a++)i=s.charCodeAt(a)+((i<<5)-i);return`hsl(${Math.abs(i)%360} 70% 45%)`},t=(s,i)=>{const A=C(i),a=s.trim().charAt(0).toUpperCase(),U=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${A}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${a}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(U)}`},l=()=>{e.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(i=>{const A=i.querySelector(".lk-participant-name, [data-lk-participant-name]"),a=i.querySelector(".lk-participant-placeholder");if(!A||!a)return;const U=i.getAttribute("data-lk-participant-identity")?i:i.querySelector("[data-lk-participant-identity]"),x=U?(U.getAttribute("data-lk-participant-identity")||"").trim():"";let g=(A.textContent||A.getAttribute("data-lk-participant-name")||"").trim();if(!g){const p=i.querySelector(".lk-participant-metadata");p?.textContent?.trim()&&(g=p.textContent.trim())}g||(g=x||"");const z=x?v[x]??null:null,$=Object.keys(f).find(p=>p.toLowerCase()===g.toLowerCase()),G=$?f[$]:null,V=P,ee=!!(i.hasAttribute("data-lk-local-participant")||i.hasAttribute("data-lk-local")||i.classList.contains("lk-local-participant")||i.querySelector(".lk-local-indicator")||/\b(you|вы)\b/i.test(g)||x&&w&&x===w);let te=z??G??(ee?V||(w?v[w]??null:null):null);const ae=t(g||x||"U",x||g||"U");a.querySelectorAll("svg").forEach(p=>p.remove()),a.querySelectorAll("svg").forEach(p=>p.style.display="none");let h=a.querySelector("img.eb-ph");h||(h=document.createElement("img"),h.className="eb-ph",a.appendChild(h)),h.src=te||ae,h.alt=g,h.style.width="auto",h.style.height="auto",h.style.maxWidth="85%",h.style.maxHeight="85%",h.style.objectFit="cover",h.style.borderRadius="50%",h.style.display="block",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.background="transparent",a.style.backgroundImage="none",a.style.color="transparent",a.style.fontSize="0",a.style.overflow="hidden";try{a.style.borderRadius="50%"}catch{}Array.from(a.childNodes).forEach(p=>{p.nodeType===Node.TEXT_NODE&&(p.textContent="")})})},n=new MutationObserver(l);return n.observe(e,{childList:!0,subtree:!0}),l(),()=>n.disconnect()},[u,b,r,m,O]),!u||!o||!_||!W)return null;const Z=S.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:d?"transparent":"rgba(10,12,16,0.55)",backdropFilter:d?"none":"blur(4px) saturate(110%)",display:d?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:d?"none":"auto"},children:S.jsxs("div",{"data-lk-theme":"default",style:{width:d?0:"90vw",height:d?0:"80vh",maxWidth:d?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:d?"none":"var(--shadow-sharp)",opacity:d?0:1,visibility:d?"hidden":"visible"},className:"call-container",children:[S.jsx("style",{children:Y}),S.jsx(ie,{serverUrl:W,token:_,connect:!0,video:X,audio:!I,onConnected:()=>{D(!0);try{o&&k&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:o,video:y}),se(o,y),H([o]))}catch(e){console.error("Error joining call room:",e)}},onDisconnected:e=>{console.log("[CallOverlay] onDisconnected:",e,"wasConnected:",F,"isGroup:",k);const f=F;D(!1),f?R({manual:!1}):k||R({manual:!1})},children:S.jsx("div",{style:{width:"100%",height:"100%"},children:S.jsx(ce,{})})})]})});return oe.createPortal(Z,document.body)}export{ve as CallOverlay};
