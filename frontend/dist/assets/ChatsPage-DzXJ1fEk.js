const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-veLCMP6E.js","assets/index-BrU8mxfA.js","assets/vendor-query-CNP5Hy5J.js","assets/vendor-react-BcTlWpV0.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-GGjuBpPe.js","assets/index-E2TB4HJS.css","assets/index-BdT5Om9k.js","assets/index-DcBnOcQS.css"])))=>i.map(i=>d[i]);
import{e as gr,f as lo,g as _n,h as Xs,n as Bt,d as ne,i as uo,_ as pa,s as Me,u as mn,j as ho,k as Ys,o as fo,l as po,m as Gs,p as qs,q as Vs,t as go,v as mo,w as yo,x as xo,y as vo,z as bo,A as wo,B as jo,D as Co,E as So,F as ko,G as Io,H as Ro,I as Mo,J as Eo,K as Ao,L as fr,M as Ks,P as To,Q as Do,R as Lo,S as No,T as zo,U as Qs}from"./index-BrU8mxfA.js";import{r as o,j as e,c as On,d as Uo}from"./vendor-query-CNP5Hy5J.js";import"./vendor-react-BcTlWpV0.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-GGjuBpPe.js";const Ho=a=>a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),Po=a=>a.replace(/^([A-Z])|[\s-_]+(\w)/g,(l,h,x)=>x?x.toUpperCase():h.toLowerCase()),Js=a=>{const l=Po(a);return l.charAt(0).toUpperCase()+l.slice(1)},ga=(...a)=>a.filter((l,h,x)=>!!l&&l.trim()!==""&&x.indexOf(l)===h).join(" ").trim(),Wo=a=>{for(const l in a)if(l.startsWith("aria-")||l==="role"||l==="title")return!0};var Bo={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const Oo=o.forwardRef(({color:a="currentColor",size:l=24,strokeWidth:h=2,absoluteStrokeWidth:x,className:y="",children:C,iconNode:v,...I},z)=>o.createElement("svg",{ref:z,...Bo,width:l,height:l,stroke:a,strokeWidth:x?Number(h)*24/Number(l):h,className:ga("lucide",y),...!C&&!Wo(I)&&{"aria-hidden":"true"},...I},[...v.map(([q,O])=>o.createElement(q,O)),...Array.isArray(C)?C:[C]]));const pe=(a,l)=>{const h=o.forwardRef(({className:x,...y},C)=>o.createElement(Oo,{ref:C,iconNode:l,className:ga(`lucide-${Ho(Js(a))}`,`lucide-${a}`,x),...y}));return h.displayName=Js(a),h};const Fo=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],_o=pe("arrow-left",Fo);const $o=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],Xo=pe("bell-ring",$o);const Yo=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],Go=pe("check",Yo);const qo=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Zs=pe("circle-check-big",qo);const Vo=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],Ko=pe("circle-plus",Vo);const Qo=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],Xi=pe("cloud-upload",Qo);const Jo=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Zo=pe("copy",Jo);const ec=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],pr=pe("ellipsis-vertical",ec);const tc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],nc=pe("lock-open",tc);const rc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],ea=pe("lock",rc);const ic=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],Yi=pe("log-out",ic);const sc=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],ta=pe("maximize-2",sc);const ac=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],oc=pe("mic",ac);const cc=[["path",{d:"M5 12h14",key:"1ays0h"}]],lc=pe("minus",cc);const dc=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],uc=pe("paperclip",dc);const hc=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],Gi=pe("phone-off",hc);const fc=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],qi=pe("phone",fc);const pc=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],gc=pe("reply",pc);const mc=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],na=pe("rotate-ccw",mc);const yc=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],ra=pe("send",yc);const xc=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],ia=pe("square-pen",xc);const vc=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],bc=pe("square",vc);const wc=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],sa=pe("trash-2",wc);const jc=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],aa=pe("undo-2",jc);const Cc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],oa=pe("user-plus",Cc);const Sc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],kc=pe("users",Sc);const Ic=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],Vi=pe("video",Ic);const Rc=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],xt=pe("x",Rc);async function ca(a={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const l=a.audio!==!1,h=!!a.video;if(!l&&!h)return{ok:!0};const x={audio:l,video:h};let y=null;try{return y=await navigator.mediaDevices.getUserMedia(x),{ok:!0}}catch(C){return{ok:!1,error:C??new Error("Unknown media error")}}finally{y&&y.getTracks().forEach(C=>{try{C.stop()}catch{}})}}function si(a){return a??null}function Mc(a){let l=0;for(let v=0;v<a.length;v++)l=a.charCodeAt(v)+((l<<5)-l);const h=Math.abs(l),x=24+h%18-9,y=60+h%15,C=30+h%12;return`hsl(${x} ${y}% ${C}%)`}const Ec=3,Ki=[500,1500,3e3];function Ue({name:a,size:l=40,id:h=a,presence:x,avatarUrl:y}){const C=Mc(h),v=(a||"?").trim().charAt(0).toUpperCase(),I=!!y?.startsWith("emoji:"),z=I?y.slice(6):null,[q,O]=o.useState(!1),[_,ee]=o.useState(0),[ce,N]=o.useState(null),$=o.useRef(null),B=o.useMemo(()=>{if(!y||I)return y??null;if(y.startsWith("data:")||typeof window>"u")return y;const we=si(y);if(we&&we!==y)return we;try{if(y.startsWith("http://")||y.startsWith("https://"))return y;const Te=window.location,le=new URL(y,Te.origin);return le.host===Te.host&&le.protocol!==Te.protocol&&(le.protocol=Te.protocol),le.toString()}catch{return y}},[y,I]),me=o.useMemo(()=>{if(!x)return null;switch(x){case"ONLINE":case"IN_CALL":return"#22c55e";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[x]);o.useEffect(()=>{O(!1),ee(0),N(null),$.current&&(clearTimeout($.current),$.current=null)},[y]),o.useEffect(()=>{B&&!I&&N(B)},[B,I]);const Le=()=>{if(_<Ec&&B&&!I){const we=Ki[_]||Ki[Ki.length-1];$.current=setTimeout(()=>{try{if(B.startsWith("data:"))N(B);else{const Te=new URL(B);Te.searchParams.set("_retry",String(_+1)),Te.searchParams.set("_t",String(Date.now())),N(Te.toString())}ee(Te=>Te+1)}catch(Te){console.warn("[Avatar] Failed to parse URL for retry:",B,Te),N(B),ee(le=>le+1)}},we)}else O(!0)};o.useEffect(()=>()=>{$.current&&clearTimeout($.current)},[]);const he=ce&&!I&&!q;return e.jsxs("div",{style:{width:l,height:l,borderRadius:"50%",background:C,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[he?e.jsx("img",{src:ce,alt:a,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:Le,onLoad:()=>{_>0&&ee(0)}}):I?e.jsx("span",{style:{fontSize:Math.floor(l*.6)},children:z}):v,me&&e.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(l*.28)),height:Math.max(8,Math.floor(l*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:me}})]})}const Qi=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],Ji=[4,8,14],Ct=24,At=80;function Ac({open:a,image:l,onClose:h,onApply:x}){const[y,C]=o.useState(null),[v,I]=o.useState({width:0,height:0}),[z,q]=o.useState(1),[O,_]=o.useState({x:0,y:0}),[ee,ce]=o.useState({width:0,height:0}),[N,$]=o.useState({x:0,y:0,width:0,height:0}),[B,me]=o.useState("crop"),[Le,he]=o.useState(Qi[0]),[we,Te]=o.useState(Ji[1]),[le,et]=o.useState([]),[qe,at]=o.useState(null),[yn,ci]=o.useState(()=>typeof window<"u"&&window.innerWidth<=768),[ye,Lt]=o.useState(!1),ot=o.useRef(null),de=o.useRef(null),ct=o.useRef(null),W=o.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),Nt=o.useRef(null),xn=o.useRef(null),tt=o.useRef(null),He=a&&!!l&&!!y&&v.width>0&&v.height>0;o.useEffect(()=>{const g=()=>ci(window.innerWidth<=768);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]);const xr=async()=>{if(!y||!ct.current||ye)return;Lt(!0);const g=N.width/N.height,L=Math.max(N.x,O.x),R=Math.max(N.y,O.y),U=Math.min(N.x+N.width,O.x+ee.width),T=Math.min(N.y+N.height,O.y+ee.height),K=U-L,V=T-R,Y=y.naturalWidth/ee.width,ge=y.naturalHeight/ee.height;let ke=(L-O.x)*Y,Ie=(R-O.y)*ge,Ce=K*Y,Pe=V*ge;Ce/Pe>g?Ce=Pe*g:Pe=Ce/g;const k=y.naturalWidth,zt=y.naturalHeight;let De=Math.max(0,ke),bt=Math.max(0,Ie),fe=Math.max(1,Math.min(Ce,k-De)),We=Math.max(1,Math.min(Pe,zt-bt));const kt=fe/We;Math.abs(kt-g)>.01&&(kt>g?fe=We*g:We=fe/g,fe=Math.max(1,Math.min(fe,k-De)),We=Math.max(1,Math.min(We,zt-bt)));const lt=document.createElement("canvas"),nt=Math.max(1,Math.round(fe)),Be=Math.max(1,Math.round(We));lt.width=nt,lt.height=Be;const ue=lt.getContext("2d");if(!ue){Lt(!1);return}ue.drawImage(y,De,bt,fe,We,0,0,nt,Be);const rt=nt/K,dt=Be/V;ue.lineCap="round",ue.lineJoin="round";const Ut=[...le,...qe?[qe]:[]];for(const Ve of Ut){if(!Ve.points.length)continue;ue.strokeStyle=Ve.color,ue.lineWidth=Ve.size*((rt+dt)/2),ue.beginPath();const Ke=Ve.points[0],Oe=(Ke.x-L)*rt,je=(Ke.y-R)*dt;ue.moveTo(Oe,je);for(let $e=1;$e<Ve.points.length;$e++){const ut=Ve.points[$e];ue.lineTo((ut.x-L)*rt,(ut.y-R)*dt)}ue.stroke()}const _e=new Image;_e.src=lt.toDataURL(),await new Promise(Ve=>{_e.onload=()=>{C(_e);const Ke=_e.naturalWidth/_e.naturalHeight;let Oe,je;if(yn){const xe=window.innerWidth,on=window.innerHeight-200-60,Je=xe;Ke>Je/on?(Oe=Je,je=Je/Ke):(je=on,Oe=on*Ke)}else{const xe=Math.min(window.innerWidth-64,720),Ee=Math.min(window.innerHeight-200,520);Ke>xe/Ee?(Oe=Math.max(280,xe),je=Oe/Ke):(je=Math.max(220,Ee),Oe=je*Ke)}I({width:Oe,height:je});const $e=Oe/_e.naturalWidth;q($e),ce({width:Oe,height:je}),_({x:0,y:0});const ut=2,Ft=Math.max(At,Oe-ut*2),_t=Math.max(At,je-ut*2);$({x:ut,y:ut,width:Ft,height:_t});const $t=Oe/nt,Yn=je/Be,vr=Ut.map(xe=>({...xe,points:xe.points.map(Ee=>{const Cn=(Ee.x-L)*rt,qn=(Ee.y-R)*dt,on=Cn*$t,Je=qn*Yn;return{x:on,y:Je}})}));et(vr.filter(xe=>xe.points.every(Ee=>Ee.x>=0&&Ee.x<=Oe&&Ee.y>=0&&Ee.y<=je))),at(null),setTimeout(()=>{vn()},0);const jn=performance.now(),Xt=300,Gn=xe=>{const Ee=xe-jn;Math.min(Ee/Xt,1)<1?tt.current=requestAnimationFrame(Gn):(Lt(!1),tt.current=null,setTimeout(()=>{vn()},0))};tt.current=requestAnimationFrame(Gn),Ve()}})};o.useEffect(()=>()=>{tt.current&&cancelAnimationFrame(tt.current)},[]),o.useEffect(()=>{if(!a||!l){C(null),et([]),at(null),Lt(!1);return}const g=new Image;return g.crossOrigin="anonymous",g.onload=()=>{if(C(g),yn){const L=window.innerWidth,K=window.innerHeight-200-60,V=L;let Y=g.naturalWidth,ge=g.naturalHeight;const ke=V/Y,Ie=K/ge,Ce=Math.min(ke,Ie);Y=g.naturalWidth*Ce,ge=g.naturalHeight*Ce,I({width:V,height:K}),q(Ce),ce({width:Y,height:ge});const Pe={x:(V-Y)/2,y:(K-ge)/2};_(Pe);const vt=2;$({x:vt,y:vt,width:V-vt*2,height:K-vt*2})}else{const L=Math.min(window.innerWidth-64,720),R=Math.min(window.innerHeight-200,520);let U=g.naturalWidth,T=g.naturalHeight;if(U>L){const Ie=L/U;U*=Ie,T*=Ie}if(T>R){const Ie=R/T;U*=Ie,T*=Ie}U=Math.max(280,U),T=Math.max(220,T),I({width:U,height:T});const K=Math.max(U/g.naturalWidth,T/g.naturalHeight);q(K);const V=g.naturalWidth*K,Y=g.naturalHeight*K;ce({width:V,height:Y});const ge={x:(U-V)/2,y:(T-Y)/2};_(ge);const ke=2;$({x:ke,y:ke,width:U-ke*2,height:T-ke*2})}et([]),at(null),me("crop"),Lt(!1)},g.src=l.previewUrl,xn.current=()=>{g.src=""},()=>{xn.current?.(),xn.current=null}},[a,l?.id,l?.previewUrl,yn]),o.useEffect(()=>{a||(et([]),at(null),Lt(!1))},[a]);const vn=()=>{const g=de.current;if(!g||v.width===0||v.height===0)return;const L=g.getContext("2d");if(!L)return;const R=window.devicePixelRatio||1;(g.width!==v.width*R||g.height!==v.height*R)&&(g.width=v.width*R,g.height=v.height*R,g.style.width=`${v.width}px`,g.style.height=`${v.height}px`),L.save(),L.scale(R,R),L.clearRect(0,0,v.width,v.height);const U=qe?[...le,qe]:le;L.lineCap="round",L.lineJoin="round";for(const T of U)if(T.points.length!==0){L.strokeStyle=T.color,L.lineWidth=T.size,L.beginPath(),L.moveTo(T.points[0].x,T.points[0].y);for(let K=1;K<T.points.length;K++)L.lineTo(T.points[K].x,T.points[K].y);L.stroke()}L.restore()};o.useEffect(()=>{vn()},[le,qe,v.width,v.height]),o.useEffect(()=>{const g=L=>{a&&L.key==="Escape"&&(L.preventDefault(),h())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[a,h]);const li=(g,L,R)=>{const T=Ct/2;return Math.abs(g-R.x)<T&&Math.abs(L-R.y)<T?"nw":Math.abs(g-(R.x+R.width))<T&&Math.abs(L-R.y)<T?"ne":Math.abs(g-R.x)<T&&Math.abs(L-(R.y+R.height))<T?"sw":Math.abs(g-(R.x+R.width))<T&&Math.abs(L-(R.y+R.height))<T?"se":Math.abs(g-R.x)<T&&L>=R.y&&L<=R.y+R.height?"w":Math.abs(g-(R.x+R.width))<T&&L>=R.y&&L<=R.y+R.height?"e":Math.abs(L-R.y)<T&&g>=R.x&&g<=R.x+R.width?"n":Math.abs(L-(R.y+R.height))<T&&g>=R.x&&g<=R.x+R.width?"s":g>=R.x&&g<=R.x+R.width&&L>=R.y&&L<=R.y+R.height?"move":null},tn=g=>{const K=v.width-2,V=v.height-2,Y=Math.max(2,Math.min(K-g.width,g.x)),ge=Math.max(2,Math.min(V-g.height,g.y)),ke=Math.max(At,Math.min(K-Y,g.width)),Ie=Math.max(At,Math.min(V-ge,g.height));return{x:Y,y:ge,width:ke,height:Ie}},di=g=>{if(B!=="crop"||ye||!ot.current)return;g.preventDefault();const L=ot.current.getBoundingClientRect(),R=g.clientX-L.left,U=g.clientY-L.top,T=li(R,U,N);T&&(ot.current.setPointerCapture(g.pointerId),W.current={type:T==="move"?"move":"resize",handle:T!=="move"?T:void 0,startX:g.clientX,startY:g.clientY,initial:{...N}})},ui=g=>{if(B!=="crop"||!W.current.type||ye||(g.preventDefault(),!ot.current?.getBoundingClientRect()))return;const R=g.clientX-W.current.startX,U=g.clientY-W.current.startY,T=R,K=U;if(W.current.type==="move"){const V={x:W.current.initial.x+T,y:W.current.initial.y+K,width:W.current.initial.width,height:W.current.initial.height};$(tn(V))}else if(W.current.type==="resize"&&W.current.handle){const V=W.current.handle;let Y={...W.current.initial};V==="nw"?(Y.x=W.current.initial.x+T,Y.y=W.current.initial.y+K,Y.width=W.current.initial.width-T,Y.height=W.current.initial.height-K):V==="ne"?(Y.y=W.current.initial.y+K,Y.width=W.current.initial.width+T,Y.height=W.current.initial.height-K):V==="sw"?(Y.x=W.current.initial.x+T,Y.width=W.current.initial.width-T,Y.height=W.current.initial.height+K):V==="se"?(Y.width=W.current.initial.width+T,Y.height=W.current.initial.height+K):V==="n"?(Y.y=W.current.initial.y+K,Y.height=W.current.initial.height-K):V==="s"?Y.height=W.current.initial.height+K:V==="w"?(Y.x=W.current.initial.x+T,Y.width=W.current.initial.width-T):V==="e"&&(Y.width=W.current.initial.width+T),Y.width<At&&((V==="nw"||V==="w"||V==="sw")&&(Y.x=W.current.initial.x+W.current.initial.width-At),Y.width=At),Y.height<At&&((V==="nw"||V==="n"||V==="ne")&&(Y.y=W.current.initial.y+W.current.initial.height-At),Y.height=At),$(tn(Y))}},nn=async g=>{const L=W.current.type!==null;W.current.type&&ot.current?.hasPointerCapture(g.pointerId)&&ot.current.releasePointerCapture(g.pointerId),W.current.type=null,L&&B==="crop"&&!ye&&await xr()},rn=g=>{if(B!=="draw"||!de.current||ye)return;g.preventDefault();const L=de.current.getBoundingClientRect(),R={x:g.clientX-L.left,y:g.clientY-L.top},U={color:Le,size:we,points:[R]};Nt.current=g.pointerId,de.current.setPointerCapture(g.pointerId),at(U)},bn=g=>{if(B!=="draw"||Nt.current!==g.pointerId||!de.current)return;g.preventDefault();const L=de.current.getBoundingClientRect(),R={x:g.clientX-L.left,y:g.clientY-L.top};at(U=>!U||U.points.length&&U.points[U.points.length-1].x===R.x&&U.points[U.points.length-1].y===R.y?U:{...U,points:[...U.points,R]})},sn=g=>{B!=="draw"||Nt.current!==g.pointerId||(Nt.current=null,de.current?.hasPointerCapture(g.pointerId)&&de.current.releasePointerCapture(g.pointerId),at(L=>{if(!L)return null;if(L.points.length<2){const R={...L,points:[...L.points,L.points[0]]};et(U=>[...U,R])}else et(R=>[...R,L]);return null}))},an=()=>{et(g=>g.slice(0,-1))},wn=()=>{et([]),at(null)},$n=async()=>{if(!y||ye)return;const g=new Image;g.crossOrigin="anonymous",await new Promise(L=>{g.onload=()=>{if(C(g),yn){const R=window.innerWidth,V=window.innerHeight-200-60,Y=R;let ge=g.naturalWidth,ke=g.naturalHeight;const Ie=Y/ge,Ce=V/ke,Pe=Math.min(Ie,Ce),vt=ge*Pe,k=ke*Pe;I({width:Y,height:V}),q(Pe),ce({width:vt,height:k});const zt={x:(Y-vt)/2,y:(V-k)/2};_(zt);const De=2;$({x:De,y:De,width:Y-De*2,height:V-De*2})}else{const R=Math.min(window.innerWidth-64,720),U=Math.min(window.innerHeight-200,520);let T=g.naturalWidth,K=g.naturalHeight;if(T>R){const Ce=R/T;T*=Ce,K*=Ce}if(K>U){const Ce=U/K;T*=Ce,K*=Ce}T=Math.max(280,T),K=Math.max(220,K),I({width:T,height:K});const V=Math.max(T/g.naturalWidth,K/g.naturalHeight);q(V);const Y=g.naturalWidth*V,ge=g.naturalHeight*V;ce({width:Y,height:ge});const ke={x:(T-Y)/2,y:(K-ge)/2};_(ke);const Ie=2;$({x:Ie,y:Ie,width:T-Ie*2,height:K-Ie*2})}et([]),at(null),L()},g.src=l.previewUrl})},Ot=async()=>{if(!l||!y)return;const g=N.width/N.height,L=Math.max(N.x,O.x),R=Math.max(N.y,O.y),U=Math.min(N.x+N.width,O.x+ee.width),T=Math.min(N.y+N.height,O.y+ee.height),K=U-L,V=T-R,Y=y.naturalWidth/ee.width,ge=y.naturalHeight/ee.height,ke=(L-O.x)*Y,Ie=(R-O.y)*ge;let Ce=K*Y,Pe=V*ge;Ce/Pe>g?Ce=Pe*g:Pe=Ce/g;const k=y.naturalWidth,zt=y.naturalHeight;let De=Math.max(0,ke),bt=Math.max(0,Ie),fe=Math.max(1,Math.min(Ce,k-De)),We=Math.max(1,Math.min(Pe,zt-bt));const kt=fe/We;Math.abs(kt-g)>.01&&(kt>g?fe=We*g:We=fe/g,fe=Math.max(1,Math.min(fe,k-De)),We=Math.max(1,Math.min(We,zt-bt)));const lt=Math.max(1,Math.round(fe)),nt=Math.max(1,Math.round(We)),Be=document.createElement("canvas");Be.width=lt,Be.height=nt;const ue=Be.getContext("2d");if(!ue)return;ue.drawImage(y,De,bt,fe,We,0,0,lt,nt);const rt=lt/K,dt=nt/V,Ut=[...le,...qe?[qe]:[]];ue.lineCap="round",ue.lineJoin="round";for(const je of Ut){if(!je.points.length)continue;ue.strokeStyle=je.color,ue.lineWidth=je.size*((rt+dt)/2),ue.beginPath();const $e=je.points[0],ut=($e.x-L)*rt,Ft=($e.y-R)*dt;ue.moveTo(ut,Ft);for(let _t=1;_t<je.points.length;_t++){const $t=je.points[_t];ue.lineTo(($t.x-L)*rt,($t.y-R)*dt)}ue.stroke()}const _e=await new Promise(je=>Be.toBlob($e=>je($e),"image/png",.96));if(!_e)return;const Ve=l.fileName?.replace(/\.[^.]+$/,"")||l.file.name.replace(/\.[^.]+$/,"")||"image",Ke=new File([_e],`${Ve}-edited.png`,{type:"image/png"}),Oe=URL.createObjectURL(_e);x({file:Ke,previewUrl:Oe})},St=()=>{if(B!=="crop"||ye)return null;const{x:g,y:L,width:R,height:U}=N,T={position:"absolute",width:Ct,height:Ct,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{...T,left:g-Ct/2,top:L-Ct/2,cursor:"nwse-resize"}}),e.jsx("div",{style:{...T,left:g+R-Ct/2,top:L-Ct/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...T,left:g-Ct/2,top:L+U-Ct/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...T,left:g+R-Ct/2,top:L+U-Ct/2,cursor:"nwse-resize"}})]})};if(!a||!l)return null;if(yn)return gr.createPortal(e.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[e.jsx("button",{onClick:h,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"}),e.jsx("button",{onClick:Ot,disabled:!He||ye,style:{background:!He||ye?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:He&&!ye?"pointer":"not-allowed"},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]}),e.jsxs("div",{ref:ot,onPointerDown:di,onPointerMove:ui,onPointerUp:nn,onPointerLeave:nn,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[y&&e.jsx("img",{src:y.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:O.x,top:O.y,width:ee.width,height:ee.height,userSelect:"none",pointerEvents:"none",transition:ye?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:de,style:{position:"absolute",inset:0,pointerEvents:B==="draw"?"auto":"none"},onPointerDown:rn,onPointerMove:bn,onPointerUp:sn,onPointerLeave:sn}),e.jsx("canvas",{ref:ct,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),B==="crop"&&!ye&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${N.x}px 100%,
                    ${N.x}px ${N.y}px,
                    ${N.x+N.width}px ${N.y}px,
                    ${N.x+N.width}px ${N.y+N.height}px,
                    ${N.x}px ${N.y+N.height}px,
                    ${N.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:N.x,top:N.y,width:N.width,height:N.height,border:"2px solid #fff",pointerEvents:"none"}}),St()]})]}),e.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>me("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:B==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{onClick:()=>me("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:B==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[e.jsx(ia,{size:18}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]})]}),e.jsxs("button",{onClick:$n,disabled:ye,style:{padding:"10px",borderRadius:10,border:"none",background:ye?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:ye?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:ye?"not-allowed":"pointer"},children:[e.jsx(na,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),B==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:Qi.map(g=>e.jsx("button",{onClick:()=>he(g),style:{width:40,height:40,borderRadius:"50%",border:Le===g?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:g,cursor:"pointer",flexShrink:0},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:Ji.map(g=>e.jsx("button",{onClick:()=>Te(g),style:{width:48,height:48,borderRadius:12,border:we===g?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:we===g?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Le,display:"inline-block"}})},g))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{onClick:an,disabled:le.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:le.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:le.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:le.length===0?"not-allowed":"pointer"},children:[e.jsx(aa,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"]}),e.jsx("button",{onClick:wn,disabled:le.length===0&&!qe,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:le.length===0&&!qe?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:le.length===0&&!qe?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:le.length===0&&!qe?"not-allowed":"pointer"},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ"})]})]})]})]}),document.body);const Xn=e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:e.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:l.fileName||l.file.name})]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:h,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€",children:e.jsx(xt,{size:18})})]}),e.jsxs("div",{ref:ot,onPointerDown:di,onPointerMove:ui,onPointerUp:nn,onPointerLeave:nn,style:{position:"relative",width:v.width,height:v.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:B==="crop"?"default":"crosshair"},children:[y&&e.jsx("img",{src:y.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:O.x,top:O.y,width:ee.width,height:ee.height,userSelect:"none",pointerEvents:"none",transition:ye?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:de,style:{position:"absolute",inset:0,pointerEvents:B==="draw"?"auto":"none"},onPointerDown:rn,onPointerMove:bn,onPointerUp:sn,onPointerLeave:sn}),e.jsx("canvas",{ref:ct,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),B==="crop"&&!ye&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${N.x}px 100%,
                    ${N.x}px ${N.y}px,
                    ${N.x+N.width}px ${N.y}px,
                    ${N.x+N.width}px ${N.y+N.height}px,
                    ${N.x}px ${N.y+N.height}px,
                    ${N.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:N.x,top:N.y,width:N.width,height:N.height,border:"2px solid #fff",pointerEvents:"none"}}),St()]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:B==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>me("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{className:B==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>me("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(ia,{size:16}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]}),e.jsxs("button",{className:"btn btn-ghost",onClick:$n,disabled:ye,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(na,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),B==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost",onClick:an,disabled:le.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(aa,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…"]}),e.jsx("button",{className:"btn btn-ghost",onClick:wn,disabled:le.length===0&&!qe,style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº"})]})]}),B==="draw"&&e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:Qi.map(g=>e.jsx("button",{onClick:()=>he(g),style:{width:28,height:28,borderRadius:"50%",border:Le===g?"2px solid #fff":"2px solid transparent",background:g,cursor:"pointer"},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:8},children:Ji.map(g=>e.jsx("button",{onClick:()=>Te(g),className:we===g?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Le,display:"inline-block"}})},g))})]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[e.jsx("button",{className:"btn btn-ghost",onClick:h,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsxs("button",{className:"btn btn-primary",onClick:Ot,disabled:!He||ye,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[e.jsx(Go,{size:16}),"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"]})]})]})});return gr.createPortal(Xn,document.body)}const Zi=lo(a=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:l=>a({incoming:l}),startOutgoing:(l,h)=>a({activeConvId:l,incoming:null,initialVideo:!!h,initialAudio:!0}),startIncoming:l=>a({incoming:l}),endCall:()=>a({activeConvId:null,incoming:null,initialVideo:!1})}));function Tc(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&a.constructor.name==="Uint8Array"}function rs(a){if(!Number.isSafeInteger(a)||a<0)throw new Error("positive integer expected, got "+a)}function oi(a,...l){if(!Tc(a))throw new Error("Uint8Array expected");if(l.length>0&&!l.includes(a.length))throw new Error("Uint8Array expected of length "+l+", got length="+a.length)}function is(a){if(typeof a!="function"||typeof a.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");rs(a.outputLen),rs(a.blockLen)}function ai(a,l=!0){if(a.destroyed)throw new Error("Hash instance has been destroyed");if(l&&a.finished)throw new Error("Hash#digest() has already been called")}function Dc(a,l){oi(a);const h=l.outputLen;if(a.length<h)throw new Error("digestInto() expects output buffer of length at least "+h)}function mr(...a){for(let l=0;l<a.length;l++)a[l].fill(0)}function es(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}function Tt(a,l){return a<<32-l|a>>>l}function Lc(a){if(typeof a!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(a))}function yr(a){return typeof a=="string"&&(a=Lc(a)),oi(a),a}class ma{}function Nc(a){const l=x=>a().update(yr(x)).digest(),h=a();return l.outputLen=h.outputLen,l.blockLen=h.blockLen,l.create=()=>a(),l}class ya extends ma{constructor(l,h){super(),this.finished=!1,this.destroyed=!1,is(l);const x=yr(h);if(this.iHash=l.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const y=this.blockLen,C=new Uint8Array(y);C.set(x.length>y?l.create().update(x).digest():x);for(let v=0;v<C.length;v++)C[v]^=54;this.iHash.update(C),this.oHash=l.create();for(let v=0;v<C.length;v++)C[v]^=106;this.oHash.update(C),mr(C)}update(l){return ai(this),this.iHash.update(l),this}digestInto(l){ai(this),oi(l,this.outputLen),this.finished=!0,this.iHash.digestInto(l),this.oHash.update(l),this.oHash.digestInto(l),this.destroy()}digest(){const l=new Uint8Array(this.oHash.outputLen);return this.digestInto(l),l}_cloneInto(l){l||(l=Object.create(Object.getPrototypeOf(this),{}));const{oHash:h,iHash:x,finished:y,destroyed:C,blockLen:v,outputLen:I}=this;return l=l,l.finished=y,l.destroyed=C,l.blockLen=v,l.outputLen=I,l.oHash=h._cloneInto(l.oHash),l.iHash=x._cloneInto(l.iHash),l}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const ss=(a,l,h)=>new ya(a,l).update(h).digest();ss.create=(a,l)=>new ya(a,l);function zc(a,l,h){return is(a),h===void 0&&(h=new Uint8Array(a.outputLen)),ss(a,yr(h),yr(l))}const ts=Uint8Array.from([0]),la=Uint8Array.of();function Uc(a,l,h,x=32){is(a),rs(x);const y=a.outputLen;if(x>255*y)throw new Error("Length should be <= 255*HashLen");const C=Math.ceil(x/y);h===void 0&&(h=la);const v=new Uint8Array(C*y),I=ss.create(a,l),z=I._cloneInto(),q=new Uint8Array(I.outputLen);for(let O=0;O<C;O++)ts[0]=O+1,z.update(O===0?la:q).update(h).update(ts).digestInto(q),v.set(q,y*O),I._cloneInto(z);return I.destroy(),z.destroy(),mr(q,ts),v.slice(0,x)}const Hc=(a,l,h,x,y)=>Uc(a,zc(a,l,h),x,y);function Pc(a,l,h,x){if(typeof a.setBigUint64=="function")return a.setBigUint64(l,h,x);const y=BigInt(32),C=BigInt(4294967295),v=Number(h>>y&C),I=Number(h&C),z=x?4:0,q=x?0:4;a.setUint32(l+z,v,x),a.setUint32(l+q,I,x)}function Wc(a,l,h){return a&l^~a&h}function Bc(a,l,h){return a&l^a&h^l&h}class Oc extends ma{constructor(l,h,x,y){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=l,this.outputLen=h,this.padOffset=x,this.isLE=y,this.buffer=new Uint8Array(l),this.view=es(this.buffer)}update(l){ai(this),l=yr(l),oi(l);const{view:h,buffer:x,blockLen:y}=this,C=l.length;for(let v=0;v<C;){const I=Math.min(y-this.pos,C-v);if(I===y){const z=es(l);for(;y<=C-v;v+=y)this.process(z,v);continue}x.set(l.subarray(v,v+I),this.pos),this.pos+=I,v+=I,this.pos===y&&(this.process(h,0),this.pos=0)}return this.length+=l.length,this.roundClean(),this}digestInto(l){ai(this),Dc(l,this),this.finished=!0;const{buffer:h,view:x,blockLen:y,isLE:C}=this;let{pos:v}=this;h[v++]=128,mr(this.buffer.subarray(v)),this.padOffset>y-v&&(this.process(x,0),v=0);for(let _=v;_<y;_++)h[_]=0;Pc(x,y-8,BigInt(this.length*8),C),this.process(x,0);const I=es(l),z=this.outputLen;if(z%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const q=z/4,O=this.get();if(q>O.length)throw new Error("_sha2: outputLen bigger than state");for(let _=0;_<q;_++)I.setUint32(4*_,O[_],C)}digest(){const{buffer:l,outputLen:h}=this;this.digestInto(l);const x=l.slice(0,h);return this.destroy(),x}_cloneInto(l){l||(l=new this.constructor),l.set(...this.get());const{blockLen:h,buffer:x,length:y,finished:C,destroyed:v,pos:I}=this;return l.destroyed=v,l.finished=C,l.length=y,l.pos=I,y%h&&l.buffer.set(x),l}clone(){return this._cloneInto()}}const Zt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Fc=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),en=new Uint32Array(64);class _c extends Oc{constructor(l=32){super(64,l,8,!1),this.A=Zt[0]|0,this.B=Zt[1]|0,this.C=Zt[2]|0,this.D=Zt[3]|0,this.E=Zt[4]|0,this.F=Zt[5]|0,this.G=Zt[6]|0,this.H=Zt[7]|0}get(){const{A:l,B:h,C:x,D:y,E:C,F:v,G:I,H:z}=this;return[l,h,x,y,C,v,I,z]}set(l,h,x,y,C,v,I,z){this.A=l|0,this.B=h|0,this.C=x|0,this.D=y|0,this.E=C|0,this.F=v|0,this.G=I|0,this.H=z|0}process(l,h){for(let _=0;_<16;_++,h+=4)en[_]=l.getUint32(h,!1);for(let _=16;_<64;_++){const ee=en[_-15],ce=en[_-2],N=Tt(ee,7)^Tt(ee,18)^ee>>>3,$=Tt(ce,17)^Tt(ce,19)^ce>>>10;en[_]=$+en[_-7]+N+en[_-16]|0}let{A:x,B:y,C,D:v,E:I,F:z,G:q,H:O}=this;for(let _=0;_<64;_++){const ee=Tt(I,6)^Tt(I,11)^Tt(I,25),ce=O+ee+Wc(I,z,q)+Fc[_]+en[_]|0,$=(Tt(x,2)^Tt(x,13)^Tt(x,22))+Bc(x,y,C)|0;O=q,q=z,z=I,I=v+ce|0,v=C,C=y,y=x,x=ce+$|0}x=x+this.A|0,y=y+this.B|0,C=C+this.C|0,v=v+this.D|0,I=I+this.E|0,z=z+this.F|0,q=q+this.G|0,O=O+this.H|0,this.set(x,y,C,v,I,z,q,O)}roundClean(){mr(en)}destroy(){this.set(0,0,0,0,0,0,0,0),mr(this.buffer)}}const $c=Nc(()=>new _c),Xc=$c,Yc=new TextEncoder,Gc=new TextDecoder;function yt(a){if(!a)return new Uint8Array;const l=a.replace(/-/g,"+").replace(/_/g,"/"),h=l.length%4===0?"":"=".repeat(4-l.length%4),x=atob(l+h),y=x.length,C=new Uint8Array(y);for(let v=0;v<y;v+=1)C[v]=x.charCodeAt(v);return C}function Fn(a){let l="";for(let h=0;h<a.length;h+=1)l+=String.fromCharCode(a[h]);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function da(a){return Yc.encode(a)}function qc(a){return Gc.decode(a)}const ua="eb_e2ee_sessions_v1";class Vc{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(l){return!!this.sessions[l]}getSession(l){return this.sessions[l]??null}async ensureSession(l){if(!l.isSecret||l.secretStatus!=="ACTIVE")return null;const h=this.sessions[l.id];if(h)return h;const x=_n(),y=Xs();if(!x||!y||!l.secretInitiatorDeviceId||!l.secretPeerDeviceId||!(l.secretInitiatorDeviceId===x.deviceId))return null;const v=l.secretPeerDeviceId;return v?this.createInitiatorSession(l,x.deviceId,v,y):null}processHandshakes(l,h){if(!l.isSecret||!h||h.length===0)return!1;const x=_n();if(!x)return!1;let y=!1;for(const C of h){const I=(C?.metadata??{}).e2ee;if(!I||I.kind!=="handshake")continue;const z=I.payload;if(!z||z.recipientDeviceId!==x.deviceId)continue;const q=this.sessions[l.id];if(q&&q.peerDeviceId===z.initiatorDeviceId&&q.prekeyId===z.prekeyId)continue;this.handlePeerHandshake(l,z)&&(y=!0)}return y&&this.bumpVersion(),y}transformMessage(l,h){if(!h)return h;const x=h.metadata??{},y=x.e2ee;if(!y||y.kind!=="ciphertext")return h;const C=this.sessions[l];if(!C)return{...h,content:"ðŸ” Ð—Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¾",metadata:{...x,e2ee:{...y,decrypted:!1}}};try{const v=yt(C.key),I=yt(y.nonce),z=yt(h.content||""),q=Bt.secretbox.open(z,I,v);if(!q)throw new Error("Failed to decrypt");return{...h,content:qc(q),metadata:{...x,e2ee:{...y,decrypted:!0}}}}catch(v){return console.warn("Failed to decrypt message",v),{...h,content:"ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸",metadata:{...x,e2ee:{...y,decrypted:!1,error:!0}}}}}async encryptPayload(l,h){const x=await this.ensureSession(l);if(!x)throw new Error("E2EE session is not ready");const y=yt(x.key),C=Bt.randomBytes(24),v=da(h.content??""),I=Bt.secretbox(v,C,y);return{conversationId:l.id,type:h.type,content:Fn(I),replyToId:h.replyToId,metadata:{...h.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:Fn(C)}}}}async encryptBinary(l,h){const x=await this.ensureSession(l);if(!x)throw new Error("E2EE session is not ready");const y=yt(x.key),C=Bt.randomBytes(24);return{cipher:Bt.secretbox(h,C,y),nonce:Fn(C)}}decryptBinary(l,h,x){const y=this.sessions[l];if(!y)throw new Error("E2EE session is not ready");const C=yt(y.key),v=yt(x);return Bt.secretbox.open(h,v,C)}async createInitiatorSession(l,h,x,y){try{const C=await ne.post("/devices/prekeys/claim",{deviceId:x}),v=C.data?.identityKey,I=C.data?.prekey;if(!v||!I?.publicKey||!I?.keyId)throw new Error("Invalid prekey response");const z=Bt.scalarMult(yt(y.secretKey),yt(I.publicKey)),q=Bt.randomBytes(32),O=`eblusha:e2ee:${l.id}:${h}->${x}:${I.keyId}`,_=this.deriveKey(z,q,O),ee={conversationId:l.id,key:Fn(_),localDeviceId:h,peerDeviceId:x,role:"initiator",prekeyId:I.keyId,hkdfInfo:O,handshakeSalt:Fn(q),createdAt:Date.now()};return this.sessions[l.id]=ee,this.persist(),await this.sendHandshakeMessage(l.id,{version:1,kind:"handshake",conversationId:l.id,initiatorDeviceId:h,recipientDeviceId:x,prekeyId:I.keyId,handshakeSalt:ee.handshakeSalt,hkdfInfo:O,initiatorIdentityKey:y.publicKey,createdAt:Date.now()}),ee}catch(C){return console.error("Failed to initialize E2EE session",C),delete this.sessions[l.id],this.persist(),null}}handlePeerHandshake(l,h){if(!h?.prekeyId||!h?.initiatorIdentityKey||!h.hkdfInfo||!h.handshakeSalt||!Xs())return!1;const y=_n();if(!y)return!1;const C=uo(h.prekeyId);if(!C)return console.warn("Missing prekey secret for handshake",h.prekeyId),!1;try{const v=Bt.scalarMult(yt(C),yt(h.initiatorIdentityKey)),I=this.deriveKey(v,yt(h.handshakeSalt),h.hkdfInfo),z={conversationId:l.id,key:Fn(I),localDeviceId:y.deviceId,peerDeviceId:h.initiatorDeviceId,role:"peer",prekeyId:h.prekeyId,hkdfInfo:h.hkdfInfo,handshakeSalt:h.handshakeSalt,createdAt:Date.now()};return this.sessions[l.id]=z,this.persist(),!0}catch(v){return console.error("Failed to handle handshake payload",v),!1}}async sendHandshakeMessage(l,h){await ne.post("/conversations/send",{conversationId:l,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:h}}})}deriveKey(l,h,x){return Hc(Xc,l,h,da(x),32)}clearSession(l){this.sessions[l]&&(delete this.sessions[l],this.persist())}load(){try{const l=localStorage.getItem(ua);l&&(this.sessions=JSON.parse(l))}catch{this.sessions={}}}persist(){try{localStorage.setItem(ua,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const Dt=new Vc;class Kc{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(l={}){this.callbacks=l}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const l={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,l),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const h=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,h.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(h){console.error("Failed to setup audio analysis:",h)}this.mediaRecorder.ondataavailable=h=>{h.data.size>0&&this.audioChunks.push(h.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(h=>h.stop())},this.mediaRecorder.onerror=h=>{const x=new Error("MediaRecorder error");this.callbacks.onError?.(x)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(l){const h=l instanceof Error?l:new Error("Failed to start recording");throw this.callbacks.onError?.(h),h}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(l=>l.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let l=0;const h=50,x=y=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(x));return}if(typeof y=="number"){if(y-l<h){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(x));return}l=y}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(ce){console.warn("Analyser error:",ce);return}let C=0,v=0;for(let ce=0;ce<this.dataArray.length;ce++){const N=Math.abs(this.dataArray[ce]-128);C=Math.max(C,N),v+=N}const I=v/this.dataArray.length,q=(C*.7+I*.3)/128*100,O=Math.min(100,q*2.5),ee=Math.max(15,O);this.callbacks.onAmplitudeUpdate?.(ee),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(x))};this.amplitudeTimer=window.requestAnimationFrame(x)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const l=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const h of l)if(MediaRecorder.isTypeSupported(h))return h;return""}cleanup(){this.cancel()}}async function Qc(a,l=60){try{const x=await(await fetch(a)).arrayBuffer(),y=new(window.AudioContext||window.webkitAudioContext),v=(await y.decodeAudioData(x)).getChannelData(0),I=Math.floor(v.length/l),z=[];for(let q=0;q<l;q++){let O=0,_=0;const ee=q*I,ce=Math.min(ee+I,v.length);for(let me=ee;me<ce;me++){const Le=Math.abs(v[me]);O+=Le,_=Math.max(_,Le)}const N=O/(ce-ee),$=Math.max(N,_*.7),B=Math.max(20,Math.min(100,$*200));z.push(B)}return y.close(),z}catch(h){return console.error("Failed to generate waveform:",h),Array(l).fill(0).map(()=>Math.random()*40+30)}}const ns=new Map;async function Jc(a,l=60){const h=`${a}:${l}`;if(ns.has(h))return ns.get(h);const x=await Qc(a,l);return ns.set(h,x),x}const Zc=o.lazy(()=>pa(()=>import("./CallOverlay-veLCMP6E.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(a=>({default:a.CallOverlay}))),el=()=>pa(()=>import("./CallOverlay-veLCMP6E.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),ha="eblusha:last-active-conversation",tl=3e4,nl=10;function rl({url:a,duration:l}){const[h,x]=o.useState(!1),[y,C]=o.useState(0),[v,I]=o.useState([]),[z,q]=o.useState(!0),O=o.useRef(null),_=si(a)||a;o.useEffect(()=>{let $=!1;return q(!0),Jc(_,60).then(B=>{$||(I(B),q(!1))}).catch(B=>{console.error("Failed to load waveform:",B),$||q(!1)}),()=>{$=!0}},[_]),o.useEffect(()=>{const $=O.current;if(!$)return;const B=()=>C($.currentTime),me=()=>{x(!1),C(0)},Le=()=>x(!0),he=()=>x(!1);return $.addEventListener("timeupdate",B),$.addEventListener("ended",me),$.addEventListener("play",Le),$.addEventListener("pause",he),()=>{$.removeEventListener("timeupdate",B),$.removeEventListener("ended",me),$.removeEventListener("play",Le),$.removeEventListener("pause",he)}},[]);const ee=()=>{const $=O.current;$&&(h?$.pause():$.play().catch(B=>{console.error("Failed to play audio:",B)}))},ce=$=>{const B=Math.floor($/60),me=Math.floor($%60);return`${B}:${me.toString().padStart(2,"0")}`},N=v.length>0?Math.floor(y/l*v.length):0;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[e.jsx("audio",{ref:O,src:_,preload:"metadata"}),e.jsx("button",{type:"button",onClick:ee,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":h?"ÐŸÐ°ÑƒÐ·Ð°":"Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸",children:h?e.jsx(bc,{size:16,fill:"currentColor"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[z?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map(($,B)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${B*.1}s`}},B))}):v.length>0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:v.map(($,B)=>{const me=B<=N,Le=Math.max(4,$/100*20);return e.jsx("div",{style:{width:2,height:`${Le}px`,background:me?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},B)})}):e.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."}),e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[ce(y)," / ",ce(l)]})})]})]})}function fl(){const[a,l]=o.useState(null),[h,x]=o.useState(null),[y,C]=o.useState(null),[v,I]=o.useState(null),z=o.useRef(null),[q,O]=o.useState(""),[_,ee]=o.useState(null),ce=o.useRef(null),N=o.useRef(null),$=o.useRef(null),B=o.useRef(null),me=o.useRef(null),Le=o.useRef(!1),he=o.useRef(null),we=o.useRef(null),Te=o.useRef(!1),le=o.useRef(null),et=o.useRef(null),[qe,at]=o.useState(!1),[yn,ci]=o.useState(1),[ye,Lt]=o.useState(!1),ot=o.useRef(null);o.useRef({pinTimer:null});const[de,ct]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[W,Nt]=o.useState(()=>({open:!1,x:0,y:0,conversationId:null})),xn=o.useRef(null),[tt,He]=o.useState(()=>({open:!1,anchor:null})),xr=o.useRef(null),vn=o.useRef(null),[li,tn]=o.useState(!1),[di,ui]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[nn,rn]=o.useState({open:!1,messageId:null}),[bn,sn]=o.useState(!1),[an,wn]=o.useState([]),[$n,Ot]=o.useState(!1),[St,Xn]=o.useState("friends"),[g,L]=o.useState(["","","",""]),R=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[U,T]=o.useState(null),[K,V]=o.useState(null),[Y,ge]=o.useState(!1),ke=o.useRef(0),[Ie,Ce]=o.useState(!1),[Pe,vt]=o.useState(!1),[k,zt]=o.useState(!1),De=o.useRef(k),[bt,fe]=o.useState("list");o.useEffect(()=>{De.current=k},[k]);const[We,kt]=o.useState(!1),lt=o.useRef(null);o.useRef(null);const nt=o.useRef(new Map),Be=o.useRef(!0),ue=o.useRef(!1),rt=o.useRef(0),dt=o.useRef(null),Ut=o.useRef(new Set),_e=o.useRef(null);o.useRef(null);const Ve=o.useRef(null),Ke=o.useRef(0),[Oe,je]=o.useState(!1),[$e,ut]=o.useState(""),[Ft,_t]=o.useState([]),[$t,Yn]=o.useState(!1),[vr,jn]=o.useState(null),[Xt,Gn]=o.useState(null),[xe,Ee]=o.useState(null),[Cn,qn]=o.useState(null),[on,Je]=o.useState(!1),hi=o.useRef(null),cn=o.useRef(null),xa=o.useRef(null),fi=o.useRef(null),[Ne,It]=o.useState({x:0,y:0,scale:1}),[as,pi]=o.useState(!1),[va,br]=o.useState(!1),[gi,ba]=o.useState(["","","",""]),mi=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[Yt,yi]=o.useState(null),[wa,xi]=o.useState(!1),[vi,ja]=o.useState(""),[Ca,wr]=o.useState(!1),[Sn,jr]=o.useState(!1),[bi,Cr]=o.useState(null),[ht,Sr]=o.useState(null),kr=o.useRef(null),[ve,Gt]=o.useState({x:0,y:0,scale:1}),[os,Ir]=o.useState(0),ln=o.useRef(null),wi=o.useRef(null),cs=o.useRef(null),Xe=o.useRef(null),dn=o.useRef(null),qt=o.useRef(null),Rr=o.useRef(null),Ye=o.useRef(null),un=o.useRef(null),Mr=o.useRef(null),ls=o.useRef(null),[be,Rt]=o.useState({x:0,y:0,scale:1}),[ft,Er]=o.useState(null),[Ar,Tr]=o.useState(null),[ds,ji]=o.useState(!1),[us,Ci]=o.useState(!1),[Dr,kn]=o.useState(null),[hn,Vt]=o.useState({open:!1,index:0,items:[]}),[Sa,Si]=o.useState(1),[ka,Lr]=o.useState(!1),[Ia,In]=o.useState(0),[il,ki]=o.useState(!1),[Rn,Vn]=o.useState(null),[hs,Kn]=o.useState({}),[Qn,Nr]=o.useState({}),Jn=o.useRef(new Set),Mn=o.useRef(new Set),[Ht,Zn]=o.useState([]),[zr,Mt]=o.useState(null),[Ur,fs]=o.useState(0),Pt=o.useRef(null),[ps,Ii]=o.useState(!1),[gs,Ri]=o.useState(0),[er,Mi]=o.useState([]),En=o.useRef(null),tr=o.useRef(null),[ms,ys]=o.useState(150);o.useEffect(()=>{if(k){ys(60);return}const t=()=>{if(!tr.current)return;const r=tr.current.clientWidth,c=Math.floor(r/4);ys(Math.max(100,c))};t();const n=new ResizeObserver(t);return tr.current&&n.observe(tr.current),()=>{n.disconnect()}},[k]),o.useEffect(()=>{el().catch(()=>{})},[]);const xs=o.useRef(null);o.useEffect(()=>{xs.current=a},[a]);const Hr=o.useRef([]);o.useEffect(()=>{Hr.current=Ht},[Ht]);const fn=o.useCallback(t=>{if(t)try{URL.revokeObjectURL(t)}catch{}},[]),Ei=o.useCallback(()=>{Mt(null),Zn(t=>t.length?(t.forEach(n=>fn(n.previewUrl)),[]):t)},[fn,Mt]),nr=o.useCallback((t,n)=>{!t||!t.type.startsWith("image/")||Zn(r=>{if(r.length>=nl)return alert("ÐœÐ¾Ð¶Ð½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10 Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð·Ð° Ñ€Ð°Ð·."),r;const i=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,c=URL.createObjectURL(t),s={id:i,file:t,previewUrl:c,edited:!1,fileName:t.name||"image.png",source:n};return[...r,s]})},[]),Ra=o.useCallback(t=>{Zn(n=>{const r=n.find(i=>i.id===t);return r&&fn(r.previewUrl),n.filter(i=>i.id!==t)}),Mt(n=>n===t?null:n)},[fn,Mt]),Ma=o.useCallback((t,n,r)=>{Zn(i=>i.map(c=>c.id!==t?c:(fn(c.previewUrl),{...c,file:n,previewUrl:r,edited:!0,fileName:n.name||c.fileName})))},[fn]),vs=On({queryKey:["my-devices"],queryFn:async()=>(await ne.get("/devices")).data.devices}),[sl,bs]=o.useState(null),[Ea,Pr]=o.useState(()=>Me.connected),[Aa,ws]=o.useState(null),[Ta,Da]=o.useState({}),[La,Na]=o.useState({}),[za,rr]=o.useState(!1),[js,ir]=o.useState({}),[Cs,Ss]=o.useState(!1),[Ai,Wr]=o.useState(!1),ks=o.useRef(null),D=mn(t=>t.session?.user),sr=o.useRef(null);if(sr.current===null&&typeof window<"u")try{const t=localStorage.getItem("eb_user");if(t){const n=JSON.parse(t);n&&typeof n.id=="string"&&(sr.current=n.id)}}catch{sr.current=null}o.useEffect(()=>{D?.id&&(sr.current=D.id)},[D?.id]);const it=D?.id??sr.current??null,G=Zi(),X=Uo(),Br=o.useMemo(()=>a?hs[a]||[]:[],[a,hs]),Or=o.useMemo(()=>zr?Ht.find(t=>t.id===zr)??null:null,[Ht,zr]);o.useRef(null),o.useRef(null);const[pn,Ze]=o.useState({}),[al,Ua]=o.useState(0),An=o.useRef(null);o.useEffect(()=>{An.current=h},[h]);const Ha=o.useRef({}),Ti=o.useRef({}),Tn=o.useRef({});o.useEffect(()=>()=>{typeof window>"u"||(Object.values(Tn.current).forEach(t=>{typeof t=="number"&&window.clearTimeout(t)}),z.current&&window.clearTimeout(z.current),Qt())},[]),o.useEffect(()=>{if(!v)return;const t=setInterval(()=>{I(n=>n?{...n}:null)},1e3);return()=>clearInterval(t)},[v]);const Fr=o.useCallback(t=>{if(!t)return null;const n=X.getQueryData(["conversations"]);return Array.isArray(n)?n.find(i=>i?.conversation?.id===t)?.conversation??null:null},[X]),Dn=o.useCallback(t=>{const n=Fr(t);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[Fr]),Kt=o.useCallback(t=>{if(!t)return;const n=Tn.current[t];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete Tn.current[t]),delete Ti.current[t]},[]),_r=o.useCallback(t=>{t&&Dn(t)&&(Ti.current[t]=Date.now()+tl)},[Dn]),Di=o.useCallback((t,n,r)=>{if(!t){n();return}if(r?.force){Kt(t),n();return}const i=Ti.current[t];if(!i){n();return}const c=Date.now();if(c>=i){Kt(t),n();return}const s=i-c,d=Tn.current[t];if(typeof d=="number"&&typeof window<"u"&&window.clearTimeout(d),typeof window>"u"){n();return}Tn.current[t]=window.setTimeout(()=>{delete Tn.current[t],Kt(t),n()},s)},[Kt]),Li=o.useCallback((t,n)=>{const r=t?"ÐºÐ°Ð¼ÐµÑ€Ðµ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ":"Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ",i=typeof n=="object"&&n&&"name"in n?String(n.name):"";return i==="NotAllowedError"||i==="SecurityError"?`Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð°Ð´Ñ€ÐµÑÐ½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`:i==="NotFoundError"?t?"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":i==="NotReadableError"||i==="TrackStartError"?"ÐšÐ°Ð¼ÐµÑ€Ð° Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð»Ð¸ Ð²ÐºÐ»Ð°Ð´ÐºÐ¾Ð¹.":`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð° Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`},[]),$r=o.useCallback(async t=>{try{const n=await ca({audio:!0,video:t});return n.ok?(Vn(null),!0):(Vn(Li(t,n.error)),!1)}catch(n){return Vn(Li(t,n)),!1}},[Li]),Xr=o.useCallback(async t=>{const n=G.incoming;if(!n||!await $r(t))return;const r=n.conversationId;_r(r),ho(r,t),G.startOutgoing(r,t),Ze(i=>{const c=i[r],s=D?.id;return c?.active?s&&c.participants&&!c.participants.includes(s)?{...i,[r]:{...c,participants:[...c.participants,s]}}:i:{...i,[r]:{startedAt:Date.now(),active:!0,participants:s?[s]:[]}}}),x(r),C(i=>i===r?null:i),G.setIncoming(null),jt()},[_r,G,D?.id,$r]),Ni=o.useCallback(()=>{const t=G.incoming;t&&(Ys(t.conversationId),G.setIncoming(null),jt())},[G]);o.useEffect(()=>{if(typeof window>"u")return;const t={accept:async(n,r)=>G.incoming?.conversationId!==n?!1:(await Xr(r),!0),decline:n=>G.incoming?.conversationId!==n?!1:(Ni(),!0)};return window.__nativeCallOverlayBridge=t,()=>{window.__nativeCallOverlayBridge===t&&delete window.__nativeCallOverlayBridge}},[G.incoming?.conversationId,Xr,Ni]),o.useEffect(()=>{const t=window.setInterval(()=>Ua(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(t)},[]),o.useEffect(()=>{if(!Rn||typeof window>"u")return;const t=window.setTimeout(()=>Vn(null),9e3);return()=>window.clearTimeout(t)},[Rn]),o.useEffect(()=>{const t=()=>{const n=window.innerWidth<=768;zt(n),De.current=n,n?a||fe("list"):fe("conversation")};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]),o.useEffect(()=>{k&&fe(a?"conversation":"list")},[k,a]),o.useEffect(()=>{const t=(()=>{try{const c=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(c==="1"||c==="true")return!0;const s=window.localStorage.getItem("lk-debug-callstatus");return s==="1"||s==="true"}catch{return!1}})(),n=i=>{t&&console.log("[CallStatus] Single:",i),Ze(c=>{const s=X.getQueryData(["conversations"]),d=Array.isArray(s)?s.find(b=>b.conversation.id===i.conversationId)?.conversation:null,f=c[i.conversationId],u=Zi.getState().activeConvId;if(!(!!(d&&(d.isGroup||(d.participants?.length??0)>2))||!!f&&(f.participants?f.participants.length>1:!0)||u===i.conversationId))return c;const j=i.participants||[];if(i.active){const b=typeof i.startedAt=="number"&&i.startedAt>0?i.startedAt:f?.startedAt??Date.now();return{...c,[i.conversationId]:{active:!0,startedAt:b,participants:j,endedAt:null,elapsedMs:typeof i.elapsedMs=="number"?i.elapsedMs:void 0}}}const m=f?.active?Date.now():f?.endedAt??null;return{...c,[i.conversationId]:{active:!1,startedAt:f?.startedAt??null,endedAt:m,participants:[],elapsedMs:void 0}}})},r=i=>{t&&console.log("[CallStatus] Bulk:",i),Ze(c=>{const s={...c},d=X.getQueryData(["conversations"]);for(const[f,u]of Object.entries(i.statuses||{})){const p=Array.isArray(d)?d.find(M=>M.conversation.id===f)?.conversation:null,j=c[f],m=Zi.getState().activeConvId;if(!(!!(p&&(p.isGroup||(p.participants?.length??0)>2))||!!j&&(j.participants?j.participants.length>1:!0)||m===f))continue;const E=u.participants||[];if(u.active){const M=typeof u.startedAt=="number"&&u.startedAt>0?u.startedAt:j?.startedAt??Date.now();s[f]={active:!0,startedAt:M,participants:E,endedAt:null,elapsedMs:typeof u.elapsedMs=="number"?u.elapsedMs:void 0};continue}const w=j?.active?Date.now():j?.endedAt??null;s[f]={active:!1,startedAt:j?.startedAt??null,endedAt:w,participants:[],elapsedMs:void 0}}return s})};return fo(n),po(r),()=>{Me.off("call:status",n),Me.off("call:status:bulk",r)}},[]),o.useEffect(()=>{if(!de.open)return;const t=ks.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=de.x,s=de.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),s+i.height>r-8&&(s=Math.max(8,r-i.height-8)),(c!==de.x||s!==de.y)&&ct(d=>({...d,x:c,y:s}))},[de.open,de.x,de.y]),o.useEffect(()=>{if(!W.open)return;const t=xn.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,i=t.getBoundingClientRect();let c=W.x,s=W.y;c+i.width>n-8&&(c=Math.max(8,n-i.width-8)),s+i.height>r-8&&(s=Math.max(8,r-i.height-8)),(c!==W.x||s!==W.y)&&Nt(d=>({...d,x:c,y:s}))},[W.open,W.x,W.y]),o.useEffect(()=>{if(!tt.open||!tt.anchor)return;const t=xr.current;if(!t)return;const n=tt.anchor.getBoundingClientRect(),r=window.innerWidth,i=window.visualViewport?window.visualViewport.height:window.innerHeight;t.style.display="flex";const c=t.getBoundingClientRect();let s=n.right-c.width,d=n.bottom+8;s<8&&(s=8),s+c.width>r-8&&(s=r-c.width-8),d+c.height>i-8&&(d=n.top-c.height-8),d<8&&(d=8),t.style.left=`${s}px`,t.style.top=`${d}px`},[tt.open,tt.anchor]),o.useEffect(()=>{a||He({open:!1,anchor:null})},[a]);function Ln(t){l(n=>{try{n&&n!==t&&(re.data||[]).find(c=>c.conversation.id===n)?.conversation?.isSecret&&X.removeQueries({queryKey:["messages",n]})}catch{}return t}),k&&fe("conversation"),Hr.current.length&&Ei()}async function Is(){let t=_n();return t||(t=await Lo()),t||null}async function Rs(t){if(Cs)return;Ss(!0);const n=2;let r=0;const i=async()=>{if(r>=n)throw new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");r+=1,await Do()};try{for(;;){const c=await Is();if(!c){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}try{const s={participantIds:[t],isGroup:!1,isSecret:!0,initiatorDeviceId:c.deviceId};console.log("[SecretChat] Creating with payload:",s),await ne.post("/conversations",s),X.invalidateQueries({queryKey:["conversations"]});return}catch(s){console.error("[SecretChat] Creation error:",s?.response?.data||s);const d=s?.response?.data?.message,f=s?.response?.data?.errors;if(f&&console.error("[SecretChat] Validation errors:",f),s?.response?.status===400&&typeof d=="string"&&d.toLowerCase().includes("invalid initiator device")){await i();continue}const p=f?`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸: ${f.map(j=>`${j.path.join(".")}: ${j.message}`).join(", ")}`:d||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";throw new Error(p)}}}catch(c){console.error("Failed to start secret conversation:",c);const s=c?.message||c?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";alert(s)}finally{Ss(!1)}}const Ms=async t=>{Wr(!0);try{No(t),ir(n=>{const r={...n};return delete r[t],r}),X.invalidateQueries({queryKey:["conversations"]})}finally{Wr(!1)}},Pa=async t=>{Wr(!0);try{const n=await Is();if(!n){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}zo(t,n.deviceId),X.invalidateQueries({queryKey:["conversations"]}),Ln(t)}catch(n){console.error("Failed to accept secret chat:",n),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚")}finally{Wr(!1)}};async function Es(t,n){if(!t)return;const r={...n,content:n.content??void 0};if(t.isSecret){const i=await Dt.encryptPayload(t,r);await ne.post("/conversations/send",i);return}await ne.post("/conversations/send",{conversationId:t.id,...r})}const Nn=()=>{sn(!1),wn([]),Ot(!1),Xn("friends"),L(["","","",""]),T(null),V(null),ge(!1)},Wa=async()=>{if(!a||an.length===0){Nn();return}Ot(!0);try{await ne.post(`/conversations/${a}/participants`,{participantIds:an}),X.invalidateQueries({queryKey:["conversations"]}),re.refetch(),Nn()}catch(t){console.error("Error adding participants:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")}finally{Ot(!1)}},Ba=async()=>{if(!(!a||!U)){Ot(!0);try{await ne.post(`/conversations/${a}/participants`,{participantIds:[U.id]}),X.invalidateQueries({queryKey:["conversations"]}),re.refetch(),Nn()}catch(t){console.error("Error adding participant by EBLID:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°")}finally{Ot(!1)}}},Oa=(t,n)=>{if(!/^\d?$/.test(n))return;const r=[...g];r[t]=n,L(r),n&&t<3&&R[t+1].current?.focus(),!n&&t>0&&R[t-1].current?.focus();const i=r.join("");if(i.length===4&&/^\d{4}$/.test(i)){const c=Date.now();ke.current=c,ge(!0),V(null),ne.get("/contacts/search",{params:{query:i}}).then(s=>{if(ke.current!==c)return;const d=s.data.results?.[0]??null;T(d),V(d?null:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")}).catch(()=>{ke.current===c&&(T(null),V("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº"))}).finally(()=>{ke.current===c&&ge(!1)})}else T(null),V(null),ge(!1)};function Fa(){if(k){if(a)try{(re.data||[]).find(r=>r.conversation.id===a)?.conversation?.isSecret&&X.removeQueries({queryKey:["messages",a]})}catch{}fe("list"),l(null),kt(!1)}Hr.current.length&&Ei()}const wt=On({queryKey:["me-info"],queryFn:async()=>(await ne.get("/status/me")).data.user}),re=On({queryKey:["conversations"],queryFn:async()=>(await ne.get("/conversations")).data.conversations}),Re=On({queryKey:["messages",a],enabled:!!a,queryFn:async()=>(await ne.get(`/conversations/${a}/messages`)).data.messages,refetchInterval:a?15e3:!1});o.useEffect(()=>{Re.error?.response?.status===403&&a&&(console.warn("[ChatsPage] Lost access to conversation, closing view",a),X.removeQueries({queryKey:["messages",a]}),l(null))},[Re.error,a,X]);const Qe=On({queryKey:["accepted-contacts"],queryFn:async()=>(await ne.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),pt=On({queryKey:["incoming-contacts"],queryFn:async()=>(await ne.get("/contacts",{params:{filter:"incoming"}})).data.contacts});o.useEffect(()=>{if(a&&!(typeof window>"u"))try{window.localStorage.setItem(ha,a)}catch{}},[a]),o.useEffect(()=>{if(typeof window>"u"||a)return;const t=re.data;if(!(!t||t.length===0)&&!(De.current&&bt!=="conversation"))try{const n=window.localStorage.getItem(ha);if(!n)return;t.some(i=>i?.conversation?.id===n)&&Ln(n)}catch{}},[a,re.data,bt]);const zi=()=>{if(je(!1),ut(""),_t([]),Yn(!1),Xt)try{URL.revokeObjectURL(Xt)}catch{}if(Gn(null),xe)try{URL.revokeObjectURL(xe)}catch{}Ee(null),jn(null),qn(null),It({x:0,y:0,scale:1}),Je(!1)};o.useEffect(()=>{const t=vn.current;if(!t)return;const n=()=>{const{scrollTop:r,scrollHeight:i,clientHeight:c}=t,s=r>2,d=i-r-c>2;Ce(s),vt(d)};return n(),t.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{t.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[re.data?.length]),o.useEffect(()=>{try{const t=(re.data||[]).map(n=>n.conversation.id);try{const r=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(r==="1"||r==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",t)}catch{}t.length>0&&Gs(t);for(const n of t)try{qs(n)}catch{}}catch{}},[re.data]);const S=o.useMemo(()=>re.data?.find(t=>t.conversation.id===a)?.conversation,[re.data,a]);o.useEffect(()=>()=>{Jn.current.forEach(t=>URL.revokeObjectURL(t)),Jn.current.clear(),Mn.current.clear()},[]),o.useEffect(()=>{Jn.current.forEach(t=>URL.revokeObjectURL(t)),Jn.current.clear(),Mn.current.clear(),Nr({})},[S?.id]);const ar=o.useMemo(()=>_n()?.deviceId??null,[Ur]),Yr=o.useMemo(()=>{const t={};for(const n of vs.data||[])t[n.id]=n;return t},[vs.data]),Gr=o.useCallback(t=>{if(!t?.isSecret)return null;const n=[t.secretInitiatorDeviceId,t.secretPeerDeviceId];for(const r of n){if(!r)continue;const i=Yr[r];if(i?.userId&&D?.id&&i.userId===D.id)return r}if(D?.id){if(t.createdById===D.id&&t.secretInitiatorDeviceId)return t.secretInitiatorDeviceId;if(t.createdById!==D.id&&t.secretPeerDeviceId)return t.secretPeerDeviceId}return null},[Yr,D?.id]),zn=o.useMemo(()=>Gr(S),[S,Gr]),As=o.useMemo(()=>{if(!zn)return;const t=Yr[zn]?.name;if(t&&t.trim())return t;const n=_n();if(n&&n.deviceId===zn&&n.name)return n.name},[zn,Yr,Ur]),Ts=o.useCallback(t=>{if(!t)return!1;const n=(re.data||[]).find(i=>i?.conversation?.id===t)?.conversation;if(!n?.isSecret)return!1;const r=Gr(n);return!!(r&&ar&&r!==ar)},[re.data,ar,Gr]),qr=!!(S?.isSecret&&(S.secretStatus??"ACTIVE")!=="ACTIVE"),Un=o.useMemo(()=>S?.isSecret?Dt.hasSession(S.id):!0,[S?.id,S?.isSecret,Ur]),_a=!!(S?.isSecret&&!qr&&!Un&&zn&&ar&&zn!==ar);o.useEffect(()=>{if(!S?.isSecret||S.secretStatus!=="ACTIVE")return;let t=!1;return Dt.ensureSession(S).then(n=>{!t&&n&&fs(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{t=!0}},[S?.id,S?.secretStatus,S?.isSecret]),o.useEffect(()=>{if(!S?.isSecret||!Re.data||Re.data.length===0)return;Dt.processHandshakes(S,Re.data)&&fs(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[Re.data,S?.id,S?.isSecret,S?.secretStatus]);const gt=o.useMemo(()=>Re.data?S?.isSecret?Re.data.filter(t=>{const r=(t?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(t=>Dt.transformMessage(S.id,t)):Re.data:[],[Re.data,S?.id,S?.isSecret,Ur]),Ds=o.useCallback(t=>{if(!S?.id)return;const n=t?.metadata?.e2ee;!n||n.kind!=="ciphertext"||!n.nonce||!Dt.hasSession(S.id)||Mn.current.has(t.url)||Qn[t.url]?.status==="ready"||(Mn.current.add(t.url),Nr(i=>({...i,[t.url]:{status:"pending"}})),(async()=>{try{const i=si(t.url)||t.url,c=await fetch(i,{credentials:"omit"});if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const s=new Uint8Array(await c.arrayBuffer()),d=Dt.decryptBinary(S.id,s,n.nonce);if(!d)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const f=new Blob([d],{type:n.originalType||t.metadata?.mime||t.metadata?.contentType||"application/octet-stream"}),u=URL.createObjectURL(f);Jn.current.add(u),Mn.current.delete(t.url),Nr(p=>({...p,[t.url]:{status:"ready",url:u}}))}catch(i){Mn.current.delete(t.url),Nr(c=>{const s={...c};return i?.message?.includes("E2EE session is not ready")?delete s[t.url]:s[t.url]={status:"error"},s})}})())},[S?.id,Qn]),Ls=o.useCallback(t=>{if(!t)return null;const n=si(t.url);if(!S?.isSecret)return n;const r=t.metadata?.e2ee;if(!r||r.kind!=="ciphertext")return n;const i=Qn[t.url];return i?.status==="ready"&&i.url?i.url:null},[Qn,S?.isSecret]);o.useEffect(()=>{if(!S?.isSecret||!Un)return;(gt||[]).flatMap(n=>n.attachments||[]).forEach(n=>{n?.metadata?.e2ee?.kind==="ciphertext"&&Ds(n)})},[gt,S?.id,S?.isSecret,Un,Ds]),o.useEffect(()=>{const t=new Set((re.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));ir(n=>{let r=!1;const i={...n};for(const c of Object.keys(i))t.has(c)||(delete i[c],r=!0);return r?i:n})},[re.data]);const Hn=o.useMemo(()=>{if(!S||S.isGroup||S.isSecret||!D?.id)return null;const t=fa(S.participants||[]);if(!t)return null;const n=re.data||[];for(const r of n){const i=r.conversation;if(!i?.isSecret||(i.secretStatus??"ACTIVE")!=="PENDING"||fa(i.participants||[])!==t)continue;const s=(i.participants||[]).find(f=>f.user.id===i.createdById)?.user,d=js[i.id]?.from?.name??s?.displayName??s?.username??"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº";return{conversationId:i.id,isInitiator:i.createdById===D.id,initiatorName:d}}return null},[S,re.data,D?.id,js]),Ns=o.useMemo(()=>{const t={};if(S)for(const n of S.participants)t[n.user.id]=n.user;return D&&!t[D.id]&&(t[D.id]=D),t},[S,D]),Ui=o.useMemo(()=>S?(S.participants||[]).map(t=>t.user.id):[],[S]),zs=o.useMemo(()=>{if(!S||!Qe.data)return[];const t=new Set(Ui);return Qe.data.filter(n=>!t.has(n.friend.id))},[S,Qe.data,Ui]),Vr={alreadyInChat:U?Ui.includes(U.id):!1,isSelf:U?U.id===D?.id:!1};o.useEffect(()=>{bn&&St==="eblid"&&R[0].current?.focus()},[bn,St]),o.useEffect(()=>{const t=n=>{X.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(s=>s.user.id===n.userId?{...s,user:{...s.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="OFFLINE"?new Date().toISOString():s.user.lastSeenAt}}:s)}})))};return Vs(t),()=>{Me.off("presence:update",t)}},[X]);const Kr=o.useRef(Me.connected);o.useEffect(()=>{const t=()=>{try{const c=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",c+"px")}catch{}X.invalidateQueries({queryKey:["me-info"]}),Pr(Me.connected)};window.addEventListener("focus",t);const n=()=>{Pr(!0);const c=Kr.current;if(Kr.current=!0,c)try{const s=(re.data||[]).map(d=>d.conversation.id);for(const d of s)try{qs(d)}catch{}s.length>0&&Gs(s)}catch{}},r=()=>{Pr(!1),Kr.current=!1};Me.on("connect",n),Me.on("disconnect",r),Pr(Me.connected),Me.connected&&(Kr.current=!0);const i=()=>{X.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",i),()=>{Me.off("connect",n),Me.off("disconnect",r),document.removeEventListener("visibilitychange",i),window.removeEventListener("focus",t)}},[X]),o.useEffect(()=>{const t=n=>{if(D?.id&&n.userId===D.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="OFFLINE")&&ws(r)}};return Vs(t),()=>{Me.off("presence:update",t)}},[D?.id]),o.useEffect(()=>{const t=(wt.data?.status||"").toString().toUpperCase();(t==="ONLINE"||t==="AWAY"||t==="BACKGROUND"||t==="OFFLINE")&&ws(t)},[wt.data]),o.useEffect(()=>{if(!hn.open)return;const t=n=>{n.key==="Escape"&&Vt(r=>({...r,open:!1})),n.key==="ArrowLeft"&&Vt(r=>({...r,index:(r.index-1+r.items.length)%r.items.length})),n.key==="ArrowRight"&&Vt(r=>({...r,index:(r.index+1)%r.items.length}))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[hn.open]),o.useEffect(()=>{const t=n=>{X.setQueryData(["conversations"],r=>r&&r.map(i=>({...i,conversation:{...i.conversation,participants:i.conversation.participants.map(c=>c.user.id===n.userId?{...c,user:{...c.user,avatarUrl:n.avatarUrl??c.user.avatarUrl,displayName:n.displayName??c.user.displayName}}:c)}}))),n.userId===D?.id&&wt.refetch()};return go(t),()=>{Me.off("profile:update",t)}},[X,D?.id]);function $a(t){return"#191d23"}o.useEffect(()=>{if(!a)return;const t=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const i=n.clipboardData?.items;if(i)for(let c=0;c<i.length;c++){const s=i[c];if(s.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const d=s.getAsFile();d&&nr(d,"paste");break}}};return window.addEventListener("paste",t,!0),()=>{window.removeEventListener("paste",t,!0)}},[a,nr]),o.useEffect(()=>{re.refetch(),mo(),yo(()=>re.refetch()),xo(r=>{const i=r?.conversationId;if(!i){re.refetch();return}ir(s=>{if(!s[i])return s;const d={...s};return delete d[i],d}),Kn(s=>{if(!s[i])return s;const d={...s};return delete d[i],d}),Dt.clearSession(i),X.removeQueries({queryKey:["messages",i]}),X.setQueryData(["conversations"],s=>Array.isArray(s)?s.filter(d=>d?.conversation?.id!==i):s),xs.current===i&&(l(s=>s===i?null:s),kt(!1),Hr.current.length&&Ei(),De.current&&fe("list")),re.refetch()}),vo(()=>{re.refetch()}),bo(()=>{re.refetch()});const t=wo(r=>{ir(i=>({...i,[r.conversationId]:r})),re.refetch()}),n=jo(r=>{ir(i=>{const c={...i};return delete c[r.conversationId],c}),X.invalidateQueries({queryKey:["conversations"]}),Ln(r.conversationId)});Co(({conversationId:r,from:i,video:c})=>{if(!(B.current&&B.current===r)){jt();try{const s=X.getQueryData(["conversations"]),d=Array.isArray(s)?s.find(p=>p.conversation.id===r)?.conversation:null,f=!!(d&&(d.isGroup||(d.participants?.length??0)>2));Ha.current[r]=i.id;const u=An.current===r;if(f||u||i?.id&&D?.id&&i.id===D.id)return}catch{}B.current=r,G.startIncoming({conversationId:r,from:i,video:c});try{const s=Us();s&&(s.currentTime=0,s.loop=!0,s.volume=.9,s.play().catch(()=>{}))}catch(s){console.error("Error starting ringtone:",s)}$.current=window.setTimeout(()=>{Ys(r),jt(),G.setIncoming(null)},25e3)}}),So(({conversationId:r,by:i})=>{if(Kt(r),i?.id===D?.id){(G.incoming?.conversationId===r||B.current===r)&&(jt(),G.setIncoming(null),$.current&&(window.clearTimeout($.current),$.current=null),B.current=null),I(s=>s?.conversationId===r?(z.current&&(window.clearTimeout(z.current),z.current=null),Qt(),null):s);return}I(c=>c?.conversationId===r?(z.current&&(window.clearTimeout(z.current),z.current=null),Qt(),null):c),Ze(c=>c[r]?.active?c:{...c,[r]:{startedAt:Date.now(),active:!0,participants:[D?.id||""].filter(Boolean)}}),G.activeConvId!==r&&G.startOutgoing(r,!1),x(r),C(c=>c===r?null:c),jt()}),ko(({conversationId:r})=>{I(c=>c?.conversationId===r?(z.current&&(window.clearTimeout(z.current),z.current=null),Qt(),Qr(),null):c);const i=()=>{Ze(c=>{const s=c[r];if(s){if(s.active)return{...c,[r]:{...s,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}return c}),An.current===r&&(x(c=>c===r?null:c),C(c=>c===r?null:c),G.endCall()),G.setIncoming(null),jt(),Kt(r)};Dn(r)?Di(r,i,{force:!0}):i()}),Io(({conversationId:r})=>{try{const c=X.getQueryData(["conversations"]),s=Array.isArray(c)?c.find(f=>f.conversation.id===r)?.conversation:null;if(!!(s&&(s.isGroup||(s.participants?.length??0)>2)))return}catch{}if(y===r)return;if(Dn(r)){const c=pn[r];if((An.current===r||G.activeConvId===r)&&c?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",r);return}}const i=()=>{I(c=>c?.conversationId===r?(z.current&&(window.clearTimeout(z.current),z.current=null),Qt(),null):c),Ze(c=>{const s=c[r];if(s?.active)return{...c,[r]:{...s,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}),An.current===r&&(x(c=>c===r?null:c),C(c=>c===r?null:c),G.endCall()),G.setIncoming(null),jt(),Kt(r)};Dn(r)?Di(r,i,{force:!0}):i()}),Ro(({conversationId:r})=>{X.invalidateQueries({queryKey:["messages",r]}),X.refetchQueries({queryKey:["messages",r]})});try{we.current||(we.current=new Audio("/notify.mp3"),we.current.preload="auto",we.current.volume=.9);const r=async()=>{try{if(we.current&&!Te.current&&(we.current.volume=0,await we.current.play(),we.current.pause(),we.current.currentTime=0,we.current.volume=.9,Te.current=!0),!Le.current){const i=Us();if(i){const c=i.volume;i.volume=0,await i.play().catch(()=>{}),i.pause(),i.currentTime=0,i.volume=c,Le.current=!0}}}catch{}Te.current&&Le.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{t?.(),n?.()}},[]),o.useEffect(()=>{Mo(()=>{pt.refetch()}),Eo(()=>{Qe.refetch(),re.refetch(),pt.refetch()}),Ao(()=>{Qe.refetch(),pt.refetch()})},[]),o.useEffect(()=>{if(!ht)return;const t=ln.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,m=p.clientY-u.clientY;return Math.sqrt(j*j+m*m)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,m,b)=>{const E=u-j,w=p-m;return E*E+w*w<=b*b},s=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,m=p.height,b=j/2,E=m/2,w=i/2;if(u.touches.length===1){const M=u.touches[0],H=M.clientX-p.left,P=M.clientY-p.top;if(!c(H,P,b,E,w))return;Xe.current={touches:[M],initialDistance:0,initialScale:ve.scale,initialX:ve.x,initialY:ve.y},u.preventDefault()}else if(u.touches.length===2){const M=u.touches[0],H=u.touches[1],P=r(M,H),se=P.x-p.left,ae=P.y-p.top;if(!c(se,ae,b,E,w))return;const oe=n(M,H);Xe.current={touches:[M,H],initialDistance:oe,initialScale:ve.scale,initialX:ve.x,initialY:ve.y},u.preventDefault()}},d=u=>{Xe.current&&(u.preventDefault(),dn.current!==null&&cancelAnimationFrame(dn.current),dn.current=requestAnimationFrame(()=>{if(!Xe.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,m=p.height,b=j/2,E=m/2,w=u.touches.length,M=Xe.current.touches.length;if(w===1&&M===1){const H=u.touches[0],P=Xe.current.touches[0],se=H.clientX-P.clientX,ae=H.clientY-P.clientY;Gt(oe=>{let Q=Xe.current.initialX+se,te=Xe.current.initialY+ae;const F=wi.current;if(F){const J=oe.scale,ie=F.naturalWidth*J,Se=F.naturalHeight*J,ze=b+i/2,Ae=b-i/2-ie,Ge=E+i/2,Wt=E-i/2-Se;Q=Math.max(Ae,Math.min(ze,Q)),te=Math.max(Wt,Math.min(Ge,te))}return{...oe,x:Q,y:te}})}else if(w===2&&M===2){const H=u.touches[0],P=u.touches[1],ae=n(H,P)/Xe.current.initialDistance,oe=Math.max(.1,Math.min(10,Xe.current.initialScale*ae)),Q=wi.current;if(Q){const te=Q.naturalWidth,F=Q.naturalHeight,J=Xe.current.initialX+te*Xe.current.initialScale/2,ie=Xe.current.initialY+F*Xe.current.initialScale/2,Se=J-b,ze=ie-E,Ae=oe/Xe.current.initialScale,Ge=b+Se*Ae,Wt=E+ze*Ae,or=Ge-te*oe/2,cr=Wt-F*oe/2;Gt({x:or,y:cr,scale:oe})}}dn.current=null}))},f=()=>{dn.current!==null&&(cancelAnimationFrame(dn.current),dn.current=null),Xe.current=null};return t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",s),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[ht,ve.scale,ve.x,ve.y]),o.useEffect(()=>{if(!ft)return;const t=qt.current;if(!t)return;const n=(u,p)=>{const j=p.clientX-u.clientX,m=p.clientY-u.clientY;return Math.sqrt(j*j+m*m)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),i=240,c=(u,p,j,m,b)=>{const E=u-j,w=p-m;return E*E+w*w<=b*b},s=u=>{const p=t.getBoundingClientRect();if(!p)return;const j=p.width,m=p.height,b=j/2,E=m/2,w=i/2;if(u.touches.length===1){const M=u.touches[0],H=M.clientX-p.left,P=M.clientY-p.top;if(!c(H,P,b,E,w))return;Ye.current={touches:[M],initialDistance:0,initialScale:be.scale,initialX:be.x,initialY:be.y},u.preventDefault()}else if(u.touches.length===2){const M=u.touches[0],H=u.touches[1],P=r(M,H),se=P.x-p.left,ae=P.y-p.top;if(!c(se,ae,b,E,w))return;const oe=n(M,H);Ye.current={touches:[M,H],initialDistance:oe,initialScale:be.scale,initialX:be.x,initialY:be.y},u.preventDefault()}},d=u=>{Ye.current&&(u.preventDefault(),un.current!==null&&cancelAnimationFrame(un.current),un.current=requestAnimationFrame(()=>{if(!Ye.current)return;const p=t.getBoundingClientRect();if(!p)return;const j=p.width,m=p.height,b=j/2,E=m/2,w=u.touches.length,M=Ye.current.touches.length;if(w===1&&M===1){const H=u.touches[0],P=Ye.current.touches[0],se=H.clientX-P.clientX,ae=H.clientY-P.clientY;Rt(oe=>{let Q=Ye.current.initialX+se,te=Ye.current.initialY+ae;const F=Rr.current;if(F){const J=oe.scale,ie=F.naturalWidth*J,Se=F.naturalHeight*J,ze=b+i/2,Ae=b-i/2-ie,Ge=E+i/2,Wt=E-i/2-Se;Q=Math.max(Ae,Math.min(ze,Q)),te=Math.max(Wt,Math.min(Ge,te))}return{...oe,x:Q,y:te}})}else if(w===2&&M===2){const H=u.touches[0],P=u.touches[1],ae=n(H,P)/Ye.current.initialDistance,oe=Math.max(.1,Math.min(10,Ye.current.initialScale*ae)),Q=Rr.current;if(Q){const te=Q.naturalWidth,F=Q.naturalHeight,J=Ye.current.initialX+te*Ye.current.initialScale/2,ie=Ye.current.initialY+F*Ye.current.initialScale/2,Se=J-b,ze=ie-E,Ae=oe/Ye.current.initialScale,Ge=b+Se*Ae,Wt=E+ze*Ae,or=Ge-te*oe/2,cr=Wt-F*oe/2;Rt({x:or,y:cr,scale:oe})}}un.current=null}))},f=()=>{un.current!==null&&(cancelAnimationFrame(un.current),un.current=null),Ye.current=null};return t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",s),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[ft,be.scale,be.x,be.y]);const Us=o.useCallback(()=>{if(typeof window>"u")return null;if(!me.current){const t=new Audio("/ring.mp3");t.preload="auto",t.loop=!0,t.volume=.9,me.current=t}return me.current},[]);function jt(){try{if($.current&&clearTimeout($.current),$.current=null,me.current)try{me.current.pause(),me.current.currentTime=0}catch{}B.current=null}catch{}}const Xa=o.useCallback(()=>{if(typeof window>"u")return null;if(!le.current){const t=new Audio("/dialing.mp3");t.preload="auto",t.loop=!0,t.volume=.7,le.current=t}return le.current},[]);function Hs(){try{const t=Xa();t&&(t.currentTime=0,t.loop=!0,t.volume=.7,t.play().catch(()=>{}))}catch(t){console.error("Error starting dialing sound:",t)}}function Qt(){try{if(le.current)try{le.current.pause(),le.current.currentTime=0}catch{}}catch{}}const Ya=o.useCallback(()=>{if(typeof window>"u")return null;if(!et.current){const t=new Audio("/notify.mp3");t.preload="auto",t.volume=.6,et.current=t}return et.current},[]);function Qr(){try{const t=Ya();t&&(t.currentTime=0,t.volume=.6,t.play().catch(()=>{}))}catch(t){console.error("Error playing end call sound:",t)}}o.useEffect(()=>{const t=async i=>{if(!(i.conversationId===a)){X.invalidateQueries({queryKey:["conversations"]});return}if(!a)return;const d=i.message??i;d&&d.id&&(Kn(f=>{const u=f[a]||[];if(u.length===0)return f;const p=(d.attachments||[]).map(m=>m.url).sort(),j=u.filter(m=>{if(m.senderId!==d.senderId)return!0;const b=m.attachments.map(E=>E.url).sort();return b.length===p.length?!b.every((w,M)=>{const H=p[M];return w===H||w.startsWith("blob:")&&H&&!H.startsWith("blob:")}):!0});if(j.length===u.length)return f;if(j.length===0){const{[a]:m,...b}=f;return b}return{...f,[a]:j}}),Os(a,d)),Re.refetch()},n=i=>{i.conversationId===a&&(at(!0),ot.current&&window.clearTimeout(ot.current),ot.current=window.setTimeout(()=>at(!1),2e3))},r=i=>{if(!a||i.conversationId!==a){X.invalidateQueries({queryKey:["conversations"]});return}i.message?to(a,i.message):Re.refetch()};return Me.on("message:new",t),Me.on("conversation:typing",n),Me.on("message:reaction",r),()=>{Me.off("message:new",t),Me.off("conversation:typing",n),Me.off("message:reaction",r)}},[a]),o.useEffect(()=>{const t=async n=>{if(Ts(n.conversationId))return;const r=n.senderId===D?.id,i=n.conversationId===a,c=document.visibilityState==="visible";if(!r&&(!i||!c)&&we.current&&Te.current&&(we.current.currentTime=0,we.current.play().catch(()=>{})),i){n.message&&n.message.id&&Os(a,n.message),Re.refetch().catch(()=>{});return}};return Me.on("message:notify",t),()=>{Me.off("message:notify",t)}},[a,D?.id,Re,Ts]),o.useLayoutEffect(()=>{if(!a){dt.current=null,rt.current=0;return}dt.current!==a&&(dt.current=a,rt.current=0);const t=(gt?.length??0)+Br.length,n=rt.current;if(rt.current=t,!he.current||t===0||t<=n)return;const r=[...gt||[],...Br],i=r[r.length-1],c=i?.senderId&&D?.id?i.senderId===D.id:!1;(c||!ue.current||Be.current)&&requestAnimationFrame(()=>{const d=he.current;d&&(d.scrollTop=d.scrollHeight,Be.current=!0,c&&(ue.current=!1))})},[a,Br,gt,D?.id]),o.useEffect(()=>{if(!a)return;const t=he.current;if(!t)return;const n=()=>{t&&(t.scrollTop=t.scrollHeight,Be.current=!0,ue.current=!1)};if(De.current){n();const r=window.setTimeout(n,50),i=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(i)}}n()},[a]),o.useEffect(()=>{if(!De.current)return;const t=he.current;if(!t)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===ce.current&&(t.scrollTop=t.scrollHeight,Be.current=!0,ue.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[a]),o.useEffect(()=>{},[]),o.useEffect(()=>{if(!qe||!De.current)return;const t=he.current,n=window.setInterval(()=>{ci(r=>r%3+1),t&&t.scrollHeight-t.scrollTop-t.clientHeight<80&&(t.scrollTop=t.scrollHeight)},500);return()=>window.clearInterval(n)},[qe]),o.useEffect(()=>{const t=he.current;if(!t)return;let n=0,r=t.scrollTop;const i=()=>{n&&cancelAnimationFrame(n);const c=t.scrollTop;Math.abs(c-r)>1&&(ue.current=!0),n=requestAnimationFrame(()=>{const d=t.scrollHeight-t.scrollTop-t.clientHeight<8;Be.current=d,kt(!d),d&&window.setTimeout(()=>{t.scrollHeight-t.scrollTop-t.clientHeight<40&&(ue.current=!1)},100),r=t.scrollTop})};return t.addEventListener("scroll",i,{passive:!0}),i(),()=>{t.removeEventListener("scroll",i),n&&cancelAnimationFrame(n)}},[a]),o.useEffect(()=>{const t=()=>{if(!he.current)return;const n=he.current.clientWidth;Lt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]);function Ga(t,n){if(!/^\d?$/.test(n))return;const r=[...gi];r[t]=n,ba(r),n&&t<3&&mi[t+1].current?.focus(),!n&&t>0&&mi[t-1].current?.focus();const i=r.join("");i.length===4&&/^\d{4}$/.test(i)?(async()=>{try{const c=await ne.get("/contacts/search",{params:{query:i}});yi(c.data.results?.[0]??null)}catch{yi(null)}})():yi(null)}async function qa(){br(!0);try{const t=await ne.get("/status/me");ja(t.data.user?.eblid??"")}catch{}}async function Va(){const t=gi.join("");if(/^\d{4}$/.test(t)){xi(!0);try{await ne.post("/contacts/add",{identifier:t}),xi(!1)}catch{xi(!1)}}}function Jr(){if(!a||!Re.data||!D?.id)return;const t=Re.data.filter(n=>n.senderId!==D.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===D.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);t.length!==0&&ne.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{X.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})}o.useEffect(()=>{document.hasFocus()&&Jr(),a&&(ne.post("/messages/mark-conversation-read",{conversationId:a}).catch(()=>{}),X.setQueryData(["conversations"],t=>t&&t.map(n=>n.conversation.id===a?{...n,unreadCount:0}:n)))},[a]),o.useEffect(()=>{document.hasFocus()&&Jr()},[Re.data]),o.useEffect(()=>{const t=()=>Jr(),n=()=>{document.visibilityState==="visible"&&Jr()};return window.addEventListener("focus",t),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",t),document.removeEventListener("visibilitychange",n)}},[a,Re.data]);function Ka(){_e.current||(_e.current=window.setTimeout(()=>{const t=Array.from(Ut.current);Ut.current.clear(),_e.current&&clearTimeout(_e.current),_e.current=null,t.length&&ne.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{a&&X.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})},250))}o.useEffect(()=>{if(!a||!Re.data||!D?.id)return;lt.current?.disconnect();const t=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const i=r.target,c=i.dataset.mid;if(!c)continue;const s=Re.data.find(f=>f.id===c);!s||s.senderId===D.id||(s.receipts||[]).some(f=>f.userId===D.id&&(f.status==="READ"||f.status==="SEEN"))||(Ut.current.add(c),t.unobserve(i))}Ut.current.size&&Ka()},{root:he.current,threshold:[.25]});lt.current=t;for(const n of Re.data){if(n.senderId===D.id||(n.receipts||[]).some(c=>c.userId===D.id&&(c.status==="READ"||c.status==="SEEN")))continue;const i=nt.current.get(n.id);i&&t.observe(i)}return()=>{t.disconnect()}},[a,Re.data,D?.id]),o.useEffect(()=>{const t=()=>{if(!he.current)return;const n=he.current.clientWidth;Lt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]);async function Hi(t,n="",r){if(!a||t.length===0)return;const i=!!S?.isSecret;if(i){if(qr){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!Un){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}Lr(!0),In(0);try{const c=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,s=[],d=t.reduce((j,m)=>j+m.size,0);for(const j of t)if(j.type.startsWith("image/")){const m=URL.createObjectURL(j),{width:b,height:E}=await Qa(m);s.push({url:m,type:"IMAGE",width:b,height:E,progress:0,__pending:!0})}else s.push({url:j.name,type:"FILE",__pending:!0,progress:0});Kn(j=>({...j,[a]:[...j[a]||[],{id:c,createdAt:Date.now(),senderId:D?.id||"me",attachments:s,content:n}]}));const f=[];let u=0;for(let j=0;j<t.length;j++){const m=t[j],b=s[j];let E=m,w;if(i&&S){const ae=new Uint8Array(await m.arrayBuffer()),oe=await Dt.encryptBinary(S,ae);E=new Blob([oe.cipher],{type:"application/octet-stream"}),w={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:oe.nonce,originalName:m.name,originalType:m.type,originalSize:m.size}}const M=new FormData;M.append("file",E,i?`${m.name||"file"}.enc`:m.name);const P={url:await new Promise((ae,oe)=>{const Q=new XMLHttpRequest;Q.open("POST","/api/upload");try{const te=mn.getState().session?.accessToken;te&&Q.setRequestHeader("Authorization",`Bearer ${te}`)}catch{}Q.upload.onprogress=te=>{if(te.lengthComputable){const F=Math.round((u+te.loaded)/d*100);In(F),Kn(J=>{const Se=(J[a]||[]).map(Ae=>({...Ae,attachments:Ae.attachments.map(Ge=>({...Ge}))})),ze=Se[Se.length-1];if(ze){const Ae=ze.attachments.findIndex(Ge=>Ge.__pending&&Ge.type===(m.type.startsWith("image/")?"IMAGE":"FILE")&&(!Ge.width||Ge.url.startsWith("blob:")));Ae>=0&&(ze.attachments[Ae].progress=F)}return{...J,[a]:Se}})}},Q.onreadystatechange=()=>{if(Q.readyState===4)if(Q.status>=200&&Q.status<300)try{const te=JSON.parse(Q.responseText);ae(te.url)}catch(te){oe(te)}else oe(new Error("upload failed"))},Q.send(M)}),type:m.type.startsWith("image/")?"IMAGE":"FILE"},se={};b&&b.type==="IMAGE"&&b.width&&b.height&&(se.width=b.width,se.height=b.height),w&&(se.e2ee=w),Object.keys(se).length>0&&(P.metadata=se),f.push(P),u+=m.size,In(Math.round(u/d*100))}const p=f.every(j=>j.type==="IMAGE")?"IMAGE":"FILE";await ne.post("/conversations/send",{conversationId:a,type:p,content:n,attachments:f,replyToId:r}),Kn(j=>{const b=(j[a]||[]).filter(E=>E.id!==c);if(b.length===0){const{[a]:E,...w}=j;return w}return{...j,[a]:b}}),X.invalidateQueries({queryKey:["messages",a]})}catch(c){console.error("Failed to upload attachments",c)}Lr(!1)}async function Qa(t){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=t})}const Ja=async()=>{if(a&&!ps)try{if(!(await ca({audio:!0})).ok){alert("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹");return}jt(),Mi([]);const n=new Kc({onStateChange:r=>{Ii(r==="recording"),r!=="recording"&&En.current&&(clearInterval(En.current),En.current=null)},onDurationUpdate:r=>{Ri(r)},onAmplitudeUpdate:r=>{Mi(i=>{const c=k?60:ms,s=[...i,r];return s.length>c?s.slice(-c):s})},onError:r=>{console.error("Voice recording error:",r),alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"),Ps()}});Pt.current=n,await n.start()}catch(t){console.error("Failed to start voice recording:",t),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ")}},Ps=()=>{if(!Pt.current)return;const t=Pt.current,n=t.getDuration(),r=t.stop();Pt.current=null,Ii(!1),Ri(0),r&&a&&eo(r,n)},Za=()=>{Pt.current&&(Pt.current.cancel(),Pt.current=null),En.current&&(clearInterval(En.current),En.current=null),Ii(!1),Ri(0),Mi([])},eo=async(t,n)=>{if(!a)return;const r=!!S?.isSecret;if(r){if(qr){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!Un){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}Lr(!0),In(0);try{const i=new File([t],"voice-message.webm",{type:t.type||"audio/webm"});let c=i,s;if(r&&S){const p=new Uint8Array(await i.arrayBuffer()),j=await Dt.encryptBinary(S,p);c=new Blob([j.cipher],{type:"application/octet-stream"}),s={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:j.nonce,originalName:i.name,originalType:i.type,originalSize:i.size}}const d=new FormData;d.append("file",c,r?`${i.name}.enc`:i.name);const u={url:await new Promise((p,j)=>{const m=new XMLHttpRequest;m.open("POST","/api/upload");try{const b=mn.getState().session?.accessToken;b&&m.setRequestHeader("Authorization",`Bearer ${b}`)}catch{}m.upload.onprogress=b=>{if(b.lengthComputable){const E=Math.round(b.loaded/b.total*100);In(E)}},m.onreadystatechange=()=>{if(m.readyState===4)if(m.status>=200&&m.status<300)try{const b=JSON.parse(m.responseText);p(b.url)}catch(b){j(b)}else j(new Error("upload failed"))},m.send(d)}),type:"AUDIO",size:i.size,...s?{metadata:{e2ee:s}}:{}};await ne.post("/conversations/send",{conversationId:a,type:"AUDIO",metadata:{duration:n},attachments:[u],replyToId:_?.id}),ee(null),X.invalidateQueries({queryKey:["messages",a]})}catch(i){console.error("Failed to send voice message",i),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")}finally{Lr(!1),In(0)}};o.useEffect(()=>()=>{Pt.current&&Pt.current.cleanup()},[]),o.useEffect(()=>{let t=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),bs(Math.round(performance.now()-r))}catch{bs(null)}};return n(),t=window.setInterval(n,15e3),()=>{t&&clearInterval(t)}},[]),o.useEffect(()=>{let t=null;const n=()=>X.invalidateQueries({queryKey:["conversations"]});return t=window.setInterval(n,2e4),()=>{t&&clearInterval(t)}},[X]);function Pi(t){const n=t.status,r=t.lastSeenAt?new Date(t.lastSeenAt):null;if(n==="ONLINE")return"ÐžÐÐ›ÐÐ™Ð";if(n==="BACKGROUND")return"Ð’ Ð¤ÐžÐÐ•";if(!r)return"Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½";const c=new Date().getTime()-r.getTime(),s=Math.floor(c/6e4);if(s<1)return"Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";if(s<60)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${s} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;const d=Math.floor(s/60);if(d<24)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${d} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;const f={hour:"2-digit",minute:"2-digit"},u=r.toLocaleDateString(),p=r.toLocaleTimeString([],f);return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${u} Ð² ${p}`}function Wi(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/3600),i=Math.floor(n%3600/60),c=n%60;return r>0?`${r}:${String(i).padStart(2,"0")}:${String(c).padStart(2,"0")}`:`${i}:${String(c).padStart(2,"0")}`}function Ws(t){const n=t?"conversations-list slider-panel":"conversations-list";return e.jsxs("aside",{className:n,children:[e.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{className:"logo",children:[e.jsx("span",{children:"Ð•"}),e.jsx("span",{className:"b",children:"Ð‘"}),e.jsx("span",{children:"Ð»ÑƒÑˆÐ°"})]}),e.jsx("div",{className:"subtitle",children:"Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÐ¼ÑÑ"})]})}),e.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx("div",{ref:vn,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:re.data?.slice().sort((r,i)=>{const c=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(i.conversation.messages?.[0]?.createdAt?new Date(i.conversation.messages[0].createdAt).getTime():0)-c}).filter(r=>{const i=r.conversation;return!(i.isSecret&&(i.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const i=r.conversation,c=i.participants.filter(m=>it?m.user.id!==it:!0).map(m=>m.user),s=c.map(m=>m.displayName??m.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",d=i.title??s,f=i.isGroup||i.participants.length>2,u=!!i.isSecret;c.map(m=>m.displayName??m.username).join(", ");const p=a===i.id,j=h===i.id;return e.jsxs("div",{onContextMenu:m=>{m.preventDefault(),m.stopPropagation(),Nt({open:!0,x:m.clientX,y:m.clientY,conversationId:i.id})},onClick:()=>Ln(i.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...j?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)"}:{}},children:[f?(()=>{const b=pn[i.id]?.active;return e.jsx(Ue,{name:d?.trim()?.charAt(0)||"Ð“",id:i.id,avatarUrl:i.avatarUrl&&i.avatarUrl.trim()?i.avatarUrl:void 0,presence:b?"IN_CALL":void 0})})():(()=>{const b=pn[i.id]?.active;return e.jsx(Ue,{name:c[0]?.displayName??c[0]?.username??"D",id:c[0]?.id??i.id,presence:b?"IN_CALL":c[0]?.status??"OFFLINE",avatarUrl:c[0]?.avatarUrl&&c[0].avatarUrl.trim()?c[0].avatarUrl:void 0})})(),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:d}),!f&&u&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:e.jsx(ea,{size:12,color:"#22c55e"})})]}),e.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…`:(()=>{const m=pn[i.id];if(m?.active){const b=m.startedAt?Date.now()-m.startedAt:typeof m.elapsedMs=="number"?m.elapsedMs:0;return e.jsx("span",{children:Wi(b)})}else if(m&&m.endedAt){const b=m.endedAt,w=Date.now()-b,M=Math.floor(w/6e4);if(M<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(M<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",M," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const H=Math.floor(M/60);if(H<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",H," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const P=new Date(b),se=P.toLocaleDateString(),ae=P.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",se," Ð² ",ae]})}return f?null:Pi(c[0]??{})})()})]})]},i.id)})}),Ie&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),Pe&&e.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),e.jsxs("div",{className:"conv-footer",children:[e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:12},children:[e.jsxs("div",{onClick:()=>je(!0),className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Ko,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Ð‘ÐµÑÐµÐ´Ð°"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})]}),e.jsxs("div",{onClick:qa,className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:pt.data&&pt.data.length>0?e.jsx(Xo,{size:22}):Qe.data&&Qe.data.length>0?e.jsx(kc,{size:22}):e.jsx(oa,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:pt.data&&pt.data.length>0?"ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ":Qe.data&&Qe.data.length>0?"Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})]})]}),e.jsxs("div",{className:"tile",onClick:()=>wr(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const r=Aa??wt.data?.status,i=Ea?"ONLINE":"OFFLINE",c=(r??i??"OFFLINE").toString().toUpperCase(),s=["ONLINE","AWAY","BACKGROUND","OFFLINE"],d=c,f=i,u=s.includes(d)?d:f,p=wt.data?.avatarUrl??D?.avatarUrl??void 0;return e.jsx(Ue,{name:D?.displayName??D?.username??"Me",id:D?.id??"me",presence:u,avatarUrl:p})})(),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:D?.displayName??D?.username??"Ð¯"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",wt.data?.eblid??"â€” â€” â€” â€”"]})]})]})]})]})]})}function Bs(t){const n=t?"messages-pane slider-panel":"messages-pane",r=qr,i=Un;let c="";return S?.isSecret&&(r?c="Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°.":_a?c=As?`Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Â«${As}Â»`:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.":i||(c="Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...")),e.jsxs("section",{className:n,children:[e.jsxs("header",{style:{...a?pn[a]?.active||y===a?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:k?"column":"row",justifyContent:k?"flex-start":"space-between",alignItems:k?"stretch":"center",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:k?"100%":"auto",padding:k?"0 8px":"0"},children:[t&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:Fa,children:e.jsx(_o,{size:18})}),S?(()=>{const s=S.participants.filter(m=>it?m.user.id!==it:!0).map(m=>m.user),d=s.map(m=>m.displayName??m.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",f=S.title??d,u=S.isGroup||S.participants.length>2;S.isSecret;const p=pn[S.id],j=p?.active;return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>tn(!0),style:{cursor:"pointer"},children:e.jsx(Ue,{name:f?.trim()?.charAt(0)||"Ð“",id:S.id,size:60,avatarUrl:S.avatarUrl&&S.avatarUrl.trim()?S.avatarUrl:void 0,presence:j?"IN_CALL":void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0,order:k?1:2},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),k&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:m=>{He({open:!0,anchor:m.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(pr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:j?e.jsx(e.Fragment,{children:(()=>{const m=p.participants||[],b=S.participants||[],E=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsxs(e.Fragment,{children:[p.active&&e.jsx("span",{children:Wi(E)}),b.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[p.startedAt&&" â€¢ ",b.map((w,M)=>{const H=w.user,P=m.length>0&&m.includes(H.id);return e.jsxs("span",{style:{fontWeight:P?700:400,color:P?"var(--brand-600)":"var(--text-muted)"},children:[M>0&&", ",H.displayName??H.username,P&&" âœ“"]},H.id)})]})]})})()}):p&&p.endedAt?(()=>{const m=p.endedAt,E=Date.now()-m,w=Math.floor(E/6e4);let M="";if(w<1)M="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";else if(w<60)M=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${w} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;else{const P=Math.floor(w/60);if(P<24)M=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${P} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;else{const se=new Date(m),ae=se.toLocaleDateString(),oe=se.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});M=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${ae} Ð² ${oe}`}}const H=S.participants||[];return e.jsxs(e.Fragment,{children:[e.jsx("span",{children:M}),H.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" â€¢ ",H.map((P,se)=>{const ae=P.user;return e.jsxs("span",{children:[se>0&&", ",ae.displayName??ae.username]},ae.id)})]})]})})():s.map(m=>m.displayName??m.username).join(", ")})]})]}):(()=>{const m=s[0];return e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(Ue,{name:m?.displayName??m?.username??"D",id:m?.id??S.id,avatarUrl:m?.avatarUrl&&m.avatarUrl.trim()?m.avatarUrl:void 0,presence:p?.active?"IN_CALL":m?.status??"OFFLINE",size:60})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),k&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:b=>{He({open:!0,anchor:b.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(pr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const b=y===a;if((p?.active||b)&&p){const E=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsx("span",{children:Wi(E)})}if(p&&p.endedAt&&!b){const E=p.endedAt,M=Date.now()-E,H=Math.floor(M/6e4);if(H<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(H<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",H," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const P=Math.floor(H/60);if(P<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",P," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const se=new Date(E),ae=se.toLocaleDateString(),oe=se.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",ae," Ð² ",oe]})}return m?m.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":m.status==="BACKGROUND"?"Ð’ Ð¤ÐžÐÐ•":Pi(m):""})()})]})]})})()})():e.jsx("div",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚"})]}),za&&S&&!!S.isSecret&&(S.participants?.length??0)<=2&&typeof document<"u"&&gr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:k?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>rr(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:k?16:20,borderRadius:k?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:k?"center":"left"},onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:k?"column":"row",gap:k?8:0},children:[e.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚?"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>rr(!1),style:{alignSelf:k?"flex-end":void 0},children:e.jsx(xt,{size:18})})]}),e.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ñƒ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."}),e.jsxs("div",{style:{display:"flex",justifyContent:k?"center":"flex-end",alignItems:"center",flexDirection:k?"column":"row",gap:k?12:8},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>rr(!1),style:k?{width:"100%"}:void 0,children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:k?"100%":void 0},onClick:async()=>{if(a)try{await ne.delete(`/conversations/${a}`),X.invalidateQueries({queryKey:["conversations"]}),X.removeQueries({queryKey:["messages",a]}),rr(!1),l(null)}catch(s){console.error("Failed to end secret conversation:",s)}},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ"})]})]})}),document.body),a&&(()=>{const s=pn[a],d=s?.active,f=S?.isGroup||(S?.participants.length??0)>2,u=y===a,p=h===a&&!u,j=D?.id,m=f&&d&&j&&s?.participants?.includes(j),b=!f&&(u||h===a||G.activeConvId===a||d&&(G.activeConvId===a||h===a)),E=m||b,w={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:k?"8px 12px":"12px 16px",flex:k?1:"auto",minWidth:k?0:"auto",fontSize:k?"14px":"15px",fontWeight:k?500:600,height:k?"42px":"46px",minHeight:k?"42px":"46px",boxSizing:"border-box"},M={display:"flex",alignItems:"center",gap:8,width:k?"100%":"auto",padding:k?"0 8px":"0",justifyContent:k?"center":"flex-end",marginLeft:k?0:"auto"},H={display:"inline-flex",alignItems:"center",justifyContent:"center",width:k?42:44,height:k?42:44,minWidth:k?42:44,padding:0,margin:0,borderRadius:999},P=async()=>{if(a&&await $r(!1))try{_r(a),Qs(a,!1),G.startOutgoing(a,!1),Ze(F=>{const J=F[a],ie=D?.id;return J?.active?ie&&J.participants&&!J.participants.includes(ie)?{...F,[a]:{...J,participants:[...J.participants,ie]}}:F:{...F,[a]:{startedAt:Date.now(),active:!0,participants:ie?[ie]:[]}}});const Q=re.data?.find(F=>F.conversation.id===a)?.conversation;if(Q?.isGroup||(Q?.participants?.length??0)>2)x(a),C(F=>F===a?null:F);else{const F=a;I({conversationId:F,startedAt:Date.now(),video:!1}),Hs(),z.current&&window.clearTimeout(z.current),z.current=window.setTimeout(()=>{I(J=>J?.conversationId===F?(Qt(),Qr(),fr(F),Ze(ie=>{const Se=ie[F];if(Se?.active)return{...ie,[F]:{...Se,active:!1,endedAt:Date.now()}};const{[F]:ze,...Ae}=ie;return Ae}),G.endCall(),null):J),z.current=null},3e4)}}catch(Q){console.error("Error starting call:",Q)}},se=async()=>{if(a&&await $r(!0))try{_r(a),Qs(a,!0),G.startOutgoing(a,!0),Ze(F=>{const J=F[a],ie=D?.id;return J?.active?ie&&J.participants&&!J.participants.includes(ie)?{...F,[a]:{...J,participants:[...J.participants,ie]}}:F:{...F,[a]:{startedAt:Date.now(),active:!0,participants:ie?[ie]:[]}}});const Q=re.data?.find(F=>F.conversation.id===a)?.conversation;if(Q?.isGroup||(Q?.participants?.length??0)>2)x(a),C(F=>F===a?null:F);else{const F=a;I({conversationId:F,startedAt:Date.now(),video:!0}),Hs(),z.current&&window.clearTimeout(z.current),z.current=window.setTimeout(()=>{I(J=>J?.conversationId===F?(Qt(),Qr(),fr(F),Ze(ie=>{const Se=ie[F];if(Se?.active)return{...ie,[F]:{...Se,active:!1,endedAt:Date.now()}};const{[F]:ze,...Ae}=ie;return Ae}),G.endCall(),null):J),z.current=null},3e4)}}catch(Q){console.error("Error starting call:",Q)}},ae=()=>{a&&(x(a),C(null))},oe=()=>d||u?E?e.jsxs(e.Fragment,{children:[!p&&e.jsxs("button",{className:"btn btn-secondary",onClick:ae,style:w,children:[e.jsx(ta,{size:k?16:18}),k?"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ":" Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"]}),e.jsxs("button",{className:"btn",onClick:()=>{const Q=S?.participants?.length??0,te=Q<=2,F=S?.isGroup||Q>2;if(te&&h)fr(h),Ze(J=>{const ie=J[h];return ie?.active?{...J,[h]:{...ie,active:!1,endedAt:Date.now()}}:J});else if(F&&h){try{To(h)}catch{}Ze(J=>{const ie=J[h];if(!ie||!ie.participants)return J;const Se=D?.id;return!Se||!ie.participants.includes(Se)?J:{...J,[h]:{...ie,participants:ie.participants.filter(ze=>ze!==Se)}}})}x(null),C(null),G.endCall(),jt()},style:{...w,background:"#ef4444",color:"#fff"},children:[e.jsx(Gi,{size:k?16:18}),k?"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ":" Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),!k&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:Q=>{He({open:!0,anchor:Q.currentTarget})},style:H,children:e.jsx(pr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){x(a),C(te=>te===a?null:te),G.startOutgoing(a,!1);try{Ks(a,!1)}catch{}}else x(a),C(te=>te===a?null:te),G.startOutgoing(a,!1)},style:w,children:[e.jsx(qi,{size:k?16:18}),k?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){x(a),C(te=>te===a?null:te),G.startOutgoing(a,!0);try{Ks(a,!0)}catch{}}else x(a),C(te=>te===a?null:te),G.startOutgoing(a,!0)},style:w,children:[e.jsx(Vi,{size:k?16:18}),k?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾"]}),!k&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:Q=>{He({open:!0,anchor:Q.currentTarget})},style:H,children:e.jsx(pr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{P()},style:w,children:[e.jsx(qi,{size:k?16:18}),k?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº":" Ð—Ð²Ð¾Ð½Ð¾Ðº"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{se()},style:w,children:[e.jsx(Vi,{size:k?16:18}),k?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾":" Ð’Ð¸Ð´ÐµÐ¾"]}),!k&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:Q=>{He({open:!0,anchor:Q.currentTarget})},style:H,children:e.jsx(pr,{size:22})})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:M,children:oe()}),Rn&&e.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:k?"100%":420,width:k?"100%":"auto"},children:[e.jsx("span",{style:{flex:1},children:Rn}),e.jsx("button",{type:"button",onClick:()=>Vn(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:e.jsx(xt,{size:14})})]})]})})()]}),!S?.isSecret&&Hn&&e.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:k?"column":"row",gap:12,alignItems:k?"stretch":"center"},children:Hn.isInitiator?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1},children:"Ð–Ð´Ñ‘Ð¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚."}),e.jsx("div",{style:{display:"flex",gap:8},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Ms(Hn.conversationId),disabled:Ai,style:{color:"#f87171"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[Hn.initiatorName," Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ."]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>Pa(Hn.conversationId),disabled:Ai,children:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>Ms(Hn.conversationId),disabled:Ai,style:{color:"#bae6fd"},children:"ÐžÑ‚ÐºÐ°Ð·Ð°Ñ‚ÑŒÑÑ"})]})]})}),e.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),e.jsx("div",{ref:he,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:a?S?.isSecret&&(!i||r)?e.jsx("div",{className:"messages-empty",children:c}):(()=>{const s=(gt?[...gt]:[]).filter(u=>!u.deletedAt).sort((u,p)=>new Date(u.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),d=Br,f=[...s||[],...d];return f?f.map((u,p)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const j=f[p-1],m=f[p+1],b=!m||m.senderId!==u.senderId,E=!!j&&j.senderId===u.senderId,w=u.senderId===D?.id,P=`${ye?"msg left":w?"msg me":"msg them"} ${E?"compact":"gap"}`,se=ye?"msg-bubble left":w?"msg-bubble me":"msg-bubble them",ae=b?`${se} ${w&&!ye?"tail-right":"tail-left"}`:se,oe=Ns[u.senderId],Q=oe?.displayName??oe?.username??(w?D?.displayName??D?.username??"Me":"User"),te=oe?.id??(w?D?.id??"me":"user"),F=w?"#303845":$a(u.senderId),J="#f1f3f6",ie=ye&&b,Se=ye,ze=u.createdAt?new Date(u.createdAt):null,Ae=ze?ze.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",Ge=(S?.participants||[]).map(A=>A.user.id).filter(A=>it?A!==it:!0),Wt=u.receipts||[],or=w&&Ge.some(A=>Wt.some(Z=>Z.userId===A&&(Z.status==="READ"||Z.status==="SEEN"))),cr=w&&or?"âœ“":"",Zr=(A,Z)=>{ct({open:!0,x:A,y:Z,messageId:u.id})},no=A=>{A.preventDefault(),Zr(A.clientX,A.clientY)},ro=()=>{const A=u.replyTo?.id;if(!A)return;const Z=nt.current.get(A);Z&&Z.scrollIntoView({behavior:"smooth",block:"center"})},Fs=f.filter(A=>(A.attachments||[]).some(Z=>Z.type==="IMAGE")).flatMap(A=>A.attachments.filter(Z=>Z.type==="IMAGE").map(Z=>Ls(Z)).filter(Z=>!!Z)),io=A=>{const Z=Fs.findIndex(Fe=>Fe===A);Vt({open:!0,index:Z>=0?Z:0,items:Fs})},so=k?{}:{onContextMenu:no,...{onPointerDown:A=>{const Z=window.setTimeout(()=>Zr(A.clientX,A.clientY),450),Fe=()=>{window.clearTimeout(Z),window.removeEventListener("pointerup",Fe),window.removeEventListener("pointermove",st)},st=()=>{window.clearTimeout(Z),window.removeEventListener("pointerup",Fe),window.removeEventListener("pointermove",st)};window.addEventListener("pointerup",Fe,{passive:!0}),window.addEventListener("pointermove",st,{passive:!0})}}};return e.jsxs("div",{className:P,...so,children:[Se&&(ie?e.jsx(Ue,{name:Q,id:te,avatarUrl:(()=>{const A=Ns[u.senderId]?.avatarUrl;return A&&A.trim()?A:void 0})()}):e.jsx("div",{className:"avatar-spacer"})),e.jsxs("div",{className:ae,"data-mid":u.id,ref:A=>{if(!A){nt.current.delete(u.id);return}nt.current.set(u.id,A),lt.current?.observe(A)},style:{"--bubble-bg":F,"--bubble-fg":J},onClick:A=>{if(!k||A.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const Fe=typeof window.getSelection=="function"?window.getSelection():null;Fe&&Fe.toString()||Zr(A.clientX,A.clientY)},onContextMenu:A=>{if(A.target.closest(".reaction-emoji")){A.preventDefault(),A.stopPropagation();return}Zr(A.clientX,A.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const A={};for(const Z of u.reactions)A[Z.emoji]||(A[Z.emoji]={count:0,hasMine:!1}),A[Z.emoji].count++,Z.userId===D?.id&&(A[Z.emoji].hasMine=!0);return e.jsx("div",{style:{position:"absolute",bottom:-18,right:w?8:void 0,left:w?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(A).map(([Z,Fe],st)=>{const lr=Z==="â¤ï¸"?"#ef4444":"#ffc46b";return e.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async mt=>{mt.preventDefault(),mt.stopPropagation();try{Fe.hasMine?await ne.post("/messages/unreact",{messageId:u.id,emoji:Z}):await ne.post("/messages/react",{messageId:u.id,emoji:Z}),a&&X.invalidateQueries({queryKey:["messages",a]})}catch(Pn){console.error("Error toggling reaction:",Pn)}},onMouseDown:mt=>{mt.stopPropagation()},style:{fontSize:12,color:lr,display:"inline-block",animation:`reactionBounce 0.6s ease ${st*.1}s`,cursor:"pointer",opacity:Fe.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[Z,Fe.count>1?` ${Fe.count}`:""]},Z)})})})(),u.replyTo&&e.jsxs("div",{onClick:ro,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:w?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°: ",u.replyTo.content??"ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(u.attachments||[]).map((A,Z)=>{const Fe=A.metadata??{},st=Ls(A),ei=!!(S?.isSecret&&Fe?.e2ee?.kind==="ciphertext"),lr=ei?Qn[A.url]:void 0,mt=ei&&!st&&(!lr||lr.status==="pending"),Pn=ei&&lr?.status==="error",Bi=Fe?.e2ee?.originalName||A.url?.split("/").pop()||"Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ";if(A.type==="AUDIO"){const dr=u.metadata?.duration||0,Oi=st||A.url;return e.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:mt?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[e.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{style:{fontSize:13},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð°ÑƒÐ´Ð¸Ð¾..."})]}):Pn?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°ÑƒÐ´Ð¸Ð¾"}):Oi?e.jsx(rl,{url:Oi,duration:dr}):e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})},`${A.url}-${Z}`)}if(A.type==="IMAGE"){const dr=typeof window<"u"?window.innerWidth:1280,ur=dr<=768?Math.max(320,Math.floor(dr/2)):Math.min(600,Math.max(320,Math.floor(dr/3))),ao=`${A.url||Z}`,_s=La[ao],hr=_s?.width||A.width||A.metadata?.width||ur,ti=_s?.height||A.height||A.metadata?.height||Math.round(hr*.75),ni=ti/hr||.75,ri=ur;let Wn=ur;ni<.5?Wn=Math.max(Math.round(ur*.6),200):ni<.7&&(Wn=Math.max(Math.round(ur*.75),200));const oo=hr>ri?ri/hr:1,co=ti>Wn?Wn/ti:1,$s=Math.min(oo,co,1);let Jt=hr*$s,Et=ti*$s;Jt>ri&&(Jt=ri,Et=Jt*ni),Et>Wn&&(Et=Wn,Jt=Et/ni),Jt=Math.round(Jt),Et=Math.round(Et);const Fi=`${A.url||Z}`,_i=!!Ta[Fi],ii=A.__pending||mt||!_i;return e.jsxs("div",{style:{maxWidth:"100%",maxHeight:Et,width:ii?Math.min(Jt,typeof window<"u"?window.innerWidth-100:Jt):"fit-content",height:ii?Et:"auto",minWidth:0,minHeight:ii?Et:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[ii&&e.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),mt?e.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ..."}):typeof A.progress=="number"&&A.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[A.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Pn&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"}),st&&!Pn&&e.jsx("img",{src:st,alt:"img",style:{maxWidth:"100%",maxHeight:Et,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:A.__pending?.85:1,display:_i?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:$i=>{const gn=$i.target;if(!A.width&&!Fe?.width&&gn.naturalWidth&&gn.naturalHeight&&Na(Bn=>({...Bn,[Fi]:{width:gn.naturalWidth,height:gn.naturalHeight}})),Da(Bn=>({...Bn,[Fi]:!0})),he.current&&Be.current){const Bn=he.current;Bn.scrollTop=Bn.scrollHeight}},onError:$i=>{const gn=$i.target;gn&&(gn.style.display="none")},onClick:()=>{!A.__pending&&!mt&&st&&io(st)}}),_i&&!mt&&typeof A.progress=="number"&&A.progress<100&&e.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:e.jsx("div",{style:{width:`${A.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`${A.url}-${Z}`)}return e.jsxs("div",{style:{marginTop:8},children:[A.__pending||mt?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Ð¤Ð°Ð¹Ð»: ",Bi,mt&&" (Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°...)"]}):Pn?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»"}):e.jsxs("a",{href:st||A.url,target:"_blank",rel:"noreferrer",download:Bi,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Ð¤Ð°Ð¹Ð»: ",Bi]}),typeof A.progress=="number"&&A.progress<100&&e.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:e.jsx("div",{style:{width:`${A.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${A.url}-${Z}`)})]}),e.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[Ae," ",cr]})]})]},u.id)}):null})():e.jsx("div",{className:"messages-empty",children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ"})}),a&&e.jsx("button",{className:We?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{he.current&&he.current.scrollTo({top:he.current.scrollHeight,behavior:"smooth"}),Be.current=!0,ue.current=!1,kt(!1)},children:"â†“"}),e.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:s=>{s.preventDefault(),ki(!0)},onDragLeave:()=>ki(!1),onDrop:async s=>{s.preventDefault(),ki(!1);const d=Array.from(s.dataTransfer.files||[]);if(!d.length||!a)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>nr(p,"upload")),u.length&&await Hi(u)},children:S?.isSecret&&(!i||r)?e.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:c}):e.jsxs(e.Fragment,{children:[_&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsx(gc,{size:16,color:"var(--text-muted)"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°:"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:_.preview}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>ee(null),style:{marginLeft:"auto",flexShrink:0},children:e.jsx(xt,{size:16})})]}),Ht.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹"}),e.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:Ht.map(s=>e.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[e.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{zr===s.id&&Mt(null),Ra(s.id)},"aria-label":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx(xt,{size:14})}),e.jsx("button",{type:"button",onClick:()=>Mt(s.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx("img",{src:s.previewUrl,alt:s.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:s.fileName}),e.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>Mt(s.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),s.edited&&e.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"})]})]},s.id))})]}),e.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:N,onChange:async s=>{const d=Array.from(s.target.files||[]);if(!a||d.length===0)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>nr(p,"upload")),u.length&&await Hi(u),s.target.value=""}}),ps?e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),e.jsx("div",{ref:tr,style:{width:"100%",...k?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const u=k?60:ms;return er.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(u).fill(0).map((p,j)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${j*.1}s`,flexShrink:0}},j))}):e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:er.length>u?`translateX(-${(er.length-u)*4}px)`:"translateX(0)",transition:"none"},children:er.slice(-u).map((p,j)=>{const m=Math.max(4,p/100*20);return e.jsx("div",{style:{width:2,height:`${m}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${er.length-u+j}-${j}`)})})})()}),e.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor(gs/60),":",(gs%60).toString().padStart(2,"0")]})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:Za,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ",children:e.jsx(xt,{size:16})}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Ps,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:e.jsx(ra,{size:16})})]}):e.jsxs("form",{autoComplete:"off",onSubmit:async s=>{if(s.preventDefault(),!a)return;const d=q.trim();if(Ht.length>0){const f=Ht.map(u=>({file:u.file,previewUrl:u.previewUrl}));Zn([]),Mt(null),f.forEach(u=>fn(u.previewUrl)),await Hi(f.map(u=>u.file),d||"",_?.id),O(""),ee(null)}else d&&(await Es(S,{type:"TEXT",content:d,replyToId:_?.id}),O(""),ee(null));X.invalidateQueries({queryKey:["messages",a]}),setTimeout(()=>{he.current&&(he.current.scrollTop=he.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>N.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:k?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹",children:[e.jsx(uc,{size:16}),!k&&e.jsx("span",{children:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),e.jsx("input",{type:"text",placeholder:Ht.length>0?"Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼...":"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...",value:q,onChange:s=>O(s.target.value),onPaste:s=>{if(!a)return;const d=s.clipboardData?.items;if(d)for(let f=0;f<d.length;f++){const u=d[f];if(u.type.indexOf("image")!==-1){s.preventDefault();const p=u.getAsFile();p&&nr(p,"paste");break}}},ref:ce,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:Ja,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:k?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:[e.jsx(oc,{size:16}),!k&&e.jsx("span",{children:"Ð“Ð¾Ð»Ð¾Ñ"})]}),e.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:k?0:6,height:46,minHeight:46,padding:"0 12px"},children:[e.jsx(ra,{size:16}),!k&&e.jsx("span",{children:"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]}),ka&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:e.jsx("div",{style:{width:`${Ia}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),e.jsx(o.Suspense,{fallback:null,children:h&&e.jsx(Zc,{open:!!h,conversationId:h,minimized:y===h,peerAvatarUrl:(()=>{const d=(h?re.data?.find(f=>f.conversation.id===h)?.conversation:S)?.participants||[];return d.length===2?d.find(u=>it?u.user.id!==it:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const d=(h?re.data?.find(u=>u.conversation.id===h)?.conversation:S)?.participants||[],f={};for(const u of d){const p=u.user,j=p.displayName??p.username??p.id;f[j]=p.avatarUrl??null}return D&&(f[D.displayName??D.username??D.id]=wt.data?.avatarUrl??D.avatarUrl??null),f})(),avatarsById:(()=>{const d=(h?re.data?.find(u=>u.conversation.id===h)?.conversation:S)?.participants||[],f={};for(const u of d){const p=u.user;f[p.id]=p.avatarUrl??null}return D&&(f[D.id]=wt.data?.avatarUrl??D.avatarUrl??null),f})(),localUserId:D?.id??null,isGroup:!!(h?re.data?.find(d=>d.conversation.id===h)?.conversation:S)?.isGroup,onMinimize:()=>{if(h){const s=h;C(s);const d=Fr(s);!!!(d?.isGroup||(d?.participants?.length??0)>2)&&G.activeConvId!==s&&G.startOutgoing(s,G.initialVideo),h!==s&&x(s)}},onClose:s=>{const d=h??An.current;if(!d||y===d)return;const f=()=>{const u=Fr(d),p=u?.participants?.length??0,j=!!(u?.isGroup||p>2);!j&&fr(d),Ze(b=>{const E=b[d];if(!E)return b;if(j){const w=(E.participants||[]).filter(M=>it?M!==it:!0);return{...b,[d]:{...E,participants:w}}}return E.active?{...b,[d]:{...E,active:!1,endedAt:Date.now()}}:b}),x(b=>b===d?null:b),C(b=>b===d?null:b),G.endCall(),jt()};!s?.manual&&Dn(d)?Di(d,f):(Kt(d),f())},initialVideo:G.initialVideo,initialAudio:G.initialAudio})}),e.jsx(Ac,{open:!!Or,image:Or,onClose:()=>Mt(null),onApply:({file:s,previewUrl:d})=>{Or&&(Ma(Or.id,s,d),Mt(null))}}),v&&(()=>{const s=re.data?.find(w=>w.conversation.id===v.conversationId)?.conversation,d=s?.isGroup||(s?.participants?.length??0)>2;if(d)return null;let f="ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u,p=v.conversationId;if(d)f=s?.title??"Ð“Ñ€ÑƒÐ¿Ð¿Ð°",u=s?.avatarUrl,p=v.conversationId;else{const w=s?.participants?.find(M=>M.user.id!==D?.id)?.user;if(w)f=w.displayName??w.username??w.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u=w.avatarUrl,p=w.id;else{const M=Qe.data?.find(H=>(H.conversationIds||[]).includes(v.conversationId));M?.friend&&(f=M.friend.displayName??M.friend.username??M.friend.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u=M.friend.avatarUrl,p=M.friend.id)}}const j=Math.floor((Date.now()-v.startedAt)/1e3),m=Math.floor(j/60),b=j%60,E=`${m}:${b.toString().padStart(2,"0")}`;return gr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700},children:v.video?"Ð’Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð—Ð²Ð¾Ð½Ð¾Ðº"}),!v.minimized&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{I(w=>w?{...w,minimized:!0}:null)},style:{padding:8},children:e.jsx(lc,{size:18})})]}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[e.jsx(Ue,{name:f,id:p,size:64,avatarUrl:u}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:f}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð´Ð¾Ð·Ð²Ð¾Ð½â€¦"})]}),e.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:E})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{z.current&&(window.clearTimeout(z.current),z.current=null),Qt(),Qr(),fr(v.conversationId),I(null),Ze(w=>{const M=w[v.conversationId];if(M?.active)return{...w,[v.conversationId]:{...M,active:!1,endedAt:Date.now()}};const{[v.conversationId]:H,...P}=w;return P}),G.endCall()},children:[e.jsx(Gi,{size:18}),e.jsx("span",{children:"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"})]}),v.minimized&&e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{I(w=>w?{...w,minimized:!1}:null)},children:[e.jsx(ta,{size:18}),e.jsx("span",{children:"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"})]})]})]})}),document.body)})(),G.incoming&&gr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:12},children:G.incoming.video?"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð°ÑƒÐ´Ð¸Ð¾Ð·Ð²Ð¾Ð½Ð¾Ðº"}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[e.jsx(Ue,{name:G.incoming.from.name??G.incoming.from.id,id:G.incoming.from.id,size:64,avatarUrl:G.incoming.from.avatarUrl??re.data?.find(s=>s.conversation.id===G.incoming.conversationId)?.conversation?.participants?.find(s=>s.user.id===G.incoming.from.id)?.user?.avatarUrl??Qe.data?.find(s=>s.friend?.id===G.incoming.from.id)?.friend?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:G.incoming.from.name??G.incoming.from.id}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð·Ð²Ð¾Ð½Ð¸Ñ‚â€¦"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Xr(!1)},children:[e.jsx(qi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ"})]}),e.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Xr(!0)},children:[e.jsx(Vi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"})]})]}),e.jsx("div",{style:{display:"flex"},children:e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ni()},children:[e.jsx(Gi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})}),Rn&&e.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:Rn})]})]})}),document.body)]})}function Os(t,n){n&&X.setQueryData(["messages",t],r=>{const i=Array.isArray(r)?[...r]:[];return i.some(c=>c.id===n.id)||(i.push(n),i.sort((c,s)=>new Date(c.createdAt||0).getTime()-new Date(s.createdAt||0).getTime())),i})}function to(t,n){n&&X.setQueryData(["messages",t],r=>{if(!Array.isArray(r))return r;const i=r.findIndex(s=>s.id===n.id);if(i===-1)return r;const c=[...r];return c[i]={...c[i],...n},c})}return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:k?"chats-page mobile-slider":"chats-page",children:k?e.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${bt==="conversation"?"-100vw":"0"})`},onTouchStart:t=>{const n=t.touches[0];Ve.current={x:n.clientX,y:n.clientY},Ke.current=0},onTouchMove:t=>{if(!Ve.current)return;const n=t.touches[0];Ke.current=n.clientX-Ve.current.x},onTouchEnd:()=>{const t=Ke.current;Ve.current=null,!(Math.abs(t)<50)&&(t<0&&a&&fe("conversation"),t>0&&fe("list"))},children:[Ws(!0),Bs(!0)]}):e.jsxs(e.Fragment,{children:[Ws(!1),Bs(!1)]})}),Ca&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>wr(!1),children:e.jsx(xt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(Ue,{name:D?.displayName??D?.username??"Me",id:D?.id??"me",avatarUrl:ht??wt.data?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:D?.displayName??D?.username}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",wt.data?.eblid??"â€” â€” â€” â€”"]})]})]}),e.jsx("input",{ref:cs,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){Cr(n);try{Sr(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!ht&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>cs.current?.click(),onDragOver:t=>{t.preventDefault(),Ci(!0)},onDragLeave:()=>Ci(!1),onDrop:t=>{t.preventDefault(),Ci(!1);const n=t.dataTransfer.files?.[0];if(n){Cr(n);try{Sr(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(us?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:us?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(Xi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),ht&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:ln,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,ve.scale*(1+n))),i=ln.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,s=t.clientY-i.top,d=r/ve.scale,f=c-(c-ve.x)*d,u=s-(s-ve.y)*d;Gt({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=ln.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,s=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,m=p-s;if(j*j+m*m>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const b=t.clientX,E=t.clientY,w={...ve},M=P=>{P.preventDefault();const se=P.clientX-b,ae=P.clientY-E;Gt({...w,x:w.x+se,y:w.y+ae})},H=()=>{window.removeEventListener("pointermove",M),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",M,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:wi,src:ht,alt:"preview",style:{position:"absolute",left:ve.x,top:ve.y,transform:`scale(${ve.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=ln.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,s=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=s/d,m=s/f,b=Math.max(j,m)*1.2,E=u-d*b/2,w=p-f*b/2;Gt({x:E,y:w,scale:b})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(ve.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Gt(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.05,value:ve.scale,onChange:t=>Gt(n=>({...n,scale:parseFloat(t.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Gt(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:e.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:k?"Ð”Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°, Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ":"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾ Ð¼Ñ‹ÑˆÐ¸ Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°"})})]}),e.jsx("canvas",{ref:kr,width:240,height:240,style:{display:"none"}})]}),bi&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{Cr(null),ht&&URL.revokeObjectURL(ht),Sr(null)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:Sn,onClick:async()=>{if(bi){jr(!0),Ir(0);try{let t=null;if(kr.current&&ht){const i=await new Promise(w=>{const M=new Image;M.onload=()=>w(M),M.src=ht}),c=kr.current.getContext("2d"),s=240;c.clearRect(0,0,s,s),c.save(),c.beginPath(),c.arc(s/2,s/2,s/2,0,Math.PI*2),c.closePath(),c.clip();const d=ln.current?.clientWidth??320,f=ln.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-s/2,y:u.y-s/2,w:s,h:s},j=(p.x-ve.x)/ve.scale,m=(p.y-ve.y)/ve.scale,b=p.w/ve.scale,E=p.h/ve.scale;c.drawImage(i,j,m,b,E,0,0,s,s),c.restore(),t=await new Promise(w=>kr.current.toBlob(M=>w(M),"image/png"))}const n=new FormData;n.append("file",t??bi);const r=await new Promise((i,c)=>{const s=new XMLHttpRequest;s.open("POST","/api/upload");try{const d=mn.getState().session?.accessToken;d&&s.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}s.upload.onprogress=d=>{d.lengthComputable&&Ir(Math.round(100*d.loaded/d.total))},s.onreadystatechange=()=>{if(s.readyState===4)if(s.status>=200&&s.status<300)try{const d=JSON.parse(s.responseText);i(d.url)}catch(d){c(d)}else c(new Error("upload failed"))},s.send(n)});await ne.patch("/status/me",{avatarUrl:r}),Cr(null),ht&&URL.revokeObjectURL(ht),Sr(null),wt.refetch()}catch{}jr(!1),kn("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>kn(null),2200)}},children:Sn?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),Sn&&e.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${os}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),Dr&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[e.jsx(Zs,{size:16}),e.jsx("span",{children:Dr})]}),e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:e.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await ne.post("/auth/logout")}catch{}mn.getState().setSession(null),wr(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[e.jsx(Yi,{size:18}),e.jsx("span",{children:"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð•Ð±Ð»ÑƒÑˆÐ¸"})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>wr(!1),children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})}),on&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>Je(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Je(!1),children:e.jsx(xt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(Ue,{name:$e.trim()||"?",id:"new-group-avatar-preview",avatarUrl:Xt??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:$e||"ÐÐ¾Ð²Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:hi,type:"file",accept:"image/*",style:{display:"none"},onChange:t=>{const n=t.target.files?.[0];if(n){if(jn(n),xe)try{URL.revokeObjectURL(xe)}catch{}try{const r=URL.createObjectURL(n);Ee(r)}catch{Ee(null)}It({x:0,y:0,scale:1})}}}),!xe&&e.jsx(e.Fragment,{children:e.jsxs("div",{onClick:()=>hi.current?.click(),onDragOver:t=>{t.preventDefault(),pi(!0)},onDragLeave:()=>pi(!1),onDrop:t=>{t.preventDefault(),pi(!1);const n=t.dataTransfer.files?.[0];if(n){if(jn(n),xe)try{URL.revokeObjectURL(xe)}catch{}try{const r=URL.createObjectURL(n);Ee(r)}catch{Ee(null)}It({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(as?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:as?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(Xi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})}),xe&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:cn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ne.scale*(1+n))),i=cn.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,s=t.clientY-i.top,d=r/Ne.scale,f=c-(c-Ne.x)*d,u=s-(s-Ne.y)*d;It({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=cn.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,s=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,m=p-s;if(j*j+m*m>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const b=t.clientX,E=t.clientY,w={...Ne},M=P=>{P.preventDefault();const se=P.clientX-b,ae=P.clientY-E;It({...w,x:w.x+se,y:w.y+ae})},H=()=>{window.removeEventListener("pointermove",M),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",M,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:xa,src:xe,alt:"preview",style:{position:"absolute",left:Ne.x,top:Ne.y,transform:`scale(${Ne.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=cn.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,s=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=s/d,m=s/f,b=Math.max(j,m)*1.2,E=u-d*b/2,w=p-f*b/2;It({x:E,y:w,scale:b})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>It(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Ne.scale,onChange:t=>{const n=parseFloat(t.target.value),r=cn.current?.getBoundingClientRect();if(!r){It(u=>({...u,scale:n}));return}const i=r.width/2,c=r.height/2,s=n/Ne.scale,d=i-(i-Ne.x)*s,f=c-(c-Ne.y)*s;It({x:d,y:f,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>It(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:fi,width:240,height:240,style:{display:"none"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>{Je(!1)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:!xe,onClick:async()=>{if(!xe||!fi.current){Je(!1);return}try{const t=await new Promise(E=>{const w=new Image;w.onload=()=>E(w),w.src=xe}),n=fi.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const i=240;r.clearRect(0,0,i,i),r.save(),r.beginPath(),r.arc(i/2,i/2,i/2,0,Math.PI*2),r.closePath(),r.clip();const c=cn.current?.clientWidth??320,s=cn.current?.clientHeight??320,d={x:c/2,y:s/2},f={x:d.x-i/2,y:d.y-i/2,w:i,h:i},u=(f.x-Ne.x)/Ne.scale,p=(f.y-Ne.y)/Ne.scale,j=f.w/Ne.scale,m=f.h/Ne.scale;r.drawImage(t,u,p,j,m,0,0,i,i),r.restore();const b=await new Promise(E=>n.toBlob(w=>E(w),"image/png"));if(b){if(Xt)try{URL.revokeObjectURL(Xt)}catch{}const E=URL.createObjectURL(b);qn(b),Gn(E)}}catch{}finally{Je(!1)}},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]})]})}),Oe&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:zi,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700},children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:zi,children:e.jsx(xt,{size:16})})]}),(()=>{const t=$e.trim(),n=t||"?";return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[e.jsx("input",{placeholder:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ",value:$e,onChange:r=>ut(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),e.jsx("input",{ref:hi,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const i=r.target.files?.[0];if(i){if(jn(i),xe)try{URL.revokeObjectURL(xe)}catch{}try{const c=URL.createObjectURL(i);Ee(c)}catch{Ee(null)}Je(!0)}}}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>Je(!0),title:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:e.jsx(Ue,{name:n,id:"new-group-avatar",avatarUrl:Xt??void 0,size:40})})]})})(),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:Qe.data?.map(t=>{const n=t.friend,r=Ft.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>_t(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[e.jsx(Ue,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾":"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},t.id)})}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:e.jsx("button",{className:"btn btn-primary",disabled:Ft.length===0||$t,onClick:async()=>{if(!(Ft.length===0||$t)){Yn(!0);try{const t=await ne.post("/conversations",{participantIds:Ft,title:$e||void 0,isGroup:!0}),n=t.data?.conversation?.id;if(n&&(Cn||vr))try{const r=new FormData;r.append("file",Cn??vr);const i=await new Promise((c,s)=>{const d=new XMLHttpRequest;d.open("POST","/api/upload");try{const f=mn.getState().session?.accessToken;f&&d.setRequestHeader("Authorization",`Bearer ${f}`)}catch{}d.onreadystatechange=()=>{if(d.readyState===4)if(d.status>=200&&d.status<300)try{const f=JSON.parse(d.responseText);c(f.url)}catch(f){s(f)}else s(new Error(`upload failed: ${d.status} ${d.statusText}`))},d.onerror=()=>s(new Error("Network error during upload")),d.send(r)});await ne.patch(`/conversations/${n}`,{avatarUrl:i})}catch(r){console.error("Error setting group avatar:",r)}X.invalidateQueries({queryKey:["conversations"]}),t.data?.conversation?.id&&Ln(t.data.conversation.id),zi()}catch(t){console.error("Error creating group:",t),alert(t?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ")}finally{Yn(!1)}}},children:$t?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...":"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"})})]})}),va&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("div",{style:{fontWeight:700},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>br(!1),children:e.jsx(xt,{size:16})})]}),pt.data&&pt.data.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:pt.data.map(t=>e.jsxs("div",{className:"tile",children:[e.jsx(Ue,{name:t.friend.displayName??t.friend.username,id:t.friend.id,presence:t.friend.status,avatarUrl:t.friend.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:t.friend.displayName??t.friend.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ñ…Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ne.post("/contacts/respond",{contactId:t.id,action:"reject"}),pt.refetch()},children:"ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{await ne.post("/contacts/respond",{contactId:t.id,action:"accept"}),Qe.refetch(),pt.refetch(),re.refetch()},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]},t.id))})]}),e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ EBLID"}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(t=>e.jsx("input",{ref:mi[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:gi[t],onChange:n=>Ga(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},t))}),Yt&&e.jsxs("div",{className:"tile",style:{marginBottom:12},children:[e.jsx(Ue,{name:Yt.displayName??Yt.username,id:Yt.id,presence:Yt.status,avatarUrl:Yt.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:Yt.displayName??Yt.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("button",{disabled:wa,className:"btn btn-primary",onClick:Va,children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐœÐ¾Ð¹ EBLID:"}),e.jsx("div",{style:{fontWeight:700},children:vi||"â€” â€” â€” â€”"}),e.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{vi&&navigator.clipboard.writeText(vi)},title:"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID",children:e.jsx(Zo,{size:16})})]}),e.jsx("div",{style:{marginTop:16,fontWeight:700},children:"ÐœÐ¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ"}),e.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(Qe.data||[]).map(t=>{const n=t.friend;return e.jsxs("div",{className:"tile",children:[e.jsx(Ue,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]}),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ne.post("/contacts/remove",{contactId:t.id}),Qe.refetch()},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await Rs(n.id),br(!1),X.invalidateQueries({queryKey:["conversations"]})},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{const r=await ne.post("/conversations",{participantIds:[n.id],isGroup:!1});br(!1),Ln(r.data.conversation.id),X.invalidateQueries({queryKey:["conversations"]})},children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‡Ð°Ñ‚"})]})]},t.id)})})]})}),de.open&&de.messageId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>ct({open:!1,x:0,y:0,messageId:null}),children:e.jsxs("div",{ref:ks,className:"msg-menu",style:{position:"absolute",left:de.x,top:de.y,color:"#ffffff"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["ðŸ‘","â¤ï¸","ðŸ‘Ž","ðŸ”¥","ðŸ¤","ðŸ˜†"].map((t,n)=>{const i=t==="â¤ï¸"?"#ef4444":"#ffffff";return e.jsx("button",{onClick:async()=>{try{const c=de.messageId;((gt||[]).find(f=>f.id===c)?.reactions||[]).some(f=>f.userId===D?.id&&f.emoji===t)?await ne.post("/messages/unreact",{messageId:c,emoji:t}):await ne.post("/messages/react",{messageId:c,emoji:t}),a&&X.invalidateQueries({queryKey:["messages",a]})}catch{}ct({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:i,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${n*.05}s both`},onMouseEnter:c=>{c.currentTarget.style.transform="scale(1.2)"},onMouseLeave:c=>{c.currentTarget.style.transform="scale(1)"},children:t},t)})}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const t=de.messageId,n=(gt||[]).find(r=>r.id===t);ee({id:t,preview:(n?.content??"").slice(0,100)}),ct({open:!1,x:0,y:0,messageId:null})},children:"Ð¦Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),(()=>{const t=de.messageId;return(gt||[]).find(i=>i.id===t)?.senderId===D?.id?e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await ne.post("/messages/delete",{messageId:de.messageId}),a&&X.invalidateQueries({queryKey:["messages",a]})}catch{}ct({open:!1,x:0,y:0,messageId:null})},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}):null})(),e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const t=de.messageId,n=(gt||[]).find(r=>r.id===t);try{await navigator.clipboard.writeText(n?.content||"")}catch{}ct({open:!1,x:0,y:0,messageId:null})},children:"ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{rn({open:!0,messageId:de.messageId}),ct({open:!1,x:0,y:0,messageId:null})},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ"})]})}),hn.open&&e.jsx("div",{className:"lightbox-backdrop",onClick:()=>Vt({...hn,open:!1}),children:e.jsxs("div",{className:"lightbox-content",onClick:t=>t.stopPropagation(),children:[e.jsx("button",{className:"lightbox-arrow",onClick:()=>Vt(t=>({...t,index:(t.index-1+t.items.length)%t.items.length})),children:"â€¹"}),e.jsx("img",{src:hn.items[hn.index],alt:"preview",style:{transform:`scale(${Sa})`,transformOrigin:"center center"}}),e.jsx("button",{className:"lightbox-arrow",onClick:()=>Vt(t=>({...t,index:(t.index+1)%t.items.length})),children:"â€º"}),e.jsx("button",{className:"lightbox-close",onClick:()=>Vt({...hn,open:!1}),children:"âœ•"}),e.jsxs("div",{style:{position:"absolute",bottom:-48,left:"50%",transform:"translateX(-50%)",display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>Si(t=>Math.max(.25,t-.25)),children:"-"}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>Si(1),children:"100%"}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>Si(t=>Math.min(4,t+.25)),children:"+"})]})]})}),nn.open&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>rn({open:!1,messageId:null}),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"}),e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(re.data||[]).map(t=>{const n=t.conversation,i=n.participants.filter(s=>it?s.user.id!==it:!0).map(s=>s.user).map(s=>s.displayName??s.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",c=n.title??i;return e.jsx("div",{className:"tile",onClick:async()=>{const s=nn.messageId,d=(gt||[]).find(f=>f.id===s);d&&(await Es(n,{type:"TEXT",content:`â†ª ${d.content??""}`,replyToId:void 0}),rn({open:!1,messageId:null}))},children:e.jsx("div",{style:{fontWeight:600},children:c})},n.id)})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>rn({open:!1,messageId:null}),children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})})]})}),bn&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:Nn,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:Nn,children:e.jsx(xt,{size:18})})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Ð˜Ð· Ð´Ñ€ÑƒÐ·ÐµÐ¹"},{key:"eblid",label:"ÐŸÐ¾ EBLID"}].map(t=>{const n=St===t.key;return e.jsx("button",{className:"btn btn-ghost",onClick:()=>Xn(t.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:t.label},t.key)})}),e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:St==="friends"?"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ Ð² ÑÑ‚Ñƒ Ð±ÐµÑÐµÐ´Ñƒ.":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ EBLID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±ÐµÑÐµÐ´Ñƒ."}),St==="friends"?e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:zs.length===0?e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ."}):zs.map(t=>{const n=t.friend,r=an.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>wn(i=>r?i.filter(c=>c!==n.id):[...i,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ue,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:n.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":n.status==="BACKGROUND"?"Ð’ Ð¤ÐžÐÐ•":Pi(n)})]}),e.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},t.id)})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(t=>e.jsx("input",{ref:R[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:g[t],onChange:n=>Oa(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},t))}),Y&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñâ€¦"}),U&&e.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[e.jsx(Ue,{name:U.displayName??U.username,id:U.id,presence:U.status,avatarUrl:U.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:U.displayName??U.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Vr.alreadyInChat?"Ð£Ð¶Ðµ Ð² Ð±ÐµÑÐµÐ´Ðµ":Vr.isSelf?"Ð­Ñ‚Ð¾ Ð²Ñ‹":"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]})]}),!U&&K&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:K})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[e.jsx("button",{className:"btn btn-secondary",onClick:Nn,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:$n||(St==="friends"?an.length===0:!U||Vr.alreadyInChat||Vr.isSelf),onClick:St==="friends"?Wa:Ba,children:$n?"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ...":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]})}),W.open&&W.conversationId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Nt({open:!1,x:0,y:0,conversationId:null}),children:e.jsx("div",{ref:xn,className:"msg-menu",style:{position:"absolute",left:W.x,top:W.y},onClick:t=>t.stopPropagation(),children:(()=>{const n=(re.data||[]).find(c=>c.conversation.id===W.conversationId)?.conversation||(a===W.conversationId?S:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),i=async()=>{try{r?await ne.delete(`/conversations/${W.conversationId}/participants/me`):await ne.delete(`/conversations/${W.conversationId}`),X.invalidateQueries({queryKey:["conversations"]}),a===W.conversationId&&(l(null),k&&fe("list"))}catch{}Nt({open:!1,x:0,y:0,conversationId:null})};return e.jsxs("button",{onClick:i,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?e.jsx(Yi,{size:16}):e.jsx(sa,{size:16}),r?"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ"]})})()})}),tt.open&&tt.anchor&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>He({open:!1,anchor:null}),children:e.jsx("div",{ref:xr,className:"msg-menu",style:{position:"fixed"},onClick:t=>t.stopPropagation(),children:(()=>{const t=S.isGroup||(S.participants?.length??0)>2,n=!!S.isSecret&&!t,r=!t&&S.participants?.find(i=>i.user.id!==it)?.user;return t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{wn([]),Xn("friends"),L(["","","",""]),T(null),V(null),ge(!1),sn(!0),He({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(oa,{size:16}),"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"]}),e.jsxs("button",{onClick:async()=>{if(a){try{await ne.delete(`/conversations/${a}/participants/me`),X.invalidateQueries({queryKey:["conversations"]}),l(null),k&&fe("list")}catch(i){console.error("Failed to leave conversation:",i)}He({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(Yi,{size:16}),"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹"]})]}):e.jsxs(e.Fragment,{children:[n?e.jsxs("button",{onClick:()=>{rr(!0),He({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(nc,{size:16}),"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}):e.jsxs("button",{onClick:async()=>{r?.id&&await Rs(r.id),He({open:!1,anchor:null})},disabled:Cs,style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(ea,{size:16}),"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}),e.jsxs("button",{onClick:async()=>{if(a){try{await ne.delete(`/conversations/${a}`),X.invalidateQueries({queryKey:["conversations"]}),X.removeQueries({queryKey:["messages",a]}),l(null),k&&fe("list")}catch(i){console.error("Failed to delete conversation:",i)}He({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(sa,{size:16}),"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚"]})]})})()})}),li&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>tn(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>tn(!1),children:e.jsx(xt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(Ue,{name:S.title?.trim()?.charAt(0)||"Ð“",id:S.id,avatarUrl:ft??S.avatarUrl??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:S.title||"Ð“Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:ls,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){Tr(n);try{Er(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!ft&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>ls.current?.click(),onDragOver:t=>{t.preventDefault(),ji(!0)},onDragLeave:()=>ji(!1),onDrop:t=>{t.preventDefault(),ji(!1);const n=t.dataTransfer.files?.[0];if(n){Tr(n);try{Er(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(ds?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:ds?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(Xi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),ft&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:qt,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,be.scale*(1+n))),i=qt.current?.getBoundingClientRect();if(i){const c=t.clientX-i.left,s=t.clientY-i.top,d=r/be.scale,f=c-(c-be.x)*d,u=s-(s-be.y)*d;Rt({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=qt.current?.getBoundingClientRect();if(!n)return;const r=n.width,i=n.height,c=r/2,s=i/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,j=u-c,m=p-s;if(j*j+m*m>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const b=t.clientX,E=t.clientY,w={...be},M=P=>{P.preventDefault();const se=P.clientX-b,ae=P.clientY-E;Rt({...w,x:w.x+se,y:w.y+ae})},H=()=>{window.removeEventListener("pointermove",M),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",M,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Rr,src:ft,alt:"preview",style:{position:"absolute",left:be.x,top:be.y,transform:`scale(${be.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=qt.current;if(!r)return;const i=r.clientWidth,c=r.clientHeight,s=240,d=n.naturalWidth,f=n.naturalHeight,u=i/2,p=c/2,j=s/d,m=s/f,b=Math.max(j,m)*1.2,E=u-d*b/2,w=p-f*b/2;Rt({x:E,y:w,scale:b})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(be.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Rt(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.01,value:be.scale,onChange:t=>{const n=parseFloat(t.target.value);Rt(r=>{const i=qt.current?.getBoundingClientRect();if(!i)return{...r,scale:n};const c=i.width,s=i.height,d=c/2,f=s/2,u=Rr.current;if(u){const p=u.naturalWidth,j=u.naturalHeight,m=r.x+p*r.scale/2,b=r.y+j*r.scale/2,E=m-d,w=b-f,M=n/r.scale,H=d+E*M,P=f+w*M,se=H-p*n/2,ae=P-j*n/2;return{x:se,y:ae,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Rt(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:Mr,width:240,height:240,style:{display:"none"}})]}),Ar&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{Tr(null),ft&&URL.revokeObjectURL(ft),Er(null),Rt({x:0,y:0,scale:1})},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:Sn,onClick:async()=>{if(!(!Ar||!S)){jr(!0),Ir(0);try{let t=null;if(Mr.current&&ft){const i=await new Promise(w=>{const M=new Image;M.onload=()=>w(M),M.src=ft}),c=Mr.current.getContext("2d");if(!c)throw new Error("Could not get 2d context from canvas");const s=240;c.clearRect(0,0,s,s),c.save(),c.beginPath(),c.arc(s/2,s/2,s/2,0,Math.PI*2),c.closePath(),c.clip();const d=qt.current?.clientWidth??320,f=qt.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-s/2,y:u.y-s/2,w:s,h:s},j=(p.x-be.x)/be.scale,m=(p.y-be.y)/be.scale,b=p.w/be.scale,E=p.h/be.scale;c.drawImage(i,j,m,b,E,0,0,s,s),c.restore(),t=await new Promise(w=>Mr.current.toBlob(M=>w(M),"image/png"))}if(!t&&!Ar)throw new Error("No file to upload");const n=new FormData;n.append("file",t??Ar);const r=await new Promise((i,c)=>{const s=new XMLHttpRequest;s.open("POST","/api/upload");try{const d=mn.getState().session?.accessToken;d&&s.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}s.upload.onprogress=d=>{d.lengthComputable&&Ir(Math.round(100*d.loaded/d.total))},s.onreadystatechange=()=>{if(s.readyState===4)if(s.status>=200&&s.status<300)try{const d=JSON.parse(s.responseText);i(d.url)}catch(d){c(d)}else c(new Error(`upload failed: ${s.status} ${s.statusText}`))},s.onerror=()=>{c(new Error("Network error during upload"))},s.send(n)});await ne.patch(`/conversations/${S.id}`,{avatarUrl:r}),X.setQueryData(["conversations"],i=>Array.isArray(i)?i.map(c=>c.conversation?.id===S.id?{...c,conversation:{...c.conversation,avatarUrl:r}}:c):i),X.invalidateQueries({queryKey:["conversations"]}),await re.refetch(),Tr(null),ft&&URL.revokeObjectURL(ft),Er(null),Rt({x:0,y:0,scale:1}),tn(!1),kn("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>kn(null),2200)}catch(t){console.error("Error uploading group avatar:",t),kn(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${t instanceof Error?t.message:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}`),setTimeout(()=>kn(null),3e3)}finally{jr(!1)}}},children:Sn?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),Sn&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${os}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),Dr&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[e.jsx(Zs,{size:16}),e.jsx("span",{children:Dr})]})]})})]})}function fa(a){return(a??[]).map(l=>l.user.id).sort().join(",")}export{fl as default};
