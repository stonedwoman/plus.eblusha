import{r as c,j as S}from"./vendor-query-D8-W16Rz.js";import{u as ne,M as oe,j as I,I as le,c as se,K as ie}from"./index-BYLdstB9.js";import{W as ce,a as ue}from"./index-BGpmfXXY.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const d=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const o=await d(),L=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(L))return o;const f=[],b=[],C=[],_=(a,v)=>{const k=a.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(k)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(k)||/(back|rear)/.test(v.toLowerCase())?"back":"other"};o.forEach(a=>{if(a.kind!=="videoinput"){C.push(a);return}const v=_(a.label||"",a.deviceId||"");v==="front"?f.push(a):b.push(a)});const m=[];if(f.length>0&&m.push(f[0]),b.length>0&&m.push(b[0]),m.length===0&&o.some(a=>a.kind==="videoinput")){const a=o.find(v=>v.kind==="videoinput");a&&m.push(a)}return C.forEach(a=>{a.kind!=="videoinput"&&m.push(a)}),m},window.__eblushaEnumeratePatched=!0}function ge({open:d,conversationId:o,onClose:L,onMinimize:R,minimized:f=!1,initialVideo:b=!1,initialAudio:C=!0,peerAvatarUrl:_=null,avatarsByName:m={},avatarsById:a={},localUserId:v=null,isGroup:k=!1}){const[M,W]=c.useState(null),[B,F]=c.useState(null),[K,X]=c.useState(!C),[J,Q]=c.useState(!!b),[de,Y]=c.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[P,N]=c.useState(!1),j=ne(e=>e.session?.user),O=c.useRef(!1),q=c.useRef(!1),T=c.useMemo(()=>j?.avatarUrl??null,[j?.avatarUrl]),U=c.useCallback(e=>{if(O.current||(O.current=!0),e?.manual&&(q.current=!0),o&&k){try{oe(o)}catch(u){console.error("Error leaving call room:",u)}try{I([o])}catch(u){console.error("Error requesting call status update:",u)}}const h=q.current?{...e??{},manual:!0}:e;L(h)},[o,k,L]),Z=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
  `;if(c.useEffect(()=>{let e=!0;async function h(){if(!d||!o)return;const u=`conv-${o}`,w=await se.post("/livekit/token",{room:u,participantMetadata:{app:"eblusha",userId:j?.id,displayName:j?.displayName??j?.username,avatarUrl:T}});e&&(W(w.data.token),F(w.data.url))}return h(),()=>{e=!1,W(null),F(null)}},[d,o]),c.useEffect(()=>{d&&(Q(!!b),X(!C),N(!1))},[d,b,C]),c.useEffect(()=>{if(!d)return;if(typeof window<"u"&&window.innerWidth<=768){const h=document.body.style.overflow,u=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=h,document.body.style.touchAction=u}}},[d]),c.useEffect(()=>{d||(O.current=!1,q.current=!1)},[d]),c.useEffect(()=>{const e=()=>Y(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),c.useEffect(()=>{if(!d)return;const e=document.body;if(!e)return;const h=()=>{e.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(t=>{const l=t.getAttribute("aria-label")||t.getAttribute("title")||"";let n="";const s=l.toLowerCase();s.includes("microphone")?n=l.includes("mute")?"Выключить микрофон":"Включить микрофон":s.includes("camera")?n=l.includes("disable")||s.includes("off")?"Выключить камеру":"Включить камеру":s.includes("screen")?n=s.includes("stop")?"Остановить показ экрана":"Поделиться экраном":s.includes("flip")?n="Сменить камеру":s.includes("participants")?n="Участники":s.includes("settings")?n="Настройки":s.includes("leave")||s.includes("hang")?n="Выйти":s.includes("chat")&&(n="Чат"),n&&(t.setAttribute("aria-label",n),t.setAttribute("title",n))}),e.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(t=>{const l=t;l.style.display="none";try{l.remove()}catch{}});const E=e.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(E&&R){let t=E.querySelector(".eb-minimize-btn");if(!t){t=document.createElement("button"),t.className="eb-minimize-btn lk-button",t.setAttribute("aria-label","Свернуть"),t.setAttribute("title","Свернуть"),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',t.style.cssText="display: flex; align-items: center; justify-content: center; background: var(--surface-100); color: var(--text-primary); border: 1px solid var(--surface-border); border-radius: 8px; padding: 8px; cursor: pointer; transition: background 0.2s ease;",t.onmouseenter=()=>{t.style.background="var(--surface-200)"},t.onmouseleave=()=>{t.style.background="var(--surface-100)"},t.onclick=n=>{n.stopPropagation(),R()};const l=E.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(l&&l.parentNode){if(!l.__ebLeaveBound){const n=()=>{setTimeout(()=>U({manual:!0}),0)};l.addEventListener("click",n),l.__ebLeaveBound=n}l.parentNode.insertBefore(t,l)}else E.appendChild(t)}}},u=new MutationObserver(()=>h());return u.observe(e,{childList:!0,subtree:!0,attributes:!0}),h(),()=>u.disconnect()},[d,R,U]),c.useEffect(()=>{if(!d)return;const e=document.body;if(!e)return;const h=m||{},u=a||{},w=v||null,$=T||null,E=s=>{let i=0;for(let r=0;r<s.length;r++)i=s.charCodeAt(r)+((i<<5)-i);return`hsl(${Math.abs(i)%360} 70% 45%)`},t=(s,i)=>{const A=E(i),r=s.trim().charAt(0).toUpperCase(),D=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${A}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${r}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(D)}`},l=()=>{e.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(i=>{const A=i.querySelector(".lk-participant-name, [data-lk-participant-name]"),r=i.querySelector(".lk-participant-placeholder");if(!A||!r)return;const D=i.getAttribute("data-lk-participant-identity")?i:i.querySelector("[data-lk-participant-identity]"),x=D?(D.getAttribute("data-lk-participant-identity")||"").trim():"";let g=(A.textContent||A.getAttribute("data-lk-participant-name")||"").trim();if(!g){const y=i.querySelector(".lk-participant-metadata");y?.textContent?.trim()&&(g=y.textContent.trim())}g||(g=x||"");const G=x?u[x]??null:null,H=Object.keys(h).find(y=>y.toLowerCase()===g.toLowerCase()),V=H?h[H]:null,ee=$,te=!!(i.hasAttribute("data-lk-local-participant")||i.hasAttribute("data-lk-local")||i.classList.contains("lk-local-participant")||i.querySelector(".lk-local-indicator")||/\b(you|вы)\b/i.test(g)||x&&w&&x===w);let re=G??V??(te?ee||(w?u[w]??null:null):null);const ae=t(g||x||"U",x||g||"U");r.querySelectorAll("svg").forEach(y=>y.remove()),r.querySelectorAll("svg").forEach(y=>y.style.display="none");let p=r.querySelector("img.eb-ph");p||(p=document.createElement("img"),p.className="eb-ph",r.appendChild(p)),p.src=re||ae,p.alt=g,p.style.width="auto",p.style.height="auto",p.style.maxWidth="85%",p.style.maxHeight="85%",p.style.objectFit="cover",p.style.borderRadius="50%",p.style.display="block",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.background="transparent",r.style.backgroundImage="none",r.style.color="transparent",r.style.fontSize="0",r.style.overflow="hidden";try{r.style.borderRadius="50%"}catch{}Array.from(r.childNodes).forEach(y=>{y.nodeType===Node.TEXT_NODE&&(y.textContent="")})})},n=new MutationObserver(l);return n.observe(e,{childList:!0,subtree:!0}),l(),()=>n.disconnect()},[d,m,a,v,T]),!d||!o||!M||!B)return null;const z=S.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:f?"transparent":"rgba(10,12,16,0.55)",backdropFilter:f?"none":"blur(4px) saturate(110%)",display:f?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:f?"none":"auto"},children:S.jsxs("div",{"data-lk-theme":"default",style:{width:f?0:"90vw",height:f?0:"80vh",maxWidth:f?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:f?"none":"var(--shadow-sharp)",opacity:f?0:1,visibility:f?"hidden":"visible"},className:"call-container",children:[S.jsx("style",{children:Z}),S.jsx(ce,{serverUrl:B,token:M,connect:!0,video:J,audio:!K,onConnected:()=>{N(!0);try{o&&k&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:o,video:b}),ie(o,b),I([o]))}catch(e){console.error("Error joining call room:",e)}},onDisconnected:e=>{console.log("[CallOverlay] onDisconnected:",e,"wasConnected:",P,"isGroup:",k);const h=P;N(!1);const u=e===1||q.current;h?U({manual:u}):k||U({manual:u})},children:S.jsx("div",{style:{width:"100%",height:"100%"},children:S.jsx(ue,{})})})]})});return le.createPortal(z,document.body)}export{ge as CallOverlay};
