import{_ as we,u as Te,P as Re,m as ye,e as Ee,d as Ae,M as Fe}from"./index-BrU8mxfA.js";import{r as a,j as g}from"./vendor-query-CNP5Hy5J.js";import{O as le,L as ve,b as Me,W as Pe,a as je,t as Le,C as de,u as fe,R as ke,f as pe,s as De,c as Ie}from"./index-BdT5Om9k.js";import"./vendor-react-BcTlWpV0.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-GGjuBpPe.js";function _e(f={}){const[r,S]=a.useState(!1),[E,y]=a.useState(!1),[_,I]=a.useState(!1);let B=le().microphoneTrack;const[P,F]=a.useState();f.trackRef&&(B=f.trackRef.publication);const q=a.useCallback(async j=>{if(j){const{KrispNoiseFilter:M,isKrispNoiseFilterSupported:W}=await we(async()=>{const{KrispNoiseFilter:H,isKrispNoiseFilterSupported:$}=await import("./index-Cc9ouniY.js");return{KrispNoiseFilter:H,isKrispNoiseFilterSupported:$}},[]);if(!W()){ve.warn("LiveKit-Krisp noise filter is not supported in this browser");return}P||F(M(f.filterOptions))}S(M=>(M!==j&&y(!0),j))},[]);return a.useEffect(()=>{var j;if(B&&B.track instanceof Me&&P){const M=B.track.getProcessor();M&&M.name==="livekit-noise-filter"?(y(!0),M.setEnabled(r).finally(()=>{y(!1),I(r)})):!M&&r&&(y(!0),(j=B?.track)==null||j.setProcessor(P).then(()=>P.setEnabled(r)).then(()=>{I(!0)}).catch(W=>{I(!1),ve.error("Krisp hook: error enabling filter",W)}).finally(()=>{y(!1)}))}},[r,B,P]),{setNoiseFilterEnabled:q,isNoiseFilterEnabled:_,isNoiseFilterPending:E,processor:P}}if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const f=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const r=await f(),S=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(S))return r;const y=[],_=[],I=[],B=(F,q)=>{const j=F.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(j)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(j)||/(back|rear)/.test(q.toLowerCase())?"back":"other"};r.forEach(F=>{if(F.kind!=="videoinput"){I.push(F);return}const q=B(F.label||"",F.deviceId||"");q==="front"?y.push(F):_.push(F)});const P=[];if(y.length>0&&P.push(y[0]),_.length>0&&P.push(_[0]),P.length===0&&r.some(F=>F.kind==="videoinput")){const F=r.find(q=>q.kind==="videoinput");F&&P.push(F)}return I.forEach(F=>{F.kind!=="videoinput"&&P.push(F)}),P},window.__eblushaEnumeratePatched=!0}try{De(Ie.warn)}catch{}const J={aec:"eb.lk.webrtc.aec",ns:"eb.lk.webrtc.ns",agc:"eb.lk.webrtc.agc",krisp:"eb.lk.krisp.enabled"};function oe(f,r){if(typeof window>"u")return r;try{const S=window.localStorage.getItem(f);return S===null?r:S==="1"||S==="true"}catch{return r}}function ie(f,r){if(!(typeof window>"u"))try{window.localStorage.setItem(f,r?"1":"0")}catch{}}function ne(f,r){if(typeof window>"u")return!1;try{const E=new URLSearchParams(window.location.search).get(r);if(E==="1"||E==="true")return!0;const y=window.localStorage.getItem(f);return y==="1"||y==="true"}catch{return!1}}function se({label:f,description:r,checked:S,onChange:E,disabled:y=!1,rightHint:_}){return g.jsxs("div",{className:"eb-toggle-row",children:[g.jsxs("div",{className:"eb-toggle-text",children:[g.jsx("div",{className:"eb-toggle-label",children:f}),r?g.jsx("div",{className:"eb-toggle-desc",children:r}):null]}),g.jsxs("div",{className:"eb-toggle-right",children:[_?g.jsx("div",{className:"eb-toggle-hint",children:_}):null,g.jsxs("label",{className:`eb-switch ${y?"is-disabled":""}`,children:[g.jsx("input",{type:"checkbox",checked:S,disabled:y,onChange:I=>E(I.target.checked)}),g.jsx("span",{className:"eb-switch-track","aria-hidden":"true"})]})]})]})}function qe(){const f=Le();let r="Подключено";return f===de.Connecting?r="Подключение…":f===de.Reconnecting?r="Переподключение…":f===de.Disconnected&&(r="Отключено"),g.jsx("div",{className:"eb-conn-badge",style:{position:"absolute",top:10,left:10,zIndex:20,padding:"6px 10px",borderRadius:999,background:"rgba(0,0,0,0.45)",border:"1px solid rgba(255,255,255,0.12)",fontSize:12,color:"#fff",backdropFilter:"blur(6px)"},children:r})}function Be(){const f=fe(),{isMicrophoneEnabled:r}=le(),S=a.useRef(!1);return a.useEffect(()=>{f&&(S.current||r&&(S.current=!0,f.localParticipant.setMicrophoneEnabled(!0,{deviceId:"default"}).catch(E=>console.warn("[DefaultMicrophoneSetter] Failed to set default microphone",E))))},[f,r]),null}function Ke({localUserId:f}){const r=fe(),{localParticipant:S,microphoneTrack:E,cameraTrack:y}=le(),[_,I]=a.useState(null),B=a.useRef(null),[P,F]=a.useState(null),q=a.useRef(null),j=a.useRef(null),M=a.useRef(new Map),W=a.useRef(new Map),H=a.useRef(0),$=a.useRef(!1),Y=a.useRef(!1),A=a.useRef(0),U=a.useRef({at:0,rtt:null}),[b,X]=a.useState(()=>ne("lk-debug-ping","lkDebugPing")),Q=a.useRef({at:0,lastLocalRtt:null,lastSignalRtt:null}),C=(...T)=>{b&&console.log("[Ping]",...T)};a.useEffect(()=>{const T=window.setInterval(()=>{const u=ne("lk-debug-ping","lkDebugPing");X(v=>v===u?v:u)},1e3);return()=>window.clearInterval(T)},[]),a.useEffect(()=>{if(b){C("debug enabled",{localStorage:(()=>{try{return window.localStorage.getItem("lk-debug-ping")}catch{return"(unavailable)"}})(),query:(()=>{try{return new URLSearchParams(window.location.search).get("lkDebugPing")}catch{return"(unavailable)"}})(),localIdentity:S?.identity??null});try{const u=performance?.getEntriesByType?.("resource")?.map(v=>v.name).find(v=>v.includes("/assets/CallOverlay-"))??null;u&&C("asset",u)}catch{}}},[b,S?.identity]),a.useEffect(()=>{q.current=P,j.current?.(),b&&C("localPlayoutMs state",P)},[P]),a.useEffect(()=>{if(!r)return;const T=N=>{let o=null;try{N.forEach(i=>{if(i?.type!=="inbound-rtp")return;const l=(i?.kind||i?.mediaType||"").toString().toLowerCase();if(l&&l!=="audio")return;const p=typeof i?.jitterBufferTargetDelay=="number"?i.jitterBufferTargetDelay:null;if(typeof p=="number"&&Number.isFinite(p)&&p>0){const n=p*1e3;Number.isFinite(n)&&n>0&&n<5e3&&(o=o===null?n:Math.max(o,n))}const w=typeof i?.jitterBufferDelay=="number"?i.jitterBufferDelay:null,t=typeof i?.jitterBufferEmittedCount=="number"?i.jitterBufferEmittedCount:null;if(typeof w=="number"&&typeof t=="number"&&Number.isFinite(w)&&Number.isFinite(t)&&w>0&&t>=50){const n=w/t*1e3;Number.isFinite(n)&&n>0&&n<5e3&&(o=o===null?n:Math.max(o,n))}})}catch{}return o};let u=!1;const v=async()=>{try{const o=r.engine?.pcManager?.subscriber;if(o?.getStats){const i=await o.getStats(),l=T(i);u||F(l),b&&C("playout sample",{ms:l});return}}catch(N){b&&C("playout sample failed",N)}u||F(null)},L=window.setInterval(v,2e3);return v(),()=>{u=!0,window.clearInterval(L)}},[r,b]);const ee=T=>T.getAttribute("data-lk-local-participant")==="true"?!0:T.dataset?.lkLocalParticipant==="true",O=T=>{const u=T.querySelector("[data-lk-participant-name]")||T.querySelector(".lk-participant-name"),v=u?.getAttribute("data-lk-participant-name"),L=v&&v.trim()||(u?.textContent?.trim()??"");return L?L.replace(/[\u2019']/g,"'").replace(/'s\s+screen$/i,"").trim():null};return a.useEffect(()=>{if(!r||!S)return;const T=N=>{try{let o=null;const i=t=>{const n=(typeof t?.currentRoundTripTime=="number"?t.currentRoundTripTime:null)??(typeof t?.roundTripTime=="number"?t.roundTripTime:null)??(typeof t?.totalRoundTripTime=="number"&&Number.isFinite(t.totalRoundTripTime)&&t.totalRoundTripTime>0&&typeof t?.responsesReceived=="number"&&Number.isFinite(t.responsesReceived)&&t.responsesReceived>0?t.totalRoundTripTime/t.responsesReceived:null);return typeof n!="number"||!Number.isFinite(n)||n<=0?null:n};let l=null,p=null;N.forEach(t=>{t?.type==="transport"&&t.selectedCandidatePairId&&(l=String(t.selectedCandidatePairId))}),l&&(p=N.get?.(l)??(()=>{let t=null;return N.forEach(n=>{t||n?.id===l&&(t=n)}),t})()??null),p||N.forEach(t=>{p||t?.type==="candidate-pair"&&(t.selected||t.nominated||t.state==="succeeded")&&(p=t)});const w=p?i(p):null;if(typeof w=="number"&&Number.isFinite(w)&&w>0&&(o=w),N.forEach(t=>{if(t?.type!=="candidate-pair"||!(t.selected||t.nominated||t.state==="succeeded"))return;const n=i(t);typeof n=="number"&&(o===null||n<o)&&(o=n)}),N.forEach(t=>{if(t?.type!=="remote-inbound-rtp")return;const n=(typeof t?.roundTripTime=="number"?t.roundTripTime:null)??(typeof t?.totalRoundTripTime=="number"&&Number.isFinite(t.totalRoundTripTime)&&t.totalRoundTripTime>0&&typeof t?.roundTripTimeMeasurements=="number"&&Number.isFinite(t.roundTripTimeMeasurements)&&t.roundTripTimeMeasurements>0?t.totalRoundTripTime/t.roundTripTimeMeasurements:null);typeof n!="number"||!Number.isFinite(n)||n<=0||(o===null||n<o)&&(o=n)}),N.forEach(t=>{const n=typeof t?.roundTripTime=="number"?t.roundTripTime:null;typeof n!="number"||!Number.isFinite(n)||n<=0||(o===null||n<o)&&(o=n)}),typeof o=="number"&&Number.isFinite(o)&&o>0)return o*1e3}catch{}return null},u=async()=>{try{const N=r.engine,o=N?.client?.rtt;if((!o||o<=0)&&typeof N?.client?.sendPing=="function"){const e=Date.now();if(e-A.current>5e3){A.current=e;try{await N.client.sendPing(),b&&C("signal sendPing() called")}catch(m){b&&C("signal sendPing() failed",m)}}}if(b){const e=Date.now(),m=Q.current;(typeof o=="number"?o:null)!==m.lastSignalRtt&&e-m.at>750&&(Q.current={...m,at:e,lastSignalRtt:typeof o=="number"?o:null},C("signal rtt",{rtt:o,hasEngine:!!N,localIdentity:S.identity}))}if(typeof o=="number"&&Number.isFinite(o)&&o>0){I(o),b&&C("local rtt set",{ms:Math.round(o),source:"engine.client.rtt"});return}const i=E?.track;if(i&&typeof i.getSenderStats=="function")try{const e=await i.getSenderStats(),m=typeof e?.roundTripTime=="number"?e.roundTripTime:null;if(typeof m=="number"&&Number.isFinite(m)&&m>0){const s=m*1e3;I(s),b&&C("local rtt set",{ms:Math.round(s),source:"LocalAudioTrack.getSenderStats().roundTripTime"});return}}catch(e){b&&C("mic getSenderStats failed",e)}const l=y?.track;if(l&&typeof l.getSenderStats=="function")try{const e=await l.getSenderStats(),s=(Array.isArray(e)?e:[]).map(c=>typeof c?.roundTripTime=="number"?c.roundTripTime:null).filter(c=>typeof c=="number"&&Number.isFinite(c)&&c>0);if(s.length>0){const h=Math.min(...s)*1e3;I(h),b&&C("local rtt set",{ms:Math.round(h),source:"LocalVideoTrack.getSenderStats()[].roundTripTime"});return}}catch(e){b&&C("camera getSenderStats failed",e)}const p=Date.now();if(p-H.current<3e3)return;const w=N?.pcManager?.publisher,t=N?.pcManager?.subscriber,n=[w,t].filter(Boolean),k=[E?.track,y?.track].filter(Boolean);if(n.length>0||k.length>0)H.current=p;else{b&&!Y.current&&(Y.current=!0,C("waiting for transports/tracks",{publisher:!!w,subscriber:!!t,trackCandidates:k.length}));return}for(const e of n){if(!e?.getStats)continue;const m=await e.getStats(),s=T(m);if(typeof s=="number"&&Number.isFinite(s)&&s>0){I(s),b&&C("local rtt set",{ms:Math.round(s),source:"pcTransport.getStats()"});return}}for(const e of k){if(!e?.getRTCStatsReport)continue;const m=await e.getRTCStatsReport();if(!m)continue;const s=T(m);if(typeof s=="number"&&Number.isFinite(s)&&s>0){I(s),b&&C("local rtt set",{ms:Math.round(s),source:"MediaStreamTrack.getRTCStatsReport()"});return}}$.current||($.current=!0,b&&C("could not compute local rtt",{signalRtt:o,transports:n.length,trackCandidates:k.length,localIdentity:S.identity}))}catch(N){b&&C("updateRtt error",N)}},v=setInterval(()=>void u(),1500);u();const L=setTimeout(()=>void u(),2500);return()=>{clearInterval(v),clearTimeout(L)}},[r,S,E?.trackSid,y?.trackSid]),a.useEffect(()=>{if(!r||!S)return;const T=new TextEncoder,u=async()=>{try{const o=B.current;if(typeof o!="number"||!Number.isFinite(o)||o<=0){b&&C("skip publish eb.ping (no local rtt yet)",{localRtt:o});return}const i=Date.now(),l=U.current,p=l.rtt===null||Math.abs(l.rtt-o)>=2;if(!(i-l.at>=2e3)&&!p)return;U.current={at:i,rtt:o};const t=q.current,n={t:"eb.ping",v:2,rtt:Math.round(o),playoutMs:typeof t=="number"&&Number.isFinite(t)&&t>=0?Math.round(t):0,ts:i};await S.publishData(T.encode(JSON.stringify(n)),{reliable:!1,topic:"eb.ping"}),b&&C("publish eb.ping ok",n)}catch(o){b&&C("publish eb.ping failed",o),b&&!window.__ebPingPublishWarned&&(window.__ebPingPublishWarned=!0,console.warn("[Ping] Failed to publish eb.ping (data channel). Check LiveKit token grant canPublishData=true."))}},v=new TextDecoder,L=(o,i,l,p)=>{if(p&&p!=="eb.ping")return;const w=i?.identity;if(w&&!(S&&w===S.identity))try{const t=JSON.parse(v.decode(o));if(!t||t.t!=="eb.ping")return;const n=Number(t.rtt);if(!Number.isFinite(n)||n<=0)return;const k=Number(t.playoutMs),e=Number.isFinite(k)&&k>=0?k:0,m=typeof i?.name=="string"&&i.name?i.name:null,s=M.current.get(w);M.current.set(w,n),m&&M.current.set(m,n),W.current.set(w,e),m&&W.current.set(m,e);const c=typeof i?.metadata=="string"?i.metadata:null;if(c)try{const h=JSON.parse(c);h?.displayName&&M.current.set(String(h.displayName),n),h?.userId&&M.current.set(String(h.userId),n),h?.displayName&&W.current.set(String(h.displayName),e),h?.userId&&W.current.set(String(h.userId),e)}catch{}b&&(s===void 0||Math.abs(s-n)>=2)&&C("recv eb.ping",{from:w,name:m,rtt:n,playoutMs:e,ts:t.ts,topic:p??null}),j.current?.()}catch{}};r.on(ke.DataReceived,L);const N=setInterval(()=>void u(),2e3);return u(),()=>{clearInterval(N),r.off(ke.DataReceived,L)}},[r,S,b]),a.useEffect(()=>{B.current=_,j.current?.(),b&&C("localRtt state",_)},[_]),a.useEffect(()=>{if(!r)return;const T=document.querySelector(".call-container");if(!T)return;const u=i=>{const l=B.current;return typeof l!="number"||!Number.isFinite(l)||l<=0?"—":i?`${Math.round(l)} мс`:"—"},v=()=>{const i=T.querySelectorAll(".lk-participant-metadata-item[data-lk-quality]");b&&C("dom scan",{indicators:i.length}),i.forEach(l=>{const p=l.closest(".lk-participant-tile, [data-participant]");if(!p)return;const w=ee(p),t=O(p);l.classList.contains("eb-ping-display")||l.classList.add("eb-ping-display");let n=l.querySelector(".eb-ping-text");n||(n=document.createElement("span"),n.className="eb-ping-text",l.appendChild(n));let k=null,e=u(w);if(w){const c=B.current;typeof c=="number"&&Number.isFinite(c)&&c>0&&(k=Math.round(c),e=`${k} мс`)}else{const c=(t?M.current.get(t):void 0)??void 0,h=(t?W.current.get(t):void 0)??0,R=B.current;typeof c=="number"&&Number.isFinite(c)&&c>0&&typeof R=="number"&&R>0&&(k=Math.round((c+R)/2+(typeof h=="number"&&Number.isFinite(h)&&h>=0?h:0)),e=`${k} мс`)}const m=typeof k=="number"&&Number.isFinite(k)&&k>0;if(l.classList.toggle("eb-ping-has-value",m),typeof k=="number"&&Number.isFinite(k)&&k>0){const c=k<=200?"good":k<=500?"warn":"bad";l.setAttribute("data-eb-ping-level",c)}else l.removeAttribute("data-eb-ping-level");const s=m?e:"";if(n.textContent!==s&&(n.textContent=s,b)){const c=B.current,h=t?M.current.get(t):void 0;C("dom set",{name:t,isLocal:w,text:s,mine:c,remote:h})}})};let L=!1;const N=()=>{L||(L=!0,requestAnimationFrame(()=>{L=!1,v()}))};j.current=N;const o=new MutationObserver(()=>N());return o.observe(T,{childList:!0,subtree:!0}),N(),()=>{j.current===N&&(j.current=null),o.disconnect()}},[r,S,f,b]),null}function Oe(){const f=fe(),{isMicrophoneEnabled:r,microphoneTrack:S}=le(),E=_e(),[y,_]=a.useState(()=>oe(J.aec,!0)),[I,B]=a.useState(()=>oe(J.ns,!0)),[P,F]=a.useState(()=>oe(J.agc,!0)),[q,j]=a.useState(()=>oe(J.krisp,!1)),[M,W]=a.useState("checking"),[H,$]=a.useState("Проверяем поддержку Krisp…");a.useEffect(()=>{let A=!0;async function U(){try{const b=await we(()=>import("./index-Cc9ouniY.js"),[]),X=typeof b.isKrispNoiseFilterSupported=="function"?b.isKrispNoiseFilterSupported():!1;if(!A)return;W(X?"supported":"unsupported"),$(X?"Браузер поддерживает Krisp.":"Этот браузер не поддерживает Krisp.")}catch{if(!A)return;W("error"),$("Не удалось проверить поддержку Krisp (ошибка загрузки модуля).")}}return U(),()=>{A=!1}},[]);const Y=a.useRef("");return a.useEffect(()=>{if(!f||!r)return;const A=`${y}|${I}|${P}|${S?.trackSid??""}`;Y.current!==A&&(Y.current=A,f.localParticipant.setMicrophoneEnabled(!0,{echoCancellation:y,noiseSuppression:I,autoGainControl:P}).catch(U=>console.warn("[CallSettings] Failed to apply mic capture options",U)))},[f,r,y,I,P,S?.trackSid]),a.useEffect(()=>{r&&M==="supported"&&(E.isNoiseFilterPending||q!==E.isNoiseFilterEnabled&&E.setNoiseFilterEnabled(q).catch(A=>{console.warn("[CallSettings] Krisp setNoiseFilterEnabled failed, disabling toggle",A),j(!1),ie(J.krisp,!1),W("error"),$("Krisp недоступен (ошибка подключения к сервису шумоподавления).")}))},[r,S?.trackSid,q,E.isNoiseFilterPending,E.isNoiseFilterEnabled,M]),a.useEffect(()=>{const A=()=>{const X=document.querySelectorAll(".call-container .lk-settings-menu-modal .lk-media-device-select li"),Q=[],C=new Map;X.forEach(O=>{const T=O.querySelector(".lk-button");if(!T)return;const u=T.textContent||"",v=/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i.test(u);let L=u.replace(/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i,"").trim();L=L.replace(/\s*\([0-9a-fA-F]{4}:[0-9a-fA-F]{0,4}\)?\s*/g,"").trim(),C.has(L)||C.set(L,[]),C.get(L).push(O),v&&Q.push(O)}),Q.forEach(O=>{O.remove()}),document.querySelectorAll(".call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button").forEach(O=>{const T=Array.from(O.childNodes).find(v=>v.nodeType===Node.TEXT_NODE);let u=O.querySelector("span.eb-device-label");if(T&&!u){const v=T.textContent||"";u=document.createElement("span"),u.className="eb-device-label",u.textContent=v,O.replaceChild(u,T)}if(u){let v=u.textContent||"";v=v.replace(/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i,"").trim(),v=v.replace(/\s*\([0-9a-fA-F]{4}:[0-9a-fA-F]{0,4}\)?\s*/g,"").trim(),v=v.replace(/\s*\([0-9a-fA-F]{4}:\s*$/,"").trim(),v!==u.textContent&&(u.textContent=v),setTimeout(()=>{const L=O.getBoundingClientRect(),N=u.getBoundingClientRect(),i=L.width-24;if(N.width>i){const l=N.width-i;u.setAttribute("data-overflows","true"),u.style.setProperty("--eb-device-scroll-distance",`${-l}px`)}else u.removeAttribute("data-overflows"),u.style.removeProperty("--eb-device-scroll-distance")},10)}})};A();const U=new MutationObserver(()=>{setTimeout(A,50)}),b=document.querySelector(".call-container .lk-settings-menu-modal");if(b)return U.observe(b,{childList:!0,subtree:!0,characterData:!0}),()=>U.disconnect()},[]),g.jsxs("div",{className:"eb-call-settings",style:{width:"100%"},children:[g.jsx("div",{style:{fontSize:18,fontWeight:600,marginBottom:12},children:"Настройки"}),g.jsxs("div",{className:"eb-settings-section",children:[g.jsx("div",{className:"eb-section-title",children:"Обработка микрофона"}),g.jsx(se,{label:"WebRTC: AEC (анти-эхо)",description:"Эхо‑подавление на уровне браузера (лучше включать почти всегда).",checked:y,onChange:A=>{_(A),ie(J.aec,A)}}),g.jsx(se,{label:"WebRTC: NS (шумоподавление)",description:"Шумоподавление на уровне браузера.",checked:I,onChange:A=>{B(A),ie(J.ns,A)}}),g.jsx(se,{label:"WebRTC: AGC (автогейн)",description:"Автоматическая регулировка усиления микрофона.",checked:P,onChange:A=>{F(A),ie(J.agc,A)}}),g.jsx(se,{label:"Krisp (улучшенное шумоподавление)",description:`${H} Может быть недоступен на self-hosted LiveKit.`,checked:q,disabled:!r||E.isNoiseFilterPending||M==="unsupported"||M==="error",rightHint:r?M==="checking"?"Проверяем…":M==="unsupported"?"Не поддерживается":M==="error"?"Ошибка проверки":E.isNoiseFilterPending?"Применяем…":q&&!E.isNoiseFilterEnabled?"Не активно":E.isNoiseFilterEnabled?"Активно":"":"Включите микрофон",onChange:A=>{j(A),ie(J.krisp,A)}}),g.jsx("div",{className:"eb-settings-note",children:"Изменения AEC/NS/AGC применяются перезапуском микрофона и могут дать короткий “пик” при переключении."})]}),g.jsxs("div",{className:"eb-settings-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:16,alignItems:"start",marginBottom:12},children:[g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Микрофон"}),g.jsx(pe,{kind:"audioinput",requestPermissions:!0})]}),g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Камера"}),g.jsx(pe,{kind:"videoinput",requestPermissions:!0})]}),g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Вывод звука"}),g.jsx(pe,{kind:"audiooutput",requestPermissions:!0}),g.jsx("div",{style:{fontSize:11,opacity:.65,marginTop:6},children:"На Safari/iOS переключение устройства вывода может быть недоступно."})]})]}),g.jsx("div",{style:{fontSize:12,opacity:.8},children:"Выберите устройства ввода. Закрыть это окно можно кнопкой «Настройки» внизу."})]})}function Ye({open:f,conversationId:r,onClose:S,onMinimize:E,minimized:y=!1,initialVideo:_=!1,initialAudio:I=!0,peerAvatarUrl:B=null,avatarsByName:P={},avatarsById:F={},localUserId:q=null,isGroup:j=!1}){const[M,W]=a.useState(null),[H,$]=a.useState(null),[Y,A]=a.useState(!I),[U,b]=a.useState(!!_),[X,Q]=a.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[C,ee]=a.useState(!1),O=Te(i=>i.session?.user),T=a.useRef(!1),u=a.useRef(!1),v=a.useMemo(()=>O?.avatarUrl??null,[O?.avatarUrl]),L=a.useCallback(i=>{if(T.current||(T.current=!0),i?.manual&&(u.current=!0),r&&j){try{Re(r)}catch(p){console.error("Error leaving call room:",p)}try{ye([r])}catch(p){console.error("Error requesting call status update:",p)}}const l=u.current?{...i??{},manual:!0}:i;S(l)},[r,j,S]),N=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
    
    /* Ensure placeholder stays circular and doesn't stretch */
    .call-container .lk-participant-placeholder {
      aspect-ratio: 1 !important;
      border-radius: 50% !important;
      margin: auto !important;
      align-self: center !important;
      flex-shrink: 0 !important;
    }
    
    /* Hide chat entry point in the control bar (we expose device selection via Settings and also via button group menus) */
    .call-container .lk-control-bar .lk-chat-toggle { display: none !important; }

    /* Settings toggles */
    .call-container .eb-settings-section { margin-bottom: 16px; }
    .call-container .eb-section-title { font-size: 12px; color: rgba(255,255,255,0.72); margin-bottom: 10px; }
    .call-container .eb-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .call-container .eb-toggle-text { min-width: 0; }
    .call-container .eb-toggle-label { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.92); }
    .call-container .eb-toggle-desc { font-size: 11px; color: rgba(255,255,255,0.62); margin-top: 4px; line-height: 1.25; }
    .call-container .eb-toggle-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .call-container .eb-toggle-hint { font-size: 11px; color: rgba(255,255,255,0.55); max-width: 120px; text-align: right; }
    .call-container .eb-settings-note { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 6px; }

    .call-container .eb-switch { position: relative; display: inline-flex; align-items: center; }
    .call-container .eb-switch input { position: absolute; opacity: 0; width: 1px; height: 1px; }
    .call-container .eb-switch-track {
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.14);
      position: relative;
      transition: background 120ms ease, border-color 120ms ease;
    }
    .call-container .eb-switch-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transition: transform 120ms ease;
    }
    .call-container .eb-switch input:checked + .eb-switch-track {
      background: rgba(217,119,6,0.55);
      border-color: rgba(217,119,6,0.55);
    }
    .call-container .eb-switch input:checked + .eb-switch-track::after { transform: translateX(20px); }
    .call-container .eb-switch.is-disabled { opacity: 0.55; pointer-events: none; }

    /* Settings modal: keep layout contained and prevent long device labels from breaking columns */
    .call-container .lk-settings-menu-modal {
      width: min(980px, calc(100vw - 32px)) !important;
      max-width: min(980px, calc(100vw - 32px)) !important;
      max-height: min(80vh, 760px) !important;
      min-height: unset !important;
      padding: 20px !important;
      background: var(--surface-200) !important;
      border: 1px solid var(--surface-border) !important;
      border-radius: 16px !important;
      overflow: hidden !important;
      box-shadow: var(--shadow-sharp) !important;
    }

    .call-container .lk-settings-menu-modal .eb-settings-grid {
      min-width: 0 !important;
    }

    .call-container .lk-settings-menu-modal .eb-device-col {
      min-width: 0 !important;
    }

    /* LiveKit uses white-space: nowrap for buttons globally; override inside settings to avoid overflow */
    .call-container .lk-settings-menu-modal .lk-media-device-select {
      width: 100% !important;
      max-width: 100% !important;
      overflow: hidden !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      justify-content: flex-start !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      position: relative !important;
      text-overflow: ellipsis !important;
    }

    /* Smooth scrolling animation for long device names - only on hover and only if overflowing */
    @keyframes eb-device-scroll {
      0%, 100% {
        transform: translateX(0);
      }
      15% {
        transform: translateX(0);
      }
      42.5% {
        transform: translateX(var(--eb-device-scroll-distance, -100px));
      }
      57.5% {
        transform: translateX(var(--eb-device-scroll-distance, -100px));
      }
      85% {
        transform: translateX(0);
      }
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button {
      display: flex !important;
      align-items: center !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button > span.eb-device-label {
      display: inline-block !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      max-width: 100% !important;
    }

    /* Enable smooth scrolling animation only on hover and only if text overflows */
    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button:hover > span.eb-device-label[data-overflows="true"] {
      overflow: visible !important;
      text-overflow: clip !important;
      max-width: none !important;
      animation: eb-device-scroll 6s ease-in-out infinite !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button * {
      min-width: 0 !important;
    }

    /* Override LiveKit's blue accent color for selected devices with eblusha brand color */
    .call-container .lk-settings-menu-modal .lk-media-device-select [data-lk-active="true"] > .lk-button {
      color: #fff !important;
      background-color: var(--brand, #d97706) !important;
    }
    .call-container .lk-settings-menu-modal .lk-media-device-select [data-lk-active="true"] > .lk-button:hover {
      background-color: var(--brand-600, #e38b0a) !important;
    }

    /* Ping display: always keep value on one line */
    .call-container .eb-ping-display .eb-ping-text { font-size: 11px; opacity: 0.85; white-space: nowrap; }

    /* LiveKit hides connection quality until hover; keep it always visible so ping is always visible */
    .call-container .lk-participant-tile .lk-connection-quality {
      opacity: 1 !important;
      transition-delay: 0s !important;
    }

    /* When we have a ping value, fully replace the quality icon with text */
    .call-container .lk-connection-quality.eb-ping-display { width: auto !important; min-width: 1.5rem; }
    .call-container .eb-ping-display.eb-ping-has-value svg { display: none !important; }
    .call-container .eb-ping-display.eb-ping-has-value .eb-ping-text { display: inline !important; }
    .call-container .eb-ping-display:not(.eb-ping-has-value) .eb-ping-text { display: none !important; }

    /* Ping severity colors */
    .call-container .eb-ping-display[data-eb-ping-level="good"] .eb-ping-text { color: #22c55e; } /* green */
    .call-container .eb-ping-display[data-eb-ping-level="warn"] .eb-ping-text { color: #fbbf24; } /* yellow */
    .call-container .eb-ping-display[data-eb-ping-level="bad"] .eb-ping-text { color: #ef4444; }  /* red */
  `;if(a.useEffect(()=>{let i=!0;async function l(){if(!f||!r)return;const p=`conv-${r}`,w=await Ae.post("/livekit/token",{room:p,participantMetadata:{app:"eblusha",userId:O?.id,displayName:O?.displayName??O?.username,avatarUrl:v}});if(i){W(w.data.token),$(w.data.url);try{const t=String(w.data.token||"").split(".");if(t.length>=2){const n=t[1].replace(/-/g,"+").replace(/_/g,"/"),k=JSON.parse(atob(n)),e=!!k?.video?.canPublishData||!!k?.video?.can_publish_data;ne("lk-debug-ping","lkDebugPing")&&console.log("[Ping] LiveKit grant canPublishData:",e)}}catch{}}}return l(),()=>{i=!1,W(null),$(null)}},[f,r]),a.useEffect(()=>{f&&(b(!!_),A(!I),ee(!1))},[f,_,I]),a.useEffect(()=>{if(!f)return;if(typeof window<"u"&&window.innerWidth<=768){const l=document.body.style.overflow,p=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=l,document.body.style.touchAction=p}}},[f]),a.useEffect(()=>{f||(T.current=!1,u.current=!1)},[f]),a.useEffect(()=>{const i=()=>Q(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),a.useEffect(()=>{if(!f)return;const i=document.body;if(!i)return;const l=()=>{const n=new Set;document.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(e=>n.add(e)),document.querySelectorAll(".call-container .lk-control-bar button, .call-container button.lk-button").forEach(e=>n.add(e)),n.forEach(e=>{const m=e.getAttribute("aria-label")||e.getAttribute("title")||"";let s="";const c=m.toLowerCase();if(c.includes("microphone")?s=m.includes("mute")?"Выключить микрофон":"Включить микрофон":c.includes("camera")?s=m.includes("disable")||c.includes("off")?"Выключить камеру":"Включить камеру":c.includes("screen")?s=c.includes("stop")?"Остановить показ экрана":"Поделиться экраном":c.includes("flip")?s="Сменить камеру":c.includes("participants")?s="Участники":c.includes("settings")?s="Настройки":c.includes("leave")||c.includes("hang")?s="Выйти":c.includes("chat")&&(s="Чат"),s&&(e.setAttribute("aria-label",s),e.setAttribute("title",s)),e.tagName==="BUTTON"){const h=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let R=h.nextNode();for(;R;){const d=(R.nodeValue||"").replace(/\s+/g," ").trim().toLowerCase();let x=null;d==="leave"?x="Выйти":d==="participants"?x="Участники":d==="settings"?x="Настройки":d==="microphone"?x="Микрофон":d==="camera"?x="Камера":d==="connecting"?x="Подключение":d==="reconnecting"?x="Переподключение":d==="disconnected"?x="Отключено":(d==="screen share"||d==="share screen"||d==="share-screen"||d==="share-screen "||d.includes("share")&&d.includes("screen"))&&(x="Показ экрана"),x&&(R.nodeValue=x,e.setAttribute("aria-label",x),e.setAttribute("title",x)),R=h.nextNode()}}}),document.querySelectorAll(".call-container .lk-toast-connection-state").forEach(e=>{const m=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let s=m.nextNode();for(;s;){const h=(s.nodeValue||"").replace(/\s+/g," ").trim().toLowerCase();h==="connecting"?s.nodeValue="Подключение":h==="reconnecting"?s.nodeValue="Переподключение":h==="disconnected"&&(s.nodeValue="Отключено"),s=m.nextNode()}});const k=i.querySelector(".call-container .lk-control-bar")||i.querySelector(".call-container [data-lk-control-bar]")||i.querySelector('.call-container [role="toolbar"]');if(k&&E){let e=k.querySelector(".eb-minimize-btn");if(!e){e=document.createElement("button"),e.className="eb-minimize-btn lk-button",e.setAttribute("aria-label","Свернуть"),e.setAttribute("title","Свернуть"),e.setAttribute("type","button"),e.innerHTML=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
                <g id="IconSvg_bgCarrier" stroke-width="0"></g>
                <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
                <g id="IconSvg_iconCarrier">
                  <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961 3.75 10.496 10.68 10.496 18.18z"></path>
                  <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                </g>
              </svg>
              <span style="font-size: 14px;">Свернуть</span>
            </span>
          `;const m=c=>{c.preventDefault(),c.stopPropagation();try{E?.()}catch(h){console.error("Minimize click error",h)}};e.onclick=m,e.onmousedown=m,e.style.pointerEvents="auto",e.disabled=!1;let s=k.querySelector("button.lk-disconnect-button")||k.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(s&&s.parentNode){if(!s.__ebLeaveBound){const c=h=>{u.current=!0};s.addEventListener("click",c,!0),s.__ebLeaveBound=c}s.parentNode.insertBefore(e,s)}else k.appendChild(e)}if(e){const m=`
            <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
              <g id="IconSvg_bgCarrier" stroke-width="0"></g>
              <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
              <g id="IconSvg_iconCarrier">
                <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
              </g>
            </svg>`,s=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 14px; font-family: inherit; font-weight: 500; line-height: 20px;">Свернуть</span>
              ${m}
            </span>`;e.innerHTML=X?s:m,e.style.height="44px",e.style.minHeight="44px",e.style.padding="0 12px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="flex-start",e.style.fontFamily="inherit",e.style.fontSize="14px",e.style.fontWeight="500",e.style.lineHeight="20px";const c=h=>{h.preventDefault(),h.stopPropagation();try{E?.()}catch(R){console.error("Minimize click error",R)}};e.onclick=c,e.onmousedown=c,e.style.pointerEvents="auto",e.disabled=!1,e.style.marginLeft="auto",e.parentElement===k&&k.lastElementChild!==e&&k.appendChild(e),k.querySelectorAll("button.lk-button").forEach(h=>{h.style.justifyContent="flex-start"})}}};let p=!1;const w=()=>{p||(p=!0,requestAnimationFrame(()=>{p=!1,l()}))},t=new MutationObserver(()=>w());return t.observe(i,{childList:!0,subtree:!0,attributes:!0}),l(),()=>{t.disconnect();const n=i.querySelector(".call-container .lk-control-bar button.lk-disconnect-button")||i.querySelector('.call-container .lk-control-bar [aria-label*="Выйти" i], .call-container .lk-control-bar [title*="Выйти" i], .call-container .lk-control-bar [aria-label*="leave" i], .call-container .lk-control-bar [title*="leave" i]');n&&n.__ebLeaveBound&&(n.removeEventListener("click",n.__ebLeaveBound,!0),delete n.__ebLeaveBound)}},[f,E,L,X]),a.useEffect(()=>{if(!f)return;const i=document.body;if(!i)return;const l=P||{},p=F||{},w=q||null,t=v||null,n=B||null,k=ne("lk-debug-avatars","lkDebugAvatars"),e=h=>{let R=0;for(let d=0;d<h.length;d++)R=h.charCodeAt(d)+((R<<5)-R);return`hsl(${Math.abs(R)%360} 70% 45%)`},m=(h,R)=>{const Z=e(R),d=h.trim().charAt(0).toUpperCase(),x=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${Z}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${d}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(x)}`},s=()=>{i.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(R=>{const Z=R.querySelector(".lk-participant-name, [data-lk-participant-name]"),d=R.querySelector(".lk-participant-placeholder");if(!Z||!d)return;let x="";const xe={};for(let D=0;D<R.attributes.length;D++){const G=R.attributes[D];G.name.startsWith("data-")&&(xe[G.name]=G.value)}const me=R.getAttribute("data-lk-participant-identity");if(me&&(x=me.trim()),!x){const D=R.querySelector("[data-lk-participant-identity]");D&&(x=(D.getAttribute("data-lk-participant-identity")||"").trim())}if(!x){const D=R.dataset?.lkParticipantIdentity||R.dataset?.lkParticipantIdentity;D&&(x=String(D).trim())}if(!x){const D=["data-participant-identity","data-identity","data-participant-id","data-user-id"];for(const G of D){const ae=R.getAttribute(G);if(ae){x=ae.trim();break}}}const ge=R.getAttribute("data-lk-participant-metadata")||(R.dataset?R.dataset.lkParticipantMetadata:"")||"";let V=null;if(ge)try{V=JSON.parse(ge)}catch{V=null}V?.userId&&(x=String(V.userId).trim());let z=(Z.textContent||Z.getAttribute("data-lk-participant-name")||"").trim();if(!z&&V?.displayName&&(z=String(V.displayName).trim()),!z){const D=R.querySelector(".lk-participant-metadata");D?.textContent?.trim()&&(z=D.textContent.trim())}z||(z=x||"");const ce=!!(x&&w&&x===w),Se=x?p[x]??null:null,be=Object.keys(l).find(D=>D.toLowerCase()===z.toLowerCase()),Ne=be?l[be]:null;let ue=Se??Ne??(ce?t||(w?p[w]??null:null):ce?null:n);const re=m(z||x||"U",x||z||"U");if(k&&!ue&&(x||z)){const D=Object.keys(l),G=z?D.find(ae=>ae.toLowerCase()===z.toLowerCase()):null;console.log("[Avatars] Avatar not found:",{identity:x||"(empty)",name:z||"(empty)",isLocal:ce,localIdRef:w||"(empty)",byIdHasIdentity:x?x in p:!1,byNameHasName:!!G,nameMatch:G||"(no match)",participantMeta:V?{userId:V.userId,displayName:V.displayName}:null})}d.querySelectorAll("svg").forEach(D=>D.remove()),d.querySelectorAll("svg").forEach(D=>D.style.display="none");let K=d.querySelector("img.eb-ph");K||(K=document.createElement("img"),K.className="eb-ph",d.appendChild(K),K.onerror=()=>{K&&K.src!==re&&(k&&console.log("[Avatars] Avatar image failed to load, using fallback:",K.src),K.src=re)}),K.src!==(ue||re)&&(K.src=ue||re);const he=R.getBoundingClientRect(),Ce=Math.min(he.width,he.height),te=Math.floor(Ce*.95);d.style.width=`${te}px`,d.style.height=`${te}px`,d.style.maxWidth=`${te}px`,d.style.maxHeight=`${te}px`,d.style.minWidth=`${te}px`,d.style.minHeight=`${te}px`,d.style.flexShrink="0",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.style.background="transparent",d.style.backgroundImage="none",d.style.color="transparent",d.style.fontSize="0",d.style.overflow="hidden",d.style.margin="auto",d.style.borderRadius="50%",d.style.aspectRatio="1",K.alt=z,K.style.aspectRatio="1",K.style.width="100%",K.style.height="100%",K.style.maxWidth="100%",K.style.maxHeight="100%",K.style.objectFit="cover",K.style.borderRadius="50%",K.style.display="block",Array.from(d.childNodes).forEach(D=>{D.nodeType===Node.TEXT_NODE&&(D.textContent="")})})},c=new MutationObserver(s);return c.observe(i,{childList:!0,subtree:!0}),s(),()=>c.disconnect()},[f,P,F,q,v]),!f||!r||!M||!H)return null;const o=g.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:y?"transparent":"rgba(10,12,16,0.55)",backdropFilter:y?"none":"blur(4px) saturate(110%)",display:y?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:y?"none":"auto"},children:g.jsxs("div",{"data-lk-theme":"default",style:{width:y?0:"90vw",height:y?0:"80vh",maxWidth:y?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:y?"none":"var(--shadow-sharp)",opacity:y?0:1,visibility:y?"hidden":"visible"},className:"call-container",children:[g.jsx("style",{children:N}),g.jsx(Pe,{serverUrl:H,token:M,connect:!0,video:U,audio:!Y,onConnected:()=>{ee(!0);try{r&&j&&(ne("lk-debug-call","lkDebugCall")&&console.log("[CallOverlay] joinCallRoom emit",{conversationId:r,video:_}),Fe(r,_),ye([r]))}catch(i){console.error("Error joining call room:",i)}},onDisconnected:i=>{ne("lk-debug-call","lkDebugCall")&&console.log("[CallOverlay] onDisconnected:",i,"wasConnected:",C,"isGroup:",j,"minimized:",y);const l=C;ee(!1);const p=i===1||u.current;y||(j?l&&L({manual:p}):p&&L({manual:!0}))},children:g.jsxs("div",{style:{width:"100%",height:"100%"},children:[g.jsx(qe,{}),g.jsx(Be,{}),g.jsx(Ke,{localUserId:q}),g.jsx(je,{SettingsComponent:Oe})]})})]})});return Ee.createPortal(o,document.body)}export{Ye as CallOverlay};
