const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-DauDZLFk.js","assets/index-C1NmowVe.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/web-d6mkuPnj.js","assets/incoming-call-plugin.web-DbD9yKw-.js"])))=>i.map(i=>d[i]);
import{l as N}from"./vendor-socket-CA1CrNgP.js";import{r as g,_ as k,C as r}from"./index-C1NmowVe.js";import"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-crypto-C7xP7Q7Y.js";class b{socket=null;wsUrl;accessToken=null;reconnectAttempts=0;maxReconnectAttempts=5;constructor(e){this.wsUrl=e}connect(e){if(this.socket?.connected){console.log("[SocketService] Already connected");return}this.accessToken=e,console.log("[SocketService] Connecting to:",this.wsUrl),console.log("[SocketService] Token length:",e?.length||0),this.socket=N(this.wsUrl,{autoConnect:!1,transports:["websocket","polling"],auth:{token:e},query:{token:e}}),this.setupEventHandlers(),this.socket.connect(),console.log("[SocketService] Connection initiated")}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.accessToken=null,this.reconnectAttempts=0}updateToken(e){this.accessToken=e,this.socket&&(this.socket.auth={token:e},this.socket.io.opts.query={token:e})}isConnected(){return this.socket?.connected??!1}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{console.log("[SocketService] ‚úÖ Connected successfully"),this.reconnectAttempts=0}),this.socket.on("disconnect",e=>{console.log("[SocketService] ‚ùå Disconnected:",e)}),this.socket.on("connect_error",e=>{console.error("[SocketService] ‚ùå Connection error:",e),console.error("[SocketService] Error message:",e.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&console.error("[SocketService] Max reconnect attempts reached")}),this.socket.io.on("reconnect_attempt",()=>{this.accessToken&&(this.socket.auth={token:this.accessToken},this.socket.io.opts.query={token:this.accessToken})}))}onMessageNew(e){return this.socket?(this.socket.on("message:new",e),()=>this.socket?.off("message:new",e)):()=>{}}onMessageNotify(e){return this.socket?(this.socket.on("message:notify",e),()=>this.socket?.off("message:notify",e)):()=>{}}onConversationTyping(e){return this.socket?(this.socket.on("conversation:typing",e),()=>this.socket?.off("conversation:typing",e)):()=>{}}onMessageReaction(e){return this.socket?(this.socket.on("message:reaction",e),()=>this.socket?.off("message:reaction",e)):()=>{}}onReceiptsUpdate(e){return this.socket?(this.socket.on("receipts:update",e),()=>this.socket?.off("receipts:update",e)):()=>{}}onConversationNew(e){return this.socket?(this.socket.on("conversations:new",e),()=>this.socket?.off("conversations:new",e)):()=>{}}onConversationUpdated(e){return this.socket?(this.socket.on("conversations:updated",e),()=>this.socket?.off("conversations:updated",e)):()=>{}}onConversationDeleted(e){return this.socket?(this.socket.on("conversations:deleted",e),()=>this.socket?.off("conversations:deleted",e)):()=>{}}onConversationMemberRemoved(e){return this.socket?(this.socket.on("conversations:member:removed",e),()=>this.socket?.off("conversations:member:removed",e)):()=>{}}onPresenceUpdate(e){return this.socket?(this.socket.on("presence:update",e),()=>this.socket?.off("presence:update",e)):()=>{}}onContactRequest(e){return this.socket?(this.socket.on("contacts:request:new",e),()=>this.socket?.off("contacts:request:new",e)):()=>{}}onContactAccepted(e){return this.socket?(this.socket.on("contacts:request:accepted",e),()=>this.socket?.off("contacts:request:accepted",e)):()=>{}}onContactRemoved(e){return this.socket?(this.socket.on("contacts:removed",e),()=>this.socket?.off("contacts:removed",e)):()=>{}}onProfileUpdate(e){return this.socket?(this.socket.on("profile:update",e),()=>this.socket?.off("profile:update",e)):()=>{}}onCallIncoming(e){return this.socket?(this.socket.on("call:incoming",e),()=>this.socket?.off("call:incoming",e)):()=>{}}onCallAccepted(e){return this.socket?(this.socket.on("call:accepted",e),()=>this.socket?.off("call:accepted",e)):()=>{}}onCallDeclined(e){return this.socket?(this.socket.on("call:declined",e),()=>this.socket?.off("call:declined",e)):()=>{}}onCallEnded(e){return this.socket?(this.socket.on("call:ended",e),()=>this.socket?.off("call:ended",e)):()=>{}}onCallStatus(e){return this.socket?(this.socket.on("call:status",e),()=>this.socket?.off("call:status",e)):()=>{}}onCallStatusBulk(e){return this.socket?(this.socket.on("call:status:bulk",e),()=>this.socket?.off("call:status:bulk",e)):()=>{}}emitConversationTyping(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:typing");return}this.socket.emit("conversation:typing",e)}emitCallInvite(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:invite");return}this.socket.emit("call:invite",e)}emitCallAccept(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:accept");return}this.socket.emit("call:accept",e)}emitCallDecline(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:decline");return}this.socket.emit("call:decline",e)}emitCallEnd(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:end");return}this.socket.emit("call:end",e)}emitCallRoomJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:join");return}this.socket.emit("call:room:join",e)}emitCallRoomLeave(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:leave");return}this.socket.emit("call:room:leave",e)}emitCallStatusRequest(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:status:request");return}this.socket.emit("call:status:request",e)}emitConversationJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:join");return}this.socket.emit("conversation:join",e)}}let v=null;function d(n){if(!v){if(!n)throw new Error("SocketService requires wsUrl for first initialization");v=new b(n)}return v}var C;(function(n){n[n.Sunday=1]="Sunday",n[n.Monday=2]="Monday",n[n.Tuesday=3]="Tuesday",n[n.Wednesday=4]="Wednesday",n[n.Thursday=5]="Thursday",n[n.Friday=6]="Friday",n[n.Saturday=7]="Saturday"})(C||(C={}));const h=g("LocalNotifications",{web:()=>k(()=>import("./web-DauDZLFk.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(n=>new n.LocalNotificationsWeb)}),p=g("App",{web:()=>k(()=>import("./web-d6mkuPnj.js"),__vite__mapDeps([7,1,2,3,4,5,6])).then(n=>new n.AppWeb)});class T{notificationIds=new Set;conversationNotifications=new Map;async initialize(){if(console.log("[NotificationService] üöÄ Initializing notification service..."),console.log("[NotificationService] Platform:",r.getPlatform()),console.log("[NotificationService] Is native:",r.isNativePlatform()),!r.isPluginAvailable("LocalNotifications")){console.error("[NotificationService] ‚ùå LocalNotifications plugin is not available on this platform");return}try{const e=await h.checkPermissions();if(console.log("[NotificationService] Current permission:",e.display),e.display!=="granted"){console.log("[NotificationService] Requesting notification permission...");const t=await h.requestPermissions();if(console.log("[NotificationService] Permission result:",t.display),t.display!=="granted"){console.warn("[NotificationService] ‚ùå Notification permission not granted");return}}console.log("[NotificationService] ‚úÖ Notification permission granted")}catch(e){console.error("[NotificationService] ‚ùå Error initializing notifications:",e);return}h.addListener("localNotificationActionPerformed",e=>{const t=e.notification.extra;t?.conversationId&&this.handleNotificationClick(t)}),p.addListener("appStateChange",e=>{e.isActive&&this.onAppBecameActive()})}async showMessageNotification(e,t,s,a){console.log("[NotificationService] üì® showMessageNotification called:",{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,messageText:t,senderName:s});const l=await p.getState();if(console.log("[NotificationService] App state:",l.isActive?"active":"background"),l.isActive){console.log("[NotificationService] App is active, skipping notification");return}const f=Date.now()%2147483647,o=e.conversationId,i=this.conversationNotifications.get(o);if(i){await this.updateConversationNotification(i,o,t||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",s||"–ö—Ç–æ-—Ç–æ",a);return}const c=s||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",u=t||"–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";if(console.log("[NotificationService] üì§ Scheduling notification:",{notificationId:f,title:c,body:u,conversationId:o}),!r.isPluginAvailable("LocalNotifications")){console.error("[NotificationService] ‚ùå LocalNotifications plugin is not available");return}try{await h.schedule({notifications:[{title:c,body:u,id:f,sound:"notify.mp3",attachments:a?[{id:"avatar",url:a}]:void 0,extra:{conversationId:o,messageId:e.messageId,senderId:e.senderId,avatarUrl:a},actionTypeId:"MESSAGE",group:`conversation_${o}`,groupSummary:!1}]}),console.log("[NotificationService] ‚úÖ Notification scheduled successfully"),this.notificationIds.add(f),this.conversationNotifications.set(o,f)}catch(w){console.error("[NotificationService] ‚ùå Error scheduling notification:",w)}}async updateConversationNotification(e,t,s,a,l){await h.schedule({notifications:[{title:a,body:s,id:e,sound:void 0,extra:{conversationId:t,senderId:void 0,avatarUrl:l},actionTypeId:"MESSAGE",group:`conversation_${t}`,groupSummary:!1}]})}async showIncomingCallNotification(e,t,s,a){const l=Date.now()%2147483647,f=s?"–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫":"–∑–≤–æ–Ω–æ–∫";return await h.schedule({notifications:[{title:`–í—Ö–æ–¥—è—â–∏–π ${f}`,body:`${t} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`,id:l,sound:"ring.mp3",ongoing:!0,extra:{conversationId:e,callType:s?"video":"audio",callerName:t,avatarUrl:a},actionTypeId:"INCOMING_CALL"}]}),this.notificationIds.add(l),l}async cancelCallNotification(e){await h.cancel({notifications:[{id:e}]}),this.notificationIds.delete(e)}async cancelConversationNotifications(e){const t=this.conversationNotifications.get(e);t&&(await h.cancel({notifications:[{id:t}]}),this.notificationIds.delete(t),this.conversationNotifications.delete(e))}async clearAll(){const e=Array.from(this.notificationIds);e.length>0&&await h.cancel({notifications:e.map(t=>({id:t}))}),this.notificationIds.clear(),this.conversationNotifications.clear()}handleNotificationClick(e){console.log("[NotificationService] Notification clicked:",e)}onAppBecameActive(){console.log("[NotificationService] App became active")}}let m=null;function S(){return m||(m=new T),m}class A{socketService=d();notificationService=S();callbacks;typingTimers=new Map;constructor(e){this.callbacks=e}initialize(){console.log("[MessageHandler] üöÄ Initializing message handlers...");const e=[],t=this.socketService.onMessageNew(async o=>{console.log("[MessageHandler] üì® message:new:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(t);const s=this.socketService.onMessageNotify(async o=>{console.log("[MessageHandler] üîî message:notify:",o);const i=this.callbacks.isConversationActive?.(o.conversationId)??!1;i||await this.handleMessageNotification(o),i&&o.message&&this.callbacks.onMessageReceived?.(o),this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(s);const a=this.socketService.onConversationTyping(o=>{console.log("[MessageHandler] conversation:typing:",o);const i=`${o.conversationId}_${o.userId}`,c=this.typingTimers.get(i);if(c&&clearTimeout(c),o.typing){this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!0);const u=setTimeout(()=>{this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(i)},2e3);this.typingTimers.set(i,u)}else this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(i)});e.push(a);const l=this.socketService.onMessageReaction(async o=>{console.log("[MessageHandler] message:reaction:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?o.message&&this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(l);const f=this.socketService.onReceiptsUpdate(o=>{console.log("[MessageHandler] receipts:update:",o),this.callbacks.isConversationActive?.(o.conversationId)});return e.push(f),console.log("[MessageHandler] ‚úÖ All handlers subscribed, total:",e.length),()=>{console.log("[MessageHandler] Unsubscribing all handlers"),e.forEach(o=>o()),this.typingTimers.forEach(o=>clearTimeout(o)),this.typingTimers.clear()}}async handleMessageNotification(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);let s="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";e.message&&(e.message.content?s=e.message.content:e.message.attachments?.length&&(e.message.attachments[0].type==="IMAGE"?s="üì∑ –§–æ—Ç–æ":s="üìé –§–∞–π–ª")),await this.notificationService.showMessageNotification(e,s,t?.senderName||t?.title,t?.avatarUrl)}catch(t){console.error("[MessageHandler] Error handling message notification:",t)}}sendTyping(e,t){this.socketService.emitConversationTyping({conversationId:e,typing:t})}}const I=g("IncomingCall",{web:()=>k(()=>import("./incoming-call-plugin.web-DbD9yKw-.js"),__vite__mapDeps([8,1,2,3,4,5,6])).then(n=>new n.IncomingCallWeb)});class M{socketService=d();notificationService=S();callbacks;activeIncomingCalls=new Map;callNotificationIds=new Map;autoDeclineTimers=new Map;constructor(e){this.callbacks=e}initialize(){const e=[],t=this.socketService.onCallIncoming(async i=>{console.log("[CallHandler] üìû call:incoming:",i),this.activeIncomingCalls.set(i.conversationId,i),await this.handleIncomingCall(i);const c=setTimeout(()=>{console.log("[CallHandler] Auto-declining call after 25 seconds"),this.declineCall(i.conversationId)},25e3);this.autoDeclineTimers.set(i.conversationId,c),this.callbacks.onIncomingCall?.(i)});e.push(t);const s=this.socketService.onCallAccepted(i=>{console.log("[CallHandler] call:accepted:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallAccepted?.(i)});e.push(s);const a=this.socketService.onCallDeclined(i=>{console.log("[CallHandler] call:declined:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallDeclined?.(i)});e.push(a);const l=this.socketService.onCallEnded(i=>{console.log("[CallHandler] call:ended:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallEnded?.(i)});e.push(l);const f=this.socketService.onCallStatus(i=>{console.log("[CallHandler] call:status:",i),this.callbacks.onCallStatusUpdate?.(i.conversationId,i)});e.push(f);const o=this.socketService.onCallStatusBulk(i=>{console.log("[CallHandler] call:status:bulk:",i);for(const[c,u]of Object.entries(i.statuses))this.callbacks.onCallStatusUpdate?.(c,u)});return e.push(o),()=>{e.forEach(i=>i()),this.autoDeclineTimers.forEach(i=>clearTimeout(i)),this.autoDeclineTimers.clear()}}async handleIncomingCall(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId),s=await this.notificationService.showIncomingCallNotification(e.conversationId,e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",e.video,t?.avatarUrl);this.callNotificationIds.set(e.conversationId,s),await this.openIncomingCallScreen(e)}catch(t){console.error("[CallHandler] Error handling incoming call:",t)}}async openIncomingCallScreen(e){if(r.isNativePlatform())try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);await I.showIncomingCall({conversationId:e.conversationId,callerName:e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",isVideo:e.video,avatarUrl:t?.avatarUrl})}catch(t){console.error("[CallHandler] Error opening incoming call screen:",t)}}async closeIncomingCallScreen(e){const t=this.callNotificationIds.get(e);if(t&&(await this.notificationService.cancelCallNotification(t),this.callNotificationIds.delete(e)),this.activeIncomingCalls.delete(e),r.isNativePlatform())try{await I.closeIncomingCall()}catch(s){console.error("[CallHandler] Error closing incoming call screen:",s)}}acceptCall(e,t){if(!this.activeIncomingCalls.get(e)){console.warn("[CallHandler] No active incoming call for:",e);return}const a=this.autoDeclineTimers.get(e);a&&(clearTimeout(a),this.autoDeclineTimers.delete(e)),this.socketService.emitCallAccept({conversationId:e,video:t}),this.closeIncomingCallScreen(e)}declineCall(e){const t=this.autoDeclineTimers.get(e);t&&(clearTimeout(t),this.autoDeclineTimers.delete(e)),this.socketService.emitCallDecline({conversationId:e}),this.closeIncomingCallScreen(e)}endCall(e){this.socketService.emitCallEnd({conversationId:e})}joinCallRoom(e,t){this.socketService.emitCallRoomJoin({conversationId:e,video:t})}leaveCallRoom(e){this.socketService.emitCallRoomLeave({conversationId:e})}requestCallStatuses(e){this.socketService.emitCallStatusRequest({conversationIds:e})}}typeof window<"u"&&r.isNativePlatform()?(console.log("[Capacitor] ‚úÖ Native platform detected, initializing services..."),S().initialize().then(()=>{console.log("[Capacitor] ‚úÖ Notification service initialized")}).catch(e=>{console.error("[Capacitor] ‚ùå Failed to initialize notification service:",e)})):console.log("[Capacitor] Web platform detected");function _(n,e){if(console.log("[Capacitor] initializeSocketConnection called, isNative:",r.isNativePlatform()),!r.isNativePlatform()){console.warn("[Capacitor] initializeSocketConnection called on web platform");return}console.log("[Capacitor] Creating SocketService with URL:",n);const t=d(n);console.log("[Capacitor] Connecting socket with token length:",e?.length||0),t.connect(e)}function z(n){if(console.log("[Capacitor] initializeMessageHandlers called, isNative:",r.isNativePlatform()),!r.isNativePlatform())return console.warn("[Capacitor] initializeMessageHandlers called on web platform"),()=>{};console.log("[Capacitor] Creating MessageHandler");const t=new A(n).initialize();return console.log("[Capacitor] ‚úÖ MessageHandler initialized"),t}function U(n){return r.isNativePlatform()?new M(n).initialize():(console.warn("[Capacitor] initializeCallHandlers called on web platform"),()=>{})}function L(n){if(!r.isNativePlatform()){console.warn("[Capacitor] updateSocketToken called on web platform");return}d().updateToken(n)}export{S as getNotificationService,d as getSocketService,U as initializeCallHandlers,z as initializeMessageHandlers,_ as initializeSocketConnection,L as updateSocketToken};
