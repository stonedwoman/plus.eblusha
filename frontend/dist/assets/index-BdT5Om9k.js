import{r as f}from"./vendor-query-CNP5Hy5J.js";var Xs={};function Du(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var Au=Object.defineProperty,Lu=(n,e,t)=>e in n?Au(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Zs=(n,e,t)=>Lu(n,typeof e!="symbol"?e+"":e,t);class ye{constructor(){Zs(this,"_locking"),Zs(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),i}}function ee(n,e){if(!n)throw new Error(e)}const Nu=34028234663852886e22,Uu=-34028234663852886e22,Fu=4294967295,ju=2147483647,Bu=-2147483648;function Zn(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>ju||n<Bu)throw new Error("invalid int 32: "+n)}function wr(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>Fu||n<0)throw new Error("invalid uint 32: "+n)}function Fa(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>Nu||n<Uu))throw new Error("invalid float 32: "+n)}const ja=Symbol("@bufbuild/protobuf/enum-type");function Vu(n){const e=n[ja];return ee(e,"missing enum type on enum object"),e}function Ba(n,e,t,i){n[ja]=Va(e,t.map(r=>({no:r.no,name:r.name,localName:n[r.no]})))}function Va(n,e,t){const i=Object.create(null),r=Object.create(null),s=[];for(const o of e){const a=qa(o);s.push(a),i[o.name]=a,r[o.no]=a}return{typeName:n,values:s,findName(o){return i[o]},findNumber(o){return r[o]}}}function qu(n,e,t){const i={};for(const r of e){const s=qa(r);i[s.localName]=s.no,i[s.no]=s.localName}return Ba(i,n,e),i}function qa(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}class as{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(t);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,t){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(t);return r.readMessage(i,e,s,this),this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e?.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function Wu(n,e,t,i){var r;const s=(r=i?.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),o={[s]:function(a){n.util.initFields(this),n.util.initPartial(a,this)}}[s];return Object.setPrototypeOf(o.prototype,new as),Object.assign(o,{runtime:n,typeName:e,fields:n.util.newFieldList(t),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return n.util.equals(o,a,c)}}),o}function Hu(){let n=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(n|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}let t=this.buf[this.pos++];if(n|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[n,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}throw new Error("invalid varint")}function er(n,e,t){for(let s=0;s<28;s=s+7){const o=n>>>s,a=!(!(o>>>7)&&e==0),c=(a?o|128:o)&255;if(t.push(c),!a)return}const i=n>>>28&15|(e&7)<<4,r=e>>3!=0;if(t.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const o=e>>>s,a=!!(o>>>7),c=(a?o|128:o)&255;if(t.push(c),!a)return}t.push(e>>>31&1)}}const ei=4294967296;function eo(n){const e=n[0]==="-";e&&(n=n.slice(1));const t=1e6;let i=0,r=0;function s(o,a){const c=Number(n.slice(o,a));r*=t,i=i*t+c,i>=ei&&(r=r+(i/ei|0),i=i%ei)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?Ha(i,r):cs(i,r)}function Ku(n,e){let t=cs(n,e);const i=t.hi&2147483648;i&&(t=Ha(t.lo,t.hi));const r=Wa(t.lo,t.hi);return i?"-"+r:r}function Wa(n,e){if({lo:n,hi:e}=zu(n,e),e<=2097151)return String(ei*e+n);const t=n&16777215,i=(n>>>24|e<<8)&16777215,r=e>>16&65535;let s=t+i*6777216+r*6710656,o=i+r*8147497,a=r*2;const c=1e7;return s>=c&&(o+=Math.floor(s/c),s%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+to(o)+to(s)}function zu(n,e){return{lo:n>>>0,hi:e>>>0}}function cs(n,e){return{lo:n|0,hi:e|0}}function Ha(n,e){return e=~e,n?n=~n+1:e+=1,cs(n,e)}const to=n=>{const e=String(n);return"0000000".slice(e.length)+e};function no(n,e){if(n>=0){for(;n>127;)e.push(n&127|128),n=n>>>7;e.push(n)}else{for(let t=0;t<9;t++)e.push(n&127|128),n=n>>7;e.push(1)}}function Gu(){let n=this.buf[this.pos++],e=n&127;if((n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<7,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<14,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<21,(n&128)==0)return this.assertBounds(),e;n=this.buf[this.pos++],e|=(n&15)<<28;for(let t=5;(n&128)!==0&&t<10;t++)n=this.buf[this.pos++];if((n&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function Ju(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof Xs!="object"||Xs.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>a||l<o)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return n.setBigInt64(0,this.parse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(c){return n.setBigInt64(0,this.uParse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigInt64(0,!0)},uDec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigUint64(0,!0)}}}const t=r=>ee(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>ee(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),eo(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),eo(r)},dec(r,s){return Ku(r,s)},uDec(r,s){return Wa(r,s)}}}const X=Ju();var A;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(A||(A={}));var _t;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(_t||(_t={}));function bt(n,e,t){if(e===t)return!0;if(n==A.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}switch(n){case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return e==t}return!1}function ln(n,e){switch(n){case A.BOOL:return!1;case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return e==0?X.zero:"0";case A.DOUBLE:case A.FLOAT:return 0;case A.BYTES:return new Uint8Array(0);case A.STRING:return"";default:return 0}}function Ka(n,e){switch(n){case A.BOOL:return e===!1;case A.STRING:return e==="";case A.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var ne;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(ne||(ne={}));class $u{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(wr(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Zn(e),no(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Fa(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){wr(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Zn(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Zn(e),e=(e<<1^e>>31)>>>0,no(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=X.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=X.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=X.enc(e);return er(t.lo,t.hi,this.buf),this}sint64(e){let t=X.enc(e),i=t.hi>>31,r=t.lo<<1^i,s=(t.hi<<1|t.lo>>>31)^i;return er(r,s,this.buf),this}uint64(e){let t=X.uEnc(e);return er(t.lo,t.hi,this.buf),this}}class Qu{constructor(e,t){this.varint64=Hu,this.uint32=Gu,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e,t){let i=this.pos;switch(e){case ne.Varint:for(;this.buf[this.pos++]&128;);break;case ne.Bit64:this.pos+=4;case ne.Bit32:this.pos+=4;break;case ne.LengthDelimited:let r=this.uint32();this.pos+=r;break;case ne.StartGroup:for(;;){const[s,o]=this.tag();if(o===ne.EndGroup){if(t!==void 0&&s!==t)throw new Error("invalid end group tag");break}this.skip(o,s)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return X.dec(...this.varint64())}uint64(){return X.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(e&1);return e=(e>>>1|(t&1)<<31)^i,t=t>>>1^i,X.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return X.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return X.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function Yu(n,e,t,i){let r;return{typeName:e,extendee:t,get field(){if(!r){const s=typeof i=="function"?i():i;s.name=e.split(".").pop(),s.jsonName="[".concat(e,"]"),r=n.util.newFieldList([s]).list()[0]}return r},runtime:n}}function za(n){const e=n.field.localName,t=Object.create(null);return t[e]=Xu(n),[t,()=>t[e]]}function Xu(n){const e=n.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return ln(e.T,e.L);case"message":const t=e.T,i=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function Zu(n,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=n.length-1;t>=0;--t)if(n[t].no==e.no)return[n[t]];return[]}return n.filter(t=>t.no===e.no)}let at="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Di=[];for(let n=0;n<at.length;n++)Di[at[n].charCodeAt(0)]=n;Di[45]=at.indexOf("+");Di[95]=at.indexOf("/");const Ga={dec(n){let e=n.length*3/4;n[n.length-2]=="="?e-=2:n[n.length-1]=="="&&(e-=1);let t=new Uint8Array(e),i=0,r=0,s,o=0;for(let a=0;a<n.length;a++){if(s=Di[n.charCodeAt(a)],s===void 0)switch(n[a]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:o=s,r=1;break;case 1:t[i++]=o<<2|(s&48)>>4,o=s,r=2;break;case 2:t[i++]=(o&15)<<4|(s&60)>>2,o=s,r=3;break;case 3:t[i++]=(o&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,i)},enc(n){let e="",t=0,i,r=0;for(let s=0;s<n.length;s++)switch(i=n[s],t){case 0:e+=at[i>>2],r=(i&3)<<4,t=1;break;case 1:e+=at[r|i>>4],r=(i&15)<<2,t=2;break;case 2:e+=at[r|i>>6],e+=at[i&63],t=0;break}return t&&(e+=at[r],e+="=",t==1&&(e+="=")),e}};function ed(n,e,t){$a(e,n);const i=e.runtime.bin.makeReadOptions(t),r=Zu(n.getType().runtime.bin.listUnknownFields(n),e.field),[s,o]=za(e);for(const a of r)e.runtime.bin.readField(s,i.readerFactory(a.data),e.field,a.wireType,i);return o()}function td(n,e,t,i){$a(e,n);const r=e.runtime.bin.makeReadOptions(i),s=e.runtime.bin.makeWriteOptions(i);if(Ja(n,e)){const l=n.getType().runtime.bin.listUnknownFields(n).filter(u=>u.no!=e.field.no);n.getType().runtime.bin.discardUnknownFields(n);for(const u of l)n.getType().runtime.bin.onUnknownField(n,u.no,u.wireType,u.data)}const o=s.writerFactory();let a=e.field;!a.opt&&!a.repeated&&(a.kind=="enum"||a.kind=="scalar")&&(a=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(a,t,o,s);const c=r.readerFactory(o.finish());for(;c.pos<c.len;){const[l,u]=c.tag(),d=c.skip(u,l);n.getType().runtime.bin.onUnknownField(n,l,u,d)}}function Ja(n,e){const t=n.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(n).find(i=>i.no==e.field.no)}function $a(n,e){ee(n.extendee.typeName==e.getType().typeName,"extension ".concat(n.typeName," can only be applied to message ").concat(n.extendee.typeName))}function Qa(n,e){const t=n.localName;if(n.repeated)return e[t].length>0;if(n.oneof)return e[n.oneof.localName].case===t;switch(n.kind){case"enum":case"scalar":return n.opt||n.req?e[t]!==void 0:n.kind=="enum"?e[t]!==n.T.values[0].no:!Ka(n.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function io(n,e){const t=n.localName,i=!n.opt&&!n.req;if(n.repeated)e[t]=[];else if(n.oneof)e[n.oneof.localName]={case:void 0};else switch(n.kind){case"map":e[t]={};break;case"enum":e[t]=i?n.T.values[0].no:void 0;break;case"scalar":e[t]=i?ln(n.T,n.L):void 0;break;case"message":e[t]=void 0;break}}function ct(n,e){if(n===null||typeof n!="object"||!Object.getOwnPropertyNames(as.prototype).every(i=>i in n&&typeof n[i]=="function"))return!1;const t=n.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function Ya(n,e){return ct(e)||!n.fieldWrapper?e:n.fieldWrapper.wrapField(e)}A.DOUBLE,A.FLOAT,A.INT64,A.UINT64,A.INT32,A.UINT32,A.BOOL,A.STRING,A.BYTES;const ro={ignoreUnknownFields:!1},so={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function nd(n){return n?Object.assign(Object.assign({},ro),n):ro}function id(n){return n?Object.assign(Object.assign({},so),n):so}const fi=Symbol(),ti=Symbol();function rd(){return{makeReadOptions:nd,makeWriteOptions:id,readMessage(n,e,t,i){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(n.typeName," from JSON: ").concat(Qe(e)));i=i??new n;const r=new Map,s=t.typeRegistry;for(const[o,a]of Object.entries(e)){const c=n.fields.findJsonName(o);if(c){if(c.oneof){if(a===null&&c.kind=="scalar")continue;const l=r.get(c.oneof);if(l!==void 0)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(l,'", "').concat(o,'"'));r.set(c.oneof,o)}oo(i,a,c,t,n)}else{let l=!1;if(s?.findExtension&&o.startsWith("[")&&o.endsWith("]")){const u=s.findExtension(o.substring(1,o.length-1));if(u&&u.extendee.typeName==n.typeName){l=!0;const[d,h]=za(u);oo(d,a,u.field,t,u),td(i,u,h(),t)}}if(!l&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: key "').concat(o,'" is unknown'))}}return i},writeMessage(n,e){const t=n.getType(),i={};let r;try{for(r of t.fields.byNumber()){if(!Qa(r,n)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!od(r))continue}const o=r.oneof?n[r.oneof.localName].value:n[r.localName],a=ao(r,o,e);a!==void 0&&(i[e.useProtoFieldName?r.name:r.jsonName]=a)}const s=e.typeRegistry;if(s?.findExtensionFor)for(const o of t.runtime.bin.listUnknownFields(n)){const a=s.findExtensionFor(t.typeName,o.no);if(a&&Ja(n,a)){const c=ed(n,a,e),l=ao(a.field,c,e);l!==void 0&&(i[a.field.jsonName]=l)}}}catch(s){const o=r?"cannot encode field ".concat(t.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),a=s instanceof Error?s.message:String(s);throw new Error(o+(a.length>0?": ".concat(a):""))}return i},readScalar(n,e,t){return Rn(n,e,t??_t.BIGINT,!0)},writeScalar(n,e,t){if(e!==void 0&&(t||Ka(n,e)))return ni(n,e)},debug:Qe}}function Qe(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function oo(n,e,t,i,r){let s=t.localName;if(t.repeated){if(ee(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(e)));const o=n[s];for(const a of e){if(a===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(a)));switch(t.kind){case"message":o.push(t.T.fromJson(a,i));break;case"enum":const c=tr(t.T,a,i.ignoreUnknownFields,!0);c!==ti&&o.push(c);break;case"scalar":try{o.push(Rn(t.T,a,t.L,!0))}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(a));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(e)));const o=n[s];for(const[a,c]of Object.entries(e)){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: map value null"));let l;try{l=sd(t.K,a)}catch(u){let d="cannot decode map key for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(e));throw u instanceof Error&&u.message.length>0&&(d+=": ".concat(u.message)),new Error(d)}switch(t.V.kind){case"message":o[l]=t.V.T.fromJson(c,i);break;case"enum":const u=tr(t.V.T,c,i.ignoreUnknownFields,!0);u!==ti&&(o[l]=u);break;case"scalar":try{o[l]=Rn(t.V.T,c,_t.BIGINT,!0)}catch(d){let h="cannot decode map value for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(e));throw d instanceof Error&&d.message.length>0&&(h+=": ".concat(d.message)),new Error(h)}break}}}else switch(t.oneof&&(n=n[t.oneof.localName]={case:s},s="value"),t.kind){case"message":const o=t.T;if(e===null&&o.typeName!="google.protobuf.Value")return;let a=n[s];ct(a)?a.fromJson(e,i):(n[s]=a=o.fromJson(e,i),o.fieldWrapper&&!t.oneof&&(n[s]=o.fieldWrapper.unwrapField(a)));break;case"enum":const c=tr(t.T,e,i.ignoreUnknownFields,!1);switch(c){case fi:io(t,n);break;case ti:break;default:n[s]=c;break}break;case"scalar":try{const l=Rn(t.T,e,t.L,!1);switch(l){case fi:io(t,n);break;default:n[s]=l;break}}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Qe(e));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}function sd(n,e){if(n===A.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return Rn(n,e,_t.BIGINT,!0).toString()}function Rn(n,e,t,i){if(e===null)return i?ln(n,t):fi;switch(n){case A.DOUBLE:case A.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return n==A.FLOAT&&Fa(r),r;case A.INT32:case A.FIXED32:case A.SFIXED32:case A.SINT32:case A.UINT32:let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return n==A.UINT32||n==A.FIXED32?wr(s):Zn(s),s;case A.INT64:case A.SFIXED64:case A.SINT64:if(typeof e!="number"&&typeof e!="string")break;const o=X.parse(e);return t?o.toString():o;case A.FIXED64:case A.UINT64:if(typeof e!="number"&&typeof e!="string")break;const a=X.uParse(e);return t?a.toString():a;case A.BOOL:if(typeof e!="boolean")break;return e;case A.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case A.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return Ga.dec(e)}throw new Error}function tr(n,e,t,i){if(e===null)return n.typeName=="google.protobuf.NullValue"?0:i?n.values[0].no:fi;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=n.findName(e);if(r!==void 0)return r.no;if(t)return ti;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(Qe(e)))}function od(n){return n.repeated||n.kind=="map"?!0:!(n.oneof||n.kind=="message"||n.opt||n.req)}function ao(n,e,t){if(n.kind=="map"){ee(typeof e=="object"&&e!=null);const i={},r=Object.entries(e);switch(n.V.kind){case"scalar":for(const[o,a]of r)i[o.toString()]=ni(n.V.T,a);break;case"message":for(const[o,a]of r)i[o.toString()]=a.toJson(t);break;case"enum":const s=n.V.T;for(const[o,a]of r)i[o.toString()]=nr(s,a,t.enumAsInteger);break}return t.emitDefaultValues||r.length>0?i:void 0}if(n.repeated){ee(Array.isArray(e));const i=[];switch(n.kind){case"scalar":for(let r=0;r<e.length;r++)i.push(ni(n.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)i.push(nr(n.T,e[r],t.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)i.push(e[r].toJson(t));break}return t.emitDefaultValues||i.length>0?i:void 0}switch(n.kind){case"scalar":return ni(n.T,e);case"enum":return nr(n.T,e,t.enumAsInteger);case"message":return Ya(n.T,e).toJson(t)}}function nr(n,e,t){var i;if(ee(typeof e=="number"),n.typeName=="google.protobuf.NullValue")return null;if(t)return e;const r=n.findNumber(e);return(i=r?.name)!==null&&i!==void 0?i:e}function ni(n,e){switch(n){case A.INT32:case A.SFIXED32:case A.SINT32:case A.FIXED32:case A.UINT32:return ee(typeof e=="number"),e;case A.FLOAT:case A.DOUBLE:return ee(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case A.STRING:return ee(typeof e=="string"),e;case A.BOOL:return ee(typeof e=="boolean"),e;case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return ee(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case A.BYTES:return ee(e instanceof Uint8Array),Ga.enc(e)}}const $t=Symbol("@bufbuild/protobuf/unknown-fields"),co={readUnknownFields:!0,readerFactory:n=>new Qu(n)},lo={writeUnknownFields:!0,writerFactory:()=>new $u};function ad(n){return n?Object.assign(Object.assign({},co),n):co}function cd(n){return n?Object.assign(Object.assign({},lo),n):lo}function ld(){return{makeReadOptions:ad,makeWriteOptions:cd,listUnknownFields(n){var e;return(e=n[$t])!==null&&e!==void 0?e:[]},discardUnknownFields(n){delete n[$t]},writeUnknownFields(n,e){const i=n[$t];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(n,e,t,i){const r=n;Array.isArray(r[$t])||(r[$t]=[]),r[$t].push({no:e,wireType:t,data:i})},readMessage(n,e,t,i,r){const s=n.getType(),o=r?e.len:e.pos+t;let a,c;for(;e.pos<o&&([a,c]=e.tag(),!(r===!0&&c==ne.EndGroup));){const l=s.fields.find(a);if(!l){const u=e.skip(c,a);i.readUnknownFields&&this.onUnknownField(n,a,c,u);continue}uo(n,e,l,c,i)}if(r&&(c!=ne.EndGroup||a!==t))throw new Error("invalid end group tag")},readField:uo,writeMessage(n,e,t){const i=n.getType();for(const r of i.fields.byNumber()){if(!Qa(r,n)){if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?n[r.oneof.localName].value:n[r.localName];ho(r,s,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(n,e),e},writeField(n,e,t,i){e!==void 0&&ho(n,e,t,i)}}}function uo(n,e,t,i,r){let{repeated:s,localName:o}=t;switch(t.oneof&&(n=n[t.oneof.localName],n.case!=o&&delete n.value,n.case=o,o="value"),t.kind){case"scalar":case"enum":const a=t.kind=="enum"?A.INT32:t.T;let c=pi;if(t.kind=="scalar"&&t.L>0&&(c=dd),s){let h=n[o];if(i==ne.LengthDelimited&&a!=A.STRING&&a!=A.BYTES){let b=e.uint32()+e.pos;for(;e.pos<b;)h.push(c(e,a))}else h.push(c(e,a))}else n[o]=c(e,a);break;case"message":const l=t.T;s?n[o].push(ii(e,new l,r,t)):ct(n[o])?ii(e,n[o],r,t):(n[o]=ii(e,new l,r,t),l.fieldWrapper&&!t.oneof&&!t.repeated&&(n[o]=l.fieldWrapper.unwrapField(n[o])));break;case"map":let[u,d]=ud(t,e,r);n[o][u]=d;break}}function ii(n,e,t,i){const r=e.getType().runtime.bin,s=i?.delimited;return r.readMessage(e,n,s?i.no:n.uint32(),t,s),e}function ud(n,e,t){const i=e.uint32(),r=e.pos+i;let s,o;for(;e.pos<r;){const[a]=e.tag();switch(a){case 1:s=pi(e,n.K);break;case 2:switch(n.V.kind){case"scalar":o=pi(e,n.V.T);break;case"enum":o=e.int32();break;case"message":o=ii(e,new n.V.T,t,void 0);break}break}}if(s===void 0&&(s=ln(n.K,_t.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),o===void 0)switch(n.V.kind){case"scalar":o=ln(n.V.T,_t.BIGINT);break;case"enum":o=n.V.T.values[0].no;break;case"message":o=new n.V.T;break}return[s,o]}function dd(n,e){const t=pi(n,e);return typeof t=="bigint"?t.toString():t}function pi(n,e){switch(e){case A.STRING:return n.string();case A.BOOL:return n.bool();case A.DOUBLE:return n.double();case A.FLOAT:return n.float();case A.INT32:return n.int32();case A.INT64:return n.int64();case A.UINT64:return n.uint64();case A.FIXED64:return n.fixed64();case A.BYTES:return n.bytes();case A.FIXED32:return n.fixed32();case A.SFIXED32:return n.sfixed32();case A.SFIXED64:return n.sfixed64();case A.SINT64:return n.sint64();case A.UINT32:return n.uint32();case A.SINT32:return n.sint32()}}function ho(n,e,t,i){ee(e!==void 0);const r=n.repeated;switch(n.kind){case"scalar":case"enum":let s=n.kind=="enum"?A.INT32:n.T;if(r)if(ee(Array.isArray(e)),n.packed)fd(t,s,n.no,e);else for(const o of e)_n(t,s,n.no,o);else _n(t,s,n.no,e);break;case"message":if(r){ee(Array.isArray(e));for(const o of e)fo(t,i,n,o)}else fo(t,i,n,e);break;case"map":ee(typeof e=="object"&&e!=null);for(const[o,a]of Object.entries(e))hd(t,i,n,o,a);break}}function hd(n,e,t,i,r){n.tag(t.no,ne.LengthDelimited),n.fork();let s=i;switch(t.K){case A.INT32:case A.FIXED32:case A.UINT32:case A.SFIXED32:case A.SINT32:s=Number.parseInt(i);break;case A.BOOL:ee(i=="true"||i=="false"),s=i=="true";break}switch(_n(n,t.K,1,s),t.V.kind){case"scalar":_n(n,t.V.T,2,r);break;case"enum":_n(n,A.INT32,2,r);break;case"message":ee(r!==void 0),n.tag(2,ne.LengthDelimited).bytes(r.toBinary(e));break}n.join()}function fo(n,e,t,i){const r=Ya(t.T,i);t.delimited?n.tag(t.no,ne.StartGroup).raw(r.toBinary(e)).tag(t.no,ne.EndGroup):n.tag(t.no,ne.LengthDelimited).bytes(r.toBinary(e))}function _n(n,e,t,i){ee(i!==void 0);let[r,s]=Xa(e);n.tag(t,r)[s](i)}function fd(n,e,t,i){if(!i.length)return;n.tag(t,ne.LengthDelimited).fork();let[,r]=Xa(e);for(let s=0;s<i.length;s++)n[r](i[s]);n.join()}function Xa(n){let e=ne.Varint;switch(n){case A.BYTES:case A.STRING:e=ne.LengthDelimited;break;case A.DOUBLE:case A.FIXED64:case A.SFIXED64:e=ne.Bit64;break;case A.FIXED32:case A.SFIXED32:case A.FLOAT:e=ne.Bit32;break}const t=A[n].toLowerCase();return[e,t]}function pd(){return{setEnumType:Ba,initPartial(n,e){if(n===void 0)return;const t=e.getType();for(const i of t.fields.byMember()){const r=i.localName,s=e,o=n;if(o[r]!=null)switch(i.kind){case"oneof":const a=o[r].case;if(a===void 0)continue;const c=i.findField(a);let l=o[r].value;c&&c.kind=="message"&&!ct(l,c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===A.BYTES&&(l=vn(l)),s[r]={case:a,value:l};break;case"scalar":case"enum":let u=o[r];i.T===A.BYTES&&(u=i.repeated?u.map(vn):vn(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===A.BYTES)for(const[p,b]of Object.entries(o[r]))s[r][p]=vn(b);else Object.assign(s[r],o[r]);break;case"message":const h=i.V.T;for(const p of Object.keys(o[r])){let b=o[r][p];h.fieldWrapper||(b=new h(b)),s[r][p]=b}break}break;case"message":const d=i.T;if(i.repeated)s[r]=o[r].map(h=>ct(h,d)?h:new d(h));else{const h=o[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=vn(h):s[r]=h:s[r]=ct(h,d)?h:new d(h)}break}}},equals(n,e,t){return e===t?!0:!e||!t?!1:n.fields.byMember().every(i=>{const r=e[i.localName],s=t[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((o,a)=>i.T.equals(o,s[a]));case"scalar":return r.every((o,a)=>bt(i.T,o,s[a]));case"enum":return r.every((o,a)=>bt(A.INT32,o,s[a]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":let o=r,a=s;return i.T.fieldWrapper&&(o!==void 0&&!ct(o)&&(o=i.T.fieldWrapper.wrapField(o)),a!==void 0&&!ct(a)&&(a=i.T.fieldWrapper.wrapField(a))),i.T.equals(o,a);case"enum":return bt(A.INT32,r,s);case"scalar":return bt(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const c=i.findField(r.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(r.value,s.value);case"enum":return bt(A.INT32,r.value,s.value);case"scalar":return bt(c.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const l=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const u=i.V.T;return l.every(h=>u.equals(r[h],s[h]));case"enum":return l.every(h=>bt(A.INT32,r[h],s[h]));case"scalar":const d=i.V.T;return l.every(h=>bt(d,r[h],s[h]))}break}})},clone(n){const e=n.getType(),t=new e,i=t;for(const r of e.fields.byMember()){const s=n[r.localName];let o;if(r.repeated)o=s.map(zn);else if(r.kind=="map"){o=i[r.localName];for(const[a,c]of Object.entries(s))o[a]=zn(c)}else r.kind=="oneof"?o=r.findField(s.case)?{case:s.case,value:zn(s.value)}:{case:void 0}:o=zn(s);i[r.localName]=o}for(const r of e.runtime.bin.listUnknownFields(n))e.runtime.bin.onUnknownField(i,r.no,r.wireType,r.data);return t}}}function zn(n){if(n===void 0)return n;if(ct(n))return n.clone();if(n instanceof Uint8Array){const e=new Uint8Array(n.byteLength);return e.set(n),e}return n}function vn(n){return n instanceof Uint8Array?n:new Uint8Array(n)}function md(n,e,t){return{syntax:n,json:rd(),bin:ld(),util:Object.assign(Object.assign({},pd()),{newFieldList:e,initFields:t}),makeMessageType(i,r,s){return Wu(this,i,r,s)},makeEnum:qu,makeEnumType:Va,getEnumType:Vu,makeExtension(i,r,s){return Yu(this,i,r,s)}}}class gd{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const i of this.list())t[i.jsonName]=t[i.name]=i;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const i of this.list())t[i.no]=i;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())i.oneof?i.oneof!==t&&(t=i.oneof,e.push(t)):e.push(i)}return this.members}}function Za(n,e){const t=ec(n);return e?t:Td(Sd(t))}function vd(n){return Za(n,!1)}const bd=ec;function ec(n){let e=!1;const t=[];for(let i=0;i<n.length;i++){let r=n.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const yd=new Set(["constructor","toString","toJSON","valueOf"]),kd=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),tc=n=>"".concat(n,"$"),Sd=n=>kd.has(n)?tc(n):n,Td=n=>yd.has(n)?tc(n):n;class Cd{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=vd(e)}addField(e){ee(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function Ed(n,e){var t,i,r,s,o,a;const c=[];let l;for(const u of typeof n=="function"?n():n){const d=u;if(d.localName=Za(u.name,u.oneof!==void 0),d.jsonName=(t=u.jsonName)!==null&&t!==void 0?t:bd(u.name),d.repeated=(i=u.repeated)!==null&&i!==void 0?i:!1,u.kind=="scalar"&&(d.L=(r=u.L)!==null&&r!==void 0?r:_t.BIGINT),d.delimited=(s=u.delimited)!==null&&s!==void 0?s:!1,d.req=(o=u.req)!==null&&o!==void 0?o:!1,d.opt=(a=u.opt)!==null&&a!==void 0?a:!1,u.packed===void 0&&(d.packed=u.kind=="enum"||u.kind=="scalar"&&u.T!=A.BYTES&&u.T!=A.STRING),u.oneof!==void 0){const h=typeof u.oneof=="string"?u.oneof:u.oneof.name;(!l||l.name!=h)&&(l=new Cd(h)),d.oneof=l,l.addField(d)}c.push(d)}return c}const w=md("proto3",n=>new gd(n,e=>Ed(e)),n=>{for(const e of n.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,i=n;if(e.repeated){i[t]=[];continue}switch(e.kind){case"oneof":i[t]={case:void 0};break;case"enum":i[t]=0;break;case"map":i[t]={};break;case"scalar":i[t]=ln(e.T,e.L);break}}});class Ee extends as{constructor(e){super(),this.seconds=X.zero,this.nanos=0,w.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(w.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=X.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Ee.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Ee({seconds:X.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Ee().fromBinary(e,t)}static fromJson(e,t){return new Ee().fromJson(e,t)}static fromJsonString(e,t){return new Ee().fromJsonString(e,t)}static equals(e,t){return w.util.equals(Ee,e,t)}}Ee.runtime=w;Ee.typeName="google.protobuf.Timestamp";Ee.fields=w.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const wd=w.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ee},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:Pd,repeated:!0},{no:5,name:"events",kind:"message",T:_d,repeated:!0}]),Pd=w.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Rd,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),Rd=w.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Ee},{no:3,name:"value",kind:"scalar",T:2}]),_d=w.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Ee},{no:7,name:"normalized_end_timestamp",kind:"message",T:Ee,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),nc=w.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),Ne=w.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),ie=w.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),ls=w.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),wn=w.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),xn=w.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Be=w.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),Lt=w.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),Id=w.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),ue=w.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Ai=w.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:mi,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:mc}]),mi=w.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),Od=w.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:w.getEnumType(ie),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),jt=w.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:w.getEnumType(en)},{no:4,name:"tracks",kind:"message",T:Yt,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Od},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:w.getEnumType(Mn)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:w.getEnumType(Be)},{no:18,name:"kind_details",kind:"enum",T:w.getEnumType(xd),repeated:!0}]),en=w.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),Mn=w.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),xd=w.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),ae=w.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),Md=w.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Et,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:w.getEnumType(ic)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),Yt=w.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:w.getEnumType(Ne)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:w.getEnumType(ie)},{no:10,name:"layers",kind:"message",T:Et,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:Md,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:w.getEnumType(ae)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:mc},{no:19,name:"audio_features",kind:"enum",T:w.getEnumType(ue),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:w.getEnumType(nc)}]),Et=w.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:w.getEnumType(ls)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),ic=w.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),be=w.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:w.getEnumType(V)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:us,oneof:"value"},{no:3,name:"speaker",kind:"message",T:Dd,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:ac,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Ad,oneof:"value"},{no:8,name:"metrics",kind:"message",T:wd,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:gi,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:ds,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:hs,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:fs,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:vi,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:bi,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:yi,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:rc,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),V=w.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),rc=w.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:w.getEnumType(ae)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),sc=w.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:us,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:gi,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:ds,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:hs,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:fs,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:vi,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:bi,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:yi,oneof:"value"}]),Dd=w.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:oc,repeated:!0}]),oc=w.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),us=w.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),ac=w.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Ad=w.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:Ld,repeated:!0}]),Ld=w.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),gi=w.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),ds=w.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),hs=w.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),fs=w.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:cc,oneof:"value"}]),cc=w.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),lc=w.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),uc=w.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:w.getEnumType(dc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),dc=w.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),hc=w.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:w.getEnumType(fc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),fc=w.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),pc=w.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:po},{no:2,name:"screen",kind:"message",T:po},{no:3,name:"resume_connection",kind:"enum",T:w.getEnumType(xn)},{no:4,name:"disabled_codecs",kind:"message",T:Nd},{no:5,name:"force_relay",kind:"enum",T:w.getEnumType(xn)}]),po=w.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:w.getEnumType(xn)}]),Nd=w.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:mi,repeated:!0},{no:2,name:"publish",kind:"message",T:mi,repeated:!0}]),mc=w.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),Pr=w.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),gc=w.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:w.getEnumType(Pr)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),vc=w.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),vi=w.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:w.getEnumType(ae)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:gc,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:vc,oneof:"content_header"}],{localName:"DataStream_Header"}),bi=w.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),yi=w.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),Ud=w.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Ue=w.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Rr=w.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Fd=w.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),jd=w.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:It,oneof:"message"},{no:2,name:"answer",kind:"message",T:It,oneof:"message"},{no:3,name:"trickle",kind:"message",T:Li,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Dn,oneof:"message"},{no:5,name:"mute",kind:"message",T:Ni,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Ui,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:bc,oneof:"message"},{no:8,name:"leave",kind:"message",T:Fi,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:kc,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:Cc,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:bs,oneof:"message"},{no:13,name:"simulate",kind:"message",T:$e,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:gs,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Pc,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:ms,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:yc,oneof:"message"}]),mo=w.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:Bd,oneof:"message"},{no:2,name:"answer",kind:"message",T:It,oneof:"message"},{no:3,name:"offer",kind:"message",T:It,oneof:"message"},{no:4,name:"trickle",kind:"message",T:Li,oneof:"message"},{no:5,name:"update",kind:"message",T:Wd,oneof:"message"},{no:6,name:"track_published",kind:"message",T:ps,oneof:"message"},{no:8,name:"leave",kind:"message",T:Fi,oneof:"message"},{no:9,name:"mute",kind:"message",T:Ni,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Hd,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Kd,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Gd,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:$d,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Yd,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:Zd,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:qd,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Vd,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:th,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:rh,oneof:"message"},{no:22,name:"request_response",kind:"message",T:sh,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:oh,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:eh,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:uh,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:Xd,oneof:"message"}]),_r=w.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Et,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:w.getEnumType(ic)}]),Dn=w.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:w.getEnumType(Ne)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:w.getEnumType(ie)},{no:9,name:"layers",kind:"message",T:Et,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:_r,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:w.getEnumType(ae)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:w.getEnumType(nc)},{no:17,name:"audio_features",kind:"enum",T:w.getEnumType(ue),repeated:!0}]),Li=w.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:w.getEnumType(Ue)},{no:3,name:"final",kind:"scalar",T:8}]),Ni=w.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),Bd=w.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Ai},{no:2,name:"participant",kind:"message",T:jt},{no:3,name:"other_participants",kind:"message",T:jt,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:Sc,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:pc},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:uc},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:mi,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Vd=w.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:Sc,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:pc},{no:3,name:"server_info",kind:"message",T:uc},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),ps=w.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Yt}]),qd=w.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),It=w.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),Wd=w.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:jt,repeated:!0}]),Ui=w.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:lc,repeated:!0}]),bc=w.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:w.getEnumType(ls)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),ms=w.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:w.getEnumType(ue),repeated:!0}]),yc=w.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Fi=w.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:w.getEnumType(Be)},{no:3,name:"action",kind:"enum",T:w.getEnumType(tn)},{no:4,name:"regions",kind:"message",T:nh}]),tn=w.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),kc=w.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:Et,repeated:!0}]),gs=w.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),Sc=w.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),Hd=w.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:oc,repeated:!0}]),Kd=w.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Ai}]),zd=w.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:w.getEnumType(wn)},{no:3,name:"score",kind:"scalar",T:2}]),Gd=w.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:zd,repeated:!0}]),Jd=w.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:w.getEnumType(Rr)}]),$d=w.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:Jd,repeated:!0}]),vs=w.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:w.getEnumType(ls)},{no:2,name:"enabled",kind:"scalar",T:8}]),Qd=w.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:vs,repeated:!0}]),Yd=w.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:vs,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:Qd,repeated:!0}]),Xd=w.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:Ud,repeated:!0}]),Tc=w.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),Cc=w.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Tc,repeated:!0}]),Zd=w.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),eh=w.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Ai},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:jt},{no:4,name:"other_participants",kind:"message",T:jt,repeated:!0}]),bs=w.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:It},{no:2,name:"subscription",kind:"message",T:Ui},{no:3,name:"publish_tracks",kind:"message",T:ps,repeated:!0},{no:4,name:"data_channels",kind:"message",T:wc,repeated:!0},{no:5,name:"offer",kind:"message",T:It},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:Ec,repeated:!0}]),Ec=w.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),wc=w.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:w.getEnumType(Ue)}]),$e=w.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:w.getEnumType(Fd),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Pc=w.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),th=w.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),nh=w.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:ih,repeated:!0}]),ih=w.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),rh=w.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:w.getEnumType(Id)}]),sh=w.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:w.getEnumType(ys)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:Li,oneof:"request"},{no:5,name:"add_track",kind:"message",T:Dn,oneof:"request"},{no:6,name:"mute",kind:"message",T:Ni,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:gs,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:ms,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:yc,oneof:"request"}]),ys=w.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),oh=w.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Rc=w.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),ah=w.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:hc},{no:2,name:"connection_settings",kind:"message",T:Rc},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:Dn,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:It},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:w.getEnumType(Lt)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:bs}]),ch=w.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:w.getEnumType(lh)},{no:2,name:"join_request",kind:"scalar",T:12}]),lh=w.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),uh=w.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function dh(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ri={exports:{}},hh=ri.exports,go;function fh(){return go||(go=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(hh,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,T){var S=m[T];if(typeof S.bind=="function")return S.bind(m);try{return Function.prototype.bind.call(S,m)}catch{return function(){return Function.prototype.apply.apply(S,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var S=r[T];this[S]=T<m?e:this.methodFactory(S,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,S){return l(m)||d.apply(this,arguments)}function p(m,T){var S=this,P,_,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var U=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=U;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+U+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var U=window.document.cookie,z=encodeURIComponent(g),Q=U.indexOf(z+"=");Q!==-1&&(D=/^([^;]+)/.exec(U.slice(Q+z.length+1))[1])}catch{}return S.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function R(D){var U=D;if(typeof U=="string"&&S.levels[U.toUpperCase()]!==void 0&&(U=S.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=S.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+D)}S.name=m,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=T||h,S.getLevel=function(){return v??_??P},S.setLevel=function(D,U){return v=R(D),U!==!1&&y(v),u.call(S)},S.setDefaultLevel=function(D){_=R(D),C()||S.setLevel(D,!1)},S.resetLevel=function(){v=null,x(),u.call(S)},S.enableAll=function(D){S.setLevel(S.levels.TRACE,D)},S.disableAll=function(D){S.setLevel(S.levels.SILENT,D)},S.rebuild=function(){if(o!==S&&(P=R(o.getLevel())),u.call(S),o===S)for(var D in s)s[D].rebuild()},P=R(o?o.getLevel():"WARN");var O=C();O!=null&&(v=R(O)),u.call(S)}o=new p,o.getLogger=function(T){if(typeof T!="symbol"&&typeof T!="string"||T==="")throw new TypeError("You must supply a name when creating a logger.");var S=s[T];return S||(S=s[T]=new p(T,o.methodFactory)),S};var b=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=b),o},o.getLoggers=function(){return s},o.default=o,o})})(ri)),ri.exports}var ji=fh(),Ir;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(Ir||(Ir={}));var Ve;(function(n){n.Default="livekit",n.Room="livekit-room",n.TokenSource="livekit-token-source",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(Ve||(Ve={}));let j=ji.getLogger("livekit");const ph=Object.values(Ve).map(n=>ji.getLogger(n));j.setDefaultLevel(Ir.info);function dt(n){const e=ji.getLogger(n);return e.setDefaultLevel(j.getLevel()),e}function ay(n,e){for(const t of ph)t.setLevel(n)}const mh=ji.getLogger("lk-e2ee"),bn=7e3,gh=[0,300,4*300,9*300,16*300,bn,bn,bn,bn,bn];class vh{constructor(e){this._retryDelays=e!==void 0?[...e]:gh}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function bh(n,e){var t={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(n);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(n,i[r])&&(t[i[r]]=n[i[r]]);return t}function k(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,e||[])).next())})}function vo(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function lt(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof vo=="function"?vo(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}var Gn={exports:{}},bo;function yh(){if(bo)return Gn.exports;bo=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(g,y,C){return Function.prototype.apply.call(g,y,C)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:t=function(g){return Object.getOwnPropertyNames(g)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(g){return g!==g};function s(){s.init.call(this)}Gn.exports=s,Gn.exports.once=S,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");o=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(g){if(typeof g!="number"||g<0||r(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(g){for(var y=[],C=1;C<arguments.length;C++)y.push(arguments[C]);var x=g==="error",R=this._events;if(R!==void 0)x=x&&R.error===void 0;else if(!x)return!1;if(x){var O;if(y.length>0&&(O=y[0]),O instanceof Error)throw O;var D=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw D.context=O,D}var U=R[g];if(U===void 0)return!1;if(typeof U=="function")e(U,this,y);else for(var z=U.length,Q=b(U,z),C=0;C<z;++C)e(Q[C],this,y);return!0};function l(v,g,y,C){var x,R,O;if(a(y),R=v._events,R===void 0?(R=v._events=Object.create(null),v._eventsCount=0):(R.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),R=v._events),O=R[g]),O===void 0)O=R[g]=y,++v._eventsCount;else if(typeof O=="function"?O=R[g]=C?[y,O]:[O,y]:C?O.unshift(y):O.push(y),x=c(v),x>0&&O.length>x&&!O.warned){O.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=O.length,i(D)}return v}s.prototype.addListener=function(g,y){return l(this,g,y,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(g,y){return l(this,g,y,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(g,y){return a(y),this.on(g,d(this,g,y)),this},s.prototype.prependOnceListener=function(g,y){return a(y),this.prependListener(g,d(this,g,y)),this},s.prototype.removeListener=function(g,y){var C,x,R,O,D;if(a(y),x=this._events,x===void 0)return this;if(C=x[g],C===void 0)return this;if(C===y||C.listener===y)--this._eventsCount===0?this._events=Object.create(null):(delete x[g],x.removeListener&&this.emit("removeListener",g,C.listener||y));else if(typeof C!="function"){for(R=-1,O=C.length-1;O>=0;O--)if(C[O]===y||C[O].listener===y){D=C[O].listener,R=O;break}if(R<0)return this;R===0?C.shift():m(C,R),C.length===1&&(x[g]=C[0]),x.removeListener!==void 0&&this.emit("removeListener",g,D||y)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(g){var y,C,x;if(C=this._events,C===void 0)return this;if(C.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):C[g]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete C[g]),this;if(arguments.length===0){var R=Object.keys(C),O;for(x=0;x<R.length;++x)O=R[x],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(y=C[g],typeof y=="function")this.removeListener(g,y);else if(y!==void 0)for(x=y.length-1;x>=0;x--)this.removeListener(g,y[x]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(g){return h(this,g,!0)},s.prototype.rawListeners=function(g){return h(this,g,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function S(v,g){return new Promise(function(y,C){function x(O){v.removeListener(g,R),C(O)}function R(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}_(v,g,R,{once:!0}),g!=="error"&&P(v,x,{once:!0})})}function P(v,g,y){typeof v.on=="function"&&_(v,"error",g,y)}function _(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(R){C.once&&v.removeEventListener(g,x),y(R)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return Gn.exports}var tt=yh();let _c=!0,Ic=!0;function Pn(n,e,t){const i=n.match(e);return i&&i.length>=t&&parseFloat(i[t],10)}function Kt(n,e,t){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=l=>{const u=t(l);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function kh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(_c=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Sh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Ic=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Oc(){if(typeof window=="object"){if(_c)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function ks(n,e){Ic&&console.warn(n+" is deprecated, please use "+e+" instead.")}function Th(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const i=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(i)return{browser:"chrome",version:parseInt(i.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(Pn(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(Pn(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(Pn(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype,e._safariVersion=Pn(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function yo(n){return Object.prototype.toString.call(n)==="[object Object]"}function xc(n){return yo(n)?Object.keys(n).reduce(function(e,t){const i=yo(n[t]),r=i?xc(n[t]):n[t],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[t]:r})},{}):n}function Or(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Or(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{Or(n,n.get(r),t)})}))}function ko(n,e,t){const i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return n.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)}),s.forEach(o=>{n.forEach(a=>{a.type===i&&a.trackId===o.id&&Or(n,a,r)})}),r}const So=Oc;function Mc(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const i=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof a[l]=="object"?a[l]:{ideal:a[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(u.ideal!==void 0){c.optional=c.optional||[];let h={};typeof u.ideal=="number"?(h[d("min",l)]=u.ideal,c.optional.push(h),h={},h[d("max",l)]=u.ideal,c.optional.push(h)):(h[d("",l)]=u.ideal,c.optional.push(h))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(h=>{u[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(h,l)]=u[h])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},r=function(a,c){if(e.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const l=function(u,d,h){d in u&&!(h in u)&&(u[h]=u[d],delete u[d])};a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=i(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete a.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return t.mediaDevices.enumerateDevices().then(h=>{h=h.filter(b=>b.kind==="videoinput");let p=h.find(b=>d.some(m=>b.label.toLowerCase().includes(m)));return!p&&h.length&&d.includes("back")&&(p=h[h.length-1]),p&&(a.video.deviceId=l.exact?{exact:p.deviceId}:{ideal:p.deviceId}),a.video=i(a.video),So("chrome: "+JSON.stringify(a)),c(a)})}a.video=i(a.video)}return So("chrome: "+JSON.stringify(a)),c(a)},s=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(a,c,l){r(a,u=>{t.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(t.getUserMedia=o.bind(t),t.mediaDevices.getUserMedia){const a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return r(c,l=>a(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function Dc(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function Ac(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):s={track:r.track};const o=new Event("track");o.track=r.track,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.id):s={track:r};const o=new Event("track");o.track=r,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Kt(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Lc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,c){let l=r.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){s.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],t.apply(this,[s]),s.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(o=>{const a=this._senders.find(c=>c.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Nc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(o=>o._pc=this),s});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(o=>ko(o,s.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Kt(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>ko(s,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const i=arguments[0];let r,s,o;return this.getSenders().forEach(a=>{a.track===i&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(s?o=!0:s=a),a.track===i)),o||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Uc(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(o);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),r.apply(this,arguments)}}function Fc(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Uc(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(p=>p.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new n.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const b=this._streams[d.id];if(b)b.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new n.MediaStream([u]);this._streams[d.id]=m,this._reverseStreams[m.id]=d,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(b.id,"g"),p.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function o(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(p.id,"g"),b.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],d={[l](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[b=>{const m=s(this,b);h[0].apply(null,[m])},b=>{h[1]&&h[1].apply(null,b)},arguments[2]]):u.apply(this,arguments).then(b=>s(this,b))}};n.RTCPeerConnection.prototype[l]=d[l]});const a=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(m=>u.track===m)&&(h=this._streams[p])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function xr(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function jc(n,e){Kt(n,"negotiationneeded",t=>{const i=t.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return t})}var To=Object.freeze({__proto__:null,fixNegotiationNeeded:jc,shimAddTrackRemoveTrack:Fc,shimAddTrackRemoveTrackWithNative:Uc,shimGetSendersWithDtmf:Lc,shimGetUserMedia:Mc,shimMediaStream:Dc,shimOnTrack:Ac,shimPeerConnection:xr,shimSenderReceiverGetStats:Nc});function Bc(n,e){const t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,s,o){ks("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function Ch(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(i)})}function Vc(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Mr(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=o[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[s,o,a]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!o)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(o,a)}}function qc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Wc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Kt(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Hc(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){ks("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Kc(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function zc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:o}=s,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return s})}function Gc(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Jc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function $c(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var Co=Object.freeze({__proto__:null,shimAddTransceiver:zc,shimCreateAnswer:$c,shimCreateOffer:Jc,shimGetDisplayMedia:Ch,shimGetParameters:Gc,shimGetUserMedia:Bc,shimOnTrack:Vc,shimPeerConnection:Mr,shimRTCDataChannel:Kc,shimReceiverGetStats:Wc,shimRemoveStream:Hc,shimSenderGetStats:qc});function Qc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},n.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];return s&&s.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function Yc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const o=new Event("addstream");o.stream=s,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function Xc(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=t.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h};let a=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=a,a=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=a,a=function(c,l,u){const d=o.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=a}function Zc(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(el(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function el(n){return n&&n.video!==void 0?Object.assign({},n,{video:xc(n.video)}):n}function tl(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let o=0;o<i.iceServers.length;o++){let a=i.iceServers[o];a.urls===void 0&&a.url?(ks("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,s.push(a)):s.push(i.iceServers[o])}i.iceServers=s}return new e(i,r)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function nl(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function il(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function rl(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var Eo=Object.freeze({__proto__:null,shimAudioContext:rl,shimCallbacksAPI:Xc,shimConstraints:el,shimCreateOfferLegacy:il,shimGetUserMedia:Zc,shimLocalStreamsAPI:Qc,shimRTCIceServerUrls:tl,shimRemoteStreamsAPI:Yc,shimTrackEventTransceiver:nl}),ir={exports:{}},wo;function Eh(){return wo||(wo=1,(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;t.indexOf("a=candidate:")===0?i=t.substring(12).split(" "):i=t.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(t){const i=[];i.push(t.foundation);const r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);const s=t.type;return i.push("typ"),i.push(s),s!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const i={};let r;const s=t.substring(t.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(o=>{t.parameters[o]!==void 0?s.push(o+"="+t.parameters[o]):s.push(o)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){const i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){const i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},s=t.indexOf(":",i);return s>-1?(r.attribute=t.substring(i+1,s),r.value=t.substring(s+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){const i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(t){const i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(t)[0].split(" ");i.profile=s[2];for(let a=3;a<s.length;a++){const c=s[a],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(a=>{i.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(a=>{o.forEach(c=>{a.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let s=0;return i.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(t){const i=[],r=e.parseRtpParameters(t),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(t,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(b=>parseInt(b,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&l&&(p.rtx={ssrc:l}),i.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(t,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-2e3*8:d=void 0,i.forEach(h=>{h.maxBitrate=d})),i},e.parseRtcpParameters=function(t){const i={},r=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=e.matchPrefix(t,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(t){const i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,i){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let s;const o=i!==void 0?i:2;return t?s=t:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){const r=e.splitLines(t);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(ir)),ir.exports}var sl=Eh(),nn=dh(sl),wh=Du({__proto__:null,default:nn},[sl]);function si(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=nn.parseCandidate(i.candidate);for(const o in s)o in r||Object.defineProperty(r,o,{value:s[o]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},n.RTCIceCandidate.prototype=e.prototype,Kt(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Dr(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Kt(n,"icecandidate",e=>{if(e.candidate){const t=nn.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function oi(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(a){if(!a||!a.sdp)return!1;const c=nn.splitSections(a.sdp);return c.shift(),c.some(l=>{const u=nn.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(a){let c=65536;return e.browser==="firefox"&&(e.version<57?a===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(a,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=nn.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},o=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return d}}),this._sctp=h}return o.apply(this,arguments)}}function ai(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},Kt(n,"datachannel",i=>(e(i.channel,i.target),i))}function Ar(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Lr(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return t.apply(this,arguments)}}function ci(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function li(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>t.apply(this,[o]))})}var Ph=Object.freeze({__proto__:null,removeExtmapAllowMixed:Lr,shimAddIceCandidateNullOrEmpty:ci,shimConnectionState:Ar,shimMaxMessageSize:oi,shimParameterlessSetLocalDescription:li,shimRTCIceCandidate:si,shimRTCIceCandidateRelayProtocol:Dr,shimSendThrowTypeError:ai});function Rh(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=Oc,i=Th(n),r={browserDetails:i,commonShim:Ph,extractVersion:Pn,disableLog:kh,disableWarnings:Sh,sdp:wh};switch(i.browser){case"chrome":if(!To||!xr||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=To,ci(n,i),li(n),Mc(n,i),Dc(n),xr(n,i),Ac(n),Fc(n,i),Lc(n),Nc(n),jc(n,i),si(n),Dr(n),Ar(n),oi(n,i),ai(n),Lr(n,i);break;case"firefox":if(!Co||!Mr||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=Co,ci(n,i),li(n),Bc(n,i),Mr(n,i),Vc(n),Hc(n),qc(n),Wc(n),Kc(n),zc(n),Gc(n),Jc(n),$c(n),si(n),Ar(n),oi(n,i),ai(n);break;case"safari":if(!Eo||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=Eo,ci(n,i),li(n),tl(n),il(n),Xc(n),Qc(n),Yc(n),nl(n),Zc(n),rl(n),si(n),Dr(n),oi(n,i),ai(n),Lr(n,i);break;default:t("Unsupported browser!");break}return r}Rh({window:typeof window>"u"?void 0:window});const _h=/version\/(\d+(\.?_?\d+)+)/i;let rr;function ke(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if(rr===void 0||e){const i=Ih.find(r=>{let{test:s}=r;return s.test(t)});rr=i?.describe(t)}return rr}const Ih=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:ui(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:sr(n)}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:ui(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0,osVersion:sr(n)}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:ui(_h,n),os:n.includes("mobile/")?"iOS":"macOS",osVersion:sr(n)}}}];function ui(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(n);return i&&i.length>=t&&i[t]||""}function sr(n){return n.includes("mac os")?ui(/\(.+?(\d+_\d+(:?_\d+)?)/,n,1).replace(/_/g,"."):void 0}var Oh="2.16.1";const xh=Oh,Mh=16;class nt extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}var Y;(function(n){n[n.NotAllowed=0]="NotAllowed",n[n.ServerUnreachable=1]="ServerUnreachable",n[n.InternalError=2]="InternalError",n[n.Cancelled=3]="Cancelled",n[n.LeaveRequest=4]="LeaveRequest",n[n.Timeout=5]="Timeout",n[n.WebSocket=6]="WebSocket"})(Y||(Y={}));class F extends nt{constructor(e,t,i,r){super(1,e),this.name="ConnectionError",this.status=i,this.reason=t,this.context=r,this.reasonName=Y[t]}static notAllowed(e,t,i){return new F(e,Y.NotAllowed,t,i)}static timeout(e){return new F(e,Y.Timeout)}static leaveRequest(e,t){return new F(e,Y.LeaveRequest,void 0,t)}static internal(e,t){return new F(e,Y.InternalError,void 0,t)}static cancelled(e){return new F(e,Y.Cancelled)}static serverUnreachable(e,t){return new F(e,Y.ServerUnreachable,t)}static websocket(e,t,i){return new F(e,Y.WebSocket,t,i)}}class Ss extends nt{constructor(e){super(21,e??"device is unsupported"),this.name="DeviceUnsupportedError"}}class ut extends nt{constructor(e){super(20,e??"track is invalid"),this.name="TrackInvalidError"}}class Dh extends nt{constructor(e){super(10,e??"unsupported server"),this.name="UnsupportedServer"}}class oe extends nt{constructor(e){super(12,e??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class Nr extends nt{constructor(e){super(13,e??"unable to negotiate"),this.name="NegotiationError"}}class Po extends nt{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Ro extends nt{constructor(e,t){super(15,e),this.name="SignalRequestError",this.reason=t,this.reasonName=typeof t=="string"?t:ys[t]}}var ve;(function(n){n[n.AlreadyOpened=0]="AlreadyOpened",n[n.AbnormalEnd=1]="AbnormalEnd",n[n.DecodeFailed=2]="DecodeFailed",n[n.LengthExceeded=3]="LengthExceeded",n[n.Incomplete=4]="Incomplete",n[n.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",n[n.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(ve||(ve={}));class Me extends nt{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=ve[t]}}class Qt extends nt{constructor(e){super(18,e),this.name="SignalReconnectError"}}var An;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(An||(An={}));(function(n){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?n.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?n.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=e})(An||(An={}));class fe{}fe.setTimeout=function(){return setTimeout(...arguments)};fe.setInterval=function(){return setInterval(...arguments)};fe.clearTimeout=function(){return clearTimeout(...arguments)};fe.clearInterval=function(){return clearInterval(...arguments)};var I;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.Moved="moved",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.ParticipantAttributesChanged="participantAttributesChanged",n.ParticipantActive="participantActive",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged",n.ChatMessage="chatMessage",n.LocalTrackSubscribed="localTrackSubscribed",n.MetricsReceived="metricsReceived"})(I||(I={}));var M;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackCpuConstrained="localTrackCpuConstrained",n.LocalSenderCreated="localSenderCreated",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.TrackCpuConstrained="trackCpuConstrained",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded",n.AttributesChanged="attributesChanged",n.LocalTrackSubscribed="localTrackSubscribed",n.ChatMessage="chatMessage",n.Active="active"})(M||(M={}));var N;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackSubscribed="localTrackSubscribed",n.Offline="offline",n.SignalRequestResponse="signalRequestResponse",n.SignalConnected="signalConnected",n.RoomMoved="roomMoved"})(N||(N={}));var L;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.CpuConstrained="cpuConstrained",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed",n.TrackProcessorUpdate="trackProcessorUpdate",n.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",n.TranscriptionReceived="transcriptionReceived",n.TimeSyncUpdate="timeSyncUpdate",n.PreConnectBufferFlushed="preConnectBufferFlushed"})(L||(L={}));function Ah(n){return typeof n>"u"?n:typeof structuredClone=="function"?typeof n=="object"&&n!==null?structuredClone(Object.assign({},n)):structuredClone(n):JSON.parse(JSON.stringify(n))}class G{constructor(e,t,i,r,s){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&i!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:i,maxFramerate:r,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Lh=["vp8","h264"],Nh=["vp8","h264","vp9","av1","h265"];function Uh(n){return!!Lh.find(e=>e===n)}const Fh=Uh;var _o;(function(n){n[n.PREFER_REGRESSION=0]="PREFER_REGRESSION",n[n.SIMULCAST=1]="SIMULCAST",n[n.REGRESSION=2]="REGRESSION"})(_o||(_o={}));var Ur;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:24e3},n.music={maxBitrate:48e3},n.musicStereo={maxBitrate:64e3},n.musicHighQuality={maxBitrate:96e3},n.musicHighQualityStereo={maxBitrate:128e3}})(Ur||(Ur={}));const Ln={h90:new G(160,90,9e4,20),h180:new G(320,180,16e4,20),h216:new G(384,216,18e4,20),h360:new G(640,360,45e4,20),h540:new G(960,540,8e5,25),h720:new G(1280,720,17e5,30),h1080:new G(1920,1080,3e6,30),h1440:new G(2560,1440,5e6,30),h2160:new G(3840,2160,8e6,30)},Fr={h120:new G(160,120,7e4,20),h180:new G(240,180,125e3,20),h240:new G(320,240,14e4,20),h360:new G(480,360,33e4,20),h480:new G(640,480,5e5,20),h540:new G(720,540,6e5,25),h720:new G(960,720,13e5,30),h1080:new G(1440,1080,23e5,30),h1440:new G(1920,1440,38e5,30)},Ts={h360fps3:new G(640,360,2e5,3,"medium"),h360fps15:new G(640,360,4e5,15,"medium"),h720fps5:new G(1280,720,8e5,5,"medium"),h720fps15:new G(1280,720,15e5,15,"medium"),h720fps30:new G(1280,720,2e6,30,"medium"),h1080fps15:new G(1920,1080,25e5,15,"medium"),h1080fps30:new G(1920,1080,5e6,30,"medium"),original:new G(0,0,7e6,30,"medium")};function ol(n,e,t){var i,r,s,o;const{optionsWithoutProcessor:a,audioProcessor:c,videoProcessor:l}=ll(n??{}),u=e?.processor,d=t?.processor,h=a??{};return h.audio===!0&&(h.audio={}),h.video===!0&&(h.video={}),h.audio&&(jr(h.audio,e),(i=(s=h.audio).deviceId)!==null&&i!==void 0||(s.deviceId={ideal:"default"}),(c||u)&&(h.audio.processor=c??u)),h.video&&(jr(h.video,t),(r=(o=h.video).deviceId)!==null&&r!==void 0||(o.deviceId={ideal:"default"}),(l||d)&&(h.video.processor=l??d)),h}function jr(n,e){return Object.keys(e).forEach(t=>{n[t]===void 0&&(n[t]=e[t])}),n}function Cs(n){var e,t,i,r;const s={};if(n.video)if(typeof n.video=="object"){const o={},a=o,c=n.video;Object.keys(c).forEach(l=>{switch(l){case"resolution":jr(a,c.resolution);break;default:a[l]=c[l]}}),s.video=o,(e=(i=s.video).deviceId)!==null&&e!==void 0||(i.deviceId={ideal:"default"})}else s.video=n.video?{deviceId:{ideal:"default"}}:!1;else s.video=!1;return n.audio?typeof n.audio=="object"?(s.audio=n.audio,(t=(r=s.audio).deviceId)!==null&&t!==void 0||(r.deviceId={ideal:"default"})):s.audio={deviceId:{ideal:"default"}}:s.audio=!1,s}function al(n){return k(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const i=cl();if(i){const r=i.createAnalyser();r.fftSize=2048;const s=r.frequencyBinCount,o=new Uint8Array(s);i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield pe(t),r.getByteTimeDomainData(o);const c=o.some(l=>l!==128&&l!==0);return i.close(),!c}return!1})()})}function cl(){var n;const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e){const t=new e({latencyHint:"interactive"});if(t.state==="suspended"&&typeof window<"u"&&(!((n=window.document)===null||n===void 0)&&n.body)){const i=()=>k(this,void 0,void 0,function*(){var r;try{t.state==="suspended"&&(yield t.resume())}catch(s){console.warn("Error trying to auto-resume audio context",s)}finally{(r=window.document.body)===null||r===void 0||r.removeEventListener("click",i)}});t.addEventListener("statechange",()=>{var r;t.state==="closed"&&((r=window.document.body)===null||r===void 0||r.removeEventListener("click",i))}),window.document.body.addEventListener("click",i)}return t}}function jh(n){return n==="audioinput"?E.Source.Microphone:n==="videoinput"?E.Source.Camera:E.Source.Unknown}function Br(n){return n===E.Source.Microphone?"audioinput":n===E.Source.Camera?"videoinput":void 0}function Bh(n){var e,t;let i=(e=n.video)!==null&&e!==void 0?e:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(i=typeof i=="boolean"?{}:i,Vt()?i=Object.assign(Object.assign({},i),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(t=n.audio)!==null&&t!==void 0?t:!1,video:i,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio,preferCurrentTab:n.preferCurrentTab}}function In(n){return n.split("/")[1].toLowerCase()}function Vh(n){const e=[];return n.forEach(t=>{t.track!==void 0&&e.push(new ps({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function q(n){return"mediaStreamTrack"in n?{trackID:n.sid,source:n.source,muted:n.isMuted,enabled:n.mediaStreamTrack.enabled,kind:n.kind,streamID:n.mediaStreamID,streamTrackID:n.mediaStreamTrack.id}:{trackID:n.trackSid,enabled:n.isEnabled,muted:n.isMuted,trackInfo:Object.assign({mimeType:n.mimeType,name:n.trackName,encrypted:n.isEncrypted,kind:n.kind,source:n.source},n.track?q(n.track):{})}}function qh(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function Wh(n,e){var t;n===void 0&&(n={}),e===void 0&&(e={});const i=[...Object.keys(e),...Object.keys(n)],r={};for(const s of i)n[s]!==e[s]&&(r[s]=(t=e[s])!==null&&t!==void 0?t:"");return r}function ll(n){const e=Object.assign({},n);let t,i;return typeof e.audio=="object"&&e.audio.processor&&(t=e.audio.processor,e.audio=Object.assign(Object.assign({},e.audio),{processor:void 0})),typeof e.video=="object"&&e.video.processor&&(i=e.video.processor,e.video=Object.assign(Object.assign({},e.video),{processor:void 0})),{audioProcessor:t,videoProcessor:i,optionsWithoutProcessor:Ah(e)}}function Hh(n){switch(n){case ie.CAMERA:return E.Source.Camera;case ie.MICROPHONE:return E.Source.Microphone;case ie.SCREEN_SHARE:return E.Source.ScreenShare;case ie.SCREEN_SHARE_AUDIO:return E.Source.ScreenShareAudio;default:return E.Source.Unknown}}function Io(n,e){return n.width*n.height<e.width*e.height}function Kh(n,e){var t;return(t=n.layers)===null||t===void 0?void 0:t.find(i=>i.quality===e)}const zh=5e3,yn=[];var _e;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH"})(_e||(_e={}));class E extends tt.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=E.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=j,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),zh):this.handleAppVisibilityChanged()},this.log=dt((r=i.loggerName)!==null&&r!==void 0?r:Ve.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=E.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),q(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===E.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===E.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(yn.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&yn.splice(yn.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),Xt(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?L.AudioPlaybackStarted:L.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?L.AudioPlaybackFailed:L.VideoPlaybackFailed,s):s.name==="AbortError"?j.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):j.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(o=>o.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(L.ElementAttached,e),e}detach(e){try{if(e){rn(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(L.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(i=>{rn(this.mediaStreamTrack,i),t.push(i),this.recycleElement(i),this.emit(L.ElementDetached,i)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=dt(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),yn.forEach(i=>{i.parentElement||(t=!1)}),t&&yn.push(e)}}handleAppVisibilityChanged(){return k(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===E.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){we()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){we()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Xt(n,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let i;n.kind==="audio"?i=t.getAudioTracks():i=t.getVideoTracks(),i.includes(n)||(i.forEach(r=>{t.removeTrack(r)}),t.addTrack(n)),(!Vt()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(Vt()||Bt())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function rn(n,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(n),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(n){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=n.Kind||(n.Kind={}));let t;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(t=n.Source||(n.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=n.StreamState||(n.StreamState={}));function r(l){switch(l){case e.Audio:return Ne.AUDIO;case e.Video:return Ne.VIDEO;default:return Ne.DATA}}n.kindToProto=r;function s(l){switch(l){case Ne.AUDIO:return e.Audio;case Ne.VIDEO:return e.Video;default:return e.Unknown}}n.kindFromProto=s;function o(l){switch(l){case t.Camera:return ie.CAMERA;case t.Microphone:return ie.MICROPHONE;case t.ScreenShare:return ie.SCREEN_SHARE;case t.ScreenShareAudio:return ie.SCREEN_SHARE_AUDIO;default:return ie.UNKNOWN}}n.sourceToProto=o;function a(l){switch(l){case ie.CAMERA:return t.Camera;case ie.MICROPHONE:return t.Microphone;case ie.SCREEN_SHARE:return t.ScreenShare;case ie.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}n.sourceFromProto=a;function c(l){switch(l){case Rr.ACTIVE:return i.Active;case Rr.PAUSED:return i.Paused;default:return i.Unknown}}n.streamStateFromProto=c})(E||(E={}));const Gh="|",Oo="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Jh(n){const e=n.split(Gh);return e.length>1?[e[0],n.substr(e[0].length+1)]:[n,""]}function pe(n){return k(this,void 0,void 0,function*(){return new Promise(e=>fe.setTimeout(e,n))})}function Vr(){return"addTransceiver"in RTCPeerConnection.prototype}function qr(){return"addTrack"in RTCPeerConnection.prototype}function $h(){if(!("getCapabilities"in RTCRtpSender)||Vt()||Bt())return!1;const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/av1"){e=!0;break}}return e}function Qh(){if(!("getCapabilities"in RTCRtpSender)||Bt())return!1;if(Vt()){const t=ke();if(t?.version&&qe(t.version,"16")<0||t?.os==="iOS"&&t?.osVersion&&qe(t.osVersion,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/vp9"){e=!0;break}}return e}function Fe(n){return n==="av1"||n==="vp9"}function Wr(n){return!document||Nn()?!1:(n||(n=document.createElement("audio")),"setSinkId"in n)}function Yh(){return typeof RTCPeerConnection>"u"?!1:Vr()||qr()}function Bt(){var n;return((n=ke())===null||n===void 0?void 0:n.name)==="Firefox"}function xo(){const n=ke();return!!n&&n.name==="Chrome"&&n.os!=="iOS"}function Vt(){var n;return((n=ke())===null||n===void 0?void 0:n.name)==="Safari"}function Nn(){const n=ke();return n?.name==="Safari"||n?.os==="iOS"}function Xh(){const n=ke();return n?.name==="Safari"&&n.version.startsWith("17.")||n?.os==="iOS"&&!!n?.osVersion&&qe(n.osVersion,"17")>=0}function Zh(n){return n||(n=ke()),n?.name==="Safari"&&qe(n.version,"18.3")>0||n?.os==="iOS"&&!!n?.osVersion&&qe(n.osVersion,"18.3")>0}function ul(){var n,e;return we()?(e=(n=navigator.userAgentData)===null||n===void 0?void 0:n.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function ef(){const n=ke(),e="17.2";if(n)return n.name!=="Safari"&&n.os!=="iOS"||n.os==="iOS"&&n.osVersion&&qe(n.osVersion,e)>=0?!0:n.name==="Safari"&&qe(n.version,e)>=0}function we(){return typeof document<"u"}function Ze(){return navigator.product=="ReactNative"}function un(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function or(n){return un(n)?n.hostname.split(".")[0]:null}function dl(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function hl(){if(!Ze())return;let n=dl();if(n)return n.platform}function Mo(){if(we())return window.devicePixelRatio;if(Ze()){let n=dl();if(n)return n.devicePixelRatio}return 1}function qe(n,e){const t=n.split("."),i=e.split("."),r=Math.min(t.length,i.length);for(let s=0;s<r;++s){const o=parseInt(t[s],10),a=parseInt(i[s],10);if(o>a)return 1;if(o<a)return-1;if(s===r-1&&o===a)return 0}return n===""&&e!==""?-1:e===""?1:t.length==i.length?0:t.length<i.length?-1:1}function tf(n){for(const e of n)e.target.handleResize(e)}function nf(n){for(const e of n)e.target.handleVisibilityChanged(e)}let ar=null;const Do=()=>(ar||(ar=new ResizeObserver(tf)),ar);let cr=null;const Ao=()=>(cr||(cr=new IntersectionObserver(nf,{root:null,rootMargin:"0px"})),cr);function rf(){var n;const e=new hc({sdk:fc.JS,protocol:Mh,version:xh});return Ze()&&(e.os=(n=hl())!==null&&n!==void 0?n:""),e}function Lo(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=n,r.height=e;const s=r.getContext("2d");s?.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(n/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const o=r.captureStream(),[a]=o.getTracks();if(!a)throw Error("Could not get empty media stream video track");return a.enabled=t,a}let kn;function lr(){if(!kn){const n=new AudioContext,e=n.createOscillator(),t=n.createGain();t.gain.setValueAtTime(0,0);const i=n.createMediaStreamDestination();if(e.connect(t),t.connect(i),e.start(),[kn]=i.stream.getAudioTracks(),!kn)throw Error("Could not get empty media stream audio track");kn.enabled=!1}return kn.clone()}class De{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((i,r)=>k(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;this._isResolved=!0,(i=this.onFinally)===null||i===void 0||i.call(this)})}}function sf(n){return Nh.includes(n)}function wt(n){if(typeof n=="string"||typeof n=="number")return n;if(Array.isArray(n))return n[0];if(n.exact!==void 0)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal!==void 0)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function of(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function Un(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}function af(n,e){return n.segments.map(t=>{let{id:i,text:r,language:s,startTime:o,endTime:a,final:c}=t;var l;const u=(l=e.get(i))!==null&&l!==void 0?l:Date.now(),d=Date.now();return c?e.delete(i):e.set(i,u),{id:i,text:r,startTime:Number.parseInt(o.toString()),endTime:Number.parseInt(a.toString()),final:c,language:s,firstReceivedTime:u,lastReceivedTime:d}})}function cf(n){const{id:e,timestamp:t,message:i,editTimestamp:r}=n;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}function No(n){switch(n.reason){case Y.LeaveRequest:return n.context;case Y.Cancelled:return Be.CLIENT_INITIATED;case Y.NotAllowed:return Be.USER_REJECTED;case Y.ServerUnreachable:return Be.JOIN_FAILURE;default:return Be.UNKNOWN_REASON}}function di(n){return n!==void 0?Number(n):void 0}function Nt(n){return n!==void 0?BigInt(n):void 0}function Ut(n){return!!n&&!(n instanceof MediaStreamTrack)&&n.isLocal}function Ye(n){return!!n&&n.kind==E.Kind.Audio}function xt(n){return!!n&&n.kind==E.Kind.Video}function yt(n){return Ut(n)&&xt(n)}function st(n){return Ut(n)&&Ye(n)}function Hr(n){return!!n&&!n.isLocal}function lf(n){return!!n&&!n.isLocal}function ur(n){return Hr(n)&&xt(n)}function uf(n){return n.isLocal}function df(n,e){const t=[];let i=new TextEncoder().encode(n);for(;i.length>e;){let r=e;for(;r>0;){const s=i[r];if(s!==void 0&&(s&192)!==128)break;r--}t.push(i.slice(0,r)),i=i.slice(r)}return i.length>0&&t.push(i),t}function hf(n){var e;const t=n.get("Cache-Control");if(t){const i=(e=t.match(/(?:^|[,\s])max-age=(\d+)/))===null||e===void 0?void 0:e[1];if(i)return parseInt(i,10)}}function ff(n,e){const t=new URL(of(n));return e.forEach((i,r)=>{t.searchParams.set(r,i)}),pl(t,"rtc")}function pf(n){const e=new URL(Un(n));return pl(e,"validate")}function fl(n){return n.endsWith("/")?n:"".concat(n,"/")}function pl(n,e){return n.pathname="".concat(fl(n.pathname)).concat(e),n.toString()}function Uo(n){if(typeof n=="string")return mo.fromJson(JSON.parse(n),{ignoreUnknownFields:!0});if(n instanceof ArrayBuffer)return mo.fromBinary(new Uint8Array(n));throw new Error("could not decode websocket message: ".concat(typeof n))}function mf(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Unknown reason";if(!(n instanceof AbortSignal))return e;const t=n.reason;switch(typeof t){case"string":return t;case"object":return t instanceof Error?t.message:e;default:return"toString"in t?t.toString():e}}const gf=10,Sn="lk_e2ee",vf="LKFrameEncryptionKey",bf={sharedKey:!1,ratchetSalt:vf,ratchetWindowSize:8,failureTolerance:gf,keyringSize:16};var Pt;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(Pt||(Pt={}));var Fo;(function(n){n.KeyRatcheted="keyRatcheted"})(Fo||(Fo={}));var Tt;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(Tt||(Tt={}));var jo;(function(n){n.Error="cryptorError"})(jo||(jo={}));function yf(){return kf()||Kr()}function Kr(){return typeof window.RTCRtpScriptTransform<"u"}function kf(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}function Sf(n){var e,t,i,r,s;if(((e=n.value)===null||e===void 0?void 0:e.case)!=="sipDtmf"&&((t=n.value)===null||t===void 0?void 0:t.case)!=="metrics"&&((i=n.value)===null||i===void 0?void 0:i.case)!=="speaker"&&((r=n.value)===null||r===void 0?void 0:r.case)!=="transcription"&&((s=n.value)===null||s===void 0?void 0:s.case)!=="encryptedPacket")return new sc({value:n.value})}class cy extends tt.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,i,r)=>{j.debug("key ratcheted event received",{ratchetResult:t,participantId:i,keyIndex:r})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},bf),e),this.on(Pt.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,i){const r={key:e,participantIdentity:t,keyIndex:i};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(i??0),r),this.emit(Pt.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Pt.RatchetRequest,e,t)}}var Bo;(function(n){n[n.InvalidKey=0]="InvalidKey",n[n.MissingKey=1]="MissingKey",n[n.InternalError=2]="InternalError"})(Bo||(Bo={}));class Tf extends tt.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=i=>{var r,s;const{kind:o,data:a}=i.data;switch(o){case"error":if(j.error(a.error.message),a.uuid){const u=this.decryptDataRequests.get(a.uuid);if(u?.reject){u.reject(a.error);break}const d=this.encryptDataRequests.get(a.uuid);if(d?.reject){d.reject(a.error);break}}this.emit(Tt.EncryptionError,a.error,a.participantIdentity);break;case"initAck":a.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)});break;case"enable":if(a.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)}),this.encryptionEnabled!==a.enabled&&a.participantIdentity===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity))this.emit(Tt.ParticipantEncryptionStatusChanged,a.enabled,this.room.localParticipant),this.encryptionEnabled=a.enabled;else if(a.participantIdentity){const u=(s=this.room)===null||s===void 0?void 0:s.getParticipantByIdentity(a.participantIdentity);if(!u)throw TypeError("couldn't set encryption status, participant not found".concat(a.participantIdentity));this.emit(Tt.ParticipantEncryptionStatusChanged,a.enabled,u)}break;case"ratchetKey":this.keyProvider.emit(Pt.KeyRatcheted,a.ratchetResult,a.participantIdentity,a.keyIndex);break;case"decryptDataResponse":const c=this.decryptDataRequests.get(a.uuid);c?.resolve&&c.resolve(a);break;case"encryptDataResponse":const l=this.encryptDataRequests.get(a.uuid);l?.resolve&&l.resolve(a);break}},this.onWorkerError=i=>{j.error("e2ee worker encountered an error:",{error:i.error}),this.emit(Tt.EncryptionError,i.error,void 0)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!yf())throw new Ss("tried to setup end-to-end encryption on an unsupported browser");if(j.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:mh.getLevel()}};this.worker&&(j.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){j.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?j.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(N.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(I.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==ae.NONE,r.identity)),e.on(I.ConnectionStateChanged,i=>{i===H.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==ae.NONE,r.identity)})})}).on(I.TrackUnsubscribed,(i,r,s)=>{var o;const a={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(o=this.worker)===null||o===void 0||o.postMessage(a)}).on(I.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(I.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(i=>{this.postKey(i)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(M.LocalSenderCreated,(i,r)=>k(this,void 0,void 0,function*(){this.setupE2EESender(r,i)})),e.localParticipant.on(M.LocalTrackPublished,i=>{if(!xt(i.track)||!Nn())return;const r={kind:"updateCodec",data:{trackId:i.track.mediaStreamID,codec:In(i.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r)}),t.on(Pt.SetKey,i=>this.postKey(i)).on(Pt.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}encryptData(e){return k(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),i={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},r=new De;return r.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,r),this.worker.postMessage(i),r.promise})}handleEncryptedData(e,t,i,r){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const s=crypto.randomUUID(),o={kind:"decryptDataRequest",data:{uuid:s,payload:e,iv:t,participantIdentity:i,keyIndex:r}},a=new De;return a.onFinally=()=>{this.decryptDataRequests.delete(s)},this.decryptDataRequests.set(s,a),this.worker.postMessage(o),a.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(o)}postEnable(e,t){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!i?.mimeType||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?In(i.mimeType):void 0)}}setupE2EESender(e,t){if(!Ut(e)||!t){t||j.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,i,r){return k(this,void 0,void 0,function*(){if(this.worker){if(Kr()&&!xo()){const s={kind:"decode",participantIdentity:i,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Sn in e&&r){const c={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,o=e.readableStream;if(!s||!o){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,o=c.readable}const a={kind:"decode",data:{readableStream:o,writableStream:s,trackId:t,codec:r,participantIdentity:i,isReuse:Sn in e}};this.worker.postMessage(a,[o,s])}e[Sn]=!0}})}handleSender(e,t,i){var r;if(!(Sn in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Kr()&&!xo()){j.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{j.info("initialize encoded streams");const s=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(o,[s.readable,s.writable])}e[Sn]=!0}}}const Cf=500,Ef=15e3;class sn{constructor(){this.failedConnectionAttempts=new Map,this.backOffPromises=new Map}static getInstance(){return this._instance||(this._instance=new sn),this._instance}addFailedConnectionAttempt(e){var t;const i=new URL(e),r=or(i);if(!r)return;let s=(t=this.failedConnectionAttempts.get(r))!==null&&t!==void 0?t:0;this.failedConnectionAttempts.set(r,s+1),this.backOffPromises.set(r,pe(Math.min(Cf*Math.pow(2,s),Ef)))}getBackOffPromise(e){const t=new URL(e),i=t&&or(t);return i&&this.backOffPromises.get(i)||Promise.resolve()}resetFailedConnectionAttempts(e){const t=new URL(e),i=t&&or(t);i&&(this.failedConnectionAttempts.set(i,0),this.backOffPromises.set(i,Promise.resolve()))}resetAll(){this.backOffPromises.clear(),this.failedConnectionAttempts.clear()}}sn._instance=null;const dr="default";class de{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new de),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;if(((s=de.userMediaPromiseMap)===null||s===void 0?void 0:s.size)>0){j.debug("awaiting getUserMedia promise");try{t?yield de.userMediaPromiseMap.get(t):yield Promise.all(de.userMediaPromiseMap.values())}catch{j.warn("error waiting for media permissons")}}let o=yield navigator.mediaDevices.enumerateDevices();if(r&&!(Vt()&&i.hasDeviceInUse(t))&&(o.filter(c=>c.kind===t).length===0||o.some(c=>{const l=c.label==="",u=t?c.kind===t:!0;return l&&u}))){const c={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}},l=yield navigator.mediaDevices.getUserMedia(c);o=yield navigator.mediaDevices.enumerateDevices(),l.getTracks().forEach(u=>{u.stop()})}return i._previousDevices=o,t&&(o=o.filter(a=>a.kind===t)),o})()})}normalizeDeviceId(e,t,i){return k(this,void 0,void 0,function*(){if(t!==dr)return t;const r=yield this.getDevices(e),s=r.find(a=>a.deviceId===dr);if(!s){j.warn("could not reliably determine default device");return}const o=r.find(a=>a.deviceId!==dr&&a.groupId===(i??s.groupId));if(!o){j.warn("could not reliably determine default device");return}return o?.deviceId})}hasDeviceInUse(e){return e?de.userMediaPromiseMap.has(e):de.userMediaPromiseMap.size>0}}de.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];de.userMediaPromiseMap=new Map;var On;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(On||(On={}));class wf{constructor(){this.pendingTasks=new Map,this.taskMutex=new ye,this.nextTaskIndex=0}run(e){return k(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:On.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=On.RUNNING,yield e()}finally{t.status=On.COMPLETED,this.pendingTasks.delete(t.id),i()}})}flush(){return k(this,void 0,void 0,function*(){return this.run(()=>k(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class Pf{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i,r;if(!((i=t.signal)===null||i===void 0)&&i.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const s=new WebSocket(e,(r=t.protocols)!==null&&r!==void 0?r:[]);s.binaryType="arraybuffer",this.ws=s;const o=function(){let{closeCode:a,reason:c}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.close(a,c)};this.opened=new Promise((a,c)=>{s.onopen=()=>{a({readable:new ReadableStream({start(l){s.onmessage=u=>{let{data:d}=u;return l.enqueue(d)},s.onerror=u=>l.error(u)},cancel:o}),writable:new WritableStream({write(l){s.send(l)},abort(){s.close()},close:o}),protocol:s.protocol,extensions:s.extensions}),s.removeEventListener("error",c)},s.addEventListener("error",c)}),this.closed=new Promise((a,c)=>{const l=()=>k(this,void 0,void 0,function*(){const u=new Promise(h=>{s.readyState!==WebSocket.CLOSED&&s.addEventListener("close",p=>{h(p)},{once:!0})}),d=yield Promise.race([pe(250),u]);d?a(d):c(new Error("Encountered unspecified websocket error without a timely close event"))});s.onclose=u=>{let{code:d,reason:h}=u;a({closeCode:d,reason:h}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),t.signal&&(t.signal.onabort=()=>s.close()),this.close=o}}const Rf=["syncState","trickle","offer","answer","simulate","leave"];function _f(n){const e=Rf.indexOf(n.case)>=0;return j.trace("request allowed to bypass queue:",{canPass:e,req:n}),e}var J;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(J||(J={}));const If=250;class Es{get currentState(){return this.state}get isDisconnected(){return this.state===J.DISCONNECTING||this.state===J.DISCONNECTED}get isEstablishingConnection(){return this.state===J.CONNECTING||this.state===J.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=J.DISCONNECTED,this.log=j,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=dt((i=t.loggerName)!==null&&i!==void 0?i:Ve.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new wf,this.queuedRequests=[],this.closingLock=new ye,this.connectionLock=new ye,this.state=J.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,r){return k(this,void 0,void 0,function*(){return this.state=J.CONNECTING,this.options=i,yield this.connect(e,t,i,r)})}reconnect(e,t,i,r){return k(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=J.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}))})}connect(e,t,i,r){return k(this,void 0,void 0,function*(){const s=yield this.connectionLock.lock();this.connectOptions=i;const o=rf(),a=i.singlePeerConnection?xf(t,o,i):Of(t,o,i),c=ff(e,a),l=pf(c);return new Promise((u,d)=>k(this,void 0,void 0,function*(){var h,p;try{let b=!1;const m=v=>k(this,void 0,void 0,function*(){if(b)return;b=!0;const g=v instanceof Event?v.currentTarget:v,y=mf(g,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(y)).catch(C=>{this.log.error(C),this.close()}):this.close(),T(),d(F.cancelled(y))});r?.addEventListener("abort",m);const T=()=>{clearTimeout(S),r?.removeEventListener("abort",m)},S=setTimeout(()=>{m(F.timeout("room connection has timed out (signal)"))},i.websocketTimeout),P=(v,g)=>{this.handleSignalConnected(v,S,g)},_=new URL(c);_.searchParams.has("access_token")&&_.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(_),Object.assign({reconnect:i.reconnect,reconnectReason:i.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new Pf(c);try{this.ws.closed.then(O=>{var D;this.isEstablishingConnection&&d(F.internal("Websocket got closed during a (re)connection attempt: ".concat(O.reason))),O.closeCode!==1e3&&(this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:O.reason,code:O.closeCode,wasClean:O.closeCode===1e3,state:this.state})),this.state===J.CONNECTED&&this.handleOnClose((D=O.reason)!==null&&D!==void 0?D:"Unexpected WS error"))}).catch(O=>{this.isEstablishingConnection&&d(F.internal("Websocket error during a (re)connection attempt: ".concat(O)))});const v=yield this.ws.opened.catch(O=>k(this,void 0,void 0,function*(){if(this.state!==J.CONNECTED){this.state=J.DISCONNECTED,clearTimeout(S);const D=yield this.handleConnectionError(O,l);d(D);return}this.handleWSError(O),d(O)}));if(clearTimeout(S),!v)return;const g=v.readable.getReader();this.streamWriter=v.writable.getWriter();const y=yield g.read();if(g.releaseLock(),!y.value)throw F.internal("no message received as first message");const C=Uo(y.value),x=this.validateFirstMessage(C,(h=i.reconnect)!==null&&h!==void 0?h:!1);if(!x.isValid){d(x.error);return}((p=C.message)===null||p===void 0?void 0:p.case)==="join"&&(this.pingTimeoutDuration=C.message.value.pingTimeout,this.pingIntervalDuration=C.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));const R=x.shouldProcessFirstMessage?C:void 0;P(v,R),u(x.response)}catch(v){d(v)}finally{T()}}finally{s()}}))})}startReadingLoop(e,t){return k(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield pe(this.signalLatency));const{done:i,value:r}=yield e.read();if(i)break;const s=Uo(r);this.handleSignalResponse(s)}})}close(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Close method called on signal client";return(function*(){if([J.DISCONNECTING||J.DISCONNECTED].includes(e.state)){e.log.debug("ignoring signal close as it's already in disconnecting state");return}const r=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=J.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:i});const s=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([s,pe(If)])}}catch(s){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:s}))}finally{t&&(e.state=J.DISCONNECTED),r()}})()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Zt(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Zt(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new Li({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Ni({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const a=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new gs({requestId:a,metadata:i,name:r,attributes:o})}),a})()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new kc({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new Cc({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:X.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Pc({timestamp:X.parse(Date.now()),rtt:X.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new ms({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new Fi({reason:Be.CLIENT_INITIATED,action:tn.DISCONNECT})})}sendRequest(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!r&&!_f(t)&&i.state===J.RECONNECTING){i.queuedRequests.push(()=>k(i,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(r||(yield i.requestQueue.flush()),i.signalLatency&&(yield pe(i.signalLatency)),i.isDisconnected){i.log.debug("skipping signal request (type: ".concat(t.case,") - SignalClient disconnected"));return}if(!i.streamWriter){i.log.error("cannot send signal request before connected, type: ".concat(t?.case),i.logContext);return}const o=new jd({message:t});try{i.useJSON?yield i.streamWriter.write(o.toJsonString()):yield i.streamWriter.write(o.toBinary())}catch(a){i.log.error("error sending signal message",Object.assign(Object.assign({},i.logContext),{error:a}))}})()})}handleSignalResponse(e){var t,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const o=Vo(r.value);this.onAnswer&&this.onAnswer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="offer"){const o=Vo(r.value);this.onOffer&&this.onOffer(o,r.value.id,r.value.midToTrackId)}else if(r.case==="trickle"){const o=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(o,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):r.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(r.value.token),this.onRoomMoved&&this.onRoomMoved(r.value)):r.case==="mediaSectionsRequirement"?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(r.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return k(this,void 0,void 0,function*(){if(this.state===J.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=fe.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&fe.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=fe.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&fe.clearInterval(this.pingInterval)}handleSignalConnected(e,t,i){this.state=J.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),i)}validateFirstMessage(e,t){var i,r,s,o,a;return((i=e.message)===null||i===void 0?void 0:i.case)==="join"?{isValid:!0,response:e.message.value}:this.state===J.RECONNECTING&&((r=e.message)===null||r===void 0?void 0:r.case)!=="leave"?((s=e.message)===null||s===void 0?void 0:s.case)==="reconnect"?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&((o=e.message)===null||o===void 0?void 0:o.case)==="leave"?{isValid:!1,error:F.leaveRequest("Received leave request while trying to (re)connect",e.message.value.reason)}:t?{isValid:!1,error:F.internal("Unexpected first message")}:{isValid:!1,error:F.internal("did not receive join response, got ".concat((a=e.message)===null||a===void 0?void 0:a.case," instead"))}}handleConnectionError(e,t){return k(this,void 0,void 0,function*(){try{const i=yield fetch(t);if(i.status.toFixed(0).startsWith("4")){const r=yield i.text();return F.notAllowed(r,i.status)}else return e instanceof F?e:F.internal("Encountered unknown websocket error during connection: ".concat(e),{status:i.status,statusText:i.statusText})}catch(i){return i instanceof F?i:F.serverUnreachable(i instanceof Error?i.message:"server was not reachable")}})}}function Vo(n){const e={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=n.type;break}return e}function Zt(n,e){return new It({sdp:n.sdp,type:n.type,id:e})}function Of(n,e,t){var i;const r=new URLSearchParams;return r.set("access_token",n),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",Ze()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),r}function xf(n,e,t){const i=new URLSearchParams;i.set("access_token",n);const r=new ah({clientInfo:e,connectionSettings:new Rc({autoSubscribe:!!t.autoSubscribe,adaptiveStream:!!t.adaptiveStream}),reconnect:!!t.reconnect,participantSid:t.sid?t.sid:void 0});t.reconnectReason&&(r.reconnectReason=t.reconnectReason);const s=new ch({joinRequest:r.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(s.toBinary()))),i}class qo{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class Mf{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const i=Date.now();i-this._lastCleanup>this.ttl/2&&this.cleanup();const r=i+this.ttl;return this._map.set(e,{value:t,expiresAt:r}),this}get(e){const t=this._map.get(e);if(t){if(t.expiresAt<Date.now()){this._map.delete(e);return}return t.value}}has(e){const t=this._map.get(e);return t?t.expiresAt<Date.now()?(this._map.delete(e),!1):!0:!1}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,i]of this._map.entries())i.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e(i.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],i=this.asValueMap();for(const[r,s]of i.entries())t.push(e(s,r,i));return t}asValueMap(){const e=new Map;for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e.set(t,i.value);return e}}var Ae={},hr={},fr={exports:{}},Wo;function ws(){if(Wo)return fr.exports;Wo=1;var n=fr.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(n).forEach(function(e){var t=n[e];t.forEach(function(i){i.reg||(i.reg=/(.*)/),i.format||(i.format="%s")})}),fr.exports}var Ho;function Df(){return Ho||(Ho=1,(function(n){var e=function(a){return String(Number(a))===a?Number(a):a},t=function(a,c,l,u){if(u&&!l)c[u]=e(a[1]);else for(var d=0;d<l.length;d+=1)a[d+1]!=null&&(c[l[d]]=e(a[d+1]))},i=function(a,c,l){var u=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:u&&!c[a.name]&&(c[a.name]={});var d=a.push?{}:u?c[a.name]:c;t(l.match(a.reg),d,a.names,a.name),a.push&&c[a.push].push(d)},r=ws(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(a){var c={},l=[],u=c;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],p=d.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var b=0;b<(r[h]||[]).length;b+=1){var m=r[h][b];if(m.reg.test(p))return i(m,u,p)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=e(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};n.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(a){return a.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},n.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},n.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}})(hr)),hr}var pr,Ko;function Af(){if(Ko)return pr;Ko=1;var n=ws(),e=/%[sdv%]/g,t=function(o){var a=1,c=arguments,l=c.length;return o.replace(e,function(u){if(a>=l)return u;var d=c[a];switch(a+=1,u){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},i=function(o,a,c){var l=a.format instanceof Function?a.format(a.push?c:c[a.name]):a.format,u=[o+"="+l];if(a.names)for(var d=0;d<a.names.length;d+=1){var h=a.names[d];a.name?u.push(c[a.name][h]):u.push(c[a.names[d]])}else u.push(c[a.name]);return t.apply(null,u)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return pr=function(o,a){a=a||{},o.version==null&&(o.version=0),o.name==null&&(o.name=" "),o.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var c=a.outerOrder||r,l=a.innerOrder||s,u=[];return c.forEach(function(d){n[d].forEach(function(h){h.name in o&&o[h.name]!=null?u.push(i(d,h,o)):h.push in o&&o[h.push]!=null&&o[h.push].forEach(function(p){u.push(i(d,h,p))})})}),o.media.forEach(function(d){u.push(i("m",n.m[0],d)),l.forEach(function(h){n[h].forEach(function(p){p.name in d&&d[p.name]!=null?u.push(i(h,p,d)):p.push in d&&d[p.push]!=null&&d[p.push].forEach(function(b){u.push(i(h,p,b))})})})}),u.join(`\r
`)+`\r
`},pr}var zo;function Lf(){if(zo)return Ae;zo=1;var n=Df(),e=Af(),t=ws();return Ae.grammar=t,Ae.write=e,Ae.parse=n.parse,Ae.parseParams=n.parseParams,Ae.parseFmtpConfig=n.parseFmtpConfig,Ae.parsePayloads=n.parsePayloads,Ae.parseRemoteCandidates=n.parseRemoteCandidates,Ae.parseImageAttributes=n.parseImageAttributes,Ae.parseSimulcastStreamList=n.parseSimulcastStreamList,Ae}var kt=Lf();function Ps(n,e,t){var i,r,s;e===void 0&&(e=50),t===void 0&&(t={});var o=(i=t.isImmediate)!=null&&i,a=(r=t.callback)!=null&&r,c=t.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var p=Date.now()-l;if(p+e>=c)return c-p}return e}var h=function(){var p=[].slice.call(arguments),b=this;return new Promise(function(m,T){var S=o&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!o){var _=n.apply(b,p);a&&a(_),u.forEach(function(v){return(0,v.resolve)(_)}),u=[]}},d()),S){var P=n.apply(b,p);return a&&a(P),m(P)}u.push({resolve:m,reject:T})})};return h.cancel=function(p){s!==void 0&&clearTimeout(s),u.forEach(function(b){return(0,b.reject)(p)}),u=[]},h}const Nf=.7,Uf=20,on={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class Go extends tt.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super(),this.log=j,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Ps(r=>k(this,void 0,void 0,function*(){this.emit(on.NegotiationStarted);try{yield this.createAndSendOffer()}catch(s){if(r)r(s);else throw s}}),Uf),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=dt((i=t.loggerName)!==null&&i!==void 0?i:Ve.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new ye}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var i;t.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,t.candidate))},e.onicecandidateerror=t=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,t)},e.ontrack=t=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return k(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return k(this,void 0,void 0,function*(){var i;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let r;if(e.type==="offer"){let{stereoMids:s,nackMids:o}=Ff(e);this.remoteStereoMids=s,this.remoteNackMids=o}else if(e.type==="answer"){const s=kt.parse((i=e.sdp)!==null&&i!==void 0?i:"");s.media.forEach(o=>{const a=Rs(o.mid);o.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||a!=c.transceiver.mid)return!1;let l=0;if(o.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0)return!0;let u=!1;for(const d of o.fmtp)if(d.payload===l){d.config=d.config.split(";").filter(h=>!h.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(d.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),u=!0;break}return u||c.maxbr>0&&o.fmtp.push({payload:l,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),r=kt.write(s)}return yield this.setMungedSDP(e,r,!0),this.pendingCandidates.forEach(s=>{this.pc.addIceCandidate(s)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(on.NegotiationComplete),e.sdp&&kt.parse(e.sdp).media.forEach(o=>{o.type==="video"&&this.emit(on.RTPVideoPayloadTypes,o.rtp)})),!0})}createAndSendOffer(e){return k(this,void 0,void 0,function*(){var t;const i=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const a=this._pc.remoteDescription;if(e?.iceRestart&&a)yield this._pc.setRemoteDescription(a);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const r=this.latestOfferId+1;this.latestOfferId=r;const s=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const o=kt.parse((t=s.sdp)!==null&&t!==void 0?t:"");if(o.media.forEach(a=>{$o(a),a.type==="audio"?Jo(a,["all"],[]):a.type==="video"&&this.trackBitrates.some(c=>{if(!a.msid||!c.cid||!a.msid.includes(c.cid))return!1;let l=0;if(a.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0||(Fe(c.codec)&&!Vt()&&this.ensureVideoDDExtensionForSVC(a,o),!Fe(c.codec)))return!0;const u=Math.round(c.maxbr*Nf);for(const d of a.fmtp)if(d.payload===l){d.config.includes("x-google-start-bitrate")||(d.config+=";x-google-start-bitrate=".concat(u));break}return!0})}),this.latestOfferId>r){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:r}));return}yield this.setMungedSDP(s,kt.write(o)),this.onOffer(s,this.latestOfferId)}finally{i()}})}createAndSetAnswer(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),i=kt.parse((e=t.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{$o(r),r.type==="audio"&&Jo(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,kt.write(i)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new oe("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new oe("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return k(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(a=>{switch(a.type){case"transport":t=a.selectedCandidatePairId;break;case"candidate-pair":t===""&&a.selected&&(t=a.id),i.set(a.id,a);break;case"remote-candidate":r.set(a.id,"".concat(a.address,":").concat(a.port));break}}),t==="")return;const o=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(o!==void 0)return r.get(o)})}setMungedSDP(e,t,i){return k(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:t})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const o={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new Nr(s)}})}ensureVideoDDExtensionForSVC(e,t){var i,r;if(!((i=e.ext)===null||i===void 0?void 0:i.some(o=>o.uri===Oo))){if(this.ddExtID===0){let o=0;t.media.forEach(a=>{var c;a.type==="video"&&((c=a.ext)===null||c===void 0||c.forEach(l=>{l.value>o&&(o=l.value)}))}),this.ddExtID=o+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:Oo})}}}function Jo(n,e,t){const i=Rs(n.mid);let r=0;n.rtp.some(s=>s.codec==="opus"?(r=s.payload,!0):!1),r>0&&(n.rtcpFb||(n.rtcpFb=[]),t.includes(i)&&!n.rtcpFb.some(s=>s.payload===r&&s.type==="nack")&&n.rtcpFb.push({payload:r,type:"nack"}),(e.includes(i)||e.length===1&&e[0]==="all")&&n.fmtp.some(s=>s.payload===r?(s.config.includes("stereo=1")||(s.config+=";stereo=1"),!0):!1))}function Ff(n){var e;const t=[],i=[],r=kt.parse((e=n.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(o=>{var a;const c=Rs(o.mid);o.type==="audio"&&(o.rtp.some(l=>l.codec==="opus"?(s=l.payload,!0):!1),!((a=o.rtcpFb)===null||a===void 0)&&a.some(l=>l.payload===s&&l.type==="nack")&&i.push(c),o.fmtp.some(l=>l.payload===s?(l.config.includes("sprop-stereo=1")&&t.push(c),!0):!1))}),{stereoMids:t,nackMids:i}}function $o(n){if(n.connection){const e=n.connection.ip.indexOf(":")>=0;(n.connection.version===4&&e||n.connection.version===6&&!e)&&(n.connection.ip="0.0.0.0",n.connection.version=4)}}function Rs(n){return typeof n=="number"?n.toFixed(0):n}const zr="vp8",jf={audioPreset:Ur.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:Ts.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:zr,backupCodec:!0,preConnectBuffer:!1},ml={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},gl={deviceId:{ideal:"default"},resolution:Ln.h720.resolution},Bf={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new vh,disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},_s={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var Z;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(Z||(Z={}));class Vf{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,i){var r;this.peerConnectionTimeout=_s.peerConnectionTimeout,this.log=j,this.updateState=()=>{var s,o;const a=this.state,c=this.requiredTransports.map(l=>l.getConnectionState());c.every(l=>l==="connected")?this.state=Z.CONNECTED:c.some(l=>l==="failed")?this.state=Z.FAILED:c.some(l=>l==="connecting")?this.state=Z.CONNECTING:c.every(l=>l==="closed")?this.state=Z.CLOSED:c.some(l=>l==="closed")?this.state=Z.CLOSING:c.every(l=>l==="new")&&(this.state=Z.NEW),a!==this.state&&(this.log.debug("pc state change: from ".concat(Z[a]," to ").concat(Z[this.state]),this.logContext),(s=this.onStateChange)===null||s===void 0||s.call(this,this.state,this.publisher.getConnectionState(),(o=this.subscriber)===null||o===void 0?void 0:o.getConnectionState()))},this.log=dt((r=i.loggerName)!==null&&r!==void 0?r:Ve.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=t!=="subscriber-primary",this.isSubscriberConnectionRequired=t==="subscriber-primary",this.publisher=new Go(e,i),t!=="publisher-only"&&(this.subscriber=new Go(e,i),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,Ue.SUBSCRIBER)},this.subscriber.onDataChannel=s=>{var o;(o=this.onDataChannel)===null||o===void 0||o.call(this,s)},this.subscriber.onTrack=s=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,s)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=s=>{var o;(o=this.onIceCandidate)===null||o===void 0||o.call(this,s,Ue.PUBLISHER)},this.publisher.onTrack=s=>{var o;(o=this.onTrack)===null||o===void 0||o.call(this,s)},this.publisher.onOffer=(s,o)=>{var a;(a=this.onPublisherOffer)===null||a===void 0||a.call(this,s,o)},this.state=Z.NEW,this.connectionLock=new ye,this.remoteOfferLock=new ye}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return k(this,void 0,void 0,function*(){var e;if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const i of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(i)}catch(r){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:r}))}}yield Promise.all([this.publisher.close(),(e=this.subscriber)===null||e===void 0?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return k(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return k(this,void 0,void 0,function*(){var i;t===Ue.PUBLISHER?yield this.publisher.addIceCandidate(e):yield(i=this.subscriber)===null||i===void 0?void 0:i.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return k(this,void 0,void 0,function*(){var i,r,s;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:(i=this.subscriber)===null||i===void 0?void 0:i.getSignallingState().toString()}));const o=yield this.remoteOfferLock.lock();try{return(yield(r=this.subscriber)===null||r===void 0?void 0:r.setRemoteDescription(e,t))?yield(s=this.subscriber)===null||s===void 0?void 0:s.createAndSetAnswer():void 0}finally{o()}})}updateConfiguration(e,t){var i;this.publisher.setConfiguration(e),(i=this.subscriber)===null||i===void 0||i.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return k(this,void 0,void 0,function*(){var i;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,t)))}finally{r()}})}negotiate(e){return k(this,void 0,void 0,function*(){return new Promise((t,i)=>k(this,void 0,void 0,function*(){const r=setTimeout(()=>{i("negotiation timed out")},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i("negotiation aborted")};e.signal.addEventListener("abort",s),this.publisher.once(on.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(on.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(o=>{clearTimeout(r),i(o)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const i=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(r=>r.receiver===e);return i?.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Ue.PUBLISHER?this.publisher.getConnectedAddress():e===Ue.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(i.getConnectionState()!=="connected")return new Promise((c,l)=>k(s,void 0,void 0,function*(){const u=()=>{this.log.warn("abort transport connection",this.logContext),fe.clearTimeout(d),l(F.cancelled("room connection has been cancelled"))};r?.signal.aborted&&u(),r?.signal.addEventListener("abort",u);const d=fe.setTimeout(()=>{r?.signal.removeEventListener("abort",u),l(F.internal("could not establish pc connection"))},o);for(;this.state!==Z.CONNECTED;)if(yield pe(50),r?.signal.aborted){l(F.cancelled("room connection has been cancelled"));return}fe.clearTimeout(d),r?.signal.removeEventListener("abort",u),c()}))})()})}}const vl=5e3,qf=3e4;class K{static fetchRegionSettings(e,t,i){return k(this,void 0,void 0,function*(){const r=yield K.fetchLock.lock();try{const s=yield fetch("".concat(Wf(e),"/regions"),{headers:{authorization:"Bearer ".concat(t)},signal:i});if(s.ok){const o=hf(s.headers),a=o?o*1e3:vl;return{regionSettings:yield s.json(),updatedAtInMs:Date.now(),maxAgeInMs:a}}else throw s.status===401?F.notAllowed("Could not fetch region settings: ".concat(s.statusText),s.status):F.internal("Could not fetch region settings: ".concat(s.statusText))}catch(s){throw s instanceof F?s:i?.aborted?F.cancelled("Region fetching was aborted"):F.serverUnreachable("Could not fetch region settings, ".concat(s instanceof Error?"".concat(s.name,": ").concat(s.message):s))}finally{r()}})}static scheduleRefetch(e,t,i){return k(this,void 0,void 0,function*(){const r=K.settingsTimeouts.get(e.hostname);clearTimeout(r),K.settingsTimeouts.set(e.hostname,setTimeout(()=>k(this,void 0,void 0,function*(){try{const s=yield K.fetchRegionSettings(e,t);K.updateCachedRegionSettings(e,t,s)}catch(s){if(s instanceof F&&s.reason===Y.NotAllowed){j.debug("token is not valid, cancelling auto region refresh");return}j.debug("auto refetching of region settings failed",{error:s}),K.scheduleRefetch(e,t,i)}}),i))})}static updateCachedRegionSettings(e,t,i){K.cache.set(e.hostname,i),K.scheduleRefetch(e,t,i.maxAgeInMs)}static stopRefetch(e){const t=K.settingsTimeouts.get(e);t&&(clearTimeout(t),K.settingsTimeouts.delete(e))}static scheduleCleanup(e){let t=K.connectionTrackers.get(e);t&&(t.cleanupTimeout&&clearTimeout(t.cleanupTimeout),t.cleanupTimeout=setTimeout(()=>{const i=K.connectionTrackers.get(e);i&&i.connectionCount===0&&(j.debug("stopping region refetch after disconnect delay",{hostname:e}),K.stopRefetch(e)),i&&(i.cleanupTimeout=void 0)},qf))}static cancelCleanup(e){const t=K.connectionTrackers.get(e);t?.cleanupTimeout&&(clearTimeout(t.cleanupTimeout),t.cleanupTimeout=void 0)}notifyConnected(){const e=this.serverUrl.hostname;let t=K.connectionTrackers.get(e);t||(t={connectionCount:0},K.connectionTrackers.set(e,t)),t.connectionCount++,K.cancelCleanup(e)}notifyDisconnected(){const e=this.serverUrl.hostname,t=K.connectionTrackers.get(e);t&&(t.connectionCount=Math.max(0,t.connectionCount-1),t.connectionCount===0&&K.scheduleCleanup(e))}constructor(e,t){this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return un(this.serverUrl)}getServerUrl(){return this.serverUrl}fetchRegionSettings(e){return k(this,void 0,void 0,function*(){return K.fetchRegionSettings(this.serverUrl,this.token,e)})}getNextBestRegionUrl(e){return k(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");let t=K.cache.get(this.serverUrl.hostname);(!t||Date.now()-t.updatedAtInMs>t.maxAgeInMs)&&(t=yield this.fetchRegionSettings(e),K.updateCachedRegionSettings(this.serverUrl,this.token,t));const i=t.regionSettings.regions.filter(r=>!this.attemptedRegions.find(s=>s.url===r.url));if(i.length>0){const r=i[0];return this.attemptedRegions.push(r),j.debug("next region: ".concat(r.region)),r.url}else return null})}resetAttempts(){this.attemptedRegions=[]}setServerReportedRegions(e){K.updateCachedRegionSettings(this.serverUrl,this.token,e)}}K.cache=new Map;K.settingsTimeouts=new Map;K.connectionTrackers=new Map;K.fetchLock=new ye;function Wf(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}class te extends Error{constructor(e,t,i){super(t),this.code=e,this.message=Qo(t,te.MAX_MESSAGE_BYTES),this.data=i?Qo(i,te.MAX_DATA_BYTES):void 0}static fromProto(e){return new te(e.code,e.message,e.data)}toProto(){return new cc({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new te(te.ErrorCode[e],te.ErrorMessage[e],t)}}te.MAX_MESSAGE_BYTES=256;te.MAX_DATA_BYTES=15360;te.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};te.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const bl=15360;function Is(n){return new TextEncoder().encode(n).length}function Qo(n,e){if(Is(n)<=e)return n;let t=0,i=n.length;const r=new TextEncoder;for(;t<i;){const s=Math.floor((t+i+1)/2);r.encode(n.slice(0,s)).length<=e?t=s:i=s-1}return n.slice(0,t)}const Os=2e3;function Bi(n,e){if(!e)return 0;let t,i;return"bytesReceived"in n?(t=n.bytesReceived,i=e.bytesReceived):"bytesSent"in n&&(t=n.bytesSent,i=e.bytesSent),t===void 0||i===void 0||n.timestamp===void 0||e.timestamp===void 0?0:(t-i)*8*1e3/(n.timestamp-e.timestamp)}const xs=typeof MediaRecorder<"u";class Hf{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const Kf=xs?MediaRecorder:Hf;class zf extends Kf{constructor(e,t){if(!xs)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let i,r;const s=()=>r===void 0,o=()=>{this.removeEventListener("dataavailable",i),this.removeEventListener("stop",o),this.removeEventListener("error",a),r?.close(),r=void 0},a=c=>{r?.error(c),this.removeEventListener("dataavailable",i),this.removeEventListener("stop",o),this.removeEventListener("error",a),r=void 0};this.byteStream=new ReadableStream({start:c=>{r=c,i=l=>k(this,void 0,void 0,function*(){let u;if(l.data.arrayBuffer){const d=yield l.data.arrayBuffer();u=new Uint8Array(d)}else if(l.data.byteArray)u=l.data.byteArray;else throw new Error("no data available!");s()||c.enqueue(u)}),this.addEventListener("dataavailable",i)},cancel:()=>{o()}}),this.addEventListener("stop",o),this.addEventListener("error",a)}}function Gf(){return xs}const Jf=1e3,$f=1e4;class yl extends E{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,t,s),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=Ps(()=>k(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>k(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(L.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new ye,this.pauseUpstreamLock=new ye,this.trackChangeLock=new ye,this.trackChangeLock.lock().then(o=>k(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{o()}})),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==E.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return k(this,void 0,void 0,function*(){var i;if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(s=>{rn(this._mediaStreamTrack,s)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let r;if(this.processor&&e){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Xt(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),r=this.processor.processedTrack}this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"&&(yield this.sender.replaceTrack(r??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(s=>{Xt(r??e,s)}))})}waitForDimensions(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Jf;return(function*(){var i;if(e.kind===E.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=ke())===null||i===void 0?void 0:i.os)==="iOS"&&(yield pe(10));const r=Date.now();for(;Date.now()-r<t;){const s=e.dimensions;if(s)return s;yield pe(50)}throw new ut("unable to get track dimensions after timeout")})()})}setDeviceId(e){return k(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===wt(e)||(this._constraints.deviceId=e,this.isMuted)?!0:(yield this.restartTrack(),wt(e)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if(e.source===E.Source.ScreenShare)return;const{deviceId:i,groupId:r}=e._mediaStreamTrack.getSettings(),s=e.kind===E.Kind.Audio?"audioinput":"videoinput";return t?de.getInstance().normalizeDeviceId(s,i,r):i})()})}mute(){return k(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return k(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return k(this,void 0,void 0,function*(){const i=yield this.trackChangeLock.lock();try{if(!this.sender)throw new ut("unable to replace an unpublished track");let r,s;return typeof t=="boolean"?r=t:t!==void 0&&(r=t.userProvidedTrack,s=t.stopProcessor),this.providedByUser=r??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),s&&this.processor&&(yield this.internalStopProcessor()),this}finally{i()}})}restart(e){return k(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:i,facingMode:r}=e,s=bh(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const o={audio:!1,video:!1};this.kind===E.Kind.Video?o.video=i||r?{deviceId:i,facingMode:r}:!0:o.audio=i?Object.assign({deviceId:i},s):!0,this.attachedElements.forEach(l=>{rn(this.mediaStreamTrack,l)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const c=(yield navigator.mediaDevices.getUserMedia(o)).getTracks()[0];return this.kind===E.Kind.Video&&(yield c.applyConstraints(s)),c.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(c),this._constraints=e,this.emit(L.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?L.Muted:L.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),ul()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(L.UpstreamPaused,this);const i=ke();if(i?.name==="Safari"&&qe(i.version,"12.0")<0)throw new Ss("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(L.UpstreamResumed,this),((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return k(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;const o=yield i.trackChangeLock.lock();try{i.log.debug("setting up processor",i.logContext);const a=document.createElement(i.kind),c={kind:i.kind,track:i._mediaStreamTrack,element:a,audioContext:i.audioContext};if(yield t.init(c),i.log.debug("processor initialized",i.logContext),i.processor&&(yield i.internalStopProcessor()),i.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(Xt(i._mediaStreamTrack,a),a.muted=!0,a.play().catch(l=>{l instanceof DOMException&&l.name==="AbortError"?(i.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},i.logContext),{error:l})),setTimeout(()=>{a.play().catch(u=>{i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{err:u}))})},100)):i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{error:l}))}),i.processor=t,i.processorElement=a,i.processor.processedTrack){for(const l of i.attachedElements)l!==i.processorElement&&r&&(rn(i._mediaStreamTrack,l),Xt(i.processor.processedTrack,l));yield(s=i.sender)===null||s===void 0?void 0:s.replaceTrack(i.processor.processedTrack)}i.emit(L.TrackProcessorUpdate,i.processor)}finally{o()}})()})}getProcessor(){return this.processor}stopProcessor(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const i=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{i()}})()})}internalStopProcessor(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var i,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(i=e.processor.processedTrack)===null||i===void 0||i.stop(),yield e.processor.destroy(),e.processor=void 0,t||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(L.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!Gf()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="video/mp4"),this.localTrackRecorder=new zf(this,{mimeType:t})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},$f)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class ki extends yl{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,E.Kind.Audio,t,i,s),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>k(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let o;try{o=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}o&&this.prevStats&&(this._currentBitrate=Bi(o,this.prevStats)),this.prevStats=o}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(L.AudioTrackFeatureUpdate,this,ue.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(L.AudioTrackFeatureUpdate,this,ue.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===E.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==wt(this._constraints.deviceId);return this.source===E.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return k(this,void 0,void 0,function*(){let t;if(e){const i=Cs({audio:e});typeof i.audio!="boolean"&&(t=i.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return k(this,void 0,void 0,function*(){const i=yield t.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){we()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},Os)))}setProcessor(e){return k(this,void 0,void 0,function*(){var t;const i=yield this.trackChangeLock.lock();try{if(!Ze()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(L.TrackProcessorUpdate,this.processor)}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return k(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let i;return t.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return k(this,void 0,void 0,function*(){const e=yield al(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(L.AudioSilenceDetected)),e})}}function Qf(n,e,t){switch(n.kind){case"audio":return new ki(n,e,!1,void 0,t);case"video":return new Si(n,e,!1,t);default:throw new ut("unsupported track type: ".concat(n.kind))}}const Yf=Object.values(Ln),Xf=Object.values(Fr),Zf=Object.values(Ts),ep=[Ln.h180,Ln.h360],tp=[Fr.h180,Fr.h360],np=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(t=>{var i,r;return new G(Math.floor(n.width/t.scaleResolutionDownBy),Math.floor(n.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=n.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,n.encoding.priority)}),Gr=["q","h","f"];function Jr(n,e,t,i){var r,s;let o=i?.videoEncoding;n&&(o=i?.screenShareEncoding);const a=i?.simulcast,c=i?.scalabilityMode,l=i?.videoCodec;if(!o&&!a&&!c||!e||!t)return[{}];o||(o=rp(n,e,t,l),j.debug("using video encoding",o));const u=o.maxFramerate,d=new G(e,t,o.maxBitrate,o.maxFramerate,o.priority);if(c&&Fe(l)){const b=new kl(c),m=[];if(b.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const T=ke();if(Nn()||Ze()||T?.name==="Chrome"&&qe(T?.version,"113")<0){const S=b.suffix=="h"?2:3,P=Zh(T);for(let _=0;_<b.spatial;_+=1)m.push({rid:Gr[2-_],maxBitrate:o.maxBitrate/Math.pow(S,_),maxFramerate:d.encoding.maxFramerate,scaleResolutionDownBy:P?Math.pow(2,_):void 0});m[0].scalabilityMode=c}else m.push({maxBitrate:o.maxBitrate,maxFramerate:d.encoding.maxFramerate,scalabilityMode:c});return d.encoding.priority&&(m[0].priority=d.encoding.priority,m[0].networkPriority=d.encoding.priority),j.debug("using svc encoding",{encodings:m}),m}if(!a)return[o];let h=[];n?h=(r=Xo(i?.screenShareSimulcastLayers))!==null&&r!==void 0?r:Yo(n,d):h=(s=Xo(i?.videoSimulcastLayers))!==null&&s!==void 0?s:Yo(n,d);let p;if(h.length>0){const b=h[0];h.length>1&&([,p]=h);const m=Math.max(e,t);if(m>=960&&p)return mr(e,t,[b,p,d],u);if(m>=480)return mr(e,t,[b,d],u)}return mr(e,t,[d])}function ip(n,e,t){var i,r,s,o;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&j.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const a=n.mediaStreamTrack.getSettings(),c=(i=a.width)!==null&&i!==void 0?i:(r=n.dimensions)===null||r===void 0?void 0:r.width,l=(s=a.height)!==null&&s!==void 0?s:(o=n.dimensions)===null||o===void 0?void 0:o.height;return n.source===E.Source.ScreenShare&&t.simulcast&&(t.simulcast=!1),Jr(n.source===E.Source.ScreenShare,c,l,t)}function rp(n,e,t,i){const r=sp(n,e,t);let{encoding:s}=r[0];const o=Math.max(e,t);for(let a=0;a<r.length;a+=1){const c=r[a];if(s=c.encoding,c.width>=o)break}if(i)switch(i){case"av1":case"h265":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function sp(n,e,t){if(n)return Zf;const i=e>t?e/t:t/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?Yf:Xf}function Yo(n,e){if(n)return np(e);const{width:t,height:i}=e,r=t>i?t/i:i/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?ep:tp}function mr(n,e,t,i){const r=[];if(t.forEach((s,o)=>{if(o>=Gr.length)return;const a=Math.min(n,e),l={rid:Gr[o],scaleResolutionDownBy:Math.max(1,a/Math.min(s.width,s.height)),maxBitrate:s.encoding.maxBitrate},u=i&&s.encoding.maxFramerate?Math.min(i,s.encoding.maxFramerate):s.encoding.maxFramerate;u&&(l.maxFramerate=u);const d=Bt()||o===0;s.encoding.priority&&d&&(l.priority=s.encoding.priority,l.networkPriority=s.encoding.priority),r.push(l)}),Ze()&&hl()==="ios"){let s;r.forEach(a=>{s?a.maxFramerate&&a.maxFramerate>s&&(s=a.maxFramerate):s=a.maxFramerate});let o=!0;r.forEach(a=>{var c;a.maxFramerate!=s&&(o&&(o=!1,j.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),j.info('Setting framerate of encoding "'.concat((c=a.rid)!==null&&c!==void 0?c:"",'" to ').concat(s)),a.maxFramerate=s)})}return r}function Xo(n){if(n)return n.sort((e,t)=>{const{encoding:i}=e,{encoding:r}=t;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class kl{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function op(n){return n.source===E.Source.ScreenShare||n.constraints.height&&wt(n.constraints.height)>=1080?"maintain-resolution":"balanced"}const ap=5e3;class Si extends yl{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,E.Kind.Video,t,i,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>k(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(c){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:c}));return}const o=new Map(s.map(c=>[c.rid,c])),a=s.some(c=>c.qualityLimitationReason==="cpu");if(a!==this.isCpuConstrained&&(this.isCpuConstrained=a,this.isCpuConstrained&&this.emit(L.CpuConstrained)),this.prevStats){let c=0;o.forEach((l,u)=>{var d;const h=(d=this.prevStats)===null||d===void 0?void 0:d.get(u);c+=Bi(l,h)}),this._currentBitrate=c}this.prevStats=o}),this.senderLock=new ye}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!we())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},Os))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return k(this,void 0,void 0,function*(){var t,i,r,s,o;yield e.pauseUpstream.call(this);try{for(var a=!0,c=lt(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0)s=l.value,a=!1,yield(o=s.sender)===null||o===void 0?void 0:o.replaceTrack(null)}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return k(this,void 0,void 0,function*(){var t,i,r,s,o;yield e.resumeUpstream.call(this);try{for(var a=!0,c=lt(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0){s=l.value,a=!1;const u=s;yield(o=u.sender)===null||o===void 0?void 0:o.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===E.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===E.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return k(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const o={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},a=i.get(r.remoteId);a&&(o.jitter=a.jitter,o.packetsLost=a.packetsLost,o.roundTripTime=a.roundTripTime),t.push(o)}}),t.sort((r,s)=>{var o,a;return((o=s.frameWidth)!==null&&o!==void 0?o:0)-((a=r.frameWidth)!==null&&a!==void 0?a:0)}),t})}setPublishingQuality(e){const t=[];for(let i=_e.LOW;i<=_e.HIGH;i+=1)t.push(new vs({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(Fe(this.codec),t)}restartTrack(e){return k(this,void 0,void 0,function*(){var t,i,r,s,o;let a;if(e){const d=Cs({video:e});typeof d.video!="boolean"&&(a=d.video)}yield this.restart(a),this.isCpuConstrained=!1;try{for(var c=!0,l=lt(this.simulcastCodecs.values()),u;u=yield l.next(),t=u.done,!t;c=!0){s=u.value,c=!1;const d=s;d.sender&&((o=d.sender.transport)===null||o===void 0?void 0:o.state)!=="closed"&&(d.mediaStreamTrack=this.mediaStreamTrack.clone(),yield d.sender.replaceTrack(d.mediaStreamTrack))}}catch(d){i={error:d}}finally{try{!c&&!t&&(r=l.return)&&(yield r.call(l))}finally{if(i)throw i.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return k(this,arguments,void 0,function(i){var r=this;let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var o,a,c,l,u,d;if(yield t.setProcessor.call(r,i,s),!((u=r.processor)===null||u===void 0)&&u.processedTrack)try{for(var h=!0,p=lt(r.simulcastCodecs.values()),b;b=yield p.next(),o=b.done,!o;h=!0)l=b.value,h=!1,yield(d=l.sender)===null||d===void 0?void 0:d.replaceTrack(r.processor.processedTrack)}catch(m){a={error:m}}finally{try{!h&&!o&&(c=p.return)&&(yield c.call(p))}finally{if(a)throw a.error}}})()})}setDegradationPreference(e){return k(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);i&&(i.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},ap))}setPublishingCodecs(e){return k(this,void 0,void 0,function*(){var t,i,r,s,o,a,c;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(Fe(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,i=lt(e);r=yield i.next(),s=r.done,!s;t=!0){c=r.value,t=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers(Fe(u.codec),u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const h of u.qualities)if(h.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield Zo(d.sender,d.encodings,u.qualities,this.senderLock,Fe(u.codec),this.log,this.logContext))}}}catch(u){o={error:u}}finally{try{!t&&!s&&(a=i.return)&&(yield a.call(i))}finally{if(o)throw o.error}}return l})}setPublishingLayers(e,t){return k(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield Zo(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))})}prioritizePerformance(){return k(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const t=this.sender.getParameters();t.encodings=t.encodings.map((i,r)=>{var s;return Object.assign(Object.assign({},i),{active:r===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((s=this.mediaStreamTrack.getSettings().height)!==null&&s!==void 0?s:360)/360)),scalabilityMode:r===0&&Fe(this.codec)?"L1T3":void 0,maxFramerate:r===0?15:0,maxBitrate:r===0?i.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:t.encodings})),this.encodings=t.encodings,yield this.sender.setParameters(t)}catch(t){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:t})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),ul()&&this.isInBackground&&this.source===E.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function Zo(n,e,t,i,r,s,o){return k(this,void 0,void 0,function*(){const a=yield i.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},o),{sender:n,qualities:t,senderEncodings:e}));try{const c=n.getParameters(),{encodings:l}=c;if(!l)return;if(l.length!==e.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},o),{encodings:l,senderEncodings:e}));return}let u=!1;!1&&l[0].scalabilityMode||(r&&t.some(p=>p.enabled)&&t.forEach(p=>p.enabled=!0),l.forEach((h,p)=>{var b;let m=(b=h.rid)!==null&&b!==void 0?b:"";m===""&&(m="q");const T=Sl(m),S=t.find(P=>P.quality===T);S&&h.active!==S.enabled&&(u=!0,h.active=S.enabled,s.debug("setting layer ".concat(S.quality," to ").concat(h.active?"enabled":"disabled"),o),Bt()&&(S.enabled?(h.scaleResolutionDownBy=e[p].scaleResolutionDownBy,h.maxBitrate=e[p].maxBitrate,h.maxFrameRate=e[p].maxFrameRate):(h.scaleResolutionDownBy=4,h.maxBitrate=10,h.maxFrameRate=2)))})),u&&(c.encodings=l,s.debug("setting encodings",Object.assign(Object.assign({},o),{encodings:c.encodings})),yield n.setParameters(c))}finally{a()}})}function Sl(n){switch(n){case"f":return _e.HIGH;case"h":return _e.MEDIUM;case"q":return _e.LOW;default:return _e.HIGH}}function ea(n,e,t,i){if(!t)return[new Et({quality:_e.HIGH,width:n,height:e,bitrate:0,ssrc:0})];if(i){const r=t[0].scalabilityMode,s=new kl(r),o=[],a=s.suffix=="h"?1.5:2,c=s.suffix=="h"?2:3;for(let l=0;l<s.spatial;l+=1)o.push(new Et({quality:Math.min(_e.HIGH,s.spatial-1)-l,width:Math.ceil(n/Math.pow(a,l)),height:Math.ceil(e/Math.pow(a,l)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(c,l)):0,ssrc:0}));return o}return t.map(r=>{var s,o,a;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=Sl((o=r.rid)!==null&&o!==void 0?o:"");return new Et({quality:l,width:Math.ceil(n/c),height:Math.ceil(e/c),bitrate:(a=r.maxBitrate)!==null&&a!==void 0?a:0,ssrc:0})})}const ta="_lossy",na="_reliable",cp=2*1e3,gr="leave-reconnect",lp=3e4,up=8*1024,dp=256*1024;var xe;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(xe||(xe={}));class hp extends tt.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=_s.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=xe.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=j,this.reliableDataSequence=1,this.reliableMessageBuffer=new qo,this.reliableReceivedState=new Mf(lp),this.lossyDataStatCurrentBytes=0,this.lossyDataStatByterate=0,this.lossyDataDropCount=0,this.midToTrackId={},this.isWaitingForNetworkReconnect=!1,this.handleDataChannel=i=>k(this,[i],void 0,function(r){var s=this;let{channel:o}=r;return(function*(){if(o){if(o.label===na)s.reliableDCSub=o;else if(o.label===ta)s.lossyDCSub=o;else return;s.log.debug("on data channel ".concat(o.id,", ").concat(o.label),s.logContext),o.onmessage=s.handleDataMessage}})()}),this.handleDataMessage=i=>k(this,void 0,void 0,function*(){var r,s,o,a,c;const l=yield this.dataProcessLock.lock();try{let u;if(i.data instanceof ArrayBuffer)u=i.data;else if(i.data instanceof Blob)u=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const d=be.fromBinary(new Uint8Array(u));if(d.sequence>0&&d.participantSid!==""){const h=this.reliableReceivedState.get(d.participantSid);if(h&&d.sequence<=h)return;this.reliableReceivedState.set(d.participantSid,d.sequence)}if(((r=d.value)===null||r===void 0?void 0:r.case)==="speaker")this.emit(N.ActiveSpeakersUpdate,d.value.value.speakers);else if(((s=d.value)===null||s===void 0?void 0:s.case)==="encryptedPacket"){if(!this.e2eeManager){this.log.error("Received encrypted packet but E2EE not set up",this.logContext);return}const h=yield(o=this.e2eeManager)===null||o===void 0?void 0:o.handleEncryptedData(d.value.value.encryptedValue,d.value.value.iv,d.participantIdentity,d.value.value.keyIndex),p=sc.fromBinary(h.payload),b=new be({value:p.value,participantIdentity:d.participantIdentity,participantSid:d.participantSid});((a=b.value)===null||a===void 0?void 0:a.case)==="user"&&ia(b,b.value.value),this.emit(N.DataPacketReceived,b,d.value.value.encryptionType)}else((c=d.value)===null||c===void 0?void 0:c.case)==="user"&&ia(d,d.value.value),this.emit(N.DataPacketReceived,d,ae.NONE)}finally{l()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:o}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:o}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?V.LOSSY:V.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(N.Disconnected),this.close()},o=Date.now()-this.reconnectStart;let a=this.getNextRetryDelay({elapsedMs:o,retryCount:this.reconnectAttempts});if(a===null){s(o);return}i===gr&&(a=0),this.log.debug("reconnecting in ".concat(a,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=fe.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),a)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===xe.Connected&&i();const s=()=>{this.off(N.Disconnected,o),i()},o=()=>{this.off(N.Restarted,s),r()};this.once(N.Restarted,s),this.once(N.Disconnected,o)}),this.updateAndEmitDCBufferStatus=i=>{if(i===V.RELIABLE){const s=this.dataChannelForKind(i);s&&this.reliableMessageBuffer.alignBufferedAmount(s.bufferedAmount)}const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(N.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>k(this,void 0,void 0,function*(){!this.url||!(yield fetch(Un(this.url),{method:"HEAD"}).then(r=>r.ok).catch(()=>!1))||(this.log.info("detected network reconnected"),(this.client.currentState===J.RECONNECTING||this.isWaitingForNetworkReconnect&&this.client.currentState===J.CONNECTED)&&(this.clearReconnectTimeout(),this.attemptReconnect(Lt.RR_SIGNAL_DISCONNECTED),this.isWaitingForNetworkReconnect=!1))}),this.handleBrowserOffline=()=>k(this,void 0,void 0,function*(){if(this.url)try{yield Promise.race([fetch(Un(this.url),{method:"HEAD"}),pe(4e3).then(()=>Promise.reject())])}catch{window.navigator.onLine===!1&&(this.log.info("detected network interruption"),this.isWaitingForNetworkReconnect=!0)}}),this.log=dt((t=e.loggerName)!==null&&t!==void 0?t:Ve.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new Es(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new ye,this.dataProcessLock=new ye,this.dcBufferStatus=new Map([[V.LOSSY,!0],[V.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(N.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(N.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(N.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(N.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(N.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(N.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(N.StreamStateChanged,i),this.client.onRequestResponse=i=>this.emit(N.SignalRequestResponse,i)}get logContext(){var e,t,i,r,s,o;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,participant:(o=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||o===void 0?void 0:o.identity,pID:this.participantSid}}join(e,t,i,r){return k(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=i,this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const s=yield this.client.join(e,t,i,r);return this._isClosed=!1,this.latestJoinResponse=s,this.subscriberPrimary=s.subscriberPrimary,this.pcManager||(yield this.configure(s)),(!this.subscriberPrimary||s.fastPublish)&&this.negotiate().catch(o=>{j.error(o,this.logContext)}),this.registerOnLineListener(),this.clientConfiguration=s.clientConfiguration,this.emit(N.SignalConnected,s),s}catch(s){if(s instanceof F&&s.reason===Y.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,i,r);throw s}})}close(){return k(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(N.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),this.cleanupLossyDataStats(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return k(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new qo,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupLossyDataStats(){this.lossyDataStatByterate=0,this.lossyDataStatCurrentBytes=0,this.lossyDataStatInterval&&(clearInterval(this.lossyDataStatInterval),this.lossyDataStatInterval=void 0),this.lossyDataDropCount=0}cleanupClient(){return k(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new ut("a track with the same ID has already been published");return new Promise((t,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(F.timeout("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),t(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return k(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return k(this,void 0,void 0,function*(){var t,i;if(this.pcManager&&this.pcManager.currentState!==Z.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const r=this.makeRTCConfiguration(e);this.pcManager=new Vf(r,this.options.singlePeerConnection?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(N.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(s,o)=>{this.client.sendIceCandidate(s,o)},this.pcManager.onPublisherOffer=(s,o)=>{this.client.sendOffer(s,o)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(s,o,a)=>k(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(s),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),s===Z.CONNECTED){const u=this.pcState===xe.New;this.pcState=xe.Connected,u&&this.emit(N.Connected,e)}else s===Z.FAILED&&(this.pcState===xe.Connected||this.pcState===xe.Reconnecting)&&(this.pcState=xe.Disconnected,this.handleDisconnect("peerconnection failed",a==="failed"?Lt.RR_SUBSCRIBER_FAILED:Lt.RR_PUBLISHER_FAILED));const c=this.client.isDisconnected||this.client.currentState===J.RECONNECTING,l=[Z.FAILED,Z.CLOSING,Z.CLOSED].includes(s);c&&l&&!this._isClosed&&this.emit(N.Offline)}),this.pcManager.onTrack=s=>{s.streams.length!==0&&this.emit(N.MediaTrackAdded,s.track,s.streams[0],s.receiver)},fp((i=e.serverInfo)===null||i===void 0?void 0:i.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,i)=>k(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:i})),this.midToTrackId=i,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,i)=>k(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=i;const r=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);r&&this.client.sendAnswer(r,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(N.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(N.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{var t;this.token=e,(t=this.regionUrlProvider)===null||t===void 0||t.updateToken(e)},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(N.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(N.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(N.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,i;const r={direction:"recvonly"};for(let s=0;s<e.numAudios;s++)(t=this.pcManager)===null||t===void 0||t.addPublisherTransceiverOfKind("audio",r);for(let s=0;s<e.numVideos;s++)(i=this.pcManager)===null||i===void 0||i.addPublisherTransceiverOfKind("video",r);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",Lt.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e?.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions({updatedAtInMs:Date.now(),maxAgeInMs:vl,regionSettings:e.regions})),e.action){case tn.DISCONNECT:this.emit(N.Disconnected,e?.reason),this.close();break;case tn.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(gr);break;case tn.RESUME:this.handleDisconnect(gr)}}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const o={urls:s.urls};s.username&&(o.username=s.username),s.credential&&(o.credential=s.credential),r.push(o)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===xn.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(ta,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(na,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow,this.cleanupLossyDataStats(),this.lossyDataStatInterval=setInterval(()=>{this.lossyDataStatByterate=this.lossyDataStatCurrentBytes,this.lossyDataStatCurrentBytes=0;const e=this.dataChannelForKind(V.LOSSY);if(e){const t=this.lossyDataStatByterate/10;e.bufferedAmountLowThreshold=Math.min(Math.max(t,up),dp)}},1e3))}createSender(e,t,i){return k(this,void 0,void 0,function*(){if(Vr())return yield this.createTransceiverRTCRtpSender(e,t,i);if(qr())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new oe("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,i,r){return k(this,void 0,void 0,function*(){if(Vr())return this.createSimulcastTransceiverSender(e,t,i,r);if(qr())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new oe("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,i){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new oe("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),xt(e)&&(e.codec=t.videoCodec);const s={direction:"sendonly",streams:r};return i&&(s.sendEncodings=i),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s)).sender})}createSimulcastTransceiverSender(e,t,i,r){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new oe("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const o=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);if(i.videoCodec)return e.setSimulcastTrackSender(i.videoCodec,o.sender),o.sender})}createRTCRtpSender(e){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new oe("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return k(this,void 0,void 0,function*(){var t,i,r;if(!this._isClosed){if(this.attemptingReconnect){j.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===xn.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:Z.NEW)===Z.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let o=!0;s instanceof oe?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),o=!1):s instanceof Qt||(this.fullReconnectOnNext=!0),o?this.handleDisconnect("reconnect",Lt.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(N.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return k(this,void 0,void 0,function*(){var t,i,r;try{if(!this.url||!this.token)throw new oe("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(N.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Qt;s=yield this.join(e??this.url,this.token,this.signalOpts)}catch(o){throw o instanceof F&&o.reason===Y.NotAllowed?new oe("could not reconnect, token might be expired"):new Qt}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(N.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==J.CONNECTED)throw new Qt("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(N.Restarted)}catch(s){const o=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(o){yield this.restartConnection(o);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){return k(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new oe("could not reconnect, url or token not saved");if(!this.pcManager)throw new oe("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(N.Resuming);let i;try{this.setupSignalClientCallbacks(),i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let s="";throw r instanceof Error&&(s=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof F&&r.reason===Y.NotAllowed?new oe("could not reconnect, token might be expired"):r instanceof F&&r.reason===Y.LeaveRequest?r:new Qt(s)}if(this.emit(N.SignalResumed),i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=i.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==J.CONNECTED)throw new Qt("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),i?.lastMessageSeq&&this.resendReliableMessagesForResume(i.lastMessageSeq),this.emit(N.Resumed)})}waitForPCInitialConnection(e,t){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new oe("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return k(this,void 0,void 0,function*(){this.pcState=xe.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield pe(cp),!this.pcManager)throw new oe("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=xe.Connected}catch(e){throw this.pcState=xe.Disconnected,F.internal("could not establish PC connection, ".concat(e.message))}})}publishRpcResponse(e,t,i,r){return k(this,void 0,void 0,function*(){const s=new be({destinationIdentities:[e],kind:V.RELIABLE,value:{case:"rpcResponse",value:new fs({requestId:t,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:i??""}})}});yield this.sendDataPacket(s,V.RELIABLE)})}publishRpcAck(e,t){return k(this,void 0,void 0,function*(){const i=new be({destinationIdentities:[e],kind:V.RELIABLE,value:{case:"rpcAck",value:new hs({requestId:t})}});yield this.sendDataPacket(i,V.RELIABLE)})}sendDataPacket(e,t){return k(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const s=Sf(e);if(s){const o=yield this.e2eeManager.encryptData(s.toBinary());e.value={case:"encryptedPacket",value:new rc({encryptedValue:o.payload,iv:o.iv,keyIndex:o.keyIndex})}}}t===V.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const i=e.toBinary(),r=this.dataChannelForKind(t);if(r){if(t===V.RELIABLE)yield this.waitForBufferStatusLow(t),this.reliableMessageBuffer.push({data:i,sequence:e.sequence});else{if(!this.isBufferStatusLow(t)){this.lossyDataDropCount+=1,this.lossyDataDropCount%100===0&&this.log.warn("dropping lossy data channel messages, total dropped: ".concat(this.lossyDataDropCount),this.logContext);return}this.lossyDataStatCurrentBytes+=i.byteLength}if(this.attemptingReconnect)return;r.send(i)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return k(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(V.RELIABLE);const t=this.dataChannelForKind(V.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(i=>{t.send(i.data)})),this.updateAndEmitDCBufferStatus(V.RELIABLE)})}waitForBufferStatusLow(e){return new Promise((t,i)=>k(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const r=()=>i("Engine closed");for(this.once(N.Closing,r);!this.dcBufferStatus.get(e);)yield pe(10);this.off(N.Closing,r),t()}}))}ensureDataTransportConnected(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var s;if(!i.pcManager)throw new oe("PC manager is closed");const o=r?i.pcManager.subscriber:i.pcManager.publisher,a=r?"Subscriber":"Publisher";if(!o)throw F.internal("".concat(a," connection not set"));let c=!1;!r&&!i.dataChannelForKind(t,r)&&(i.createDataChannels(),c=!0),!c&&!r&&!i.pcManager.publisher.isICEConnected&&i.pcManager.publisher.getICEConnectionState()!=="checking"&&(c=!0),c&&i.negotiate().catch(d=>{j.error(d,i.logContext)});const l=i.dataChannelForKind(t,r);if(l?.readyState==="open")return;const u=new Date().getTime()+i.peerConnectionTimeout;for(;new Date().getTime()<u;){if(o.isICEConnected&&((s=i.dataChannelForKind(t,r))===null||s===void 0?void 0:s.readyState)==="open")return;yield pe(50)}throw F.internal("could not establish ".concat(a," connection, state: ").concat(o.getICEConnectionState()))})()})}ensurePublisherConnected(e){return k(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==Z.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return k(this,void 0,void 0,function*(){return new Promise((e,t)=>k(this,void 0,void 0,function*(){if(!this.pcManager){t(new Nr("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(N.Closing,r),this.pcManager.publisher.once(on.RTPVideoPayloadTypes,s=>{const o=new Map;s.forEach(a=>{const c=a.codec.toLowerCase();sf(c)&&o.set(a.payload,c)}),this.emit(N.RTPVideoMapUpdate,o)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof Nr&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Lt.RR_UNKNOWN),t(s)}finally{this.off(N.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===V.LOSSY)return this.lossyDCSub;if(e===V.RELIABLE)return this.reliableDCSub}else{if(e===V.LOSSY)return this.lossyDC;if(e===V.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,r,s,o;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const a=this.pcManager.publisher.getLocalDescription(),c=this.pcManager.publisher.getRemoteDescription(),l=(i=this.pcManager.subscriber)===null||i===void 0?void 0:i.getRemoteDescription(),u=(r=this.pcManager.subscriber)===null||r===void 0?void 0:r.getLocalDescription(),d=(o=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&o!==void 0?o:!0,h=new Array,p=new Array;e.forEach(b=>{b.isDesired!==d&&h.push(b.trackSid),b.isEnabled||p.push(b.trackSid)}),this.client.sendSyncState(new bs({answer:this.options.singlePeerConnection?c?Zt({sdp:c.sdp,type:c.type}):void 0:u?Zt({sdp:u.sdp,type:u.type}):void 0,offer:this.options.singlePeerConnection?a?Zt({sdp:a.sdp,type:a.type}):void 0:l?Zt({sdp:l.sdp,type:l.type}):void 0,subscription:new Ui({trackSids:h,subscribe:!d,participantTracks:[]}),publishTracks:Vh(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p,datachannelReceiveStates:this.reliableReceivedState.map((b,m)=>new Ec({publisherSid:m,lastSeq:b}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(i,r)=>{i?.id!==void 0&&i.id!==null&&e.push(new wc({label:i.label,id:i.id,target:r}))};return t(this.dataChannelForKind(V.LOSSY),Ue.PUBLISHER),t(this.dataChannelForKind(V.RELIABLE),Ue.PUBLISHER),t(this.dataChannelForKind(V.LOSSY,!0),Ue.SUBSCRIBER),t(this.dataChannelForKind(V.RELIABLE,!0),Ue.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&fe.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){we()&&(window.addEventListener("online",this.handleBrowserOnLine),window.addEventListener("offline",this.handleBrowserOffline))}deregisterOnLineListener(){we()&&(window.removeEventListener("online",this.handleBrowserOnLine),window.removeEventListener("offline",this.handleBrowserOffline))}getTrackIdForReceiver(e){var t;const i=(t=this.pcManager)===null||t===void 0?void 0:t.getMidForReceiver(e);if(i){const r=Object.entries(this.midToTrackId).find(s=>{let[o]=s;return o===i});if(r)return r[1]}}}function fp(n){return n!==void 0&&n>13}function ia(n,e){const t=n.participantIdentity?n.participantIdentity:e.participantIdentity;n.participantIdentity=t,e.participantIdentity=t;const i=n.destinationIdentities.length!==0?n.destinationIdentities:e.destinationIdentities;n.destinationIdentities=i,e.destinationIdentities=i}class Tl{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if(e&&this.bytesReceived<this.totalByteSize)throw new Me("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),ve.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new Me("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),ve.LengthExceeded)}}constructor(e,t,i,r){this.reader=t,this.totalByteSize=i,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=r}}class pp extends Tl{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,i)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new De,i=null,r=null;if(this.signal){const o=this.signal;r=()=>{var a;(a=t.reject)===null||a===void 0||a.call(t,o.reason)},o.addEventListener("abort",r),i=o}const s=()=>{e.releaseLock(),i&&r&&i.removeEventListener("abort",r),this.signal=void 0};return{next:()=>k(this,void 0,void 0,function*(){var o,a;try{const{done:c,value:l}=yield Promise.race([e.read(),t.promise,(a=(o=this.outOfBandFailureRejectingFuture)===null||o===void 0?void 0:o.promise)!==null&&a!==void 0?a:new Promise(()=>{})]);return c?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(l),{done:!1,value:l.content})}catch(c){throw s(),c}}),return(){return k(this,void 0,void 0,function*(){return s(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,o;let a=new Set;const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=lt(c),d;d=yield u.next(),i=d.done,!i;l=!0){o=d.value,l=!1;const h=o;a.add(h)}}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return Array.from(a)})()})}}class mp extends Tl{constructor(e,t,i,r){super(e,t,i,r),this.receivedChunks=new Map}handleChunkReceived(e){var t;const i=di(e.chunkIndex),r=this.receivedChunks.get(i);if(r&&r.version>e.version)return;this.receivedChunks.set(i,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,s)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let i=new De,r=null,s=null;if(this.signal){const a=this.signal;s=()=>{var c;(c=i.reject)===null||c===void 0||c.call(i,a.reason)},a.addEventListener("abort",s),r=a}const o=()=>{e.releaseLock(),r&&s&&r.removeEventListener("abort",s),this.signal=void 0};return{next:()=>k(this,void 0,void 0,function*(){var a,c;try{const{done:l,value:u}=yield Promise.race([e.read(),i.promise,(c=(a=this.outOfBandFailureRejectingFuture)===null||a===void 0?void 0:a.promise)!==null&&c!==void 0?c:new Promise(()=>{})]);if(l)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(u);let d;try{d=t.decode(u.content)}catch(h){throw new Me("Cannot decode datastream chunk ".concat(u.chunkIndex," as text: ").concat(h),ve.DecodeFailed)}return{done:!1,value:d}}}catch(l){throw o(),l}}),return(){return k(this,void 0,void 0,function*(){return o(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,o;let a="";const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=lt(c),d;d=yield u.next(),i=d.done,!i;l=!0)o=d.value,l=!1,a+=o}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return a})()})}}class gp{constructor(){this.log=j,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new Me('A text stream handler for topic "'.concat(e,'" has already been set.'),ve.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new Me('A byte stream handler for topic "'.concat(e,'" has already been set.'),ve.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,i,r,s;const o=Array.from(this.textStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e),a=Array.from(this.byteStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e);if(o.length>0||a.length>0){const c=new Me("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),ve.AbnormalEnd);for(const[l,u]of a)(i=(t=u.outOfBandFailureRejectingFuture).reject)===null||i===void 0||i.call(t,c),this.byteStreamControllers.delete(l);for(const[l,u]of o)(s=(r=u.outOfBandFailureRejectingFuture).reject)===null||s===void 0||s.call(r,c),this.textStreamControllers.delete(l)}}handleDataStreamPacket(e,t){return k(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,i){return k(this,void 0,void 0,function*(){var r;if(e.contentHeader.case==="byteHeader"){const s=this.byteStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let o;const a=new De;a.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,name:(r=e.contentHeader.value.name)!==null&&r!==void 0?r:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:di(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(o=u,this.textStreamControllers.has(e.streamId))throw new Me("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),ve.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:c,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});s(new pp(c,l,di(e.totalLength),a),{identity:t})}else if(e.contentHeader.case==="textHeader"){const s=this.textStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let o;const a=new De;a.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(o=u,this.textStreamControllers.has(e.streamId))throw new Me("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),ve.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:c,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});s(new mp(c,l,di(e.totalLength),a),{identity:t})}})}handleStreamChunk(e,t){const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new Me("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),ve.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e));const r=this.textStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?(r.controller.error(new Me("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),ve.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&r.controller.enqueue(e))}handleStreamTrailer(e,t){const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new Me("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),ve.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close(),this.textStreamControllers.delete(e.streamId)));const r=this.byteStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?r.controller.error(new Me("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),ve.EncryptionTypeMismatch)):(r.info.attributes=Object.assign(Object.assign({},r.info.attributes),e.attributes),r.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class Cl{constructor(e,t,i){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=i,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return k(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(e=this.onClose)===null||e===void 0||e.call(this)})}}class vp extends Cl{}class bp extends Cl{}const ra=15e3;class yp{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return k(this,void 0,void 0,function*(){var i;const r=crypto.randomUUID(),o=new TextEncoder().encode(e).byteLength,a=(i=t?.attachments)===null||i===void 0?void 0:i.map(()=>crypto.randomUUID()),c=new Array(a?a.length+1:1).fill(0),l=(d,h)=>{var p;c[h]=d;const b=c.reduce((m,T)=>m+T,0);(p=t?.onProgress)===null||p===void 0||p.call(t,b)},u=yield this.streamText({streamId:r,totalSize:o,destinationIdentities:t?.destinationIdentities,topic:t?.topic,attachedStreamIds:a,attributes:t?.attributes});return yield u.write(e),l(1,0),yield u.close(),t?.attachments&&a&&(yield Promise.all(t.attachments.map((d,h)=>k(this,void 0,void 0,function*(){return this._sendFile(a[h],d,{topic:t.topic,mimeType:d.type,onProgress:p=>{l(p,h+1)}})})))),u.info})}streamText(e){return k(this,void 0,void 0,function*(){var t,i,r;const s=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),o={id:s,mimeType:"text/plain",timestamp:Date.now(),topic:(i=e?.topic)!==null&&i!==void 0?i:"",size:e?.totalSize,attributes:e?.attributes,encryptionType:!((r=this.engine.e2eeManager)===null||r===void 0)&&r.isDataChannelEncryptionEnabled?ae.GCM:ae.NONE},a=new vi({streamId:s,mimeType:o.mimeType,topic:o.topic,timestamp:Nt(o.timestamp),totalLength:Nt(e?.totalSize),attributes:o.attributes,contentHeader:{case:"textHeader",value:new gc({version:e?.version,attachedStreamIds:e?.attachedStreamIds,replyToStreamId:e?.replyToStreamId,operationType:e?.type==="update"?Pr.UPDATE:Pr.CREATE})}}),c=e?.destinationIdentities,l=new be({destinationIdentities:c,value:{case:"streamHeader",value:a}});yield this.engine.sendDataPacket(l,V.RELIABLE);let u=0;const d=this.engine,h=new WritableStream({write(m){return k(this,void 0,void 0,function*(){for(const T of df(m,ra)){const S=new bi({content:T,streamId:s,chunkIndex:Nt(u)}),P=new be({destinationIdentities:c,value:{case:"streamChunk",value:S}});yield d.sendDataPacket(P,V.RELIABLE),u+=1}})},close(){return k(this,void 0,void 0,function*(){const m=new yi({streamId:s}),T=new be({destinationIdentities:c,value:{case:"streamTrailer",value:m}});yield d.sendDataPacket(T,V.RELIABLE)})},abort(m){console.log("Sink error:",m)}});let p=()=>k(this,void 0,void 0,function*(){yield b.close()});d.once(N.Closing,p);const b=new vp(h,o,()=>this.engine.off(N.Closing,p));return b})}sendFile(e,t){return k(this,void 0,void 0,function*(){const i=crypto.randomUUID();return yield this._sendFile(i,e,t),{id:i}})}_sendFile(e,t,i){return k(this,void 0,void 0,function*(){var r;const s=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(r=i?.mimeType)!==null&&r!==void 0?r:t.type,topic:i?.topic,destinationIdentities:i?.destinationIdentities}),o=t.stream().getReader();for(;;){const{done:a,value:c}=yield o.read();if(a)break;yield s.write(c)}return yield s.close(),s.info})}streamBytes(e){return k(this,void 0,void 0,function*(){var t,i,r,s,o,a;const c=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),l=e?.destinationIdentities,u={id:c,mimeType:(i=e?.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(r=e?.topic)!==null&&r!==void 0?r:"",timestamp:Date.now(),attributes:e?.attributes,size:e?.totalSize,name:(s=e?.name)!==null&&s!==void 0?s:"unknown",encryptionType:!((o=this.engine.e2eeManager)===null||o===void 0)&&o.isDataChannelEncryptionEnabled?ae.GCM:ae.NONE},d=new vi({totalLength:Nt((a=u.size)!==null&&a!==void 0?a:0),mimeType:u.mimeType,streamId:c,topic:u.topic,timestamp:Nt(Date.now()),attributes:u.attributes,contentHeader:{case:"byteHeader",value:new vc({name:u.name})}}),h=new be({destinationIdentities:l,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(h,V.RELIABLE);let p=0;const b=new ye,m=this.engine,T=this.log,S=new WritableStream({write(_){return k(this,void 0,void 0,function*(){const v=yield b.lock();let g=0;try{for(;g<_.byteLength;){const y=_.slice(g,g+ra),C=new be({destinationIdentities:l,value:{case:"streamChunk",value:new bi({content:y,streamId:c,chunkIndex:Nt(p)})}});yield m.sendDataPacket(C,V.RELIABLE),p+=1,g+=y.byteLength}}finally{v()}})},close(){return k(this,void 0,void 0,function*(){const _=new yi({streamId:c}),v=new be({destinationIdentities:l,value:{case:"streamTrailer",value:_}});yield m.sendDataPacket(v,V.RELIABLE)})},abort(_){T.error("Sink error:",_)}});return new bp(S,u)})}}class El extends E{constructor(e,t,i,r,s){super(e,i,s),this.sid=t,this.receiver=r}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?L.Muted:L.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(L.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return k(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),Os)),qh()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const i=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(i){const{timestamp:r,rtpTimestamp:s}=i;s&&this.rtpTimestamp!==s&&(this.emit(L.TimeSyncUpdate,{timestamp:r,rtpTimestamp:s}),this.rtpTimestamp=s)}};e()}}class wl extends El{constructor(e,t,i,r,s,o){super(e,t,E.Kind.Audio,i,o),this.monitorReceiver=()=>k(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Bi(a,this.prevStats)),this.prevStats=a}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):i.volume=e;Ze()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(Ze())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return k(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Wr(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&Wr(e)&&e.setSinkId(this.sinkId).catch(i=>{this.log.error("Failed to set sink id on remote audio track",i,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(L.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(L.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return k(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(i=>{i.type==="inbound-rtp"&&(t={type:"audio",streamId:i.id,timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),t})}}const vr=100;class kp extends El{constructor(e,t,i,r,s){super(e,t,E.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>k(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Bi(o,this.prevStats)),this.prevStats=o}),this.debouncedHandleResize=Ps(()=>{this.updateDimensions()},vr),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e),this.log.debug("setStreamState",e),this.isAdaptiveStream&&e===E.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?rn(this._mediaStreamTrack,t):Xt(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new Sp(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(i=>i===e);for(const i of t)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const i of t)this.stopObservingElement(i);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return k(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,t={type:"video",streamId:s.id,framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),t&&i!==""&&r.get(i)&&(t.mimeType=r.get(i).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(i=>i.element===e);for(const i of t)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,i;const r=this.elementInfos.reduce((c,l)=>Math.max(c,l.visibilityChangedAt||0),0),s=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0)||i?this.isInBackground:!1,o=this.elementInfos.some(c=>c.pictureInPicture),a=this.elementInfos.some(c=>c.visible)&&!s||o;if(!(this.lastVisible===a&&!e)){if(!a&&Date.now()-r<vr){fe.setTimeout(()=>{this.updateVisibility()},vr);return}this.lastVisible=a,this.emit(L.VisibilityChanged,a,this)}}updateDimensions(){var e,t;let i=0,r=0;const s=this.getPixelDensity();for(const o of this.elementInfos){const a=o.width()*s,c=o.height()*s;a+c>i+r&&(i=a,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:i,height:r},this.emit(L.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?Mo():t||(Mo()>2?2:1)}}class Sp{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:o}=i;s===this.element&&(this.isIntersecting=o,this.isPiP=Tn(this.element),this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i,r,s;(r=(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)===null||r===void 0||r.addEventListener("pagehide",this.onLeavePiP),this.isPiP=Tn(this.element),(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=Tn(this.element),(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=t??$r(e),this.isPiP=we()&&Tn(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,i;this.isIntersecting=$r(this.element),this.isPiP=Tn(this.element),this.element.handleResize=()=>{var r;(r=this.handleResize)===null||r===void 0||r.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,Ao().observe(this.element),Do().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(e=window.documentPictureInPicture)===null||e===void 0||e.addEventListener("enter",this.onEnterPiP),(i=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||i===void 0||i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,i,r,s;(e=Ao())===null||e===void 0||e.unobserve(this.element),(t=Do())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(i=window.documentPictureInPicture)===null||i===void 0||i.removeEventListener("enter",this.onEnterPiP),(s=(r=window.documentPictureInPicture)===null||r===void 0?void 0:r.window)===null||s===void 0||s.removeEventListener("pagehide",this.onLeavePiP)}}function Tn(n){var e,t;return document.pictureInPictureElement===n?!0:!((e=window.documentPictureInPicture)===null||e===void 0)&&e.window?$r(n,(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window):!1}function $r(n,e){const t=e||window;let i=n.offsetTop,r=n.offsetLeft;const s=n.offsetWidth,o=n.offsetHeight,{hidden:a}=n,{display:c}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,i+=n.offsetTop,r+=n.offsetLeft;return i<t.pageYOffset+t.innerHeight&&r<t.pageXOffset+t.innerWidth&&i+o>t.pageYOffset&&r+s>t.pageXOffset&&!a&&c!=="none"}class ot extends tt.EventEmitter{constructor(e,t,i,r){var s;super(),this.metadataMuted=!1,this.encryption=ae.NONE,this.log=j,this.handleMuted=()=>{this.emit(L.Muted)},this.handleUnmuted=()=>{this.emit(L.Unmuted)},this.log=dt((s=r?.loggerName)!==null&&s!==void 0?s:Ve.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=i,this.source=E.Source.Unknown}setTrack(e){this.track&&(this.track.off(L.Muted,this.handleMuted),this.track.off(L.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(L.Muted,this.handleMuted),e.on(L.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),q(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==ae.NONE}get audioTrack(){if(Ye(this.track))return this.track}get videoTrack(){if(xt(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=E.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===E.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(n){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),(function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"})(n.PermissionStatus||(n.PermissionStatus={}))})(ot||(ot={}));class Ti extends ot{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(L.Ended)},this.handleCpuConstrained=()=>{this.track&&xt(this.track)&&this.emit(L.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(i)}setTrack(e){this.track&&(this.track.off(L.Ended,this.handleTrackEnded),this.track.off(L.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(L.Ended,this.handleTrackEnded),e.on(L.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return k(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return k(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return k(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return k(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(Ye(this.track)){const t=this.track.getSourceTrackSettings(),i=new Set;return t.autoGainControl&&i.add(ue.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&i.add(ue.TF_ECHO_CANCELLATION),t.noiseSuppression&&i.add(ue.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&i.add(ue.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||i.add(ue.TF_NO_DTX),this.track.enhancedNoiseCancellation&&i.add(ue.TF_ENHANCED_NOISE_CANCELLATION),Array.from(i.values())}else return[]}}function Vi(n,e){return k(this,void 0,void 0,function*(){n??(n={});let t=!1;const{audioProcessor:i,videoProcessor:r,optionsWithoutProcessor:s}=ll(n);let o=s.audio,a=s.video;if(i&&typeof s.audio=="object"&&(s.audio.processor=i),r&&typeof s.video=="object"&&(s.video.processor=r),n.audio&&typeof s.audio=="object"&&typeof s.audio.deviceId=="string"){const d=s.audio.deviceId;s.audio.deviceId={exact:d},t=!0,o=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:d}})}if(s.video&&typeof s.video=="object"&&typeof s.video.deviceId=="string"){const d=s.video.deviceId;s.video.deviceId={exact:d},t=!0,a=Object.assign(Object.assign({},s.video),{deviceId:{ideal:d}})}s.audio===!0?s.audio={deviceId:"default"}:typeof s.audio=="object"&&s.audio!==null&&(s.audio=Object.assign(Object.assign({},s.audio),{deviceId:s.audio.deviceId||"default"})),s.video===!0?s.video={deviceId:"default"}:typeof s.video=="object"&&!s.video.deviceId&&(s.video.deviceId="default");const c=ol(s,ml,gl),l=Cs(c),u=navigator.mediaDevices.getUserMedia(l);s.audio&&(de.userMediaPromiseMap.set("audioinput",u),u.catch(()=>de.userMediaPromiseMap.delete("audioinput"))),s.video&&(de.userMediaPromiseMap.set("videoinput",u),u.catch(()=>de.userMediaPromiseMap.delete("videoinput")));try{const d=yield u;return yield Promise.all(d.getTracks().map(h=>k(this,void 0,void 0,function*(){const p=h.kind==="audio";let b=p?c.audio:c.video;(typeof b=="boolean"||!b)&&(b={});let m;const T=p?l.audio:l.video;typeof T!="boolean"&&(m=T);const S=h.getSettings().deviceId;m?.deviceId&&wt(m.deviceId)!==S?m.deviceId=S:m||(m={deviceId:S});const P=Qf(h,m,e);return P.kind===E.Kind.Video?P.source=E.Source.Camera:P.kind===E.Kind.Audio&&(P.source=E.Source.Microphone),P.mediaStream=d,Ye(P)&&i?yield P.setProcessor(i):xt(P)&&r&&(yield P.setProcessor(r)),P})))}catch(d){if(!t)throw d;return Vi(Object.assign(Object.assign({},n),{audio:o,video:a}),e)}})}function Tp(n){return k(this,void 0,void 0,function*(){return(yield Vi({audio:!1,video:!0}))[0]})}function Cp(n){return k(this,void 0,void 0,function*(){return(yield Vi({audio:!0,video:!1}))[0]})}var je;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(je||(je={}));function Ep(n){switch(n){case wn.EXCELLENT:return je.Excellent;case wn.GOOD:return je.Good;case wn.POOR:return je.Poor;case wn.LOST:return je.Lost;default:return je.Unknown}}class Pl extends tt.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===Mn.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===en.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,i,r,s,o){let a=arguments.length>6&&arguments[6]!==void 0?arguments[6]:Mn.STANDARD;var c;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=je.Unknown,this.log=j,this.log=dt((c=o?.loggerName)!==null&&c!==void 0?c:Ve.Participant),this.loggerOptions=o,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=i,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=a,this._attributes=s??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new De,this.once(M.Active,()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0||t.call(e),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(E.Source.Camera);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(E.Source.Microphone);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(E.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===en.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==en.ACTIVE&&this.emit(M.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,i=this.metadata;this.metadata=e,t&&this.emit(M.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(M.ParticipantNameChanged,e)}_setAttributes(e){const t=Wh(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(M.AttributesChanged,t)}setPermissions(e){var t,i,r,s,o,a;const c=this.permissions,l=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((o=this.permissions)===null||o===void 0?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((u,d)=>{var h;return u!==((h=this.permissions)===null||h===void 0?void 0:h.canPublishSources[d])})||e.canSubscribeMetrics!==((a=this.permissions)===null||a===void 0?void 0:a.canSubscribeMetrics);return this.permissions=e,l&&this.emit(M.ParticipantPermissionsChanged,c),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(M.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=Ep(e),t!==this._connectionQuality&&this.emit(M.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&((t=(e=this.activeFuture).reject)===null||t===void 0||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>Ye(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(L.Muted,()=>{this.emit(M.TrackMuted,e)}),e.on(L.Unmuted,()=>{this.emit(M.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case E.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case E.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function wp(n){var e,t,i;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Tc({participantIdentity:(e=n.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=n.participantSid)!==null&&t!==void 0?t:"",allTracks:(i=n.allowAll)!==null&&i!==void 0?i:!1,trackSids:n.allowedTrackSids||[]})}class Pp extends Pl{constructor(e,t,i,r,s,o){super(e,t,void 0,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=ae.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new De)},this.handleReconnected=()=>{var a,c;(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.resolve)===null||c===void 0||c.call(a),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var a,c,l,u,d,h;this.reconnectFuture&&(this.reconnectFuture.promise.catch(p=>this.log.warn(p.message,this.logContext)),(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.reject)===null||c===void 0||c.call(a,new Error("Got disconnected during reconnection attempt")),this.reconnectFuture=void 0),this.signalConnectedFuture&&((u=(l=this.signalConnectedFuture).reject)===null||u===void 0||u.call(l,new Error("Got disconnected without signal connected")),this.signalConnectedFuture=void 0),(h=(d=this.activeAgentFuture)===null||d===void 0?void 0:d.reject)===null||h===void 0||h.call(d,new Error("Got disconnected without active agent present")),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=a=>{var c,l;a.participant&&this.updateInfo(a.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new De),(l=(c=this.signalConnectedFuture).resolve)===null||l===void 0||l.call(c)},this.handleSignalRequestResponse=a=>{const{requestId:c,reason:l,message:u}=a,d=this.pendingSignalRequests.get(c);d&&(l!==ys.OK&&d.reject(new Ro(u,l)),this.pendingSignalRequests.delete(c))},this.handleDataPacket=a=>{switch(a.value.case){case"rpcResponse":let c=a.value.value,l=null,u=null;c.value.case==="payload"?l=c.value.value:c.value.case==="error"&&(u=te.fromProto(c.value.value)),this.handleIncomingRpcResponse(c.requestId,l,u);break;case"rpcAck":let d=a.value.value;this.handleIncomingRpcAck(d.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(a=>wp(a)))},this.onTrackUnmuted=a=>{this.onTrackMuted(a,a.isUpstreamPaused)},this.onTrackMuted=(a,c)=>{if(c===void 0&&(c=!0),!a.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),q(a)));return}this.engine.updateMuteStatus(a.sid,c)},this.onTrackUpstreamPaused=a=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),q(a))),this.onTrackMuted(a,!0)},this.onTrackUpstreamResumed=a=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),q(a))),this.onTrackMuted(a,a.isMuted)},this.onTrackFeatureUpdate=a=>{const c=this.audioTrackPublications.get(a.sid);if(!c){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(a.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(c.trackSid,c.getTrackFeatures())},this.onTrackCpuConstrained=(a,c)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),q(c))),this.emit(M.LocalTrackCpuConstrained,a,c)},this.handleSubscribedQualityUpdate=a=>k(this,void 0,void 0,function*(){var c,l,u,d,h;if(!(!((h=this.roomOptions)===null||h===void 0)&&h.dynacast))return;const p=this.videoTrackPublications.get(a.trackSid);if(!p){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}if(!p.videoTrack)return;const b=yield p.videoTrack.setPublishingCodecs(a.subscribedCodecs);try{for(var m=!0,T=lt(b),S;S=yield T.next(),c=S.done,!c;m=!0){d=S.value,m=!1;const P=d;Fh(P)&&(this.log.debug("publish ".concat(P," for ").concat(p.videoTrack.sid),Object.assign(Object.assign({},this.logContext),q(p))),yield this.publishAdditionalCodecForTrack(p.videoTrack,P,p.options))}}catch(P){l={error:P}}finally{try{!m&&!c&&(u=T.return)&&(yield u.call(T))}finally{if(l)throw l.error}}}),this.handleLocalTrackUnpublished=a=>{const c=this.trackPublications.get(a.trackSid);if(!c){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}this.unpublishTrack(c.track)},this.handleTrackEnded=a=>k(this,void 0,void 0,function*(){if(a.source===E.Source.ScreenShare||a.source===E.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),q(a))),this.unpublishTrack(a);else if(a.isUserProvided)yield a.mute();else if(st(a)||yt(a))try{if(we())try{const c=yield navigator?.permissions.query({name:a.source===E.Source.Camera?"camera":"microphone"});if(c&&c.state==="denied")throw this.log.warn("user has revoked access to ".concat(a.source),Object.assign(Object.assign({},this.logContext),q(a))),c.onchange=()=>{c.state!=="denied"&&(a.isMuted||a.restartTrack(),c.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}a.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),q(a))),st(a)?yield a.restartTrack({deviceId:"default"}):yield a.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),q(a))),yield a.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=s,this.roomOutgoingDataStreamManager=o}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==ae.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(N.RemoteMute,(i,r)=>{const s=this.trackPublications.get(i);!s||!s.track||(r?s.mute():s.unmute())}),!((t=this.signalConnectedFuture)===null||t===void 0)&&t.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(N.Connected,this.handleReconnected).on(N.SignalConnected,this.handleSignalConnected).on(N.SignalRestarted,this.handleReconnected).on(N.SignalResumed,this.handleReconnected).on(N.Restarting,this.handleReconnecting).on(N.Resuming,this.handleReconnecting).on(N.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(N.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(N.Closing,this.handleClosing).on(N.SignalRequestResponse,this.handleSignalRequestResponse).on(N.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return k(this,arguments,void 0,function(t){var i=this;let{metadata:r,name:s,attributes:o}=t;return(function*(){return new Promise((a,c)=>k(i,void 0,void 0,function*(){var l,u;try{let d=!1;const h=yield this.engine.client.sendUpdateLocalMetadata((l=r??this.metadata)!==null&&l!==void 0?l:"",(u=s??this.name)!==null&&u!==void 0?u:"",o),p=performance.now();for(this.pendingSignalRequests.set(h,{resolve:a,reject:b=>{c(b),d=!0},values:{name:s,metadata:r,attributes:o}});performance.now()-p<5e3&&!d;){if((!s||this.name===s)&&(!r||this.metadata===r)&&(!o||Object.entries(o).every(b=>{let[m,T]=b;return this.attributes[m]===T||T===""&&!this.attributes[m]}))){this.pendingSignalRequests.delete(h),a();return}yield pe(50)}c(new Ro("Request to update local metadata timed out","TimeoutError"))}catch(d){d instanceof Error&&c(d)}}))})()})}setCameraEnabled(e,t,i){return this.setTrackEnabled(E.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(E.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(E.Source.ScreenShare,e,t,i)}setE2EEEnabled(e){return k(this,void 0,void 0,function*(){this.encryptionType=e?ae.GCM:ae.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,i,r){return k(this,void 0,void 0,function*(){var s,o;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(t)if(a)yield a.unmute();else{let c;if(this.pendingPublishing.has(e)){const l=yield this.waitForPendingPublicationOfSource(e);return l||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield l?.unmute(),l}this.pendingPublishing.add(e);try{switch(e){case E.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case E.Source.Microphone:c=yield this.createTracks({audio:(o=i)!==null&&o!==void 0?o:!0});break;case E.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new ut(e)}}catch(l){throw c?.forEach(u=>{u.stop()}),l instanceof Error&&this.emit(M.MediaDevicesError,l,Br(e)),this.pendingPublishing.delete(e),l}for(const l of c){const u=Object.assign(Object.assign({},this.roomOptions.publishDefaults),i);e===E.Source.Microphone&&Ye(l)&&u.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),l.startPreConnectBuffer())}try{const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),q(d))),l.push(this.publishTrack(d,r));[a]=yield Promise.all(l)}catch(l){throw c?.forEach(u=>{u.stop()}),l}finally{this.pendingPublishing.delete(e)}}else if(!a?.track&&this.pendingPublishing.has(e)&&(a=yield this.waitForPendingPublicationOfSource(e),a||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),a&&a.track)if(e===E.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const c=this.getTrackPublication(E.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return k(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(E.Source.Camera)||this.pendingPublishing.has(E.Source.Microphone))){this.pendingPublishing.add(E.Source.Camera),this.pendingPublishing.add(E.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(E.Source.Camera),this.pendingPublishing.delete(E.Source.Microphone)}}})}createTracks(e){return k(this,void 0,void 0,function*(){var t,i;e??(e={});const r=ol(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{return(yield Vi(r,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(a=>(Ye(a)&&(this.microphoneError=void 0,a.setAudioContext(this.audioContext),a.source=E.Source.Microphone,this.emit(M.AudioStreamAcquired)),xt(a)&&(this.cameraError=void 0,a.source=E.Source.Camera),a))}catch(s){throw s instanceof Error&&(e.audio&&(this.microphoneError=s),e.video&&(this.cameraError=s)),s}})}createScreenTracks(e){return k(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new Ss("getDisplayMedia not supported");e.resolution===void 0&&!Xh()&&(e.resolution=Ts.h1080fps30.resolution);const t=Bh(e),i=yield navigator.mediaDevices.getDisplayMedia(t),r=i.getVideoTracks();if(r.length===0)throw new ut("no video track found");const s=new Si(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=E.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const o=[s];if(i.getAudioTracks().length>0){this.emit(M.AudioStreamAcquired);const a=new ki(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=E.Source.ScreenShareAudio,o.push(a)}return o})}publishTrack(e,t){return k(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var a,c,l,u;st(i)&&i.setAudioContext(s.audioContext),yield(a=s.reconnectFuture)===null||a===void 0?void 0:a.promise,s.republishPromise&&!o&&(yield s.republishPromise),Ut(i)&&s.pendingPublishPromises.has(i)&&(yield s.pendingPublishPromises.get(i));let d;if(i instanceof MediaStreamTrack)d=i.getConstraints();else{d=i.constraints;let S;switch(i.source){case E.Source.Microphone:S="audioinput";break;case E.Source.Camera:S="videoinput"}S&&s.activeDeviceMap.has(S)&&(d=Object.assign(Object.assign({},d),{deviceId:s.activeDeviceMap.get(S)}))}if(i instanceof MediaStreamTrack)switch(i.kind){case"audio":i=new ki(i,d,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":i=new Si(i,d,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new ut("unsupported MediaStreamTrack kind ".concat(i.kind))}else i.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});let h;if(s.trackPublications.forEach(S=>{S.track&&S.track===i&&(h=S)}),h)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),q(h))),h;const p=Object.assign(Object.assign({},s.roomOptions.publishDefaults),r),b="channelCount"in i.mediaStreamTrack.getSettings()&&i.mediaStreamTrack.getSettings().channelCount===2||i.mediaStreamTrack.getConstraints().channelCount===2,m=(c=p.forceStereo)!==null&&c!==void 0?c:b;m&&(p.dtx===void 0&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),q(i))),p.red===void 0&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(l=p.dtx)!==null&&l!==void 0||(p.dtx=!1),(u=p.red)!==null&&u!==void 0||(p.red=!1)),!ef()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),p.simulcast=!1),p.source&&(i.source=p.source);const T=new Promise((S,P)=>k(s,void 0,void 0,function*(){try{if(this.engine.client.currentState!==J.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:q(i)}));let _=!1;const v=setTimeout(()=>{_=!0,i.stop(),P(new Po("publishing rejected as engine not connected within timeout",408))},15e3);if(yield this.waitUntilEngineConnected(),clearTimeout(v),_)return;const g=yield this.publish(i,p,m);S(g)}else try{const _=yield this.publish(i,p,m);S(_)}catch(_){P(_)}}catch(_){P(_)}}));s.pendingPublishPromises.set(i,T);try{return yield T}catch(S){throw S}finally{s.pendingPublishPromises.delete(i)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new De),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),q(e))),!1;const{canPublish:t,canPublishSources:i}=this.permissions;return t&&(i.length===0||i.map(r=>Hh(r)).includes(e.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),q(e))),!1)}publish(e,t,i){return k(this,void 0,void 0,function*(){var r,s,o,a,c,l,u,d,h,p;if(!this.hasPermissionsToPublish(e))throw new Po("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(R=>Ut(e)&&R.source===e.source)&&e.source!==E.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),q(e))),t.stopMicTrackOnMute&&Ye(e)&&(e.stopOnMute=!0),e.source===E.Source.ScreenShare&&Bt()&&(t.simulcast=!1),t.videoCodec==="av1"&&!$h()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!Qh()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=zr),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(R=>t.videoCodec===In(R.mime))||(t.videoCodec=In(this.enabledPublishVideoCodecs[0].mime)));const m=t.videoCodec;e.on(L.Muted,this.onTrackMuted),e.on(L.Unmuted,this.onTrackUnmuted),e.on(L.Ended,this.handleTrackEnded),e.on(L.UpstreamPaused,this.onTrackUpstreamPaused),e.on(L.UpstreamResumed,this.onTrackUpstreamResumed),e.on(L.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const T=[],S=!(!((r=t.dtx)!==null&&r!==void 0)||r),P=e.getSourceTrackSettings();P.autoGainControl&&T.push(ue.TF_AUTO_GAIN_CONTROL),P.echoCancellation&&T.push(ue.TF_ECHO_CANCELLATION),P.noiseSuppression&&T.push(ue.TF_NOISE_SUPPRESSION),P.channelCount&&P.channelCount>1&&T.push(ue.TF_STEREO),S&&T.push(ue.TF_NO_DTX),st(e)&&e.hasPreConnectBuffer&&T.push(ue.TF_PRECONNECT_BUFFER);const _=new Dn({cid:e.mediaStreamTrack.id,name:t.name,type:E.kindToProto(e.kind),muted:e.isMuted,source:E.sourceToProto(e.source),disableDtx:S,encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=t.red)!==null&&s!==void 0)||s),stream:t?.stream,backupCodecPolicy:t?.backupCodecPolicy,audioFeatures:T});let v;if(e.kind===E.Kind.Video){let R={width:0,height:0};try{R=yield e.waitForDimensions()}catch{const D=(a=(o=this.roomOptions.videoCaptureDefaults)===null||o===void 0?void 0:o.resolution)!==null&&a!==void 0?a:Ln.h720.resolution;R={width:D.width,height:D.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),q(e)),{dims:R}))}_.width=R.width,_.height=R.height,yt(e)&&(Fe(m)&&(e.source===E.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),q(e))))),t.scalabilityMode=(c=t.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),_.simulcastCodecs=[new _r({codec:m,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:zr}),t.backupCodec&&m!==t.backupCodec.codec&&_.encryption===ae.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),_.simulcastCodecs.push(new _r({codec:t.backupCodec.codec,cid:""})))),v=Jr(e.source===E.Source.ScreenShare,_.width,_.height,t),_.layers=ea(_.width,_.height,v,Fe(t.videoCodec))}else e.kind===E.Kind.Audio&&(v=[{maxBitrate:(l=t.audioPreset)===null||l===void 0?void 0:l.maxBitrate,priority:(d=(u=t.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(p=(h=t.audioPreset)===null||h===void 0?void 0:h.priority)!==null&&p!==void 0?p:"high"}]);if(!this.engine||this.engine.isClosed)throw new oe("cannot publish track when not connected");const g=()=>k(this,void 0,void 0,function*(){var R,O,D;if(!this.engine.pcManager)throw new oe("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,v),this.emit(M.LocalSenderCreated,e.sender,e),yt(e)&&((R=t.degradationPreference)!==null&&R!==void 0||(t.degradationPreference=op(e)),e.setDegradationPreference(t.degradationPreference)),v)if(Bt()&&e.kind===E.Kind.Audio){let U;for(const z of this.engine.pcManager.publisher.getTransceivers())if(z.sender===e.sender){U=z;break}U&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:U,codec:"opus",maxbr:!((O=v[0])===null||O===void 0)&&O.maxBitrate?v[0].maxBitrate/1e3:0})}else e.codec&&Fe(e.codec)&&(!((D=v[0])===null||D===void 0)&&D.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:_.cid,codec:e.codec,maxbr:v[0].maxBitrate/1e3});yield this.engine.negotiate()});let y;const C=new Promise((R,O)=>k(this,void 0,void 0,function*(){var D;try{y=yield this.engine.addTrack(_),R(y)}catch(U){e.sender&&(!((D=this.engine.pcManager)===null||D===void 0)&&D.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(z=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),q(e)),{error:z}))})),O(U)}}));if(this.enabledPublishVideoCodecs.length>0)y=(yield Promise.all([C,g()]))[0];else{y=yield C;let R;if(y.codecs.forEach(O=>{R===void 0&&(R=O.mimeType)}),R&&e.kind===E.Kind.Video){const O=In(R);O!==m&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),q(e)),{codec:O})),t.videoCodec=O,v=Jr(e.source===E.Source.ScreenShare,_.width,_.height,t))}yield g()}const x=new Ti(e.kind,y,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(x.on(L.CpuConstrained,R=>this.onTrackCpuConstrained(R,x)),x.options=t,e.sid=y.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:v,trackInfo:y})),yt(e)?e.startMonitor(this.engine.client):st(e)&&e.startMonitor(),this.addTrackPublication(x),this.emit(M.LocalTrackPublished,x),st(e)&&y.audioFeatures.includes(ue.TF_PRECONNECT_BUFFER)){const R=e.getPreConnectBuffer(),O=e.getPreConnectBufferMimeType();this.on(M.LocalTrackSubscribed,D=>{if(D.trackSid===y.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),q(e))),e.stopPreConnectBuffer()}}),R&&new Promise((U,z)=>k(this,void 0,void 0,function*(){var Q,Oe,Te,me,ge,Ce;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),q(e)));const Jt=setTimeout(()=>{z(new Error("agent not active within 10 seconds"))},1e4),Zi=yield this.waitUntilActiveAgentPresent();clearTimeout(Jt),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),q(e)));const Kn=yield this.streamBytes({name:"preconnect-buffer",mimeType:O,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[Zi.identity],attributes:{trackId:x.trackSid,sampleRate:String((ge=P.sampleRate)!==null&&ge!==void 0?ge:"48000"),channels:String((Ce=P.channelCount)!==null&&Ce!==void 0?Ce:"1")}});try{for(var Dt=!0,Gt=lt(R),gt;gt=yield Gt.next(),Q=gt.done,!Q;Dt=!0){me=gt.value,Dt=!1;const At=me;yield Kn.write(At)}}catch(At){Oe={error:At}}finally{try{!Dt&&!Q&&(Te=Gt.return)&&(yield Te.call(Gt))}finally{if(Oe)throw Oe.error}}yield Kn.close(),U()}catch(Jt){z(Jt)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),q(e)))}).catch(U=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),q(e)),{error:U}))})}return x})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,i){return k(this,void 0,void 0,function*(){var r;if(this.encryptionType!==ae.NONE)return;let s;if(this.trackPublications.forEach(p=>{p.track&&p.track===e&&(s=p)}),!s)throw new ut("track is not published");if(!yt(e))throw new ut("track is not a video track");const o=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),a=ip(e,t,o);if(!a){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),q(e)));return}const c=e.addSimulcastTrack(t,a);if(!c)return;const l=new Dn({cid:c.mediaStreamTrack.id,type:E.kindToProto(e.kind),muted:e.isMuted,source:E.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=ea(l.width,l.height,a),!this.engine||this.engine.isClosed)throw new oe("cannot publish track when not connected");const u=()=>k(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,c,o,a),yield this.engine.negotiate()}),h=(yield Promise.all([this.engine.addTrack(l),u()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:h}))})}unpublishTrack(e,t){return k(this,void 0,void 0,function*(){var i,r;if(Ut(e)){const l=this.pendingPublishPromises.get(e);l&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),q(e))),yield l)}const s=this.getPublicationForTrack(e),o=s?q(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));return}e=s.track,e.off(L.Muted,this.onTrackMuted),e.off(L.Unmuted,this.onTrackUnmuted),e.off(L.Ended,this.handleTrackEnded),e.off(L.UpstreamPaused,this.onTrackUpstreamPaused),e.off(L.UpstreamResumed,this.onTrackUpstreamResumed),e.off(L.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t?e.stop():e.stopMonitor();let a=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<Z.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",a=!0);if(this.engine.removeTrack(c)&&(a=!0),yt(e)){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(a=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:l}))}switch(this.trackPublications.delete(s.trackSid),s.kind){case E.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case E.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}return this.emit(M.LocalTrackUnpublished,s),s.setTrack(void 0),a&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return k(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>!!i)})}republishAllTracks(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){i.republishPromise&&(yield i.republishPromise),i.republishPromise=new Promise((s,o)=>k(i,void 0,void 0,function*(){try{const a=[];this.trackPublications.forEach(c=>{c.track&&(t&&(c.options=Object.assign(Object.assign({},c.options),t)),a.push(c))}),yield Promise.all(a.map(c=>k(this,void 0,void 0,function*(){const l=c.track;yield this.unpublishTrack(l,!1),r&&!l.isMuted&&l.source!==E.Source.ScreenShare&&l.source!==E.Source.ScreenShareAudio&&(st(l)||yt(l))&&!l.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:c.trackSid})),yield l.restartTrack()),yield this.publishOrRepublishTrack(l,c.options,!0)}))),s()}catch(a){o(a)}finally{this.republishPromise=void 0}})),yield i.republishPromise})()})}publishData(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const s=r.reliable?V.RELIABLE:V.LOSSY,o=r.destinationIdentities,a=r.topic;let c=new us({participantIdentity:i.identity,payload:t,destinationIdentities:o,topic:a});const l=new be({kind:s,value:{case:"user",value:c}});yield i.engine.sendDataPacket(l,s)})()})}publishDtmf(e,t){return k(this,void 0,void 0,function*(){const i=new be({kind:V.RELIABLE,value:{case:"sipDtmf",value:new ac({code:e,digit:t})}});yield this.engine.sendDataPacket(i,V.RELIABLE)})}sendChatMessage(e,t){return k(this,void 0,void 0,function*(){const i={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t?.attachments},r=new be({value:{case:"chatMessage",value:new gi(Object.assign(Object.assign({},i),{timestamp:X.parse(i.timestamp)}))}});return yield this.engine.sendDataPacket(r,V.RELIABLE),this.emit(M.ChatMessage,i),i})}editChatMessage(e,t){return k(this,void 0,void 0,function*(){const i=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),r=new be({value:{case:"chatMessage",value:new gi(Object.assign(Object.assign({},i),{timestamp:X.parse(i.timestamp),editTimestamp:X.parse(i.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,V.RELIABLE),this.emit(M.ChatMessage,i),i})}sendText(e,t){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){return k(this,arguments,void 0,function(t){var i=this;let{destinationIdentity:r,method:s,payload:o,responseTimeout:a=15e3}=t;return(function*(){return new Promise((u,d)=>k(i,void 0,void 0,function*(){var h,p,b,m;if(Is(o)>bl){d(te.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((p=(h=this.engine.latestJoinResponse)===null||h===void 0?void 0:h.serverInfo)===null||p===void 0)&&p.version&&qe((m=(b=this.engine.latestJoinResponse)===null||b===void 0?void 0:b.serverInfo)===null||m===void 0?void 0:m.version,"1.8.0")<0){d(te.builtIn("UNSUPPORTED_SERVER"));return}const T=Math.max(a,8e3),S=crypto.randomUUID();yield this.publishRpcRequest(r,S,s,o,T);const P=setTimeout(()=>{this.pendingAcks.delete(S),d(te.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(S),clearTimeout(_)},7e3);this.pendingAcks.set(S,{resolve:()=>{clearTimeout(P)},participantIdentity:r});const _=setTimeout(()=>{this.pendingResponses.delete(S),d(te.builtIn("RESPONSE_TIMEOUT"))},a);this.pendingResponses.set(S,{resolve:(v,g)=>{clearTimeout(_),this.pendingAcks.has(S)&&(this.log.warn("RPC response received before ack",S),this.pendingAcks.delete(S),clearTimeout(P)),g?d(g):u(v??"")},participantIdentity:r})}))})()})}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,i){const r=this.pendingResponses.get(e);r?(r.resolve(t,i),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,i,r,s){return k(this,void 0,void 0,function*(){const o=new be({destinationIdentities:[e],kind:V.RELIABLE,value:{case:"rpcRequest",value:new ds({id:t,method:i,payload:r,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(o,V.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:i,resolve:r}]of this.pendingResponses)i===e&&(r(null,te.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return super.updateInfo(e)?(e.tracks.forEach(t=>{var i,r;const s=this.trackPublications.get(t.sid);if(s){const o=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);o!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),q(s)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(t.sid,o))}}),!0):!1}setActiveAgent(e){var t,i,r,s;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?(i=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||i===void 0||i.call(t,e):(s=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||s===void 0||s.call(r,new Error("Agent disconnected")),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new De),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(st(r)||yt(r))&&r.mediaStreamTrack===e&&(t=i):e===r&&(t=i))}),t}waitForPendingPublicationOfSource(e){return k(this,void 0,void 0,function*(){const i=Date.now();for(;Date.now()<i+1e4;){const r=Array.from(this.pendingPublishPromises.entries()).find(s=>{let[o]=s;return o.source===e});if(r)return r[1];yield pe(20)}})}}class Ci extends ot{constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=s=>{this.setTrack(void 0),this.emit(L.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.visible=s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensionsAdaptiveStream=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Ui({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new lc({participantSid:"",trackSids:[this.trackSid]})]});this.emit(L.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?ot.SubscriptionStatus.Unsubscribed:super.isSubscribed?ot.SubscriptionStatus.Subscribed:ot.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?ot.PermissionStatus.Allowed:ot.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled(e){!this.isManualOperationAllowed()||this.requestedDisabled===!e||(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.requestedMaxQuality===e||(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,i;this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((i=this.requestedVideoDimensions)===null||i===void 0?void 0:i.height)===e.height||(ur(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&ur(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:_e.HIGH}setTrack(e){const t=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(L.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(L.VisibilityChanged,this.handleVisibilityChange),r.off(L.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(L.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(L.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(L.VisibilityChanged,this.handleVisibilityChange),e.on(L.Ended,this.handleEnded),this.emit(L.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(L.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?L.Muted:L.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(L.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(L.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return ur(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new bc({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===E.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t)Io(this.videoDimensionsAdaptiveStream,t)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const i=Kh(this.trackInfo,this.requestedMaxQuality);i&&Io(this.videoDimensionsAdaptiveStream,i)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream;t?(e.width=Math.ceil(t.width),e.height=Math.ceil(t.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:_e.HIGH})),e.quality=_e.HIGH)}this.emit(L.UpdateSettings,e)}}class Ei extends Pl{static fromParticipantInfo(e,t,i){return new Ei(e,t.sid,t.identity,t.name,t.metadata,t.attributes,i,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,i,r,s,o,a){let c=arguments.length>7&&arguments[7]!==void 0?arguments[7]:Mn.STANDARD;super(t,i||"",r,s,o,a,c),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(L.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),q(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(L.UpdateSubscription,t=>{t.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(L.SubscriptionPermissionChanged,t=>{this.emit(M.TrackSubscriptionPermissionChanged,e,t)}),e.on(L.SubscriptionStatusChanged,t=>{this.emit(M.TrackSubscriptionStatusChanged,e,t)}),e.on(L.Subscribed,t=>{this.emit(M.TrackSubscribed,t,e)}),e.on(L.Unsubscribed,t=>{this.emit(M.TrackUnsubscribed,t,e)}),e.on(L.SubscriptionFailed,t=>{this.emit(M.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:E.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrackPublication(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:E.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,r,s,o){let a=this.getTrackPublicationBySid(t);if(a||t.startsWith("TR")||this.trackPublications.forEach(u=>{!a&&e.kind===u.kind.toString()&&(a=u)}),!a){if(o===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(M.TrackSubscriptionFailed,t);return}o===void 0&&(o=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,i,r,s,o-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),q(a))),this.emit(M.TrackSubscriptionFailed,t);return}const c=e.kind==="video";let l;return c?l=new kp(e,t,r,s):l=new wl(e,t,r,this.audioContext,this.audioOutput),l.source=a.source,l.isMuted=a.isMuted,l.setMediaStream(i),l.start(),a.setTrack(l),this.volumeMap.has(a.source)&&Hr(l)&&Ye(l)&&l.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,i=new Map;return e.tracks.forEach(r=>{var s,o;let a=this.getTrackPublicationBySid(r.sid);if(a)a.updateInfo(r);else{const c=E.kindFromProto(r.type);if(!c)return;a=new Ci(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(o=this.loggerOptions)===null||o===void 0?void 0:o.loggerName}),a.updateInfo(r),i.set(r.sid,a);const l=Array.from(this.trackPublications.values()).find(u=>u.source===a?.source);l&&a.source!==E.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(a.source),Object.assign(Object.assign({},this.logContext),{oldTrack:q(l),newTrack:q(a)})),this.addTrackPublication(a)}t.set(r.sid,a)}),this.trackPublications.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),q(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(M.TrackPublished,r)}),!0}unpublishTrack(e,t){const i=this.trackPublications.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.trackPublications.delete(e),i.kind){case E.Kind.Audio:this.audioTrackPublications.delete(e);break;case E.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(M.TrackUnpublished,i)}setAudioOutput(e){return k(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(i=>{var r;Ye(i.track)&&Hr(i.track)&&t.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}var H;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting"})(H||(H={}));const Rp=4*1e3;class ht extends tt.EventEmitter{get hasE2EESetup(){return this.e2eeManager!==void 0}constructor(e){var t,i,r,s;if(super(),t=this,this.state=H.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=j,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(o,a,c)=>k(this,void 0,void 0,function*(){var l;if(!Yh())throw Ze()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const u=yield this.disconnectLock.lock();if(this.state===H.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),u(),Promise.resolve();if(this.connectFuture)return u(),this.connectFuture.promise;this.setAndEmitConnectionState(H.Connecting),((l=this.regionUrlProvider)===null||l===void 0?void 0:l.getServerUrl().toString())!==fl(o)&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),un(new URL(o))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new K(o,a):this.regionUrlProvider.updateToken(a),this.regionUrlProvider.fetchRegionSettings().then(p=>{var b;(b=this.regionUrlProvider)===null||b===void 0||b.setServerReportedRegions(p)}).catch(p=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:p}))}));const d=(p,b,m)=>k(this,void 0,void 0,function*(){var T,S;this.abortController&&this.abortController.abort();const P=new AbortController;this.abortController=P,u?.();try{if(yield sn.getInstance().getBackOffPromise(o),P.signal.aborted)throw F.cancelled("Connection attempt aborted");yield this.attemptConnection(m??o,a,c,P),this.abortController=void 0,p()}catch(_){if(this.regionUrlProvider&&_ instanceof F&&_.reason!==Y.Cancelled&&_.reason!==Y.NotAllowed){let v=null;try{this.log.debug("Fetching next region"),v=yield this.regionUrlProvider.getNextBestRegionUrl((T=this.abortController)===null||T===void 0?void 0:T.signal)}catch(g){if(g instanceof F&&(g.status===401||g.reason===Y.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),b(g);return}}[Y.InternalError,Y.ServerUnreachable,Y.Timeout].includes(_.reason)&&(this.log.debug("Adding failed connection attempt to back off"),sn.getInstance().addFailedConnectionAttempt(o)),v&&!(!((S=this.abortController)===null||S===void 0)&&S.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(_.message,". Retrying with another region: ").concat(v),this.logContext),this.recreateEngine(),yield d(p,b,v)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,No(_)),b(_))}else{let v=Be.UNKNOWN_REASON;_ instanceof F&&(v=No(_)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,v),b(_)}}}),h=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new De((p,b)=>{d(p,b,h)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(o,a,c,l,u,d)=>k(this,void 0,void 0,function*(){var h,p,b;const m=yield c.join(o,a,{autoSubscribe:l.autoSubscribe,adaptiveStream:typeof u.adaptiveStream=="object"?!0:u.adaptiveStream,maxRetries:l.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:l.websocketTimeout,singlePeerConnection:u.singlePeerConnection},d.signal);let T=m.serverInfo;if(T||(T={version:m.serverVersion,region:m.serverRegion}),this.serverInfo=T,this.log.debug("connected to Livekit Server ".concat(Object.entries(T).map(S=>{let[P,_]=S;return"".concat(P,": ").concat(_)}).join(", ")),{room:(h=m.room)===null||h===void 0?void 0:h.name,roomSid:(p=m.room)===null||p===void 0?void 0:p.sid,identity:(b=m.participant)===null||b===void 0?void 0:b.identity}),!T.version)throw new Dh("unknown server version");return T.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),u.dynacast=!1),m}),this.applyJoinResponse=o=>{const a=o.participant;if(this.localParticipant.sid=a.sid,this.localParticipant.identity=a.identity,this.localParticipant.setEnabledPublishCodecs(o.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(o.sifTrailer)}catch(c){this.log.error(c instanceof Error?c.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:c}))}this.handleParticipantUpdates([a,...o.otherParticipants]),o.room&&this.handleRoomUpdate(o.room)},this.attemptConnection=(o,a,c,l)=>k(this,void 0,void 0,function*(){var u,d;this.state===H.Reconnecting||this.isResuming||!((u=this.engine)===null||u===void 0)&&u.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((d=this.regionUrlProvider)===null||d===void 0)&&d.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},_s),c),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const h=yield this.connectSignal(o,a,this.engine,this.connOptions,this.options,l);this.applyJoinResponse(h),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected)}catch(h){yield this.engine.close(),this.recreateEngine();const p=l.signal.aborted?F.cancelled("Signal connection aborted"):F.serverUnreachable("could not establish signal connection");throw h instanceof Error&&(p.message="".concat(p.message,": ").concat(h.message)),h instanceof F&&(p.reason=h.reason,p.status=h.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:h})),p}if(l.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),F.cancelled("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,l)}catch(h){throw yield this.engine.close(),this.recreateEngine(),h}we()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),we()&&window.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(H.Connected),this.emit(I.Connected),sn.getInstance().resetFailedConnectionAttempts(o),this.registerConnectionReconcile(),this.regionUrlProvider&&this.regionUrlProvider.notifyConnected()}),this.disconnect=function(){for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return k(t,[...a],void 0,function(){var l=this;let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var d,h,p;const b=yield l.disconnectLock.lock();try{if(l.state===H.Disconnected){l.log.debug("already disconnected",l.logContext);return}if(l.log.info("disconnect from room",Object.assign({},l.logContext)),l.state===H.Connecting||l.state===H.Reconnecting||l.isResuming){const m="Abort connection attempt due to user initiated disconnect";l.log.warn(m,l.logContext),(d=l.abortController)===null||d===void 0||d.abort(m),(p=(h=l.connectFuture)===null||h===void 0?void 0:h.reject)===null||p===void 0||p.call(h,F.cancelled("Client initiated disconnect")),l.connectFuture=void 0}l.engine&&(l.engine.client.isDisconnected||(yield l.engine.client.sendLeave()),yield l.engine.close()),l.handleDisconnect(u,Be.CLIENT_INITIATED),l.engine=void 0}finally{b()}})()})},this.onPageLeave=()=>k(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>k(this,void 0,void 0,function*(){const o=[],a=ke();if(a&&a.os==="iOS"){const c="livekit-dummy-audio-el";let l=document.getElementById(c);if(!l){l=document.createElement("audio"),l.id=c,l.autoplay=!0,l.hidden=!0;const u=lr();u.enabled=!0;const d=new MediaStream([u]);l.srcObject=d,document.addEventListener("visibilitychange",()=>{l&&(l.srcObject=document.hidden?null:d,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(l),this.once(I.Disconnected,()=>{l?.remove(),l=null})}o.push(l)}this.remoteParticipants.forEach(c=>{c.audioTrackPublications.forEach(l=>{l.track&&l.track.attachedElements.forEach(u=>{o.push(u)})})});try{yield Promise.all([this.acquireAudioContext(),...o.map(c=>(c.muted=!1,c.play()))]),this.handleAudioPlaybackStarted()}catch(c){throw this.handleAudioPlaybackFailed(c),c}}),this.startVideo=()=>k(this,void 0,void 0,function*(){const o=[];for(const a of this.remoteParticipants.values())a.videoTrackPublications.forEach(c=>{var l;(l=c.track)===null||l===void 0||l.attachedElements.forEach(u=>{o.includes(u)||o.push(u)})});yield Promise.all(o.map(a=>a.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(a=>{a.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const o of this.remoteParticipants.values())this.handleParticipantDisconnected(o.identity,o);this.setAndEmitConnectionState(H.Reconnecting)&&this.emit(I.Reconnecting)},this.handleSignalRestarted=o=>k(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(o.serverRegion),Object.assign(Object.assign({},this.logContext),{region:o.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(o);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(a){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:a}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:o.serverRegion}))}catch{return}this.setAndEmitConnectionState(H.Connected),this.emit(I.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=o=>{o.forEach(a=>{var c;if(a.identity===this.localParticipant.identity){this.localParticipant.updateInfo(a);return}a.identity===""&&(a.identity=(c=this.sidToIdentity.get(a.sid))!==null&&c!==void 0?c:"");let l=this.remoteParticipants.get(a.identity);a.state===en.DISCONNECTED?this.handleParticipantDisconnected(a.identity,l):l=this.getOrCreateParticipant(a.identity,a)})},this.handleActiveSpeakersUpdate=o=>{const a=[],c={};o.forEach(l=>{if(c[l.sid]=!0,l.sid===this.localParticipant.sid)this.localParticipant.audioLevel=l.level,this.localParticipant.setIsSpeaking(!0),a.push(this.localParticipant);else{const u=this.getRemoteParticipantBySid(l.sid);u&&(u.audioLevel=l.level,u.setIsSpeaking(!0),a.push(u))}}),c[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(l=>{c[l.sid]||(l.audioLevel=0,l.setIsSpeaking(!1))}),this.activeSpeakers=a,this.emitWhenConnected(I.ActiveSpeakersChanged,a)},this.handleSpeakersChanged=o=>{const a=new Map;this.activeSpeakers.forEach(l=>{const u=this.remoteParticipants.get(l.identity);u&&u.sid!==l.sid||a.set(l.sid,l)}),o.forEach(l=>{let u=this.getRemoteParticipantBySid(l.sid);l.sid===this.localParticipant.sid&&(u=this.localParticipant),u&&(u.audioLevel=l.level,u.setIsSpeaking(l.active),l.active?a.set(l.sid,u):a.delete(l.sid))});const c=Array.from(a.values());c.sort((l,u)=>u.audioLevel-l.audioLevel),this.activeSpeakers=c,this.emitWhenConnected(I.ActiveSpeakersChanged,c)},this.handleStreamStateUpdate=o=>{o.streamStates.forEach(a=>{const c=this.getRemoteParticipantBySid(a.participantSid);if(!c)return;const l=c.getTrackPublicationBySid(a.trackSid);if(!l||!l.track)return;const u=E.streamStateFromProto(a.state);l.track.setStreamState(u),u!==l.track.streamState&&(c.emit(M.TrackStreamStateChanged,l,l.track.streamState),this.emitWhenConnected(I.TrackStreamStateChanged,l,l.track.streamState,c))})},this.handleSubscriptionPermissionUpdate=o=>{const a=this.getRemoteParticipantBySid(o.participantSid);if(!a)return;const c=a.getTrackPublicationBySid(o.trackSid);c&&c.setAllowed(o.allowed)},this.handleSubscriptionError=o=>{const a=Array.from(this.remoteParticipants.values()).find(l=>l.trackPublications.has(o.trackSid));if(!a)return;const c=a.getTrackPublicationBySid(o.trackSid);c&&c.setSubscriptionError(o.err)},this.handleDataPacket=(o,a)=>{const c=this.remoteParticipants.get(o.participantIdentity);if(o.value.case==="user")this.handleUserPacket(c,o.value.value,o.kind,a);else if(o.value.case==="transcription")this.handleTranscription(c,o.value.value);else if(o.value.case==="sipDtmf")this.handleSipDtmf(c,o.value.value);else if(o.value.case==="chatMessage")this.handleChatMessage(c,o.value.value);else if(o.value.case==="metrics")this.handleMetrics(o.value.value,c);else if(o.value.case==="streamHeader"||o.value.case==="streamChunk"||o.value.case==="streamTrailer")this.handleDataStream(o,a);else if(o.value.case==="rpcRequest"){const l=o.value.value;this.handleIncomingRpcRequest(o.participantIdentity,l.id,l.method,l.payload,l.responseTimeoutMs,l.version)}},this.handleUserPacket=(o,a,c,l)=>{this.emit(I.DataReceived,a.payload,o,c,a.topic,l),o?.emit(M.DataReceived,a.payload,c,l)},this.handleSipDtmf=(o,a)=>{this.emit(I.SipDTMFReceived,a,o),o?.emit(M.SipDTMFReceived,a)},this.handleTranscription=(o,a)=>{const c=a.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(a.transcribedParticipantIdentity),l=c?.trackPublications.get(a.trackId),u=af(a,this.transcriptionReceivedTimes);l?.emit(L.TranscriptionReceived,u),c?.emit(M.TranscriptionReceived,u,l),this.emit(I.TranscriptionReceived,u,c,l)},this.handleChatMessage=(o,a)=>{const c=cf(a);this.emit(I.ChatMessage,c,o)},this.handleMetrics=(o,a)=>{this.emit(I.MetricsReceived,o,a)},this.handleDataStream=(o,a)=>{this.incomingDataStreamManager.handleDataStreamPacket(o,a)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(I.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=o=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:o})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(I.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(I.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(I.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>k(this,void 0,void 0,function*(){var o;((o=ke())===null||o===void 0?void 0:o.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(I.MediaDevicesChanged)}),this.handleRoomUpdate=o=>{const a=this.roomInfo;this.roomInfo=o,a&&a.metadata!==o.metadata&&this.emitWhenConnected(I.RoomMetadataChanged,o.metadata),a?.activeRecording!==o.activeRecording&&this.emitWhenConnected(I.RecordingStatusChanged,o.activeRecording)},this.handleConnectionQualityUpdate=o=>{o.updates.forEach(a=>{if(a.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(a.quality);return}const c=this.getRemoteParticipantBySid(a.participantSid);c&&c.setConnectionQuality(a.quality)})},this.onLocalParticipantMetadataChanged=o=>{this.emit(I.ParticipantMetadataChanged,o,this.localParticipant)},this.onLocalParticipantNameChanged=o=>{this.emit(I.ParticipantNameChanged,o,this.localParticipant)},this.onLocalAttributesChanged=o=>{this.emit(I.ParticipantAttributesChanged,o,this.localParticipant)},this.onLocalTrackMuted=o=>{this.emit(I.TrackMuted,o,this.localParticipant)},this.onLocalTrackUnmuted=o=>{this.emit(I.TrackUnmuted,o,this.localParticipant)},this.onTrackProcessorUpdate=o=>{var a;(a=o?.onPublish)===null||a===void 0||a.call(o,this)},this.onLocalTrackPublished=o=>k(this,void 0,void 0,function*(){var a,c,l,u,d,h;(a=o.track)===null||a===void 0||a.on(L.TrackProcessorUpdate,this.onTrackProcessorUpdate),(c=o.track)===null||c===void 0||c.on(L.Restarted,this.onLocalTrackRestarted),(d=(u=(l=o.track)===null||l===void 0?void 0:l.getProcessor())===null||u===void 0?void 0:u.onPublish)===null||d===void 0||d.call(u,this),this.emit(I.LocalTrackPublished,o,this.localParticipant),st(o.track)&&(yield o.track.checkForSilence())&&this.emit(I.LocalAudioSilenceDetected,o);const p=yield(h=o.track)===null||h===void 0?void 0:h.getDeviceId(!1),b=Br(o.source);b&&p&&p!==this.localParticipant.activeDeviceMap.get(b)&&(this.localParticipant.activeDeviceMap.set(b,p),this.emit(I.ActiveDeviceChanged,b,p))}),this.onLocalTrackUnpublished=o=>{var a,c;(a=o.track)===null||a===void 0||a.off(L.TrackProcessorUpdate,this.onTrackProcessorUpdate),(c=o.track)===null||c===void 0||c.off(L.Restarted,this.onLocalTrackRestarted),this.emit(I.LocalTrackUnpublished,o,this.localParticipant)},this.onLocalTrackRestarted=o=>k(this,void 0,void 0,function*(){const a=yield o.getDeviceId(!1),c=Br(o.source);c&&a&&a!==this.localParticipant.activeDeviceMap.get(c)&&(this.log.debug("local track restarted, setting ".concat(c," ").concat(a," active"),this.logContext),this.localParticipant.activeDeviceMap.set(c,a),this.emit(I.ActiveDeviceChanged,c,a))}),this.onLocalConnectionQualityChanged=o=>{this.emit(I.ConnectionQualityChanged,o,this.localParticipant)},this.onMediaDevicesError=(o,a)=>{this.emit(I.MediaDevicesError,o,a)},this.onLocalParticipantPermissionsChanged=o=>{this.emit(I.ParticipantPermissionsChanged,o,this.localParticipant)},this.onLocalChatMessageSent=o=>{this.emit(I.ChatMessage,o,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},Bf),e),this.log=dt((i=this.options.loggerName)!==null&&i!==void 0?i:Ve.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},ml),e?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},gl),e?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},jf),e?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new gp,this.outgoingDataStreamManager=new yp(this.engine,this.log),this.disconnectLock=new ye,this.localParticipant=new Pp("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",wt(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",wt(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",wt(this.options.audioOutput.deviceId)).catch(o=>this.log.warn("Could not set audio output: ".concat(o.message),this.logContext)),we()){const o=new AbortController;(s=navigator.mediaDevices)===null||s===void 0||s.addEventListener("devicechange",this.handleDeviceChange,{signal:o.signal}),ht.cleanupRegistry&&ht.cleanupRegistry.register(this,()=>{o.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return k(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;const t=!!this.options.encryption,i=this.options.encryption||this.options.e2ee;i&&("e2eeManager"in i?(this.e2eeManager=i.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new Tf(i,t),this.e2eeManager.on(Tt.ParticipantEncryptionStatusChanged,(r,s)=>{uf(s)&&(this.isE2EEEnabled=r),this.emit(I.ParticipantEncryptionStatusChanged,r,s)}),this.e2eeManager.on(Tt.EncryptionError,(r,s)=>{const o=s?this.getParticipantByIdentity(s):void 0;this.emit(I.EncryptionError,r,o)}),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return k(this,void 0,void 0,function*(){return this.state===H.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((e,t)=>{const i=r=>{r.sid!==""&&(this.engine.off(N.RoomUpdate,i),e(r.sid))};this.engine.on(N.RoomUpdate,i),this.once(I.Disconnected,()=>{this.engine.off(N.RoomUpdate,i),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new hp(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(N.ParticipantUpdate,this.handleParticipantUpdates).on(N.RoomUpdate,this.handleRoomUpdate).on(N.SpeakersChanged,this.handleSpeakersChanged).on(N.StreamStateChanged,this.handleStreamStateUpdate).on(N.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(N.SubscriptionError,this.handleSubscriptionError).on(N.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(N.MediaTrackAdded,(e,t,i)=>{this.onTrackAdded(e,t,i)}).on(N.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(N.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(N.DataPacketReceived,this.handleDataPacket).on(N.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(H.SignalReconnecting)&&this.emit(I.SignalReconnecting)}).on(N.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(H.Connected)&&this.emit(I.Reconnected)}).on(N.SignalResumed,()=>{this.bufferedEvents=[],(this.state===H.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(N.Restarting,this.handleRestarting).on(N.SignalRestarted,this.handleSignalRestarted).on(N.Offline,()=>{this.setAndEmitConnectionState(H.Reconnecting)&&this.emit(I.Reconnecting)}).on(N.DCBufferStatusChanged,(e,t)=>{this.emit(I.DCBufferStatusChanged,e,t)}).on(N.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(i=>{let{trackSid:r}=i;return r===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(M.LocalTrackSubscribed,t),this.emitWhenConnected(I.LocalTrackSubscribed,t,this.localParticipant)}).on(N.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((t,i)=>{this.handleParticipantDisconnected(i,t)}),this.emit(I.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return de.getInstance().getDevices(e,t)}prepareConnection(e,t){return k(this,void 0,void 0,function*(){if(this.state===H.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(un(new URL(e))&&t){this.regionUrlProvider=new K(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===H.Disconnected&&(this.regionUrl=i,yield fetch(Un(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(Un(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return k(this,void 0,void 0,function*(){let i=()=>k(this,void 0,void 0,function*(){}),r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new $e({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new $e({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new $e({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new $e({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>k(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new $e({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>k(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new $e({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new $e({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>k(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new Fi({reason:Be.CLIENT_INITIATED,action:tn.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new $e({scenario:{case:"subscriberBandwidth",value:Nt(t)}});break;case"leave-full-reconnect":r=new $e({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var a,c,l,u,d,h,p;let b=!0,m=!1;const T=o?{exact:r}:r;if(i==="audioinput"){m=s.localParticipant.audioTrackPublications.size===0;const S=(a=s.getActiveDevice(i))!==null&&a!==void 0?a:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=T;const P=Array.from(s.localParticipant.audioTrackPublications.values()).filter(v=>v.source===E.Source.Microphone);try{b=(yield Promise.all(P.map(v=>{var g;return(g=v.audioTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.audioCaptureDefaults.deviceId=S,v}const _=P.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&_&&(m=!0)}else if(i==="videoinput"){m=s.localParticipant.videoTrackPublications.size===0;const S=(c=s.getActiveDevice(i))!==null&&c!==void 0?c:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=T;const P=Array.from(s.localParticipant.videoTrackPublications.values()).filter(v=>v.source===E.Source.Camera);try{b=(yield Promise.all(P.map(v=>{var g;return(g=v.videoTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.videoCaptureDefaults.deviceId=S,v}const _=P.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&_&&(m=!0)}else if(i==="audiooutput"){if(m=!0,!Wr()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");s.options.webAudioMix&&(r=(l=yield de.getInstance().normalizeDeviceId("audiooutput",r))!==null&&l!==void 0?l:""),(u=(p=s.options).audioOutput)!==null&&u!==void 0||(p.audioOutput={});const S=(d=s.getActiveDevice(i))!==null&&d!==void 0?d:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=r;try{s.options.webAudioMix&&((h=s.audioContext)===null||h===void 0||h.setSinkId(r)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(P=>P.setAudioOutput({deviceId:r})))}catch(P){throw s.options.audioOutput.deviceId=S,P}}return m&&(s.localParticipant.activeDeviceMap.set(i,r),s.emit(I.ActiveDeviceChanged,i,r)),b})()})}setupLocalParticipantEvents(){this.localParticipant.on(M.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(M.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(M.AttributesChanged,this.onLocalAttributesChanged).on(M.TrackMuted,this.onLocalTrackMuted).on(M.TrackUnmuted,this.onLocalTrackUnmuted).on(M.LocalTrackPublished,this.onLocalTrackPublished).on(M.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(M.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(M.MediaDevicesError,this.onMediaDevicesError).on(M.AudioStreamAcquired,this.startAudio).on(M.ChatMessage,this.onLocalChatMessageSent).on(M.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===H.Connecting||this.state===H.Reconnecting){const d=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(p=>p.id)}),this.onTrackAdded(e,t,i),h()},h=()=>{this.off(I.Reconnected,d),this.off(I.Connected,d),this.off(I.Disconnected,h)};this.once(I.Reconnected,d),this.once(I.Connected,d),this.once(I.Disconnected,h);return}if(this.state===H.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const r=Jh(t.id),s=r[0];let o=r[1],a=e.id;if(o&&o.startsWith("TR")&&(a=o),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=Array.from(this.remoteParticipants.values()).find(d=>d.sid===s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}if(!a.startsWith("TR")){const d=this.engine.getTrackIdForReceiver(i);if(!d){this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(s),this.logContext);return}a=d}a.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(s,", streamId: ").concat(o,", trackId: ").concat(a),Object.assign(Object.assign({},this.logContext),{rpID:s,streamId:o,trackId:a}));let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={});const u=c.addSubscribedMediaTrack(e,a,t,i,l);u?.isEncrypted&&!this.e2eeManager&&this.emit(I.EncryptionError,new Error("Encrypted ".concat(u.source," track received from participant ").concat(c.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var i;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearControllers(),this.state!==H.Disconnected){this.regionUrl=void 0,this.regionUrlProvider&&this.regionUrlProvider.notifyDisconnected();try{this.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{r.unpublishTrack(s.trackSid)})}),this.localParticipant.trackPublications.forEach(r=>{var s,o,a;r.track&&this.localParticipant.unpublishTrack(r.track,e),e?((s=r.track)===null||s===void 0||s.detach(),(o=r.track)===null||o===void 0||o.stop()):(a=r.track)===null||a===void 0||a.stopMonitor()}),this.localParticipant.off(M.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(M.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(M.AttributesChanged,this.onLocalAttributesChanged).off(M.TrackMuted,this.onLocalTrackMuted).off(M.TrackUnmuted,this.onLocalTrackUnmuted).off(M.LocalTrackPublished,this.onLocalTrackPublished).off(M.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(M.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(M.MediaDevicesError,this.onMediaDevicesError).off(M.AudioStreamAcquired,this.startAudio).off(M.ChatMessage,this.onLocalChatMessageSent).off(M.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),we()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(i=navigator.mediaDevices)===null||i===void 0||i.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(H.Disconnected),this.emit(I.Disconnected,t)}}}handleParticipantDisconnected(e,t){var i;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(r=>{t.unpublishTrack(r.trackSid,!0)}),this.emit(I.ParticipantDisconnected,t),t.setDisconnected(),(i=this.localParticipant)===null||i===void 0||i.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,i,r,s,o){return k(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),o!==1){yield this.engine.publishRpcResponse(e,t,null,te.builtIn("UNSUPPORTED_VERSION"));return}const a=this.rpcHandlers.get(i);if(!a){yield this.engine.publishRpcResponse(e,t,null,te.builtIn("UNSUPPORTED_METHOD"));return}let c=null,l=null;try{const u=yield a({requestId:t,callerIdentity:e,payload:r,responseTimeout:s});Is(u)>bl?(c=te.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),this.log.warn("RPC Response payload too large for ".concat(i))):l=u}catch(u){u instanceof te?c=u:(this.log.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),u),c=te.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,l,c)})}selectDefaultDevices(){return k(this,void 0,void 0,function*(){var e,t,i;const r=de.getInstance().previousDevices,s=yield de.getInstance().getDevices(void 0,!1),o=ke();if(o?.name==="Chrome"&&o.os!=="iOS")for(let c of s){const l=r.find(u=>u.deviceId===c.deviceId);l&&l.label!==""&&l.kind===c.kind&&l.label!==c.label&&this.getActiveDevice(c.kind)==="default"&&this.emit(I.ActiveDeviceChanged,c.kind,c.deviceId)}const a=["audiooutput","audioinput","videoinput"];for(let c of a){const l=jh(c),u=this.localParticipant.getTrackPublication(l);if(u&&(!((e=u.track)===null||e===void 0)&&e.isUserProvided))continue;const d=s.filter(p=>p.kind===c),h=this.getActiveDevice(c);if(h===((t=r.filter(p=>p.kind===c)[0])===null||t===void 0?void 0:t.deviceId)&&d.length>0&&((i=d[0])===null||i===void 0?void 0:i.deviceId)!==h){yield this.switchActiveDevice(c,d[0].deviceId);continue}c==="audioinput"&&!Nn()||c==="videoinput"||d.length>0&&!d.find(p=>p.deviceId===this.getActiveDevice(c))&&(c!=="audiooutput"||!Nn())&&(yield this.switchActiveDevice(c,d[0].deviceId))}})}acquireAudioContext(){return k(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=cl())!==null&&e!==void 0?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),pe(200)])}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(I.AudioPlaybackStatusChanged,i))})}createParticipant(e,t){var i;let r;return t?r=Ei.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new Ei(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return t&&r.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),r}const i=this.createParticipant(e,t);return this.remoteParticipants.set(e,i),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(I.ParticipantConnected,i),i.on(M.TrackPublished,r=>{this.emitWhenConnected(I.TrackPublished,r,i)}).on(M.TrackSubscribed,(r,s)=>{r.kind===E.Kind.Audio?(r.on(L.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(L.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===E.Kind.Video&&(r.on(L.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(L.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(I.TrackSubscribed,r,s,i)}).on(M.TrackUnpublished,r=>{this.emit(I.TrackUnpublished,r,i)}).on(M.TrackUnsubscribed,(r,s)=>{this.emit(I.TrackUnsubscribed,r,s,i)}).on(M.TrackMuted,r=>{this.emitWhenConnected(I.TrackMuted,r,i)}).on(M.TrackUnmuted,r=>{this.emitWhenConnected(I.TrackUnmuted,r,i)}).on(M.ParticipantMetadataChanged,r=>{this.emitWhenConnected(I.ParticipantMetadataChanged,r,i)}).on(M.ParticipantNameChanged,r=>{this.emitWhenConnected(I.ParticipantNameChanged,r,i)}).on(M.AttributesChanged,r=>{this.emitWhenConnected(I.ParticipantAttributesChanged,r,i)}).on(M.ConnectionQualityChanged,r=>{this.emitWhenConnected(I.ConnectionQualityChanged,r,i)}).on(M.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(I.ParticipantPermissionsChanged,r,i)}).on(M.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionStatusChanged,r,s,i)}).on(M.TrackSubscriptionFailed,(r,s)=>{this.emit(I.TrackSubscriptionFailed,r,i,s)}).on(M.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionPermissionChanged,r,s,i)}).on(M.Active,()=>{this.emitWhenConnected(I.ParticipantActive,i),i.kind===Mn.AGENT&&this.localParticipant.setActiveAgent(i)}),t&&i.updateInfo(t),i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((i,r)=>(i.push(...r.getTrackPublications()),i),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&lf(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=fe.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Be.STATE_MISMATCH))):e=0},Rp)}clearConnectionReconcile(){this.connectionReconcileInterval&&fe.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(I.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,i]=e;this.emit(t,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(this.state===H.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===H.Connected)return this.emit(e,...i);return!1}simulateParticipants(e){return k(this,void 0,void 0,function*(){var t,i;const r=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),s=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Ai({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:X.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new jt({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected),this.emit(I.Connected),this.setAndEmitConnectionState(H.Connected),r.video){const o=new Ti(E.Kind.Video,new Yt({source:ie.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO,name:"video-dummy"}),new Si(r.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Lo(160*((t=s.aspectRatios[0])!==null&&t!==void 0?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(M.LocalTrackPublished,o)}if(r.audio){const o=new Ti(E.Kind.Audio,new Yt({source:ie.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO}),new ki(r.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:lr(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(M.LocalTrackPublished,o)}for(let o=0;o<s.count-1;o+=1){let a=new jt({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(o),state:en.ACTIVE,tracks:[],joinedAt:X.parse(Date.now())});const c=this.getOrCreateParticipant(a.identity,a);if(s.video){const l=Lo(160*((i=s.aspectRatios[o%s.aspectRatios.length])!==null&&i!==void 0?i:1),160,!1,!0),u=new Yt({source:ie.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}if(s.audio){const l=lr(),u=new Yt({source:ie.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ne.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l]),new RTCRtpReceiver),a.tracks=[...a.tracks,u]}c.updateInfo(a)}})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(e!==I.ActiveSpeakersChanged&&e!==I.TranscriptionReceived){const s=Rl(i).filter(o=>o!==void 0);(e===I.TrackSubscribed||e===I.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}ht.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(n=>{n()});function Rl(n){return n.map(e=>{if(e)return Array.isArray(e)?Rl(e):typeof e=="object"?"logContext"in e?e.logContext:void 0:e})}var Le;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(Le||(Le={}));class Mt extends tt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=Le.IDLE,this.logs=[],this.options={},this.url=e,this.token=t,this.name=this.constructor.name,this.room=new ht(i.roomOptions),this.connectOptions=i.connectOptions,this.options=i}run(e){return k(this,void 0,void 0,function*(){if(this.status!==Le.IDLE)throw Error("check is running already");this.setStatus(Le.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==Le.SKIPPED&&this.setStatus(this.isSuccess()?Le.SUCCESS:Le.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(e){return k(this,void 0,void 0,function*(){return this.room.state===H.Connected?this.room:(e||(e=this.url),yield this.room.connect(e,this.token,this.connectOptions),this.room)})}disconnect(){return k(this,void 0,void 0,function*(){this.room&&this.room.state!==H.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(Le.SKIPPED)}switchProtocol(e){return k(this,void 0,void 0,function*(){let t=!1,i=!1;if(this.room.on(I.Reconnecting,()=>{t=!0}),this.room.once(I.Reconnected,()=>{i=!0}),this.room.simulateScenario("force-".concat(e)),yield new Promise(s=>setTimeout(s,1e3)),!t)return;const r=Date.now()+1e4;for(;Date.now()<r;){if(i)return;yield pe(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))})}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class _p extends Mt{get description(){return"Cloud regions"}perform(){return k(this,void 0,void 0,function*(){const e=new K(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[],i=new Set;for(let s=0;s<3;s++){const o=yield e.getNextBestRegionUrl();if(!o)break;if(i.has(o))continue;i.add(o);const a=yield this.checkCloudRegion(o);this.appendMessage("".concat(a.region," RTT: ").concat(a.rtt,"ms, duration: ").concat(a.duration,"ms")),t.push(a)}t.sort((s,o)=>(s.duration-o.duration)*.5+(s.rtt-o.rtt)*.5);const r=t[0];this.bestStats=r,this.appendMessage("best Cloud region: ".concat(r.region))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkCloudRegion(e){return k(this,void 0,void 0,function*(){var t,i;yield this.connect(e),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const r=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!r)throw new Error("Region not found");const s=yield this.room.localParticipant.streamText({topic:"test"}),o=1e3,c=1e6/o,l="A".repeat(o),u=Date.now();for(let b=0;b<c;b++)yield s.write(l);yield s.close();const d=Date.now(),h=yield(i=this.room.engine.pcManager)===null||i===void 0?void 0:i.publisher.getStats(),p={region:r,rtt:1e4,duration:d-u};return h?.forEach(b=>{b.type==="candidate-pair"&&b.nominated&&(p.rtt=b.currentRoundTripTime*1e3)}),yield this.disconnect(),p})}}const br=1e4;class Ip extends Mt{get description(){return"Connection via UDP vs TCP"}perform(){return k(this,void 0,void 0,function*(){const e=yield this.checkConnectionProtocol("udp"),t=yield this.checkConnectionProtocol("tcp");this.bestStats=e,e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=t):this.appendMessage("best connection quality via udp");const i=this.bestStats;this.appendMessage("upstream bitrate: ".concat((i.bitrateTotal/i.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((i.rttTotal/i.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((i.jitterTotal/i.count*1e3).toFixed(2)," ms")),i.packetsLost>0&&this.appendWarning("packets lost: ".concat((i.packetsLost/i.packetsSent*100).toFixed(2),"%")),i.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((i.qualityLimitationDurations.bandwidth/(br/1e3)*100).toFixed(2),"%")),i.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((i.qualityLimitationDurations.cpu/(br/1e3)*100).toFixed(2),"%"))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkConnectionProtocol(e){return k(this,void 0,void 0,function*(){yield this.connect(),e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280,t.height=720;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");let r=0;const s=()=>{r=(r+1)%360,i.fillStyle="hsl(".concat(r,", 100%, 50%)"),i.fillRect(0,0,t.width,t.height),requestAnimationFrame(s)};s();const a=t.captureStream(30).getVideoTracks()[0],l=(yield this.room.localParticipant.publishTrack(a,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,u={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},d=setInterval(()=>k(this,void 0,void 0,function*(){const h=yield l.getRTCStatsReport();h?.forEach(p=>{p.type==="outbound-rtp"?(u.packetsSent=p.packetsSent,u.qualityLimitationDurations=p.qualityLimitationDurations,u.bitrateTotal+=p.targetBitrate,u.count++):p.type==="remote-inbound-rtp"&&(u.packetsLost=p.packetsLost,u.rttTotal+=p.roundTripTime,u.jitterTotal+=p.jitter)})}),1e3);return yield new Promise(h=>setTimeout(h,br)),clearInterval(d),a.stop(),t.remove(),yield this.disconnect(),u})}}class Op extends Mt{get description(){return"Can publish audio"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield Cp();if(yield al(i,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),t.localParticipant.publishTrack(i),yield new Promise(a=>setTimeout(a,3e3));const s=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!s)throw new Error("Could not get RTCStats");let o=0;if(s.forEach(a=>{a.type==="outbound-rtp"&&(a.kind==="audio"||!a.kind&&a.mediaType==="audio")&&(o=a.packetsSent)}),o===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(o," audio packets"))})}}class xp extends Mt{get description(){return"Can publish video"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield Tp();yield this.checkForVideo(i.mediaStreamTrack),t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,5e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="video"||!o.kind&&o.mediaType==="video")&&(s+=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}checkForVideo(e){return k(this,void 0,void 0,function*(){const t=new MediaStream;t.addTrack(e.clone());const i=document.createElement("video");i.srcObject=t,i.muted=!0,i.autoplay=!0,i.playsInline=!0,i.setAttribute("playsinline","true"),document.body.appendChild(i),yield new Promise(r=>{i.onplay=()=>{setTimeout(()=>{var s,o,a,c;const l=document.createElement("canvas"),u=e.getSettings(),d=(o=(s=u.width)!==null&&s!==void 0?s:i.videoWidth)!==null&&o!==void 0?o:1280,h=(c=(a=u.height)!==null&&a!==void 0?a:i.videoHeight)!==null&&c!==void 0?c:720;l.width=d,l.height=h;const p=l.getContext("2d");p.drawImage(i,0,0);const m=p.getImageData(0,0,l.width,l.height).data;let T=!0;for(let S=0;S<m.length;S+=4)if(m[S]!==0||m[S+1]!==0||m[S+2]!==0){T=!1;break}T?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),r()},1e3)},i.play()}),t.getTracks().forEach(r=>r.stop()),i.remove()})}}class Mp extends Mt{get description(){return"Resuming connection after interruption"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect();let i=!1,r=!1,s;const o=new Promise(l=>{setTimeout(l,5e3),s=l}),a=()=>{i=!0};t.on(I.SignalReconnecting,a).on(I.Reconnecting,a).on(I.Reconnected,()=>{r=!0,s(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const c=t.engine.client.onClose;if(c&&c(""),yield o,i){if(!r||t.state!==H.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class Dp extends Mt{get description(){return"Can connect via TURN"}perform(){return k(this,void 0,void 0,function*(){var e,t,i;un(new URL(this.url))&&(this.appendMessage("Using region specific url"),this.url=(e=yield new K(this.url,this.token).getNextBestRegionUrl())!==null&&e!==void 0?e:this.url);const r=new Es,s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1});let o=!1,a=!1,c=!1;for(let l of s.iceServers)for(let u of l.urls)u.startsWith("turn:")?(a=!0,c=!0):u.startsWith("turns:")&&(a=!0,c=!0,o=!0),u.startsWith("stun:")&&(c=!0);c?a&&!o&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield r.close(),!((i=(t=this.connectOptions)===null||t===void 0?void 0:t.rtcConfig)===null||i===void 0)&&i.iceServers||a?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(l=>setTimeout(l,0)))})}}class Ap extends Mt{get description(){return"Establishing WebRTC connection"}perform(){return k(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(I.SignalConnected,()=>{var i;const r=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(s,o)=>{if(s.candidate){const a=new RTCIceCandidate(s);let c="".concat(a.protocol," ").concat(a.address,":").concat(a.port," ").concat(a.type);a.address&&(Lp(a.address)?c+=" (private)":a.protocol==="tcp"&&a.tcpType==="passive"?(e=!0,c+=" (passive)"):a.protocol==="udp"&&(t=!0)),this.appendMessage(c)}r&&r(s,o)},!((i=this.room.engine.pcManager)===null||i===void 0)&&i.subscriber&&(this.room.engine.pcManager.subscriber.onIceCandidateError=s=>{s instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(s.errorCode," ").concat(s.errorText," ").concat(s.url))})});try{yield this.connect(),j.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function Lp(n){const e=n.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class Np extends Mt{get description(){return"Connecting to signal connection via WebSocket"}perform(){return k(this,void 0,void 0,function*(){var e,t,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new Es,s;try{s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1})}catch(o){if(un(new URL(this.url))){this.appendMessage("Initial connection failed with error ".concat(o.message,". Retrying with region fallback"));const c=yield new K(this.url,this.token).getNextBestRegionUrl();c&&(s=yield r.join(c,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3,singlePeerConnection:!1}),this.appendMessage("Fallback to region worked. To avoid initial connections failing, ensure you're calling room.prepareConnection() ahead of time"))}}s?(this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===dc.Cloud&&(!((t=s.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region))):this.appendError("Websocket connection could not be established"),yield r.close()})}}class ly extends tt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=i}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:Le.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==Le.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return k(this,void 0,void 0,function*(){const t=this.getNextCheckId(),i=new e(this.url,this.token,this.options),r=o=>{this.updateCheck(t,o)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Np)})}checkWebRTC(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Ap)})}checkTURN(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Dp)})}checkReconnect(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Mp)})}checkPublishAudio(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Op)})}checkPublishVideo(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(xp)})}checkConnectionProtocol(){return k(this,void 0,void 0,function*(){const e=yield this.createAndRunCheck(Ip);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e})}checkCloudRegion(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(_p)})}}function W(n,e,t){return(e=Fp(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Up(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Fp(n){var e=Up(n,"string");return typeof e=="symbol"?e:e+""}new TextEncoder;new TextDecoder;class Se extends Error{constructor(e,t){var i;super(e,t),W(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,(i=Error.captureStackTrace)===null||i===void 0||i.call(Error,this,this.constructor)}}W(Se,"code","ERR_JOSE_GENERIC");class jp extends Se{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),W(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),W(this,"claim",void 0),W(this,"reason",void 0),W(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}W(jp,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class Bp extends Se{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),W(this,"code","ERR_JWT_EXPIRED"),W(this,"claim",void 0),W(this,"reason",void 0),W(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}W(Bp,"code","ERR_JWT_EXPIRED");class Vp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}}W(Vp,"code","ERR_JOSE_ALG_NOT_ALLOWED");class qp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JOSE_NOT_SUPPORTED")}}W(qp,"code","ERR_JOSE_NOT_SUPPORTED");class Wp extends Se{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"decryption operation failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),W(this,"code","ERR_JWE_DECRYPTION_FAILED")}}W(Wp,"code","ERR_JWE_DECRYPTION_FAILED");class Hp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JWE_INVALID")}}W(Hp,"code","ERR_JWE_INVALID");class Kp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JWS_INVALID")}}W(Kp,"code","ERR_JWS_INVALID");class zp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JWT_INVALID")}}W(zp,"code","ERR_JWT_INVALID");class Gp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JWK_INVALID")}}W(Gp,"code","ERR_JWK_INVALID");class Jp extends Se{constructor(){super(...arguments),W(this,"code","ERR_JWKS_INVALID")}}W(Jp,"code","ERR_JWKS_INVALID");class $p extends Se{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"no applicable key found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),W(this,"code","ERR_JWKS_NO_MATCHING_KEY")}}W($p,"code","ERR_JWKS_NO_MATCHING_KEY");class Qp extends Se{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"multiple matching keys found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),W(this,Symbol.asyncIterator,void 0),W(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}}W(Qp,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");class Yp extends Se{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"request timed out",t=arguments.length>1?arguments[1]:void 0;super(e,t),W(this,"code","ERR_JWKS_TIMEOUT")}}W(Yp,"code","ERR_JWKS_TIMEOUT");class Xp extends Se{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"signature verification failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),W(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}W(Xp,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function Zp(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const i=Ut(n)?n.mediaStreamTrack:n,r=i.getSettings();let s={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const o=r.facingMode;j.trace("rawFacingMode",{rawFacingMode:o}),o&&typeof o=="string"&&nm(o)&&(s={facingMode:o,confidence:"high"})}if(["low","medium"].includes(s.confidence)){j.trace("Try to get facing mode from device label: (".concat(i.label,")"));const o=tm(i.label);o!==void 0&&(s=o)}return s}const sa=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),em=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function tm(n){var e;const t=n.trim().toLowerCase();if(t!=="")return sa.has(t)?sa.get(t):(e=Array.from(em.entries()).find(i=>{let[r]=i;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function nm(n){return n===void 0||["user","environment","left","right"].includes(n)}const wi=Math.min,Ft=Math.max,Pi=Math.round,Jn=Math.floor,Xe=n=>({x:n,y:n}),im={left:"right",right:"left",bottom:"top",top:"bottom"},rm={start:"end",end:"start"};function oa(n,e,t){return Ft(n,wi(e,t))}function qi(n,e){return typeof n=="function"?n(e):n}function qt(n){return n.split("-")[0]}function Wi(n){return n.split("-")[1]}function _l(n){return n==="x"?"y":"x"}function Il(n){return n==="y"?"height":"width"}const sm=new Set(["top","bottom"]);function Ct(n){return sm.has(qt(n))?"y":"x"}function Ol(n){return _l(Ct(n))}function om(n,e,t){t===void 0&&(t=!1);const i=Wi(n),r=Ol(n),s=Il(r);let o=r==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(o=Ri(o)),[o,Ri(o)]}function am(n){const e=Ri(n);return[Qr(n),e,Qr(e)]}function Qr(n){return n.replace(/start|end/g,e=>rm[e])}const aa=["left","right"],ca=["right","left"],cm=["top","bottom"],lm=["bottom","top"];function um(n,e,t){switch(n){case"top":case"bottom":return t?e?ca:aa:e?aa:ca;case"left":case"right":return e?cm:lm;default:return[]}}function dm(n,e,t,i){const r=Wi(n);let s=um(qt(n),t==="start",i);return r&&(s=s.map(o=>o+"-"+r),e&&(s=s.concat(s.map(Qr)))),s}function Ri(n){return n.replace(/left|right|bottom|top/g,e=>im[e])}function hm(n){return{top:0,right:0,bottom:0,left:0,...n}}function fm(n){return typeof n!="number"?hm(n):{top:n,right:n,bottom:n,left:n}}function _i(n){const{x:e,y:t,width:i,height:r}=n;return{width:i,height:r,top:t,left:e,right:e+i,bottom:t+r,x:e,y:t}}function la(n,e,t){let{reference:i,floating:r}=n;const s=Ct(e),o=Ol(e),a=Il(o),c=qt(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,h=i[a]/2-r[a]/2;let p;switch(c){case"top":p={x:u,y:i.y-r.height};break;case"bottom":p={x:u,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:d};break;case"left":p={x:i.x-r.width,y:d};break;default:p={x:i.x,y:i.y}}switch(Wi(e)){case"start":p[o]-=h*(t&&l?-1:1);break;case"end":p[o]+=h*(t&&l?-1:1);break}return p}const pm=async(n,e,t)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:o}=t,a=s.filter(Boolean),c=await(o.isRTL==null?void 0:o.isRTL(e));let l=await o.getElementRects({reference:n,floating:e,strategy:r}),{x:u,y:d}=la(l,i,c),h=i,p={},b=0;for(let m=0;m<a.length;m++){const{name:T,fn:S}=a[m],{x:P,y:_,data:v,reset:g}=await S({x:u,y:d,initialPlacement:i,placement:h,strategy:r,middlewareData:p,rects:l,platform:o,elements:{reference:n,floating:e}});u=P??u,d=_??d,p={...p,[T]:{...p[T],...v}},g&&b<=50&&(b++,typeof g=="object"&&(g.placement&&(h=g.placement),g.rects&&(l=g.rects===!0?await o.getElementRects({reference:n,floating:e,strategy:r}):g.rects),{x:u,y:d}=la(l,h,c)),m=-1)}return{x:u,y:d,placement:h,strategy:r,middlewareData:p}};async function xl(n,e){var t;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:o,elements:a,strategy:c}=n,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:h=!1,padding:p=0}=qi(e,n),b=fm(p),m=a[h?d==="floating"?"reference":"floating":d],T=_i(await s.getClippingRect({element:(t=await(s.isElement==null?void 0:s.isElement(m)))==null||t?m:m.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(a.floating)),boundary:l,rootBoundary:u,strategy:c})),S=d==="floating"?{x:i,y:r,width:o.floating.width,height:o.floating.height}:o.reference,P=await(s.getOffsetParent==null?void 0:s.getOffsetParent(a.floating)),_=await(s.isElement==null?void 0:s.isElement(P))?await(s.getScale==null?void 0:s.getScale(P))||{x:1,y:1}:{x:1,y:1},v=_i(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:a,rect:S,offsetParent:P,strategy:c}):S);return{top:(T.top-v.top+b.top)/_.y,bottom:(v.bottom-T.bottom+b.bottom)/_.y,left:(T.left-v.left+b.left)/_.x,right:(v.right-T.right+b.right)/_.x}}const mm=function(n){return n===void 0&&(n={}),{name:"flip",options:n,async fn(e){var t,i;const{placement:r,middlewareData:s,rects:o,initialPlacement:a,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:h,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:b="none",flipAlignment:m=!0,...T}=qi(n,e);if((t=s.arrow)!=null&&t.alignmentOffset)return{};const S=qt(r),P=Ct(a),_=qt(a)===a,v=await(c.isRTL==null?void 0:c.isRTL(l.floating)),g=h||(_||!m?[Ri(a)]:am(a)),y=b!=="none";!h&&y&&g.push(...dm(a,m,b,v));const C=[a,...g],x=await xl(e,T),R=[];let O=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&R.push(x[S]),d){const Q=om(r,o,v);R.push(x[Q[0]],x[Q[1]])}if(O=[...O,{placement:r,overflows:R}],!R.every(Q=>Q<=0)){var D,U;const Q=(((D=s.flip)==null?void 0:D.index)||0)+1,Oe=C[Q];if(Oe&&(!(d==="alignment"&&P!==Ct(Oe))||O.every(me=>Ct(me.placement)===P?me.overflows[0]>0:!0)))return{data:{index:Q,overflows:O},reset:{placement:Oe}};let Te=(U=O.filter(me=>me.overflows[0]<=0).sort((me,ge)=>me.overflows[1]-ge.overflows[1])[0])==null?void 0:U.placement;if(!Te)switch(p){case"bestFit":{var z;const me=(z=O.filter(ge=>{if(y){const Ce=Ct(ge.placement);return Ce===P||Ce==="y"}return!0}).map(ge=>[ge.placement,ge.overflows.filter(Ce=>Ce>0).reduce((Ce,Dt)=>Ce+Dt,0)]).sort((ge,Ce)=>ge[1]-Ce[1])[0])==null?void 0:z[0];me&&(Te=me);break}case"initialPlacement":Te=a;break}if(r!==Te)return{reset:{placement:Te}}}return{}}}},gm=new Set(["left","top"]);async function vm(n,e){const{placement:t,platform:i,elements:r}=n,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),o=qt(t),a=Wi(t),c=Ct(t)==="y",l=gm.has(o)?-1:1,u=s&&c?-1:1,d=qi(e,n);let{mainAxis:h,crossAxis:p,alignmentAxis:b}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:d.mainAxis||0,crossAxis:d.crossAxis||0,alignmentAxis:d.alignmentAxis};return a&&typeof b=="number"&&(p=a==="end"?b*-1:b),c?{x:p*u,y:h*l}:{x:h*l,y:p*u}}const bm=function(n){return n===void 0&&(n=0),{name:"offset",options:n,async fn(e){var t,i;const{x:r,y:s,placement:o,middlewareData:a}=e,c=await vm(e,n);return o===((t=a.offset)==null?void 0:t.placement)&&(i=a.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:o}}}}},ym=function(n){return n===void 0&&(n={}),{name:"shift",options:n,async fn(e){const{x:t,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:o=!1,limiter:a={fn:T=>{let{x:S,y:P}=T;return{x:S,y:P}}},...c}=qi(n,e),l={x:t,y:i},u=await xl(e,c),d=Ct(qt(r)),h=_l(d);let p=l[h],b=l[d];if(s){const T=h==="y"?"top":"left",S=h==="y"?"bottom":"right",P=p+u[T],_=p-u[S];p=oa(P,p,_)}if(o){const T=d==="y"?"top":"left",S=d==="y"?"bottom":"right",P=b+u[T],_=b-u[S];b=oa(P,b,_)}const m=a.fn({...e,[h]:p,[d]:b});return{...m,data:{x:m.x-t,y:m.y-i,enabled:{[h]:s,[d]:o}}}}}};function Hi(){return typeof window<"u"}function pn(n){return Ml(n)?(n.nodeName||"").toLowerCase():"#document"}function Ie(n){var e;return(n==null||(e=n.ownerDocument)==null?void 0:e.defaultView)||window}function it(n){var e;return(e=(Ml(n)?n.ownerDocument:n.document)||window.document)==null?void 0:e.documentElement}function Ml(n){return Hi()?n instanceof Node||n instanceof Ie(n).Node:!1}function We(n){return Hi()?n instanceof Element||n instanceof Ie(n).Element:!1}function et(n){return Hi()?n instanceof HTMLElement||n instanceof Ie(n).HTMLElement:!1}function ua(n){return!Hi()||typeof ShadowRoot>"u"?!1:n instanceof ShadowRoot||n instanceof Ie(n).ShadowRoot}const km=new Set(["inline","contents"]);function Vn(n){const{overflow:e,overflowX:t,overflowY:i,display:r}=He(n);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!km.has(r)}const Sm=new Set(["table","td","th"]);function Tm(n){return Sm.has(pn(n))}const Cm=[":popover-open",":modal"];function Ki(n){return Cm.some(e=>{try{return n.matches(e)}catch{return!1}})}const Em=["transform","translate","scale","rotate","perspective"],wm=["transform","translate","scale","rotate","perspective","filter"],Pm=["paint","layout","strict","content"];function Ms(n){const e=Ds(),t=We(n)?He(n):n;return Em.some(i=>t[i]?t[i]!=="none":!1)||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||wm.some(i=>(t.willChange||"").includes(i))||Pm.some(i=>(t.contain||"").includes(i))}function Rm(n){let e=Ot(n);for(;et(e)&&!dn(e);){if(Ms(e))return e;if(Ki(e))return null;e=Ot(e)}return null}function Ds(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}const _m=new Set(["html","body","#document"]);function dn(n){return _m.has(pn(n))}function He(n){return Ie(n).getComputedStyle(n)}function zi(n){return We(n)?{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}:{scrollLeft:n.scrollX,scrollTop:n.scrollY}}function Ot(n){if(pn(n)==="html")return n;const e=n.assignedSlot||n.parentNode||ua(n)&&n.host||it(n);return ua(e)?e.host:e}function Dl(n){const e=Ot(n);return dn(e)?n.ownerDocument?n.ownerDocument.body:n.body:et(e)&&Vn(e)?e:Dl(e)}function Fn(n,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);const r=Dl(n),s=r===((i=n.ownerDocument)==null?void 0:i.body),o=Ie(r);if(s){const a=Yr(o);return e.concat(o,o.visualViewport||[],Vn(r)?r:[],a&&t?Fn(a):[])}return e.concat(r,Fn(r,[],t))}function Yr(n){return n.parent&&Object.getPrototypeOf(n.parent)?n.frameElement:null}function Al(n){const e=He(n);let t=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=et(n),s=r?n.offsetWidth:t,o=r?n.offsetHeight:i,a=Pi(t)!==s||Pi(i)!==o;return a&&(t=s,i=o),{width:t,height:i,$:a}}function As(n){return We(n)?n:n.contextElement}function an(n){const e=As(n);if(!et(e))return Xe(1);const t=e.getBoundingClientRect(),{width:i,height:r,$:s}=Al(e);let o=(s?Pi(t.width):t.width)/i,a=(s?Pi(t.height):t.height)/r;return(!o||!Number.isFinite(o))&&(o=1),(!a||!Number.isFinite(a))&&(a=1),{x:o,y:a}}const Im=Xe(0);function Ll(n){const e=Ie(n);return!Ds()||!e.visualViewport?Im:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function Om(n,e,t){return e===void 0&&(e=!1),!t||e&&t!==Ie(n)?!1:e}function Wt(n,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);const r=n.getBoundingClientRect(),s=As(n);let o=Xe(1);e&&(i?We(i)&&(o=an(i)):o=an(n));const a=Om(s,t,i)?Ll(s):Xe(0);let c=(r.left+a.x)/o.x,l=(r.top+a.y)/o.y,u=r.width/o.x,d=r.height/o.y;if(s){const h=Ie(s),p=i&&We(i)?Ie(i):i;let b=h,m=Yr(b);for(;m&&i&&p!==b;){const T=an(m),S=m.getBoundingClientRect(),P=He(m),_=S.left+(m.clientLeft+parseFloat(P.paddingLeft))*T.x,v=S.top+(m.clientTop+parseFloat(P.paddingTop))*T.y;c*=T.x,l*=T.y,u*=T.x,d*=T.y,c+=_,l+=v,b=Ie(m),m=Yr(b)}}return _i({width:u,height:d,x:c,y:l})}function Gi(n,e){const t=zi(n).scrollLeft;return e?e.left+t:Wt(it(n)).left+t}function Nl(n,e){const t=n.getBoundingClientRect(),i=t.left+e.scrollLeft-Gi(n,t),r=t.top+e.scrollTop;return{x:i,y:r}}function xm(n){let{elements:e,rect:t,offsetParent:i,strategy:r}=n;const s=r==="fixed",o=it(i),a=e?Ki(e.floating):!1;if(i===o||a&&s)return t;let c={scrollLeft:0,scrollTop:0},l=Xe(1);const u=Xe(0),d=et(i);if((d||!d&&!s)&&((pn(i)!=="body"||Vn(o))&&(c=zi(i)),et(i))){const p=Wt(i);l=an(i),u.x=p.x+i.clientLeft,u.y=p.y+i.clientTop}const h=o&&!d&&!s?Nl(o,c):Xe(0);return{width:t.width*l.x,height:t.height*l.y,x:t.x*l.x-c.scrollLeft*l.x+u.x+h.x,y:t.y*l.y-c.scrollTop*l.y+u.y+h.y}}function Mm(n){return Array.from(n.getClientRects())}function Dm(n){const e=it(n),t=zi(n),i=n.ownerDocument.body,r=Ft(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=Ft(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let o=-t.scrollLeft+Gi(n);const a=-t.scrollTop;return He(i).direction==="rtl"&&(o+=Ft(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:o,y:a}}const da=25;function Am(n,e){const t=Ie(n),i=it(n),r=t.visualViewport;let s=i.clientWidth,o=i.clientHeight,a=0,c=0;if(r){s=r.width,o=r.height;const u=Ds();(!u||u&&e==="fixed")&&(a=r.offsetLeft,c=r.offsetTop)}const l=Gi(i);if(l<=0){const u=i.ownerDocument,d=u.body,h=getComputedStyle(d),p=u.compatMode==="CSS1Compat"&&parseFloat(h.marginLeft)+parseFloat(h.marginRight)||0,b=Math.abs(i.clientWidth-d.clientWidth-p);b<=da&&(s-=b)}else l<=da&&(s+=l);return{width:s,height:o,x:a,y:c}}const Lm=new Set(["absolute","fixed"]);function Nm(n,e){const t=Wt(n,!0,e==="fixed"),i=t.top+n.clientTop,r=t.left+n.clientLeft,s=et(n)?an(n):Xe(1),o=n.clientWidth*s.x,a=n.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:o,height:a,x:c,y:l}}function ha(n,e,t){let i;if(e==="viewport")i=Am(n,t);else if(e==="document")i=Dm(it(n));else if(We(e))i=Nm(e,t);else{const r=Ll(n);i={x:e.x-r.x,y:e.y-r.y,width:e.width,height:e.height}}return _i(i)}function Ul(n,e){const t=Ot(n);return t===e||!We(t)||dn(t)?!1:He(t).position==="fixed"||Ul(t,e)}function Um(n,e){const t=e.get(n);if(t)return t;let i=Fn(n,[],!1).filter(a=>We(a)&&pn(a)!=="body"),r=null;const s=He(n).position==="fixed";let o=s?Ot(n):n;for(;We(o)&&!dn(o);){const a=He(o),c=Ms(o);!c&&a.position==="fixed"&&(r=null),(s?!c&&!r:!c&&a.position==="static"&&r&&Lm.has(r.position)||Vn(o)&&!c&&Ul(n,o))?i=i.filter(l=>l!==o):r=a,o=Ot(o)}return e.set(n,i),i}function Fm(n){let{element:e,boundary:t,rootBoundary:i,strategy:r}=n;const s=[...t==="clippingAncestors"?Ki(e)?[]:Um(e,this._c):[].concat(t),i],o=s[0],a=s.reduce((c,l)=>{const u=ha(e,l,r);return c.top=Ft(u.top,c.top),c.right=wi(u.right,c.right),c.bottom=wi(u.bottom,c.bottom),c.left=Ft(u.left,c.left),c},ha(e,o,r));return{width:a.right-a.left,height:a.bottom-a.top,x:a.left,y:a.top}}function jm(n){const{width:e,height:t}=Al(n);return{width:e,height:t}}function Bm(n,e,t){const i=et(e),r=it(e),s=t==="fixed",o=Wt(n,!0,s,e);let a={scrollLeft:0,scrollTop:0};const c=Xe(0);function l(){c.x=Gi(r)}if(i||!i&&!s)if((pn(e)!=="body"||Vn(r))&&(a=zi(e)),i){const p=Wt(e,!0,s,e);c.x=p.x+e.clientLeft,c.y=p.y+e.clientTop}else r&&l();s&&!i&&r&&l();const u=r&&!i&&!s?Nl(r,a):Xe(0),d=o.left+a.scrollLeft-c.x-u.x,h=o.top+a.scrollTop-c.y-u.y;return{x:d,y:h,width:o.width,height:o.height}}function yr(n){return He(n).position==="static"}function fa(n,e){if(!et(n)||He(n).position==="fixed")return null;if(e)return e(n);let t=n.offsetParent;return it(n)===t&&(t=t.ownerDocument.body),t}function Fl(n,e){const t=Ie(n);if(Ki(n))return t;if(!et(n)){let r=Ot(n);for(;r&&!dn(r);){if(We(r)&&!yr(r))return r;r=Ot(r)}return t}let i=fa(n,e);for(;i&&Tm(i)&&yr(i);)i=fa(i,e);return i&&dn(i)&&yr(i)&&!Ms(i)?t:i||Rm(n)||t}const Vm=async function(n){const e=this.getOffsetParent||Fl,t=this.getDimensions,i=await t(n.floating);return{reference:Bm(n.reference,await e(n.floating),n.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}};function qm(n){return He(n).direction==="rtl"}const Wm={convertOffsetParentRelativeRectToViewportRelativeRect:xm,getDocumentElement:it,getClippingRect:Fm,getOffsetParent:Fl,getElementRects:Vm,getClientRects:Mm,getDimensions:jm,getScale:an,isElement:We,isRTL:qm};function jl(n,e){return n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height}function Hm(n,e){let t=null,i;const r=it(n);function s(){var a;clearTimeout(i),(a=t)==null||a.disconnect(),t=null}function o(a,c){a===void 0&&(a=!1),c===void 0&&(c=1),s();const l=n.getBoundingClientRect(),{left:u,top:d,width:h,height:p}=l;if(a||e(),!h||!p)return;const b=Jn(d),m=Jn(r.clientWidth-(u+h)),T=Jn(r.clientHeight-(d+p)),S=Jn(u),P={rootMargin:-b+"px "+-m+"px "+-T+"px "+-S+"px",threshold:Ft(0,wi(1,c))||1};let _=!0;function v(g){const y=g[0].intersectionRatio;if(y!==c){if(!_)return o();y?o(!1,y):i=setTimeout(()=>{o(!1,1e-7)},1e3)}y===1&&!jl(l,n.getBoundingClientRect())&&o(),_=!1}try{t=new IntersectionObserver(v,{...P,root:r.ownerDocument})}catch{t=new IntersectionObserver(v,P)}t.observe(n)}return o(!0),s}function Km(n,e,t,i){i===void 0&&(i={});const{ancestorScroll:r=!0,ancestorResize:s=!0,elementResize:o=typeof ResizeObserver=="function",layoutShift:a=typeof IntersectionObserver=="function",animationFrame:c=!1}=i,l=As(n),u=r||s?[...l?Fn(l):[],...Fn(e)]:[];u.forEach(S=>{r&&S.addEventListener("scroll",t,{passive:!0}),s&&S.addEventListener("resize",t)});const d=l&&a?Hm(l,t):null;let h=-1,p=null;o&&(p=new ResizeObserver(S=>{let[P]=S;P&&P.target===l&&p&&(p.unobserve(e),cancelAnimationFrame(h),h=requestAnimationFrame(()=>{var _;(_=p)==null||_.observe(e)})),t()}),l&&!c&&p.observe(l),p.observe(e));let b,m=c?Wt(n):null;c&&T();function T(){const S=Wt(n);m&&!jl(m,S)&&t(),m=S,b=requestAnimationFrame(T)}return t(),()=>{var S;u.forEach(P=>{r&&P.removeEventListener("scroll",t),s&&P.removeEventListener("resize",t)}),d?.(),(S=p)==null||S.disconnect(),p=null,c&&cancelAnimationFrame(b)}}const zm=bm,Gm=ym,Jm=mm,$m=(n,e,t)=>{const i=new Map,r={platform:Wm,...t},s={...r.platform,_c:i};return pm(n,e,{...r,platform:s})};var $n=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Bl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Xr={exports:{}},Qm=Xr.exports,pa;function Ym(){return pa||(pa=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(Qm,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},o=null;function a(m,T){var S=m[T];if(typeof S.bind=="function")return S.bind(m);try{return Function.prototype.bind.call(S,m)}catch{return function(){return Function.prototype.apply.apply(S,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?a(console,m):console.log!==void 0?a(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var S=r[T];this[S]=T<m?e:this.methodFactory(S,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,S){return l(m)||d.apply(this,arguments)}function p(m,T){var S=this,P,_,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var U=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=U;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+U+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var U=window.document.cookie,z=encodeURIComponent(g),Q=U.indexOf(z+"=");Q!==-1&&(D=/^([^;]+)/.exec(U.slice(Q+z.length+1))[1])}catch{}return S.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function R(D){var U=D;if(typeof U=="string"&&S.levels[U.toUpperCase()]!==void 0&&(U=S.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=S.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+D)}S.name=m,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=T||h,S.getLevel=function(){return v??_??P},S.setLevel=function(D,U){return v=R(D),U!==!1&&y(v),u.call(S)},S.setDefaultLevel=function(D){_=R(D),C()||S.setLevel(D,!1)},S.resetLevel=function(){v=null,x(),u.call(S)},S.enableAll=function(D){S.setLevel(S.levels.TRACE,D)},S.disableAll=function(D){S.setLevel(S.levels.SILENT,D)},S.rebuild=function(){if(o!==S&&(P=R(o.getLevel())),u.call(S),o===S)for(var D in s)s[D].rebuild()},P=R(o?o.getLevel():"WARN");var O=C();O!=null&&(v=R(O)),u.call(S)}o=new p,o.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var T=s[m];return T||(T=s[m]=new p(m,o.methodFactory)),T};var b=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=b),o},o.getLoggers=function(){return s},o.default=o,o})})(Xr)),Xr.exports}var Xm=Ym();const Zm=Bl(Xm);var Zr=function(n,e){return Zr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},Zr(n,e)};function ft(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Zr(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function eg(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,[])).next())})}function Vl(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,o=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(t=0)),t;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,r=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function hn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function fn(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,s=[],o;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return s}function jn(n,e,t){if(arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return n.concat(s||Array.prototype.slice.call(e))}function cn(n){return this instanceof cn?(this.v=n,this):new cn(n)}function tg(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(p){return function(b){return Promise.resolve(b).then(p,d)}}function a(p,b){i[p]&&(r[p]=function(m){return new Promise(function(T,S){s.push([p,m,T,S])>1||c(p,m)})},b&&(r[p]=b(r[p])))}function c(p,b){try{l(i[p](b))}catch(m){h(s[0][3],m)}}function l(p){p.value instanceof cn?Promise.resolve(p.value.v).then(u,d):h(s[0][2],p)}function u(p){c("next",p)}function d(p){c("throw",p)}function h(p,b){p(b),s.shift(),s.length&&c(s[0][0],s[0][1])}}function ng(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof hn=="function"?hn(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}function $(n){return typeof n=="function"}function Ls(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var kr=Ls(function(n){return function(e){n(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,i){return i+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Ii(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var qn=(function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return n.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=hn(o),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var u=this.initialTeardown;if($(u))try{u()}catch(m){s=m instanceof kr?m.errors:[m]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var h=hn(d),p=h.next();!p.done;p=h.next()){var b=p.value;try{ma(b)}catch(m){s=s??[],m instanceof kr?s=jn(jn([],fn(s)),fn(m.errors)):s.push(m)}}}catch(m){i={error:m}}finally{try{p&&!p.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(s)throw new kr(s)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)ma(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ii(t,e)},n.prototype.remove=function(e){var t=this._finalizers;t&&Ii(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=(function(){var e=new n;return e.closed=!0,e})(),n})(),ql=qn.EMPTY;function Wl(n){return n instanceof qn||n&&"closed"in n&&$(n.remove)&&$(n.add)&&$(n.unsubscribe)}function ma(n){$(n)?n():n.unsubscribe()}var ig={Promise:void 0},rg={setTimeout:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setTimeout.apply(void 0,jn([n,e],fn(t)))},clearTimeout:function(n){return clearTimeout(n)},delegate:void 0};function Hl(n){rg.setTimeout(function(){throw n})}function Oi(){}function hi(n){n()}var Ns=(function(n){ft(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,Wl(t)&&t.add(i)):i.destination=ag,i}return e.create=function(t,i,r){return new es(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(qn),sg=(function(){function n(e){this.partialObserver=e}return n.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){Qn(i)}},n.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){Qn(i)}else Qn(e)},n.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Qn(t)}},n})(),es=(function(n){ft(e,n);function e(t,i,r){var s=n.call(this)||this,o;return $(t)||!t?o={next:t??void 0,error:i??void 0,complete:r??void 0}:o=t,s.destination=new sg(o),s}return e})(Ns);function Qn(n){Hl(n)}function og(n){throw n}var ag={closed:!0,next:Oi,error:og,complete:Oi},Us=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Fs(n){return n}function cg(n){return n.length===0?Fs:n.length===1?n[0]:function(e){return n.reduce(function(t,i){return i(t)},e)}}var le=(function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,s=ug(e)?e:new es(e,t,i);return hi(function(){var o=r,a=o.operator,c=o.source;s.add(a?a.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=ga(t),new t(function(r,s){var o=new es({next:function(a){try{e(a)}catch(c){s(c),o.unsubscribe()}},error:s,complete:r});i.subscribe(o)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[Us]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return cg(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=ga(e),new e(function(i,r){var s;t.subscribe(function(o){return s=o},function(o){return r(o)},function(){return i(s)})})},n.create=function(e){return new n(e)},n})();function ga(n){var e;return(e=n??ig.Promise)!==null&&e!==void 0?e:Promise}function lg(n){return n&&$(n.next)&&$(n.error)&&$(n.complete)}function ug(n){return n&&n instanceof Ns||lg(n)&&Wl(n)}function dg(n){return $(n?.lift)}function Ge(n){return function(e){if(dg(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ke(n,e,t,i,r){return new hg(n,e,t,i,r)}var hg=(function(n){ft(e,n);function e(t,i,r,s,o,a){var c=n.call(this,t)||this;return c.onFinalize=o,c.shouldUnsubscribe=a,c._next=i?function(l){try{i(l)}catch(u){t.error(u)}}:n.prototype._next,c._error=s?function(l){try{s(l)}catch(u){t.error(u)}finally{this.unsubscribe()}}:n.prototype._error,c._complete=r?function(){try{r()}catch(l){t.error(l)}finally{this.unsubscribe()}}:n.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e})(Ns),fg=Ls(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Ht=(function(n){ft(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new va(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new fg},e.prototype.next=function(t){var i=this;hi(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var o=hn(i.currentObservers),a=o.next();!a.done;a=o.next()){var c=a.value;c.next(t)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;hi(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;hi(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=this,s=r.hasError,o=r.isStopped,a=r.observers;return s||o?ql:(this.currentObservers=null,a.push(t),new qn(function(){i.currentObservers=null,Ii(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,s=i.thrownError,o=i.isStopped;r?t.error(s):o&&t.complete()},e.prototype.asObservable=function(){var t=new le;return t.source=this,t},e.create=function(t,i){return new va(t,i)},e})(le),va=(function(n){ft(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:ql},e})(Ht),Kl=(function(n){ft(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,s=t._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e})(Ht),pg={now:function(){return Date.now()}},mg=(function(n){ft(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e})(qn),ba={setInterval:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setInterval.apply(void 0,jn([n,e],fn(t)))},clearInterval:function(n){return clearInterval(n)},delegate:void 0},gg=(function(n){ft(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=t;var s=this.id,o=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(o,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(o,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),ba.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&ba.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,s;try{this.work(t)}catch(o){r=!0,s=o||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Ii(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e})(mg),ya=(function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=pg.now,n})(),vg=(function(n){ft(e,n);function e(t,i){i===void 0&&(i=ya.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e})(ya),bg=new vg(gg);function yg(n){return n&&$(n.schedule)}function kg(n){return n[n.length-1]}function js(n){return yg(kg(n))?n.pop():void 0}var Bs=(function(n){return n&&typeof n.length=="number"&&typeof n!="function"});function zl(n){return $(n?.then)}function Gl(n){return $(n[Us])}function Jl(n){return Symbol.asyncIterator&&$(n?.[Symbol.asyncIterator])}function $l(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Sg(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Ql=Sg();function Yl(n){return $(n?.[Ql])}function Xl(n){return tg(this,arguments,function(){var e,t,i,r;return Vl(this,function(s){switch(s.label){case 0:e=n.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,cn(e.read())];case 3:return t=s.sent(),i=t.value,r=t.done,r?[4,cn(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,cn(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Zl(n){return $(n?.getReader)}function pt(n){if(n instanceof le)return n;if(n!=null){if(Gl(n))return Tg(n);if(Bs(n))return Cg(n);if(zl(n))return Eg(n);if(Jl(n))return eu(n);if(Yl(n))return wg(n);if(Zl(n))return Pg(n)}throw $l(n)}function Tg(n){return new le(function(e){var t=n[Us]();if($(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Cg(n){return new le(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function Eg(n){return new le(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Hl)})}function wg(n){return new le(function(e){var t,i;try{for(var r=hn(n),s=r.next();!s.done;s=r.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(a){t={error:a}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function eu(n){return new le(function(e){Rg(n,e).catch(function(t){return e.error(t)})})}function Pg(n){return eu(Xl(n))}function Rg(n,e){var t,i,r,s;return eg(this,void 0,void 0,function(){var o,a;return Vl(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=ng(n),c.label=1;case 1:return[4,t.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(o=i.value,e.next(o),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),r={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=t.return)?[4,s.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Rt(n,e,t,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function tu(n,e){return e===void 0&&(e=0),Ge(function(t,i){t.subscribe(Ke(i,function(r){return Rt(i,n,function(){return i.next(r)},e)},function(){return Rt(i,n,function(){return i.complete()},e)},function(r){return Rt(i,n,function(){return i.error(r)},e)}))})}function nu(n,e){return e===void 0&&(e=0),Ge(function(t,i){i.add(n.schedule(function(){return t.subscribe(i)},e))})}function _g(n,e){return pt(n).pipe(nu(e),tu(e))}function Ig(n,e){return pt(n).pipe(nu(e),tu(e))}function Og(n,e){return new le(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function xg(n,e){return new le(function(t){var i;return Rt(t,e,function(){i=n[Ql](),Rt(t,e,function(){var r,s,o;try{r=i.next(),s=r.value,o=r.done}catch(a){t.error(a);return}o?t.complete():t.next(s)},0,!0)}),function(){return $(i?.return)&&i.return()}})}function iu(n,e){if(!n)throw new Error("Iterable cannot be null");return new le(function(t){Rt(t,e,function(){var i=n[Symbol.asyncIterator]();Rt(t,e,function(){i.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function Mg(n,e){return iu(Xl(n),e)}function Dg(n,e){if(n!=null){if(Gl(n))return _g(n,e);if(Bs(n))return Og(n,e);if(zl(n))return Ig(n,e);if(Jl(n))return iu(n,e);if(Yl(n))return xg(n,e);if(Zl(n))return Mg(n,e)}throw $l(n)}function Vs(n,e){return e?Dg(n,e):pt(n)}function ka(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=js(n);return Vs(n,t)}function Ag(n){return n instanceof Date&&!isNaN(n)}var Lg=Ls(function(n){return function(e){e===void 0&&(e=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function Ng(n,e){var t=Ag(n)?{first:n}:typeof n=="number"?{each:n}:n,i=t.first,r=t.each,s=t.with,o=s===void 0?Ug:s,a=t.scheduler,c=a===void 0?bg:a,l=t.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return Ge(function(d,h){var p,b,m=null,T=0,S=function(P){b=Rt(h,c,function(){try{p.unsubscribe(),pt(o({meta:u,lastValue:m,seen:T})).subscribe(h)}catch(_){h.error(_)}},P)};p=d.subscribe(Ke(h,function(P){b?.unsubscribe(),T++,h.next(m=P),r>0&&S(r)},void 0,void 0,function(){b!=null&&b.closed||b==null||b.unsubscribe(),m=null})),!T&&S(i!=null?typeof i=="number"?i:+i-c.now():r)})}function Ug(n){throw new Lg(n)}function re(n,e){return Ge(function(t,i){var r=0;t.subscribe(Ke(i,function(s){i.next(n.call(e,s,r++))}))})}var Fg=Array.isArray;function jg(n,e){return Fg(e)?n.apply(void 0,jn([],fn(e))):n(e)}function Bg(n){return re(function(e){return jg(n,e)})}function Vg(n,e,t,i,r,s,o,a){var c=[],l=0,u=0,d=!1,h=function(){d&&!c.length&&!l&&e.complete()},p=function(m){return l<i?b(m):c.push(m)},b=function(m){l++;var T=!1;pt(t(m,u++)).subscribe(Ke(e,function(S){e.next(S)},function(){T=!0},void 0,function(){if(T)try{l--;for(var S=function(){var P=c.shift();o||b(P)};c.length&&l<i;)S();h()}catch(P){e.error(P)}}))};return n.subscribe(Ke(e,p,function(){d=!0,h()})),function(){}}function qs(n,e,t){return t===void 0&&(t=1/0),$(e)?qs(function(i,r){return re(function(s,o){return e(i,s,r,o)})(pt(n(i,r)))},t):(typeof e=="number"&&(t=e),Ge(function(i,r){return Vg(i,r,n,t)}))}function qg(n){return qs(Fs,n)}function Wg(){return qg(1)}function xi(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Wg()(Vs(n,js(n)))}var Hg=["addListener","removeListener"],Kg=["addEventListener","removeEventListener"],zg=["on","off"];function ts(n,e,t,i){if($(t)&&(i=t,t=void 0),i)return ts(n,e,t).pipe(Bg(i));var r=fn($g(n)?Kg.map(function(a){return function(c){return n[a](e,c,t)}}):Gg(n)?Hg.map(Sa(n,e)):Jg(n)?zg.map(Sa(n,e)):[],2),s=r[0],o=r[1];if(!s&&Bs(n))return qs(function(a){return ts(a,e,t)})(pt(n));if(!s)throw new TypeError("Invalid event target");return new le(function(a){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return a.next(1<l.length?l:l[0])};return s(c),function(){return o(c)}})}function Sa(n,e){return function(t){return function(i){return n[t](e,i)}}}function Gg(n){return $(n.addListener)&&$(n.removeListener)}function Jg(n){return $(n.on)&&$(n.off)}function $g(n){return $(n.addEventListener)&&$(n.removeEventListener)}function Ji(n,e){return Ge(function(t,i){var r=0;t.subscribe(Ke(i,function(s){return n.call(e,s,r++)&&i.next(s)}))})}function Qg(n,e,t,i,r){return function(s,o){var a=t,c=e,l=0;s.subscribe(Ke(o,function(u){var d=l++;c=a?n(c,u,d):(a=!0,u),o.next(c)},r))}}function Yg(n,e){return e===void 0&&(e=Fs),n=n??Xg,Ge(function(t,i){var r,s=!0;t.subscribe(Ke(i,function(o){var a=e(o);(s||!n(r,a))&&(s=!1,r=a,i.next(o))}))})}function Xg(n,e){return n===e}function Ta(n,e){return Ge(Qg(n,e,arguments.length>=2,!0))}function Zg(n){return Ge(function(e,t){var i=!1,r=Ke(t,function(){r?.unsubscribe(),i=!0},Oi);pt(n).subscribe(r),e.subscribe(Ke(t,function(s){return i&&t.next(s)}))})}function Je(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=js(n);return Ge(function(i,r){(t?xi(n,i,t):xi(n,i)).subscribe(r)})}function Ca(n){return Ge(function(e,t){pt(n).subscribe(Ke(t,function(){return t.complete()},Oi)),!t.closed&&e.subscribe(t)})}var ev=Object.defineProperty,tv=Object.defineProperties,nv=Object.getOwnPropertyDescriptors,Ea=Object.getOwnPropertySymbols,iv=Object.prototype.hasOwnProperty,rv=Object.prototype.propertyIsEnumerable,wa=(n,e,t)=>e in n?ev(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,St=(n,e)=>{for(var t in e||(e={}))iv.call(e,t)&&wa(n,t,e[t]);if(Ea)for(var t of Ea(e))rv.call(e,t)&&wa(n,t,e[t]);return n},Cn=(n,e)=>tv(n,nv(e)),ze=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{a(t.next(c))}catch(l){r(l)}},o=c=>{try{a(t.throw(c))}catch(l){r(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(n,e)).next())}),ru="lk";function ce(n){return typeof n>"u"?!1:sv(n)||ov(n)}function sv(n){var e;return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("track")&&typeof((e=n.publication)==null?void 0:e.track)<"u":!1}function ov(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("publication")&&typeof n.publication<"u":!1}function Bn(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&typeof n.publication>"u":!1}function he(n){if(typeof n=="string"||typeof n=="number")return`${n}`;if(Bn(n))return`${n.participant.identity}_${n.source}_placeholder`;if(ce(n))return`${n.participant.identity}_${n.publication.source}_${n.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${n}`)}function av(n,e){return n===void 0||e===void 0?!1:ce(n)&&ce(e)?n.publication.trackSid===e.publication.trackSid:he(n)===he(e)}function su(n,e){return typeof e>"u"?!1:ce(n)?e.some(t=>t.participant.identity===n.participant.identity&&ce(t)&&t.publication.trackSid===n.publication.trackSid):Bn(n)?e.some(t=>t.participant.identity===n.participant.identity&&Bn(t)&&t.source===n.source):!1}function cv(n,e){return Bn(n)&&ce(e)&&e.participant.identity===n.participant.identity&&e.source===n.source}function lv(){const n=document.createElement("p");n.style.width="100%",n.style.height="200px";const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(n),document.body.appendChild(e);const t=n.offsetWidth;e.style.overflow="scroll";let i=n.offsetWidth;return t===i&&(i=e.clientWidth),document.body.removeChild(e),t-i}function uv(){return typeof document<"u"}function dv(n,e,t){return Km(n,e,()=>ze(this,null,function*(){const{x:i,y:r}=yield $m(n,e,{placement:"top",middleware:[zm(6),Jm(),Gm({padding:5})]});t?.(i,r)}))}function hv(n,e){return!n.contains(e.target)}var fv=[I.ConnectionStateChanged,I.RoomMetadataChanged,I.ActiveSpeakersChanged,I.ConnectionQualityChanged,I.ParticipantConnected,I.ParticipantDisconnected,I.ParticipantPermissionsChanged,I.ParticipantMetadataChanged,I.ParticipantNameChanged,I.ParticipantAttributesChanged,I.TrackMuted,I.TrackUnmuted,I.TrackPublished,I.TrackUnpublished,I.TrackStreamStateChanged,I.TrackSubscriptionFailed,I.TrackSubscriptionPermissionChanged,I.TrackSubscriptionStatusChanged],pv=[...fv,I.LocalTrackPublished,I.LocalTrackUnpublished];M.TrackPublished,M.TrackUnpublished,M.TrackMuted,M.TrackUnmuted,M.TrackStreamStateChanged,M.TrackSubscribed,M.TrackUnsubscribed,M.TrackSubscriptionPermissionChanged,M.TrackSubscriptionFailed,M.LocalTrackPublished,M.LocalTrackUnpublished;var mv=[M.ConnectionQualityChanged,M.IsSpeakingChanged,M.ParticipantMetadataChanged,M.ParticipantPermissionsChanged,M.TrackMuted,M.TrackUnmuted,M.TrackPublished,M.TrackUnpublished,M.TrackStreamStateChanged,M.TrackSubscriptionFailed,M.TrackSubscriptionPermissionChanged,M.TrackSubscriptionStatusChanged];[...mv,M.LocalTrackPublished,M.LocalTrackUnpublished];var B=Zm.getLogger("lk-components-js");B.setDefaultLevel("WARN");var gv=[{columns:1,rows:1},{columns:1,rows:2,orientation:"portrait"},{columns:2,rows:1,orientation:"landscape"},{columns:2,rows:2,minWidth:560},{columns:3,rows:3,minWidth:700},{columns:4,rows:4,minWidth:960},{columns:5,rows:5,minWidth:1100}];function ou(n,e,t,i){if(n.length<1)throw new Error("At least one grid layout definition must be provided.");const r=vv(n);if(t<=0||i<=0)return r[0];let s=0;const o=t/i>1?"landscape":"portrait";let a=r.find((c,l,u)=>{s=l;const d=u.findIndex((h,p)=>{const b=!h.orientation||h.orientation===o,m=p>l,T=h.maxTiles===c.maxTiles;return m&&T&&b})!==-1;return c.maxTiles>=e&&!d});if(a===void 0)if(a=r[r.length-1],a)B.warn(`No layout found for: participantCount: ${e}, width/height: ${t}/${i} fallback to biggest available layout (${a}).`);else throw new Error("No layout or fallback layout found.");if((t<a.minWidth||i<a.minHeight)&&s>0){const c=r[s-1];a=ou(r.slice(0,s),c.maxTiles,t,i)}return a}function vv(n){return[...n].map(e=>{var t,i;return{name:`${e.columns}x${e.rows}`,columns:e.columns,rows:e.rows,maxTiles:e.columns*e.rows,minWidth:(t=e.minWidth)!=null?t:0,minHeight:(i=e.minHeight)!=null?i:0,orientation:e.orientation}}).sort((e,t)=>e.maxTiles!==t.maxTiles?e.maxTiles-t.maxTiles:e.minWidth!==0||t.minWidth!==0?e.minWidth-t.minWidth:e.minHeight!==0||t.minHeight!==0?e.minHeight-t.minHeight:0)}function bv(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}var au=(n=>(n.AgentState="lk.agent.state",n.PublishOnBehalf="lk.publish_on_behalf",n.TranscriptionFinal="lk.transcription_final",n.TranscriptionSegmentId="lk.segment_id",n.TranscribedTrackId="lk.transcribed_track_id",n))(au||{}),cu=[],lu={showChat:!1,unreadMessages:0,showSettings:!1};function uu(n){return typeof n=="object"}function du(n){return Array.isArray(n)&&n.filter(uu).length>0}function yv(n,e){return e.audioLevel-n.audioLevel}function kv(n,e){return n.isSpeaking===e.isSpeaking?0:n.isSpeaking?-1:1}function Sv(n,e){var t,i,r,s;return n.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(t=e.lastSpokeAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=n.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function ns(n,e){var t,i,r,s;return((i=(t=n.joinedAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function Tv(n,e){return ce(n)?ce(e)?0:-1:ce(e)?1:0}function Cv(n,e){const t=n.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return t!==i?t?-1:1:0}function Ev(n){const e=[],t=[],i=[],r=[];n.forEach(a=>{a.participant.isLocal&&a.source===E.Source.Camera?e.push(a):a.source===E.Source.ScreenShare?t.push(a):a.source===E.Source.Camera?i.push(a):r.push(a)});const s=wv(t),o=Pv(i);return[...e,...s,...o,...r]}function wv(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),e.sort((i,r)=>ns(i.participant,r.participant)),t.sort((i,r)=>ns(i.participant,r.participant)),[...t,...e]}function Pv(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),t.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?yv(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?kv(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?Sv(i.participant,r.participant):ce(i)!==ce(r)?Tv(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?Cv(i,r):ns(i.participant,r.participant)),[...e,...t]}function Rv(n,e){return n.reduce((t,i,r)=>r%e===0?[...t,[i]]:[...t.slice(0,-1),[...t.slice(-1)[0],i]],[])}function Pa(n,e){const t=Math.max(n.length,e.length);return new Array(t).fill([]).map((i,r)=>[n[r],e[r]])}function Mi(n,e,t){return n.filter(i=>!e.map(r=>t(r)).includes(t(i)))}function is(n){return n.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:he(e))}function _v(n,e){return{dropped:Mi(n,e,he),added:Mi(e,n,he)}}function Iv(n){return n.added.length!==0||n.dropped.length!==0}function rs(n,e){const t=e.findIndex(i=>he(i)===he(n));if(t===-1)throw new Error(`Element not part of the array: ${he(n)} not in ${is(e)}`);return t}function Ov(n,e,t){const i=rs(n,t),r=rs(e,t);return t.splice(i,1,e),t.splice(r,1,n),t}function xv(n,e){const t=rs(n,e);return e.splice(t,1),e}function Mv(n,e){return[...e,n]}function Sr(n,e){return Rv(n,e)}function Dv(n,e,t){let i=Av(n,e);if(i.length<e.length){const o=Mi(e,i,he);i=[...i,...o]}const r=Sr(i,t),s=Sr(e,t);if(Pa(r,s).forEach(([o,a],c)=>{if(o&&a){const l=Sr(i,t)[c],u=_v(l,a);Iv(u)&&(B.debug(`Detected visual changes on page: ${c}, current: ${is(o)}, next: ${is(a)}`,{changes:u}),u.added.length===u.dropped.length&&Pa(u.added,u.dropped).forEach(([d,h])=>{if(d&&h)i=Ov(d,h,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${h}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=xv(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=Mv(d,i)}))}}),i.length>e.length){const o=Mi(i,e,he);i=i.filter(a=>!o.map(he).includes(he(a)))}return i}function Av(n,e){return n.map(t=>e.find(r=>he(t)===he(r)||typeof t!="number"&&Bn(t)&&ce(r)&&cv(t,r))??t)}function Pe(n){return`${ru}-${n}`}function Lv(n){const e=ss(n),t=Ks(n.participant).pipe(re(()=>ss(n)),Je(e));return{className:Pe(n.source===E.Source.Camera||n.source===E.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function ss(n){if(ce(n))return n.publication;{const{source:e,name:t,participant:i}=n;if(e&&t)return i.getTrackPublications().find(r=>r.source===e&&r.trackName===t);if(t)return i.getTrackPublicationByName(t);if(e)return i.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function Ws(n,...e){return new le(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(Je(n))}function $i(n,e){return new le(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function Nv(n){return $i(n,I.ConnectionStateChanged).pipe(re(([e])=>e),Je(n.state))}function Uv(n,e,t=!0){const i=new le(s=>{ht.getLocalDevices(n,t).then(o=>{s.next(o),s.complete()}).catch(o=>{e?.(o),s.next([]),s.complete()})}),r=new le(s=>{var o;const a=()=>ze(this,null,function*(){try{const c=yield ht.getLocalDevices(n,t);s.next(c)}catch(c){e?.(c)}});if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(o=navigator?.mediaDevices)==null||o.addEventListener("devicechange",a)}return()=>{var c;(c=navigator?.mediaDevices)==null||c.removeEventListener("devicechange",a)}});return xi(i,r)}function Fv(n){return $i(n,I.DataReceived)}function jv(n){return Ws(n,I.AudioPlaybackStatusChanged).pipe(re(e=>({canPlayAudio:e.canPlaybackAudio})))}function Bv(n){return Ws(n,I.VideoPlaybackStatusChanged).pipe(re(e=>({canPlayVideo:e.canPlaybackVideo})))}function Vv(n,e){return $i(n,I.ActiveDeviceChanged).pipe(Ji(([t])=>t===e),re(([t,i])=>(B.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:t,deviceId:i}),i)))}function qv(n,e){return $i(n,I.ParticipantEncryptionStatusChanged).pipe(Ji(([,t])=>e?.identity===t?.identity||!t&&e?.identity===n.localParticipant.identity),re(([t])=>t),Je(e!=null&&e.isLocal?e.isE2EEEnabled:!!(e!=null&&e.isEncrypted)))}function Hs(n,...e){return new le(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(Je(n))}function Ks(n){return Hs(n,M.TrackMuted,M.TrackUnmuted,M.ParticipantPermissionsChanged,M.TrackPublished,M.TrackUnpublished,M.LocalTrackPublished,M.LocalTrackUnpublished,M.MediaDevicesError,M.TrackSubscriptionStatusChanged).pipe(re(e=>{const{isMicrophoneEnabled:t,isCameraEnabled:i,isScreenShareEnabled:r}=e,s=e.getTrackPublication(E.Source.Microphone),o=e.getTrackPublication(E.Source.Camera);return{isCameraEnabled:i,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:o,microphoneTrack:s,participant:e}}))}function Wv(n){return n?Hs(n,M.ParticipantMetadataChanged,M.ParticipantNameChanged).pipe(re(({name:e,identity:t,metadata:i})=>({name:e,identity:t,metadata:i})),Je({name:n.name,identity:n.identity,metadata:n.metadata})):void 0}function Hv(n){return zs(n,M.ConnectionQualityChanged).pipe(re(([e])=>e),Je(n.connectionQuality))}function zs(n,e){return new le(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function hu(n){var e,t,i,r;return Hs(n.participant,M.TrackMuted,M.TrackUnmuted,M.TrackSubscribed,M.TrackUnsubscribed,M.LocalTrackPublished,M.LocalTrackUnpublished).pipe(re(s=>{var o,a;const c=(o=n.publication)!=null?o:s.getTrackPublication(n.source);return(a=c?.isMuted)!=null?a:!0}),Je((r=(i=(e=n.publication)==null?void 0:e.isMuted)!=null?i:(t=n.participant.getTrackPublication(n.source))==null?void 0:t.isMuted)!=null?r:!0))}function Kv(n){return zs(n,M.IsSpeakingChanged).pipe(re(([e])=>e))}function zv(n){return zs(n,M.ParticipantPermissionsChanged).pipe(re(()=>n.permissions),Je(n.permissions))}function Gv(n,e,t,i,r){const{localParticipant:s}=e,o=(u,d)=>{let h=!1;switch(u){case E.Source.Camera:h=d.isCameraEnabled;break;case E.Source.Microphone:h=d.isMicrophoneEnabled;break;case E.Source.ScreenShare:h=d.isScreenShareEnabled;break}return h},a=Ks(s).pipe(re(u=>o(n,u.participant)),Je(o(n,s))),c=new Ht,l=(u,d)=>ze(this,null,function*(){try{switch(d??(d=t),c.next(!0),n){case E.Source.Camera:return yield s.setCameraEnabled(u??!s.isCameraEnabled,d,i),s.isCameraEnabled;case E.Source.Microphone:return yield s.setMicrophoneEnabled(u??!s.isMicrophoneEnabled,d,i),s.isMicrophoneEnabled;case E.Source.ScreenShare:return yield s.setScreenShareEnabled(u??!s.isScreenShareEnabled,d,i),s.isScreenShareEnabled;default:throw new TypeError("Tried to toggle unsupported source")}}catch(h){if(r&&h instanceof Error){r?.(h);return}else throw h}finally{c.next(!1)}});return{className:Pe("button"),toggle:l,enabledObserver:a,pendingObserver:c.asObservable()}}function Jv(){let n=!1;const e=new Ht,t=new Ht,i=r=>ze(this,null,function*(){t.next(!0),n=r??!n,e.next(n),t.next(!1)});return{className:Pe("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:t.asObservable()}}function $v(n,e,t){const i=new Kl(void 0),r=Vv(e,n),s=(o,...a)=>ze(this,[o,...a],function*(c,l={}){var u,d,h;if(e){const p=ke();if(n==="audiooutput"&&(p?.name==="Safari"||p?.os==="iOS")){B.warn("Switching audio output device is not supported on Safari and iOS.");return}B.debug(`Switching active device of kind "${n}" with id ${c}.`),yield e.switchActiveDevice(n,c,l.exact);const b=(u=e.getActiveDevice(n))!=null?u:c;b!==c&&c!=="default"&&B.info(`We tried to select the device with id (${c}), but the browser decided to select the device with id (${b}) instead.`);let m;n==="audioinput"?m=(d=e.localParticipant.getTrackPublication(E.Source.Microphone))==null?void 0:d.track:n==="videoinput"&&(m=(h=e.localParticipant.getTrackPublication(E.Source.Camera))==null?void 0:h.track);const T=c==="default"&&!m||c==="default"&&m?.mediaStreamTrack.label.startsWith("Default");i.next(T?c:b)}});return{className:Pe("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function Qv(n){const e=t=>{n.disconnect(t)};return{className:Pe("disconnect-button"),disconnect:e}}function Yv(n){const e=Pe("connection-quality"),t=Hv(n);return{className:e,connectionQualityObserver:t}}function Xv(n){let e="track-muted-indicator-camera";switch(n.source){case E.Source.Camera:e="track-muted-indicator-camera";break;case E.Source.Microphone:e="track-muted-indicator-microphone";break}const t=Pe(e),i=hu(n);return{className:t,mediaMutedObserver:i}}function Zv(n){return{className:"lk-participant-name",infoObserver:Wv(n)}}function e0(){return{className:Pe("participant-tile")}}var t0={CHAT:"lk.chat"},n0={CHAT:"lk-chat-topic"};function fu(n,e){return ze(this,arguments,function*(t,i,r={}){const{reliable:s,destinationIdentities:o,topic:a}=r;yield t.publishData(i,{destinationIdentities:o,topic:a,reliable:s})})}function i0(n,e,t){const i=Array.isArray(e)?e:[e],r=Fv(n).pipe(Ji(([,,,a])=>e===void 0||a!==void 0&&i.includes(a)),re(([a,c,,l])=>({payload:a,topic:l,from:c})));let s;const o=new le(a=>{s=a});return{messageObservable:r,isSendingObservable:o,send:(a,...c)=>ze(this,[a,...c],function*(l,u={}){s.next(!0);try{yield fu(n.localParticipant,l,St({topic:i[0]},u))}finally{s.next(!1)}})}}var Yn=new WeakMap;function r0(n){return n.ignoreLegacy==!0}var s0=n=>JSON.parse(new TextDecoder().decode(n)),o0=n=>new TextEncoder().encode(JSON.stringify(n));function a0(n,e){var t,i,r,s,o,a;const c=()=>{var g,y,C;return((g=n.serverInfo)==null?void 0:g.edition)===1||!!((y=n.serverInfo)!=null&&y.version)&&qe((C=n.serverInfo)==null?void 0:C.version,"1.8.2")>0},l=new Ht,u=(t=e?.channelTopic)!=null?t:t0.CHAT,d=(i=e?.channelTopic)!=null?i:n0.CHAT;let h=!1;Yn.has(n)||(h=!0);const p=(r=Yn.get(n))!=null?r:new Map,b=(s=p.get(u))!=null?s:new Ht;p.set(u,b),Yn.set(n,p);const m=(o=e?.messageDecoder)!=null?o:s0;if(h){n.registerTextStreamHandler(u,(y,C)=>ze(this,null,function*(){const{id:x,timestamp:R}=y.info;Vs(y).pipe(Ta((O,D)=>O+D),re(O=>({id:x,timestamp:R,message:O,from:n.getParticipantByIdentity(C.identity),type:"chatMessage"}))).subscribe({next:O=>b.next(O)})}));const{messageObservable:g}=i0(n,[d]);g.pipe(re(y=>{const C=m(y.payload);return r0(C)?void 0:Cn(St({},C),{type:"chatMessage",from:y.from})}),Ji(y=>!!y),Ca(l)).subscribe(b)}const T=b.pipe(Ta((g,y)=>{if("id"in y&&g.find(C=>{var x,R;return((x=C.from)==null?void 0:x.identity)===((R=y.from)==null?void 0:R.identity)&&C.id===y.id})){const C=g.findIndex(x=>x.id===y.id);if(C>-1){const x=g[C];g[C]=Cn(St({},y),{timestamp:x.timestamp,editTimestamp:y.timestamp})}return[...g]}return[...g,y]},[]),Ca(l)),S=new Kl(!1),P=(a=e?.messageEncoder)!=null?a:o0,_=(g,y)=>ze(this,null,function*(){y||(y={}),y.topic!=null||(y.topic=u),S.next(!0);try{const C={id:(yield n.localParticipant.sendText(g,y)).id,timestamp:Date.now(),message:g},x=Cn(St({},C),{attachedFiles:y.attachments}),R=Cn(St({},x),{type:"chatMessage",from:n.localParticipant,attributes:y.attributes});b.next(R);const O=P(Cn(St({},C),{ignoreLegacy:c()}));try{yield fu(n.localParticipant,O,{reliable:!0,topic:d})}catch(D){B.info("could not send message in legacy chat format",D)}return R}finally{S.next(!1)}});function v(){l.next(),l.complete(),b.complete(),Yn.delete(n),n.unregisterTextStreamHandler(u)}return n.once(I.Disconnected,v),{messageObservable:T,isSendingObservable:S,send:_}}function c0(){const n=e=>ze(this,null,function*(){B.info("Start Audio for room: ",e),yield e.startAudio()});return{className:Pe("start-audio-button"),roomAudioPlaybackAllowedObservable:jv,handleStartAudioPlayback:n}}function l0(){const n=e=>ze(this,null,function*(){B.info("Start Video for room: ",e),yield e.startVideo()});return{className:Pe("start-audio-button"),roomVideoPlaybackAllowedObservable:Bv,handleStartVideoPlayback:n}}function u0(){return{className:[Pe("button"),Pe("chat-toggle")].join(" ")}}function d0(){return{className:[Pe("button"),Pe("focus-toggle-button")].join(" ")}}function h0(){return{className:"lk-room-container"}}function Ra(n,e,t=!0){const i=[n.localParticipant,...Array.from(n.remoteParticipants.values())],r=[];return i.forEach(s=>{e.forEach(o=>{const a=Array.from(s.trackPublications.values()).filter(c=>c.source===o&&(!t||c.track)).map(c=>({participant:s,publication:c,source:c.source}));r.push(...a)})}),{trackReferences:r,participants:i}}function f0(n,e,t){var i,r;const s=(i=t.additionalRoomEvents)!=null?i:pv,o=(r=t.onlySubscribed)!=null?r:!0,a=Array.from(new Set([I.ParticipantConnected,I.ParticipantDisconnected,I.ConnectionStateChanged,I.LocalTrackPublished,I.LocalTrackUnpublished,I.TrackPublished,I.TrackUnpublished,I.TrackSubscriptionStatusChanged,...s]).values());return Ws(n,...a).pipe(re(c=>{const l=Ra(c,e,o);return B.debug(`TrackReference[] was updated. (length ${l.trackReferences.length})`,l),l}),Je(Ra(n,e,o)))}function p0(n,e=1e3){if(n===null)return ka(!1);const t=ts(n,"mousemove",{passive:!0}).pipe(re(()=>!0)),i=t.pipe(Ng({each:e,with:()=>xi(ka(!1),i.pipe(Zg(t)))}),Yg());return i}function m0(n,e){if(typeof localStorage>"u"){B.error("Local storage is not available.");return}try{if(e){const t=Object.fromEntries(Object.entries(e).filter(([,i])=>i!==""));localStorage.setItem(n,JSON.stringify(t))}}catch(t){B.error(`Error setting item to local storage: ${t}`)}}function g0(n){if(typeof localStorage>"u"){B.error("Local storage is not available.");return}try{const e=localStorage.getItem(n);if(!e){B.warn(`Item with key ${n} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){B.error(`Error getting item from local storage: ${e}`);return}}function v0(n){return{load:()=>g0(n),save:e=>m0(n,e)}}var b0=`${ru}-user-choices`,En={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"default",audioDeviceId:"default",username:""},{load:y0,save:k0}=v0(b0);function S0(n,e=!1){e!==!0&&k0(n)}function T0(n,e=!1){var t,i,r,s,o;const a={videoEnabled:(t=n?.videoEnabled)!=null?t:En.videoEnabled,audioEnabled:(i=n?.audioEnabled)!=null?i:En.audioEnabled,videoDeviceId:(r=n?.videoDeviceId)!=null?r:En.videoDeviceId,audioDeviceId:(s=n?.audioDeviceId)!=null?s:En.audioDeviceId,username:(o=n?.username)!=null?o:En.username};if(e)return a;{const c=y0();return St(St({},a),c??{})}}function pu(n,e){if(e.msg==="show_chat")return{...n,showChat:!0,unreadMessages:0};if(e.msg==="hide_chat")return{...n,showChat:!1};if(e.msg==="toggle_chat"){const t={...n,showChat:!n.showChat};return t.showChat===!0&&(t.unreadMessages=0),t}else return e.msg==="unread_msg"?{...n,unreadMessages:e.count}:e.msg==="toggle_settings"?{...n,showSettings:!n.showSettings}:{...n}}function mu(n,e){return e.msg==="set_pin"?[e.trackReference]:e.msg==="clear_pin"?[]:{...n}}const Qi=f.createContext(void 0);function gu(){const n=f.useContext(Qi);if(!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function C0(n){const e=Wn();if(n??(n=e),!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function E0(){const[n,e]=f.useReducer(mu,cu),[t,i]=f.useReducer(pu,lu);return{pin:{dispatch:e,state:n},widget:{dispatch:i,state:t}}}function w0(n){const[e,t]=f.useReducer(mu,cu),[i,r]=f.useReducer(pu,lu);return n??{pin:{dispatch:t,state:e},widget:{dispatch:r,state:i}}}function Wn(){return f.useContext(Qi)}const Gs=f.createContext(void 0);function Yi(){return f.useContext(Gs)}function mn(n){const e=Yi(),t=n??e;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}const vu=f.createContext(void 0);function bu(){return f.useContext(vu)}function Hn(n){const e=bu(),t=Yi(),i=n??e??t?.participant;if(!i)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return i}const Js=f.createContext(void 0);function $s(){const n=f.useContext(Js);if(!n)throw Error("tried to access room context outside of livekit room component");return n}function Xi(){return f.useContext(Js)}function zt(n){const e=Xi(),t=n??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}f.createContext(void 0);const yu=f.createContext(void 0);function P0(n){return f.useContext(yu)}var _a={};function ku(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=ku(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function Su(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=ku(n))&&(i&&(i+=" "),i+=e);return i}function R0(...n){return(...e)=>{for(const t of n)if(typeof t=="function")try{t(...e)}catch(i){console.error(i)}}}function rt(...n){const e={...n[0]};for(let t=1;t<n.length;t++){const i=n[t];for(const r in i){const s=e[r],o=i[r];typeof s=="function"&&typeof o=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=R0(s,o):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof o=="string"?e[r]=Su(s,o):e[r]=o!==void 0?o:s}}return e}function _0(n){return n!==void 0}function mt(...n){return rt(...n.filter(_0))}function Tu(n,e,t){return f.Children.map(n,i=>f.isValidElement(i)&&f.Children.only(n)?(i.props.className&&(e??(e={}),e.className=Su(i.props.className,e.className),e.style={...i.props.style,...e.style}),f.cloneElement(i,{...e,key:t})):i)}function I0(n){var e,t;if(typeof window<"u"&&typeof process<"u"&&(((e=process==null?void 0:_a)==null?void 0:e.NODE_ENV)==="dev"||((t=process==null?void 0:_a)==null?void 0:t.NODE_ENV)==="development")){const i=document.querySelector(".lk-room-container");i&&!getComputedStyle(i).getPropertyValue("--lk-has-imported-styles")&&B.warn("It looks like you're not using the `@livekit/components-styles package`. To render the UI with the default styling, please import it in your layout or page.")}}function O0(n,e){return n==="processor"&&e&&typeof e=="object"&&"name"in e?e.name:n==="e2ee"&&e?"e2ee-enabled":e}const x0={connect:!0,audio:!1,video:!1};function M0(n){const{token:e,serverUrl:t,options:i,room:r,connectOptions:s,connect:o,audio:a,video:c,screen:l,onConnected:u,onDisconnected:d,onError:h,onMediaDeviceFailure:p,onEncryptionError:b,simulateParticipants:m,...T}={...x0,...n};i&&r&&B.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[S,P]=f.useState(),_=f.useRef(o);f.useEffect(()=>{P(r??new ht(i))},[r,JSON.stringify(i,O0)]);const v=f.useMemo(()=>{const{className:g}=h0();return rt(T,{className:g})},[T]);return f.useEffect(()=>{if(!S)return;const g=()=>{const O=S.localParticipant;B.debug("trying to publish local tracks"),Promise.all([O.setMicrophoneEnabled(!!a,typeof a!="boolean"?a:void 0),O.setCameraEnabled(!!c,typeof c!="boolean"?c:void 0),O.setScreenShareEnabled(!!l,typeof l!="boolean"?l:void 0)]).catch(D=>{B.warn(D),h?.(D)})},y=(O,D)=>{const U=An.getFailure(O);p?.(U,D)},C=O=>{b?.(O)},x=O=>{d?.(O)},R=()=>{u?.()};return S.on(I.SignalConnected,g).on(I.MediaDevicesError,y).on(I.EncryptionError,C).on(I.Disconnected,x).on(I.Connected,R),()=>{S.off(I.SignalConnected,g).off(I.MediaDevicesError,y).off(I.EncryptionError,C).off(I.Disconnected,x).off(I.Connected,R)}},[S,a,c,l,h,b,p,u,d]),f.useEffect(()=>{if(S){if(m){S.simulateParticipants({participants:{count:m},publish:{audio:!0,useRealTracks:!0}});return}if(o){if(_.current=!0,B.debug("connecting"),!e){B.debug("no token yet");return}if(!t){B.warn("no livekit url provided"),h?.(Error("no livekit url provided"));return}S.connect(t,e,s).catch(g=>{B.warn(g),_.current===!0&&h?.(g)})}else B.debug("disconnecting because connect is false"),_.current=!1,S.disconnect()}},[o,e,JSON.stringify(s),S,h,t,m]),f.useEffect(()=>{if(S)return()=>{B.info("disconnecting on onmount"),S.disconnect()}},[S]),{room:S,htmlProps:v}}const uy=f.forwardRef(function(n,e){const{room:t,htmlProps:i}=M0(n);return f.createElement("div",{ref:e,...i},t&&f.createElement(Js.Provider,{value:t},f.createElement(yu.Provider,{value:n.featureFlags},n.children)))}),D0=n=>{const e=f.useRef(n);return f.useEffect(()=>{e.current=n}),e};function A0(n,e){const t=N0(),i=D0(e);return f.useLayoutEffect(()=>{let r=!1;const s=n.current;if(!s)return;function o(a,c){r||i.current(a,c)}return t?.subscribe(s,o),()=>{r=!0,t?.unsubscribe(s,o)}},[n.current,t,i]),t?.observer}function L0(){let n=!1,e=[];const t=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),n||window.requestAnimationFrame(()=>{const o=new Set;for(let a=0;a<e.length;a++){if(o.has(e[a].target))continue;o.add(e[a].target);const c=t.get(e[a].target);c?.forEach(l=>l(e[a],s))}e=[],n=!1}),n=!0});return{observer:i,subscribe(r,s){i.observe(r);const o=t.get(r)??[];o.push(s),t.set(r,o)},unsubscribe(r,s){const o=t.get(r)??[];if(o.length===1){i.unobserve(r),t.delete(r);return}const a=o.indexOf(s);a!==-1&&o.splice(a,1),t.set(r,o)}}}let Ia;const N0=()=>Ia||(Ia=L0()),Cu=n=>{const[e,t]=f.useState({width:0,height:0});f.useLayoutEffect(()=>{if(n.current){const{width:r,height:s}=n.current.getBoundingClientRect();t({width:r,height:s})}},[n.current]);const i=f.useCallback(r=>t(r.contentRect),[]);return A0(n,i),e};function Re(n,e,t=!0){const[i,r]=f.useState(e);return f.useEffect(()=>{if(t&&r(e),typeof window>"u"||!n)return;const s=n.subscribe(r);return()=>s.unsubscribe()},[n,t]),i}function U0(n){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[t,i]=f.useState(e(n));function r(){i(e(n))}return f.useEffect(()=>{const s=window.matchMedia(n);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[n]),t}function F0(n={}){const e=Hn(n.participant),{className:t,connectionQualityObserver:i}=f.useMemo(()=>Yv(e),[e]),r=Re(i,e.connectionQuality);return{className:t,quality:r}}function Qs(n){const e=zt(n),t=f.useMemo(()=>Nv(e),[e]);return Re(t,e.state)}function j0(n){const e=$s(),t=Qs(e);return{buttonProps:f.useMemo(()=>{const{className:i,disconnect:r}=Qv(e);return rt(n,{className:i,onClick:()=>r(n.stopTracks??!0),disabled:t===H.Disconnected})},[e,n,t])}}function B0(n){if(n.publication instanceof Ti){const e=n.publication.track;if(e){const{facingMode:t}=Zp(e);return t}}return"undefined"}function V0({trackRef:n,props:e}){const t=mn(n),i=Wn(),{className:r}=f.useMemo(()=>d0(),[]),s=f.useMemo(()=>su(t,i?.pin.state),[t,i?.pin.state]);return{mergedProps:f.useMemo(()=>rt(e,{className:r,onClick:o=>{var a,c,l,u,d;(a=e.onClick)==null||a.call(e,o),s?(l=i==null?void 0:(c=i.pin).dispatch)==null||l.call(c,{msg:"clear_pin"}):(d=i==null?void 0:(u=i.pin).dispatch)==null||d.call(u,{msg:"set_pin",trackReference:t})}}),[e,r,t,s,i?.pin]),inFocus:s}}function q0(n,e,t={}){const i=t.gridLayouts??gv,{width:r,height:s}=Cu(n),o=ou(i,e,r,s);return f.useEffect(()=>{n.current&&o&&(n.current.style.setProperty("--lk-col-count",o?.columns.toString()),n.current.style.setProperty("--lk-row-count",o?.rows.toString()))},[n,o]),{layout:o,containerWidth:r,containerHeight:s}}function Oa(n,e={}){var t,i;const r=typeof n=="string"?e.participant:n.participant,s=Hn(r),o=typeof n=="string"?{participant:s,source:n}:n,[a,c]=f.useState(!!((t=o.publication)!=null&&t.isMuted||(i=s.getTrackPublication(o.source))!=null&&i.isMuted));return f.useEffect(()=>{const l=hu(o).subscribe(c);return()=>l.unsubscribe()},[he(o)]),a}function W0(n){const e=Hn(n),t=f.useMemo(()=>Kv(e),[e]);return Re(t,e.isSpeaking)}function dy(n={}){const e=zt(n.room),[t,i]=f.useState(e.localParticipant),[r,s]=f.useState(t.isMicrophoneEnabled),[o,a]=f.useState(t.isCameraEnabled),[c,l]=f.useState(t.isScreenShareEnabled),[u,d]=f.useState(t.lastMicrophoneError),[h,p]=f.useState(t.lastCameraError),[b,m]=f.useState(void 0),[T,S]=f.useState(void 0),P=_=>{a(_.isCameraEnabled),s(_.isMicrophoneEnabled),l(_.isScreenShareEnabled),S(_.cameraTrack),m(_.microphoneTrack),d(_.participant.lastMicrophoneError),p(_.participant.lastCameraError),i(_.participant)};return f.useEffect(()=>{const _=Ks(e.localParticipant).subscribe(P);return()=>_.unsubscribe()},[e]),{isMicrophoneEnabled:r,isScreenShareEnabled:c,isCameraEnabled:o,microphoneTrack:b,cameraTrack:T,lastMicrophoneError:u,lastCameraError:h,localParticipant:t}}function H0(){const n=$s(),e=f.useMemo(()=>zv(n.localParticipant),[n]);return Re(e,n.localParticipant.permissions)}function K0({kind:n,room:e,track:t,requestPermissions:i,onError:r}){const s=Xi(),o=f.useMemo(()=>e??s??new ht,[e,s]),a=f.useMemo(()=>Uv(n,r,i),[n,i,r]),c=Re(a,[]),[l,u]=f.useState(o?.getActiveDevice(n)??"default"),{className:d,activeDeviceObservable:h,setActiveMediaDevice:p}=f.useMemo(()=>$v(n,o),[n,o,t]);return f.useEffect(()=>{const b=h.subscribe(m=>{m&&(B.info("setCurrentDeviceId",m),u(m))});return()=>{b?.unsubscribe()}},[h]),{devices:c,className:d,activeDeviceId:l,setActiveMediaDevice:p}}function Eu(n,e,t={}){const i=f.useRef([]),r=f.useRef(-1),s=e!==r.current,o=typeof t.customSortFunction=="function"?t.customSortFunction(n):Ev(n);let a=[...o];if(s===!1)try{a=Dv(i.current,o,e)}catch(c){B.error("Error while running updatePages(): ",c)}return s?i.current=o:i.current=a,r.current=e,a}function z0(n,e){const[t,i]=f.useState(1),r=Math.max(Math.ceil(e.length/n),1);t>r&&i(r);const s=t*n,o=s-n,a=u=>{i(d=>u==="next"?d===r?d:d+1:d===1?d:d-1)},c=u=>{u>r?i(r):u<1?i(1):i(u)},l=Eu(e,n).slice(o,s);return{totalPageCount:r,nextPage:()=>a("next"),prevPage:()=>a("previous"),setPage:c,firstItemIndex:o,lastItemIndex:s,tracks:l,currentPage:t}}function G0({trackRef:n,onParticipantClick:e,disableSpeakingIndicator:t,htmlProps:i}){const r=mn(n),s=f.useMemo(()=>{const{className:h}=e0();return rt(i,{className:h,onClick:p=>{var b;if((b=i.onClick)==null||b.call(i,p),typeof e=="function"){const m=r.publication??r.participant.getTrackPublication(r.source);e({participant:r.participant,track:m})}}})},[i,e,r.publication,r.source,r.participant]),o=r.participant.getTrackPublication(E.Source.Microphone),a=f.useMemo(()=>({participant:r.participant,source:E.Source.Microphone,publication:o}),[o,r.participant]),c=Oa(r),l=Oa(a),u=W0(r.participant),d=B0(r);return{elementProps:{"data-lk-audio-muted":l,"data-lk-video-muted":c,"data-lk-speaking":t===!0?!1:u,"data-lk-local-participant":r.participant.isLocal,"data-lk-source":r.source,"data-lk-facing-mode":d,...s}}}function J0(n){return n=C0(n),f.useMemo(()=>n?.pin.state!==void 0&&n.pin.state.length>=1?n.pin.state:[],[n.pin.state])}function $0({room:n,props:e}){const t=zt(n),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=f.useMemo(()=>c0(),[]),o=f.useMemo(()=>r(t),[t,r]),{canPlayAudio:a}=Re(o,{canPlayAudio:t.canPlaybackAudio});return{mergedProps:f.useMemo(()=>rt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayAudio:a}}function Q0({room:n,props:e}){const t=zt(n),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=f.useMemo(()=>l0(),[]),o=f.useMemo(()=>r(t),[t,r]),{canPlayVideo:a}=Re(o,{canPlayVideo:t.canPlaybackVideo});return{mergedProps:f.useMemo(()=>rt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayVideo:a}}function Y0(n,e={}){const t=f.useRef(null),i=f.useRef(null),r=e.minSwipeDistance??50,s=c=>{i.current=null,t.current=c.targetTouches[0].clientX},o=c=>{i.current=c.targetTouches[0].clientX},a=f.useCallback(()=>{if(!t.current||!i.current)return;const c=t.current-i.current,l=c>r,u=c<-r;l&&e.onLeftSwipe&&e.onLeftSwipe(),u&&e.onRightSwipe&&e.onRightSwipe()},[r,e]);f.useEffect(()=>{const c=n.current;return c&&(c.addEventListener("touchstart",s,{passive:!0}),c.addEventListener("touchmove",o,{passive:!0}),c.addEventListener("touchend",a,{passive:!0})),()=>{c&&(c.removeEventListener("touchstart",s),c.removeEventListener("touchmove",o),c.removeEventListener("touchend",a))}},[n,a])}function X0({props:n}){const{dispatch:e,state:t}=gu().widget,{className:i}=f.useMemo(()=>u0(),[]);return{mergedProps:f.useMemo(()=>rt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":t!=null&&t.showChat?"true":"false","data-lk-unread-msgs":t?t.unreadMessages<10?t.unreadMessages.toFixed(0):"9+":"0"}),[n,i,e,t])}}function Z0(n){var e,t;const i=mn(n),{className:r,mediaMutedObserver:s}=f.useMemo(()=>Xv(i),[he(i)]);return{isMuted:Re(s,!!((e=i.publication)!=null&&e.isMuted||(t=i.participant.getTrackPublication(i.source))!=null&&t.isMuted)),className:r}}function eb({source:n,onChange:e,initialState:t,captureOptions:i,publishOptions:r,onDeviceError:s,room:o,...a}){var c;const l=Xi(),u=f.useMemo(()=>o??l,[o,l]),d=(c=u?.localParticipant)==null?void 0:c.getTrackPublication(n),h=f.useRef(!1),{toggle:p,className:b,pendingObserver:m,enabledObserver:T}=f.useMemo(()=>u?Gv(n,u,i,r,s):Jv(),[u,n,JSON.stringify(i),r]),S=Re(m,!1),P=Re(T,t??!!(d!=null&&d.isEnabled));f.useEffect(()=>{e?.(P,h.current),h.current=!1},[P,e]),f.useEffect(()=>{t!==void 0&&(B.debug("forcing initial toggle state",n,t),p(t))},[]);const _=f.useMemo(()=>rt(a,{className:b}),[a,b]),v=f.useCallback(g=>{var y;h.current=!0,p().catch(()=>h.current=!1),(y=a.onClick)==null||y.call(a,g)},[a,p]);return{toggle:p,enabled:P,pending:S,track:d,buttonProps:{..._,"aria-pressed":P,"data-lk-source":n,"data-lk-enabled":P,disabled:S,onClick:v}}}function wu(n=[E.Source.Camera,E.Source.Microphone,E.Source.ScreenShare,E.Source.ScreenShareAudio,E.Source.Unknown],e={}){const t=zt(e.room),[i,r]=f.useState([]),[s,o]=f.useState([]),a=f.useMemo(()=>n.map(c=>uu(c)?c.source:c),[JSON.stringify(n)]);return f.useEffect(()=>{const c=f0(t,a,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:l,participants:u})=>{B.debug("setting track bundles",l,u),r(l),o(u)});return()=>c.unsubscribe()},[t,JSON.stringify(e.onlySubscribed),JSON.stringify(e.updateOnlyOn),JSON.stringify(n)]),f.useMemo(()=>{if(du(n)){const c=nb(n,s),l=Array.from(i);return s.forEach(u=>{c.has(u.identity)&&(c.get(u.identity)??[]).forEach(d=>{if(i.find(({participant:p,publication:b})=>u.identity===p.identity&&b.source===d))return;B.debug(`Add ${d} placeholder for participant ${u.identity}.`);const h={participant:u,source:d};l.push(h)})}),l}else return i},[i,s,n])}function tb(n,e){const t=new Set(n);for(const i of e)t.delete(i);return t}function nb(n,e){const t=new Map;if(du(n)){const i=n.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTrackPublications().map(a=>{var c;return(c=a.track)==null?void 0:c.source}).filter(a=>a!==void 0),o=Array.from(tb(new Set(i),new Set(s)));o.length>0&&t.set(r.identity,o)})}return t}function ib(n){const e=zt(n?.room),t=Qs(e),i=f.useMemo(()=>t===H.Disconnected,[t]),r=f.useMemo(()=>a0(e,n),[e,n,i]),s=Re(r.isSendingObservable,!1),o=Re(r.messageObservable,[]);return{send:r.send,chatMessages:o,isSending:s}}function rb(n={}){const[e,t]=f.useState(T0(n.defaults,n.preventLoad??!1)),i=f.useCallback(c=>{t(l=>({...l,audioEnabled:c}))},[]),r=f.useCallback(c=>{t(l=>({...l,videoEnabled:c}))},[]),s=f.useCallback(c=>{t(l=>({...l,audioDeviceId:c}))},[]),o=f.useCallback(c=>{t(l=>({...l,videoDeviceId:c}))},[]),a=f.useCallback(c=>{t(l=>({...l,username:c}))},[]);return f.useEffect(()=>{S0(e,n.preventSave??!1)},[e,n.preventSave]),{userChoices:e,saveAudioInputEnabled:i,saveVideoInputEnabled:r,saveAudioInputDeviceId:s,saveVideoInputDeviceId:o,saveUsername:a}}function sb(n,e={}){const t=Hn(n),i=zt(e.room),r=f.useMemo(()=>qv(i,t),[i,t]);return Re(r,t.isLocal?t.isE2EEEnabled:!!(t!=null&&t.isEncrypted))}au.AgentState;var Xn={exports:{}},xa;function ob(){if(xa)return Xn.exports;xa=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(v,g,y){return Function.prototype.apply.call(v,g,y)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(v){return Object.getOwnPropertyNames(v).concat(Object.getOwnPropertySymbols(v))}:t=function(v){return Object.getOwnPropertyNames(v)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(v){return v!==v};function s(){s.init.call(this)}Xn.exports=s,Xn.exports.once=S,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");o=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+v+".");return this._maxListeners=v,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(v){for(var g=[],y=1;y<arguments.length;y++)g.push(arguments[y]);var C=v==="error",x=this._events;if(x!==void 0)C=C&&x.error===void 0;else if(!C)return!1;if(C){var R;if(g.length>0&&(R=g[0]),R instanceof Error)throw R;var O=new Error("Unhandled error."+(R?" ("+R.message+")":""));throw O.context=R,O}var D=x[v];if(D===void 0)return!1;if(typeof D=="function")e(D,this,g);else for(var U=D.length,z=b(D,U),y=0;y<U;++y)e(z[y],this,g);return!0};function l(v,g,y,C){var x,R,O;if(a(y),R=v._events,R===void 0?(R=v._events=Object.create(null),v._eventsCount=0):(R.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),R=v._events),O=R[g]),O===void 0)O=R[g]=y,++v._eventsCount;else if(typeof O=="function"?O=R[g]=C?[y,O]:[O,y]:C?O.unshift(y):O.push(y),x=c(v),x>0&&O.length>x&&!O.warned){O.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=O.length,i(D)}return v}s.prototype.addListener=function(v,g){return l(this,v,g,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(v,g){return l(this,v,g,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(v,g){return a(g),this.on(v,d(this,v,g)),this},s.prototype.prependOnceListener=function(v,g){return a(g),this.prependListener(v,d(this,v,g)),this},s.prototype.removeListener=function(v,g){var y,C,x,R,O;if(a(g),C=this._events,C===void 0)return this;if(y=C[v],y===void 0)return this;if(y===g||y.listener===g)--this._eventsCount===0?this._events=Object.create(null):(delete C[v],C.removeListener&&this.emit("removeListener",v,y.listener||g));else if(typeof y!="function"){for(x=-1,R=y.length-1;R>=0;R--)if(y[R]===g||y[R].listener===g){O=y[R].listener,x=R;break}if(x<0)return this;x===0?y.shift():m(y,x),y.length===1&&(C[v]=y[0]),C.removeListener!==void 0&&this.emit("removeListener",v,O||g)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(v){var g,y,C;if(y=this._events,y===void 0)return this;if(y.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):y[v]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete y[v]),this;if(arguments.length===0){var x=Object.keys(y),R;for(C=0;C<x.length;++C)R=x[C],R!=="removeListener"&&this.removeAllListeners(R);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(g=y[v],typeof g=="function")this.removeListener(v,g);else if(g!==void 0)for(C=g.length-1;C>=0;C--)this.removeListener(v,g[C]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(v){return h(this,v,!0)},s.prototype.rawListeners=function(v){return h(this,v,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function S(v,g){return new Promise(function(y,C){function x(O){v.removeListener(g,R),C(O)}function R(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}_(v,g,R,{once:!0}),g!=="error"&&P(v,x,{once:!0})})}function P(v,g,y){typeof v.on=="function"&&_(v,"error",g,y)}function _(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(R){C.once&&v.removeEventListener(g,x),y(R)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return Xn.exports}ob();const Pu=f.forwardRef(function(n,e){const{mergedProps:t}=X0({props:n});return f.createElement("button",{ref:e,...t},n.children)}),ab=f.forwardRef(function(n,e){const{buttonProps:t}=j0(n);return f.createElement("button",{ref:e,...t},n.children)}),cb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),f.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),lb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),ub=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,viewBox:"0 0 24 24",...n},f.createElement("path",{fill:"#FFF",d:"M4.99 3.99a1 1 0 0 0-.697 1.717L10.586 12l-6.293 6.293a1 1 0 1 0 1.414 1.414L12 13.414l6.293 6.293a1 1 0 1 0 1.414-1.414L13.414 12l6.293-6.293a1 1 0 0 0-.727-1.717 1 1 0 0 0-.687.303L12 10.586 5.707 4.293a1 1 0 0 0-.717-.303z"})),db=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),Ma=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),hb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),fb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M8.961.894C8.875-.298 7.125-.298 7.04.894c-.066.912-1.246 1.228-1.76.472-.67-.99-2.186-.115-1.664.96.399.824-.465 1.688-1.288 1.289-1.076-.522-1.95.994-.961 1.665.756.513.44 1.693-.472 1.759-1.192.086-1.192 1.836 0 1.922.912.066 1.228 1.246.472 1.76-.99.67-.115 2.186.96 1.664.824-.399 1.688.465 1.289 1.288-.522 1.076.994 1.95 1.665.961.513-.756 1.693-.44 1.759.472.086 1.192 1.836 1.192 1.922 0 .066-.912 1.246-1.228 1.76-.472.67.99 2.186.115 1.664-.96-.399-.824.465-1.688 1.288-1.289 1.076.522 1.95-.994.961-1.665-.756-.513-.44-1.693.472-1.759 1.192-.086 1.192-1.836 0-1.922-.912-.066-1.228-1.246-.472-1.76.99-.67.115-2.186-.96-1.664-.824.399-1.688-.465-1.289-1.288.522-1.076-.994-1.95-1.665-.961-.513.756-1.693.44-1.759-.472ZM8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10Z",clipRule:"evenodd"})),pb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),mb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),gb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),f.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),vb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),f.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),bb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),yb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),kb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),Sb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("g",{opacity:.25},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),Ru=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),Tb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("g",{fill:"currentColor"},f.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),f.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),Da=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 0a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 12a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 8 12Z",clipRule:"evenodd",opacity:.7}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 1.072a.75.75 0 0 1 .274 1.024l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 12 1.072Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 11.464a.75.75 0 0 1 .274 1.025l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 6 11.464Z",clipRule:"evenodd",opacity:.6}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 4a.75.75 0 0 1-.274 1.025l-2.165 1.25a.75.75 0 1 1-.75-1.3l2.165-1.25A.75.75 0 0 1 14.928 4Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 10a.75.75 0 0 1-.275 1.024l-2.165 1.25a.75.75 0 0 1-.75-1.298l2.165-1.25A.75.75 0 0 1 4.536 10Z",clipRule:"evenodd",opacity:.5}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M16 8a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 16 8Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 4 8Z",clipRule:"evenodd",opacity:.4}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 12a.75.75 0 0 1-1.024.274l-2.165-1.25a.75.75 0 0 1 .75-1.299l2.165 1.25A.75.75 0 0 1 14.928 12Z",clipRule:"evenodd",opacity:.9}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 6a.75.75 0 0 1-1.025.275l-2.165-1.25a.75.75 0 1 1 .75-1.3l2.165 1.25A.75.75 0 0 1 4.536 6Z",clipRule:"evenodd",opacity:.3}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 14.928a.75.75 0 0 1-1.024-.274l-1.25-2.165a.75.75 0 0 1 1.298-.75l1.25 2.165A.75.75 0 0 1 12 14.928Z",clipRule:"evenodd",opacity:.8}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 4.536a.75.75 0 0 1-1.024-.275l-1.25-2.165a.75.75 0 1 1 1.299-.75l1.25 2.165A.75.75 0 0 1 6 4.536Z",clipRule:"evenodd",opacity:.2})),Cb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),Eb=f.forwardRef(function({trackRef:n,...e},t){const i=Yi(),{mergedProps:r,inFocus:s}=V0({trackRef:n??i,props:e});return f.createElement(Qi.Consumer,null,o=>o!==void 0&&f.createElement("button",{ref:t,...r},e.children?e.children:s?f.createElement(Cb,null):f.createElement(hb,null)))}),Tr=f.forwardRef(function({kind:n,initialSelection:e,onActiveDeviceChange:t,onDeviceListChange:i,onDeviceSelectError:r,exactMatch:s,track:o,requestPermissions:a,onError:c,...l},u){const d=Xi(),h=f.useRef("default"),p=f.useCallback(y=>{d&&d.emit(I.MediaDevicesError,y),c?.(y)},[d,c]),{devices:b,activeDeviceId:m,setActiveMediaDevice:T,className:S}=K0({kind:n,room:d,track:o,requestPermissions:a,onError:p});f.useEffect(()=>{e!==void 0&&T(e)},[T]),f.useEffect(()=>{typeof i=="function"&&i(b)},[i,b]),f.useEffect(()=>{m!==h.current&&t?.(m),h.current=m},[m]);const P=async y=>{try{await T(y,{exact:s??!0})}catch(C){if(C instanceof Error)r?.(C);else throw C}},_=f.useMemo(()=>mt(l,{className:S},{className:"lk-list"}),[S,l]),v=!!b.find(y=>y.label.toLowerCase().startsWith("default"));function g(y,C,x){return y===C||!v&&x===0&&C==="default"}return f.createElement("ul",{ref:u,..._},b.map((y,C)=>f.createElement("li",{key:y.deviceId,id:y.deviceId,"data-lk-active":g(y.deviceId,m,C),"aria-selected":g(y.deviceId,m,C),role:"option"},f.createElement("button",{className:"lk-button",onClick:()=>P(y.deviceId)},y.label))))}),wb=f.forwardRef(function({label:n,...e},t){const i=$s(),{mergedProps:r,canPlayAudio:s}=$0({room:i,props:e}),{mergedProps:o,canPlayVideo:a}=Q0({room:i,props:r}),{style:c,...l}=o;return c.display=s&&a?"none":"block",f.createElement("button",{ref:t,style:c,...l},n??`Start ${s?"Video":"Audio"}`)});function _u(n,e){switch(n){case E.Source.Microphone:return e?f.createElement(vb,null):f.createElement(gb,null);case E.Source.Camera:return e?f.createElement(lb,null):f.createElement(cb,null);case E.Source.ScreenShare:return e?f.createElement(Tb,null):f.createElement(Ru,null);default:return}}function Pb(n){switch(n){case je.Excellent:return f.createElement(bb,null);case je.Good:return f.createElement(yb,null);case je.Poor:return f.createElement(kb,null);default:return f.createElement(Sb,null)}}const Cr=f.forwardRef(function({showIcon:n,...e},t){const{buttonProps:i,enabled:r}=eb(e),[s,o]=f.useState(!1);return f.useEffect(()=>{o(!0)},[]),s&&f.createElement("button",{ref:t,...i},(n??!0)&&_u(e.source,r),e.children)}),Rb=f.forwardRef(function(n,e){const{className:t,quality:i}=F0(n),r=f.useMemo(()=>({...mt(n,{className:t}),"data-lk-quality":i}),[i,n,t]);return f.createElement("div",{ref:e,...r},n.children??Pb(i))}),Aa=f.forwardRef(function({participant:n,...e},t){const i=Hn(n),{className:r,infoObserver:s}=f.useMemo(()=>Zv(i),[i]),{identity:o,name:a}=Re(s,{name:i.name,identity:i.identity,metadata:i.metadata}),c=f.useMemo(()=>mt(e,{className:r,"data-lk-participant-name":a}),[e,r,a]);return f.createElement("span",{ref:t,...c},a!==""?a:o,e.children)}),_b=f.forwardRef(function({trackRef:n,show:e="always",...t},i){const{className:r,isMuted:s}=Z0(n),o=e==="always"||e==="muted"&&s||e==="unmuted"&&!s,a=f.useMemo(()=>mt(t,{className:r}),[r,t]);return o?f.createElement("div",{ref:i,...a,"data-lk-muted":s},t.children??_u(n.source,!s)):null}),Ib=n=>f.createElement("svg",{width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},f.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),f.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25}));function Iu(n,e={}){const[t,i]=f.useState(ss(n)),[r,s]=f.useState(t?.isMuted),[o,a]=f.useState(t?.isSubscribed),[c,l]=f.useState(t?.track),[u,d]=f.useState("landscape"),h=f.useRef(),{className:p,trackObserver:b}=f.useMemo(()=>Lv(n),[n.participant.sid??n.participant.identity,n.source,ce(n)&&n.publication.trackSid]);return f.useEffect(()=>{const m=b.subscribe(T=>{B.debug("update track",T),i(T),s(T?.isMuted),a(T?.isSubscribed),l(T?.track)});return()=>m?.unsubscribe()},[b]),f.useEffect(()=>{var m,T;return c&&(h.current&&c.detach(h.current),(m=e.element)!=null&&m.current&&!(n.participant.isLocal&&c?.kind==="audio")&&c.attach(e.element.current)),h.current=(T=e.element)==null?void 0:T.current,()=>{h.current&&c?.detach(h.current)}},[c,e.element]),f.useEffect(()=>{var m,T;if(typeof((m=t?.dimensions)==null?void 0:m.width)=="number"&&typeof((T=t?.dimensions)==null?void 0:T.height)=="number"){const S=t.dimensions.width>t.dimensions.height?"landscape":"portrait";d(S)}},[t]),{publication:t,isMuted:r,isSubscribed:o,track:c,elementProps:mt(e.props,{className:p,"data-lk-local-participant":n.participant.isLocal,"data-lk-source":t?.source,...t?.kind==="video"&&{"data-lk-orientation":u}})}}var Er,La;function Ob(){if(La)return Er;La=1;var n="Expected a function",e=NaN,t="[object Symbol]",i=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,o=/^0o[0-7]+$/i,a=parseInt,c=typeof $n=="object"&&$n&&$n.Object===Object&&$n,l=typeof self=="object"&&self&&self.Object===Object&&self,u=c||l||Function("return this")(),d=Object.prototype,h=d.toString,p=Math.max,b=Math.min,m=function(){return u.Date.now()};function T(g,y,C){var x,R,O,D,U,z,Q=0,Oe=!1,Te=!1,me=!0;if(typeof g!="function")throw new TypeError(n);y=v(y)||0,S(C)&&(Oe=!!C.leading,Te="maxWait"in C,O=Te?p(v(C.maxWait)||0,y):O,me="trailing"in C?!!C.trailing:me);function ge(se){var vt=x,gn=R;return x=R=void 0,Q=se,D=g.apply(gn,vt),D}function Ce(se){return Q=se,U=setTimeout(gt,y),Oe?ge(se):D}function Dt(se){var vt=se-z,gn=se-Q,Ys=y-vt;return Te?b(Ys,O-gn):Ys}function Gt(se){var vt=se-z,gn=se-Q;return z===void 0||vt>=y||vt<0||Te&&gn>=O}function gt(){var se=m();if(Gt(se))return Jt(se);U=setTimeout(gt,Dt(se))}function Jt(se){return U=void 0,me&&x?ge(se):(x=R=void 0,D)}function Zi(){U!==void 0&&clearTimeout(U),Q=0,x=z=R=U=void 0}function Kn(){return U===void 0?D:Jt(m())}function At(){var se=m(),vt=Gt(se);if(x=arguments,R=this,z=se,vt){if(U===void 0)return Ce(z);if(Te)return U=setTimeout(gt,y),ge(z)}return U===void 0&&(U=setTimeout(gt,y)),D}return At.cancel=Zi,At.flush=Kn,At}function S(g){var y=typeof g;return!!g&&(y=="object"||y=="function")}function P(g){return!!g&&typeof g=="object"}function _(g){return typeof g=="symbol"||P(g)&&h.call(g)==t}function v(g){if(typeof g=="number")return g;if(_(g))return e;if(S(g)){var y=typeof g.valueOf=="function"?g.valueOf():g;g=S(y)?y+"":y}if(typeof g!="string")return g===0?g:+g;g=g.replace(i,"");var C=s.test(g);return C||o.test(g)?a(g.slice(2),C?2:8):r.test(g)?e:+g}return Er=T,Er}var xb=Ob();const Na=Bl(xb);function Mb(n){const e=f.useRef(n);e.current=n,f.useEffect(()=>()=>{e.current()},[])}function Db(n,e=500,t){const i=f.useRef();Mb(()=>{i.current&&i.current.cancel()});const r=f.useMemo(()=>{const s=Na(n,e,t),o=(...a)=>s(...a);return o.cancel=()=>{s.cancel()},o.isPending=()=>!!i.current,o.flush=()=>s.flush(),o},[n,e,t]);return f.useEffect(()=>{i.current=Na(n,e,t)},[n,e,t]),r}function Ab(n,e,t){const i=((l,u)=>l===u),r=n instanceof Function?n():n,[s,o]=f.useState(r),a=f.useRef(r),c=Db(o,e,t);return i(a.current,r)||(c(r),a.current=r),[s,c]}function Lb({threshold:n=0,root:e=null,rootMargin:t="0%",freezeOnceVisible:i=!1,initialIsIntersecting:r=!1,onChange:s}={}){var o;const[a,c]=f.useState(null),[l,u]=f.useState(()=>({isIntersecting:r,entry:void 0})),d=f.useRef();d.current=s;const h=((o=l.entry)==null?void 0:o.isIntersecting)&&i;f.useEffect(()=>{if(!a||!("IntersectionObserver"in window)||h)return;const m=new IntersectionObserver(T=>{const S=Array.isArray(m.thresholds)?m.thresholds:[m.thresholds];T.forEach(P=>{const _=P.isIntersecting&&S.some(v=>P.intersectionRatio>=v);u({isIntersecting:_,entry:P}),d.current&&d.current(_,P)})},{threshold:n,root:e,rootMargin:t});return m.observe(a),()=>{m.disconnect()}},[a,JSON.stringify(n),e,t,h,i]);const p=f.useRef(null);f.useEffect(()=>{var m;!a&&(m=l.entry)!=null&&m.target&&!i&&!h&&p.current!==l.entry.target&&(p.current=l.entry.target,u({isIntersecting:r,entry:void 0}))},[a,l.entry,i,h,r]);const b=[c,!!l.isIntersecting,l.entry];return b.ref=b[0],b.isIntersecting=b[1],b.entry=b[2],b}const Nb=f.forwardRef(function({onTrackClick:n,onClick:e,onSubscriptionStatusChanged:t,trackRef:i,manageSubscription:r,...s},o){const a=mn(i),c=f.useRef(null);f.useImperativeHandle(o,()=>c.current);const l=Lb({root:c.current}),[u]=Ab(l,3e3);f.useEffect(()=>{r&&a.publication instanceof Ci&&u?.isIntersecting===!1&&l?.isIntersecting===!1&&a.publication.setSubscribed(!1)},[u,a,r]),f.useEffect(()=>{r&&a.publication instanceof Ci&&l?.isIntersecting===!0&&a.publication.setSubscribed(!0)},[l,a,r]);const{elementProps:d,publication:h,isSubscribed:p}=Iu(a,{element:c,props:s});f.useEffect(()=>{t?.(!!p)},[p,t]);const b=m=>{e?.(m),n?.({participant:a?.participant,track:h})};return f.createElement("video",{ref:c,...d,muted:!0,onClick:b})}),Ou=f.forwardRef(function({trackRef:n,onSubscriptionStatusChanged:e,volume:t,...i},r){const s=mn(n),o=f.useRef(null);f.useImperativeHandle(r,()=>o.current);const{elementProps:a,isSubscribed:c,track:l,publication:u}=Iu(s,{element:o,props:i});return f.useEffect(()=>{e?.(!!c)},[c,e]),f.useEffect(()=>{l===void 0||t===void 0||(l instanceof wl?l.setVolume(t):B.warn("Volume can only be set on remote audio tracks."))},[t,l]),f.useEffect(()=>{u===void 0||i.muted===void 0||(u instanceof Ci?u.setEnabled(!i.muted):B.warn("Can only call setEnabled on remote track publications."))},[i.muted,u,l]),f.createElement("audio",{ref:o,...a})});function Ub(n){const e=!!bu();return n.participant&&!e?f.createElement(vu.Provider,{value:n.participant},n.children):f.createElement(f.Fragment,null,n.children)}function Fb(n){const e=!!Yi();return n.trackRef&&!e?f.createElement(Gs.Provider,{value:n.trackRef},n.children):f.createElement(f.Fragment,null,n.children)}const os=f.forwardRef(function({trackRef:n,children:e,onParticipantClick:t,disableSpeakingIndicator:i,...r},s){var o,a;const c=mn(n),{elementProps:l}=G0({htmlProps:r,disableSpeakingIndicator:i,onParticipantClick:t,trackRef:c}),u=sb(c.participant),d=Wn(),h=(o=P0())==null?void 0:o.autoSubscription,p=f.useCallback(b=>{c.source&&!b&&d&&d.pin.dispatch&&su(c,d.pin.state)&&d.pin.dispatch({msg:"clear_pin"})},[c,d]);return f.createElement("div",{ref:s,style:{position:"relative"},...l},f.createElement(Fb,{trackRef:c},f.createElement(Ub,{participant:c.participant},e??f.createElement(f.Fragment,null,ce(c)&&(((a=c.publication)==null?void 0:a.kind)==="video"||c.source===E.Source.Camera||c.source===E.Source.ScreenShare)?f.createElement(Nb,{trackRef:c,onSubscriptionStatusChanged:p,manageSubscription:h}):ce(c)&&f.createElement(Ou,{trackRef:c,onSubscriptionStatusChanged:p}),f.createElement("div",{className:"lk-participant-placeholder"},f.createElement(Ib,null)),f.createElement("div",{className:"lk-participant-metadata"},f.createElement("div",{className:"lk-participant-metadata-item"},c.source===E.Source.Camera?f.createElement(f.Fragment,null,u&&f.createElement(mb,{style:{marginRight:"0.25rem"}}),f.createElement(_b,{trackRef:{participant:c.participant,source:E.Source.Microphone},show:"muted"}),f.createElement(Aa,null)):f.createElement(f.Fragment,null,f.createElement(Ru,{style:{marginRight:"0.25rem"}}),f.createElement(Aa,null,"'s screen"))),f.createElement(Rb,{className:"lk-participant-metadata-item"}))),f.createElement(Eb,{trackRef:c}))))});function jb(n){const e=mt(n,{className:"lk-focus-layout"});return f.createElement("div",{...e},n.children)}function Bb({trackRef:n,...e}){return f.createElement(os,{trackRef:n,...e})}function xu({tracks:n,...e}){return f.createElement(f.Fragment,null,n.map(t=>f.createElement(Gs.Provider,{value:t,key:he(t)},Tu(e.children))))}function Vb({totalPageCount:n,nextPage:e,prevPage:t,currentPage:i,pagesContainer:r}){const[s,o]=f.useState(!1);return f.useEffect(()=>{let a;return r&&(a=p0(r.current,2e3).subscribe(o)),()=>{a&&a.unsubscribe()}},[r]),f.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},f.createElement("button",{className:"lk-button",onClick:t},f.createElement(Ma,null)),f.createElement("span",{className:"lk-pagination-count"},`${i} of ${n}`),f.createElement("button",{className:"lk-button",onClick:e},f.createElement(Ma,null)))}const qb=f.forwardRef(function({totalPageCount:n,currentPage:e},t){const i=new Array(n).fill("").map((r,s)=>s+1===e?f.createElement("span",{"data-lk-active":!0,key:s}):f.createElement("span",{key:s}));return f.createElement("div",{ref:t,className:"lk-pagination-indicator"},i)});function Wb({tracks:n,...e}){const t=f.createRef(),i=f.useMemo(()=>mt(e,{className:"lk-grid-layout"}),[e]),{layout:r}=q0(t,n.length),s=z0(r.maxTiles,n);return Y0(t,{onLeftSwipe:s.nextPage,onRightSwipe:s.prevPage}),f.createElement("div",{ref:t,"data-lk-pagination":s.totalPageCount>1,...i},f.createElement(xu,{tracks:s.tracks},e.children),n.length>r.maxTiles&&f.createElement(f.Fragment,null,f.createElement(qb,{totalPageCount:s.totalPageCount,currentPage:s.currentPage}),f.createElement(Vb,{pagesContainer:t,...s})))}const Hb=130,Kb=140,zb=1,Mu=16/10,Gb=(1-Mu)*-1;function Jb({tracks:n,orientation:e,...t}){const i=f.useRef(null),[r,s]=f.useState(0),{width:o,height:a}=Cu(i),c=e||(a>=o?"vertical":"horizontal"),l=c==="vertical"?Math.max(o*Gb,Hb):Math.max(a*Mu,Kb),u=lv(),d=Math.max(c==="vertical"?(a-u)/l:(o-u)/l,zb);let h=Math.round(d);Math.abs(d-r)<.5?h=Math.round(r):r!==d&&s(d);const p=Eu(n,h);return f.useLayoutEffect(()=>{i.current&&(i.current.dataset.lkOrientation=c,i.current.style.setProperty("--lk-max-visible-tiles",h.toString()))},[h,c]),f.createElement("aside",{key:c,className:"lk-carousel",ref:i,...t},f.createElement(xu,{tracks:p},t.children))}function $b({value:n,onPinChange:e,onWidgetChange:t,children:i}){const r=w0(n);return f.useEffect(()=>{B.debug("PinState Updated",{state:r.pin.state}),e&&r.pin.state&&e(r.pin.state)},[r.pin.state,e]),f.useEffect(()=>{B.debug("Widget Updated",{widgetState:r.widget.state}),t&&r.widget.state&&t(r.widget.state)},[t,r.widget.state]),f.createElement(Qi.Provider,{value:r},i)}function Qb({room:n,volume:e,muted:t}){const i=wu([E.Source.Microphone,E.Source.ScreenShareAudio,E.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0,room:n}).filter(r=>!r.participant.isLocal&&r.publication.kind===E.Kind.Audio);return f.createElement("div",{style:{display:"none"}},i.map(r=>f.createElement(Ou,{key:he(r),trackRef:r,volume:e,muted:t})))}function Yb(n){const e=f.useMemo(()=>mt(n,{className:"lk-toast"}),[n]);return f.createElement("div",{...e},n.children)}function Xb(n){const[e,t]=f.useState(void 0),i=Qs(n.room);return f.useEffect(()=>{switch(i){case H.Reconnecting:t(f.createElement(f.Fragment,null,f.createElement(Da,{className:"lk-spinner"})," Reconnecting"));break;case H.Connecting:t(f.createElement(f.Fragment,null,f.createElement(Da,{className:"lk-spinner"})," Connecting"));break;case H.Disconnected:t(f.createElement(f.Fragment,null,"Disconnected"));break;default:t(void 0);break}},[i]),e?f.createElement(Yb,{className:"lk-toast-connection-state"},e):f.createElement(f.Fragment,null)}const Zb=f.forwardRef(function({entry:n,hideName:e=!1,hideTimestamp:t=!1,messageFormatter:i,...r},s){var o,a,c,l;const u=f.useMemo(()=>i?i(n.message):n.message,[n.message,i]),d=!!n.editTimestamp,h=new Date(n.timestamp),p=typeof navigator<"u"?navigator.language:"en-US",b=((o=n.from)==null?void 0:o.name)??((a=n.from)==null?void 0:a.identity);return f.createElement("li",{ref:s,className:"lk-chat-entry",title:h.toLocaleTimeString(p,{timeStyle:"full"}),"data-lk-message-origin":(c=n.from)!=null&&c.isLocal?"local":"remote",...r},(!t||!e||d)&&f.createElement("span",{className:"lk-meta-data"},!e&&f.createElement("strong",{className:"lk-participant-name"},b),(!t||d)&&f.createElement("span",{className:"lk-timestamp"},d&&"edited ",h.toLocaleTimeString(p,{timeStyle:"short"}))),f.createElement("span",{className:"lk-message-body"},u),f.createElement("span",{className:"lk-message-attachements"},(l=n.attachedFiles)==null?void 0:l.map(m=>m.type.startsWith("image/")&&f.createElement("img",{style:{maxWidth:"300px",maxHeight:"300px"},key:m.name,src:URL.createObjectURL(m),alt:m.name}))))});function ey({messageFormatter:n,messageDecoder:e,messageEncoder:t,channelTopic:i,...r}){const s=f.useRef(null),o=f.useRef(null),a=f.useMemo(()=>({messageDecoder:e,messageEncoder:t,channelTopic:i}),[e,t,i]),{chatMessages:c,send:l,isSending:u}=ib(a),d=Wn(),h=f.useRef(0);async function p(b){b.preventDefault(),o.current&&o.current.value.trim()!==""&&(await l(o.current.value),o.current.value="",o.current.focus())}return f.useEffect(()=>{var b;s&&((b=s.current)==null||b.scrollTo({top:s.current.scrollHeight}))},[s,c]),f.useEffect(()=>{var b,m,T,S,P;if(!d||c.length===0)return;if((b=d.widget.state)!=null&&b.showChat&&c.length>0&&h.current!==((m=c[c.length-1])==null?void 0:m.timestamp)){h.current=(T=c[c.length-1])==null?void 0:T.timestamp;return}const _=c.filter(g=>!h.current||g.timestamp>h.current).length,{widget:v}=d;_>0&&((S=v.state)==null?void 0:S.unreadMessages)!==_&&((P=v.dispatch)==null||P.call(v,{msg:"unread_msg",count:_}))},[c,d?.widget]),f.createElement("div",{...r,className:"lk-chat"},f.createElement("div",{className:"lk-chat-header"},"Messages",d&&f.createElement(Pu,{className:"lk-close-button"},f.createElement(ub,null))),f.createElement("ul",{className:"lk-list lk-chat-messages",ref:s},r.children?c.map((b,m)=>Tu(r.children,{entry:b,key:b.id??m,messageFormatter:n})):c.map((b,m,T)=>{const S=m>=1&&T[m-1].from===b.from,P=m>=1&&b.timestamp-T[m-1].timestamp<6e4;return f.createElement(Zb,{key:b.id??m,hideName:S,hideTimestamp:S===!1?!1:P,entry:b,messageFormatter:n})})),f.createElement("form",{className:"lk-chat-form",onSubmit:p},f.createElement("input",{className:"lk-form-control lk-chat-form-input",disabled:u,ref:o,type:"text",placeholder:"Enter a message...",onInput:b=>b.stopPropagation(),onKeyDown:b=>b.stopPropagation(),onKeyUp:b=>b.stopPropagation()}),f.createElement("button",{type:"submit",className:"lk-button lk-chat-form-button",disabled:u},"Send")))}function Ua({kind:n,initialSelection:e,onActiveDeviceChange:t,tracks:i,requestPermissions:r=!1,...s}){const[o,a]=f.useState(!1),[c,l]=f.useState([]),[u,d]=f.useState(!0),[h,p]=f.useState(r),b=(P,_)=>{B.debug("handle device change"),a(!1),t?.(P,_)},m=f.useRef(null),T=f.useRef(null);f.useLayoutEffect(()=>{o&&p(!0)},[o]),f.useLayoutEffect(()=>{let P;return m.current&&T.current&&(c||u)&&(P=dv(m.current,T.current,(_,v)=>{T.current&&Object.assign(T.current.style,{left:`${_}px`,top:`${v}px`})})),d(!1),()=>{P?.()}},[m,T,c,u]);const S=f.useCallback(P=>{T.current&&P.target!==m.current&&o&&hv(T.current,P)&&a(!1)},[o,T,m]);return f.useEffect(()=>(document.addEventListener("click",S),()=>{document.removeEventListener("click",S)}),[S]),f.createElement(f.Fragment,null,f.createElement("button",{className:"lk-button lk-button-menu","aria-pressed":o,...s,onClick:()=>a(!o),ref:m},s.children),!s.disabled&&f.createElement("div",{className:"lk-device-menu",ref:T,style:{visibility:o?"visible":"hidden"}},n?f.createElement(Tr,{initialSelection:e,onActiveDeviceChange:P=>b(n,P),onDeviceListChange:l,kind:n,track:i?.[n],requestPermissions:h}):f.createElement(f.Fragment,null,f.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),f.createElement(Tr,{kind:"audioinput",onActiveDeviceChange:P=>b("audioinput",P),onDeviceListChange:l,track:i?.audioinput,requestPermissions:h}),f.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),f.createElement(Tr,{kind:"videoinput",onActiveDeviceChange:P=>b("videoinput",P),onDeviceListChange:l,track:i?.videoinput,requestPermissions:h}))))}function ty(){f.useEffect(()=>{I0()},[])}function ny({props:n}){const{dispatch:e,state:t}=gu().widget,i="lk-button lk-settings-toggle";return{mergedProps:f.useMemo(()=>rt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_settings"})},"aria-pressed":t!=null&&t.showSettings?"true":"false"}),[n,i,e,t])}}const iy=f.forwardRef(function(n,e){const{mergedProps:t}=ny({props:n});return f.createElement("button",{ref:e,...t},n.children)}),ry=n=>{switch(n){case E.Source.Camera:return 1;case E.Source.Microphone:return 2;case E.Source.ScreenShare:return 3;default:return 0}};function sy({variation:n,controls:e,saveUserChoices:t=!0,onDeviceError:i,...r}){var s;const[o,a]=f.useState(!1),c=Wn();f.useEffect(()=>{var R,O;((R=c?.widget.state)==null?void 0:R.showChat)!==void 0&&a((O=c?.widget.state)==null?void 0:O.showChat)},[(s=c?.widget.state)==null?void 0:s.showChat]);const l=U0(`(max-width: ${o?1e3:760}px)`)?"minimal":"verbose";n??(n=l);const u={leave:!0,...e},d=H0();if(!d)u.camera=!1,u.chat=!1,u.microphone=!1,u.screenShare=!1;else{const R=O=>d.canPublish&&(d.canPublishSources.length===0||d.canPublishSources.includes(ry(O)));u.camera??(u.camera=R(E.Source.Camera)),u.microphone??(u.microphone=R(E.Source.Microphone)),u.screenShare??(u.screenShare=R(E.Source.ScreenShare)),u.chat??(u.chat=d.canPublishData&&e?.chat)}const h=f.useMemo(()=>n==="minimal"||n==="verbose",[n]),p=f.useMemo(()=>n==="textOnly"||n==="verbose",[n]),b=bv(),[m,T]=f.useState(!1),S=f.useCallback(R=>{T(R)},[T]),P=mt({className:"lk-control-bar"},r),{saveAudioInputEnabled:_,saveVideoInputEnabled:v,saveAudioInputDeviceId:g,saveVideoInputDeviceId:y}=rb({preventSave:!t}),C=f.useCallback((R,O)=>O?_(R):null,[_]),x=f.useCallback((R,O)=>O?v(R):null,[v]);return f.createElement("div",{...P},u.microphone&&f.createElement("div",{className:"lk-button-group"},f.createElement(Cr,{source:E.Source.Microphone,showIcon:h,onChange:C,onDeviceError:R=>i?.({source:E.Source.Microphone,error:R})},p&&"Microphone"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(Ua,{kind:"audioinput",onActiveDeviceChange:(R,O)=>g(O??"default")}))),u.camera&&f.createElement("div",{className:"lk-button-group"},f.createElement(Cr,{source:E.Source.Camera,showIcon:h,onChange:x,onDeviceError:R=>i?.({source:E.Source.Camera,error:R})},p&&"Camera"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(Ua,{kind:"videoinput",onActiveDeviceChange:(R,O)=>y(O??"default")}))),u.screenShare&&b&&f.createElement(Cr,{source:E.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:h,onChange:S,onDeviceError:R=>i?.({source:E.Source.ScreenShare,error:R})},p&&(m?"Stop screen share":"Share screen")),u.chat&&f.createElement(Pu,null,h&&f.createElement(db,null),p&&"Chat"),u.settings&&f.createElement(iy,null,h&&f.createElement(fb,null),p&&"Settings"),u.leave&&f.createElement(ab,null,h&&f.createElement(pb,null),p&&"Leave"),f.createElement(wb,null))}function hy({chatMessageFormatter:n,chatMessageDecoder:e,chatMessageEncoder:t,SettingsComponent:i,...r}){var s,o;const[a,c]=f.useState({showChat:!1,unreadMessages:0,showSettings:!1}),l=f.useRef(null),u=wu([{source:E.Source.Camera,withPlaceholder:!0},{source:E.Source.ScreenShare,withPlaceholder:!1}],{updateOnlyOn:[I.ActiveSpeakersChanged],onlySubscribed:!1}),d=T=>{B.debug("updating widget state",T),c(T)},h=E0(),p=u.filter(ce).filter(T=>T.publication.source===E.Source.ScreenShare),b=(s=J0(h))==null?void 0:s[0],m=u.filter(T=>!av(T,b));return f.useEffect(()=>{var T,S,P,_,v,g;if(p.some(y=>y.publication.isSubscribed)&&l.current===null?(B.debug("Auto set screen share focus:",{newScreenShareTrack:p[0]}),(S=(T=h.pin).dispatch)==null||S.call(T,{msg:"set_pin",trackReference:p[0]}),l.current=p[0]):l.current&&!p.some(y=>{var C,x;return y.publication.trackSid===((x=(C=l.current)==null?void 0:C.publication)==null?void 0:x.trackSid)})&&(B.debug("Auto clearing screen share focus."),(_=(P=h.pin).dispatch)==null||_.call(P,{msg:"clear_pin"}),l.current=null),b&&!ce(b)){const y=u.find(C=>C.participant.identity===b.participant.identity&&C.source===b.source);y!==b&&ce(y)&&((g=(v=h.pin).dispatch)==null||g.call(v,{msg:"set_pin",trackReference:y}))}},[p.map(T=>`${T.publication.trackSid}_${T.publication.isSubscribed}`).join(),(o=b?.publication)==null?void 0:o.trackSid,u]),ty(),f.createElement("div",{className:"lk-video-conference",...r},uv()&&f.createElement($b,{value:h,onWidgetChange:d},f.createElement("div",{className:"lk-video-conference-inner"},b?f.createElement("div",{className:"lk-focus-layout-wrapper"},f.createElement(jb,null,f.createElement(Jb,{tracks:m},f.createElement(os,null)),b&&f.createElement(Bb,{trackRef:b}))):f.createElement("div",{className:"lk-grid-layout-wrapper"},f.createElement(Wb,{tracks:u},f.createElement(os,null))),f.createElement(sy,{controls:{chat:!0,settings:!!i}})),f.createElement(ey,{style:{display:a.showChat?"grid":"none"},messageFormatter:n,messageEncoder:t,messageDecoder:e}),i&&f.createElement("div",{className:"lk-settings-menu-modal",style:{display:a.showSettings?"block":"none"}},f.createElement(i,null))),f.createElement(Qb,null),f.createElement(Xb,null))}export{H as C,B as L,dy as O,I as R,uy as W,hy as a,ki as b,Ir as c,Tr as f,ay as s,Qs as t,$s as u};
