const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-BX_U5xLJ.js","assets/vendor-socket-CA1CrNgP.js","assets/index-Dpn7Ag7z.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/web-BE_iRotU.js","assets/incoming-call-plugin.web-DMS_K1a4.js"])))=>i.map(i=>d[i]);
import{l as J}from"./vendor-socket-CA1CrNgP.js";import{_ as D}from"./index-Dpn7Ag7z.js";class W{socket=null;wsUrl;accessToken=null;reconnectAttempts=0;maxReconnectAttempts=5;constructor(e){this.wsUrl=e}connect(e){if(this.socket?.connected){console.log("[SocketService] Already connected");return}this.accessToken=e,console.log("[SocketService] Connecting to:",this.wsUrl),console.log("[SocketService] Token length:",e?.length||0),this.socket=J(this.wsUrl,{autoConnect:!1,transports:["websocket","polling"],auth:{token:e},query:{token:e}}),this.setupEventHandlers(),this.socket.connect(),console.log("[SocketService] Connection initiated")}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.accessToken=null,this.reconnectAttempts=0}updateToken(e){this.accessToken=e,this.socket&&(this.socket.auth={token:e},this.socket.io.opts.query={token:e})}isConnected(){return this.socket?.connected??!1}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{console.log("[SocketService] ‚úÖ Connected successfully"),this.reconnectAttempts=0}),this.socket.on("disconnect",e=>{console.log("[SocketService] ‚ùå Disconnected:",e)}),this.socket.on("connect_error",e=>{console.error("[SocketService] ‚ùå Connection error:",e),console.error("[SocketService] Error message:",e.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&console.error("[SocketService] Max reconnect attempts reached")}),this.socket.io.on("reconnect_attempt",()=>{this.accessToken&&(this.socket.auth={token:this.accessToken},this.socket.io.opts.query={token:this.accessToken})}))}onMessageNew(e){return this.socket?(this.socket.on("message:new",e),()=>this.socket?.off("message:new",e)):()=>{}}onMessageNotify(e){return this.socket?(this.socket.on("message:notify",e),()=>this.socket?.off("message:notify",e)):()=>{}}onConversationTyping(e){return this.socket?(this.socket.on("conversation:typing",e),()=>this.socket?.off("conversation:typing",e)):()=>{}}onMessageReaction(e){return this.socket?(this.socket.on("message:reaction",e),()=>this.socket?.off("message:reaction",e)):()=>{}}onReceiptsUpdate(e){return this.socket?(this.socket.on("receipts:update",e),()=>this.socket?.off("receipts:update",e)):()=>{}}onConversationNew(e){return this.socket?(this.socket.on("conversations:new",e),()=>this.socket?.off("conversations:new",e)):()=>{}}onConversationUpdated(e){return this.socket?(this.socket.on("conversations:updated",e),()=>this.socket?.off("conversations:updated",e)):()=>{}}onConversationDeleted(e){return this.socket?(this.socket.on("conversations:deleted",e),()=>this.socket?.off("conversations:deleted",e)):()=>{}}onConversationMemberRemoved(e){return this.socket?(this.socket.on("conversations:member:removed",e),()=>this.socket?.off("conversations:member:removed",e)):()=>{}}onPresenceUpdate(e){return this.socket?(this.socket.on("presence:update",e),()=>this.socket?.off("presence:update",e)):()=>{}}onContactRequest(e){return this.socket?(this.socket.on("contacts:request:new",e),()=>this.socket?.off("contacts:request:new",e)):()=>{}}onContactAccepted(e){return this.socket?(this.socket.on("contacts:request:accepted",e),()=>this.socket?.off("contacts:request:accepted",e)):()=>{}}onContactRemoved(e){return this.socket?(this.socket.on("contacts:removed",e),()=>this.socket?.off("contacts:removed",e)):()=>{}}onProfileUpdate(e){return this.socket?(this.socket.on("profile:update",e),()=>this.socket?.off("profile:update",e)):()=>{}}onCallIncoming(e){return this.socket?(this.socket.on("call:incoming",e),()=>this.socket?.off("call:incoming",e)):()=>{}}onCallAccepted(e){return this.socket?(this.socket.on("call:accepted",e),()=>this.socket?.off("call:accepted",e)):()=>{}}onCallDeclined(e){return this.socket?(this.socket.on("call:declined",e),()=>this.socket?.off("call:declined",e)):()=>{}}onCallEnded(e){return this.socket?(this.socket.on("call:ended",e),()=>this.socket?.off("call:ended",e)):()=>{}}onCallStatus(e){return this.socket?(this.socket.on("call:status",e),()=>this.socket?.off("call:status",e)):()=>{}}onCallStatusBulk(e){return this.socket?(this.socket.on("call:status:bulk",e),()=>this.socket?.off("call:status:bulk",e)):()=>{}}emitConversationTyping(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:typing");return}this.socket.emit("conversation:typing",e)}emitCallInvite(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:invite");return}this.socket.emit("call:invite",e)}emitCallAccept(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:accept");return}this.socket.emit("call:accept",e)}emitCallDecline(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:decline");return}this.socket.emit("call:decline",e)}emitCallEnd(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:end");return}this.socket.emit("call:end",e)}emitCallRoomJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:join");return}this.socket.emit("call:room:join",e)}emitCallRoomLeave(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:leave");return}this.socket.emit("call:room:leave",e)}emitCallStatusRequest(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:status:request");return}this.socket.emit("call:status:request",e)}emitConversationJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:join");return}this.socket.emit("conversation:join",e)}}let U=null;function T(i){if(!U){if(!i)throw new Error("SocketService requires wsUrl for first initialization");U=new W(i)}return U}/*! Capacitor: https://capacitorjs.com/ - MIT License */var y;(function(i){i.Unimplemented="UNIMPLEMENTED",i.Unavailable="UNAVAILABLE"})(y||(y={}));class R extends Error{constructor(e,t,s){super(e),this.message=e,this.code=t,this.data=s}}const Q=i=>{var e,t;return i?.androidBridge?"android":!((t=(e=i?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||t===void 0)&&t.bridge?"ios":"web"},X=i=>{const e=i.CapacitorCustomPlatform||null,t=i.Capacitor||{},s=t.Plugins=t.Plugins||{},c=()=>e!==null?e.name:Q(i),r=()=>c()!=="web",a=d=>{const u=l.get(d);return!!(u?.platforms.has(c())||o(d))},o=d=>{var u;return(u=t.PluginHeaders)===null||u===void 0?void 0:u.find(E=>E.name===d)},n=d=>i.console.error(d),l=new Map,m=(d,u={})=>{const E=l.get(d);if(E)return console.warn(`Capacitor plugin "${d}" already registered. Cannot register plugins twice.`),E.proxy;const b=c(),I=o(d);let p;const G=async()=>(!p&&b in u?p=typeof u[b]=="function"?p=await u[b]():p=u[b]:e!==null&&!p&&"web"in u&&(p=typeof u.web=="function"?p=await u.web():p=u.web),p),K=(h,f)=>{var k,w;if(I){const S=I?.methods.find(v=>f===v.name);if(S)return S.rtype==="promise"?v=>t.nativePromise(d,f.toString(),v):(v,P)=>t.nativeCallback(d,f.toString(),v,P);if(h)return(k=h[f])===null||k===void 0?void 0:k.bind(h)}else{if(h)return(w=h[f])===null||w===void 0?void 0:w.bind(h);throw new R(`"${d}" plugin is not implemented on ${b}`,y.Unimplemented)}},M=h=>{let f;const k=(...w)=>{const S=G().then(v=>{const P=K(v,h);if(P){const L=P(...w);return f=L?.remove,L}else throw new R(`"${d}.${h}()" is not implemented on ${b}`,y.Unimplemented)});return h==="addListener"&&(S.remove=async()=>f()),S};return k.toString=()=>`${h.toString()}() { [capacitor code] }`,Object.defineProperty(k,"name",{value:h,writable:!1,configurable:!1}),k},x=M("addListener"),O=M("removeListener"),V=(h,f)=>{const k=x({eventName:h},f),w=async()=>{const v=await k;O({eventName:h,callbackId:v},f)},S=new Promise(v=>k.then(()=>v({remove:w})));return S.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await w()},S},H=new Proxy({},{get(h,f){switch(f){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return I?V:x;case"removeListener":return O;default:return M(f)}}});return s[d]=H,l.set(d,{name:d,proxy:H,platforms:new Set([...Object.keys(u),...I?[b]:[]])}),H};return t.convertFileSrc||(t.convertFileSrc=d=>d),t.getPlatform=c,t.handleError=n,t.isNativePlatform=r,t.isPluginAvailable=a,t.registerPlugin=m,t.Exception=R,t.DEBUG=!!t.DEBUG,t.isLoggingEnabled=!!t.isLoggingEnabled,t},Y=i=>i.Capacitor=X(i),g=Y(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),A=g.registerPlugin;class F{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let s=!1;this.listeners[e]||(this.listeners[e]=[],s=!0),this.listeners[e].push(t);const r=this.windowListeners[e];r&&!r.registered&&this.addWindowListener(r),s&&this.sendRetainedArgumentsForEvent(e);const a=async()=>this.removeListener(e,t);return Promise.resolve({remove:a})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,s){const c=this.listeners[e];if(!c){if(s){let r=this.retainedEventArguments[e];r||(r=[]),r.push(t),this.retainedEventArguments[e]=r}return}c.forEach(r=>r(t))}hasListeners(e){var t;return!!(!((t=this.listeners[e])===null||t===void 0)&&t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:s=>{this.notifyListeners(t,s)}}}unimplemented(e="not implemented"){return new g.Exception(e,y.Unimplemented)}unavailable(e="not available"){return new g.Exception(e,y.Unavailable)}async removeListener(e,t){const s=this.listeners[e];if(!s)return;const c=s.indexOf(t);this.listeners[e].splice(c,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(s=>{this.notifyListeners(e,s)}))}}const $=i=>encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),j=i=>i.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Z extends F{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(s=>{if(s.length<=0)return;let[c,r]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");c=j(c).trim(),r=j(r).trim(),t[c]=r}),t}async setCookie(e){try{const t=$(e.key),s=$(e.value),c=`; expires=${(e.expires||"").replace("expires=","")}`,r=(e.path||"/").replace("path=",""),a=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${s||""}${c}; path=${r}; ${a};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}A("CapacitorCookies",{web:()=>new Z});const ee=async i=>new Promise((e,t)=>{const s=new FileReader;s.onload=()=>{const c=s.result;e(c.indexOf(",")>=0?c.split(",")[1]:c)},s.onerror=c=>t(c),s.readAsDataURL(i)}),te=(i={})=>{const e=Object.keys(i);return Object.keys(i).map(c=>c.toLocaleLowerCase()).reduce((c,r,a)=>(c[r]=i[e[a]],c),{})},ie=(i,e=!0)=>i?Object.entries(i).reduce((s,c)=>{const[r,a]=c;let o,n;return Array.isArray(a)?(n="",a.forEach(l=>{o=e?encodeURIComponent(l):l,n+=`${r}=${o}&`}),n.slice(0,-1)):(o=e?encodeURIComponent(a):a,n=`${r}=${o}`),`${s}&${n}`},"").substr(1):null,ne=(i,e={})=>{const t=Object.assign({method:i.method||"GET",headers:i.headers},e),c=te(i.headers)["content-type"]||"";if(typeof i.data=="string")t.body=i.data;else if(c.includes("application/x-www-form-urlencoded")){const r=new URLSearchParams;for(const[a,o]of Object.entries(i.data||{}))r.set(a,o);t.body=r.toString()}else if(c.includes("multipart/form-data")||i.data instanceof FormData){const r=new FormData;if(i.data instanceof FormData)i.data.forEach((o,n)=>{r.append(n,o)});else for(const o of Object.keys(i.data))r.append(o,i.data[o]);t.body=r;const a=new Headers(t.headers);a.delete("content-type"),t.headers=a}else(c.includes("application/json")||typeof i.data=="object")&&(t.body=JSON.stringify(i.data));return t};class oe extends F{async request(e){const t=ne(e,e.webFetchExtra),s=ie(e.params,e.shouldEncodeUrlParams),c=s?`${e.url}?${s}`:e.url,r=await fetch(c,t),a=r.headers.get("content-type")||"";let{responseType:o="text"}=r.ok?e:{};a.includes("application/json")&&(o="json");let n,l;switch(o){case"arraybuffer":case"blob":l=await r.blob(),n=await ee(l);break;case"json":n=await r.json();break;case"document":case"text":default:n=await r.text()}const m={};return r.headers.forEach((d,u)=>{m[u]=d}),{data:n,headers:m,status:r.status,url:r.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}A("CapacitorHttp",{web:()=>new oe});var z;(function(i){i[i.Sunday=1]="Sunday",i[i.Monday=2]="Monday",i[i.Tuesday=3]="Tuesday",i[i.Wednesday=4]="Wednesday",i[i.Thursday=5]="Thursday",i[i.Friday=6]="Friday",i[i.Saturday=7]="Saturday"})(z||(z={}));const C=A("LocalNotifications",{web:()=>D(()=>import("./web-BX_U5xLJ.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(i=>new i.LocalNotificationsWeb)}),q=A("App",{web:()=>D(()=>import("./web-BE_iRotU.js"),__vite__mapDeps([7,1,2,3,4,5,6])).then(i=>new i.AppWeb)});class se{notificationIds=new Set;conversationNotifications=new Map;async initialize(){console.log("[NotificationService] üöÄ Initializing notification service...");const e=await C.checkPermissions();if(console.log("[NotificationService] Current permission:",e.display),e.display!=="granted"){console.log("[NotificationService] Requesting notification permission...");const t=await C.requestPermissions();if(console.log("[NotificationService] Permission result:",t.display),t.display!=="granted"){console.warn("[NotificationService] ‚ùå Notification permission not granted");return}}console.log("[NotificationService] ‚úÖ Notification permission granted"),C.addListener("localNotificationActionPerformed",t=>{const s=t.notification.extra;s?.conversationId&&this.handleNotificationClick(s)}),q.addListener("appStateChange",t=>{t.isActive&&this.onAppBecameActive()})}async showMessageNotification(e,t,s,c){console.log("[NotificationService] üì® showMessageNotification called:",{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,messageText:t,senderName:s});const r=await q.getState();if(console.log("[NotificationService] App state:",r.isActive?"active":"background"),r.isActive){console.log("[NotificationService] App is active, skipping notification");return}const a=Date.now()%2147483647,o=e.conversationId,n=this.conversationNotifications.get(o);if(n){await this.updateConversationNotification(n,o,t||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",s||"–ö—Ç–æ-—Ç–æ",c);return}const l=s||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",m=t||"–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";console.log("[NotificationService] üì§ Scheduling notification:",{notificationId:a,title:l,body:m,conversationId:o});try{await C.schedule({notifications:[{title:l,body:m,id:a,sound:"notify.mp3",attachments:c?[{id:"avatar",url:c}]:void 0,extra:{conversationId:o,messageId:e.messageId,senderId:e.senderId,avatarUrl:c},actionTypeId:"MESSAGE",group:`conversation_${o}`,groupSummary:!1}]}),console.log("[NotificationService] ‚úÖ Notification scheduled successfully"),this.notificationIds.add(a),this.conversationNotifications.set(o,a)}catch(d){console.error("[NotificationService] ‚ùå Error scheduling notification:",d)}}async updateConversationNotification(e,t,s,c,r){await C.schedule({notifications:[{title:c,body:s,id:e,sound:void 0,extra:{conversationId:t,senderId:void 0,avatarUrl:r},actionTypeId:"MESSAGE",group:`conversation_${t}`,groupSummary:!1}]})}async showIncomingCallNotification(e,t,s,c){const r=Date.now()%2147483647,a=s?"–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫":"–∑–≤–æ–Ω–æ–∫";return await C.schedule({notifications:[{title:`–í—Ö–æ–¥—è—â–∏–π ${a}`,body:`${t} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`,id:r,sound:"ring.mp3",ongoing:!0,extra:{conversationId:e,callType:s?"video":"audio",callerName:t,avatarUrl:c},actionTypeId:"INCOMING_CALL"}]}),this.notificationIds.add(r),r}async cancelCallNotification(e){await C.cancel({notifications:[{id:e}]}),this.notificationIds.delete(e)}async cancelConversationNotifications(e){const t=this.conversationNotifications.get(e);t&&(await C.cancel({notifications:[{id:t}]}),this.notificationIds.delete(t),this.conversationNotifications.delete(e))}async clearAll(){const e=Array.from(this.notificationIds);e.length>0&&await C.cancel({notifications:e.map(t=>({id:t}))}),this.notificationIds.clear(),this.conversationNotifications.clear()}handleNotificationClick(e){console.log("[NotificationService] Notification clicked:",e)}onAppBecameActive(){console.log("[NotificationService] App became active")}}let _=null;function N(){return _||(_=new se),_}class ce{socketService=T();notificationService=N();callbacks;typingTimers=new Map;constructor(e){this.callbacks=e}initialize(){console.log("[MessageHandler] üöÄ Initializing message handlers...");const e=[],t=this.socketService.onMessageNew(async o=>{console.log("[MessageHandler] üì® message:new:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(t);const s=this.socketService.onMessageNotify(async o=>{console.log("[MessageHandler] üîî message:notify:",o);const n=this.callbacks.isConversationActive?.(o.conversationId)??!1;n||await this.handleMessageNotification(o),n&&o.message&&this.callbacks.onMessageReceived?.(o),this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(s);const c=this.socketService.onConversationTyping(o=>{console.log("[MessageHandler] conversation:typing:",o);const n=`${o.conversationId}_${o.userId}`,l=this.typingTimers.get(n);if(l&&clearTimeout(l),o.typing){this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!0);const m=setTimeout(()=>{this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(n)},2e3);this.typingTimers.set(n,m)}else this.callbacks.onTypingUpdate?.(o.conversationId,o.userId,!1),this.typingTimers.delete(n)});e.push(c);const r=this.socketService.onMessageReaction(async o=>{console.log("[MessageHandler] message:reaction:",o),this.callbacks.isConversationActive?.(o.conversationId)??!1?o.message&&this.callbacks.onMessageReceived?.(o):this.callbacks.onConversationUpdated?.(o.conversationId)});e.push(r);const a=this.socketService.onReceiptsUpdate(o=>{console.log("[MessageHandler] receipts:update:",o),this.callbacks.isConversationActive?.(o.conversationId)});return e.push(a),console.log("[MessageHandler] ‚úÖ All handlers subscribed, total:",e.length),()=>{console.log("[MessageHandler] Unsubscribing all handlers"),e.forEach(o=>o()),this.typingTimers.forEach(o=>clearTimeout(o)),this.typingTimers.clear()}}async handleMessageNotification(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);let s="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";e.message&&(e.message.content?s=e.message.content:e.message.attachments?.length&&(e.message.attachments[0].type==="IMAGE"?s="üì∑ –§–æ—Ç–æ":s="üìé –§–∞–π–ª")),await this.notificationService.showMessageNotification(e,s,t?.senderName||t?.title,t?.avatarUrl)}catch(t){console.error("[MessageHandler] Error handling message notification:",t)}}sendTyping(e,t){this.socketService.emitConversationTyping({conversationId:e,typing:t})}}const B=A("IncomingCall",{web:()=>D(()=>import("./incoming-call-plugin.web-DMS_K1a4.js"),__vite__mapDeps([8,1,2,3,4,5,6])).then(i=>new i.IncomingCallWeb)});class re{socketService=T();notificationService=N();callbacks;activeIncomingCalls=new Map;callNotificationIds=new Map;autoDeclineTimers=new Map;constructor(e){this.callbacks=e}initialize(){const e=[],t=this.socketService.onCallIncoming(async n=>{console.log("[CallHandler] üìû call:incoming:",n),this.activeIncomingCalls.set(n.conversationId,n),await this.handleIncomingCall(n);const l=setTimeout(()=>{console.log("[CallHandler] Auto-declining call after 25 seconds"),this.declineCall(n.conversationId)},25e3);this.autoDeclineTimers.set(n.conversationId,l),this.callbacks.onIncomingCall?.(n)});e.push(t);const s=this.socketService.onCallAccepted(n=>{console.log("[CallHandler] call:accepted:",n);const l=this.autoDeclineTimers.get(n.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(n.conversationId)),this.closeIncomingCallScreen(n.conversationId),this.callbacks.onCallAccepted?.(n)});e.push(s);const c=this.socketService.onCallDeclined(n=>{console.log("[CallHandler] call:declined:",n);const l=this.autoDeclineTimers.get(n.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(n.conversationId)),this.closeIncomingCallScreen(n.conversationId),this.callbacks.onCallDeclined?.(n)});e.push(c);const r=this.socketService.onCallEnded(n=>{console.log("[CallHandler] call:ended:",n);const l=this.autoDeclineTimers.get(n.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(n.conversationId)),this.closeIncomingCallScreen(n.conversationId),this.callbacks.onCallEnded?.(n)});e.push(r);const a=this.socketService.onCallStatus(n=>{console.log("[CallHandler] call:status:",n),this.callbacks.onCallStatusUpdate?.(n.conversationId,n)});e.push(a);const o=this.socketService.onCallStatusBulk(n=>{console.log("[CallHandler] call:status:bulk:",n);for(const[l,m]of Object.entries(n.statuses))this.callbacks.onCallStatusUpdate?.(l,m)});return e.push(o),()=>{e.forEach(n=>n()),this.autoDeclineTimers.forEach(n=>clearTimeout(n)),this.autoDeclineTimers.clear()}}async handleIncomingCall(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId),s=await this.notificationService.showIncomingCallNotification(e.conversationId,e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",e.video,t?.avatarUrl);this.callNotificationIds.set(e.conversationId,s),await this.openIncomingCallScreen(e)}catch(t){console.error("[CallHandler] Error handling incoming call:",t)}}async openIncomingCallScreen(e){if(g.isNativePlatform())try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);await B.showIncomingCall({conversationId:e.conversationId,callerName:e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",isVideo:e.video,avatarUrl:t?.avatarUrl})}catch(t){console.error("[CallHandler] Error opening incoming call screen:",t)}}async closeIncomingCallScreen(e){const t=this.callNotificationIds.get(e);if(t&&(await this.notificationService.cancelCallNotification(t),this.callNotificationIds.delete(e)),this.activeIncomingCalls.delete(e),g.isNativePlatform())try{await B.closeIncomingCall()}catch(s){console.error("[CallHandler] Error closing incoming call screen:",s)}}acceptCall(e,t){if(!this.activeIncomingCalls.get(e)){console.warn("[CallHandler] No active incoming call for:",e);return}const c=this.autoDeclineTimers.get(e);c&&(clearTimeout(c),this.autoDeclineTimers.delete(e)),this.socketService.emitCallAccept({conversationId:e,video:t}),this.closeIncomingCallScreen(e)}declineCall(e){const t=this.autoDeclineTimers.get(e);t&&(clearTimeout(t),this.autoDeclineTimers.delete(e)),this.socketService.emitCallDecline({conversationId:e}),this.closeIncomingCallScreen(e)}endCall(e){this.socketService.emitCallEnd({conversationId:e})}joinCallRoom(e,t){this.socketService.emitCallRoomJoin({conversationId:e,video:t})}leaveCallRoom(e){this.socketService.emitCallRoomLeave({conversationId:e})}requestCallStatuses(e){this.socketService.emitCallStatusRequest({conversationIds:e})}}typeof window<"u"&&g.isNativePlatform()?(console.log("[Capacitor] ‚úÖ Native platform detected, initializing services..."),N().initialize().then(()=>{console.log("[Capacitor] ‚úÖ Notification service initialized")}).catch(e=>{console.error("[Capacitor] ‚ùå Failed to initialize notification service:",e)})):console.log("[Capacitor] Web platform detected");function ae(i,e){if(console.log("[Capacitor] initializeSocketConnection called, isNative:",g.isNativePlatform()),!g.isNativePlatform()){console.warn("[Capacitor] initializeSocketConnection called on web platform");return}console.log("[Capacitor] Creating SocketService with URL:",i);const t=T(i);console.log("[Capacitor] Connecting socket with token length:",e?.length||0),t.connect(e)}function le(i){if(console.log("[Capacitor] initializeMessageHandlers called, isNative:",g.isNativePlatform()),!g.isNativePlatform())return console.warn("[Capacitor] initializeMessageHandlers called on web platform"),()=>{};console.log("[Capacitor] Creating MessageHandler");const t=new ce(i).initialize();return console.log("[Capacitor] ‚úÖ MessageHandler initialized"),t}function de(i){return g.isNativePlatform()?new re(i).initialize():(console.warn("[Capacitor] initializeCallHandlers called on web platform"),()=>{})}function ue(i){if(!g.isNativePlatform()){console.warn("[Capacitor] updateSocketToken called on web platform");return}T().updateToken(i)}const ge=Object.freeze(Object.defineProperty({__proto__:null,getNotificationService:N,getSocketService:T,initializeCallHandlers:de,initializeMessageHandlers:le,initializeSocketConnection:ae,updateSocketToken:ue},Symbol.toStringTag,{value:"Module"}));export{F as W,ge as i};
