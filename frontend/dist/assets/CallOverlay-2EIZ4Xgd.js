import{_ as xe,u as Ee,P as Re,m as ve,e as Ae,d as Fe,M as Le}from"./index-KTP06tch.js";import{r as a,j as g}from"./vendor-query-CNP5Hy5J.js";import{O as le,L as ke,b as Me,W as Pe,a as je,t as De,C as de,u as fe,R as we,f as pe,s as qe,c as Ie}from"./index-BdT5Om9k.js";import"./vendor-react-BcTlWpV0.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-GGjuBpPe.js";function _e(f={}){const[r,S]=a.useState(!1),[E,v]=a.useState(!1),[I,D]=a.useState(!1);let K=le().microphoneTrack;const[L,A]=a.useState();f.trackRef&&(K=f.trackRef.publication);const q=a.useCallback(async M=>{if(M){const{KrispNoiseFilter:F,isKrispNoiseFilterSupported:W}=await xe(async()=>{const{KrispNoiseFilter:X,isKrispNoiseFilterSupported:U}=await import("./index-Cc9ouniY.js");return{KrispNoiseFilter:X,isKrispNoiseFilterSupported:U}},[]);if(!W()){ke.warn("LiveKit-Krisp noise filter is not supported in this browser");return}L||A(F(f.filterOptions))}S(F=>(F!==M&&v(!0),M))},[]);return a.useEffect(()=>{var M;if(K&&K.track instanceof Me&&L){const F=K.track.getProcessor();F&&F.name==="livekit-noise-filter"?(v(!0),F.setEnabled(r).finally(()=>{v(!1),D(r)})):!F&&r&&(v(!0),(M=K?.track)==null||M.setProcessor(L).then(()=>L.setEnabled(r)).then(()=>{D(!0)}).catch(W=>{D(!1),ke.error("Krisp hook: error enabling filter",W)}).finally(()=>{v(!1)}))}},[r,K,L]),{setNoiseFilterEnabled:q,isNoiseFilterEnabled:I,isNoiseFilterPending:E,processor:L}}if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const f=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const r=await f(),S=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(S))return r;const v=[],I=[],D=[],K=(A,q)=>{const M=A.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(M)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(M)||/(back|rear)/.test(q.toLowerCase())?"back":"other"};r.forEach(A=>{if(A.kind!=="videoinput"){D.push(A);return}const q=K(A.label||"",A.deviceId||"");q==="front"?v.push(A):I.push(A)});const L=[];if(v.length>0&&L.push(v[0]),I.length>0&&L.push(I[0]),L.length===0&&r.some(A=>A.kind==="videoinput")){const A=r.find(q=>q.kind==="videoinput");A&&L.push(A)}return D.forEach(A=>{A.kind!=="videoinput"&&L.push(A)}),L},window.__eblushaEnumeratePatched=!0}try{qe(Ie.warn)}catch{}const G={aec:"eb.lk.webrtc.aec",ns:"eb.lk.webrtc.ns",agc:"eb.lk.webrtc.agc",krisp:"eb.lk.krisp.enabled"};function oe(f,r){if(typeof window>"u")return r;try{const S=window.localStorage.getItem(f);return S===null?r:S==="1"||S==="true"}catch{return r}}function ie(f,r){if(!(typeof window>"u"))try{window.localStorage.setItem(f,r?"1":"0")}catch{}}function ne(f,r){if(typeof window>"u")return!1;try{const E=new URLSearchParams(window.location.search).get(r);if(E==="1"||E==="true")return!0;const v=window.localStorage.getItem(f);return v==="1"||v==="true"}catch{return!1}}function se({label:f,description:r,checked:S,onChange:E,disabled:v=!1,rightHint:I}){return g.jsxs("div",{className:"eb-toggle-row",children:[g.jsxs("div",{className:"eb-toggle-text",children:[g.jsx("div",{className:"eb-toggle-label",children:f}),r?g.jsx("div",{className:"eb-toggle-desc",children:r}):null]}),g.jsxs("div",{className:"eb-toggle-right",children:[I?g.jsx("div",{className:"eb-toggle-hint",children:I}):null,g.jsxs("label",{className:`eb-switch ${v?"is-disabled":""}`,children:[g.jsx("input",{type:"checkbox",checked:S,disabled:v,onChange:D=>E(D.target.checked)}),g.jsx("span",{className:"eb-switch-track","aria-hidden":"true"})]})]})]})}function Be(){const f=De();let r="Подключено";return f===de.Connecting?r="Подключение…":f===de.Reconnecting?r="Переподключение…":f===de.Disconnected&&(r="Отключено"),g.jsx("div",{className:"eb-conn-badge",style:{position:"absolute",top:10,left:10,zIndex:20,padding:"6px 10px",borderRadius:999,background:"rgba(0,0,0,0.45)",border:"1px solid rgba(255,255,255,0.12)",fontSize:12,color:"#fff",backdropFilter:"blur(6px)"},children:r})}function Ke(){const f=fe(),{isMicrophoneEnabled:r}=le(),S=a.useRef(!1);return a.useEffect(()=>{f&&(S.current||r&&(S.current=!0,f.localParticipant.setMicrophoneEnabled(!0,{deviceId:"default"}).catch(E=>console.warn("[DefaultMicrophoneSetter] Failed to set default microphone",E))))},[f,r]),null}function Oe({localUserId:f}){const r=fe(),{localParticipant:S,microphoneTrack:E,cameraTrack:v}=le(),[I,D]=a.useState(null),K=a.useRef(null),[L,A]=a.useState(null),q=a.useRef(null),M=a.useRef(null),F=a.useRef(new Map),W=a.useRef(new Map),X=a.useRef(0),U=a.useRef(!1),Q=a.useRef(!1),R=a.useRef(0),H=a.useRef({at:0,rtt:null}),[b,V]=a.useState(()=>ne("lk-debug-ping","lkDebugPing")),Z=a.useRef({at:0,lastLocalRtt:null,lastSignalRtt:null}),C=(...T)=>{b&&console.log("[Ping]",...T)};a.useEffect(()=>{const T=window.setInterval(()=>{const d=ne("lk-debug-ping","lkDebugPing");V(w=>w===d?w:d)},1e3);return()=>window.clearInterval(T)},[]),a.useEffect(()=>{if(b){C("debug enabled",{localStorage:(()=>{try{return window.localStorage.getItem("lk-debug-ping")}catch{return"(unavailable)"}})(),query:(()=>{try{return new URLSearchParams(window.location.search).get("lkDebugPing")}catch{return"(unavailable)"}})(),localIdentity:S?.identity??null});try{const d=performance?.getEntriesByType?.("resource")?.map(w=>w.name).find(w=>w.includes("/assets/CallOverlay-"))??null;d&&C("asset",d)}catch{}}},[b,S?.identity]),a.useEffect(()=>{q.current=L,M.current?.(),b&&C("localPlayoutMs state",L)},[L]),a.useEffect(()=>{if(!r)return;const T=N=>{let l=null;try{N.forEach(i=>{if(i?.type!=="inbound-rtp")return;const u=(i?.kind||i?.mediaType||"").toString().toLowerCase();if(u&&u!=="audio")return;const p=typeof i?.jitterBufferTargetDelay=="number"?i.jitterBufferTargetDelay:null;if(typeof p=="number"&&Number.isFinite(p)&&p>0){const n=p*1e3;Number.isFinite(n)&&n>0&&n<5e3&&(l=l===null?n:Math.max(l,n))}const h=typeof i?.jitterBufferDelay=="number"?i.jitterBufferDelay:null,t=typeof i?.jitterBufferEmittedCount=="number"?i.jitterBufferEmittedCount:null;if(typeof h=="number"&&typeof t=="number"&&Number.isFinite(h)&&Number.isFinite(t)&&h>0&&t>=50){const n=h/t*1e3;Number.isFinite(n)&&n>0&&n<5e3&&(l=l===null?n:Math.max(l,n))}})}catch{}return l};let d=!1;const w=async()=>{try{const l=r.engine?.pcManager?.subscriber;if(l?.getStats){const i=await l.getStats(),u=T(i);d||A(u),b&&C("playout sample",{ms:u});return}}catch(N){b&&C("playout sample failed",N)}d||A(null)},P=window.setInterval(w,2e3);return w(),()=>{d=!0,window.clearInterval(P)}},[r,b]);const ee=T=>T.getAttribute("data-lk-local-participant")==="true"?!0:T.dataset?.lkLocalParticipant==="true",O=T=>{const d=T.querySelector("[data-lk-participant-name]")||T.querySelector(".lk-participant-name"),w=d?.getAttribute("data-lk-participant-name"),P=w&&w.trim()||(d?.textContent?.trim()??"");return P?P.replace(/[\u2019']/g,"'").replace(/'s\s+screen$/i,"").trim():null};return a.useEffect(()=>{if(!r||!S)return;const T=N=>{try{let l=null;const i=t=>{const n=(typeof t?.currentRoundTripTime=="number"?t.currentRoundTripTime:null)??(typeof t?.roundTripTime=="number"?t.roundTripTime:null)??(typeof t?.totalRoundTripTime=="number"&&Number.isFinite(t.totalRoundTripTime)&&t.totalRoundTripTime>0&&typeof t?.responsesReceived=="number"&&Number.isFinite(t.responsesReceived)&&t.responsesReceived>0?t.totalRoundTripTime/t.responsesReceived:null);return typeof n!="number"||!Number.isFinite(n)||n<=0?null:n};let u=null,p=null;N.forEach(t=>{t?.type==="transport"&&t.selectedCandidatePairId&&(u=String(t.selectedCandidatePairId))}),u&&(p=N.get?.(u)??(()=>{let t=null;return N.forEach(n=>{t||n?.id===u&&(t=n)}),t})()??null),p||N.forEach(t=>{p||t?.type==="candidate-pair"&&(t.selected||t.nominated||t.state==="succeeded")&&(p=t)});const h=p?i(p):null;if(typeof h=="number"&&Number.isFinite(h)&&h>0&&(l=h),N.forEach(t=>{if(t?.type!=="candidate-pair"||!(t.selected||t.nominated||t.state==="succeeded"))return;const n=i(t);typeof n=="number"&&(l===null||n<l)&&(l=n)}),N.forEach(t=>{if(t?.type!=="remote-inbound-rtp")return;const n=(typeof t?.roundTripTime=="number"?t.roundTripTime:null)??(typeof t?.totalRoundTripTime=="number"&&Number.isFinite(t.totalRoundTripTime)&&t.totalRoundTripTime>0&&typeof t?.roundTripTimeMeasurements=="number"&&Number.isFinite(t.roundTripTimeMeasurements)&&t.roundTripTimeMeasurements>0?t.totalRoundTripTime/t.roundTripTimeMeasurements:null);typeof n!="number"||!Number.isFinite(n)||n<=0||(l===null||n<l)&&(l=n)}),N.forEach(t=>{const n=typeof t?.roundTripTime=="number"?t.roundTripTime:null;typeof n!="number"||!Number.isFinite(n)||n<=0||(l===null||n<l)&&(l=n)}),typeof l=="number"&&Number.isFinite(l)&&l>0)return l*1e3}catch{}return null},d=async()=>{try{const N=r.engine,l=N?.client?.rtt;if((!l||l<=0)&&typeof N?.client?.sendPing=="function"){const e=Date.now();if(e-R.current>5e3){R.current=e;try{await N.client.sendPing(),b&&C("signal sendPing() called")}catch(m){b&&C("signal sendPing() failed",m)}}}if(b){const e=Date.now(),m=Z.current;(typeof l=="number"?l:null)!==m.lastSignalRtt&&e-m.at>750&&(Z.current={...m,at:e,lastSignalRtt:typeof l=="number"?l:null},C("signal rtt",{rtt:l,hasEngine:!!N,localIdentity:S.identity}))}if(typeof l=="number"&&Number.isFinite(l)&&l>0){D(l),b&&C("local rtt set",{ms:Math.round(l),source:"engine.client.rtt"});return}const i=E?.track;if(i&&typeof i.getSenderStats=="function")try{const e=await i.getSenderStats(),m=typeof e?.roundTripTime=="number"?e.roundTripTime:null;if(typeof m=="number"&&Number.isFinite(m)&&m>0){const c=m*1e3;D(c),b&&C("local rtt set",{ms:Math.round(c),source:"LocalAudioTrack.getSenderStats().roundTripTime"});return}}catch(e){b&&C("mic getSenderStats failed",e)}const u=v?.track;if(u&&typeof u.getSenderStats=="function")try{const e=await u.getSenderStats(),c=(Array.isArray(e)?e:[]).map(o=>typeof o?.roundTripTime=="number"?o.roundTripTime:null).filter(o=>typeof o=="number"&&Number.isFinite(o)&&o>0);if(c.length>0){const s=Math.min(...c)*1e3;D(s),b&&C("local rtt set",{ms:Math.round(s),source:"LocalVideoTrack.getSenderStats()[].roundTripTime"});return}}catch(e){b&&C("camera getSenderStats failed",e)}const p=Date.now();if(p-X.current<3e3)return;const h=N?.pcManager?.publisher,t=N?.pcManager?.subscriber,n=[h,t].filter(Boolean),k=[E?.track,v?.track].filter(Boolean);if(n.length>0||k.length>0)X.current=p;else{b&&!Q.current&&(Q.current=!0,C("waiting for transports/tracks",{publisher:!!h,subscriber:!!t,trackCandidates:k.length}));return}for(const e of n){if(!e?.getStats)continue;const m=await e.getStats(),c=T(m);if(typeof c=="number"&&Number.isFinite(c)&&c>0){D(c),b&&C("local rtt set",{ms:Math.round(c),source:"pcTransport.getStats()"});return}}for(const e of k){if(!e?.getRTCStatsReport)continue;const m=await e.getRTCStatsReport();if(!m)continue;const c=T(m);if(typeof c=="number"&&Number.isFinite(c)&&c>0){D(c),b&&C("local rtt set",{ms:Math.round(c),source:"MediaStreamTrack.getRTCStatsReport()"});return}}U.current||(U.current=!0,b&&C("could not compute local rtt",{signalRtt:l,transports:n.length,trackCandidates:k.length,localIdentity:S.identity}))}catch(N){b&&C("updateRtt error",N)}},w=setInterval(()=>void d(),1500);d();const P=setTimeout(()=>void d(),2500);return()=>{clearInterval(w),clearTimeout(P)}},[r,S,E?.trackSid,v?.trackSid]),a.useEffect(()=>{if(!r||!S)return;const T=new TextEncoder,d=async()=>{try{const l=K.current;if(typeof l!="number"||!Number.isFinite(l)||l<=0){b&&C("skip publish eb.ping (no local rtt yet)",{localRtt:l});return}const i=Date.now(),u=H.current,p=u.rtt===null||Math.abs(u.rtt-l)>=2;if(!(i-u.at>=2e3)&&!p)return;H.current={at:i,rtt:l};const t=q.current,n={t:"eb.ping",v:2,rtt:Math.round(l),playoutMs:typeof t=="number"&&Number.isFinite(t)&&t>=0?Math.round(t):0,ts:i};await S.publishData(T.encode(JSON.stringify(n)),{reliable:!1,topic:"eb.ping"}),b&&C("publish eb.ping ok",n)}catch(l){b&&C("publish eb.ping failed",l),b&&!window.__ebPingPublishWarned&&(window.__ebPingPublishWarned=!0,console.warn("[Ping] Failed to publish eb.ping (data channel). Check LiveKit token grant canPublishData=true."))}},w=new TextDecoder,P=(l,i,u,p)=>{if(p&&p!=="eb.ping")return;const h=i?.identity;if(h&&!(S&&h===S.identity))try{const t=JSON.parse(w.decode(l));if(!t||t.t!=="eb.ping")return;const n=Number(t.rtt);if(!Number.isFinite(n)||n<=0)return;const k=Number(t.playoutMs),e=Number.isFinite(k)&&k>=0?k:0,m=typeof i?.name=="string"&&i.name?i.name:null,c=F.current.get(h);F.current.set(h,n),m&&F.current.set(m,n),W.current.set(h,e),m&&W.current.set(m,e);const o=typeof i?.metadata=="string"?i.metadata:null;if(o)try{const s=JSON.parse(o);s?.displayName&&F.current.set(String(s.displayName),n),s?.userId&&F.current.set(String(s.userId),n),s?.displayName&&W.current.set(String(s.displayName),e),s?.userId&&W.current.set(String(s.userId),e)}catch{}b&&(c===void 0||Math.abs(c-n)>=2)&&C("recv eb.ping",{from:h,name:m,rtt:n,playoutMs:e,ts:t.ts,topic:p??null}),M.current?.()}catch{}};r.on(we.DataReceived,P);const N=setInterval(()=>void d(),2e3);return d(),()=>{clearInterval(N),r.off(we.DataReceived,P)}},[r,S,b]),a.useEffect(()=>{K.current=I,M.current?.(),b&&C("localRtt state",I)},[I]),a.useEffect(()=>{if(!r)return;const T=document.querySelector(".call-container");if(!T)return;const d=i=>{const u=K.current;return typeof u!="number"||!Number.isFinite(u)||u<=0?"—":i?`${Math.round(u)} мс`:"—"},w=()=>{const i=T.querySelectorAll(".lk-participant-metadata-item[data-lk-quality]");b&&C("dom scan",{indicators:i.length}),i.forEach(u=>{const p=u.closest(".lk-participant-tile, [data-participant]");if(!p)return;const h=ee(p),t=O(p);u.classList.contains("eb-ping-display")||u.classList.add("eb-ping-display");let n=u.querySelector(".eb-ping-text");n||(n=document.createElement("span"),n.className="eb-ping-text",u.appendChild(n));let k=null,e=d(h);if(h){const o=K.current;typeof o=="number"&&Number.isFinite(o)&&o>0&&(k=Math.round(o),e=`${k} мс`)}else{const o=(t?F.current.get(t):void 0)??void 0,s=(t?W.current.get(t):void 0)??0,_=K.current;typeof o=="number"&&Number.isFinite(o)&&o>0&&typeof _=="number"&&_>0&&(k=Math.round((o+_)/2+(typeof s=="number"&&Number.isFinite(s)&&s>=0?s:0)),e=`${k} мс`)}const m=typeof k=="number"&&Number.isFinite(k)&&k>0;if(u.classList.toggle("eb-ping-has-value",m),typeof k=="number"&&Number.isFinite(k)&&k>0){const o=k<=200?"good":k<=500?"warn":"bad";u.setAttribute("data-eb-ping-level",o)}else u.removeAttribute("data-eb-ping-level");const c=m?e:"";if(n.textContent!==c&&(n.textContent=c,b)){const o=K.current,s=t?F.current.get(t):void 0;C("dom set",{name:t,isLocal:h,text:c,mine:o,remote:s})}})};let P=!1;const N=()=>{P||(P=!0,requestAnimationFrame(()=>{P=!1,w()}))};M.current=N;const l=new MutationObserver(()=>N());return l.observe(T,{childList:!0,subtree:!0}),N(),()=>{M.current===N&&(M.current=null),l.disconnect()}},[r,S,f,b]),null}function We(){const f=fe(),{isMicrophoneEnabled:r,microphoneTrack:S}=le(),E=_e(),[v,I]=a.useState(()=>oe(G.aec,!0)),[D,K]=a.useState(()=>oe(G.ns,!0)),[L,A]=a.useState(()=>oe(G.agc,!0)),[q,M]=a.useState(()=>oe(G.krisp,!1)),[F,W]=a.useState("checking"),[X,U]=a.useState("Проверяем поддержку Krisp…");a.useEffect(()=>{let R=!0;async function H(){try{const b=await xe(()=>import("./index-Cc9ouniY.js"),[]),V=typeof b.isKrispNoiseFilterSupported=="function"?b.isKrispNoiseFilterSupported():!1;if(!R)return;W(V?"supported":"unsupported"),U(V?"Браузер поддерживает Krisp.":"Этот браузер не поддерживает Krisp.")}catch{if(!R)return;W("error"),U("Не удалось проверить поддержку Krisp (ошибка загрузки модуля).")}}return H(),()=>{R=!1}},[]);const Q=a.useRef("");return a.useEffect(()=>{if(!f||!r)return;const R=`${v}|${D}|${L}|${S?.trackSid??""}`;Q.current!==R&&(Q.current=R,f.localParticipant.setMicrophoneEnabled(!0,{echoCancellation:v,noiseSuppression:D,autoGainControl:L}).catch(H=>console.warn("[CallSettings] Failed to apply mic capture options",H)))},[f,r,v,D,L,S?.trackSid]),a.useEffect(()=>{r&&F==="supported"&&(E.isNoiseFilterPending||q!==E.isNoiseFilterEnabled&&E.setNoiseFilterEnabled(q).catch(R=>{console.warn("[CallSettings] Krisp setNoiseFilterEnabled failed, disabling toggle",R),M(!1),ie(G.krisp,!1),W("error"),U("Krisp недоступен (ошибка подключения к сервису шумоподавления).")}))},[r,S?.trackSid,q,E.isNoiseFilterPending,E.isNoiseFilterEnabled,F]),a.useEffect(()=>{const R=()=>{const V=document.querySelectorAll(".call-container .lk-settings-menu-modal .lk-media-device-select li"),Z=[],C=new Map;V.forEach(O=>{const T=O.querySelector(".lk-button");if(!T)return;const d=T.textContent||"",w=/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i.test(d);let P=d.replace(/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i,"").trim();P=P.replace(/\s*\([0-9a-fA-F]{4}:[0-9a-fA-F]{0,4}\)?\s*/g,"").trim(),C.has(P)||C.set(P,[]),C.get(P).push(O),w&&Z.push(O)}),Z.forEach(O=>{O.remove()}),document.querySelectorAll(".call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button").forEach(O=>{const T=Array.from(O.childNodes).find(w=>w.nodeType===Node.TEXT_NODE);let d=O.querySelector("span.eb-device-label");if(T&&!d){const w=T.textContent||"";d=document.createElement("span"),d.className="eb-device-label",d.textContent=w,O.replaceChild(d,T)}if(d){let w=d.textContent||"";w=w.replace(/^(Оборудование\s*-\s*|По\s+умолчанию\s*-\s*)/i,"").trim(),w=w.replace(/\s*\([0-9a-fA-F]{4}:[0-9a-fA-F]{0,4}\)?\s*/g,"").trim(),w=w.replace(/\s*\([0-9a-fA-F]{4}:\s*$/,"").trim(),w!==d.textContent&&(d.textContent=w),setTimeout(()=>{const P=O.getBoundingClientRect(),N=d.getBoundingClientRect(),i=P.width-24;if(N.width>i){const u=N.width-i;d.setAttribute("data-overflows","true"),d.style.setProperty("--eb-device-scroll-distance",`${-u}px`)}else d.removeAttribute("data-overflows"),d.style.removeProperty("--eb-device-scroll-distance")},10)}})};R();const H=new MutationObserver(()=>{setTimeout(R,50)}),b=document.querySelector(".call-container .lk-settings-menu-modal");if(b)return H.observe(b,{childList:!0,subtree:!0,characterData:!0}),()=>H.disconnect()},[]),g.jsxs("div",{className:"eb-call-settings",style:{width:"100%"},children:[g.jsx("div",{style:{fontSize:18,fontWeight:600,marginBottom:12},children:"Настройки"}),g.jsxs("div",{className:"eb-settings-section",children:[g.jsx("div",{className:"eb-section-title",children:"Обработка микрофона"}),g.jsx(se,{label:"WebRTC: AEC (анти-эхо)",description:"Эхо‑подавление на уровне браузера (лучше включать почти всегда).",checked:v,onChange:R=>{I(R),ie(G.aec,R)}}),g.jsx(se,{label:"WebRTC: NS (шумоподавление)",description:"Шумоподавление на уровне браузера.",checked:D,onChange:R=>{K(R),ie(G.ns,R)}}),g.jsx(se,{label:"WebRTC: AGC (автогейн)",description:"Автоматическая регулировка усиления микрофона.",checked:L,onChange:R=>{A(R),ie(G.agc,R)}}),g.jsx(se,{label:"Krisp (улучшенное шумоподавление)",description:`${X} Может быть недоступен на self-hosted LiveKit.`,checked:q,disabled:!r||E.isNoiseFilterPending||F==="unsupported"||F==="error",rightHint:r?F==="checking"?"Проверяем…":F==="unsupported"?"Не поддерживается":F==="error"?"Ошибка проверки":E.isNoiseFilterPending?"Применяем…":q&&!E.isNoiseFilterEnabled?"Не активно":E.isNoiseFilterEnabled?"Активно":"":"Включите микрофон",onChange:R=>{M(R),ie(G.krisp,R)}}),g.jsx("div",{className:"eb-settings-note",children:"Изменения AEC/NS/AGC применяются перезапуском микрофона и могут дать короткий “пик” при переключении."})]}),g.jsxs("div",{className:"eb-settings-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:16,alignItems:"start",marginBottom:12},children:[g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Микрофон"}),g.jsx(pe,{kind:"audioinput",requestPermissions:!0})]}),g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Камера"}),g.jsx(pe,{kind:"videoinput",requestPermissions:!0})]}),g.jsxs("div",{className:"eb-device-col",style:{minWidth:0},children:[g.jsx("div",{style:{fontSize:12,opacity:.8,marginBottom:8},children:"Вывод звука"}),g.jsx(pe,{kind:"audiooutput",requestPermissions:!0}),g.jsx("div",{style:{fontSize:11,opacity:.65,marginTop:6},children:"На Safari/iOS переключение устройства вывода может быть недоступно."})]})]}),g.jsx("div",{style:{fontSize:12,opacity:.8},children:"Выберите устройства ввода. Закрыть это окно можно кнопкой «Настройки» внизу."})]})}function Ye({open:f,conversationId:r,onClose:S,onMinimize:E,minimized:v=!1,initialVideo:I=!1,initialAudio:D=!0,peerAvatarUrl:K=null,avatarsByName:L={},avatarsById:A={},localUserId:q=null,isGroup:M=!1}){const[F,W]=a.useState(null),[X,U]=a.useState(null),[Q,R]=a.useState(!D),[H,b]=a.useState(!!I),[V,Z]=a.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[C,ee]=a.useState(!1),O=Ee(i=>i.session?.user),T=a.useRef(!1),d=a.useRef(!1),w=a.useMemo(()=>O?.avatarUrl??null,[O?.avatarUrl]),P=a.useCallback(i=>{if(T.current||(T.current=!0),i?.manual&&(d.current=!0),r&&M){try{Re(r)}catch(p){console.error("Error leaving call room:",p)}try{ve([r])}catch(p){console.error("Error requesting call status update:",p)}}const u=d.current?{...i??{},manual:!0}:i;S(u)},[r,M,S]),N=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
    
    /* Ensure placeholder stays circular and doesn't stretch */
    .call-container .lk-participant-placeholder {
      aspect-ratio: 1 !important;
      border-radius: 50% !important;
      margin: auto !important;
      align-self: center !important;
      flex-shrink: 0 !important;
    }
    
    /* Light semi-transparent border for participant tiles */
    .call-container .lk-participant-tile {
      border: 1px solid rgba(255, 255, 255, 0.12) !important;
      border-radius: 8px !important;
      overflow: hidden !important;
    }
    
    /* Hide chat entry point in the control bar (we expose device selection via Settings and also via button group menus) */
    .call-container .lk-control-bar .lk-chat-toggle { display: none !important; }

    /* Settings toggles */
    .call-container .eb-settings-section { margin-bottom: 16px; }
    .call-container .eb-section-title { font-size: 12px; color: rgba(255,255,255,0.72); margin-bottom: 10px; }
    .call-container .eb-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .call-container .eb-toggle-text { min-width: 0; }
    .call-container .eb-toggle-label { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.92); }
    .call-container .eb-toggle-desc { font-size: 11px; color: rgba(255,255,255,0.62); margin-top: 4px; line-height: 1.25; }
    .call-container .eb-toggle-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .call-container .eb-toggle-hint { font-size: 11px; color: rgba(255,255,255,0.55); max-width: 120px; text-align: right; }
    .call-container .eb-settings-note { font-size: 11px; color: rgba(255,255,255,0.55); margin-top: 6px; }

    .call-container .eb-switch { position: relative; display: inline-flex; align-items: center; }
    .call-container .eb-switch input { position: absolute; opacity: 0; width: 1px; height: 1px; }
    .call-container .eb-switch-track {
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.14);
      position: relative;
      transition: background 120ms ease, border-color 120ms ease;
    }
    .call-container .eb-switch-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transition: transform 120ms ease;
    }
    .call-container .eb-switch input:checked + .eb-switch-track {
      background: rgba(217,119,6,0.55);
      border-color: rgba(217,119,6,0.55);
    }
    .call-container .eb-switch input:checked + .eb-switch-track::after { transform: translateX(20px); }
    .call-container .eb-switch.is-disabled { opacity: 0.55; pointer-events: none; }

    /* Settings modal: keep layout contained and prevent long device labels from breaking columns */
    .call-container .lk-settings-menu-modal {
      width: min(980px, calc(100vw - 32px)) !important;
      max-width: min(980px, calc(100vw - 32px)) !important;
      max-height: min(80vh, 760px) !important;
      min-height: unset !important;
      padding: 20px !important;
      background: var(--surface-200) !important;
      border: 1px solid var(--surface-border) !important;
      border-radius: 16px !important;
      overflow: hidden !important;
      box-shadow: var(--shadow-sharp) !important;
    }

    .call-container .lk-settings-menu-modal .eb-settings-grid {
      min-width: 0 !important;
    }

    .call-container .lk-settings-menu-modal .eb-device-col {
      min-width: 0 !important;
    }

    /* LiveKit uses white-space: nowrap for buttons globally; override inside settings to avoid overflow */
    .call-container .lk-settings-menu-modal .lk-media-device-select {
      width: 100% !important;
      max-width: 100% !important;
      overflow: hidden !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      justify-content: flex-start !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
      position: relative !important;
      text-overflow: ellipsis !important;
    }

    /* Smooth scrolling animation for long device names - only on hover and only if overflowing */
    @keyframes eb-device-scroll {
      0%, 100% {
        transform: translateX(0);
      }
      15% {
        transform: translateX(0);
      }
      42.5% {
        transform: translateX(var(--eb-device-scroll-distance, -100px));
      }
      57.5% {
        transform: translateX(var(--eb-device-scroll-distance, -100px));
      }
      85% {
        transform: translateX(0);
      }
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button {
      display: flex !important;
      align-items: center !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button > span.eb-device-label {
      display: inline-block !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      max-width: 100% !important;
    }

    /* Enable smooth scrolling animation only on hover and only if text overflows */
    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button:hover > span.eb-device-label[data-overflows="true"] {
      overflow: visible !important;
      text-overflow: clip !important;
      max-width: none !important;
      animation: eb-device-scroll 6s ease-in-out infinite !important;
    }

    .call-container .lk-settings-menu-modal .lk-media-device-select li > .lk-button * {
      min-width: 0 !important;
    }

    /* Override LiveKit's blue accent color for selected devices with eblusha brand color */
    .call-container .lk-settings-menu-modal .lk-media-device-select [data-lk-active="true"] > .lk-button {
      color: #fff !important;
      background-color: var(--brand, #d97706) !important;
    }
    .call-container .lk-settings-menu-modal .lk-media-device-select [data-lk-active="true"] > .lk-button:hover {
      background-color: var(--brand-600, #e38b0a) !important;
    }

    /* Ping display: always keep value on one line */
    .call-container .eb-ping-display .eb-ping-text { font-size: 11px; opacity: 0.85; white-space: nowrap; }

    /* LiveKit hides connection quality until hover; keep it always visible so ping is always visible */
    .call-container .lk-participant-tile .lk-connection-quality {
      opacity: 1 !important;
      transition-delay: 0s !important;
    }

    /* When we have a ping value, fully replace the quality icon with text */
    .call-container .lk-connection-quality.eb-ping-display { width: auto !important; min-width: 1.5rem; }
    .call-container .eb-ping-display.eb-ping-has-value svg { display: none !important; }
    .call-container .eb-ping-display.eb-ping-has-value .eb-ping-text { display: inline !important; }
    .call-container .eb-ping-display:not(.eb-ping-has-value) .eb-ping-text { display: none !important; }

    /* Ping severity colors */
    .call-container .eb-ping-display[data-eb-ping-level="good"] .eb-ping-text { color: #22c55e; } /* green */
    .call-container .eb-ping-display[data-eb-ping-level="warn"] .eb-ping-text { color: #fbbf24; } /* yellow */
    .call-container .eb-ping-display[data-eb-ping-level="bad"] .eb-ping-text { color: #ef4444; }  /* red */
  `;if(a.useEffect(()=>{let i=!0;async function u(){if(!f||!r)return;const p=`conv-${r}`,h=await Fe.post("/livekit/token",{room:p,participantMetadata:{app:"eblusha",userId:O?.id,displayName:O?.displayName??O?.username,avatarUrl:w}});if(i){W(h.data.token),U(h.data.url);try{const t=String(h.data.token||"").split(".");if(t.length>=2){const n=t[1].replace(/-/g,"+").replace(/_/g,"/"),k=JSON.parse(atob(n)),e=!!k?.video?.canPublishData||!!k?.video?.can_publish_data;ne("lk-debug-ping","lkDebugPing")&&console.log("[Ping] LiveKit grant canPublishData:",e)}}catch{}}}return u(),()=>{i=!1,W(null),U(null)}},[f,r]),a.useEffect(()=>{f&&(b(!!I),R(!D),ee(!1))},[f,I,D]),a.useEffect(()=>{if(!f)return;if(typeof window<"u"&&window.innerWidth<=768){const u=document.body.style.overflow,p=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=u,document.body.style.touchAction=p}}},[f]),a.useEffect(()=>{f||(T.current=!1,d.current=!1)},[f]),a.useEffect(()=>{const i=()=>Z(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),a.useEffect(()=>{if(!f)return;const i=document.body;if(!i)return;const u=()=>{const n=new Set;document.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(e=>n.add(e)),document.querySelectorAll(".call-container .lk-control-bar button, .call-container button.lk-button").forEach(e=>n.add(e)),n.forEach(e=>{const m=e.getAttribute("aria-label")||e.getAttribute("title")||"";let c="";const o=m.toLowerCase();if(o.includes("microphone")?c=m.includes("mute")?"Выключить микрофон":"Включить микрофон":o.includes("camera")?c=m.includes("disable")||o.includes("off")?"Выключить камеру":"Включить камеру":o.includes("screen")?c=o.includes("stop")?"Остановить показ экрана":"Поделиться экраном":o.includes("flip")?c="Сменить камеру":o.includes("participants")?c="Участники":o.includes("settings")?c="Настройки":o.includes("leave")||o.includes("hang")?c="Выйти":o.includes("chat")&&(c="Чат"),c&&(e.setAttribute("aria-label",c),e.setAttribute("title",c)),e.tagName==="BUTTON"){const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let _=s.nextNode();for(;_;){const y=(_.nodeValue||"").replace(/\s+/g," ").trim().toLowerCase();let $=null;y==="leave"?$="Выйти":y==="participants"?$="Участники":y==="settings"?$="Настройки":y==="microphone"?$="Микрофон":y==="camera"?$="Камера":y==="connecting"?$="Подключение":y==="reconnecting"?$="Переподключение":y==="disconnected"?$="Отключено":(y==="screen share"||y==="share screen"||y==="share-screen"||y==="share-screen "||y.includes("share")&&y.includes("screen"))&&($="Показ экрана"),$&&(_.nodeValue=$,e.setAttribute("aria-label",$),e.setAttribute("title",$)),_=s.nextNode()}}}),document.querySelectorAll(".call-container .lk-toast-connection-state").forEach(e=>{const m=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let c=m.nextNode();for(;c;){const s=(c.nodeValue||"").replace(/\s+/g," ").trim().toLowerCase();s==="connecting"?c.nodeValue="Подключение":s==="reconnecting"?c.nodeValue="Переподключение":s==="disconnected"&&(c.nodeValue="Отключено"),c=m.nextNode()}});const k=i.querySelector(".call-container .lk-control-bar")||i.querySelector(".call-container [data-lk-control-bar]")||i.querySelector('.call-container [role="toolbar"]');if(k&&E){let e=k.querySelector(".eb-minimize-btn");if(!e){e=document.createElement("button"),e.className="eb-minimize-btn lk-button",e.setAttribute("aria-label","Свернуть"),e.setAttribute("title","Свернуть"),e.setAttribute("type","button"),e.innerHTML=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
                <g id="IconSvg_bgCarrier" stroke-width="0"></g>
                <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
                <g id="IconSvg_iconCarrier">
                  <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961 3.75 10.496 10.68 10.496 18.18z"></path>
                  <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                </g>
              </svg>
              <span style="font-size: 14px;">Свернуть</span>
            </span>
          `;const m=o=>{o.preventDefault(),o.stopPropagation();try{E?.()}catch(s){console.error("Minimize click error",s)}};e.onclick=m,e.onmousedown=m,e.style.pointerEvents="auto",e.disabled=!1;let c=k.querySelector("button.lk-disconnect-button")||k.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(c&&c.parentNode){if(!c.__ebLeaveBound){const o=s=>{d.current=!0};c.addEventListener("click",o,!0),c.__ebLeaveBound=o}c.parentNode.insertBefore(e,c)}else k.appendChild(e)}if(e){const m=`
            <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
              <g id="IconSvg_bgCarrier" stroke-width="0"></g>
              <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
              <g id="IconSvg_iconCarrier">
                <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
              </g>
            </svg>`,c=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 14px; font-family: inherit; font-weight: 500; line-height: 20px;">Свернуть</span>
              ${m}
            </span>`;e.innerHTML=V?c:m,e.style.height="44px",e.style.minHeight="44px",e.style.padding="0 12px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="flex-start",e.style.fontFamily="inherit",e.style.fontSize="14px",e.style.fontWeight="500",e.style.lineHeight="20px";const o=s=>{s.preventDefault(),s.stopPropagation();try{E?.()}catch(_){console.error("Minimize click error",_)}};e.onclick=o,e.onmousedown=o,e.style.pointerEvents="auto",e.disabled=!1,e.style.marginLeft="auto",e.parentElement===k&&k.lastElementChild!==e&&k.appendChild(e),k.querySelectorAll("button.lk-button").forEach(s=>{s.style.justifyContent="flex-start"})}}};let p=!1;const h=()=>{p||(p=!0,requestAnimationFrame(()=>{p=!1,u()}))},t=new MutationObserver(()=>h());return t.observe(i,{childList:!0,subtree:!0,attributes:!0}),u(),()=>{t.disconnect();const n=i.querySelector(".call-container .lk-control-bar button.lk-disconnect-button")||i.querySelector('.call-container .lk-control-bar [aria-label*="Выйти" i], .call-container .lk-control-bar [title*="Выйти" i], .call-container .lk-control-bar [aria-label*="leave" i], .call-container .lk-control-bar [title*="leave" i]');n&&n.__ebLeaveBound&&(n.removeEventListener("click",n.__ebLeaveBound,!0),delete n.__ebLeaveBound)}},[f,E,P,V]),a.useEffect(()=>{if(!f)return;const i=document.body;if(!i)return;const u=q||null,p=()=>{i.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(n=>{const k=n.getAttribute("data-lk-local-participant")==="true"||n.dataset?.lkLocalParticipant==="true";let e=n.getAttribute("data-lk-participant-identity")||"";if(!e){const y=n.querySelector("[data-lk-participant-identity]");y&&(e=y.getAttribute("data-lk-participant-identity")||"")}if(!(k||!!(e&&u&&e===u)))return;const o=n.querySelector(".lk-participant-name, [data-lk-participant-name]");if(!o)return;const s=o.textContent||"",_=s.replace(/\s*\(мы\)\s*$/,"").trim();if(!_)return;const x=`${_} (мы)`;s!==x&&(o.textContent=x,o.hasAttribute("data-lk-participant-name")&&o.setAttribute("data-lk-participant-name",x))})};p();const h=new MutationObserver(()=>{setTimeout(p,50)});return h.observe(i,{childList:!0,subtree:!0,characterData:!0}),()=>h.disconnect()},[f,q]),a.useEffect(()=>{if(!f)return;const i=document.body;if(!i)return;const u=L||{},p=A||{},h=q||null,t=w||null,n=ne("lk-debug-avatars","lkDebugAvatars"),k=o=>{let s=0;for(let x=0;x<o.length;x++)s=o.charCodeAt(x)+((s<<5)-s);return`hsl(${Math.abs(s)%360} 70% 45%)`},e=(o,s)=>{const _=k(s),x=o.trim().charAt(0).toUpperCase(),y=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${_}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${x}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(y)}`},m=()=>{i.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(s=>{const _=s.querySelector(".lk-participant-name, [data-lk-participant-name]"),x=s.querySelector(".lk-participant-placeholder");if(!_||!x)return;let y="";const $={};for(let j=0;j<s.attributes.length;j++){const Y=s.attributes[j];Y.name.startsWith("data-")&&($[Y.name]=Y.value)}const me=s.getAttribute("data-lk-participant-identity");if(me&&(y=me.trim()),!y){const j=s.querySelector("[data-lk-participant-identity]");j&&(y=(j.getAttribute("data-lk-participant-identity")||"").trim())}if(!y){const j=s.dataset?.lkParticipantIdentity||s.dataset?.lkParticipantIdentity;j&&(y=String(j).trim())}if(!y){const j=["data-participant-identity","data-identity","data-participant-id","data-user-id"];for(const Y of j){const ae=s.getAttribute(Y);if(ae){y=ae.trim();break}}}const ge=s.getAttribute("data-lk-participant-metadata")||(s.dataset?s.dataset.lkParticipantMetadata:"")||"";let J=null;if(ge)try{J=JSON.parse(ge)}catch{J=null}J?.userId&&(y=String(J.userId).trim());let z=(_.textContent||_.getAttribute("data-lk-participant-name")||"").trim();const Se=z.replace(/\s*\(мы\)\s*$/,"").trim();if(!z&&J?.displayName&&(z=String(J.displayName).trim()),!z){const j=s.querySelector(".lk-participant-metadata");j?.textContent?.trim()&&(z=j.textContent.trim())}z||(z=y||"");const be=!!(y&&h&&y===h),Ne=y?p[y]??null:null,ce=Se||z.replace(/\s*\(мы\)\s*$/,"").trim(),he=Object.keys(u).find(j=>j.toLowerCase()===ce.toLowerCase()),Ce=he?u[he]:null;let ue=Ne??Ce??(be?t||(h?p[h]??null:null):null);const re=e(ce||y||"U",y||ce||"U");if(n&&!ue&&(y||z)){const j=Object.keys(u),Y=z?j.find(ae=>ae.toLowerCase()===z.toLowerCase()):null;console.log("[Avatars] Avatar not found:",{identity:y||"(empty)",name:z||"(empty)",isLocal:be,localIdRef:h||"(empty)",byIdHasIdentity:y?y in p:!1,byNameHasName:!!Y,nameMatch:Y||"(no match)",participantMeta:J?{userId:J.userId,displayName:J.displayName}:null})}x.querySelectorAll("svg").forEach(j=>j.remove()),x.querySelectorAll("svg").forEach(j=>j.style.display="none");let B=x.querySelector("img.eb-ph");B||(B=document.createElement("img"),B.className="eb-ph",x.appendChild(B),B.onerror=()=>{B&&B.src!==re&&(n&&console.log("[Avatars] Avatar image failed to load, using fallback:",B.src),B.src=re)}),B.src!==(ue||re)&&(B.src=ue||re);const ye=s.getBoundingClientRect(),Te=Math.min(ye.width,ye.height),te=Math.floor(Te*.95);x.style.width=`${te}px`,x.style.height=`${te}px`,x.style.maxWidth=`${te}px`,x.style.maxHeight=`${te}px`,x.style.minWidth=`${te}px`,x.style.minHeight=`${te}px`,x.style.flexShrink="0",x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="center",x.style.background="transparent",x.style.backgroundImage="none",x.style.color="transparent",x.style.fontSize="0",x.style.overflow="hidden",x.style.margin="auto",x.style.borderRadius="50%",x.style.aspectRatio="1",B.alt=z,B.style.aspectRatio="1",B.style.width="100%",B.style.height="100%",B.style.maxWidth="100%",B.style.maxHeight="100%",B.style.objectFit="cover",B.style.borderRadius="50%",B.style.display="block",Array.from(x.childNodes).forEach(j=>{j.nodeType===Node.TEXT_NODE&&(j.textContent="")})})},c=new MutationObserver(m);return c.observe(i,{childList:!0,subtree:!0}),m(),()=>c.disconnect()},[f,L,A,q,w]),!f||!r||!F||!X)return null;const l=g.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:v?"transparent":"rgba(10,12,16,0.55)",backdropFilter:v?"none":"blur(4px) saturate(110%)",display:v?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:v?"none":"auto"},children:g.jsxs("div",{"data-lk-theme":"default",style:{width:v?0:"90vw",height:v?0:"80vh",maxWidth:v?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:v?"none":"var(--shadow-sharp)",opacity:v?0:1,visibility:v?"hidden":"visible"},className:"call-container",children:[g.jsx("style",{children:N}),g.jsx(Pe,{serverUrl:X,token:F,connect:!0,video:H,audio:!Q,onConnected:()=>{ee(!0);try{r&&M&&(ne("lk-debug-call","lkDebugCall")&&console.log("[CallOverlay] joinCallRoom emit",{conversationId:r,video:I}),Le(r,I),ve([r]))}catch(i){console.error("Error joining call room:",i)}},onDisconnected:i=>{ne("lk-debug-call","lkDebugCall")&&console.log("[CallOverlay] onDisconnected:",i,"wasConnected:",C,"isGroup:",M,"minimized:",v);const u=C;ee(!1);const p=i===1||d.current;v||(M?u&&P({manual:p}):p&&P({manual:!0}))},children:g.jsxs("div",{style:{width:"100%",height:"100%"},children:[g.jsx(Be,{}),g.jsx(Ke,{}),g.jsx(Oe,{localUserId:q}),g.jsx(je,{SettingsComponent:We})]})})]})});return Ae.createPortal(l,document.body)}export{Ye as CallOverlay};
