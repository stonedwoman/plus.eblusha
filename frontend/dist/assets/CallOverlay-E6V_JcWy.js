import{r as h,j as L}from"./vendor-query-D8-W16Rz.js";import{u as ge,P as be,m as ie,e as ve,d as ke,M as we}from"./index-DdNPMNy-.js";import{W as xe,a as Ce}from"./index-BGpmfXXY.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const y=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const f=await y(),q=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(q))return f;const p=[],w=[],R=[],H=(s,C)=>{const S=s.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(S)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(S)||/(back|rear)/.test(C.toLowerCase())?"back":"other"};f.forEach(s=>{if(s.kind!=="videoinput"){R.push(s);return}const C=H(s.label||"",s.deviceId||"");C==="front"?p.push(s):w.push(s)});const x=[];if(p.length>0&&x.push(p[0]),w.length>0&&x.push(w[0]),x.length===0&&f.some(s=>s.kind==="videoinput")){const s=f.find(C=>C.kind==="videoinput");s&&x.push(s)}return R.forEach(s=>{s.kind!=="videoinput"&&x.push(s)}),x},window.__eblushaEnumeratePatched=!0}function Le({open:y,conversationId:f,onClose:q,onMinimize:O,minimized:p=!1,initialVideo:w=!1,initialAudio:R=!0,peerAvatarUrl:H=null,avatarsByName:x={},avatarsById:s={},localUserId:C=null,isGroup:S=!1}){const[X,J]=h.useState(null),[Q,Y]=h.useState(null),[oe,se]=h.useState(!R),[ce,de]=h.useState(!!w),[Z,ue]=h.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[V,P]=h.useState(!1),M=ge(r=>r.session?.user),z=h.useRef(!1),D=h.useRef(!1),B=h.useMemo(()=>M?.avatarUrl??null,[M?.avatarUrl]),T=h.useCallback(r=>{if(z.current||(z.current=!0),r?.manual&&(D.current=!0),f&&S){try{be(f)}catch(c){console.error("Error leaving call room:",c)}try{ie([f])}catch(c){console.error("Error requesting call status update:",c)}}const m=D.current?{...r??{},manual:!0}:r;q(m)},[f,S,q]),fe=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
    
    /* Ensure placeholder stays circular and doesn't stretch */
    .call-container .lk-participant-placeholder {
      aspect-ratio: 1 !important;
      border-radius: 50% !important;
      margin: auto !important;
      align-self: center !important;
      flex-shrink: 0 !important;
    }
  `;if(h.useEffect(()=>{let r=!0;async function m(){if(!y||!f)return;const c=`conv-${f}`,v=await ke.post("/livekit/token",{room:c,participantMetadata:{app:"eblusha",userId:M?.id,displayName:M?.displayName??M?.username,avatarUrl:B}});r&&(J(v.data.token),Y(v.data.url))}return m(),()=>{r=!1,J(null),Y(null)}},[y,f]),h.useEffect(()=>{y&&(de(!!w),se(!R),P(!1))},[y,w,R]),h.useEffect(()=>{if(!y)return;if(typeof window<"u"&&window.innerWidth<=768){const m=document.body.style.overflow,c=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=m,document.body.style.touchAction=c}}},[y]),h.useEffect(()=>{y||(z.current=!1,D.current=!1)},[y]),h.useEffect(()=>{const r=()=>ue(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]),h.useEffect(()=>{if(!y)return;const r=document.body;if(!r)return;const m=()=>{const N=new Set;document.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(e=>N.add(e)),document.querySelectorAll(".call-container .lk-control-bar button, .call-container button.lk-button").forEach(e=>N.add(e)),N.forEach(e=>{const g=e.getAttribute("aria-label")||e.getAttribute("title")||"";let i="";const o=g.toLowerCase();if(o.includes("microphone")?i=g.includes("mute")?"Выключить микрофон":"Включить микрофон":o.includes("camera")?i=g.includes("disable")||o.includes("off")?"Выключить камеру":"Включить камеру":o.includes("screen")?i=o.includes("stop")?"Остановить показ экрана":"Поделиться экраном":o.includes("flip")?i="Сменить камеру":o.includes("participants")?i="Участники":o.includes("settings")?i="Настройки":o.includes("leave")||o.includes("hang")?i="Выйти":o.includes("chat")&&(i="Чат"),i&&(e.setAttribute("aria-label",i),e.setAttribute("title",i)),e.tagName==="BUTTON"){const u=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let n=u.nextNode();for(;n;){const t=(n.nodeValue||"").replace(/\s+/g," ").trim().toLowerCase();let a=null;t==="leave"?a="Выйти":t==="participants"?a="Участники":t==="settings"?a="Настройки":t==="microphone"?a="Микрофон":t==="camera"?a="Камера":(t==="screen share"||t==="share screen"||t==="share-screen"||t==="share-screen "||t.includes("share")&&t.includes("screen"))&&(a="Показ экрана"),a&&(n.nodeValue=a,e.setAttribute("aria-label",a),e.setAttribute("title",a)),n=u.nextNode()}}}),r.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(e=>{const g=e;g.style.display="none";try{g.remove()}catch{}});const k=r.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(k&&O){let e=k.querySelector(".eb-minimize-btn");if(!e){e=document.createElement("button"),e.className="eb-minimize-btn lk-button",e.setAttribute("aria-label","Свернуть"),e.setAttribute("title","Свернуть"),e.setAttribute("type","button"),e.innerHTML=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
                <g id="IconSvg_bgCarrier" stroke-width="0"></g>
                <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
                <g id="IconSvg_iconCarrier">
                  <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961 3.75 10.496 10.68 10.496 18.18z"></path>
                  <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                </g>
              </svg>
              <span style="font-size: 14px;">Свернуть</span>
            </span>
          `;const g=o=>{o.preventDefault(),o.stopPropagation();try{O?.()}catch(u){console.error("Minimize click error",u)}};e.onclick=g,e.onmousedown=g,e.style.pointerEvents="auto",e.disabled=!1;const i=k.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(i&&i.parentNode){if(!i.__ebLeaveBound){const o=()=>{setTimeout(()=>T({manual:!0}),0)};i.addEventListener("click",o),i.__ebLeaveBound=o}i.parentNode.insertBefore(e,i)}else k.appendChild(e)}if(e){const g=`
            <svg fill="currentColor" stroke="currentColor" width="30px" height="30px" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" transform="matrix(6.123233995736766e-17,1,-1,6.123233995736766e-17,0,0)">
              <g id="IconSvg_bgCarrier" stroke-width="0"></g>
              <g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC"></g>
              <g id="IconSvg_iconCarrier">
                <path d="m546.94 400v125.95-0.003906c0 5.5703-2.2109 10.91-6.1484 14.844-3.9336 3.9375-9.2734 6.1484-14.844 6.1484h-251.9c-5.5664 0-10.906-2.2109-14.844-6.1484-3.9375-3.9336-6.1484-9.2734-6.1484-14.844v-251.9c0-5.5664 2.2109-10.906 6.1484-14.844s9.2773-6.1484 14.844-6.1484h125.95c7.5 0 14.43 4 18.18 10.496 3.75 6.4961 3.75 14.496 0 20.992-3.75 6.4961-10.68 10.496-18.18 10.496h-104.96v209.92h209.92v-104.96c0-7.5 4.0039-14.43 10.496-18.18 6.4961-3.75 14.5-3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
                <path fill="#d97706" stroke="#d97706" d="m567.93 253.05c0.019531-2.457-0.48047-4.8906-1.4688-7.1367-1.0117-2.043-2.2812-3.9492-3.7773-5.668l-1.6797-1.2578v-0.003907 c-1.2461-1.2812-2.7461-2.2812-4.4102-2.9375h-1.8906 0.003907c-2.2812-1.8594-4.9297-3.2188-7.7695-3.9883h-62.977 c-7.4961 0-14.43 4-18.18 10.496-3.7461 6.4961-3.7461 14.496 0 20.992 3.75 6.4961 10.684 10.496 18.18 10.496h12.387 l-111.26 111.05c-3.9727 3.9414-6.2109 9.3086-6.2109 14.906s2.2383 10.961 6.2109 14.902c3.9414 3.9727 9.3086 6.2109 14.906 6.2109s10.961-2.2383 14.902-6.2109l111.05-111.26v12.387c0 7.5 4.0039 14.43 10.496 18.18 6.4961 3.75 14.5 3.75 20.992 0 6.4961-3.75 10.496-10.68 10.496-18.18z"></path>
              </g>
            </svg>`,i=`
            <span style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 14px; font-family: inherit; font-weight: 500; line-height: 20px;">Свернуть</span>
              ${g}
            </span>`;e.innerHTML=Z?i:g,e.style.height="44px",e.style.minHeight="44px",e.style.padding="0 12px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="flex-start",e.style.fontFamily="inherit",e.style.fontSize="14px",e.style.fontWeight="500",e.style.lineHeight="20px";const o=u=>{u.preventDefault(),u.stopPropagation();try{O?.()}catch(n){console.error("Minimize click error",n)}};e.onclick=o,e.onmousedown=o,e.style.pointerEvents="auto",e.disabled=!1,e.style.marginLeft="auto",e.parentElement===k&&k.lastElementChild!==e&&k.appendChild(e),k.querySelectorAll("button.lk-button").forEach(u=>{u.style.justifyContent="flex-start"})}}};let c=!1;const v=()=>{c||(c=!0,requestAnimationFrame(()=>{c=!1,m()}))},U=new MutationObserver(()=>v());return U.observe(r,{childList:!0,subtree:!0,attributes:!0}),m(),()=>U.disconnect()},[y,O,T,Z]),h.useEffect(()=>{if(!y)return;const r=document.body;if(!r)return;const m=x||{},c=s||{},v=C||null,U=B||null,N=H||null,F=Object.entries(c),k=Object.entries(m);console.log("[CallOverlay] Avatar maps initialized:",{byId:F.length,byName:k.length,byIdEntries:F.map(([u,n])=>({id:u,url:n?"present":"null"})),byNameEntries:k.map(([u,n])=>({name:u,url:n?"present":"null"})),localIdRef:v||"(empty)",myAvatar:U?"present":"missing",peerAvatar:N?"present":"missing"});const e=u=>{let n=0;for(let t=0;t<u.length;t++)n=u.charCodeAt(t)+((n<<5)-n);return`hsl(${Math.abs(n)%360} 70% 45%)`},g=(u,n)=>{const j=e(n),t=u.trim().charAt(0).toUpperCase(),a=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${j}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${t}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(a)}`},i=()=>{r.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(n=>{const j=n.querySelector(".lk-participant-name, [data-lk-participant-name]"),t=n.querySelector(".lk-participant-placeholder");if(!j||!t)return;let a="";const he={};for(let l=0;l<n.attributes.length;l++){const A=n.attributes[l];A.name.startsWith("data-")&&(he[A.name]=A.value)}const G=n.getAttribute("data-lk-participant-identity");if(G&&(a=G.trim()),!a){const l=n.querySelector("[data-lk-participant-identity]");l&&(a=(l.getAttribute("data-lk-participant-identity")||"").trim())}if(!a){const l=n.dataset?.lkParticipantIdentity||n.dataset?.lkParticipantIdentity;l&&(a=String(l).trim())}if(!a){const l=["data-participant-identity","data-identity","data-participant-id","data-user-id"];for(const A of l){const $=n.getAttribute(A);if($){a=$.trim();break}}}const ee=n.getAttribute("data-lk-participant-metadata")||(n.dataset?n.dataset.lkParticipantMetadata:"")||"";let E=null;if(ee)try{E=JSON.parse(ee)}catch{E=null}E?.userId&&(a=String(E.userId).trim());let b=(j.textContent||j.getAttribute("data-lk-participant-name")||"").trim();if(!b&&E?.displayName&&(b=String(E.displayName).trim()),!b){const l=n.querySelector(".lk-participant-metadata");l?.textContent?.trim()&&(b=l.textContent.trim())}b||(b=a||"");const K=!!(a&&v&&a===v),te=a?c[a]??null:null,ae=Object.keys(m).find(l=>l.toLowerCase()===b.toLowerCase()),ne=ae?m[ae]:null,me=U,re=K?null:N;let _=te??ne??(K?me||(v?c[v]??null:null):re);const W=g(b||a||"U",a||b||"U");if(!_&&(a||b)){const l=Object.keys(m),A=b?l.find($=>$.toLowerCase()===b.toLowerCase()):null;console.log("[CallOverlay Avatar Debug] Avatar not found:",{identity:a||"(empty)",name:b||"(empty)",isLocal:K,localIdRef:v||"(empty)",idUrl:te||"(not found)",url:ne||"(not found)",peerUrl:re||"(not found)",peerAvatarRef:N||"(not set)",finalUrl:_||"(using fallback)",byIdEntries:Object.entries(c),byNameEntries:Object.entries(m),byIdHasIdentity:a?a in c:!1,byNameHasName:!!A,nameMatch:A||"(no match)",allNameKeys:l,participantMeta:E?{userId:E.userId,displayName:E.displayName}:null})}t.querySelectorAll("svg").forEach(l=>l.remove()),t.querySelectorAll("svg").forEach(l=>l.style.display="none");let d=t.querySelector("img.eb-ph");d||(d=document.createElement("img"),d.className="eb-ph",t.appendChild(d),d.onerror=()=>{d&&d.src!==W&&(console.log("[CallOverlay] Avatar image failed to load, using fallback:",d.src),d.src=W)}),d.src!==(_||W)&&(d.src=_||W);const le=n.getBoundingClientRect(),ye=Math.min(le.width,le.height),I=Math.floor(ye*.95);t.style.width=`${I}px`,t.style.height=`${I}px`,t.style.maxWidth=`${I}px`,t.style.maxHeight=`${I}px`,t.style.minWidth=`${I}px`,t.style.minHeight=`${I}px`,t.style.flexShrink="0",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.background="transparent",t.style.backgroundImage="none",t.style.color="transparent",t.style.fontSize="0",t.style.overflow="hidden",t.style.margin="auto",t.style.borderRadius="50%",t.style.aspectRatio="1",d.alt=b,d.style.aspectRatio="1",d.style.width="100%",d.style.height="100%",d.style.maxWidth="100%",d.style.maxHeight="100%",d.style.objectFit="cover",d.style.borderRadius="50%",d.style.display="block",Array.from(t.childNodes).forEach(l=>{l.nodeType===Node.TEXT_NODE&&(l.textContent="")})})},o=new MutationObserver(i);return o.observe(r,{childList:!0,subtree:!0}),i(),()=>o.disconnect()},[y,x,s,C,B]),!y||!f||!X||!Q)return null;const pe=L.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:p?"transparent":"rgba(10,12,16,0.55)",backdropFilter:p?"none":"blur(4px) saturate(110%)",display:p?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:p?"none":"auto"},children:L.jsxs("div",{"data-lk-theme":"default",style:{width:p?0:"90vw",height:p?0:"80vh",maxWidth:p?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:p?"none":"var(--shadow-sharp)",opacity:p?0:1,visibility:p?"hidden":"visible"},className:"call-container",children:[L.jsx("style",{children:fe}),L.jsx(xe,{serverUrl:Q,token:X,connect:!0,video:ce,audio:!oe,onConnected:()=>{P(!0);try{f&&S&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:f,video:w}),we(f,w),ie([f]))}catch(r){console.error("Error joining call room:",r)}},onDisconnected:r=>{console.log("[CallOverlay] onDisconnected:",r,"wasConnected:",V,"isGroup:",S,"minimized:",p);const m=V;P(!1);const c=r===1||D.current;p||(S?m&&T({manual:c}):c&&T({manual:!0}))},children:L.jsx("div",{style:{width:"100%",height:"100%"},children:L.jsx(Ce,{})})})]})});return ve.createPortal(pe,document.body)}export{Le as CallOverlay};
