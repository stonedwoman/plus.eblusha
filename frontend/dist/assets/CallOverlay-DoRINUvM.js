import{r as c,j}from"./vendor-query-D8-W16Rz.js";import{u as se,M as ie,j as X,I as ce,c as ue,K as de}from"./index-VZSEfgNq.js";import{W as fe,a as pe}from"./index-BGpmfXXY.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const d=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const l=await d(),R=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(R))return l;const f=[],m=[],C=[],_=(r,k)=>{const w=r.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(w)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(w)||/(back|rear)/.test(k.toLowerCase())?"back":"other"};l.forEach(r=>{if(r.kind!=="videoinput"){C.push(r);return}const k=_(r.label||"",r.deviceId||"");k==="front"?f.push(r):m.push(r)});const g=[];if(f.length>0&&g.push(f[0]),m.length>0&&g.push(m[0]),g.length===0&&l.some(r=>r.kind==="videoinput")){const r=l.find(k=>k.kind==="videoinput");r&&g.push(r)}return C.forEach(r=>{r.kind!=="videoinput"&&g.push(r)}),g},window.__eblushaEnumeratePatched=!0}function xe({open:d,conversationId:l,onClose:R,onMinimize:N,minimized:f=!1,initialVideo:m=!1,initialAudio:C=!0,peerAvatarUrl:_=null,avatarsByName:g={},avatarsById:r={},localUserId:k=null,isGroup:w=!1}){const[P,W]=c.useState(null),[B,F]=c.useState(null),[Q,Y]=c.useState(!C),[Z,z]=c.useState(!!m),[he,G]=c.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[I,O]=c.useState(!1),L=se(e=>e.session?.user),M=c.useRef(!1),U=c.useRef(!1),T=c.useMemo(()=>L?.avatarUrl??null,[L?.avatarUrl]),q=c.useCallback(e=>{if(M.current||(M.current=!0),e?.manual&&(U.current=!0),l&&w){try{ie(l)}catch(u){console.error("Error leaving call room:",u)}try{X([l])}catch(u){console.error("Error requesting call status update:",u)}}const p=U.current?{...e??{},manual:!0}:e;R(p)},[l,w,R]),V=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
  `;if(c.useEffect(()=>{let e=!0;async function p(){if(!d||!l)return;const u=`conv-${l}`,x=await ue.post("/livekit/token",{room:u,participantMetadata:{app:"eblusha",userId:L?.id,displayName:L?.displayName??L?.username,avatarUrl:T}});e&&(W(x.data.token),F(x.data.url))}return p(),()=>{e=!1,W(null),F(null)}},[d,l]),c.useEffect(()=>{d&&(z(!!m),Y(!C),O(!1))},[d,m,C]),c.useEffect(()=>{if(!d)return;if(typeof window<"u"&&window.innerWidth<=768){const p=document.body.style.overflow,u=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=p,document.body.style.touchAction=u}}},[d]),c.useEffect(()=>{d||(M.current=!1,U.current=!1)},[d]),c.useEffect(()=>{const e=()=>G(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),c.useEffect(()=>{if(!d)return;const e=document.body;if(!e)return;const p=()=>{e.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(t=>{const s=t.getAttribute("aria-label")||t.getAttribute("title")||"";let n="";const i=s.toLowerCase();i.includes("microphone")?n=s.includes("mute")?"Выключить микрофон":"Включить микрофон":i.includes("camera")?n=s.includes("disable")||i.includes("off")?"Выключить камеру":"Включить камеру":i.includes("screen")?n=i.includes("stop")?"Остановить показ экрана":"Поделиться экраном":i.includes("flip")?n="Сменить камеру":i.includes("participants")?n="Участники":i.includes("settings")?n="Настройки":i.includes("leave")||i.includes("hang")?n="Выйти":i.includes("chat")&&(n="Чат"),n&&(t.setAttribute("aria-label",n),t.setAttribute("title",n))}),e.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(t=>{const s=t;s.style.display="none";try{s.remove()}catch{}});const E=e.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(E&&N){let t=E.querySelector(".eb-minimize-btn");if(!t){t=document.createElement("button"),t.className="eb-minimize-btn lk-button",t.setAttribute("aria-label","Свернуть"),t.setAttribute("title","Свернуть"),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',t.style.cssText="display: flex; align-items: center; justify-content: center; background: var(--surface-100); color: var(--text-primary); border: 1px solid var(--surface-border); border-radius: 8px; padding: 8px; cursor: pointer; transition: background 0.2s ease;",t.onmouseenter=()=>{t.style.background="var(--surface-200)"},t.onmouseleave=()=>{t.style.background="var(--surface-100)"},t.onclick=n=>{n.stopPropagation(),N()};const s=E.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(s&&s.parentNode){if(!s.__ebLeaveBound){const n=()=>{setTimeout(()=>q({manual:!0}),0)};s.addEventListener("click",n),s.__ebLeaveBound=n}s.parentNode.insertBefore(t,s)}else E.appendChild(t)}}},u=new MutationObserver(()=>p());return u.observe(e,{childList:!0,subtree:!0,attributes:!0}),p(),()=>u.disconnect()},[d,N,q]),c.useEffect(()=>{if(!d)return;const e=document.body;if(!e)return;const p=g||{},u=r||{},x=k||null,$=T||null,E=i=>{let o=0;for(let a=0;a<i.length;a++)o=i.charCodeAt(a)+((o<<5)-o);return`hsl(${Math.abs(o)%360} 70% 45%)`},t=(i,o)=>{const S=E(o),a=i.trim().charAt(0).toUpperCase(),D=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${S}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${a}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(D)}`},s=()=>{e.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(o=>{const S=o.querySelector(".lk-participant-name, [data-lk-participant-name]"),a=o.querySelector(".lk-participant-placeholder");if(!S||!a)return;const D=o.getAttribute("data-lk-participant-identity")?o:o.querySelector("[data-lk-participant-identity]");let b=D?(D.getAttribute("data-lk-participant-identity")||"").trim():"";const H=o.getAttribute("data-lk-participant-metadata")||(o.dataset?o.dataset.lkParticipantMetadata:"")||"";let A=null;if(H)try{A=JSON.parse(H)}catch{A=null}!b&&A?.userId&&(b=String(A.userId));let v=(S.textContent||S.getAttribute("data-lk-participant-name")||"").trim();if(!v&&A?.displayName&&(v=String(A.displayName).trim()),!v){const y=o.querySelector(".lk-participant-metadata");y?.textContent?.trim()&&(v=y.textContent.trim())}v||(v=b||"");const te=b?u[b]??null:null,J=Object.keys(p).find(y=>y.toLowerCase()===v.toLowerCase()),ae=J?p[J]:null,re=$,K=!!(b&&x&&b===x),ne=!K&&!b&&(o.getAttribute("data-lk-local-participant")!==null||o.getAttribute("data-lk-local")!==null||o.dataset.lkLocalParticipant==="true");let oe=te??ae??(K||ne?re||(x?u[x]??null:null):null);const le=t(v||b||"U",b||v||"U");a.querySelectorAll("svg").forEach(y=>y.remove()),a.querySelectorAll("svg").forEach(y=>y.style.display="none");let h=a.querySelector("img.eb-ph");h||(h=document.createElement("img"),h.className="eb-ph",a.appendChild(h)),h.src=oe||le,h.alt=v,h.style.width="auto",h.style.height="auto",h.style.maxWidth="85%",h.style.maxHeight="85%",h.style.objectFit="cover",h.style.borderRadius="50%",h.style.display="block",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.background="transparent",a.style.backgroundImage="none",a.style.color="transparent",a.style.fontSize="0",a.style.overflow="hidden";try{a.style.borderRadius="50%"}catch{}Array.from(a.childNodes).forEach(y=>{y.nodeType===Node.TEXT_NODE&&(y.textContent="")})})},n=new MutationObserver(s);return n.observe(e,{childList:!0,subtree:!0}),s(),()=>n.disconnect()},[d,g,r,k,T]),!d||!l||!P||!B)return null;const ee=j.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:f?"transparent":"rgba(10,12,16,0.55)",backdropFilter:f?"none":"blur(4px) saturate(110%)",display:f?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:f?"none":"auto"},children:j.jsxs("div",{"data-lk-theme":"default",style:{width:f?0:"90vw",height:f?0:"80vh",maxWidth:f?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:f?"none":"var(--shadow-sharp)",opacity:f?0:1,visibility:f?"hidden":"visible"},className:"call-container",children:[j.jsx("style",{children:V}),j.jsx(fe,{serverUrl:B,token:P,connect:!0,video:Z,audio:!Q,onConnected:()=>{O(!0);try{l&&w&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:l,video:m}),de(l,m),X([l]))}catch(e){console.error("Error joining call room:",e)}},onDisconnected:e=>{console.log("[CallOverlay] onDisconnected:",e,"wasConnected:",I,"isGroup:",w);const p=I;O(!1);const u=e===1||U.current;p?q({manual:u}):w||q({manual:u})},children:j.jsx("div",{style:{width:"100%",height:"100%"},children:j.jsx(pe,{})})})]})});return ce.createPortal(ee,document.body)}export{xe as CallOverlay};
