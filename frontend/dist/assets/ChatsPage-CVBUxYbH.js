const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-C5Ub4O6t.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/index-Z1T4QCve.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/index-CD81hMhF.js","assets/index-DqkCZ1FC.css"])))=>i.map(i=>d[i]);
import{d as Hi,g as vt,e as xr,n as gt,c as z,f as Bi,s as K,u as mt,o as Pi,h as Wi,i as vr,j as br,k as wr,l as Oi,m as Fi,p as Xi,q as Yi,t as _i,v as $i,w as Gi,x as qi,y as Ki,z as Vi,A as Qi,B as Ji,D as Zi,E as ea,F as ta,G as na,H as jr,I as Sr,J as Ir,K as sa,L as kr,M as Cr,P as Er,Q as ra,R as ia,S as aa,T as oa,_ as ca}from"./index-Z1T4QCve.js";import{r as c,j as t,b as yt,c as la}from"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const da=i=>i.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),ua=i=>i.replace(/^([A-Z])|[\s-_]+(\w)/g,(d,f,m)=>m?m.toUpperCase():f.toLowerCase()),Ar=i=>{const d=ua(i);return d.charAt(0).toUpperCase()+d.slice(1)},Hr=(...i)=>i.filter((d,f,m)=>!!d&&d.trim()!==""&&m.indexOf(d)===f).join(" ").trim(),fa=i=>{for(const d in i)if(d.startsWith("aria-")||d==="role"||d==="title")return!0};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var ha={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=c.forwardRef(({color:i="currentColor",size:d=24,strokeWidth:f=2,absoluteStrokeWidth:m,className:b="",children:S,iconNode:k,...M},T)=>c.createElement("svg",{ref:T,...ha,width:d,height:d,stroke:i,strokeWidth:m?Number(f)*24/Number(d):f,className:Hr("lucide",b),...!S&&!fa(M)&&{"aria-hidden":"true"},...M},[...k.map(([U,X])=>c.createElement(U,X)),...Array.isArray(S)?S:[S]]));/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=(i,d)=>{const f=c.forwardRef(({className:m,...b},S)=>c.createElement(pa,{ref:S,iconNode:d,className:Hr(`lucide-${da(Ar(i))}`,`lucide-${i}`,m),...b}));return f.displayName=Ar(i),f};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ga=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ma=ee("arrow-left",ga);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ya=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],xa=ee("bell-ring",ya);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const va=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Rr=ee("circle-check-big",va);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],wa=ee("circle-plus",ba);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ja=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],ds=ee("cloud-upload",ja);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ia=ee("copy",Sa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ka=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Sn=ee("lock",ka);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],Lr=ee("log-out",Ca);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Aa=ee("maximize-2",Ea);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ra=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],La=ee("paperclip",Ra);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],Mr=ee("phone-off",Ma);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],us=ee("phone",Da);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Na=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Ta=ee("reply",Na);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ua=ee("trash-2",za);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ha=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],fs=ee("user-plus",Ha);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ba=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Pa=ee("users",Ba);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],hs=ee("video",Wa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Ne=ee("x",Oa);function Fa(i){let d=0;for(let k=0;k<i.length;k++)d=i.charCodeAt(k)+((d<<5)-d);const f=Math.abs(d),m=24+f%18-9,b=60+f%15,S=30+f%12;return`hsl(${m} ${b}% ${S}%)`}function se({name:i,size:d=40,id:f=i,presence:m,avatarUrl:b}){const S=Fa(f),k=(i||"?").trim().charAt(0).toUpperCase(),M=!!b?.startsWith("emoji:"),T=M?b.slice(6):null,[U,X]=c.useState(!1),W=c.useMemo(()=>{if(!b||M)return b??null;if(b.startsWith("data:")||typeof window>"u")return b;try{if(b.startsWith("http://")||b.startsWith("https://"))return b;const de=window.location,ge=new URL(b,de.origin);return ge.host===de.host&&ge.protocol!==de.protocol&&(ge.protocol=de.protocol),ge.toString()}catch{return b}},[b,M]);c.useEffect(()=>{X(!1)},[b]);const ce=W&&!M&&!U;return t.jsxs("div",{style:{width:d,height:d,borderRadius:"50%",background:S,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[ce?t.jsx("img",{src:W,alt:i,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:()=>X(!0)}):M?t.jsx("span",{style:{fontSize:Math.floor(d*.6)},children:T}):k,m&&t.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(d*.28)),height:Math.max(8,Math.floor(d*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:m==="ONLINE"?"#22c55e":m==="AWAY"?"#f59e0b":m==="IN_CALL"?"#22c55e":"#9ca3af"}})]})}const ps=Hi(i=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:d=>i({incoming:d}),startOutgoing:(d,f)=>i({activeConvId:d,incoming:null,initialVideo:!!f,initialAudio:!0}),startIncoming:d=>i({incoming:d}),endCall:()=>i({activeConvId:null,incoming:null,initialVideo:!1})}));/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Xa(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function ys(i){if(!Number.isSafeInteger(i)||i<0)throw new Error("positive integer expected, got "+i)}function kn(i,...d){if(!Xa(i))throw new Error("Uint8Array expected");if(d.length>0&&!d.includes(i.length))throw new Error("Uint8Array expected of length "+d+", got length="+i.length)}function xs(i){if(typeof i!="function"||typeof i.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");ys(i.outputLen),ys(i.blockLen)}function In(i,d=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(d&&i.finished)throw new Error("Hash#digest() has already been called")}function Ya(i,d){kn(i);const f=d.outputLen;if(i.length<f)throw new Error("digestInto() expects output buffer of length at least "+f)}function zt(...i){for(let d=0;d<i.length;d++)i[d].fill(0)}function gs(i){return new DataView(i.buffer,i.byteOffset,i.byteLength)}function Re(i,d){return i<<32-d|i>>>d}function _a(i){if(typeof i!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(i))}function Ut(i){return typeof i=="string"&&(i=_a(i)),kn(i),i}class Br{}function $a(i){const d=m=>i().update(Ut(m)).digest(),f=i();return d.outputLen=f.outputLen,d.blockLen=f.blockLen,d.create=()=>i(),d}class Pr extends Br{constructor(d,f){super(),this.finished=!1,this.destroyed=!1,xs(d);const m=Ut(f);if(this.iHash=d.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const b=this.blockLen,S=new Uint8Array(b);S.set(m.length>b?d.create().update(m).digest():m);for(let k=0;k<S.length;k++)S[k]^=54;this.iHash.update(S),this.oHash=d.create();for(let k=0;k<S.length;k++)S[k]^=106;this.oHash.update(S),zt(S)}update(d){return In(this),this.iHash.update(d),this}digestInto(d){In(this),kn(d,this.outputLen),this.finished=!0,this.iHash.digestInto(d),this.oHash.update(d),this.oHash.digestInto(d),this.destroy()}digest(){const d=new Uint8Array(this.oHash.outputLen);return this.digestInto(d),d}_cloneInto(d){d||(d=Object.create(Object.getPrototypeOf(this),{}));const{oHash:f,iHash:m,finished:b,destroyed:S,blockLen:k,outputLen:M}=this;return d=d,d.finished=b,d.destroyed=S,d.blockLen=k,d.outputLen=M,d.oHash=f._cloneInto(d.oHash),d.iHash=m._cloneInto(d.iHash),d}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const vs=(i,d,f)=>new Pr(i,d).update(f).digest();vs.create=(i,d)=>new Pr(i,d);function Ga(i,d,f){return xs(i),f===void 0&&(f=new Uint8Array(i.outputLen)),vs(i,Ut(f),Ut(d))}const ms=Uint8Array.from([0]),Dr=Uint8Array.of();function qa(i,d,f,m=32){xs(i),ys(m);const b=i.outputLen;if(m>255*b)throw new Error("Length should be <= 255*HashLen");const S=Math.ceil(m/b);f===void 0&&(f=Dr);const k=new Uint8Array(S*b),M=vs.create(i,d),T=M._cloneInto(),U=new Uint8Array(M.outputLen);for(let X=0;X<S;X++)ms[0]=X+1,T.update(X===0?Dr:U).update(f).update(ms).digestInto(U),k.set(U,b*X),M._cloneInto(T);return M.destroy(),T.destroy(),zt(U,ms),k.slice(0,m)}const Ka=(i,d,f,m,b)=>qa(i,Ga(i,d,f),m,b);function Va(i,d,f,m){if(typeof i.setBigUint64=="function")return i.setBigUint64(d,f,m);const b=BigInt(32),S=BigInt(4294967295),k=Number(f>>b&S),M=Number(f&S),T=m?4:0,U=m?0:4;i.setUint32(d+T,k,m),i.setUint32(d+U,M,m)}function Qa(i,d,f){return i&d^~i&f}function Ja(i,d,f){return i&d^i&f^d&f}class Za extends Br{constructor(d,f,m,b){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=d,this.outputLen=f,this.padOffset=m,this.isLE=b,this.buffer=new Uint8Array(d),this.view=gs(this.buffer)}update(d){In(this),d=Ut(d),kn(d);const{view:f,buffer:m,blockLen:b}=this,S=d.length;for(let k=0;k<S;){const M=Math.min(b-this.pos,S-k);if(M===b){const T=gs(d);for(;b<=S-k;k+=b)this.process(T,k);continue}m.set(d.subarray(k,k+M),this.pos),this.pos+=M,k+=M,this.pos===b&&(this.process(f,0),this.pos=0)}return this.length+=d.length,this.roundClean(),this}digestInto(d){In(this),Ya(d,this),this.finished=!0;const{buffer:f,view:m,blockLen:b,isLE:S}=this;let{pos:k}=this;f[k++]=128,zt(this.buffer.subarray(k)),this.padOffset>b-k&&(this.process(m,0),k=0);for(let W=k;W<b;W++)f[W]=0;Va(m,b-8,BigInt(this.length*8),S),this.process(m,0);const M=gs(d),T=this.outputLen;if(T%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const U=T/4,X=this.get();if(U>X.length)throw new Error("_sha2: outputLen bigger than state");for(let W=0;W<U;W++)M.setUint32(4*W,X[W],S)}digest(){const{buffer:d,outputLen:f}=this;this.digestInto(d);const m=d.slice(0,f);return this.destroy(),m}_cloneInto(d){d||(d=new this.constructor),d.set(...this.get());const{blockLen:f,buffer:m,length:b,finished:S,destroyed:k,pos:M}=this;return d.destroyed=k,d.finished=S,d.length=b,d.pos=M,b%f&&d.buffer.set(m),d}clone(){return this._cloneInto()}}const _e=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),eo=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),$e=new Uint32Array(64);class to extends Za{constructor(d=32){super(64,d,8,!1),this.A=_e[0]|0,this.B=_e[1]|0,this.C=_e[2]|0,this.D=_e[3]|0,this.E=_e[4]|0,this.F=_e[5]|0,this.G=_e[6]|0,this.H=_e[7]|0}get(){const{A:d,B:f,C:m,D:b,E:S,F:k,G:M,H:T}=this;return[d,f,m,b,S,k,M,T]}set(d,f,m,b,S,k,M,T){this.A=d|0,this.B=f|0,this.C=m|0,this.D=b|0,this.E=S|0,this.F=k|0,this.G=M|0,this.H=T|0}process(d,f){for(let W=0;W<16;W++,f+=4)$e[W]=d.getUint32(f,!1);for(let W=16;W<64;W++){const ce=$e[W-15],de=$e[W-2],ge=Re(ce,7)^Re(ce,18)^ce>>>3,ze=Re(de,17)^Re(de,19)^de>>>10;$e[W]=ze+$e[W-7]+ge+$e[W-16]|0}let{A:m,B:b,C:S,D:k,E:M,F:T,G:U,H:X}=this;for(let W=0;W<64;W++){const ce=Re(M,6)^Re(M,11)^Re(M,25),de=X+ce+Qa(M,T,U)+eo[W]+$e[W]|0,ze=(Re(m,2)^Re(m,13)^Re(m,22))+Ja(m,b,S)|0;X=U,U=T,T=M,M=k+de|0,k=S,S=b,b=m,m=de+ze|0}m=m+this.A|0,b=b+this.B|0,S=S+this.C|0,k=k+this.D|0,M=M+this.E|0,T=T+this.F|0,U=U+this.G|0,X=X+this.H|0,this.set(m,b,S,k,M,T,U,X)}roundClean(){zt($e)}destroy(){this.set(0,0,0,0,0,0,0,0),zt(this.buffer)}}const no=$a(()=>new to),so=no,ro=new TextEncoder,io=new TextDecoder;function Te(i){if(!i)return new Uint8Array;const d=i.replace(/-/g,"+").replace(/_/g,"/"),f=d.length%4===0?"":"=".repeat(4-d.length%4),m=atob(d+f),b=m.length,S=new Uint8Array(b);for(let k=0;k<b;k+=1)S[k]=m.charCodeAt(k);return S}function Tt(i){let d="";for(let f=0;f<i.length;f+=1)d+=String.fromCharCode(i[f]);return btoa(d).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function Nr(i){return ro.encode(i)}function ao(i){return io.decode(i)}const Tr="eb_e2ee_sessions_v1";class oo{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(d){return!!this.sessions[d]}getSession(d){return this.sessions[d]??null}async ensureSession(d){if(!d.isSecret||d.secretStatus!=="ACTIVE")return null;const f=this.sessions[d.id];if(f)return f;const m=vt(),b=xr();if(!m||!b||!d.secretInitiatorDeviceId||!d.secretPeerDeviceId||!(d.secretInitiatorDeviceId===m.deviceId))return null;const k=d.secretPeerDeviceId;return k?this.createInitiatorSession(d,m.deviceId,k,b):null}processHandshakes(d,f){if(!d.isSecret||!f||f.length===0)return!1;const m=vt();if(!m)return!1;let b=!1;for(const S of f){const M=(S?.metadata??{}).e2ee;if(!M||M.kind!=="handshake")continue;const T=M.payload;if(!T||T.recipientDeviceId!==m.deviceId)continue;const U=this.sessions[d.id];if(U&&U.peerDeviceId===T.initiatorDeviceId&&U.prekeyId===T.prekeyId)continue;this.handlePeerHandshake(d,T)&&(b=!0)}return b&&this.bumpVersion(),b}transformMessage(d,f){if(!f)return f;const m=f.metadata??{},b=m.e2ee;if(!b||b.kind!=="ciphertext")return f;const S=this.sessions[d];if(!S)return{...f,content:"ðŸ” Ð—Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¾",metadata:{...m,e2ee:{...b,decrypted:!1}}};try{const k=Te(S.key),M=Te(b.nonce),T=Te(f.content||""),U=gt.secretbox.open(T,M,k);if(!U)throw new Error("Failed to decrypt");return{...f,content:ao(U),metadata:{...m,e2ee:{...b,decrypted:!0}}}}catch(k){return console.warn("Failed to decrypt message",k),{...f,content:"ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸",metadata:{...m,e2ee:{...b,decrypted:!1,error:!0}}}}}async encryptPayload(d,f){const m=await this.ensureSession(d);if(!m)throw new Error("E2EE session is not ready");const b=Te(m.key),S=gt.randomBytes(24),k=Nr(f.content??""),M=gt.secretbox(k,S,b);return{conversationId:d.id,type:f.type,content:Tt(M),replyToId:f.replyToId,metadata:{...f.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:Tt(S)}}}}async createInitiatorSession(d,f,m,b){try{const S=await z.post("/devices/prekeys/claim",{deviceId:m}),k=S.data?.identityKey,M=S.data?.prekey;if(!k||!M?.publicKey||!M?.keyId)throw new Error("Invalid prekey response");const T=gt.scalarMult(Te(b.secretKey),Te(M.publicKey)),U=gt.randomBytes(32),X=`eblusha:e2ee:${d.id}:${f}->${m}:${M.keyId}`,W=this.deriveKey(T,U,X),ce={conversationId:d.id,key:Tt(W),localDeviceId:f,peerDeviceId:m,role:"initiator",prekeyId:M.keyId,hkdfInfo:X,handshakeSalt:Tt(U),createdAt:Date.now()};return this.sessions[d.id]=ce,this.persist(),await this.sendHandshakeMessage(d.id,{version:1,kind:"handshake",conversationId:d.id,initiatorDeviceId:f,recipientDeviceId:m,prekeyId:M.keyId,handshakeSalt:ce.handshakeSalt,hkdfInfo:X,initiatorIdentityKey:b.publicKey,createdAt:Date.now()}),ce}catch(S){return console.error("Failed to initialize E2EE session",S),delete this.sessions[d.id],this.persist(),null}}handlePeerHandshake(d,f){if(!f?.prekeyId||!f?.initiatorIdentityKey||!f.hkdfInfo||!f.handshakeSalt||!xr())return!1;const b=vt();if(!b)return!1;const S=Bi(f.prekeyId);if(!S)return console.warn("Missing prekey secret for handshake",f.prekeyId),!1;try{const k=gt.scalarMult(Te(S),Te(f.initiatorIdentityKey)),M=this.deriveKey(k,Te(f.handshakeSalt),f.hkdfInfo),T={conversationId:d.id,key:Tt(M),localDeviceId:b.deviceId,peerDeviceId:f.initiatorDeviceId,role:"peer",prekeyId:f.prekeyId,hkdfInfo:f.hkdfInfo,handshakeSalt:f.handshakeSalt,createdAt:Date.now()};return this.sessions[d.id]=T,this.persist(),!0}catch(k){return console.error("Failed to handle handshake payload",k),!1}}async sendHandshakeMessage(d,f){await z.post("/conversations/send",{conversationId:d,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:f}}})}deriveKey(d,f,m){return Ka(so,d,f,Nr(m),32)}clearSession(d){this.sessions[d]&&(delete this.sessions[d],this.persist())}load(){try{const d=localStorage.getItem(Tr);d&&(this.sessions=JSON.parse(d))}catch{this.sessions={}}}persist(){try{localStorage.setItem(Tr,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const xt=new oo,co=c.lazy(()=>ca(()=>import("./CallOverlay-C5Ub4O6t.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(i=>({default:i.CallOverlay}))),zr="eblusha:last-active-conversation";function wo(){const[i,d]=c.useState(null),[f,m]=c.useState(null),[b,S]=c.useState(null),[k,M]=c.useState(""),[T,U]=c.useState(null),X=c.useRef(null),W=c.useRef(null);c.useRef(null);const ce=c.useRef(null),de=c.useRef(null),ge=c.useRef(null),ze=c.useRef(null),Ue=c.useRef(null),G=c.useRef(null),pe=c.useRef(null),Cn=c.useRef(!1),[bs,ws]=c.useState(!1),[lo,Wr]=c.useState(1),[bt,js]=c.useState(!1),En=c.useRef(null);c.useRef({pinTimer:null});const[J,He]=c.useState(()=>({open:!1,x:0,y:0,messageId:null})),[te,Ht]=c.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Ss=c.useRef(null),Is=c.useRef(null),[Or,Bt]=c.useState(!1),[uo,fo]=c.useState(()=>({open:!1,x:0,y:0,messageId:null})),[ks,Pt]=c.useState({open:!1,messageId:null}),[An,Cs]=c.useState(!1),[Wt,Rn]=c.useState([]),[Es,wt]=c.useState(!1),[Ge,Ln]=c.useState("friends"),[As,Mn]=c.useState(["","","",""]),Ot=[c.useRef(null),c.useRef(null),c.useRef(null),c.useRef(null)],[re,jt]=c.useState(null),[Rs,it]=c.useState(null),[Fr,St]=c.useState(!1),Ft=c.useRef(0),[Xr,Yr]=c.useState(!1),[_r,$r]=c.useState(!1),[A,Gr]=c.useState(!1),qe=c.useRef(A),[Dn,je]=c.useState("list");c.useEffect(()=>{qe.current=A},[A]);const[qr,Xt]=c.useState(!1),Nn=c.useRef(null);c.useRef(null);const Yt=c.useRef(new Map),Ke=c.useRef(!0),Ve=c.useRef(!1),_t=c.useRef(0),Tn=c.useRef(null),$t=c.useRef(new Set),It=c.useRef(null);c.useRef(null);const Gt=c.useRef(null),zn=c.useRef(0),[Kr,Ls]=c.useState(!1),[kt,Ms]=c.useState(""),[qt,Ds]=c.useState([]),[Un,Hn]=c.useState(!1),[Ns,Kt]=c.useState(null),[at,Ts]=c.useState(null),[ue,Qe]=c.useState(null),[zs,Us]=c.useState(null),[Vr,Be]=c.useState(!1),Bn=c.useRef(null),Je=c.useRef(null),Qr=c.useRef(null),Pn=c.useRef(null),[Z,Se]=c.useState({x:0,y:0,scale:1}),[Hs,Wn]=c.useState(!1),[Jr,Vt]=c.useState(!1),[On,Zr]=c.useState(["","","",""]),Fn=[c.useRef(null),c.useRef(null),c.useRef(null),c.useRef(null)],[Pe,Xn]=c.useState(null),[ei,Yn]=c.useState(!1),[_n,ti]=c.useState(""),[ni,Qt]=c.useState(!1),[ot,Jt]=c.useState(!1),[$n,Zt]=c.useState(null),[me,en]=c.useState(null),tn=c.useRef(null),[Y,We]=c.useState({x:0,y:0,scale:1}),[Bs,nn]=c.useState(0),Ze=c.useRef(null),Gn=c.useRef(null),Ps=c.useRef(null),ie=c.useRef(null),et=c.useRef(null),Oe=c.useRef(null),sn=c.useRef(null),ae=c.useRef(null),tt=c.useRef(null),rn=c.useRef(null),Ws=c.useRef(null),[_,Ie]=c.useState({x:0,y:0,scale:1}),[ye,an]=c.useState(null),[on,cn]=c.useState(null),[Os,qn]=c.useState(!1),[Fs,Kn]=c.useState(!1),[ln,ct]=c.useState(null),[nt,Fe]=c.useState({open:!1,index:0,items:[]}),[si,Vn]=c.useState(1),[ri,Xs]=c.useState(!1),[ii,Qn]=c.useState(0),[ho,Jn]=c.useState(!1),[Ys,Ct]=c.useState({}),[fe,st]=c.useState(null),[dn,_s]=c.useState(0),$s=c.useRef(null);c.useEffect(()=>{$s.current=i},[i]);const Gs=c.useRef(null);c.useEffect(()=>{Gs.current=fe},[fe]);const qs=yt({queryKey:["my-devices"],queryFn:async()=>(await z.get("/devices")).data.devices}),[po,Ks]=c.useState(null),[ai,un]=c.useState(()=>K.connected),[oi,Vs]=c.useState(null),[ci,li]=c.useState({}),[di,ui]=c.useState({}),[fi,Et]=c.useState(!1),[Qs,At]=c.useState({}),[Js,Zs]=c.useState(!1),[Zn,fn]=c.useState(!1),er=c.useRef(null),C=mt(e=>e.session?.user),H=ps(),D=la(),hn=c.useMemo(()=>i?Ys[i]||[]:[],[i,Ys]);c.useRef(null),c.useRef(null);const[Xe,xe]=c.useState({}),[hi,pi]=c.useState(0),tr=c.useRef(null);c.useEffect(()=>{tr.current=f},[f]);const gi=c.useRef({});c.useEffect(()=>{const e=window.setInterval(()=>pi(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(e)},[]),c.useEffect(()=>{const e=()=>{const n=window.innerWidth<=768;Gr(n),qe.current=n,n?i||je("list"):je("conversation")};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[i]),c.useEffect(()=>{A&&je(i?"conversation":"list")},[A,i]),c.useEffect(()=>{const e=s=>{console.log("[CallStatus] Single:",s),xe(r=>{const o=D.getQueryData(["conversations"]),a=Array.isArray(o)?o.find(y=>y.conversation.id===s.conversationId)?.conversation:null,l=r[s.conversationId],p=ps.getState().activeConvId;if(!(!!(a&&(a.isGroup||(a.participants?.length??0)>2))||!!l&&(l.participants?l.participants.length>1:!0)||p===s.conversationId))return r;const h=s.participants||[];if(s.active){const y=typeof s.startedAt=="number"&&s.startedAt>0?s.startedAt:l?.startedAt??Date.now();return{...r,[s.conversationId]:{active:!0,startedAt:y,participants:h,endedAt:null,elapsedMs:typeof s.elapsedMs=="number"?s.elapsedMs:void 0}}}const x=l?.active?Date.now():l?.endedAt??null;return{...r,[s.conversationId]:{active:!1,startedAt:l?.startedAt??null,endedAt:x,participants:[],elapsedMs:void 0}}})},n=s=>{console.log("[CallStatus] Bulk:",s),xe(r=>{const o={...r},a=D.getQueryData(["conversations"]);for(const[l,p]of Object.entries(s.statuses||{})){const u=Array.isArray(a)?a.find(v=>v.conversation.id===l)?.conversation:null,h=r[l],x=ps.getState().activeConvId;if(!(!!(u&&(u.isGroup||(u.participants?.length??0)>2))||!!h&&(h.participants?h.participants.length>1:!0)||x===l))continue;const g=p.participants||[];if(p.active){const v=typeof p.startedAt=="number"&&p.startedAt>0?p.startedAt:h?.startedAt??Date.now();o[l]={active:!0,startedAt:v,participants:g,endedAt:null,elapsedMs:typeof p.elapsedMs=="number"?p.elapsedMs:void 0};continue}const j=h?.active?Date.now():h?.endedAt??null;o[l]={active:!1,startedAt:h?.startedAt??null,endedAt:j,participants:[],elapsedMs:void 0}}return o})};return Pi(e),Wi(n),()=>{K.off("call:status",e),K.off("call:status:bulk",n)}},[]),c.useEffect(()=>{if(!J.open)return;const e=er.current;if(!e)return;const n=window.innerWidth,s=window.visualViewport?window.visualViewport.height:window.innerHeight,r=e.getBoundingClientRect();let o=J.x,a=J.y;o+r.width>n-8&&(o=Math.max(8,n-r.width-8)),a+r.height>s-8&&(a=Math.max(8,s-r.height-8)),(o!==J.x||a!==J.y)&&He(l=>({...l,x:o,y:a}))},[J.open,J.x,J.y]),c.useEffect(()=>{if(!te.open)return;const e=Ss.current;if(!e)return;const n=window.innerWidth,s=window.visualViewport?window.visualViewport.height:window.innerHeight,r=e.getBoundingClientRect();let o=te.x,a=te.y;o+r.width>n-8&&(o=Math.max(8,n-r.width-8)),a+r.height>s-8&&(a=Math.max(8,s-r.height-8)),(o!==te.x||a!==te.y)&&Ht(l=>({...l,x:o,y:a}))},[te.open,te.x,te.y]);function lt(e){d(n=>{try{n&&n!==e&&(B.data||[]).find(o=>o.conversation.id===n)?.conversation?.isSecret&&D.removeQueries({queryKey:["messages",n]})}catch{}return e}),A&&je("conversation"),fe&&(URL.revokeObjectURL(fe.preview),st(null))}async function nr(){let e=vt();return e||(e=await ia()),e||null}async function sr(e){if(Js)return;Zs(!0);const n=2;let s=0;const r=async()=>{if(s>=n)throw new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");s+=1,await ra()};try{for(;;){const o=await nr();if(!o){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}try{const a={participantIds:[e],isGroup:!1,isSecret:!0,initiatorDeviceId:o.deviceId};console.log("[SecretChat] Creating with payload:",a),await z.post("/conversations",a),D.invalidateQueries({queryKey:["conversations"]});return}catch(a){console.error("[SecretChat] Creation error:",a?.response?.data||a);const l=a?.response?.data?.message,p=a?.response?.data?.errors;if(p&&console.error("[SecretChat] Validation errors:",p),a?.response?.status===400&&typeof l=="string"&&l.toLowerCase().includes("invalid initiator device")){await r();continue}const h=p?`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸: ${p.map(x=>`${x.path.join(".")}: ${x.message}`).join(", ")}`:l||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";throw new Error(h)}}}catch(o){console.error("Failed to start secret conversation:",o);const a=o?.message||o?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";alert(a)}finally{Zs(!1)}}const rr=async e=>{fn(!0);try{aa(e),At(n=>{const s={...n};return delete s[e],s}),D.invalidateQueries({queryKey:["conversations"]})}finally{fn(!1)}},mi=async e=>{fn(!0);try{const n=await nr();if(!n){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}oa(e,n.deviceId),D.invalidateQueries({queryKey:["conversations"]}),lt(e)}catch(n){console.error("Failed to accept secret chat:",n),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚")}finally{fn(!1)}};async function ir(e,n){if(e){if(e.isSecret){const s=await xt.encryptPayload(e,n);await z.post("/conversations/send",s);return}await z.post("/conversations/send",{conversationId:e.id,...n})}}const dt=()=>{Cs(!1),Rn([]),wt(!1),Ln("friends"),Mn(["","","",""]),jt(null),it(null),St(!1)},yi=async()=>{if(!i||Wt.length===0){dt();return}wt(!0);try{await z.post(`/conversations/${i}/participants`,{participantIds:Wt}),D.invalidateQueries({queryKey:["conversations"]}),B.refetch(),dt()}catch(e){console.error("Error adding participants:",e),alert(e.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")}finally{wt(!1)}},xi=async()=>{if(!(!i||!re)){wt(!0);try{await z.post(`/conversations/${i}/participants`,{participantIds:[re.id]}),D.invalidateQueries({queryKey:["conversations"]}),B.refetch(),dt()}catch(e){console.error("Error adding participant by EBLID:",e),alert(e.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°")}finally{wt(!1)}}},vi=(e,n)=>{if(!/^\d?$/.test(n))return;const s=[...As];s[e]=n,Mn(s),n&&e<3&&Ot[e+1].current?.focus(),!n&&e>0&&Ot[e-1].current?.focus();const r=s.join("");if(r.length===4&&/^\d{4}$/.test(r)){const o=Date.now();Ft.current=o,St(!0),it(null),z.get("/contacts/search",{params:{query:r}}).then(a=>{if(Ft.current!==o)return;const l=a.data.results?.[0]??null;jt(l),it(l?null:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")}).catch(()=>{Ft.current===o&&(jt(null),it("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº"))}).finally(()=>{Ft.current===o&&St(!1)})}else jt(null),it(null),St(!1)};function bi(){if(A){if(i)try{(B.data||[]).find(s=>s.conversation.id===i)?.conversation?.isSecret&&D.removeQueries({queryKey:["messages",i]})}catch{}je("list"),d(null),Xt(!1)}fe&&(URL.revokeObjectURL(fe.preview),st(null))}const be=yt({queryKey:["me-info"],queryFn:async()=>(await z.get("/status/me")).data.user}),B=yt({queryKey:["conversations"],queryFn:async()=>(await z.get("/conversations")).data.conversations}),$=yt({queryKey:["messages",i],enabled:!!i,queryFn:async()=>(await z.get(`/conversations/${i}/messages`)).data.messages,refetchInterval:i?15e3:!1});c.useEffect(()=>{$.error?.response?.status===403&&i&&(console.warn("[ChatsPage] Lost access to conversation, closing view",i),D.removeQueries({queryKey:["messages",i]}),d(null))},[$.error,i,D]);const he=yt({queryKey:["accepted-contacts"],queryFn:async()=>(await z.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),ve=yt({queryKey:["incoming-contacts"],queryFn:async()=>(await z.get("/contacts",{params:{filter:"incoming"}})).data.contacts});c.useEffect(()=>{if(i&&!(typeof window>"u"))try{window.localStorage.setItem(zr,i)}catch{}},[i]),c.useEffect(()=>{if(typeof window>"u"||i)return;const e=B.data;if(!(!e||e.length===0)&&!(qe.current&&Dn!=="conversation"))try{const n=window.localStorage.getItem(zr);if(!n)return;e.some(r=>r?.conversation?.id===n)&&lt(n)}catch{}},[i,B.data,Dn]);const es=()=>{if(Ls(!1),Ms(""),Ds([]),Hn(!1),at)try{URL.revokeObjectURL(at)}catch{}if(Ts(null),ue)try{URL.revokeObjectURL(ue)}catch{}Qe(null),Kt(null),Us(null),Se({x:0,y:0,scale:1}),Be(!1)};c.useEffect(()=>{const e=Is.current;if(!e)return;const n=()=>{const{scrollTop:s,scrollHeight:r,clientHeight:o}=e,a=s>2,l=r-s-o>2;Yr(a),$r(l)};return n(),e.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{e.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[B.data?.length]),c.useEffect(()=>{try{const e=(B.data||[]).map(n=>n.conversation.id);console.log("[CallStatus] Requesting statuses for:",e),e.length>0&&vr(e);for(const n of e)try{br(n)}catch{}}catch{}},[B.data]);const w=c.useMemo(()=>B.data?.find(e=>e.conversation.id===i)?.conversation,[B.data,i]),Rt=c.useMemo(()=>vt()?.deviceId??null,[dn]),pn=c.useMemo(()=>{const e={};for(const n of qs.data||[])e[n.id]=n;return e},[qs.data]),gn=c.useCallback(e=>{if(!e?.isSecret)return null;const n=[e.secretInitiatorDeviceId,e.secretPeerDeviceId];for(const s of n){if(!s)continue;const r=pn[s];if(r?.userId&&C?.id&&r.userId===C.id)return s}if(C?.id){if(e.createdById===C.id&&e.secretInitiatorDeviceId)return e.secretInitiatorDeviceId;if(e.createdById!==C.id&&e.secretPeerDeviceId)return e.secretPeerDeviceId}return null},[pn,C?.id]),ut=c.useMemo(()=>gn(w),[w,gn]),ar=c.useMemo(()=>{if(!ut)return;const e=pn[ut]?.name;if(e&&e.trim())return e;const n=vt();if(n&&n.deviceId===ut&&n.name)return n.name},[ut,pn,dn]),or=c.useCallback(e=>{if(!e)return!1;const n=(B.data||[]).find(r=>r?.conversation?.id===e)?.conversation;if(!n?.isSecret)return!1;const s=gn(n);return!!(s&&Rt&&s!==Rt)},[B.data,Rt,gn]),cr=!!(w?.isSecret&&(w.secretStatus??"ACTIVE")!=="ACTIVE"),lr=c.useMemo(()=>w?.isSecret?xt.hasSession(w.id):!0,[w?.id,w?.isSecret,dn]),ts=!!(w?.isSecret&&!cr&&!lr&&ut&&Rt&&ut!==Rt),wi=ts?"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð²ÐµÐ·Ð´Ðµ":"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ",ji=ts?"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð²ÐµÐ·Ð´Ðµ":"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";c.useEffect(()=>{if(!w?.isSecret||w.secretStatus!=="ACTIVE")return;let e=!1;return xt.ensureSession(w).then(n=>{!e&&n&&_s(s=>(s+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{e=!0}},[w?.id,w?.secretStatus,w?.isSecret]),c.useEffect(()=>{if(!w?.isSecret||!$.data||$.data.length===0)return;xt.processHandshakes(w,$.data)&&_s(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[$.data,w?.id,w?.isSecret,w?.secretStatus]);const ke=c.useMemo(()=>$.data?w?.isSecret?$.data.filter(e=>{const s=(e?.metadata??{}).e2ee;return!(s&&s.kind==="handshake")}).map(e=>xt.transformMessage(w.id,e)):$.data:[],[$.data,w?.id,w?.isSecret,dn]);c.useEffect(()=>{const e=new Set((B.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));At(n=>{let s=!1;const r={...n};for(const o of Object.keys(r))e.has(o)||(delete r[o],s=!0);return s?r:n})},[B.data]);const ft=c.useMemo(()=>{if(!w||w.isGroup||w.isSecret||!C?.id)return null;const e=Ur(w.participants||[]);if(!e)return null;const n=B.data||[];for(const s of n){const r=s.conversation;if(!r?.isSecret||(r.secretStatus??"ACTIVE")!=="PENDING"||Ur(r.participants||[])!==e)continue;const a=(r.participants||[]).find(p=>p.user.id===r.createdById)?.user,l=Qs[r.id]?.from?.name??a?.displayName??a?.username??"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº";return{conversationId:r.id,isInitiator:r.createdById===C.id,initiatorName:l}}return null},[w,B.data,C?.id,Qs]);c.useEffect(()=>{if(f&&i){try{const n=(B.data||[]).find(r=>r.conversation.id===i)?.conversation;if(!!(n&&(n.isGroup||(n.participants?.length??0)>2)))return}catch{}const e=Xe[i];e&&(!e.active||e.endedAt)&&f===i&&(m(null),S(null),H.endCall())}},[f,i,Xe,hi,B.data]);const dr=c.useMemo(()=>{const e={};if(w)for(const n of w.participants)e[n.user.id]=n.user;return C&&!e[C.id]&&(e[C.id]=C),e},[w,C]),ns=c.useMemo(()=>w?(w.participants||[]).map(e=>e.user.id):[],[w]),ur=c.useMemo(()=>{if(!w||!he.data)return[];const e=new Set(ns);return he.data.filter(n=>!e.has(n.friend.id))},[w,he.data,ns]),mn={alreadyInChat:re?ns.includes(re.id):!1,isSelf:re?re.id===C?.id:!1};c.useEffect(()=>{An&&Ge==="eblid"&&Ot[0].current?.focus()},[An,Ge]),c.useEffect(()=>{const e=n=>{D.setQueryData(["conversations"],s=>s&&s.map(r=>({...r,conversation:{...r.conversation,participants:r.conversation.participants.map(a=>a.user.id===n.userId?{...a,user:{...a.user,status:n.status,lastSeenAt:n.status==="ONLINE"?new Date().toISOString():n.status==="OFFLINE"?new Date().toISOString():a.user.lastSeenAt}}:a)}})))};return wr(e),()=>{K.off("presence:update",e)}},[D]),c.useEffect(()=>{const e=()=>{try{const o=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",o+"px")}catch{}D.invalidateQueries({queryKey:["me-info"]}),un(K.connected)};window.addEventListener("focus",e);const n=()=>{un(!0);try{const o=(B.data||[]).map(a=>a.conversation.id);for(const a of o)try{br(a)}catch{}o.length>0&&vr(o)}catch{}},s=()=>un(!1);K.on("connect",n),K.on("disconnect",s),un(K.connected);const r=()=>{D.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",r),()=>{K.off("connect",n),K.off("disconnect",s),document.removeEventListener("visibilitychange",r),window.removeEventListener("focus",e)}},[D]),c.useEffect(()=>{const e=n=>{if(C?.id&&n.userId===C.id){const s=(n.status||"").toUpperCase();(s==="ONLINE"||s==="AWAY"||s==="OFFLINE")&&Vs(s)}};return wr(e),()=>{K.off("presence:update",e)}},[C?.id]),c.useEffect(()=>{const e=(be.data?.status||"").toString().toUpperCase();(e==="ONLINE"||e==="AWAY"||e==="OFFLINE")&&Vs(e)},[be.data]),c.useEffect(()=>{if(!nt.open)return;const e=n=>{n.key==="Escape"&&Fe(s=>({...s,open:!1})),n.key==="ArrowLeft"&&Fe(s=>({...s,index:(s.index-1+s.items.length)%s.items.length})),n.key==="ArrowRight"&&Fe(s=>({...s,index:(s.index+1)%s.items.length}))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[nt.open]),c.useEffect(()=>{const e=n=>{D.setQueryData(["conversations"],s=>s&&s.map(r=>({...r,conversation:{...r.conversation,participants:r.conversation.participants.map(o=>o.user.id===n.userId?{...o,user:{...o.user,avatarUrl:n.avatarUrl??o.user.avatarUrl,displayName:n.displayName??o.user.displayName}}:o)}}))),n.userId===C?.id&&be.refetch()};return Oi(e),()=>{K.off("profile:update",e)}},[D,C?.id]);function Si(e){return"#191d23"}c.useEffect(()=>{if(!i)return;const e=async n=>{const s=n.target;if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return;const r=n.clipboardData?.items;if(!r)return;let o=!1;for(let a=0;a<r.length;a++)if(r[a].type.indexOf("image")!==-1){o=!0;break}if(o)for(let a=0;a<r.length;a++){const l=r[a];if(l.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const p=l.getAsFile();if(p){const u=URL.createObjectURL(p);st({file:p,preview:u})}break}}};return window.addEventListener("paste",e,!0),()=>{window.removeEventListener("paste",e,!0)}},[i]),c.useEffect(()=>{B.refetch(),Fi(),Xi(()=>B.refetch()),Yi(s=>{const r=s?.conversationId;if(!r){B.refetch();return}if(At(a=>{if(!a[r])return a;const l={...a};return delete l[r],l}),Ct(a=>{if(!a[r])return a;const l={...a};return delete l[r],l}),xt.clearSession(r),D.removeQueries({queryKey:["messages",r]}),D.setQueryData(["conversations"],a=>Array.isArray(a)?a.filter(l=>l?.conversation?.id!==r):a),$s.current===r){d(l=>l===r?null:l),Xt(!1);const a=Gs.current;a&&(URL.revokeObjectURL(a.preview),st(null)),qe.current&&je("list")}B.refetch()}),_i(()=>{B.refetch()}),$i(()=>{B.refetch()});const e=Gi(s=>{At(r=>({...r,[s.conversationId]:s})),B.refetch()}),n=qi(s=>{At(r=>{const o={...r};return delete o[s.conversationId],o}),D.invalidateQueries({queryKey:["conversations"]}),lt(s.conversationId)});Ki(({conversationId:s,from:r,video:o})=>{if(ze.current&&ze.current===s)return;Ce();try{const l=D.getQueryData(["conversations"]),p=Array.isArray(l)?l.find(x=>x.conversation.id===s)?.conversation:null,u=!!(p&&(p.isGroup||(p.participants?.length??0)>2));gi.current[s]=r.id;const h=tr.current===s;if(u||h)return}catch{}ze.current=s,H.startIncoming({conversationId:s,from:r,video:o});let a=!1;try{Ue.current=new Audio("/ring.mp3"),Ue.current.loop=!0,Ue.current.volume=.9,Ue.current.play().then(()=>{a=!0}).catch(()=>{})}catch{}ge.current=window.setTimeout(()=>{Cr(s),Ce(),H.setIncoming(null)},25e3)}),Vi(({conversationId:s})=>{xe(r=>r[s]?.active?r:{...r,[s]:{startedAt:Date.now(),active:!0,participants:[C?.id||""].filter(Boolean)}}),m(s),S(r=>r===s?null:r),Ce()}),Qi(({conversationId:s})=>{xe(r=>{const o=r[s];if(o){if(o.active)return{...r,[s]:{...o,active:!1,endedAt:Date.now()}};const{[s]:a,...l}=r;return l}return r}),f===s&&(m(null),S(null),H.endCall()),H.setIncoming(null),Ce()}),Ji(({conversationId:s})=>{try{const r=D.getQueryData(["conversations"]),o=Array.isArray(r)?r.find(l=>l.conversation.id===s)?.conversation:null;if(!!(o&&(o.isGroup||(o.participants?.length??0)>2)))return}catch{}xe(r=>{const o=r[s];if(o?.active)return{...r,[s]:{...o,active:!1,endedAt:Date.now()}};const{[s]:a,...l}=r;return l}),f===s&&(m(null),S(null),H.endCall()),H.setIncoming(null),Ce()}),Zi(({conversationId:s})=>{D.invalidateQueries({queryKey:["messages",s]}),D.refetchQueries({queryKey:["messages",s]})});try{pe.current||(pe.current=new Audio("/notify.mp3"),pe.current.preload="auto",pe.current.volume=.9);const s=async()=>{if(!(!pe.current||Cn.current))try{pe.current.volume=0,await pe.current.play(),pe.current.pause(),pe.current.currentTime=0,pe.current.volume=.9,Cn.current=!0,window.removeEventListener("click",s),window.removeEventListener("keydown",s),window.removeEventListener("touchstart",s)}catch{}};window.addEventListener("click",s),window.addEventListener("keydown",s),window.addEventListener("touchstart",s)}catch{}return()=>{e?.(),n?.()}},[]),c.useEffect(()=>{ea(()=>{ve.refetch()}),ta(()=>{he.refetch(),B.refetch(),ve.refetch()}),na(()=>{he.refetch(),ve.refetch()})},[]),c.useEffect(()=>{if(!me)return;const e=Ze.current;if(!e)return;const n=(u,h)=>{const x=h.clientX-u.clientX,y=h.clientY-u.clientY;return Math.sqrt(x*x+y*y)},s=(u,h)=>({x:(u.clientX+h.clientX)/2,y:(u.clientY+h.clientY)/2}),r=240,o=(u,h,x,y,g)=>{const j=u-x,v=h-y;return j*j+v*v<=g*g},a=u=>{const h=e.getBoundingClientRect();if(!h)return;const x=h.width,y=h.height,g=x/2,j=y/2,v=r/2;if(u.touches.length===1){const I=u.touches[0],R=I.clientX-h.left,L=I.clientY-h.top;if(!o(R,L,g,j,v))return;ie.current={touches:[I],initialDistance:0,initialScale:Y.scale,initialX:Y.x,initialY:Y.y},u.preventDefault()}else if(u.touches.length===2){const I=u.touches[0],R=u.touches[1],L=s(I,R),N=L.x-h.left,O=L.y-h.top;if(!o(N,O,g,j,v))return;const P=n(I,R);ie.current={touches:[I,R],initialDistance:P,initialScale:Y.scale,initialX:Y.x,initialY:Y.y},u.preventDefault()}},l=u=>{ie.current&&(u.preventDefault(),et.current!==null&&cancelAnimationFrame(et.current),et.current=requestAnimationFrame(()=>{if(!ie.current)return;const h=e.getBoundingClientRect();if(!h)return;const x=h.width,y=h.height,g=x/2,j=y/2,v=u.touches.length,I=ie.current.touches.length;if(v===1&&I===1){const R=u.touches[0],L=ie.current.touches[0],N=R.clientX-L.clientX,O=R.clientY-L.clientY;We(P=>{let q=ie.current.initialX+N,V=ie.current.initialY+O;const Q=Gn.current;if(Q){const ne=P.scale,oe=Q.naturalWidth*ne,Le=Q.naturalHeight*ne,Ee=g+r/2,we=g-r/2-oe,Me=j+r/2,De=j-r/2-Le;q=Math.max(we,Math.min(Ee,q)),V=Math.max(De,Math.min(Me,V))}return{...P,x:q,y:V}})}else if(v===2&&I===2){const R=u.touches[0],L=u.touches[1],O=n(R,L)/ie.current.initialDistance,P=Math.max(.1,Math.min(10,ie.current.initialScale*O)),q=Gn.current;if(q){const V=q.naturalWidth,Q=q.naturalHeight,ne=ie.current.initialX+V*ie.current.initialScale/2,oe=ie.current.initialY+Q*ie.current.initialScale/2,Le=ne-g,Ee=oe-j,we=P/ie.current.initialScale,Me=g+Le*we,De=j+Ee*we,Lt=Me-V*P/2,Mt=De-Q*P/2;We({x:Lt,y:Mt,scale:P})}}et.current=null}))},p=()=>{et.current!==null&&(cancelAnimationFrame(et.current),et.current=null),ie.current=null};return e.addEventListener("touchstart",a,{passive:!1}),e.addEventListener("touchmove",l,{passive:!1}),e.addEventListener("touchend",p,{passive:!0}),e.addEventListener("touchcancel",p,{passive:!0}),()=>{e.removeEventListener("touchstart",a),e.removeEventListener("touchmove",l),e.removeEventListener("touchend",p),e.removeEventListener("touchcancel",p)}},[me,Y.scale,Y.x,Y.y]),c.useEffect(()=>{if(!ye)return;const e=Oe.current;if(!e)return;const n=(u,h)=>{const x=h.clientX-u.clientX,y=h.clientY-u.clientY;return Math.sqrt(x*x+y*y)},s=(u,h)=>({x:(u.clientX+h.clientX)/2,y:(u.clientY+h.clientY)/2}),r=240,o=(u,h,x,y,g)=>{const j=u-x,v=h-y;return j*j+v*v<=g*g},a=u=>{const h=e.getBoundingClientRect();if(!h)return;const x=h.width,y=h.height,g=x/2,j=y/2,v=r/2;if(u.touches.length===1){const I=u.touches[0],R=I.clientX-h.left,L=I.clientY-h.top;if(!o(R,L,g,j,v))return;ae.current={touches:[I],initialDistance:0,initialScale:_.scale,initialX:_.x,initialY:_.y},u.preventDefault()}else if(u.touches.length===2){const I=u.touches[0],R=u.touches[1],L=s(I,R),N=L.x-h.left,O=L.y-h.top;if(!o(N,O,g,j,v))return;const P=n(I,R);ae.current={touches:[I,R],initialDistance:P,initialScale:_.scale,initialX:_.x,initialY:_.y},u.preventDefault()}},l=u=>{ae.current&&(u.preventDefault(),tt.current!==null&&cancelAnimationFrame(tt.current),tt.current=requestAnimationFrame(()=>{if(!ae.current)return;const h=e.getBoundingClientRect();if(!h)return;const x=h.width,y=h.height,g=x/2,j=y/2,v=u.touches.length,I=ae.current.touches.length;if(v===1&&I===1){const R=u.touches[0],L=ae.current.touches[0],N=R.clientX-L.clientX,O=R.clientY-L.clientY;Ie(P=>{let q=ae.current.initialX+N,V=ae.current.initialY+O;const Q=sn.current;if(Q){const ne=P.scale,oe=Q.naturalWidth*ne,Le=Q.naturalHeight*ne,Ee=g+r/2,we=g-r/2-oe,Me=j+r/2,De=j-r/2-Le;q=Math.max(we,Math.min(Ee,q)),V=Math.max(De,Math.min(Me,V))}return{...P,x:q,y:V}})}else if(v===2&&I===2){const R=u.touches[0],L=u.touches[1],O=n(R,L)/ae.current.initialDistance,P=Math.max(.1,Math.min(10,ae.current.initialScale*O)),q=sn.current;if(q){const V=q.naturalWidth,Q=q.naturalHeight,ne=ae.current.initialX+V*ae.current.initialScale/2,oe=ae.current.initialY+Q*ae.current.initialScale/2,Le=ne-g,Ee=oe-j,we=P/ae.current.initialScale,Me=g+Le*we,De=j+Ee*we,Lt=Me-V*P/2,Mt=De-Q*P/2;Ie({x:Lt,y:Mt,scale:P})}}tt.current=null}))},p=()=>{tt.current!==null&&(cancelAnimationFrame(tt.current),tt.current=null),ae.current=null};return e.addEventListener("touchstart",a,{passive:!1}),e.addEventListener("touchmove",l,{passive:!1}),e.addEventListener("touchend",p,{passive:!0}),e.addEventListener("touchcancel",p,{passive:!0}),()=>{e.removeEventListener("touchstart",a),e.removeEventListener("touchmove",l),e.removeEventListener("touchend",p),e.removeEventListener("touchcancel",p)}},[ye,_.scale,_.x,_.y]);function Ce(){try{if(ge.current&&clearTimeout(ge.current),ge.current=null,Ue.current){try{Ue.current.pause(),Ue.current.currentTime=0}catch{}Ue.current=null}ce.current?.stop(),ce.current?.disconnect(),de.current?.disconnect(),ce.current=null,de.current=null,ze.current=null}catch{}}c.useEffect(()=>{const e=async r=>{if(!(r.conversationId===i)){D.invalidateQueries({queryKey:["conversations"]});return}if(!i)return;const l=r.message??r;l&&l.id&&(Ct(p=>{const u=p[i]||[];if(u.length===0)return p;const h=(l.attachments||[]).map(y=>y.url).sort(),x=u.filter(y=>{if(y.senderId!==l.senderId)return!0;const g=y.attachments.map(j=>j.url).sort();return g.length===h.length?!g.every((v,I)=>{const R=h[I];return v===R||v.startsWith("blob:")&&R&&!R.startsWith("blob:")}):!0});if(x.length===u.length)return p;if(x.length===0){const{[i]:y,...g}=p;return g}return{...p,[i]:x}}),pr(i,l)),$.refetch()},n=r=>{r.conversationId===i&&(ws(!0),En.current&&window.clearTimeout(En.current),En.current=window.setTimeout(()=>ws(!1),2e3))},s=r=>{if(!i||r.conversationId!==i){D.invalidateQueries({queryKey:["conversations"]});return}r.message?Ri(i,r.message):$.refetch()};return K.on("message:new",e),K.on("conversation:typing",n),K.on("message:reaction",s),()=>{K.off("message:new",e),K.off("conversation:typing",n),K.off("message:reaction",s)}},[i]),c.useEffect(()=>{const e=async n=>{if(or(n.conversationId))return;const s=n.senderId===C?.id,r=n.conversationId===i,o=document.visibilityState==="visible";if(!s&&(!r||!o)&&pe.current&&Cn.current&&(pe.current.currentTime=0,pe.current.play().catch(()=>{})),r){n.message&&n.message.id&&pr(i,n.message),$.refetch().catch(()=>{});return}};return K.on("message:notify",e),()=>{K.off("message:notify",e)}},[i,C?.id,$,or]),c.useLayoutEffect(()=>{if(!i){Tn.current=null,_t.current=0;return}Tn.current!==i&&(Tn.current=i,_t.current=0);const e=(ke?.length??0)+hn.length,n=_t.current;if(_t.current=e,!G.current||e===0||e<=n)return;const s=[...ke||[],...hn],r=s[s.length-1],o=r?.senderId&&C?.id?r.senderId===C.id:!1;(o||!Ve.current||Ke.current)&&requestAnimationFrame(()=>{const l=G.current;l&&(l.scrollTop=l.scrollHeight,Ke.current=!0,o&&(Ve.current=!1))})},[i,hn,ke,C?.id]),c.useEffect(()=>{if(!i)return;const e=G.current;if(!e)return;const n=()=>{e&&(e.scrollTop=e.scrollHeight,Ke.current=!0,Ve.current=!1)};if(qe.current){n();const s=window.setTimeout(n,50),r=window.setTimeout(n,200);return()=>{window.clearTimeout(s),window.clearTimeout(r)}}n()},[i]),c.useEffect(()=>{if(!qe.current)return;const e=G.current;if(!e)return;const n=()=>{const s=typeof document<"u"?document.activeElement:null;s&&s===X.current&&(e.scrollTop=e.scrollHeight,Ke.current=!0,Ve.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[i]),c.useEffect(()=>{},[]),c.useEffect(()=>{if(!bs||!qe.current)return;const e=G.current,n=window.setInterval(()=>{Wr(s=>s%3+1),e&&e.scrollHeight-e.scrollTop-e.clientHeight<80&&(e.scrollTop=e.scrollHeight)},500);return()=>window.clearInterval(n)},[bs]),c.useEffect(()=>{const e=G.current;if(!e)return;let n=0,s=e.scrollTop;const r=()=>{n&&cancelAnimationFrame(n);const o=e.scrollTop;Math.abs(o-s)>1&&(Ve.current=!0),n=requestAnimationFrame(()=>{const l=e.scrollHeight-e.scrollTop-e.clientHeight<8;Ke.current=l,Xt(!l),l&&window.setTimeout(()=>{e.scrollHeight-e.scrollTop-e.clientHeight<40&&(Ve.current=!1)},100),s=e.scrollTop})};return e.addEventListener("scroll",r,{passive:!0}),r(),()=>{e.removeEventListener("scroll",r),n&&cancelAnimationFrame(n)}},[i]),c.useEffect(()=>{const e=()=>{if(!G.current)return;const n=G.current.clientWidth;js(n>=900)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[i]);function Ii(e,n){if(!/^\d?$/.test(n))return;const s=[...On];s[e]=n,Zr(s),n&&e<3&&Fn[e+1].current?.focus(),!n&&e>0&&Fn[e-1].current?.focus();const r=s.join("");r.length===4&&/^\d{4}$/.test(r)?(async()=>{try{const o=await z.get("/contacts/search",{params:{query:r}});Xn(o.data.results?.[0]??null)}catch{Xn(null)}})():Xn(null)}async function ki(){Vt(!0);try{const e=await z.get("/status/me");ti(e.data.user?.eblid??"")}catch{}}async function Ci(){const e=On.join("");if(/^\d{4}$/.test(e)){Yn(!0);try{await z.post("/contacts/add",{identifier:e}),Yn(!1)}catch{Yn(!1)}}}function yn(){if(!i||!$.data||!C?.id)return;const e=$.data.filter(n=>n.senderId!==C.id).filter(n=>!(n.receipts||[]).some(s=>s.userId===C.id&&(s.status==="READ"||s.status==="SEEN"))).map(n=>n.id);e.length!==0&&z.post("/messages/receipts",{messageIds:e,status:"READ"}).then(()=>{D.invalidateQueries({queryKey:["messages",i]})}).catch(()=>{})}c.useEffect(()=>{document.hasFocus()&&yn(),i&&(z.post("/messages/mark-conversation-read",{conversationId:i}).catch(()=>{}),D.setQueryData(["conversations"],e=>e&&e.map(n=>n.conversation.id===i?{...n,unreadCount:0}:n)))},[i]),c.useEffect(()=>{document.hasFocus()&&yn()},[$.data]),c.useEffect(()=>{const e=()=>yn(),n=()=>{document.visibilityState==="visible"&&yn()};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",n)}},[i,$.data]);function Ei(){It.current||(It.current=window.setTimeout(()=>{const e=Array.from($t.current);$t.current.clear(),It.current&&clearTimeout(It.current),It.current=null,e.length&&z.post("/messages/receipts",{messageIds:e,status:"READ"}).then(()=>{i&&D.invalidateQueries({queryKey:["messages",i]})}).catch(()=>{})},250))}c.useEffect(()=>{if(!i||!$.data||!C?.id)return;Nn.current?.disconnect();const e=new IntersectionObserver(n=>{for(const s of n){if(!s.isIntersecting||s.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const r=s.target,o=r.dataset.mid;if(!o)continue;const a=$.data.find(p=>p.id===o);!a||a.senderId===C.id||(a.receipts||[]).some(p=>p.userId===C.id&&(p.status==="READ"||p.status==="SEEN"))||($t.current.add(o),e.unobserve(r))}$t.current.size&&Ei()},{root:G.current,threshold:[.25]});Nn.current=e;for(const n of $.data){if(n.senderId===C.id||(n.receipts||[]).some(o=>o.userId===C.id&&(o.status==="READ"||o.status==="SEEN")))continue;const r=Yt.current.get(n.id);r&&e.observe(r)}return()=>{e.disconnect()}},[i,$.data,C?.id]),c.useEffect(()=>{const e=()=>{if(!G.current)return;const n=G.current.clientWidth;js(n>=900)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[i]);async function ss(e,n="",s){if(!(!i||e.length===0)){if(w?.isSecret){alert("Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð² ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð±ÐµÑÐµÐ´Ð°Ñ… Ð¿Ð¾ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹. Ð­Ñ‚Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿Ð¾Ð·Ð¶Ðµ.");return}Xs(!0),Qn(0);try{const r=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,o=[],a=e.reduce((h,x)=>h+x.size,0);for(const h of e)if(h.type.startsWith("image/")){const x=URL.createObjectURL(h),{width:y,height:g}=await Ai(x);o.push({url:x,type:"IMAGE",width:y,height:g,progress:0,__pending:!0})}else o.push({url:h.name,type:"FILE",__pending:!0,progress:0});Ct(h=>({...h,[i]:[...h[i]||[],{id:r,createdAt:Date.now(),senderId:C?.id||"me",attachments:o,content:n}]}));const l=[];let p=0;for(let h=0;h<e.length;h++){const x=e[h],y=o[h],g=new FormData;g.append("file",x);const v={url:await new Promise((I,R)=>{const L=new XMLHttpRequest;L.open("POST","/api/upload");try{const N=mt.getState().session?.accessToken;N&&L.setRequestHeader("Authorization",`Bearer ${N}`)}catch{}L.upload.onprogress=N=>{if(N.lengthComputable){const O=Math.round((p+N.loaded)/a*100);Qn(O),Ct(P=>{const V=(P[i]||[]).map(ne=>({...ne,attachments:ne.attachments.map(oe=>({...oe}))})),Q=V[V.length-1];if(Q){const ne=Q.attachments.findIndex(oe=>oe.__pending&&oe.type===(x.type.startsWith("image/")?"IMAGE":"FILE")&&(!oe.width||oe.url.startsWith("blob:")));ne>=0&&(Q.attachments[ne].progress=O)}return{...P,[i]:V}})}},L.onreadystatechange=()=>{if(L.readyState===4)if(L.status>=200&&L.status<300)try{const N=JSON.parse(L.responseText);I(N.url)}catch(N){R(N)}else R(new Error("upload failed"))},L.send(g)}),type:x.type.startsWith("image/")?"IMAGE":"FILE"};y&&y.type==="IMAGE"&&y.width&&y.height&&(v.metadata={width:y.width,height:y.height}),l.push(v),p+=x.size,Qn(Math.round(p/e.reduce((I,R)=>I+R.size,0)*100))}const u=l.every(h=>h.type==="IMAGE")?"IMAGE":"FILE";await z.post("/conversations/send",{conversationId:i,type:u,content:n,attachments:l,replyToId:s}),Ct(h=>{const y=(h[i]||[]).filter(g=>g.id!==r);if(y.length===0){const{[i]:g,...j}=h;return j}return{...h,[i]:y}}),D.invalidateQueries({queryKey:["messages",i]})}catch{}Xs(!1)}}async function Ai(e){return new Promise(n=>{const s=new Image;s.onload=()=>n({width:s.naturalWidth,height:s.naturalHeight}),s.onerror=()=>n({width:320,height:200}),s.src=e})}c.useEffect(()=>{let e=null;const n=async()=>{const s=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Ks(Math.round(performance.now()-s))}catch{Ks(null)}};return n(),e=window.setInterval(n,15e3),()=>{e&&clearInterval(e)}},[]),c.useEffect(()=>{let e=null;const n=()=>D.invalidateQueries({queryKey:["conversations"]});return e=window.setInterval(n,2e4),()=>{e&&clearInterval(e)}},[D]);function rs(e){const n=e.status,s=e.lastSeenAt?new Date(e.lastSeenAt):null;if(n==="ONLINE")return"ÐžÐÐ›ÐÐ™Ð";if(!s)return"Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½";const o=new Date().getTime()-s.getTime(),a=Math.floor(o/6e4);if(a<1)return"Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";if(a<60)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${a} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;const l=Math.floor(a/60);if(l<24)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${l} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;const p={hour:"2-digit",minute:"2-digit"},u=s.toLocaleDateString(),h=s.toLocaleTimeString([],p);return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${u} Ð² ${h}`}function is(e){const n=Math.max(0,Math.floor(e/1e3)),s=Math.floor(n/3600),r=Math.floor(n%3600/60),o=n%60;return s>0?`${s}:${String(r).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${r}:${String(o).padStart(2,"0")}`}function fr(e){const n=e?"conversations-list slider-panel":"conversations-list";return t.jsxs("aside",{className:n,children:[t.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[t.jsxs("div",{className:"logo",children:[t.jsx("span",{children:"Ð•"}),t.jsx("span",{className:"b",children:"Ð‘"}),t.jsx("span",{children:"Ð»ÑƒÑˆÐ°"})]}),t.jsx("div",{className:"subtitle",children:"Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÐ¼ÑÑ"})]})}),t.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[t.jsx("div",{ref:Is,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:B.data?.slice().sort((s,r)=>{const o=s.conversation.messages?.[0]?.createdAt?new Date(s.conversation.messages[0].createdAt).getTime():0;return(r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0)-o}).filter(s=>{const r=s.conversation;return!(r.isSecret&&(r.secretStatus??"ACTIVE")!=="ACTIVE")}).map(s=>{const r=s.conversation,o=r.participants.filter(y=>y.user.id!==C?.id).map(y=>y.user),a=o.map(y=>y.displayName??y.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",l=r.title??a,p=r.isGroup||r.participants.length>2,u=!!r.isSecret;o.map(y=>y.displayName??y.username).join(", ");const h=i===r.id,x=f===r.id;return t.jsxs("div",{onContextMenu:y=>{y.preventDefault(),y.stopPropagation(),Ht({open:!0,x:y.clientX,y:y.clientY,conversationId:r.id})},onClick:()=>lt(r.id),className:"tile",style:{...s.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...h?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...x?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)"}:{}},children:[p?(()=>{const g=Xe[r.id]?.active;return t.jsx(se,{name:l?.trim()?.charAt(0)||"Ð“",id:r.id,avatarUrl:r.avatarUrl&&r.avatarUrl.trim()?r.avatarUrl:void 0,presence:g?"IN_CALL":void 0})})():(()=>{const g=Xe[r.id]?.active;return t.jsx(se,{name:o[0]?.displayName??o[0]?.username??"D",id:o[0]?.id??r.id,presence:g?"IN_CALL":o[0]?.status??"OFFLINE",avatarUrl:o[0]?.avatarUrl&&o[0].avatarUrl.trim()?o[0].avatarUrl:void 0})})(),t.jsxs("div",{children:[t.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:l}),u&&t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:t.jsx(Sn,{size:12,color:"#22c55e"})})]}),t.jsx("div",{style:{fontSize:12,color:s.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:s.unreadCount>0?`${s.unreadCount} Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…`:(()=>{const y=Xe[r.id];if(y?.active){const g=y.startedAt?Date.now()-y.startedAt:typeof y.elapsedMs=="number"?y.elapsedMs:0;return t.jsx("span",{children:is(g)})}else if(y&&y.endedAt){const g=y.endedAt,v=Date.now()-g,I=Math.floor(v/6e4);if(I<1)return t.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(I<60)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",I," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const R=Math.floor(I/60);if(R<24)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",R," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const L=new Date(g),N=L.toLocaleDateString(),O=L.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",N," Ð² ",O]})}return p?null:rs(o[0]??{})})()})]})]},r.id)})}),Xr&&t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),_r&&t.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),t.jsxs("div",{className:"conv-footer",children:[t.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsxs("div",{style:{display:"flex",gap:12},children:[t.jsxs("div",{onClick:()=>Ls(!0),className:"tile",style:{marginTop:0,flex:1},children:[t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(wa,{size:22})}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:"Ð‘ÐµÑÐµÐ´Ð°"}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})]}),t.jsxs("div",{onClick:ki,className:"tile",style:{marginTop:0,flex:1},children:[t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:ve.data&&ve.data.length>0?t.jsx(xa,{size:22}):he.data&&he.data.length>0?t.jsx(Pa,{size:22}):t.jsx(fs,{size:22})}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:ve.data&&ve.data.length>0?"ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ":he.data&&he.data.length>0?"Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})]})]}),t.jsxs("div",{className:"tile",onClick:()=>Qt(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const s=oi??be.data?.status,r=ai?"ONLINE":"OFFLINE",o=(s??r??"OFFLINE").toString().toUpperCase(),a=["ONLINE","AWAY","OFFLINE"].includes(o)?o:r,l=be.data?.avatarUrl??C?.avatarUrl??void 0;return t.jsx(se,{name:C?.displayName??C?.username??"Me",id:C?.id??"me",presence:a,avatarUrl:l})})(),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:700},children:C?.displayName??C?.username??"Ð¯"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",be.data?.eblid??"â€” â€” â€” â€”"]})]})]})]})]})]})}function hr(e){const n=e?"messages-pane slider-panel":"messages-pane",s=cr,r=lr;let o="";return w?.isSecret&&(s?o="Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°.":ts?o=ar?`Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Â«${ar}Â»`:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.":r||(o="Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...")),t.jsxs("section",{className:n,children:[t.jsxs("header",{style:{...i?Xe[i]?.active?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:A?"column":"row",justifyContent:A?"flex-start":"space-between",alignItems:A?"stretch":"center",flexShrink:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:A?"100%":"auto",padding:A?"0 8px":"0"},children:[e&&t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:bi,children:t.jsx(ma,{size:18})}),w?(()=>{const a=w.participants.filter(g=>g.user.id!==C?.id).map(g=>g.user),l=a.map(g=>g.displayName??g.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",p=w.title??l,u=w.isGroup||w.participants.length>2,h=!!w.isSecret&&!u,x=Xe[w.id],y=x?.active;return u?t.jsxs(t.Fragment,{children:[t.jsx("div",{onClick:()=>Bt(!0),style:{cursor:"pointer"},children:t.jsx(se,{name:p?.trim()?.charAt(0)||"Ð“",id:w.id,size:60,avatarUrl:w.avatarUrl&&w.avatarUrl.trim()?w.avatarUrl:void 0,presence:y?"IN_CALL":void 0})}),t.jsxs("div",{style:{flex:1,minWidth:0,order:A?1:2},children:[t.jsx("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8},children:p}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:y?t.jsx(t.Fragment,{children:(()=>{const g=x.participants||[],j=w.participants||[],v=x.startedAt?Date.now()-x.startedAt:typeof x.elapsedMs=="number"?x.elapsedMs:0;return t.jsxs(t.Fragment,{children:[x.active&&t.jsx("span",{children:is(v)}),j.length>0&&t.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[x.startedAt&&" â€¢ ",j.map((I,R)=>{const L=I.user,N=g.length>0&&g.includes(L.id);return t.jsxs("span",{style:{fontWeight:N?700:400,color:N?"var(--brand-600)":"var(--text-muted)"},children:[R>0&&", ",L.displayName??L.username,N&&" âœ“"]},L.id)})]})]})})()}):x&&x.endedAt?(()=>{const g=x.endedAt,v=Date.now()-g,I=Math.floor(v/6e4);let R="";if(I<1)R="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";else if(I<60)R=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${I} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;else{const N=Math.floor(I/60);if(N<24)R=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${N} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;else{const O=new Date(g),P=O.toLocaleDateString(),q=O.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});R=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${P} Ð² ${q}`}}const L=w.participants||[];return t.jsxs(t.Fragment,{children:[t.jsx("span",{children:R}),L.length>0&&t.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" â€¢ ",L.map((N,O)=>{const P=N.user;return t.jsxs("span",{children:[O>0&&", ",P.displayName??P.username]},P.id)})]})]})})():a.map(g=>g.displayName??g.username).join(", ")})]}),t.jsx("button",{className:A?"btn btn-secondary":"btn btn-icon btn-ghost",title:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²",onClick:()=>{Rn([]),Ln("friends"),Mn(["","","",""]),jt(null),it(null),St(!1),Cs(!0)},style:A?{padding:"8px 16px",height:42,borderRadius:999,fontSize:14,fontWeight:500,whiteSpace:"nowrap",flexShrink:0,marginLeft:"auto",order:2}:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:60,height:60,minWidth:60,minHeight:60,borderRadius:999,order:1},children:A?t.jsxs(t.Fragment,{children:[t.jsx(fs,{size:16}),t.jsx("span",{style:{marginLeft:6},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]}):t.jsx(fs,{size:20})})]}):(()=>{const g=a[0];return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[t.jsx(se,{name:g?.displayName??g?.username??"D",id:g?.id??w.id,avatarUrl:g?.avatarUrl&&g.avatarUrl.trim()?g.avatarUrl:void 0,presence:x?.active?"IN_CALL":g?.status??"OFFLINE",size:60}),t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:p}),h&&t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:t.jsx(Sn,{size:14,color:"#22c55e"})})]}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:x?.active?(()=>{const j=x.startedAt?Date.now()-x.startedAt:typeof x.elapsedMs=="number"?x.elapsedMs:0;return t.jsx("span",{children:is(j)})})():x&&x.endedAt?(()=>{const j=x.endedAt,I=Date.now()-j,R=Math.floor(I/6e4);if(R<1)return t.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(R<60)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",R," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const L=Math.floor(R/60);if(L<24)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",L," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const N=new Date(j),O=N.toLocaleDateString(),P=N.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",O," Ð² ",P]})})():g?g.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":rs(g):""})]}),g?.id&&t.jsx("button",{className:h?"btn btn-primary":A?"btn btn-secondary":"btn btn-icon btn-ghost",title:h?ji:"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚",disabled:!h&&Js,onClick:async()=>{if(h){Et(!0);return}await sr(g.id)},style:h?{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:6,padding:A?"8px 14px":"10px 18px",height:A?42:44,borderRadius:999,background:"#ef4444",borderColor:"#ef4444",color:"#fff",fontSize:A?14:15,fontWeight:600,...A?{marginLeft:"auto",alignSelf:"flex-end"}:{}}:A?{padding:"8px 12px",height:42,borderRadius:999,fontSize:14,fontWeight:500,whiteSpace:"nowrap"}:void 0,children:h?t.jsx("span",{style:{fontWeight:600},children:wi}):A?t.jsxs(t.Fragment,{children:[t.jsx(Sn,{size:16}),t.jsx("span",{style:{marginLeft:6},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"})]}):t.jsx(Sn,{size:18})})]})})()})():t.jsx("div",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚"})]}),fi&&w&&!!w.isSecret&&(w.participants?.length??0)<=2&&typeof document<"u"&&jr.createPortal(t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:A?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Et(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:A?16:20,borderRadius:A?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:A?"center":"left"},onClick:a=>a.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:A?"column":"row",gap:A?8:0},children:[t.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚?"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Et(!1),style:{alignSelf:A?"flex-end":void 0},children:t.jsx(Ne,{size:18})})]}),t.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ñƒ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."}),t.jsxs("div",{style:{display:"flex",justifyContent:A?"center":"flex-end",alignItems:"center",flexDirection:A?"column":"row",gap:A?12:8},children:[t.jsx("button",{className:"btn btn-ghost",onClick:()=>Et(!1),style:A?{width:"100%"}:void 0,children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:A?"100%":void 0},onClick:async()=>{if(i)try{await z.delete(`/conversations/${i}`),D.invalidateQueries({queryKey:["conversations"]}),D.removeQueries({queryKey:["messages",i]}),Et(!1),d(null)}catch(a){console.error("Failed to end secret conversation:",a)}},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ"})]})]})}),document.body),i&&t.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,width:A?"100%":"auto",padding:A?"0 8px":"0",justifyContent:A?"center":"flex-end",marginLeft:A?0:"auto"},children:(()=>{const l=Xe[i]?.active,p=b===i;w?.isGroup||(w?.participants.length??0)>2;const u=f===i,h={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:A?"8px 12px":"12px 16px",flex:A?1:"auto",minWidth:A?0:"auto",fontSize:A?"14px":"15px",fontWeight:A?500:600,height:A?"42px":"46px",minHeight:A?"42px":"46px",boxSizing:"border-box"},x=()=>{if(i)try{Er(i,!1),H.startOutgoing(i,!1),xe(g=>{const j=g[i],v=C?.id;return j?.active?v&&j.participants&&!j.participants.includes(v)?{...g,[i]:{...j,participants:[...j.participants,v]}}:g:{...g,[i]:{startedAt:Date.now(),active:!0,participants:v?[v]:[]}}}),m(i),S(g=>g===i?null:g)}catch(g){console.error("Error starting call:",g)}},y=()=>{if(i)try{Er(i,!0),H.startOutgoing(i,!0),xe(g=>{const j=g[i],v=C?.id;return j?.active?v&&j.participants&&!j.participants.includes(v)?{...g,[i]:{...j,participants:[...j.participants,v]}}:g:{...g,[i]:{startedAt:Date.now(),active:!0,participants:v?[v]:[]}}}),m(i),S(g=>g===i?null:g)}catch(g){console.error("Error starting call:",g)}};return l?u?t.jsxs(t.Fragment,{children:[p?t.jsxs("button",{className:"btn btn-secondary",onClick:()=>{S(null)},style:h,children:[t.jsx(Aa,{size:A?16:18}),A?"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ":" Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"]}):!A&&t.jsx("div",{style:{flex:1}}),t.jsxs("button",{className:"btn",onClick:()=>{const g=w?.participants?.length??0,j=g<=2,v=w?.isGroup||g>2;if(j&&f)Ir(f),xe(I=>{const R=I[f];return R?.active?{...I,[f]:{...R,active:!1,endedAt:Date.now()}}:I});else if(v&&f){try{sa(f)}catch{}xe(I=>{const R=I[f];if(!R||!R.participants)return I;const L=C?.id;return!L||!R.participants.includes(L)?I:{...I,[f]:{...R,participants:R.participants.filter(N=>N!==L)}}})}m(null),S(null),H.endCall(),Ce()},style:{...h,background:"#ef4444",color:"#fff"},children:[t.jsx(Mr,{size:A?16:18}),A?"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ":" Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(m(i),S(j=>j===i?null:j),H.startOutgoing(i,!1),w?.isGroup||(w?.participants?.length??0)>2)try{Sr(i,!1)}catch{}},style:h,children:[t.jsx(us,{size:A?16:18}),A?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"]}),t.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(m(i),S(j=>j===i?null:j),H.startOutgoing(i,!0),w?.isGroup||(w?.participants?.length??0)>2)try{Sr(i,!0)}catch{}},style:h,children:[t.jsx(hs,{size:A?16:18}),A?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾"]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn btn-secondary",onClick:x,style:h,children:[t.jsx(us,{size:A?16:18}),A?"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº":" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº"]}),t.jsxs("button",{className:"btn btn-primary",onClick:y,style:h,children:[t.jsx(hs,{size:A?16:18}),A?"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"]})]})})()})]}),!w?.isSecret&&ft&&t.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:A?"column":"row",gap:12,alignItems:A?"stretch":"center"},children:ft.isInitiator?t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{flex:1},children:"Ð–Ð´Ñ‘Ð¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚."}),t.jsx("div",{style:{display:"flex",gap:8},children:t.jsx("button",{className:"btn btn-ghost",onClick:()=>rr(ft.conversationId),disabled:Zn,style:{color:"#f87171"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{flex:1},children:[ft.initiatorName," Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ."]}),t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>mi(ft.conversationId),disabled:Zn,children:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ"}),t.jsx("button",{className:"btn btn-ghost",onClick:()=>rr(ft.conversationId),disabled:Zn,style:{color:"#bae6fd"},children:"ÐžÑ‚ÐºÐ°Ð·Ð°Ñ‚ÑŒÑÑ"})]})]})}),t.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),t.jsx("div",{ref:G,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:i?w?.isSecret&&(!r||s)?t.jsx("div",{className:"messages-empty",children:o}):(()=>{const a=(ke?[...ke]:[]).filter(u=>!u.deletedAt).sort((u,h)=>new Date(u.createdAt||0).getTime()-new Date(h.createdAt||0).getTime()),l=hn,p=[...a||[],...l];return p?p.map((u,h)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return t.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const x=p[h-1],y=p[h+1],g=!y||y.senderId!==u.senderId,j=!!x&&x.senderId===u.senderId,v=u.senderId===C?.id,L=`${bt?"msg left":v?"msg me":"msg them"} ${j?"compact":"gap"}`,N=bt?"msg-bubble left":v?"msg-bubble me":"msg-bubble them",O=g?`${N} ${v&&!bt?"tail-right":"tail-left"}`:N,P=dr[u.senderId],q=P?.displayName??P?.username??(v?C?.displayName??C?.username??"Me":"User"),V=P?.id??(v?C?.id??"me":"user"),Q=v?"#303845":Si(u.senderId),ne="#f1f3f6",oe=bt&&g,Le=bt,Ee=u.createdAt?new Date(u.createdAt):null,we=Ee?Ee.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",Me=(w?.participants||[]).map(E=>E.user.id).filter(E=>E!==C?.id),De=u.receipts||[],Lt=v&&Me.some(E=>De.some(F=>F.userId===E&&(F.status==="READ"||F.status==="SEEN"))),Mt=v&&Lt?"âœ“":"",as=(E,F)=>{He({open:!0,x:E,y:F,messageId:u.id})},Li=E=>{E.preventDefault(),as(E.clientX,E.clientY)},Mi=()=>{const E=u.replyTo?.id;if(!E)return;const F=Yt.current.get(E);F&&F.scrollIntoView({behavior:"smooth",block:"center"})},gr=p.filter(E=>(E.attachments||[]).some(F=>F.type==="IMAGE")).flatMap(E=>E.attachments.filter(F=>F.type==="IMAGE").map(F=>F.url)),Di=E=>{const F=gr.findIndex(le=>le===E);Fe({open:!0,index:F>=0?F:0,items:gr})},Ni=A?{}:{onContextMenu:Li,...{onPointerDown:E=>{const F=window.setTimeout(()=>as(E.clientX,E.clientY),450),le=()=>{window.clearTimeout(F),window.removeEventListener("pointerup",le),window.removeEventListener("pointermove",xn)},xn=()=>{window.clearTimeout(F),window.removeEventListener("pointerup",le),window.removeEventListener("pointermove",xn)};window.addEventListener("pointerup",le,{passive:!0}),window.addEventListener("pointermove",xn,{passive:!0})}}};return t.jsxs("div",{className:L,...Ni,children:[Le&&(oe?t.jsx(se,{name:q,id:V,avatarUrl:(()=>{const E=dr[u.senderId]?.avatarUrl;return E&&E.trim()?E:void 0})()}):t.jsx("div",{className:"avatar-spacer"})),t.jsxs("div",{className:O,"data-mid":u.id,ref:E=>{if(!E){Yt.current.delete(u.id);return}Yt.current.set(u.id,E),Nn.current?.observe(E)},style:{"--bubble-bg":Q,"--bubble-fg":ne},onClick:E=>{if(!A||E.target.closest("a, button, input, textarea, img, video"))return;const le=typeof window.getSelection=="function"?window.getSelection():null;le&&le.toString()||as(E.clientX,E.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const E={};for(const F of u.reactions)E[F.emoji]=(E[F.emoji]||0)+1;return t.jsx("div",{style:{position:"absolute",bottom:-18,right:v?8:void 0,left:v?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(E).map(([F,le])=>t.jsxs("span",{style:{fontSize:12,color:"#ffc46b"},children:[F,le>1?` ${le}`:""]},F))})})(),u.replyTo&&t.jsxs("div",{onClick:Mi,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:v?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°: ",u.replyTo.content??"ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"]}),t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(u.attachments||[]).map((E,F)=>{if(E.type==="IMAGE"){const le=typeof window<"u"?window.innerWidth:1280,Dt=le<=768?Math.max(320,Math.floor(le/2)):Math.min(600,Math.max(320,Math.floor(le/3))),Ti=`${E.url||F}`,mr=di[Ti],Nt=mr?.width||E.width||E.metadata?.width||Dt,vn=mr?.height||E.height||E.metadata?.height||Math.round(Nt*.75),bn=vn/Nt||.75,wn=Dt;let ht=Dt;bn<.5?ht=Math.max(Math.round(Dt*.6),200):bn<.7&&(ht=Math.max(Math.round(Dt*.75),200));const zi=Nt>wn?wn/Nt:1,Ui=vn>ht?ht/vn:1,yr=Math.min(zi,Ui,1);let Ye=Nt*yr,Ae=vn*yr;Ye>wn&&(Ye=wn,Ae=Ye*bn),Ae>ht&&(Ae=ht,Ye=Ae/bn),Ye=Math.round(Ye),Ae=Math.round(Ae);const os=`${E.url||F}`,cs=!!ci[os],jn=E.__pending||!cs;return t.jsxs("div",{style:{maxWidth:"100%",maxHeight:Ae,width:jn?Math.min(Ye,typeof window<"u"?window.innerWidth-100:Ye):"fit-content",height:jn?Ae:"auto",minWidth:0,minHeight:jn?Ae:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[jn&&t.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[t.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),typeof E.progress=="number"&&E.progress<100?t.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[E.progress,"%"]})]}):t.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),t.jsx("img",{src:E.url,alt:"img",style:{maxWidth:"100%",maxHeight:Ae,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:E.__pending?.85:1,display:cs?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:ls=>{const rt=ls.target;if(!E.width&&!E.metadata?.width&&rt.naturalWidth&&rt.naturalHeight&&ui(pt=>({...pt,[os]:{width:rt.naturalWidth,height:rt.naturalHeight}})),li(pt=>({...pt,[os]:!0})),G.current&&Ke.current){const pt=G.current;pt.scrollTop=pt.scrollHeight}},onError:ls=>{const rt=ls.target;rt&&(rt.style.display="none")},onClick:()=>{E.__pending||Di(E.url)}}),cs&&typeof E.progress=="number"&&E.progress<100&&t.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:t.jsx("div",{style:{width:`${E.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`${E.url}-${F}`)}return t.jsxs("div",{style:{marginTop:8},children:[E.__pending?t.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Ð¤Ð°Ð¹Ð»: ",E.url]}):t.jsxs("a",{href:E.url,target:"_blank",rel:"noreferrer",style:{display:"inline-flex",alignItems:"center",gap:6},children:["Ð¤Ð°Ð¹Ð»: ",E.url.split("/").pop()]}),typeof E.progress=="number"&&E.progress<100&&t.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:t.jsx("div",{style:{width:`${E.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${E.url}-${F}`)})]}),t.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[we," ",Mt]})]})]},u.id)}):null})():t.jsx("div",{className:"messages-empty",children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ"})}),i&&t.jsx("button",{className:qr?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{G.current&&G.current.scrollTo({top:G.current.scrollHeight,behavior:"smooth"}),Ke.current=!0,Ve.current=!1,Xt(!1)},children:"â†“"}),t.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:a=>{a.preventDefault(),Jn(!0)},onDragLeave:()=>Jn(!1),onDrop:a=>{a.preventDefault(),Jn(!1);const l=Array.from(a.dataTransfer.files||[]);ss(l)},children:w?.isSecret&&(!r||s)?t.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:o}):t.jsxs(t.Fragment,{children:[T&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[t.jsx(Ta,{size:16,color:"var(--text-muted)"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°:"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:T.preview}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>U(null),style:{marginLeft:"auto",flexShrink:0},children:t.jsx(Ne,{size:16})})]}),fe&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[t.jsx("img",{src:fe.preview,alt:"Preview",style:{width:48,height:48,objectFit:"cover",borderRadius:6}}),t.jsx("div",{style:{flex:1,fontSize:12,color:"var(--text-muted)"},children:"Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð±ÑƒÑ„ÐµÑ€Ð° Ð¾Ð±Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{fe&&URL.revokeObjectURL(fe.preview),st(null)},style:{flexShrink:0},children:t.jsx(Ne,{size:16})})]}),t.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:W,onChange:async a=>{const l=Array.from(a.target.files||[]);!i||l.length===0||await ss(l)}}),t.jsxs("form",{autoComplete:"off",onSubmit:async a=>{if(a.preventDefault(),!i)return;const l=k.trim();if(fe){const p=fe.file,u=fe.preview;URL.revokeObjectURL(u),st(null),await ss([p],l||"",T?.id),M(""),U(null)}else l&&(await ir(w,{type:"TEXT",content:l,replyToId:T?.id}),M(""),U(null));D.invalidateQueries({queryKey:["messages",i]}),setTimeout(()=>{G.current&&(G.current.scrollTop=G.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:fe?"Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑŽ...":"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...",value:k,onChange:a=>M(a.target.value),onPaste:async a=>{if(!i)return;const l=a.clipboardData?.items;if(l)for(let p=0;p<l.length;p++){const u=l[p];if(u.type.indexOf("image")!==-1){a.preventDefault();const h=u.getAsFile();if(h){const x=URL.createObjectURL(h);st({file:h,preview:x})}break}}},ref:X,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16}}),t.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>W.current?.click(),style:{flexShrink:0,whiteSpace:"nowrap"},children:A?t.jsx(La,{size:16}):"ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ"})]}),ri&&t.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:t.jsx("div",{style:{width:`${ii}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),t.jsx(c.Suspense,{fallback:null,children:f&&t.jsx(co,{open:!!f,conversationId:f,minimized:b===f,peerAvatarUrl:(()=>{const a=w?.participants||[];return a.length===2?a.find(p=>p.user.id!==C?.id)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const a=w?.participants||[],l={};for(const p of a){const u=p.user,h=u.displayName??u.username??u.id;l[h]=u.avatarUrl??null}return C&&(l[C.displayName??C.username??C.id]=be.data?.avatarUrl??C.avatarUrl??null),l})(),avatarsById:(()=>{const a=w?.participants||[],l={};for(const p of a){const u=p.user;l[u.id]=u.avatarUrl??null}return C&&(l[C.id]=be.data?.avatarUrl??C.avatarUrl??null),l})(),localUserId:C?.id??null,isGroup:(w?.participants,!!w?.isGroup),onMinimize:()=>{f&&S(f)},onClose:()=>{const a=w?.participants?.length??0,l=a<=2,p=w?.isGroup||a>2;f&&(l&&Ir(f),xe(u=>{const h=u[f];if(!h)return u;if(p){const x=(h.participants||[]).filter(y=>y!==C?.id);return{...u,[f]:{...h,participants:x}}}return h.active?{...u,[f]:{...h,active:!1,endedAt:Date.now()}}:u})),m(null),S(null),H.endCall(),Ce()},initialVideo:H.initialVideo,initialAudio:H.initialAudio})}),H.incoming&&jr.createPortal(t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:t.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:12},children:H.incoming.video?"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð°ÑƒÐ´Ð¸Ð¾Ð·Ð²Ð¾Ð½Ð¾Ðº"}),t.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[t.jsx(se,{name:H.incoming.from.name??H.incoming.from.id,id:H.incoming.from.id,size:64,avatarUrl:H.incoming.from.avatarUrl??B.data?.find(a=>a.conversation.id===H.incoming.conversationId)?.conversation?.participants?.find(a=>a.user.id===H.incoming.from.id)?.user?.avatarUrl??he.data?.find(a=>a.friend?.id===H.incoming.from.id)?.friend?.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,fontSize:16},children:H.incoming.from.name??H.incoming.from.id}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð·Ð²Ð¾Ð½Ð¸Ñ‚â€¦"})]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{const a=H.incoming.conversationId;kr(a,!1),H.startOutgoing(a,!1),m(a),S(l=>l===a?null:l),xe(l=>l[a]?.active?l:{...l,[a]:{startedAt:Date.now(),active:!0,participants:[C?.id||""].filter(Boolean)}}),H.setIncoming(null),Ce()},children:[t.jsx(us,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ"})]}),t.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{const a=H.incoming.conversationId;kr(a,!0),H.startOutgoing(a,!0),m(a),S(l=>l===a?null:l),xe(l=>l[a]?.active?l:{...l,[a]:{startedAt:Date.now(),active:!0,participants:[C?.id||""].filter(Boolean)}}),H.setIncoming(null),Ce()},children:[t.jsx(hs,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"})]})]}),t.jsx("div",{style:{display:"flex"},children:t.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Cr(H.incoming.conversationId),H.setIncoming(null),Ce()},children:[t.jsx(Mr,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})})]})]})}),document.body)]})}function pr(e,n){n&&D.setQueryData(["messages",e],s=>{const r=Array.isArray(s)?[...s]:[];return r.some(o=>o.id===n.id)||(r.push(n),r.sort((o,a)=>new Date(o.createdAt||0).getTime()-new Date(a.createdAt||0).getTime())),r})}function Ri(e,n){n&&D.setQueryData(["messages",e],s=>{if(!Array.isArray(s))return s;const r=s.findIndex(a=>a.id===n.id);if(r===-1)return s;const o=[...s];return o[r]={...o[r],...n},o})}return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:A?"chats-page mobile-slider":"chats-page",children:A?t.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${Dn==="conversation"?"-100vw":"0"})`},onTouchStart:e=>{const n=e.touches[0];Gt.current={x:n.clientX,y:n.clientY},zn.current=0},onTouchMove:e=>{if(!Gt.current)return;const n=e.touches[0];zn.current=n.clientX-Gt.current.x},onTouchEnd:()=>{const e=zn.current;Gt.current=null,!(Math.abs(e)<50)&&(e<0&&i&&je("conversation"),e>0&&je("list"))},children:[fr(!0),hr(!0)]}):t.jsxs(t.Fragment,{children:[fr(!1),hr(!1)]})}),ni&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Qt(!1),children:t.jsx(Ne,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:C?.displayName??C?.username??"Me",id:C?.id??"me",avatarUrl:me??be.data?.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:C?.displayName??C?.username}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",be.data?.eblid??"â€” â€” â€” â€”"]})]})]}),t.jsx("input",{ref:Ps,type:"file",accept:"image/*",onChange:e=>{const n=e.target.files?.[0];if(n){Zt(n);try{en(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!me&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{onClick:()=>Ps.current?.click(),onDragOver:e=>{e.preventDefault(),Kn(!0)},onDragLeave:()=>Kn(!1),onDrop:e=>{e.preventDefault(),Kn(!1);const n=e.dataTransfer.files?.[0];if(n){Zt(n);try{en(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Fs?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Fs?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(ds,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),me&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:Ze,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,s=Math.max(.1,Math.min(10,Y.scale*(1+n))),r=Ze.current?.getBoundingClientRect();if(r){const o=e.clientX-r.left,a=e.clientY-r.top,l=s/Y.scale,p=o-(o-Y.x)*l,u=a-(a-Y.y)*l;We({x:p,y:u,scale:s})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=Ze.current?.getBoundingClientRect();if(!n)return;const s=n.width,r=n.height,o=s/2,a=r/2,p=240/2,u=e.clientX-n.left,h=e.clientY-n.top,x=u-o,y=h-a;if(x*x+y*y>p*p)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,j=e.clientY,v={...Y},I=L=>{L.preventDefault();const N=L.clientX-g,O=L.clientY-j;We({...v,x:v.x+N,y:v.y+O})},R=()=>{window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",R)};window.addEventListener("pointermove",I,{passive:!1}),window.addEventListener("pointerup",R,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:Gn,src:me,alt:"preview",style:{position:"absolute",left:Y.x,top:Y.y,transform:`scale(${Y.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,s=Ze.current;if(!s)return;const r=s.clientWidth,o=s.clientHeight,a=240,l=n.naturalWidth,p=n.naturalHeight,u=r/2,h=o/2,x=a/l,y=a/p,g=Math.max(x,y)*1.2,j=u-l*g/2,v=h-p*g/2;We({x:j,y:v,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Y.scale*100),"%"]})]}),t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>We(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:10,step:.05,value:Y.scale,onChange:e=>We(n=>({...n,scale:parseFloat(e.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>We(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]}),t.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:t.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:A?"Ð”Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°, Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ":"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾ Ð¼Ñ‹ÑˆÐ¸ Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°"})})]}),t.jsx("canvas",{ref:tn,width:240,height:240,style:{display:"none"}})]}),$n&&t.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>{Zt(null),me&&URL.revokeObjectURL(me),en(null)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:ot,onClick:async()=>{if($n){Jt(!0),nn(0);try{let e=null;if(tn.current&&me){const r=await new Promise(v=>{const I=new Image;I.onload=()=>v(I),I.src=me}),o=tn.current.getContext("2d"),a=240;o.clearRect(0,0,a,a),o.save(),o.beginPath(),o.arc(a/2,a/2,a/2,0,Math.PI*2),o.closePath(),o.clip();const l=Ze.current?.clientWidth??320,p=Ze.current?.clientHeight??320,u={x:l/2,y:p/2},h={x:u.x-a/2,y:u.y-a/2,w:a,h:a},x=(h.x-Y.x)/Y.scale,y=(h.y-Y.y)/Y.scale,g=h.w/Y.scale,j=h.h/Y.scale;o.drawImage(r,x,y,g,j,0,0,a,a),o.restore(),e=await new Promise(v=>tn.current.toBlob(I=>v(I),"image/png"))}const n=new FormData;n.append("file",e??$n);const s=await new Promise((r,o)=>{const a=new XMLHttpRequest;a.open("POST","/api/upload");try{const l=mt.getState().session?.accessToken;l&&a.setRequestHeader("Authorization",`Bearer ${l}`)}catch{}a.upload.onprogress=l=>{l.lengthComputable&&nn(Math.round(100*l.loaded/l.total))},a.onreadystatechange=()=>{if(a.readyState===4)if(a.status>=200&&a.status<300)try{const l=JSON.parse(a.responseText);r(l.url)}catch(l){o(l)}else o(new Error("upload failed"))},a.send(n)});await z.patch("/status/me",{avatarUrl:s}),Zt(null),me&&URL.revokeObjectURL(me),en(null),be.refetch()}catch{}Jt(!1),ct("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ct(null),2200)}},children:ot?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),ot&&t.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:t.jsx("div",{style:{width:`${Bs}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ln&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[t.jsx(Rr,{size:16}),t.jsx("span",{children:ln})]}),t.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:t.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await z.post("/auth/logout")}catch{}mt.getState().setSession(null),Qt(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[t.jsx(Lr,{size:18}),t.jsx("span",{children:"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð•Ð±Ð»ÑƒÑˆÐ¸"})]})}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:t.jsx("button",{className:"btn btn-ghost",onClick:()=>Qt(!1),children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})}),Vr&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>Be(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Be(!1),children:t.jsx(Ne,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:kt.trim()||"?",id:"new-group-avatar-preview",avatarUrl:at??void 0,size:60}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:kt||"ÐÐ¾Ð²Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),t.jsx("input",{ref:Bn,type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{const n=e.target.files?.[0];if(n){if(Kt(n),ue)try{URL.revokeObjectURL(ue)}catch{}try{const s=URL.createObjectURL(n);Qe(s)}catch{Qe(null)}Se({x:0,y:0,scale:1})}}}),!ue&&t.jsx(t.Fragment,{children:t.jsxs("div",{onClick:()=>Bn.current?.click(),onDragOver:e=>{e.preventDefault(),Wn(!0)},onDragLeave:()=>Wn(!1),onDrop:e=>{e.preventDefault(),Wn(!1);const n=e.dataTransfer.files?.[0];if(n){if(Kt(n),ue)try{URL.revokeObjectURL(ue)}catch{}try{const s=URL.createObjectURL(n);Qe(s)}catch{Qe(null)}Se({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(Hs?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Hs?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(ds,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})}),ue&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:Je,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,s=Math.max(.1,Math.min(10,Z.scale*(1+n))),r=Je.current?.getBoundingClientRect();if(r){const o=e.clientX-r.left,a=e.clientY-r.top,l=s/Z.scale,p=o-(o-Z.x)*l,u=a-(a-Z.y)*l;Se({x:p,y:u,scale:s})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=Je.current?.getBoundingClientRect();if(!n)return;const s=n.width,r=n.height,o=s/2,a=r/2,p=240/2,u=e.clientX-n.left,h=e.clientY-n.top,x=u-o,y=h-a;if(x*x+y*y>p*p)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,j=e.clientY,v={...Z},I=L=>{L.preventDefault();const N=L.clientX-g,O=L.clientY-j;Se({...v,x:v.x+N,y:v.y+O})},R=()=>{window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",R)};window.addEventListener("pointermove",I,{passive:!1}),window.addEventListener("pointerup",R,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:Qr,src:ue,alt:"preview",style:{position:"absolute",left:Z.x,top:Z.y,transform:`scale(${Z.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,s=Je.current;if(!s)return;const r=s.clientWidth,o=s.clientHeight,a=240,l=n.naturalWidth,p=n.naturalHeight,u=r/2,h=o/2,x=a/l,y=a/p,g=Math.max(x,y)*1.2,j=u-l*g/2,v=h-p*g/2;Se({x:j,y:v,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Se(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Z.scale,onChange:e=>{const n=parseFloat(e.target.value),s=Je.current?.getBoundingClientRect();if(!s){Se(u=>({...u,scale:n}));return}const r=s.width/2,o=s.height/2,a=n/Z.scale,l=r-(r-Z.x)*a,p=o-(o-Z.y)*a;Se({x:l,y:p,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Se(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]})]}),t.jsx("canvas",{ref:Pn,width:240,height:240,style:{display:"none"}})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[t.jsx("button",{className:"btn btn-ghost",onClick:()=>{Be(!1)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:!ue,onClick:async()=>{if(!ue||!Pn.current){Be(!1);return}try{const e=await new Promise(j=>{const v=new Image;v.onload=()=>j(v),v.src=ue}),n=Pn.current,s=n.getContext("2d");if(!s)throw new Error("Could not get 2d context");const r=240;s.clearRect(0,0,r,r),s.save(),s.beginPath(),s.arc(r/2,r/2,r/2,0,Math.PI*2),s.closePath(),s.clip();const o=Je.current?.clientWidth??320,a=Je.current?.clientHeight??320,l={x:o/2,y:a/2},p={x:l.x-r/2,y:l.y-r/2,w:r,h:r},u=(p.x-Z.x)/Z.scale,h=(p.y-Z.y)/Z.scale,x=p.w/Z.scale,y=p.h/Z.scale;s.drawImage(e,u,h,x,y,0,0,r,r),s.restore();const g=await new Promise(j=>n.toBlob(v=>j(v),"image/png"));if(g){if(at)try{URL.revokeObjectURL(at)}catch{}const j=URL.createObjectURL(g);Us(g),Ts(j)}}catch{}finally{Be(!1)}},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]})]})}),Kr&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:es,children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[t.jsx("div",{style:{fontWeight:700},children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:es,children:t.jsx(Ne,{size:16})})]}),(()=>{const e=kt.trim(),n=e||"?";return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[t.jsx("input",{placeholder:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ",value:kt,onChange:s=>Ms(s.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),t.jsx("input",{ref:Bn,type:"file",accept:"image/*",style:{display:"none"},onChange:s=>{const r=s.target.files?.[0];if(r){if(Kt(r),ue)try{URL.revokeObjectURL(ue)}catch{}try{const o=URL.createObjectURL(r);Qe(o)}catch{Qe(null)}Be(!0)}}}),t.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>Be(!0),title:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:t.jsx(se,{name:n,id:"new-group-avatar",avatarUrl:at??void 0,size:40})})]})})(),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),t.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:he.data?.map(e=>{const n=e.friend,s=qt.includes(n.id);return t.jsxs("div",{className:"tile",onClick:()=>Ds(r=>s?r.filter(o=>o!==n.id):[...r,n.id]),style:{cursor:"pointer",borderColor:s?"var(--brand-600)":void 0},children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:s?"Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾":"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsx("input",{type:"checkbox",readOnly:!0,checked:s})})]},e.id)})}),t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:t.jsx("button",{className:"btn btn-primary",disabled:qt.length===0||Un,onClick:async()=>{if(!(qt.length===0||Un)){Hn(!0);try{const e=await z.post("/conversations",{participantIds:qt,title:kt||void 0,isGroup:!0}),n=e.data?.conversation?.id;if(n&&(zs||Ns))try{const s=new FormData;s.append("file",zs??Ns);const r=await new Promise((o,a)=>{const l=new XMLHttpRequest;l.open("POST","/api/upload");try{const p=mt.getState().session?.accessToken;p&&l.setRequestHeader("Authorization",`Bearer ${p}`)}catch{}l.onreadystatechange=()=>{if(l.readyState===4)if(l.status>=200&&l.status<300)try{const p=JSON.parse(l.responseText);o(p.url)}catch(p){a(p)}else a(new Error(`upload failed: ${l.status} ${l.statusText}`))},l.onerror=()=>a(new Error("Network error during upload")),l.send(s)});await z.patch(`/conversations/${n}`,{avatarUrl:r})}catch(s){console.error("Error setting group avatar:",s)}D.invalidateQueries({queryKey:["conversations"]}),e.data?.conversation?.id&&lt(e.data.conversation.id),es()}catch(e){console.error("Error creating group:",e),alert(e?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ")}finally{Hn(!1)}}},children:Un?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...":"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"})})]})}),Jr&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Vt(!1),children:t.jsx(Ne,{size:16})})]}),ve.data&&ve.data.length>0&&t.jsxs("div",{style:{marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:ve.data.map(e=>t.jsxs("div",{className:"tile",children:[t.jsx(se,{name:e.friend.displayName??e.friend.username,id:e.friend.id,presence:e.friend.status,avatarUrl:e.friend.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:e.friend.displayName??e.friend.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ñ…Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ"})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await z.post("/contacts/respond",{contactId:e.id,action:"reject"}),ve.refetch()},children:"ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-primary",onClick:async()=>{await z.post("/contacts/respond",{contactId:e.id,action:"accept"}),he.refetch(),ve.refetch(),B.refetch()},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]},e.id))})]}),t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ EBLID"}),t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(e=>t.jsx("input",{ref:Fn[e],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:On[e],onChange:n=>Ii(e,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},e))}),Pe&&t.jsxs("div",{className:"tile",style:{marginBottom:12},children:[t.jsx(se,{name:Pe.displayName??Pe.username,id:Pe.id,presence:Pe.status,avatarUrl:Pe.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:Pe.displayName??Pe.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsx("button",{disabled:ei,className:"btn btn-primary",onClick:Ci,children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐœÐ¾Ð¹ EBLID:"}),t.jsx("div",{style:{fontWeight:700},children:_n||"â€” â€” â€” â€”"}),t.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{_n&&navigator.clipboard.writeText(_n)},title:"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID",children:t.jsx(Ia,{size:16})})]}),t.jsx("div",{style:{marginTop:16,fontWeight:700},children:"ÐœÐ¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ"}),t.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(he.data||[]).map(e=>{const n=e.friend;return t.jsxs("div",{className:"tile",children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await z.post("/contacts/remove",{contactId:e.id}),he.refetch()},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await sr(n.id),Vt(!1),D.invalidateQueries({queryKey:["conversations"]})},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),t.jsx("button",{className:"btn btn-primary",onClick:async()=>{const s=await z.post("/conversations",{participantIds:[n.id],isGroup:!1});Vt(!1),lt(s.data.conversation.id),D.invalidateQueries({queryKey:["conversations"]})},children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‡Ð°Ñ‚"})]})]},e.id)})})]})}),J.open&&J.messageId&&t.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>He({open:!1,x:0,y:0,messageId:null}),children:t.jsxs("div",{ref:er,className:"msg-menu",style:{position:"absolute",left:J.x,top:J.y,color:"#ffffff"},onClick:e=>e.stopPropagation(),children:[t.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["ðŸ‘","â¤ï¸","ðŸ‘Ž","ðŸ”¥"].map(e=>t.jsx("button",{onClick:async()=>{try{const n=J.messageId;((ke||[]).find(o=>o.id===n)?.reactions||[]).some(o=>o.userId===C?.id&&o.emoji===e)?await z.post("/messages/unreact",{messageId:n,emoji:e}):await z.post("/messages/react",{messageId:n,emoji:e}),i&&D.invalidateQueries({queryKey:["messages",i]})}catch{}He({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:"#ffffff"},children:e},e))}),t.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const e=J.messageId,n=(ke||[]).find(s=>s.id===e);U({id:e,preview:(n?.content??"").slice(0,100)}),He({open:!1,x:0,y:0,messageId:null})},children:"Ð¦Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),(()=>{const e=J.messageId;return(ke||[]).find(r=>r.id===e)?.senderId===C?.id?t.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await z.post("/messages/delete",{messageId:J.messageId}),i&&D.invalidateQueries({queryKey:["messages",i]})}catch{}He({open:!1,x:0,y:0,messageId:null})},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}):null})(),t.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const e=J.messageId,n=(ke||[]).find(s=>s.id===e);try{await navigator.clipboard.writeText(n?.content||"")}catch{}He({open:!1,x:0,y:0,messageId:null})},children:"ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),t.jsx("button",{style:{color:"#ffffff"},onClick:()=>{Pt({open:!0,messageId:J.messageId}),He({open:!1,x:0,y:0,messageId:null})},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ"})]})}),nt.open&&t.jsx("div",{className:"lightbox-backdrop",onClick:()=>Fe({...nt,open:!1}),children:t.jsxs("div",{className:"lightbox-content",onClick:e=>e.stopPropagation(),children:[t.jsx("button",{className:"lightbox-arrow",onClick:()=>Fe(e=>({...e,index:(e.index-1+e.items.length)%e.items.length})),children:"â€¹"}),t.jsx("img",{src:nt.items[nt.index],alt:"preview",style:{transform:`scale(${si})`,transformOrigin:"center center"}}),t.jsx("button",{className:"lightbox-arrow",onClick:()=>Fe(e=>({...e,index:(e.index+1)%e.items.length})),children:"â€º"}),t.jsx("button",{className:"lightbox-close",onClick:()=>Fe({...nt,open:!1}),children:"âœ•"}),t.jsxs("div",{style:{position:"absolute",bottom:-48,left:"50%",transform:"translateX(-50%)",display:"flex",gap:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>Vn(e=>Math.max(.25,e-.25)),children:"-"}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>Vn(1),children:"100%"}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>Vn(e=>Math.min(4,e+.25)),children:"+"})]})]})}),ks.open&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>Pt({open:!1,messageId:null}),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:e=>e.stopPropagation(),children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"}),t.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(B.data||[]).map(e=>{const n=e.conversation,r=n.participants.filter(a=>a.user.id!==C?.id).map(a=>a.user).map(a=>a.displayName??a.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",o=n.title??r;return t.jsx("div",{className:"tile",onClick:async()=>{const a=ks.messageId,l=(ke||[]).find(p=>p.id===a);l&&(await ir(n,{type:"TEXT",content:`â†ª ${l.content??""}`,replyToId:void 0}),Pt({open:!1,messageId:null}))},children:t.jsx("div",{style:{fontWeight:600},children:o})},n.id)})}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:t.jsx("button",{className:"btn btn-secondary",onClick:()=>Pt({open:!1,messageId:null}),children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})})]})}),An&&w&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:dt,children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:dt,children:t.jsx(Ne,{size:18})})]}),t.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Ð˜Ð· Ð´Ñ€ÑƒÐ·ÐµÐ¹"},{key:"eblid",label:"ÐŸÐ¾ EBLID"}].map(e=>{const n=Ge===e.key;return t.jsx("button",{className:"btn btn-ghost",onClick:()=>Ln(e.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:e.label},e.key)})}),t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:Ge==="friends"?"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ Ð² ÑÑ‚Ñƒ Ð±ÐµÑÐµÐ´Ñƒ.":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ EBLID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±ÐµÑÐµÐ´Ñƒ."}),Ge==="friends"?t.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:ur.length===0?t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ."}):ur.map(e=>{const n=e.friend,s=Wt.includes(n.id);return t.jsxs("div",{className:"tile",onClick:()=>Rn(r=>s?r.filter(o=>o!==n.id):[...r,n.id]),style:{cursor:"pointer",borderColor:s?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:n.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":rs(n)})]}),t.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:s?"var(--brand-600)":"transparent"}})]},e.id)})}):t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(e=>t.jsx("input",{ref:Ot[e],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:As[e],onChange:n=>vi(e,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},e))}),Fr&&t.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñâ€¦"}),re&&t.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[t.jsx(se,{name:re.displayName??re.username,id:re.id,presence:re.status,avatarUrl:re.avatarUrl??void 0}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:re.displayName??re.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:mn.alreadyInChat?"Ð£Ð¶Ðµ Ð² Ð±ÐµÑÐµÐ´Ðµ":mn.isSelf?"Ð­Ñ‚Ð¾ Ð²Ñ‹":"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]})]}),!re&&Rs&&t.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:Rs})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[t.jsx("button",{className:"btn btn-secondary",onClick:dt,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:Es||(Ge==="friends"?Wt.length===0:!re||mn.alreadyInChat||mn.isSelf),onClick:Ge==="friends"?yi:xi,children:Es?"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ...":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]})}),te.open&&te.conversationId&&t.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Ht({open:!1,x:0,y:0,conversationId:null}),children:t.jsx("div",{ref:Ss,className:"msg-menu",style:{position:"absolute",left:te.x,top:te.y},onClick:e=>e.stopPropagation(),children:(()=>{const n=(B.data||[]).find(o=>o.conversation.id===te.conversationId)?.conversation||(i===te.conversationId?w:null),s=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),r=async()=>{try{s?await z.delete(`/conversations/${te.conversationId}/participants/me`):await z.delete(`/conversations/${te.conversationId}`),D.invalidateQueries({queryKey:["conversations"]}),i===te.conversationId&&(d(null),A&&je("list"))}catch{}Ht({open:!1,x:0,y:0,conversationId:null})};return t.jsxs("button",{onClick:r,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[s?t.jsx(Lr,{size:16}):t.jsx(Ua,{size:16}),s?"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ"]})})()})}),Or&&w&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>Bt(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Bt(!1),children:t.jsx(Ne,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:w.title?.trim()?.charAt(0)||"Ð“",id:w.id,avatarUrl:ye??w.avatarUrl??void 0,size:60}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:w.title||"Ð“Ñ€ÑƒÐ¿Ð¿Ð°"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),t.jsx("input",{ref:Ws,type:"file",accept:"image/*",onChange:e=>{const n=e.target.files?.[0];if(n){cn(n);try{an(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!ye&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{onClick:()=>Ws.current?.click(),onDragOver:e=>{e.preventDefault(),qn(!0)},onDragLeave:()=>qn(!1),onDrop:e=>{e.preventDefault(),qn(!1);const n=e.dataTransfer.files?.[0];if(n){cn(n);try{an(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Os?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Os?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(ds,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),ye&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:Oe,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,s=Math.max(.1,Math.min(10,_.scale*(1+n))),r=Oe.current?.getBoundingClientRect();if(r){const o=e.clientX-r.left,a=e.clientY-r.top,l=s/_.scale,p=o-(o-_.x)*l,u=a-(a-_.y)*l;Ie({x:p,y:u,scale:s})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=Oe.current?.getBoundingClientRect();if(!n)return;const s=n.width,r=n.height,o=s/2,a=r/2,p=240/2,u=e.clientX-n.left,h=e.clientY-n.top,x=u-o,y=h-a;if(x*x+y*y>p*p)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,j=e.clientY,v={..._},I=L=>{L.preventDefault();const N=L.clientX-g,O=L.clientY-j;Ie({...v,x:v.x+N,y:v.y+O})},R=()=>{window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",R)};window.addEventListener("pointermove",I,{passive:!1}),window.addEventListener("pointerup",R,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:sn,src:ye,alt:"preview",style:{position:"absolute",left:_.x,top:_.y,transform:`scale(${_.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,s=Oe.current;if(!s)return;const r=s.clientWidth,o=s.clientHeight,a=240,l=n.naturalWidth,p=n.naturalHeight,u=r/2,h=o/2,x=a/l,y=a/p,g=Math.max(x,y)*1.2,j=u-l*g/2,v=h-p*g/2;Ie({x:j,y:v,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(_.scale*100),"%"]})]}),t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ie(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:10,step:.01,value:_.scale,onChange:e=>{const n=parseFloat(e.target.value);Ie(s=>{const r=Oe.current?.getBoundingClientRect();if(!r)return{...s,scale:n};const o=r.width,a=r.height,l=o/2,p=a/2,u=sn.current;if(u){const h=u.naturalWidth,x=u.naturalHeight,y=s.x+h*s.scale/2,g=s.y+x*s.scale/2,j=y-l,v=g-p,I=n/s.scale,R=l+j*I,L=p+v*I,N=R-h*n/2,O=L-x*n/2;return{x:N,y:O,scale:n}}return{...s,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ie(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]})]}),t.jsx("canvas",{ref:rn,width:240,height:240,style:{display:"none"}})]}),on&&t.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>{cn(null),ye&&URL.revokeObjectURL(ye),an(null),Ie({x:0,y:0,scale:1})},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:ot,onClick:async()=>{if(!(!on||!w)){Jt(!0),nn(0);try{let e=null;if(rn.current&&ye){const r=await new Promise(v=>{const I=new Image;I.onload=()=>v(I),I.src=ye}),o=rn.current.getContext("2d");if(!o)throw new Error("Could not get 2d context from canvas");const a=240;o.clearRect(0,0,a,a),o.save(),o.beginPath(),o.arc(a/2,a/2,a/2,0,Math.PI*2),o.closePath(),o.clip();const l=Oe.current?.clientWidth??320,p=Oe.current?.clientHeight??320,u={x:l/2,y:p/2},h={x:u.x-a/2,y:u.y-a/2,w:a,h:a},x=(h.x-_.x)/_.scale,y=(h.y-_.y)/_.scale,g=h.w/_.scale,j=h.h/_.scale;o.drawImage(r,x,y,g,j,0,0,a,a),o.restore(),e=await new Promise(v=>rn.current.toBlob(I=>v(I),"image/png"))}if(!e&&!on)throw new Error("No file to upload");const n=new FormData;n.append("file",e??on);const s=await new Promise((r,o)=>{const a=new XMLHttpRequest;a.open("POST","/api/upload");try{const l=mt.getState().session?.accessToken;l&&a.setRequestHeader("Authorization",`Bearer ${l}`)}catch{}a.upload.onprogress=l=>{l.lengthComputable&&nn(Math.round(100*l.loaded/l.total))},a.onreadystatechange=()=>{if(a.readyState===4)if(a.status>=200&&a.status<300)try{const l=JSON.parse(a.responseText);r(l.url)}catch(l){o(l)}else o(new Error(`upload failed: ${a.status} ${a.statusText}`))},a.onerror=()=>{o(new Error("Network error during upload"))},a.send(n)});await z.patch(`/conversations/${w.id}`,{avatarUrl:s}),D.setQueryData(["conversations"],r=>Array.isArray(r)?r.map(o=>o.conversation?.id===w.id?{...o,conversation:{...o.conversation,avatarUrl:s}}:o):r),D.invalidateQueries({queryKey:["conversations"]}),await B.refetch(),cn(null),ye&&URL.revokeObjectURL(ye),an(null),Ie({x:0,y:0,scale:1}),Bt(!1),ct("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ct(null),2200)}catch(e){console.error("Error uploading group avatar:",e),ct(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${e instanceof Error?e.message:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}`),setTimeout(()=>ct(null),3e3)}finally{Jt(!1)}}},children:ot?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),ot&&t.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:t.jsx("div",{style:{width:`${Bs}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),ln&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[t.jsx(Rr,{size:16}),t.jsx("span",{children:ln})]})]})})]})}function Ur(i){return(i??[]).map(d=>d.user.id).sort().join(",")}export{wo as default};
