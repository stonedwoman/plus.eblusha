import{d as w,r as c,c as m,u as f,j as t}from"./vendor-query-CNP5Hy5J.js";import{v as b,I,J as S,d as o}from"./index-DFPrICts.js";import{A as C,P as N}from"./ProfileOverlay-DV3fK1pB.js";import"./vendor-react-BcTlWpV0.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-GGjuBpPe.js";function L(){const a=w(),[l,y]=c.useState("accepted"),[v,x]=c.useState(!1),[n,r]=c.useState(()=>({open:!1,user:null,contact:null}));c.useEffect(()=>{const e=()=>x(typeof window<"u"?window.innerWidth<=768:!1);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const g=m({queryKey:["contacts",l],queryFn:async()=>(await o.get("/contacts",{params:{filter:l}})).data.contacts}),h=m({queryKey:["me-info"],queryFn:async()=>(await o.get("/status/me")).data.user}),u=f({mutationFn:async e=>{await o.post("/contacts/add",{identifier:e})},onSuccess:()=>{a.invalidateQueries({queryKey:["contacts"]})}}),d=f({mutationFn:async e=>{await o.post("/contacts/respond",e)},onSuccess:()=>{a.invalidateQueries({queryKey:["contacts"]})}});c.useEffect(()=>{b();const e=()=>a.invalidateQueries({queryKey:["contacts"]}),i=()=>a.invalidateQueries({queryKey:["contacts"]});I(e),S(i)},[a]);const j=e=>{e.preventDefault();const i=new FormData(e.currentTarget),s=String(i.get("identifier")??"");s&&(u.mutate(s),e.currentTarget.reset())};return t.jsxs("div",{className:"contacts-page",children:[t.jsxs("header",{children:[t.jsx("h2",{children:"Контакты"}),t.jsx("div",{style:{display:"flex",gap:8},children:t.jsxs("select",{value:l,onChange:e=>y(e.target.value),children:[t.jsx("option",{value:"accepted",children:"Друзья"}),t.jsx("option",{value:"incoming",children:"Входящие"}),t.jsx("option",{value:"outgoing",children:"Исходящие"}),t.jsx("option",{value:"all",children:"Все"})]})}),t.jsxs("form",{onSubmit:j,children:[t.jsx("input",{name:"identifier",placeholder:"ID / ник / email",required:!0}),t.jsx("button",{type:"submit",disabled:u.isPending,children:"Добавить"})]})]}),t.jsx("ul",{children:g.data?.map(e=>t.jsx("li",{style:{listStyle:"none"},children:t.jsxs("div",{className:"contacts-nav-item",style:{cursor:"default"},children:[t.jsx("button",{type:"button",onClick:i=>{i.preventDefault(),i.stopPropagation();const s=e.friend;r(p=>p.open&&p.user?.id===s.id?{open:!1,user:null,contact:null}:{open:!0,user:s,contact:e})},style:{padding:0,border:0,background:"transparent",cursor:"pointer"},"aria-label":"Открыть профиль",children:t.jsx(C,{name:e.friend.displayName??e.friend.username,id:e.friend.id,presence:e.friend.status,avatarUrl:e.friend.avatarUrl??void 0})}),t.jsxs("div",{className:"contacts-nav-item__main",children:[t.jsx("div",{className:"contacts-nav-item__name-row",children:t.jsx("div",{className:"contacts-nav-item__name",children:e.friend.displayName??e.friend.username})}),t.jsx("div",{className:"contacts-nav-item__status",style:{textTransform:"lowercase"},children:e.status.toLowerCase()})]}),e.status==="PENDING"&&e.direction==="outgoing"&&t.jsx("div",{style:{marginLeft:"auto",color:"var(--text-muted)",fontSize:13},children:"ожидание…"})]})},e.id))}),t.jsx(N,{open:n.open,isMobile:v,user:n.user,meId:h.data?.id??null,statusText:n.user?n.user.status==="IN_CALL"?"В ЗВОНКЕ":(n.user.status||"").toString():"",idLabel:n.user?.eblid?"EBLID":"ID",idValue:(n.user?.eblid??n.user?.id??"").toString(),isContact:!0,canBlock:!!n.contact?.id,contactRequest:{incoming:!!(n.contact&&n.contact.status==="PENDING"&&n.contact.direction==="incoming")},secret:{enabled:!1,canOpen:!1},commonGroups:[],onClose:()=>r({open:!1,user:null,contact:null}),onAcceptContact:()=>{const e=n.contact;e?.id&&(d.mutate({contactId:e.id,action:"accept"}),r({open:!1,user:null,contact:null}))},onRejectContact:()=>{const e=n.contact;e?.id&&(d.mutate({contactId:e.id,action:"reject"}),r({open:!1,user:null,contact:null}))},onCopyId:async()=>{const e=(n.user?.eblid??n.user?.id??"").toString();if(e)try{await navigator.clipboard.writeText(e)}catch{}},onWrite:async()=>{const e=n.user?.id;if(!e)return;const s=(await o.post("/conversations",{participantIds:[e],isGroup:!1}))?.data?.conversation?.id;if(s)try{window.localStorage.setItem("eblusha:last-active-conversation",s)}catch{}window.location.assign("/")},onRemoveContact:async()=>{const e=n.contact;e?.id&&(await o.post("/contacts/remove",{contactId:e.id}),a.invalidateQueries({queryKey:["contacts"]}),r({open:!1,user:null,contact:null}))},onBlock:async()=>{const e=n.contact;e?.id&&(await o.post("/contacts/respond",{contactId:e.id,action:"block"}),a.invalidateQueries({queryKey:["contacts"]}),r({open:!1,user:null,contact:null}))}})]})}export{L as default};
