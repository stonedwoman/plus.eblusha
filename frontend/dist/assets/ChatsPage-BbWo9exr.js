const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-Sz7Ay74W.js","assets/vendor-query-CNP5Hy5J.js","assets/vendor-react-BcTlWpV0.js","assets/index-g7jd-lEN.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-GGjuBpPe.js","assets/index-DWmkowQ-.css","assets/index-BRAGuiMP.js","assets/index-DcBnOcQS.css"])))=>i.map(i=>d[i]);
import{e as br,f as zo,g as wr,h as Ca,n as jn,d as ie,i as Po,_ as Xa,s as He,u as er,j as Uo,k as Sa,o as Ho,l as Wo,m as ka,p as Ia,q as Ma,t as _o,v as Bo,w as $o,x as Oo,y as Fo,z as Xo,A as Yo,B as Go,D as qo,E as Vo,F as Ko,G as Qo,H as Jo,I as Zo,J as ec,K as tc,L as Or,M as Ra,P as nc,Q as rc,R as sc,S as ic,T as ac,U as Ea}from"./index-g7jd-lEN.js";import{r as o,j as e,c as yr,d as oc}from"./vendor-query-CNP5Hy5J.js";const cc=a=>a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),lc=a=>a.replace(/^([A-Z])|[\s-_]+(\w)/g,(l,h,y)=>y?y.toUpperCase():h.toLowerCase()),Aa=a=>{const l=lc(a);return l.charAt(0).toUpperCase()+l.slice(1)},Ya=(...a)=>a.filter((l,h,y)=>!!l&&l.trim()!==""&&y.indexOf(l)===h).join(" ").trim(),dc=a=>{for(const l in a)if(l.startsWith("aria-")||l==="role"||l==="title")return!0};var uc={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const hc=o.forwardRef(({color:a="currentColor",size:l=24,strokeWidth:h=2,absoluteStrokeWidth:y,className:m="",children:k,iconNode:x,...R},K)=>o.createElement("svg",{ref:K,...uc,width:l,height:l,stroke:a,strokeWidth:y?Number(h)*24/Number(l):h,className:Ya("lucide",m),...!k&&!dc(R)&&{"aria-hidden":"true"},...R},[...x.map(([A,O])=>o.createElement(A,O)),...Array.isArray(k)?k:[k]]));const xe=(a,l)=>{const h=o.forwardRef(({className:y,...m},k)=>o.createElement(hc,{ref:k,iconNode:l,className:Ya(`lucide-${cc(Aa(a))}`,`lucide-${a}`,y),...m}));return h.displayName=Aa(a),h};const fc=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],pc=xe("arrow-left",fc);const gc=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],mc=xe("bell-ring",gc);const yc=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],xc=xe("check",yc);const vc=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],bc=xe("chevron-left",vc);const wc=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],jc=xe("chevron-right",wc);const Cc=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ta=xe("circle-check-big",Cc);const Sc=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],kc=xe("circle-plus",Sc);const Ic=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],fi=xe("cloud-upload",Ic);const Mc=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Rc=xe("copy",Mc);const Ec=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],xr=xe("ellipsis-vertical",Ec);const Ac=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],Tc=xe("lock-open",Ac);const Nc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],pi=xe("lock",Nc);const Dc=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],gi=xe("log-out",Dc);const Lc=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Na=xe("maximize-2",Lc);const zc=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Pc=xe("mic",zc);const Uc=[["path",{d:"M5 12h14",key:"1ays0h"}]],Hc=xe("minus",Uc);const Wc=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],_c=xe("paperclip",Wc);const Bc=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],mi=xe("phone-off",Bc);const $c=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],yi=xe("phone",$c);const Oc=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Fc=xe("reply",Oc);const Xc=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Da=xe("rotate-ccw",Xc);const Yc=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],La=xe("send",Yc);const Gc=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],za=xe("square-pen",Gc);const qc=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Vc=xe("square",qc);const Kc=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Pa=xe("trash-2",Kc);const Qc=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],Ua=xe("undo-2",Qc);const Jc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ha=xe("user-plus",Jc);const Zc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],el=xe("users",Zc);const tl=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],xi=xe("video",tl);const nl=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Lt=xe("x",nl);async function Wa(a={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const l=a.audio!==!1,h=!!a.video;if(!l&&!h)return{ok:!0};const y={audio:l,video:h};let m=null;try{return m=await navigator.mediaDevices.getUserMedia(y),{ok:!0}}catch(k){return{ok:!1,error:k??new Error("Unknown media error")}}finally{m&&m.getTracks().forEach(k=>{try{k.stop()}catch{}})}}function Ps(a){if(!a)return null;if(a.startsWith("blob:")||a.startsWith("data:")||a.startsWith("/"))return a;let l;try{l=new URL(a)}catch{return a}if(l.pathname.startsWith("/api/files/"))return`${l.pathname}${l.search||""}${l.hash||""}`;const h=l.pathname.split("/").filter(Boolean).map(m=>encodeURIComponent(decodeURIComponent(m))).join("/");if(!h)return a;const y=`${l.search||""}${l.hash||""}`;return`/api/files/${h}${y}`}function rl(a){let l=0;for(let x=0;x<a.length;x++)l=a.charCodeAt(x)+((l<<5)-l);const h=Math.abs(l),y=24+h%18-9,m=60+h%15,k=30+h%12;return`hsl(${y} ${m}% ${k}%)`}const sl=3,vi=[500,1500,3e3];function nt({name:a,size:l=40,id:h=a,presence:y,avatarUrl:m}){const k=rl(h),x=(a||"?").trim().charAt(0).toUpperCase(),R=!!m?.startsWith("emoji:"),K=R?m.slice(6):null,[A,O]=o.useState(!1),[_,Q]=o.useState(0),[he,T]=o.useState(null),G=o.useRef(null),U=o.useMemo(()=>{if(!m||R)return m??null;if(m.startsWith("data:")||typeof window>"u")return m;const pe=Ps(m);if(pe&&pe!==m)return pe;try{if(m.startsWith("http://")||m.startsWith("https://"))return m;const ge=window.location,ae=new URL(m,ge.origin);return ae.host===ge.host&&ae.protocol!==ge.protocol&&(ae.protocol=ge.protocol),ae.toString()}catch{return m}},[m,R]),fe=o.useMemo(()=>{if(!y)return null;switch(y){case"ONLINE":return"#22c55e";case"IN_CALL":return"#ef4444";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[y]);o.useEffect(()=>{O(!1),Q(0),T(null),G.current&&(clearTimeout(G.current),G.current=null)},[m]),o.useEffect(()=>{U&&!R&&T(U)},[U,R]);const Se=()=>{if(_<sl&&U&&!R){const pe=vi[_]||vi[vi.length-1];G.current=setTimeout(()=>{try{if(U.startsWith("data:"))T(U);else{const ge=new URL(U,typeof window<"u"?window.location.origin:void 0);ge.searchParams.set("_retry",String(_+1)),ge.searchParams.set("_t",String(Date.now())),T(ge.toString())}Q(ge=>ge+1)}catch(ge){console.warn("[Avatar] Failed to parse URL for retry:",U,ge),T(U),Q(ae=>ae+1)}},pe)}else O(!0)};o.useEffect(()=>()=>{G.current&&clearTimeout(G.current)},[]);const dt=he&&!R&&!A;return e.jsxs("div",{style:{width:l,height:l,borderRadius:"50%",background:k,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[dt?e.jsx("img",{src:he,alt:a,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:Se,onLoad:()=>{_>0&&Q(0)}}):R?e.jsx("span",{style:{fontSize:Math.floor(l*.6)},children:K}):x,fe&&e.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(l*.28)),height:Math.max(8,Math.floor(l*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:fe}})]})}const bi=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],wi=[4,8,14],Jt=24,dn=80;function il({open:a,image:l,onClose:h,onApply:y}){const[m,k]=o.useState(null),[x,R]=o.useState({width:0,height:0}),[K,A]=o.useState(1),[O,_]=o.useState({x:0,y:0}),[Q,he]=o.useState({width:0,height:0}),[T,G]=o.useState({x:0,y:0,width:0,height:0}),[U,fe]=o.useState("crop"),[Se,dt]=o.useState(bi[0]),[pe,ge]=o.useState(wi[1]),[ae,Pe]=o.useState([]),[Te,Ne]=o.useState(null),[zt,bt]=o.useState(()=>typeof window<"u"&&window.innerWidth<=768),[be,rt]=o.useState(!1),st=o.useRef(null),ut=o.useRef(null),Re=o.useRef(null),J=o.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),Ee=o.useRef(null),qt=o.useRef(null),Zt=o.useRef(null),ht=a&&!!l&&!!m&&x.width>0&&x.height>0;o.useEffect(()=>{const g=()=>bt(window.innerWidth<=768);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]);const wt=async()=>{if(!m||!Re.current||be)return;rt(!0);const g=T.width/T.height,N=Math.max(T.x,O.x),M=Math.max(T.y,O.y),Z=Math.min(T.x+T.width,O.x+Q.width),L=Math.min(T.y+T.height,O.y+Q.height),ee=Z-N,ne=L-M,P=m.naturalWidth/Q.width,we=m.naturalHeight/Q.height;let Oe=(N-O.x)*P,je=(M-O.y)*we,De=ee*P,_e=ne*we;De/_e>g?De=_e*g:_e=De/g;const en=m.naturalWidth,fn=m.naturalHeight;let Ct=Math.max(0,Oe),pn=Math.max(0,je),I=Math.max(1,Math.min(De,en-Ct)),at=Math.max(1,Math.min(_e,fn-pn));const Rt=I/at;Math.abs(Rt-g)>.01&&(Rt>g?I=at*g:at=I/g,I=Math.max(1,Math.min(I,en-Ct)),at=Math.max(1,Math.min(at,fn-pn)));const Ut=document.createElement("canvas"),Be=Math.max(1,Math.round(I)),Kt=Math.max(1,Math.round(at));Ut.width=Be,Ut.height=Kt;const ke=Ut.getContext("2d");if(!ke){rt(!1);return}ke.drawImage(m,Ct,pn,I,at,0,0,Be,Kt);const Ht=Be/ee,Et=Kt/ne;ke.lineCap="round",ke.lineJoin="round";const Wt=[...ae,...Te?[Te]:[]];for(const yt of Wt){if(!yt.points.length)continue;ke.strokeStyle=yt.color,ke.lineWidth=yt.size*((Ht+Et)/2),ke.beginPath();const xt=yt.points[0],Fe=(xt.x-N)*Ht,Ce=(xt.y-M)*Et;ke.moveTo(Fe,Ce);for(let vt=1;vt<yt.points.length;vt++){const At=yt.points[vt];ke.lineTo((At.x-N)*Ht,(At.y-M)*Et)}ke.stroke()}const Ve=new Image;Ve.src=Ut.toDataURL(),await new Promise(yt=>{Ve.onload=()=>{k(Ve);const xt=Ve.naturalWidth/Ve.naturalHeight;let Fe,Ce;if(zt){const St=window.innerWidth,Xe=window.innerHeight-200-60,Tt=St;xt>Tt/Xe?(Fe=Tt,Ce=Tt/xt):(Ce=Xe,Fe=Xe*xt)}else{const St=Math.min(window.innerWidth-64,720),Ke=Math.min(window.innerHeight-200,520);xt>St/Ke?(Fe=Math.max(280,St),Ce=Fe/xt):(Ce=Math.max(220,Ke),Fe=Ce*xt)}R({width:Fe,height:Ce});const vt=Fe/Ve.naturalWidth;A(vt),he({width:Fe,height:Ce}),_({x:0,y:0});const At=2,Sr=Math.max(dn,Fe-At*2),Sn=Math.max(dn,Ce-At*2);G({x:At,y:At,width:Sr,height:Sn});const tn=Fe/Be,Gr=Ce/Kt,nr=Wt.map(St=>({...St,points:St.points.map(Ke=>{const nn=(Ke.x-N)*Ht,Ir=(Ke.y-M)*Et,Xe=nn*tn,Tt=Ir*Gr;return{x:Xe,y:Tt}})}));Pe(nr.filter(St=>St.points.every(Ke=>Ke.x>=0&&Ke.x<=Fe&&Ke.y>=0&&Ke.y<=Ce))),Ne(null),setTimeout(()=>{z()},0);const qr=performance.now(),kr=300,rr=St=>{const Ke=St-qr;Math.min(Ke/kr,1)<1?Zt.current=requestAnimationFrame(rr):(rt(!1),Zt.current=null,setTimeout(()=>{z()},0))};Zt.current=requestAnimationFrame(rr),yt()}})};o.useEffect(()=>()=>{Zt.current&&cancelAnimationFrame(Zt.current)},[]),o.useEffect(()=>{if(!a||!l){k(null),Pe([]),Ne(null),rt(!1);return}const g=new Image;return g.crossOrigin="anonymous",g.onload=()=>{if(k(g),zt){const N=window.innerWidth,ee=window.innerHeight-200-60,ne=N;let P=g.naturalWidth,we=g.naturalHeight;const Oe=ne/P,je=ee/we,De=Math.min(Oe,je);P=g.naturalWidth*De,we=g.naturalHeight*De,R({width:ne,height:ee}),A(De),he({width:P,height:we});const _e={x:(ne-P)/2,y:(ee-we)/2};_(_e);const jt=2;G({x:jt,y:jt,width:ne-jt*2,height:ee-jt*2})}else{const N=Math.min(window.innerWidth-64,720),M=Math.min(window.innerHeight-200,520);let Z=g.naturalWidth,L=g.naturalHeight;if(Z>N){const je=N/Z;Z*=je,L*=je}if(L>M){const je=M/L;Z*=je,L*=je}Z=Math.max(280,Z),L=Math.max(220,L),R({width:Z,height:L});const ee=Math.max(Z/g.naturalWidth,L/g.naturalHeight);A(ee);const ne=g.naturalWidth*ee,P=g.naturalHeight*ee;he({width:ne,height:P});const we={x:(Z-ne)/2,y:(L-P)/2};_(we);const Oe=2;G({x:Oe,y:Oe,width:Z-Oe*2,height:L-Oe*2})}Pe([]),Ne(null),fe("crop"),rt(!1)},g.src=l.previewUrl,qt.current=()=>{g.src=""},()=>{qt.current?.(),qt.current=null}},[a,l?.id,l?.previewUrl,zt]),o.useEffect(()=>{a||(Pe([]),Ne(null),rt(!1))},[a]);const z=()=>{const g=ut.current;if(!g||x.width===0||x.height===0)return;const N=g.getContext("2d");if(!N)return;const M=window.devicePixelRatio||1;(g.width!==x.width*M||g.height!==x.height*M)&&(g.width=x.width*M,g.height=x.height*M,g.style.width=`${x.width}px`,g.style.height=`${x.height}px`),N.save(),N.scale(M,M),N.clearRect(0,0,x.width,x.height);const Z=Te?[...ae,Te]:ae;N.lineCap="round",N.lineJoin="round";for(const L of Z)if(L.points.length!==0){N.strokeStyle=L.color,N.lineWidth=L.size,N.beginPath(),N.moveTo(L.points[0].x,L.points[0].y);for(let ee=1;ee<L.points.length;ee++)N.lineTo(L.points[ee].x,L.points[ee].y);N.stroke()}N.restore()};o.useEffect(()=>{z()},[ae,Te,x.width,x.height]),o.useEffect(()=>{const g=N=>{a&&N.key==="Escape"&&(N.preventDefault(),h())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[a,h]);const B=(g,N,M)=>{const L=Jt/2;return Math.abs(g-M.x)<L&&Math.abs(N-M.y)<L?"nw":Math.abs(g-(M.x+M.width))<L&&Math.abs(N-M.y)<L?"ne":Math.abs(g-M.x)<L&&Math.abs(N-(M.y+M.height))<L?"sw":Math.abs(g-(M.x+M.width))<L&&Math.abs(N-(M.y+M.height))<L?"se":Math.abs(g-M.x)<L&&N>=M.y&&N<=M.y+M.height?"w":Math.abs(g-(M.x+M.width))<L&&N>=M.y&&N<=M.y+M.height?"e":Math.abs(N-M.y)<L&&g>=M.x&&g<=M.x+M.width?"n":Math.abs(N-(M.y+M.height))<L&&g>=M.x&&g<=M.x+M.width?"s":g>=M.x&&g<=M.x+M.width&&N>=M.y&&N<=M.y+M.height?"move":null},q=g=>{const ee=x.width-2,ne=x.height-2,P=Math.max(2,Math.min(ee-g.width,g.x)),we=Math.max(2,Math.min(ne-g.height,g.y)),Oe=Math.max(dn,Math.min(ee-P,g.width)),je=Math.max(dn,Math.min(ne-we,g.height));return{x:P,y:we,width:Oe,height:je}},ye=g=>{if(U!=="crop"||be||!st.current)return;g.preventDefault();const N=st.current.getBoundingClientRect(),M=g.clientX-N.left,Z=g.clientY-N.top,L=B(M,Z,T);L&&(st.current.setPointerCapture(g.pointerId),J.current={type:L==="move"?"move":"resize",handle:L!=="move"?L:void 0,startX:g.clientX,startY:g.clientY,initial:{...T}})},$e=g=>{if(U!=="crop"||!J.current.type||be||(g.preventDefault(),!st.current?.getBoundingClientRect()))return;const M=g.clientX-J.current.startX,Z=g.clientY-J.current.startY,L=M,ee=Z;if(J.current.type==="move"){const ne={x:J.current.initial.x+L,y:J.current.initial.y+ee,width:J.current.initial.width,height:J.current.initial.height};G(q(ne))}else if(J.current.type==="resize"&&J.current.handle){const ne=J.current.handle;let P={...J.current.initial};ne==="nw"?(P.x=J.current.initial.x+L,P.y=J.current.initial.y+ee,P.width=J.current.initial.width-L,P.height=J.current.initial.height-ee):ne==="ne"?(P.y=J.current.initial.y+ee,P.width=J.current.initial.width+L,P.height=J.current.initial.height-ee):ne==="sw"?(P.x=J.current.initial.x+L,P.width=J.current.initial.width-L,P.height=J.current.initial.height+ee):ne==="se"?(P.width=J.current.initial.width+L,P.height=J.current.initial.height+ee):ne==="n"?(P.y=J.current.initial.y+ee,P.height=J.current.initial.height-ee):ne==="s"?P.height=J.current.initial.height+ee:ne==="w"?(P.x=J.current.initial.x+L,P.width=J.current.initial.width-L):ne==="e"&&(P.width=J.current.initial.width+L),P.width<dn&&((ne==="nw"||ne==="w"||ne==="sw")&&(P.x=J.current.initial.x+J.current.initial.width-dn),P.width=dn),P.height<dn&&((ne==="nw"||ne==="n"||ne==="ne")&&(P.y=J.current.initial.y+J.current.initial.height-dn),P.height=dn),G(q(P))}},Ae=async g=>{const N=J.current.type!==null;J.current.type&&st.current?.hasPointerCapture(g.pointerId)&&st.current.releasePointerCapture(g.pointerId),J.current.type=null,N&&U==="crop"&&!be&&await wt()},We=g=>{if(U!=="draw"||!ut.current||be)return;g.preventDefault();const N=ut.current.getBoundingClientRect(),M={x:g.clientX-N.left,y:g.clientY-N.top},Z={color:Se,size:pe,points:[M]};Ee.current=g.pointerId,ut.current.setPointerCapture(g.pointerId),Ne(Z)},it=g=>{if(U!=="draw"||Ee.current!==g.pointerId||!ut.current)return;g.preventDefault();const N=ut.current.getBoundingClientRect(),M={x:g.clientX-N.left,y:g.clientY-N.top};Ne(Z=>!Z||Z.points.length&&Z.points[Z.points.length-1].x===M.x&&Z.points[Z.points.length-1].y===M.y?Z:{...Z,points:[...Z.points,M]})},Mt=g=>{U!=="draw"||Ee.current!==g.pointerId||(Ee.current=null,ut.current?.hasPointerCapture(g.pointerId)&&ut.current.releasePointerCapture(g.pointerId),Ne(N=>{if(!N)return null;if(N.points.length<2){const M={...N,points:[...N.points,N.points[0]]};Pe(Z=>[...Z,M])}else Pe(M=>[...M,N]);return null}))},Pt=()=>{Pe(g=>g.slice(0,-1))},Vt=()=>{Pe([]),Ne(null)},tr=async()=>{if(!m||be)return;const g=new Image;g.crossOrigin="anonymous",await new Promise(N=>{g.onload=()=>{if(k(g),zt){const M=window.innerWidth,ne=window.innerHeight-200-60,P=M;let we=g.naturalWidth,Oe=g.naturalHeight;const je=P/we,De=ne/Oe,_e=Math.min(je,De),jt=we*_e,en=Oe*_e;R({width:P,height:ne}),A(_e),he({width:jt,height:en});const fn={x:(P-jt)/2,y:(ne-en)/2};_(fn);const Ct=2;G({x:Ct,y:Ct,width:P-Ct*2,height:ne-Ct*2})}else{const M=Math.min(window.innerWidth-64,720),Z=Math.min(window.innerHeight-200,520);let L=g.naturalWidth,ee=g.naturalHeight;if(L>M){const De=M/L;L*=De,ee*=De}if(ee>Z){const De=Z/ee;L*=De,ee*=De}L=Math.max(280,L),ee=Math.max(220,ee),R({width:L,height:ee});const ne=Math.max(L/g.naturalWidth,ee/g.naturalHeight);A(ne);const P=g.naturalWidth*ne,we=g.naturalHeight*ne;he({width:P,height:we});const Oe={x:(L-P)/2,y:(ee-we)/2};_(Oe);const je=2;G({x:je,y:je,width:L-je*2,height:ee-je*2})}Pe([]),Ne(null),N()},g.src=l.previewUrl})},jr=async()=>{if(!l||!m)return;const g=T.width/T.height,N=Math.max(T.x,O.x),M=Math.max(T.y,O.y),Z=Math.min(T.x+T.width,O.x+Q.width),L=Math.min(T.y+T.height,O.y+Q.height),ee=Z-N,ne=L-M,P=m.naturalWidth/Q.width,we=m.naturalHeight/Q.height,Oe=(N-O.x)*P,je=(M-O.y)*we;let De=ee*P,_e=ne*we;De/_e>g?De=_e*g:_e=De/g;const en=m.naturalWidth,fn=m.naturalHeight;let Ct=Math.max(0,Oe),pn=Math.max(0,je),I=Math.max(1,Math.min(De,en-Ct)),at=Math.max(1,Math.min(_e,fn-pn));const Rt=I/at;Math.abs(Rt-g)>.01&&(Rt>g?I=at*g:at=I/g,I=Math.max(1,Math.min(I,en-Ct)),at=Math.max(1,Math.min(at,fn-pn)));const Ut=Math.max(1,Math.round(I)),Be=Math.max(1,Math.round(at)),Kt=document.createElement("canvas");Kt.width=Ut,Kt.height=Be;const ke=Kt.getContext("2d");if(!ke)return;ke.drawImage(m,Ct,pn,I,at,0,0,Ut,Be);const Ht=Ut/ee,Et=Be/ne,Wt=[...ae,...Te?[Te]:[]];ke.lineCap="round",ke.lineJoin="round";for(const Ce of Wt){if(!Ce.points.length)continue;ke.strokeStyle=Ce.color,ke.lineWidth=Ce.size*((Ht+Et)/2),ke.beginPath();const vt=Ce.points[0],At=(vt.x-N)*Ht,Sr=(vt.y-M)*Et;ke.moveTo(At,Sr);for(let Sn=1;Sn<Ce.points.length;Sn++){const tn=Ce.points[Sn];ke.lineTo((tn.x-N)*Ht,(tn.y-M)*Et)}ke.stroke()}const Ve=await new Promise(Ce=>Kt.toBlob(vt=>Ce(vt),"image/png",.96));if(!Ve)return;const yt=l.fileName?.replace(/\.[^.]+$/,"")||l.file.name.replace(/\.[^.]+$/,"")||"image",xt=new File([Ve],`${yt}-edited.png`,{type:"image/png"}),Fe=URL.createObjectURL(Ve);y({file:xt,previewUrl:Fe})},Hn=()=>{if(U!=="crop"||be)return null;const{x:g,y:N,width:M,height:Z}=T,L={position:"absolute",width:Jt,height:Jt,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{...L,left:g-Jt/2,top:N-Jt/2,cursor:"nwse-resize"}}),e.jsx("div",{style:{...L,left:g+M-Jt/2,top:N-Jt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...L,left:g-Jt/2,top:N+Z-Jt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...L,left:g+M-Jt/2,top:N+Z-Jt/2,cursor:"nwse-resize"}})]})};if(!a||!l)return null;if(zt)return br.createPortal(e.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[e.jsx("button",{onClick:h,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"}),e.jsx("button",{onClick:jr,disabled:!ht||be,style:{background:!ht||be?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:ht&&!be?"pointer":"not-allowed"},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]}),e.jsxs("div",{ref:st,onPointerDown:ye,onPointerMove:$e,onPointerUp:Ae,onPointerLeave:Ae,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:O.x,top:O.y,width:Q.width,height:Q.height,userSelect:"none",pointerEvents:"none",transition:be?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ut,style:{position:"absolute",inset:0,pointerEvents:U==="draw"?"auto":"none"},onPointerDown:We,onPointerMove:it,onPointerUp:Mt,onPointerLeave:Mt}),e.jsx("canvas",{ref:Re,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),U==="crop"&&!be&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${T.x}px 100%,
                    ${T.x}px ${T.y}px,
                    ${T.x+T.width}px ${T.y}px,
                    ${T.x+T.width}px ${T.y+T.height}px,
                    ${T.x}px ${T.y+T.height}px,
                    ${T.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:T.x,top:T.y,width:T.width,height:T.height,border:"2px solid #fff",pointerEvents:"none"}}),Hn()]})]}),e.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>fe("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:U==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{onClick:()=>fe("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:U==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[e.jsx(za,{size:18}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]})]}),e.jsxs("button",{onClick:tr,disabled:be,style:{padding:"10px",borderRadius:10,border:"none",background:be?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:be?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:be?"not-allowed":"pointer"},children:[e.jsx(Da,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),U==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:bi.map(g=>e.jsx("button",{onClick:()=>dt(g),style:{width:40,height:40,borderRadius:"50%",border:Se===g?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:g,cursor:"pointer",flexShrink:0},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:wi.map(g=>e.jsx("button",{onClick:()=>ge(g),style:{width:48,height:48,borderRadius:12,border:pe===g?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:pe===g?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{onClick:Pt,disabled:ae.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:ae.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:ae.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:ae.length===0?"not-allowed":"pointer"},children:[e.jsx(Ua,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"]}),e.jsx("button",{onClick:Vt,disabled:ae.length===0&&!Te,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:ae.length===0&&!Te?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:ae.length===0&&!Te?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:ae.length===0&&!Te?"not-allowed":"pointer"},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ"})]})]})]})]}),document.body);const Cr=e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:e.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:l.fileName||l.file.name})]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:h,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{ref:st,onPointerDown:ye,onPointerMove:$e,onPointerUp:Ae,onPointerLeave:Ae,style:{position:"relative",width:x.width,height:x.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:U==="crop"?"default":"crosshair"},children:[m&&e.jsx("img",{src:m.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:O.x,top:O.y,width:Q.width,height:Q.height,userSelect:"none",pointerEvents:"none",transition:be?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ut,style:{position:"absolute",inset:0,pointerEvents:U==="draw"?"auto":"none"},onPointerDown:We,onPointerMove:it,onPointerUp:Mt,onPointerLeave:Mt}),e.jsx("canvas",{ref:Re,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),U==="crop"&&!be&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${T.x}px 100%,
                    ${T.x}px ${T.y}px,
                    ${T.x+T.width}px ${T.y}px,
                    ${T.x+T.width}px ${T.y+T.height}px,
                    ${T.x}px ${T.y+T.height}px,
                    ${T.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:T.x,top:T.y,width:T.width,height:T.height,border:"2px solid #fff",pointerEvents:"none"}}),Hn()]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:U==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>fe("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{className:U==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>fe("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(za,{size:16}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]}),e.jsxs("button",{className:"btn btn-ghost",onClick:tr,disabled:be,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Da,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),U==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost",onClick:Pt,disabled:ae.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ua,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…"]}),e.jsx("button",{className:"btn btn-ghost",onClick:Vt,disabled:ae.length===0&&!Te,style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº"})]})]}),U==="draw"&&e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:bi.map(g=>e.jsx("button",{onClick:()=>dt(g),style:{width:28,height:28,borderRadius:"50%",border:Se===g?"2px solid #fff":"2px solid transparent",background:g,cursor:"pointer"},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:8},children:wi.map(g=>e.jsx("button",{onClick:()=>ge(g),className:pe===g?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Se,display:"inline-block"}})},g))})]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[e.jsx("button",{className:"btn btn-ghost",onClick:h,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsxs("button",{className:"btn btn-primary",onClick:jr,disabled:!ht||be,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[e.jsx(xc,{size:16}),"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"]})]})]})});return br.createPortal(Cr,document.body)}function Cn(a,l,h){return Math.min(h,Math.max(l,a))}function al({open:a,items:l,index:h,onClose:y,onIndexChange:m}){const k=o.useRef(null),x=o.useRef(null),[R,K]=o.useState({}),[A,O]=o.useState({w:0,h:0}),[_,Q]=o.useState(1),[he,T]=o.useState(0),[G,U]=o.useState(0),fe=o.useRef(null),Se=o.useRef(null),dt=o.useRef(0),pe=o.useRef(0),ge=o.useRef(null),ae=l.length,Pe=ae>1,Te=l[h]||"",Ne=Te?R[Te]:void 0,zt=o.useMemo(()=>ae<=1?24:A.w<=768?72:Math.max(140,Math.round(A.h*.2)),[ae,A.w,A.h]),bt=o.useMemo(()=>{if(!Ne||!A.w||!A.h)return{scale:1,maxX:0,maxY:0};const z=56,B=zt,q=28,ye=Math.max(0,A.w-q*2),$e=Math.max(0,A.h-z-B-q*2),We=Math.min(ye/Ne.w,$e/Ne.h,1)*_,it=Ne.w*We,Mt=Ne.h*We,Pt=Math.max(0,(it-ye)/2),Vt=Math.max(0,(Mt-$e)/2);return{scale:We,maxX:Pt,maxY:Vt}},[Ne,A.w,A.h,_,zt]),be=()=>{Pe&&m((h-1+ae)%ae)},rt=()=>{Pe&&m((h+1)%ae)},st=()=>{Q(1),T(0),U(0)};o.useEffect(()=>{if(!a)return;const z=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=z}},[a]),o.useLayoutEffect(()=>{if(!a)return;const z=()=>{const B=window.innerWidth,q=window.innerHeight;O({w:B,h:q})};return z(),window.addEventListener("resize",z),()=>window.removeEventListener("resize",z)},[a]),o.useEffect(()=>{a&&st()},[a,Te]),o.useEffect(()=>{if(!a)return;const z=B=>{B.key==="Escape"&&y(),B.key==="ArrowLeft"&&be(),B.key==="ArrowRight"&&rt(),(B.key==="+"||B.key==="=")&&Q(q=>Cn(q*1.15,1,6)),B.key==="-"&&Q(q=>Cn(q/1.15,1,6)),B.key==="0"&&st()};return window.addEventListener("keydown",z),()=>window.removeEventListener("keydown",z)},[a,h,ae,Te,y]),o.useEffect(()=>{a&&(T(z=>Cn(z,-bt.maxX,bt.maxX)),U(z=>Cn(z,-bt.maxY,bt.maxY)))},[a,bt.maxX,bt.maxY]);const ut=z=>{if(!a)return;z.preventDefault();const B=x.current?.getBoundingClientRect()??null,q=!!B&&z.clientX>=B.left&&z.clientX<=B.right&&z.clientY>=B.top&&z.clientY<=B.bottom,ye=z.deltaMode===1?z.deltaY*16:z.deltaMode===2?z.deltaY*A.h:z.deltaY;if(!q){if(!Pe)return;const it=performance.now(),Mt=260,Pt=90;if(dt.current+=ye,it-pe.current<Mt||Math.abs(dt.current)<Pt)return;pe.current=it;const Vt=dt.current>0?1:-1;dt.current=0,Vt>0?rt():be();return}const Ae=Math.exp(-ye*9e-4),We=Cn(Ae,.8,1.25);Q(it=>Cn(it*We,1,6))},Re=z=>{if(z.button!==0)return;z.currentTarget.setPointerCapture(z.pointerId);const B=_>1.01,q=x.current?.getBoundingClientRect()??null,ye=!!q&&z.clientX>=q.left&&z.clientX<=q.right&&z.clientY>=q.top&&z.clientY<=q.bottom;fe.current={active:!0,startX:z.clientX,startY:z.clientY,startTx:he,startTy:G,mode:B?"pan":"swipe",startedInsideImg:ye}},J=z=>{const B=fe.current;if(!B?.active)return;const q=z.clientX-B.startX,ye=z.clientY-B.startY;if(B.mode==="pan"){T(Cn(B.startTx+q,-bt.maxX,bt.maxX)),U(Cn(B.startTy+ye,-bt.maxY,bt.maxY));return}},Ee=z=>{const B=fe.current;if(fe.current=null,!B?.active)return;const q=z.clientX-B.startX,ye=z.clientY-B.startY;if(B.mode==="swipe"){if(Math.abs(ye)>110&&Math.abs(q)<90){y();return}if(Math.abs(q)>70&&Math.abs(ye)<60){q<0?rt():be();return}}const $e=8,Ae=Math.abs(q)<=$e&&Math.abs(ye)<=$e;if(Ae&&B.startedInsideImg){const We=performance.now(),it=ge.current,Mt=280,Pt=18;if(it&&We-it.ts<=Mt&&Math.abs(it.x-z.clientX)<=Pt&&Math.abs(it.y-z.clientY)<=Pt){ge.current=null,_<=1.01?Q(2):st();return}ge.current={ts:We,x:z.clientX,y:z.clientY};return}Ae&&!B.startedInsideImg&&(_>1.01?st():y())},qt=z=>{if(z.touches.length!==2){Se.current=null;return}z.preventDefault();const B=z.touches[0],q=z.touches[1],ye=B.clientX-q.clientX,$e=B.clientY-q.clientY,Ae=Math.sqrt(ye*ye+$e*$e),We=Se.current;if(Se.current=Ae,!We)return;const it=Ae>We?1.03:1/1.03;Q(Mt=>Cn(Mt*it,1,6))},Zt=()=>{_<=1.01?Q(2):st()};if(!a)return null;const ht=(()=>{if(ae<=13)return l.map((Ae,We)=>({u:Ae,i:We}));const B=Math.floor(13/2);let q=h-B,ye=h+B;if(q<0&&(ye+=-q,q=0),ye>ae-1){const Ae=ye-(ae-1);q=Math.max(0,q-Ae),ye=ae-1}const $e=[];for(let Ae=q;Ae<=ye;Ae++)$e.push({u:l[Ae],i:Ae});return $e})(),wt=e.jsxs("div",{className:"imglb-root",ref:k,onWheel:ut,style:{"--imglb-thumbs-h":`${zt}px`},children:[e.jsx("div",{className:"imglb-backdrop",onClick:y}),e.jsxs("div",{className:"imglb-topbar",children:[e.jsx("div",{className:"imglb-spacer","aria-hidden":"true"}),e.jsxs("div",{className:"imglb-title",children:[h+1," / ",ae]}),e.jsx("button",{className:"imglb-btn",onClick:y,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{className:"imglb-stage",onPointerDown:Re,onPointerMove:J,onPointerUp:Ee,onPointerCancel:()=>{fe.current=null},onTouchMove:qt,onDoubleClick:Zt,children:[Pe&&e.jsx("button",{className:"imglb-nav imglb-nav-left",onClick:be,"aria-label":"ÐÐ°Ð·Ð°Ð´",children:e.jsx(bc,{size:24})}),e.jsx("div",{className:"imglb-media",onClick:z=>z.stopPropagation(),children:e.jsx("div",{className:"imglb-pan",style:{transform:`translate3d(${he}px, ${G}px, 0)`},children:e.jsx("img",{ref:x,className:"imglb-img",src:Te,alt:"preview",draggable:!1,style:{width:Ne?.w?`${Ne.w}px`:void 0,height:Ne?.h?`${Ne.h}px`:void 0,transform:`scale(${bt.scale})`},onLoad:z=>{const B=z.currentTarget,q=B.naturalWidth||1,ye=B.naturalHeight||1;K($e=>({...$e,[Te]:{w:q,h:ye}}))}})})}),Pe&&e.jsx("button",{className:"imglb-nav imglb-nav-right",onClick:rt,"aria-label":"Ð’Ð¿ÐµÑ€Ñ‘Ð´",children:e.jsx(jc,{size:24})})]}),ae>1&&e.jsx("div",{className:"imglb-thumbs",onClick:z=>z.stopPropagation(),children:e.jsx("div",{className:"imglb-thumbs-inner",children:ht.map(({u:z,i:B})=>e.jsx("button",{type:"button",className:B===h?"imglb-thumb is-active":"imglb-thumb",onClick:()=>m(B),"aria-label":`ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ${B+1}`,children:e.jsx("img",{src:z,alt:"",draggable:!1})},`${z}-${B}`))})})]});return br.createPortal(wt,document.body)}const Fr=zo(a=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:l=>a({incoming:l}),startOutgoing:(l,h)=>a({activeConvId:l,incoming:null,initialVideo:!!h,initialAudio:!0}),startIncoming:l=>a({incoming:l}),endCall:()=>a({activeConvId:null,incoming:null,initialVideo:!1})}));function ol(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&a.constructor.name==="Uint8Array"}function ki(a){if(!Number.isSafeInteger(a)||a<0)throw new Error("positive integer expected, got "+a)}function Hs(a,...l){if(!ol(a))throw new Error("Uint8Array expected");if(l.length>0&&!l.includes(a.length))throw new Error("Uint8Array expected of length "+l+", got length="+a.length)}function Ii(a){if(typeof a!="function"||typeof a.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");ki(a.outputLen),ki(a.blockLen)}function Us(a,l=!0){if(a.destroyed)throw new Error("Hash instance has been destroyed");if(l&&a.finished)throw new Error("Hash#digest() has already been called")}function cl(a,l){Hs(a);const h=l.outputLen;if(a.length<h)throw new Error("digestInto() expects output buffer of length at least "+h)}function Xr(...a){for(let l=0;l<a.length;l++)a[l].fill(0)}function ji(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}function un(a,l){return a<<32-l|a>>>l}function ll(a){if(typeof a!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(a))}function Yr(a){return typeof a=="string"&&(a=ll(a)),Hs(a),a}class Ga{}function dl(a){const l=y=>a().update(Yr(y)).digest(),h=a();return l.outputLen=h.outputLen,l.blockLen=h.blockLen,l.create=()=>a(),l}class qa extends Ga{constructor(l,h){super(),this.finished=!1,this.destroyed=!1,Ii(l);const y=Yr(h);if(this.iHash=l.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const m=this.blockLen,k=new Uint8Array(m);k.set(y.length>m?l.create().update(y).digest():y);for(let x=0;x<k.length;x++)k[x]^=54;this.iHash.update(k),this.oHash=l.create();for(let x=0;x<k.length;x++)k[x]^=106;this.oHash.update(k),Xr(k)}update(l){return Us(this),this.iHash.update(l),this}digestInto(l){Us(this),Hs(l,this.outputLen),this.finished=!0,this.iHash.digestInto(l),this.oHash.update(l),this.oHash.digestInto(l),this.destroy()}digest(){const l=new Uint8Array(this.oHash.outputLen);return this.digestInto(l),l}_cloneInto(l){l||(l=Object.create(Object.getPrototypeOf(this),{}));const{oHash:h,iHash:y,finished:m,destroyed:k,blockLen:x,outputLen:R}=this;return l=l,l.finished=m,l.destroyed=k,l.blockLen=x,l.outputLen=R,l.oHash=h._cloneInto(l.oHash),l.iHash=y._cloneInto(l.iHash),l}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Mi=(a,l,h)=>new qa(a,l).update(h).digest();Mi.create=(a,l)=>new qa(a,l);function ul(a,l,h){return Ii(a),h===void 0&&(h=new Uint8Array(a.outputLen)),Mi(a,Yr(h),Yr(l))}const Ci=Uint8Array.from([0]),_a=Uint8Array.of();function hl(a,l,h,y=32){Ii(a),ki(y);const m=a.outputLen;if(y>255*m)throw new Error("Length should be <= 255*HashLen");const k=Math.ceil(y/m);h===void 0&&(h=_a);const x=new Uint8Array(k*m),R=Mi.create(a,l),K=R._cloneInto(),A=new Uint8Array(R.outputLen);for(let O=0;O<k;O++)Ci[0]=O+1,K.update(O===0?_a:A).update(h).update(Ci).digestInto(A),x.set(A,m*O),R._cloneInto(K);return R.destroy(),K.destroy(),Xr(A,Ci),x.slice(0,y)}const fl=(a,l,h,y,m)=>hl(a,ul(a,l,h),y,m);function pl(a,l,h,y){if(typeof a.setBigUint64=="function")return a.setBigUint64(l,h,y);const m=BigInt(32),k=BigInt(4294967295),x=Number(h>>m&k),R=Number(h&k),K=y?4:0,A=y?0:4;a.setUint32(l+K,x,y),a.setUint32(l+A,R,y)}function gl(a,l,h){return a&l^~a&h}function ml(a,l,h){return a&l^a&h^l&h}class yl extends Ga{constructor(l,h,y,m){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=l,this.outputLen=h,this.padOffset=y,this.isLE=m,this.buffer=new Uint8Array(l),this.view=ji(this.buffer)}update(l){Us(this),l=Yr(l),Hs(l);const{view:h,buffer:y,blockLen:m}=this,k=l.length;for(let x=0;x<k;){const R=Math.min(m-this.pos,k-x);if(R===m){const K=ji(l);for(;m<=k-x;x+=m)this.process(K,x);continue}y.set(l.subarray(x,x+R),this.pos),this.pos+=R,x+=R,this.pos===m&&(this.process(h,0),this.pos=0)}return this.length+=l.length,this.roundClean(),this}digestInto(l){Us(this),cl(l,this),this.finished=!0;const{buffer:h,view:y,blockLen:m,isLE:k}=this;let{pos:x}=this;h[x++]=128,Xr(this.buffer.subarray(x)),this.padOffset>m-x&&(this.process(y,0),x=0);for(let _=x;_<m;_++)h[_]=0;pl(y,m-8,BigInt(this.length*8),k),this.process(y,0);const R=ji(l),K=this.outputLen;if(K%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const A=K/4,O=this.get();if(A>O.length)throw new Error("_sha2: outputLen bigger than state");for(let _=0;_<A;_++)R.setUint32(4*_,O[_],k)}digest(){const{buffer:l,outputLen:h}=this;this.digestInto(l);const y=l.slice(0,h);return this.destroy(),y}_cloneInto(l){l||(l=new this.constructor),l.set(...this.get());const{blockLen:h,buffer:y,length:m,finished:k,destroyed:x,pos:R}=this;return l.destroyed=x,l.finished=k,l.length=m,l.pos=R,m%h&&l.buffer.set(y),l}clone(){return this._cloneInto()}}const Pn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),xl=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Un=new Uint32Array(64);class vl extends yl{constructor(l=32){super(64,l,8,!1),this.A=Pn[0]|0,this.B=Pn[1]|0,this.C=Pn[2]|0,this.D=Pn[3]|0,this.E=Pn[4]|0,this.F=Pn[5]|0,this.G=Pn[6]|0,this.H=Pn[7]|0}get(){const{A:l,B:h,C:y,D:m,E:k,F:x,G:R,H:K}=this;return[l,h,y,m,k,x,R,K]}set(l,h,y,m,k,x,R,K){this.A=l|0,this.B=h|0,this.C=y|0,this.D=m|0,this.E=k|0,this.F=x|0,this.G=R|0,this.H=K|0}process(l,h){for(let _=0;_<16;_++,h+=4)Un[_]=l.getUint32(h,!1);for(let _=16;_<64;_++){const Q=Un[_-15],he=Un[_-2],T=un(Q,7)^un(Q,18)^Q>>>3,G=un(he,17)^un(he,19)^he>>>10;Un[_]=G+Un[_-7]+T+Un[_-16]|0}let{A:y,B:m,C:k,D:x,E:R,F:K,G:A,H:O}=this;for(let _=0;_<64;_++){const Q=un(R,6)^un(R,11)^un(R,25),he=O+Q+gl(R,K,A)+xl[_]+Un[_]|0,G=(un(y,2)^un(y,13)^un(y,22))+ml(y,m,k)|0;O=A,A=K,K=R,R=x+he|0,x=k,k=m,m=y,y=he+G|0}y=y+this.A|0,m=m+this.B|0,k=k+this.C|0,x=x+this.D|0,R=R+this.E|0,K=K+this.F|0,A=A+this.G|0,O=O+this.H|0,this.set(y,m,k,x,R,K,A,O)}roundClean(){Xr(Un)}destroy(){this.set(0,0,0,0,0,0,0,0),Xr(this.buffer)}}const bl=dl(()=>new vl),wl=bl,jl=new TextEncoder,Cl=new TextDecoder;function Gt(a){if(!a)return new Uint8Array;const l=a.replace(/-/g,"+").replace(/_/g,"/"),h=l.length%4===0?"":"=".repeat(4-l.length%4),y=atob(l+h),m=y.length,k=new Uint8Array(m);for(let x=0;x<m;x+=1)k[x]=y.charCodeAt(x);return k}function vr(a){let l="";for(let h=0;h<a.length;h+=1)l+=String.fromCharCode(a[h]);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function Ba(a){return jl.encode(a)}function Sl(a){return Cl.decode(a)}const $a="eb_e2ee_sessions_v1";class kl{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(l){return!!this.sessions[l]}getSession(l){return this.sessions[l]??null}async ensureSession(l){if(!l.isSecret||l.secretStatus!=="ACTIVE")return null;const h=this.sessions[l.id];if(h)return h;const y=wr(),m=Ca();if(!y||!m||!l.secretInitiatorDeviceId||!l.secretPeerDeviceId||!(l.secretInitiatorDeviceId===y.deviceId))return null;const x=l.secretPeerDeviceId;return x?this.createInitiatorSession(l,y.deviceId,x,m):null}processHandshakes(l,h){if(!l.isSecret||!h||h.length===0)return!1;const y=wr();if(!y)return!1;let m=!1;for(const k of h){const R=(k?.metadata??{}).e2ee;if(!R||R.kind!=="handshake")continue;const K=R.payload;if(!K||K.recipientDeviceId!==y.deviceId)continue;const A=this.sessions[l.id];if(A&&A.peerDeviceId===K.initiatorDeviceId&&A.prekeyId===K.prekeyId)continue;this.handlePeerHandshake(l,K)&&(m=!0)}return m&&this.bumpVersion(),m}transformMessage(l,h){if(!h)return h;const y=h.metadata??{},m=y.e2ee;if(!m||m.kind!=="ciphertext")return h;const k=this.sessions[l];if(!k)return{...h,content:"ðŸ” Ð—Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¾",metadata:{...y,e2ee:{...m,decrypted:!1}}};try{const x=Gt(k.key),R=Gt(m.nonce),K=Gt(h.content||""),A=jn.secretbox.open(K,R,x);if(!A)throw new Error("Failed to decrypt");return{...h,content:Sl(A),metadata:{...y,e2ee:{...m,decrypted:!0}}}}catch(x){return console.warn("Failed to decrypt message",x),{...h,content:"ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸",metadata:{...y,e2ee:{...m,decrypted:!1,error:!0}}}}}async encryptPayload(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Gt(y.key),k=jn.randomBytes(24),x=Ba(h.content??""),R=jn.secretbox(x,k,m);return{conversationId:l.id,type:h.type,content:vr(R),replyToId:h.replyToId,metadata:{...h.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:vr(k)}}}}async encryptBinary(l,h){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const m=Gt(y.key),k=jn.randomBytes(24);return{cipher:jn.secretbox(h,k,m),nonce:vr(k)}}decryptBinary(l,h,y){const m=this.sessions[l];if(!m)throw new Error("E2EE session is not ready");const k=Gt(m.key),x=Gt(y);return jn.secretbox.open(h,x,k)}async createInitiatorSession(l,h,y,m){try{const k=await ie.post("/devices/prekeys/claim",{deviceId:y}),x=k.data?.identityKey,R=k.data?.prekey;if(!x||!R?.publicKey||!R?.keyId)throw new Error("Invalid prekey response");const K=jn.scalarMult(Gt(m.secretKey),Gt(R.publicKey)),A=jn.randomBytes(32),O=`eblusha:e2ee:${l.id}:${h}->${y}:${R.keyId}`,_=this.deriveKey(K,A,O),Q={conversationId:l.id,key:vr(_),localDeviceId:h,peerDeviceId:y,role:"initiator",prekeyId:R.keyId,hkdfInfo:O,handshakeSalt:vr(A),createdAt:Date.now()};return this.sessions[l.id]=Q,this.persist(),await this.sendHandshakeMessage(l.id,{version:1,kind:"handshake",conversationId:l.id,initiatorDeviceId:h,recipientDeviceId:y,prekeyId:R.keyId,handshakeSalt:Q.handshakeSalt,hkdfInfo:O,initiatorIdentityKey:m.publicKey,createdAt:Date.now()}),Q}catch(k){return console.error("Failed to initialize E2EE session",k),delete this.sessions[l.id],this.persist(),null}}handlePeerHandshake(l,h){if(!h?.prekeyId||!h?.initiatorIdentityKey||!h.hkdfInfo||!h.handshakeSalt||!Ca())return!1;const m=wr();if(!m)return!1;const k=Po(h.prekeyId);if(!k)return console.warn("Missing prekey secret for handshake",h.prekeyId),!1;try{const x=jn.scalarMult(Gt(k),Gt(h.initiatorIdentityKey)),R=this.deriveKey(x,Gt(h.handshakeSalt),h.hkdfInfo),K={conversationId:l.id,key:vr(R),localDeviceId:m.deviceId,peerDeviceId:h.initiatorDeviceId,role:"peer",prekeyId:h.prekeyId,hkdfInfo:h.hkdfInfo,handshakeSalt:h.handshakeSalt,createdAt:Date.now()};return this.sessions[l.id]=K,this.persist(),!0}catch(x){return console.error("Failed to handle handshake payload",x),!1}}async sendHandshakeMessage(l,h){await ie.post("/conversations/send",{conversationId:l,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:h}}})}deriveKey(l,h,y){return fl(wl,l,h,Ba(y),32)}clearSession(l){this.sessions[l]&&(delete this.sessions[l],this.persist())}load(){try{const l=localStorage.getItem($a);l&&(this.sessions=JSON.parse(l))}catch{this.sessions={}}}persist(){try{localStorage.setItem($a,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const hn=new kl;class Il{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(l={}){this.callbacks=l}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const l={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,l),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const h=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,h.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(h){console.error("Failed to setup audio analysis:",h)}this.mediaRecorder.ondataavailable=h=>{h.data.size>0&&this.audioChunks.push(h.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(h=>h.stop())},this.mediaRecorder.onerror=h=>{const y=new Error("MediaRecorder error");this.callbacks.onError?.(y)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(l){const h=l instanceof Error?l:new Error("Failed to start recording");throw this.callbacks.onError?.(h),h}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(l=>l.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let l=0;const h=50,y=m=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}if(typeof m=="number"){if(m-l<h){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y));return}l=m}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(he){console.warn("Analyser error:",he);return}let k=0,x=0;for(let he=0;he<this.dataArray.length;he++){const T=Math.abs(this.dataArray[he]-128);k=Math.max(k,T),x+=T}const R=x/this.dataArray.length,A=(k*.7+R*.3)/128*100,O=Math.min(100,A*2.5),Q=Math.max(15,O);this.callbacks.onAmplitudeUpdate?.(Q),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(y))};this.amplitudeTimer=window.requestAnimationFrame(y)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const l=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const h of l)if(MediaRecorder.isTypeSupported(h))return h;return""}cleanup(){this.cancel()}}async function Ml(a,l=60){try{const y=await(await fetch(a)).arrayBuffer(),m=new(window.AudioContext||window.webkitAudioContext),x=(await m.decodeAudioData(y)).getChannelData(0),R=Math.floor(x.length/l),K=[];for(let A=0;A<l;A++){let O=0,_=0;const Q=A*R,he=Math.min(Q+R,x.length);for(let fe=Q;fe<he;fe++){const Se=Math.abs(x[fe]);O+=Se,_=Math.max(_,Se)}const T=O/(he-Q),G=Math.max(T,_*.7),U=Math.max(20,Math.min(100,G*200));K.push(U)}return m.close(),K}catch(h){return console.error("Failed to generate waveform:",h),Array(l).fill(0).map(()=>Math.random()*40+30)}}const Si=new Map;async function Rl(a,l=60){const h=`${a}:${l}`;if(Si.has(h))return Si.get(h);const y=await Ml(a,l);return Si.set(h,y),y}const El=o.lazy(()=>Xa(()=>import("./CallOverlay-Sz7Ay74W.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(a=>({default:a.CallOverlay}))),Al=()=>Xa(()=>import("./CallOverlay-Sz7Ay74W.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),Oa="eblusha:last-active-conversation",Tl=3e4,Nl=10;function Dl({url:a,duration:l}){const[h,y]=o.useState(!1),[m,k]=o.useState(0),[x,R]=o.useState([]),[K,A]=o.useState(!0),O=o.useRef(null),_=Ps(a)||a;o.useEffect(()=>{let G=!1;return A(!0),Rl(_,60).then(U=>{G||(R(U),A(!1))}).catch(U=>{console.error("Failed to load waveform:",U),G||A(!1)}),()=>{G=!0}},[_]),o.useEffect(()=>{const G=O.current;if(!G)return;const U=()=>k(G.currentTime),fe=()=>{y(!1),k(0)},Se=()=>y(!0),dt=()=>y(!1);return G.addEventListener("timeupdate",U),G.addEventListener("ended",fe),G.addEventListener("play",Se),G.addEventListener("pause",dt),()=>{G.removeEventListener("timeupdate",U),G.removeEventListener("ended",fe),G.removeEventListener("play",Se),G.removeEventListener("pause",dt)}},[]);const Q=()=>{const G=O.current;G&&(h?G.pause():G.play().catch(U=>{console.error("Failed to play audio:",U)}))},he=G=>{const U=Math.floor(G/60),fe=Math.floor(G%60);return`${U}:${fe.toString().padStart(2,"0")}`},T=x.length>0?Math.floor(m/l*x.length):0;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[e.jsx("audio",{ref:O,src:_,preload:"metadata"}),e.jsx("button",{type:"button",onClick:Q,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":h?"ÐŸÐ°ÑƒÐ·Ð°":"Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸",children:h?e.jsx(Vc,{size:16,fill:"currentColor"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[K?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map((G,U)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${U*.1}s`}},U))}):x.length>0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:x.map((G,U)=>{const fe=U<=T,Se=Math.max(4,G/100*20);return e.jsx("div",{style:{width:2,height:`${Se}px`,background:fe?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},U)})}):e.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."}),e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[he(m)," / ",he(l)]})})]})]})}function Ll(){const[a,l]=o.useState(null),[h,y]=o.useState(null),[m,k]=o.useState(null),[x,R]=o.useState(null),K=o.useRef(null);o.useEffect(()=>{K.current=x},[x]);const A=o.useRef(null),[O,_]=o.useState(""),[Q,he]=o.useState(null),T=o.useRef(null),G=o.useRef(null),U=o.useRef(null),fe=o.useRef(null),Se=o.useRef(null),dt=o.useRef(!1),pe=o.useRef(null),ge=o.useRef(null),ae=o.useRef(!1),Pe=o.useRef(null),Te=o.useRef(null),[Ne,zt]=o.useState(!1),[bt,be]=o.useState(1),[rt,st]=o.useState(!1),ut=o.useRef(null);o.useRef({pinTimer:null});const[Re,J]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Ee,qt]=o.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Zt=o.useRef(null),[ht,wt]=o.useState(()=>({open:!1,x:0,y:0,contactId:null,user:null})),z=o.useRef(null),[B,q]=o.useState(()=>({open:!1,anchor:null})),ye=o.useRef(null),$e=o.useRef(null),[Ae,We]=o.useState(!1),[it,Mt]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Pt,Vt]=o.useState({open:!1,messageId:null}),[tr,jr]=o.useState(!1),[Hn,Cr]=o.useState([]),[g,N]=o.useState(!1),[M,Z]=o.useState("friends"),[L,ee]=o.useState(["","","",""]),ne=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[P,we]=o.useState(null),[Oe,je]=o.useState(null),[De,_e]=o.useState(!1),jt=o.useRef(0),[en,fn]=o.useState(!1),[Ct,pn]=o.useState(!1),[I,at]=o.useState(!1),Rt=o.useRef(I),[Ut,Be]=o.useState("list");o.useEffect(()=>{Rt.current=I},[I]);const[Kt,ke]=o.useState(!1),Ht=o.useRef(null);o.useRef(null);const Et=o.useRef(new Map),Wt=o.useRef(!0),Ve=o.useRef(!1),yt=o.useRef(0),xt=o.useRef(null),Fe=o.useRef(new Set),Ce=o.useRef(null);o.useRef(null);const vt=o.useRef(null),At=o.useRef(0),[Sr,Sn]=o.useState(!1),[tn,Gr]=o.useState(""),[nr,qr]=o.useState([]),[kr,rr]=o.useState(!1),[St,Ke]=o.useState(null),[nn,Ir]=o.useState(null),[Xe,Tt]=o.useState(null),[Ri,Ei]=o.useState(null),[Va,kn]=o.useState(!1),Ws=o.useRef(null),Wn=o.useRef(null),Ka=o.useRef(null),_s=o.useRef(null),[Qe,rn]=o.useState({x:0,y:0,scale:1}),[Ai,Bs]=o.useState(!1),[$s,_n]=o.useState(!1),[Bn,Mr]=o.useState(["","","",""]),Rr=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[gn,$n]=o.useState(null),[Qa,Os]=o.useState(!1),[Fs,Ja]=o.useState(""),[Za,Vr]=o.useState(!1),[sr,Kr]=o.useState(!1),[Xs,Qr]=o.useState(null),[_t,Jr]=o.useState(null),Zr=o.useRef(null),[Ie,In]=o.useState({x:0,y:0,scale:1}),[Ti,es]=o.useState(0),On=o.useRef(null),Ys=o.useRef(null),Ni=o.useRef(null),ft=o.useRef(null),Fn=o.useRef(null),Mn=o.useRef(null),ts=o.useRef(null),pt=o.useRef(null),Xn=o.useRef(null),ns=o.useRef(null),Di=o.useRef(null),[Me,sn]=o.useState({x:0,y:0,scale:1}),[Bt,rs]=o.useState(null),[ss,is]=o.useState(null),[Li,Gs]=o.useState(!1),[zi,qs]=o.useState(!1),[as,ir]=o.useState(null),[Vs,Ks]=o.useState({open:!1,index:0,items:[]}),[eo,os]=o.useState(!1),[to,ar]=o.useState(0),[zl,Qs]=o.useState(!1),[or,Er]=o.useState(null),[Pi,Ar]=o.useState({}),[Yn,cs]=o.useState({}),Tr=o.useRef(new Set),cr=o.useRef(new Set),[mn,Nr]=o.useState([]),[ls,an]=o.useState(null),[ds,Ui]=o.useState(0),yn=o.useRef(null),[Hi,Js]=o.useState(!1),[Wi,Zs]=o.useState(0),[Dr,ei]=o.useState([]),lr=o.useRef(null),Lr=o.useRef(null),[_i,Bi]=o.useState(150);o.useEffect(()=>{if(I){Bi(60);return}const t=()=>{if(!Lr.current)return;const r=Lr.current.clientWidth,c=Math.floor(r/4);Bi(Math.max(100,c))};t();const n=new ResizeObserver(t);return Lr.current&&n.observe(Lr.current),()=>{n.disconnect()}},[I]),o.useEffect(()=>{Al().catch(()=>{})},[]);const $i=o.useRef(null);o.useEffect(()=>{$i.current=a},[a]);const us=o.useRef([]);o.useEffect(()=>{us.current=mn},[mn]);const Gn=o.useCallback(t=>{if(t)try{URL.revokeObjectURL(t)}catch{}},[]),ti=o.useCallback(()=>{an(null),Nr(t=>t.length?(t.forEach(n=>Gn(n.previewUrl)),[]):t)},[Gn,an]),zr=o.useCallback((t,n)=>{!t||!t.type.startsWith("image/")||Nr(r=>{if(r.length>=Nl)return alert("ÐœÐ¾Ð¶Ð½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10 Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð·Ð° Ñ€Ð°Ð·."),r;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,c=URL.createObjectURL(t),i={id:s,file:t,previewUrl:c,edited:!1,fileName:t.name||"image.png",source:n};return[...r,i]})},[]),no=o.useCallback(t=>{Nr(n=>{const r=n.find(s=>s.id===t);return r&&Gn(r.previewUrl),n.filter(s=>s.id!==t)}),an(n=>n===t?null:n)},[Gn,an]),ro=o.useCallback((t,n,r)=>{Nr(s=>s.map(c=>c.id!==t?c:(Gn(c.previewUrl),{...c,file:n,previewUrl:r,edited:!0,fileName:n.name||c.fileName})))},[Gn]),Oi=yr({queryKey:["my-devices"],queryFn:async()=>(await ie.get("/devices")).data.devices}),[Pl,Fi]=o.useState(null),[so,hs]=o.useState(()=>He.connected),[io,Xi]=o.useState(null),[Yi,ao]=o.useState({}),[Gi,fs]=o.useState({}),[qi,ps]=o.useState({}),[Vi,Ki]=o.useState({}),[oo,Pr]=o.useState(!1),[Qi,Ur]=o.useState({}),[Ji,Zi]=o.useState(!1),[ni,gs]=o.useState(!1),ea=o.useRef(null),D=er(t=>t.session?.user),Hr=o.useRef(null);if(Hr.current===null&&typeof window<"u")try{const t=localStorage.getItem("eb_user");if(t){const n=JSON.parse(t);n&&typeof n.id=="string"&&(Hr.current=n.id)}}catch{Hr.current=null}o.useEffect(()=>{D?.id&&(Hr.current=D.id)},[D?.id]);const qe=D?.id??Hr.current??null,Y=Fr(),F=oc(),ms=o.useMemo(()=>a?Pi[a]||[]:[],[a,Pi]),ys=o.useMemo(()=>ls?mn.find(t=>t.id===ls)??null:null,[mn,ls]);o.useRef(null),o.useRef(null);const[xn,kt]=o.useState({}),[Ul,co]=o.useState(0),qn=o.useRef(null);o.useEffect(()=>{qn.current=h},[h]);const lo=o.useRef({}),ri=o.useRef({}),dr=o.useRef({});o.useEffect(()=>()=>{typeof window>"u"||(Object.values(dr.current).forEach(t=>{typeof t=="number"&&window.clearTimeout(t)}),A.current&&window.clearTimeout(A.current),Kn())},[]),o.useEffect(()=>{if(!x)return;const t=setInterval(()=>{R(n=>n?{...n}:null)},1e3);return()=>clearInterval(t)},[x]);const xs=o.useCallback(t=>{if(!t)return null;const n=F.getQueryData(["conversations"]);return Array.isArray(n)?n.find(s=>s?.conversation?.id===t)?.conversation??null:null},[F]),ur=o.useCallback(t=>{const n=xs(t);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[xs]),Rn=o.useCallback(t=>{if(!t)return;const n=dr.current[t];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete dr.current[t]),delete ri.current[t]},[]),vs=o.useCallback(t=>{t&&ur(t)&&(ri.current[t]=Date.now()+Tl)},[ur]),si=o.useCallback((t,n,r)=>{if(!t){n();return}if(r?.force){Rn(t),n();return}const s=ri.current[t];if(!s){n();return}const c=Date.now();if(c>=s){Rn(t),n();return}const i=s-c,d=dr.current[t];if(typeof d=="number"&&typeof window<"u"&&window.clearTimeout(d),typeof window>"u"){n();return}dr.current[t]=window.setTimeout(()=>{delete dr.current[t],Rn(t),n()},i)},[Rn]),ii=o.useCallback((t,n)=>{const r=t?"ÐºÐ°Ð¼ÐµÑ€Ðµ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ":"Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ",s=typeof n=="object"&&n&&"name"in n?String(n.name):"";return s==="NotAllowedError"||s==="SecurityError"?`Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð°Ð´Ñ€ÐµÑÐ½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`:s==="NotFoundError"?t?"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":s==="NotReadableError"||s==="TrackStartError"?"ÐšÐ°Ð¼ÐµÑ€Ð° Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð»Ð¸ Ð²ÐºÐ»Ð°Ð´ÐºÐ¾Ð¹.":`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð° Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`},[]),bs=o.useCallback(async t=>{try{const n=await Wa({audio:!0,video:t});return n.ok?(Er(null),!0):(Er(ii(t,n.error)),!1)}catch(n){return Er(ii(t,n)),!1}},[ii]),ws=o.useCallback(async t=>{const n=Y.incoming;if(!n||!await bs(t))return;const r=n.conversationId;vs(r),Uo(r,t),Y.startOutgoing(r,t),kt(s=>{const c=s[r],i=D?.id;return c?.active?i&&c.participants&&!c.participants.includes(i)?{...s,[r]:{...c,participants:[...c.participants,i]}}:s:{...s,[r]:{startedAt:Date.now(),active:!0,participants:i?[i]:[]}}}),y(r),k(s=>s===r?null:s),Y.setIncoming(null),Ft()},[vs,Y,D?.id,bs]),ai=o.useCallback(()=>{const t=Y.incoming;t&&(Sa(t.conversationId),Y.setIncoming(null),Ft())},[Y]);o.useEffect(()=>{if(typeof window>"u")return;const t={accept:async(n,r)=>Y.incoming?.conversationId!==n?!1:(await ws(r),!0),decline:n=>Y.incoming?.conversationId!==n?!1:(ai(),!0)};return window.__nativeCallOverlayBridge=t,()=>{window.__nativeCallOverlayBridge===t&&delete window.__nativeCallOverlayBridge}},[Y.incoming?.conversationId,ws,ai]),o.useEffect(()=>{const t=window.setInterval(()=>co(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(t)},[]),o.useEffect(()=>{if(!or||typeof window>"u")return;const t=window.setTimeout(()=>Er(null),9e3);return()=>window.clearTimeout(t)},[or]),o.useEffect(()=>{const t=()=>{const n=window.innerWidth<=768;at(n),Rt.current=n,n?a||Be("list"):Be("conversation")};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]),o.useEffect(()=>{I&&Be(a?"conversation":"list")},[I,a]),o.useEffect(()=>{const t=(()=>{try{const c=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(c==="1"||c==="true")return!0;const i=window.localStorage.getItem("lk-debug-callstatus");return i==="1"||i==="true"}catch{return!1}})(),n=s=>{t&&console.log("[CallStatus] Single:",s),kt(c=>{const i=F.getQueryData(["conversations"]),d=Array.isArray(i)?i.find(j=>j.conversation.id===s.conversationId)?.conversation:null,f=c[s.conversationId],u=Fr.getState().activeConvId;if(!(!!(d&&(d.isGroup||(d.participants?.length??0)>2))||!!f&&(f.participants?f.participants.length>1:!0)||u===s.conversationId))return c;const w=s.participants||[];if(s.active){const j=typeof s.startedAt=="number"&&s.startedAt>0?s.startedAt:f?.startedAt??Date.now();return{...c,[s.conversationId]:{active:!0,startedAt:j,participants:w,endedAt:null,elapsedMs:typeof s.elapsedMs=="number"?s.elapsedMs:void 0}}}const v=f?.active?Date.now():f?.endedAt??null;return{...c,[s.conversationId]:{active:!1,startedAt:f?.startedAt??null,endedAt:v,participants:[],elapsedMs:void 0}}})},r=s=>{t&&console.log("[CallStatus] Bulk:",s),kt(c=>{const i={...c},d=F.getQueryData(["conversations"]);for(const[f,u]of Object.entries(s.statuses||{})){const p=Array.isArray(d)?d.find(E=>E.conversation.id===f)?.conversation:null,w=c[f],v=Fr.getState().activeConvId;if(!(!!(p&&(p.isGroup||(p.participants?.length??0)>2))||!!w&&(w.participants?w.participants.length>1:!0)||v===f))continue;const C=u.participants||[];if(u.active){const E=typeof u.startedAt=="number"&&u.startedAt>0?u.startedAt:w?.startedAt??Date.now();i[f]={active:!0,startedAt:E,participants:C,endedAt:null,elapsedMs:typeof u.elapsedMs=="number"?u.elapsedMs:void 0};continue}const b=w?.active?Date.now():w?.endedAt??null;i[f]={active:!1,startedAt:w?.startedAt??null,endedAt:b,participants:[],elapsedMs:void 0}}return i})};return Ho(n),Wo(r),()=>{He.off("call:status",n),He.off("call:status:bulk",r)}},[]),o.useEffect(()=>{if(!Re.open)return;const t=ea.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=t.getBoundingClientRect();let c=Re.x,i=Re.y;c+s.width>n-8&&(c=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(c!==Re.x||i!==Re.y)&&J(d=>({...d,x:c,y:i}))},[Re.open,Re.x,Re.y]),o.useEffect(()=>{if(!Ee.open)return;const t=Zt.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=t.getBoundingClientRect();let c=Ee.x,i=Ee.y;c+s.width>n-8&&(c=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(c!==Ee.x||i!==Ee.y)&&qt(d=>({...d,x:c,y:i}))},[Ee.open,Ee.x,Ee.y]),o.useEffect(()=>{if(!B.open||!B.anchor)return;const t=ye.current;if(!t)return;const n=B.anchor.getBoundingClientRect(),r=window.innerWidth,s=window.visualViewport?window.visualViewport.height:window.innerHeight;t.style.display="flex";const c=t.getBoundingClientRect();let i=n.right-c.width,d=n.bottom+8;i<8&&(i=8),i+c.width>r-8&&(i=r-c.width-8),d+c.height>s-8&&(d=n.top-c.height-8),d<8&&(d=8),t.style.left=`${i}px`,t.style.top=`${d}px`},[B.open,B.anchor]),o.useEffect(()=>{a||q({open:!1,anchor:null})},[a]);function En(t){l(n=>{try{n&&n!==t&&(re.data||[]).find(c=>c.conversation.id===n)?.conversation?.isSecret&&F.removeQueries({queryKey:["messages",n]})}catch{}return t}),I&&Be("conversation"),us.current.length&&ti()}async function ta(){let t=wr();return t||(t=await sc()),t||null}async function na(t){if(Ji)return;Zi(!0);const n=2;let r=0;const s=async()=>{if(r>=n)throw new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");r+=1,await rc()};try{for(;;){const c=await ta();if(!c){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}try{const i={participantIds:[t],isGroup:!1,isSecret:!0,initiatorDeviceId:c.deviceId};console.log("[SecretChat] Creating with payload:",i),await ie.post("/conversations",i),F.invalidateQueries({queryKey:["conversations"]});return}catch(i){console.error("[SecretChat] Creation error:",i?.response?.data||i);const d=i?.response?.data?.message,f=i?.response?.data?.errors;if(f&&console.error("[SecretChat] Validation errors:",f),i?.response?.status===400&&typeof d=="string"&&d.toLowerCase().includes("invalid initiator device")){await s();continue}const p=f?`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸: ${f.map(w=>`${w.path.join(".")}: ${w.message}`).join(", ")}`:d||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";throw new Error(p)}}}catch(c){console.error("Failed to start secret conversation:",c);const i=c?.message||c?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";alert(i)}finally{Zi(!1)}}const ra=async t=>{gs(!0);try{ic(t),Ur(n=>{const r={...n};return delete r[t],r}),F.invalidateQueries({queryKey:["conversations"]})}finally{gs(!1)}},uo=async t=>{gs(!0);try{const n=await ta();if(!n){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}ac(t,n.deviceId),F.invalidateQueries({queryKey:["conversations"]}),En(t)}catch(n){console.error("Failed to accept secret chat:",n),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚")}finally{gs(!1)}};async function sa(t,n){if(!t)return;const r={...n,content:n.content??void 0};if(t.isSecret){const s=await hn.encryptPayload(t,r);await ie.post("/conversations/send",s);return}await ie.post("/conversations/send",{conversationId:t.id,...r})}const hr=()=>{jr(!1),Cr([]),N(!1),Z("friends"),ee(["","","",""]),we(null),je(null),_e(!1)},ho=async()=>{if(!a||Hn.length===0){hr();return}N(!0);try{await ie.post(`/conversations/${a}/participants`,{participantIds:Hn}),F.invalidateQueries({queryKey:["conversations"]}),re.refetch(),hr()}catch(t){console.error("Error adding participants:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")}finally{N(!1)}},fo=async()=>{if(!(!a||!P)){N(!0);try{await ie.post(`/conversations/${a}/participants`,{participantIds:[P.id]}),F.invalidateQueries({queryKey:["conversations"]}),re.refetch(),hr()}catch(t){console.error("Error adding participant by EBLID:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°")}finally{N(!1)}}},po=(t,n)=>{if(!/^\d?$/.test(n))return;const r=[...L];r[t]=n,ee(r),n&&t<3&&ne[t+1].current?.focus(),!n&&t>0&&ne[t-1].current?.focus();const s=r.join("");if(s.length===4&&/^\d{4}$/.test(s)){const c=Date.now();jt.current=c,_e(!0),je(null),ie.get("/contacts/search",{params:{query:s}}).then(i=>{if(jt.current!==c)return;const d=i.data.results?.[0]??null;we(d),je(d?null:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")}).catch(()=>{jt.current===c&&(we(null),je("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº"))}).finally(()=>{jt.current===c&&_e(!1)})}else we(null),je(null),_e(!1)};function go(){if(I){if(a)try{(re.data||[]).find(r=>r.conversation.id===a)?.conversation?.isSecret&&F.removeQueries({queryKey:["messages",a]})}catch{}Be("list"),l(null),ke(!1)}us.current.length&&ti()}const Qt=yr({queryKey:["me-info"],queryFn:async()=>(await ie.get("/status/me")).data.user}),re=yr({queryKey:["conversations"],queryFn:async()=>(await ie.get("/conversations")).data.conversations}),Ue=yr({queryKey:["messages",a],enabled:!!a,queryFn:async()=>(await ie.get(`/conversations/${a}/messages`)).data.messages,refetchInterval:a?15e3:!1});o.useEffect(()=>{Ue.error?.response?.status===403&&a&&(console.warn("[ChatsPage] Lost access to conversation, closing view",a),F.removeQueries({queryKey:["messages",a]}),l(null))},[Ue.error,a,F]);const gt=yr({queryKey:["accepted-contacts"],queryFn:async()=>(await ie.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),$t=yr({queryKey:["incoming-contacts"],queryFn:async()=>(await ie.get("/contacts",{params:{filter:"incoming"}})).data.contacts});o.useEffect(()=>{if(a&&!(typeof window>"u"))try{window.localStorage.setItem(Oa,a)}catch{}},[a]),o.useEffect(()=>{if(typeof window>"u"||a)return;const t=re.data;if(!(!t||t.length===0)&&!(Rt.current&&Ut!=="conversation"))try{const n=window.localStorage.getItem(Oa);if(!n)return;t.some(s=>s?.conversation?.id===n)&&En(n)}catch{}},[a,re.data,Ut]);const oi=()=>{if(Sn(!1),Gr(""),qr([]),rr(!1),nn)try{URL.revokeObjectURL(nn)}catch{}if(Ir(null),Xe)try{URL.revokeObjectURL(Xe)}catch{}Tt(null),Ke(null),Ei(null),rn({x:0,y:0,scale:1}),kn(!1)};o.useEffect(()=>{const t=$e.current;if(!t)return;const n=()=>{const{scrollTop:r,scrollHeight:s,clientHeight:c}=t,i=r>2,d=s-r-c>2;fn(i),pn(d)};return n(),t.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{t.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[re.data?.length]),o.useEffect(()=>{try{const t=(re.data||[]).map(n=>n.conversation.id);try{const r=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(r==="1"||r==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",t)}catch{}t.length>0&&ka(t);for(const n of t)try{Ia(n)}catch{}}catch{}},[re.data]);const S=o.useMemo(()=>re.data?.find(t=>t.conversation.id===a)?.conversation,[re.data,a]);o.useEffect(()=>()=>{Tr.current.forEach(t=>URL.revokeObjectURL(t)),Tr.current.clear(),cr.current.clear()},[]),o.useEffect(()=>{Tr.current.forEach(t=>URL.revokeObjectURL(t)),Tr.current.clear(),cr.current.clear(),cs({})},[S?.id]);const Wr=o.useMemo(()=>wr()?.deviceId??null,[ds]),js=o.useMemo(()=>{const t={};for(const n of Oi.data||[])t[n.id]=n;return t},[Oi.data]),Cs=o.useCallback(t=>{if(!t?.isSecret)return null;const n=[t.secretInitiatorDeviceId,t.secretPeerDeviceId];for(const r of n){if(!r)continue;const s=js[r];if(s?.userId&&D?.id&&s.userId===D.id)return r}if(D?.id){if(t.createdById===D.id&&t.secretInitiatorDeviceId)return t.secretInitiatorDeviceId;if(t.createdById!==D.id&&t.secretPeerDeviceId)return t.secretPeerDeviceId}return null},[js,D?.id]),fr=o.useMemo(()=>Cs(S),[S,Cs]),ia=o.useMemo(()=>{if(!fr)return;const t=js[fr]?.name;if(t&&t.trim())return t;const n=wr();if(n&&n.deviceId===fr&&n.name)return n.name},[fr,js,ds]),aa=o.useCallback(t=>{if(!t)return!1;const n=(re.data||[]).find(s=>s?.conversation?.id===t)?.conversation;if(!n?.isSecret)return!1;const r=Cs(n);return!!(r&&Wr&&r!==Wr)},[re.data,Wr,Cs]),Ss=!!(S?.isSecret&&(S.secretStatus??"ACTIVE")!=="ACTIVE"),pr=o.useMemo(()=>S?.isSecret?hn.hasSession(S.id):!0,[S?.id,S?.isSecret,ds]),mo=!!(S?.isSecret&&!Ss&&!pr&&fr&&Wr&&fr!==Wr);o.useEffect(()=>{if(!S?.isSecret||S.secretStatus!=="ACTIVE")return;let t=!1;return hn.ensureSession(S).then(n=>{!t&&n&&Ui(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{t=!0}},[S?.id,S?.secretStatus,S?.isSecret]),o.useEffect(()=>{if(!S?.isSecret||!Ue.data||Ue.data.length===0)return;hn.processHandshakes(S,Ue.data)&&Ui(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[Ue.data,S?.id,S?.isSecret,S?.secretStatus]);const Ot=o.useMemo(()=>Ue.data?S?.isSecret?Ue.data.filter(t=>{const r=(t?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(t=>hn.transformMessage(S.id,t)):Ue.data:[],[Ue.data,S?.id,S?.isSecret,ds]),oa=o.useCallback(t=>{if(!S?.id)return;const n=t?.metadata?.e2ee;!n||n.kind!=="ciphertext"||!n.nonce||!hn.hasSession(S.id)||cr.current.has(t.url)||Yn[t.url]?.status==="ready"||(cr.current.add(t.url),cs(s=>({...s,[t.url]:{status:"pending"}})),(async()=>{try{const s=Ps(t.url)||t.url,c=await fetch(s,{credentials:"omit"});if(!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const i=new Uint8Array(await c.arrayBuffer()),d=hn.decryptBinary(S.id,i,n.nonce);if(!d)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const f=new Blob([d],{type:n.originalType||t.metadata?.mime||t.metadata?.contentType||"application/octet-stream"}),u=URL.createObjectURL(f);Tr.current.add(u),cr.current.delete(t.url),cs(p=>({...p,[t.url]:{status:"ready",url:u}}))}catch(s){cr.current.delete(t.url),cs(c=>{const i={...c};return s?.message?.includes("E2EE session is not ready")?delete i[t.url]:i[t.url]={status:"error"},i})}})())},[S?.id,Yn]),ks=o.useCallback(t=>{if(!t)return null;const n=Ps(t.url);if(!S?.isSecret)return n;const r=t.metadata?.e2ee;if(!r||r.kind!=="ciphertext")return n;const s=Yn[t.url];return s?.status==="ready"&&s.url?s.url:null},[Yn,S?.isSecret]);o.useEffect(()=>{if(!S?.isSecret||!pr)return;(Ot||[]).flatMap(n=>n.attachments||[]).forEach(n=>{n?.metadata?.e2ee?.kind==="ciphertext"&&oa(n)})},[Ot,S?.id,S?.isSecret,pr,oa]),o.useEffect(()=>{const t=new Set((re.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));Ur(n=>{let r=!1;const s={...n};for(const c of Object.keys(s))t.has(c)||(delete s[c],r=!0);return r?s:n})},[re.data]);const gr=o.useMemo(()=>{if(!S||S.isGroup||S.isSecret||!D?.id)return null;const t=Fa(S.participants||[]);if(!t)return null;const n=re.data||[];for(const r of n){const s=r.conversation;if(!s?.isSecret||(s.secretStatus??"ACTIVE")!=="PENDING"||Fa(s.participants||[])!==t)continue;const i=(s.participants||[]).find(f=>f.user.id===s.createdById)?.user,d=Qi[s.id]?.from?.name??i?.displayName??i?.username??"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº";return{conversationId:s.id,isInitiator:s.createdById===D.id,initiatorName:d}}return null},[S,re.data,D?.id,Qi]),ca=o.useMemo(()=>{const t={};if(S)for(const n of S.participants)t[n.user.id]=n.user;return D&&!t[D.id]&&(t[D.id]=D),t},[S,D]),ci=o.useMemo(()=>S?(S.participants||[]).map(t=>t.user.id):[],[S]),la=o.useMemo(()=>{if(!S||!gt.data)return[];const t=new Set(ci);return gt.data.filter(n=>!t.has(n.friend.id))},[S,gt.data,ci]),Is={alreadyInChat:P?ci.includes(P.id):!1,isSelf:P?P.id===D?.id:!1};o.useEffect(()=>{tr&&M==="eblid"&&ne[0].current?.focus()},[tr,M]),o.useEffect(()=>{const t=n=>{ao(r=>{const s=(n.status||"").toString().toUpperCase();return r[n.userId]===s?r:{...r,[n.userId]:s}}),F.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(i=>i.user.id===n.userId?{...i,user:{...i.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="IN_CALL"||n.status==="OFFLINE"?new Date().toISOString():i.user.lastSeenAt}}:i)}})))};return Ma(t),()=>{He.off("presence:update",t)}},[F]);const Vn=o.useCallback(t=>{const n=t?.id,r=typeof n=="string"?n:null,c=((r?Yi[r]:void 0)??t?.status??"OFFLINE").toString().toUpperCase();return c==="IN_CALL"?"IN_CALL":c==="ONLINE"?"ONLINE":c==="BACKGROUND"?"BACKGROUND":c==="AWAY"?"AWAY":"OFFLINE"},[Yi]),Ms=o.useRef(He.connected);o.useEffect(()=>{const t=()=>{try{const c=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",c+"px")}catch{}F.invalidateQueries({queryKey:["me-info"]}),hs(He.connected)};window.addEventListener("focus",t);const n=()=>{hs(!0);const c=Ms.current;if(Ms.current=!0,c)try{const i=(re.data||[]).map(d=>d.conversation.id);for(const d of i)try{Ia(d)}catch{}i.length>0&&ka(i)}catch{}},r=()=>{hs(!1),Ms.current=!1};He.on("connect",n),He.on("disconnect",r),hs(He.connected),He.connected&&(Ms.current=!0);const s=()=>{F.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",s),()=>{He.off("connect",n),He.off("disconnect",r),document.removeEventListener("visibilitychange",s),window.removeEventListener("focus",t)}},[F]),o.useEffect(()=>{const t=n=>{if(D?.id&&n.userId===D.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="IN_CALL"||r==="OFFLINE")&&Xi(r)}};return Ma(t),()=>{He.off("presence:update",t)}},[D?.id]),o.useEffect(()=>{const t=(Qt.data?.status||"").toString().toUpperCase();(t==="ONLINE"||t==="AWAY"||t==="BACKGROUND"||t==="IN_CALL"||t==="OFFLINE")&&Xi(t)},[Qt.data]),o.useEffect(()=>{const t=n=>{F.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(c=>c.user.id===n.userId?{...c,user:{...c.user,avatarUrl:n.avatarUrl??c.user.avatarUrl,displayName:n.displayName??c.user.displayName}}:c)}}))),n.userId===D?.id&&Qt.refetch()};return _o(t),()=>{He.off("profile:update",t)}},[F,D?.id]);function yo(t){return"#191d23"}o.useEffect(()=>{if(!a)return;const t=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const s=n.clipboardData?.items;if(s)for(let c=0;c<s.length;c++){const i=s[c];if(i.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const d=i.getAsFile();d&&zr(d,"paste");break}}};return window.addEventListener("paste",t,!0),()=>{window.removeEventListener("paste",t,!0)}},[a,zr]),o.useEffect(()=>{re.refetch(),Bo(),$o(()=>re.refetch()),Oo(r=>{const s=r?.conversationId;if(!s){re.refetch();return}Ur(i=>{if(!i[s])return i;const d={...i};return delete d[s],d}),Ar(i=>{if(!i[s])return i;const d={...i};return delete d[s],d}),hn.clearSession(s),F.removeQueries({queryKey:["messages",s]}),F.setQueryData(["conversations"],i=>Array.isArray(i)?i.filter(d=>d?.conversation?.id!==s):i),$i.current===s&&(l(i=>i===s?null:i),ke(!1),us.current.length&&ti(),Rt.current&&Be("list")),re.refetch()}),Fo(()=>{re.refetch()}),Xo(()=>{re.refetch()});const t=Yo(r=>{Ur(s=>({...s,[r.conversationId]:r})),re.refetch()}),n=Go(r=>{Ur(s=>{const c={...s};return delete c[r.conversationId],c}),F.invalidateQueries({queryKey:["conversations"]}),En(r.conversationId)});qo(({conversationId:r,from:s,video:c})=>{if(!(fe.current&&fe.current===r)){Ft();try{const i=F.getQueryData(["conversations"]),d=Array.isArray(i)?i.find(p=>p.conversation.id===r)?.conversation:null,f=!!(d&&(d.isGroup||(d.participants?.length??0)>2));lo.current[r]=s.id;const u=qn.current===r;if(f||u||s?.id&&D?.id&&s.id===D.id)return}catch{}fe.current=r,Y.startIncoming({conversationId:r,from:s,video:c});try{const i=da();i&&(i.currentTime=0,i.loop=!0,i.volume=.9,i.play().catch(()=>{}))}catch(i){console.error("Error starting ringtone:",i)}U.current=window.setTimeout(()=>{Sa(r),Ft(),Y.setIncoming(null)},25e3)}}),Vo(({conversationId:r,by:s,video:c})=>{if(Rn(r),R(u=>u?.conversationId===r?(A.current&&(window.clearTimeout(A.current),A.current=null),Kn(),null):u),s?.id===D?.id){(Y.incoming?.conversationId===r||fe.current===r)&&(Ft(),Y.setIncoming(null),U.current&&(window.clearTimeout(U.current),U.current=null),fe.current=null);return}const i=qn.current===r,d=Fr.getState().activeConvId===r,f=K.current?.conversationId===r;if(!i&&!d&&!f){(Fr.getState().incoming?.conversationId===r||fe.current===r)&&(Ft(),Y.setIncoming(null),U.current&&(window.clearTimeout(U.current),U.current=null),fe.current=null);return}if(kt(u=>u[r]?.active?u:{...u,[r]:{startedAt:Date.now(),active:!0,participants:[D?.id||""].filter(Boolean)}}),Y.activeConvId!==r){const u=!!c;Y.startOutgoing(r,u)}y(r),k(u=>u===r?null:u),Ft()}),Ko(({conversationId:r})=>{R(c=>c?.conversationId===r?(A.current&&(window.clearTimeout(A.current),A.current=null),Kn(),Rs(),null):c);const s=()=>{kt(c=>{const i=c[r];if(i){if(i.active)return{...c,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}return c}),qn.current===r&&(y(c=>c===r?null:c),k(c=>c===r?null:c),Y.endCall()),Y.setIncoming(null),Ft(),Rn(r)};ur(r)?si(r,s,{force:!0}):s()}),Qo(({conversationId:r})=>{try{const c=F.getQueryData(["conversations"]),i=Array.isArray(c)?c.find(f=>f.conversation.id===r)?.conversation:null;if(!!(i&&(i.isGroup||(i.participants?.length??0)>2)))return}catch{}if(m===r)return;if(ur(r)){const c=xn[r];if((qn.current===r||Y.activeConvId===r)&&c?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",r);return}}const s=()=>{R(c=>c?.conversationId===r?(A.current&&(window.clearTimeout(A.current),A.current=null),Kn(),null):c),kt(c=>{const i=c[r];if(i?.active)return{...c,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:d,...f}=c;return f}),qn.current===r&&(y(c=>c===r?null:c),k(c=>c===r?null:c),Y.endCall()),Y.setIncoming(null),Ft(),Rn(r)};ur(r)?si(r,s,{force:!0}):s()}),Jo(({conversationId:r})=>{F.invalidateQueries({queryKey:["messages",r]}),F.refetchQueries({queryKey:["messages",r]})});try{ge.current||(ge.current=new Audio("/notify.mp3"),ge.current.preload="auto",ge.current.volume=.9);const r=async()=>{try{if(ge.current&&!ae.current&&(ge.current.volume=0,await ge.current.play(),ge.current.pause(),ge.current.currentTime=0,ge.current.volume=.9,ae.current=!0),!dt.current){const s=da();if(s){const c=s.volume;s.volume=0,await s.play().catch(()=>{}),s.pause(),s.currentTime=0,s.volume=c,dt.current=!0}}}catch{}ae.current&&dt.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{t?.(),n?.()}},[]),o.useEffect(()=>{Zo(()=>{$t.refetch()}),ec(()=>{gt.refetch(),re.refetch(),$t.refetch()}),tc(()=>{gt.refetch(),$t.refetch()})},[]),o.useEffect(()=>{if(!_t)return;const t=On.current;if(!t)return;const n=(u,p)=>{const w=p.clientX-u.clientX,v=p.clientY-u.clientY;return Math.sqrt(w*w+v*v)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),s=240,c=(u,p,w,v,j)=>{const C=u-w,b=p-v;return C*C+b*b<=j*j},i=u=>{const p=t.getBoundingClientRect();if(!p)return;const w=p.width,v=p.height,j=w/2,C=v/2,b=s/2;if(u.touches.length===1){const E=u.touches[0],H=E.clientX-p.left,W=E.clientY-p.top;if(!c(H,W,j,C,b))return;ft.current={touches:[E],initialDistance:0,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}else if(u.touches.length===2){const E=u.touches[0],H=u.touches[1],W=r(E,H),ce=W.x-p.left,de=W.y-p.top;if(!c(ce,de,j,C,b))return;const ue=n(E,H);ft.current={touches:[E,H],initialDistance:ue,initialScale:Ie.scale,initialX:Ie.x,initialY:Ie.y},u.preventDefault()}},d=u=>{ft.current&&(u.preventDefault(),Fn.current!==null&&cancelAnimationFrame(Fn.current),Fn.current=requestAnimationFrame(()=>{if(!ft.current)return;const p=t.getBoundingClientRect();if(!p)return;const w=p.width,v=p.height,j=w/2,C=v/2,b=u.touches.length,E=ft.current.touches.length;if(b===1&&E===1){const H=u.touches[0],W=ft.current.touches[0],ce=H.clientX-W.clientX,de=H.clientY-W.clientY;In(ue=>{let V=ft.current.initialX+ce,oe=ft.current.initialY+de;const X=Ys.current;if(X){const se=ue.scale,le=X.naturalWidth*se,Le=X.naturalHeight*se,Je=j+s/2,ze=j-s/2-le,mt=C+s/2,vn=C-s/2-Le;V=Math.max(ze,Math.min(Je,V)),oe=Math.max(vn,Math.min(mt,oe))}return{...ue,x:V,y:oe}})}else if(b===2&&E===2){const H=u.touches[0],W=u.touches[1],de=n(H,W)/ft.current.initialDistance,ue=Math.max(.1,Math.min(10,ft.current.initialScale*de)),V=Ys.current;if(V){const oe=V.naturalWidth,X=V.naturalHeight,se=ft.current.initialX+oe*ft.current.initialScale/2,le=ft.current.initialY+X*ft.current.initialScale/2,Le=se-j,Je=le-C,ze=ue/ft.current.initialScale,mt=j+Le*ze,vn=C+Je*ze,_r=mt-oe*ue/2,bn=vn-X*ue/2;In({x:_r,y:bn,scale:ue})}}Fn.current=null}))},f=()=>{Fn.current!==null&&(cancelAnimationFrame(Fn.current),Fn.current=null),ft.current=null};return t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",i),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[_t,Ie.scale,Ie.x,Ie.y]),o.useEffect(()=>{if(!Bt)return;const t=Mn.current;if(!t)return;const n=(u,p)=>{const w=p.clientX-u.clientX,v=p.clientY-u.clientY;return Math.sqrt(w*w+v*v)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),s=240,c=(u,p,w,v,j)=>{const C=u-w,b=p-v;return C*C+b*b<=j*j},i=u=>{const p=t.getBoundingClientRect();if(!p)return;const w=p.width,v=p.height,j=w/2,C=v/2,b=s/2;if(u.touches.length===1){const E=u.touches[0],H=E.clientX-p.left,W=E.clientY-p.top;if(!c(H,W,j,C,b))return;pt.current={touches:[E],initialDistance:0,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},u.preventDefault()}else if(u.touches.length===2){const E=u.touches[0],H=u.touches[1],W=r(E,H),ce=W.x-p.left,de=W.y-p.top;if(!c(ce,de,j,C,b))return;const ue=n(E,H);pt.current={touches:[E,H],initialDistance:ue,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},u.preventDefault()}},d=u=>{pt.current&&(u.preventDefault(),Xn.current!==null&&cancelAnimationFrame(Xn.current),Xn.current=requestAnimationFrame(()=>{if(!pt.current)return;const p=t.getBoundingClientRect();if(!p)return;const w=p.width,v=p.height,j=w/2,C=v/2,b=u.touches.length,E=pt.current.touches.length;if(b===1&&E===1){const H=u.touches[0],W=pt.current.touches[0],ce=H.clientX-W.clientX,de=H.clientY-W.clientY;sn(ue=>{let V=pt.current.initialX+ce,oe=pt.current.initialY+de;const X=ts.current;if(X){const se=ue.scale,le=X.naturalWidth*se,Le=X.naturalHeight*se,Je=j+s/2,ze=j-s/2-le,mt=C+s/2,vn=C-s/2-Le;V=Math.max(ze,Math.min(Je,V)),oe=Math.max(vn,Math.min(mt,oe))}return{...ue,x:V,y:oe}})}else if(b===2&&E===2){const H=u.touches[0],W=u.touches[1],de=n(H,W)/pt.current.initialDistance,ue=Math.max(.1,Math.min(10,pt.current.initialScale*de)),V=ts.current;if(V){const oe=V.naturalWidth,X=V.naturalHeight,se=pt.current.initialX+oe*pt.current.initialScale/2,le=pt.current.initialY+X*pt.current.initialScale/2,Le=se-j,Je=le-C,ze=ue/pt.current.initialScale,mt=j+Le*ze,vn=C+Je*ze,_r=mt-oe*ue/2,bn=vn-X*ue/2;sn({x:_r,y:bn,scale:ue})}}Xn.current=null}))},f=()=>{Xn.current!==null&&(cancelAnimationFrame(Xn.current),Xn.current=null),pt.current=null};return t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",f,{passive:!0}),t.addEventListener("touchcancel",f,{passive:!0}),()=>{t.removeEventListener("touchstart",i),t.removeEventListener("touchmove",d),t.removeEventListener("touchend",f),t.removeEventListener("touchcancel",f)}},[Bt,Me.scale,Me.x,Me.y]);const da=o.useCallback(()=>{if(typeof window>"u")return null;if(!Se.current){const t=new Audio("/ring.mp3");t.preload="auto",t.loop=!0,t.volume=.9,Se.current=t}return Se.current},[]);function Ft(){try{if(U.current&&clearTimeout(U.current),U.current=null,Se.current)try{Se.current.pause(),Se.current.currentTime=0}catch{}fe.current=null}catch{}}const xo=o.useCallback(()=>{if(typeof window>"u")return null;if(!Pe.current){const t=new Audio("/dialing.mp3");t.preload="auto",t.loop=!0,t.volume=.7,Pe.current=t}return Pe.current},[]);function ua(){try{const t=xo();t&&(t.currentTime=0,t.loop=!0,t.volume=.7,t.play().catch(()=>{}))}catch(t){console.error("Error starting dialing sound:",t)}}function Kn(){try{if(Pe.current)try{Pe.current.pause(),Pe.current.currentTime=0}catch{}}catch{}}const vo=o.useCallback(()=>{if(typeof window>"u")return null;if(!Te.current){const t=new Audio("/notify.mp3");t.preload="auto",t.volume=.6,Te.current=t}return Te.current},[]);function Rs(){try{const t=vo();t&&(t.currentTime=0,t.volume=.6,t.play().catch(()=>{}))}catch(t){console.error("Error playing end call sound:",t)}}o.useEffect(()=>{const t=async s=>{if(!(s.conversationId===a)){F.invalidateQueries({queryKey:["conversations"]});return}if(!a)return;const d=s.message??s;d&&d.id&&(Ar(f=>{const u=f[a]||[];if(u.length===0)return f;const p=(d.attachments||[]).map(v=>v.url).sort(),w=u.filter(v=>{if(v.senderId!==d.senderId)return!0;const j=v.attachments.map(C=>C.url).sort();return j.length===p.length?!j.every((b,E)=>{const H=p[E];return b===H||b.startsWith("blob:")&&H&&!H.startsWith("blob:")}):!0});if(w.length===u.length)return f;if(w.length===0){const{[a]:v,...j}=f;return j}return{...f,[a]:w}}),xa(a,d)),Ue.refetch()},n=s=>{s.conversationId===a&&(zt(!0),ut.current&&window.clearTimeout(ut.current),ut.current=window.setTimeout(()=>zt(!1),2e3))},r=s=>{if(!a||s.conversationId!==a){F.invalidateQueries({queryKey:["conversations"]});return}s.message?Eo(a,s.message):Ue.refetch()};return He.on("message:new",t),He.on("conversation:typing",n),He.on("message:reaction",r),()=>{He.off("message:new",t),He.off("conversation:typing",n),He.off("message:reaction",r)}},[a]),o.useEffect(()=>{const t=async n=>{if(aa(n.conversationId))return;const r=n.senderId===D?.id,s=n.conversationId===a,c=document.visibilityState==="visible";if(!r&&(!s||!c)&&ge.current&&ae.current&&(ge.current.currentTime=0,ge.current.play().catch(()=>{})),s){n.message&&n.message.id&&xa(a,n.message),Ue.refetch().catch(()=>{});return}};return He.on("message:notify",t),()=>{He.off("message:notify",t)}},[a,D?.id,Ue,aa]),o.useLayoutEffect(()=>{if(!a){xt.current=null,yt.current=0;return}xt.current!==a&&(xt.current=a,yt.current=0);const t=(Ot?.length??0)+ms.length,n=yt.current;if(yt.current=t,!pe.current||t===0||t<=n)return;const r=[...Ot||[],...ms],s=r[r.length-1],c=s?.senderId&&D?.id?s.senderId===D.id:!1;(c||!Ve.current||Wt.current)&&requestAnimationFrame(()=>{const d=pe.current;d&&(d.scrollTop=d.scrollHeight,Wt.current=!0,c&&(Ve.current=!1))})},[a,ms,Ot,D?.id]),o.useEffect(()=>{if(!a)return;const t=pe.current;if(!t)return;const n=()=>{t&&(t.scrollTop=t.scrollHeight,Wt.current=!0,Ve.current=!1)};if(Rt.current){n();const r=window.setTimeout(n,50),s=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(s)}}n()},[a]),o.useEffect(()=>{if(!Rt.current)return;const t=pe.current;if(!t)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===T.current&&(t.scrollTop=t.scrollHeight,Wt.current=!0,Ve.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[a]),o.useEffect(()=>{},[]),o.useEffect(()=>{if(!Ne||!Rt.current)return;const t=pe.current,n=window.setInterval(()=>{be(r=>r%3+1),t&&t.scrollHeight-t.scrollTop-t.clientHeight<80&&(t.scrollTop=t.scrollHeight)},500);return()=>window.clearInterval(n)},[Ne]),o.useEffect(()=>{const t=pe.current;if(!t)return;let n=0,r=t.scrollTop;const s=()=>{n&&cancelAnimationFrame(n);const c=t.scrollTop;Math.abs(c-r)>1&&(Ve.current=!0),n=requestAnimationFrame(()=>{const d=t.scrollHeight-t.scrollTop-t.clientHeight<8;Wt.current=d,ke(!d),d&&window.setTimeout(()=>{t.scrollHeight-t.scrollTop-t.clientHeight<40&&(Ve.current=!1)},100),r=t.scrollTop})};return t.addEventListener("scroll",s,{passive:!0}),s(),()=>{t.removeEventListener("scroll",s),n&&cancelAnimationFrame(n)}},[a]),o.useEffect(()=>{const t=()=>{if(!pe.current)return;const n=pe.current.clientWidth;st(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]);function ha(t,n){if(!/^\d?$/.test(n))return;if(t===0&&n&&Bn.some(Boolean)){Mr([n,"","",""]),$n(null),Rr[1].current?.focus();return}const r=[...Bn];r[t]=n,Mr(r),n&&t<3&&Rr[t+1].current?.focus(),!n&&t>0&&Rr[t-1].current?.focus();const s=r.join("");s.length===4&&/^\d{4}$/.test(s)?(async()=>{try{const c=await ie.get("/contacts/search",{params:{query:s}});$n(c.data.results?.[0]??null)}catch{$n(null)}})():$n(null)}o.useEffect(()=>{$s||(Mr(["","","",""]),$n(null))},[$s]);async function bo(){_n(!0);try{const t=await ie.get("/status/me");Ja(t.data.user?.eblid??"")}catch{}}async function wo(){const t=Bn.join("");if(/^\d{4}$/.test(t)){Os(!0);try{await ie.post("/contacts/add",{identifier:t}),Os(!1)}catch{Os(!1)}}}function Es(){if(!a||!Ue.data||!D?.id)return;const t=Ue.data.filter(n=>n.senderId!==D.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===D.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);t.length!==0&&ie.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{F.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})}o.useEffect(()=>{document.hasFocus()&&Es(),a&&(ie.post("/messages/mark-conversation-read",{conversationId:a}).catch(()=>{}),F.setQueryData(["conversations"],t=>t&&t.map(n=>n.conversation.id===a?{...n,unreadCount:0}:n)))},[a]),o.useEffect(()=>{document.hasFocus()&&Es()},[Ue.data]),o.useEffect(()=>{const t=()=>Es(),n=()=>{document.visibilityState==="visible"&&Es()};return window.addEventListener("focus",t),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",t),document.removeEventListener("visibilitychange",n)}},[a,Ue.data]);function jo(){Ce.current||(Ce.current=window.setTimeout(()=>{const t=Array.from(Fe.current);Fe.current.clear(),Ce.current&&clearTimeout(Ce.current),Ce.current=null,t.length&&ie.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{a&&F.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})},250))}o.useEffect(()=>{if(!a||!Ue.data||!D?.id)return;Ht.current?.disconnect();const t=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const s=r.target,c=s.dataset.mid;if(!c)continue;const i=Ue.data.find(f=>f.id===c);!i||i.senderId===D.id||(i.receipts||[]).some(f=>f.userId===D.id&&(f.status==="READ"||f.status==="SEEN"))||(Fe.current.add(c),t.unobserve(s))}Fe.current.size&&jo()},{root:pe.current,threshold:[.25]});Ht.current=t;for(const n of Ue.data){if(n.senderId===D.id||(n.receipts||[]).some(c=>c.userId===D.id&&(c.status==="READ"||c.status==="SEEN")))continue;const s=Et.current.get(n.id);s&&t.observe(s)}return()=>{t.disconnect()}},[a,Ue.data,D?.id]),o.useEffect(()=>{const t=()=>{if(!pe.current)return;const n=pe.current.clientWidth;st(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[a]);async function li(t,n="",r){if(!a||t.length===0)return;const s=!!S?.isSecret;if(s){if(Ss){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!pr){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}os(!0),ar(0);try{const c=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,i=[],d=t.reduce((w,v)=>w+v.size,0);for(const w of t)if(w.type.startsWith("image/")){const v=URL.createObjectURL(w),{width:j,height:C}=await Co(v);i.push({url:v,type:"IMAGE",width:j,height:C,progress:0,__pending:!0})}else i.push({url:w.name,type:"FILE",__pending:!0,progress:0});Ar(w=>({...w,[a]:[...w[a]||[],{id:c,createdAt:Date.now(),senderId:D?.id||"me",attachments:i,content:n}]}));const f=[];let u=0;for(let w=0;w<t.length;w++){const v=t[w],j=i[w];let C=v,b;if(s&&S){const de=new Uint8Array(await v.arrayBuffer()),ue=await hn.encryptBinary(S,de);C=new Blob([ue.cipher],{type:"application/octet-stream"}),b={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:ue.nonce,originalName:v.name,originalType:v.type,originalSize:v.size}}const E=new FormData;E.append("file",C,s?`${v.name||"file"}.enc`:v.name);const W={url:await new Promise((de,ue)=>{const V=new XMLHttpRequest;V.open("POST","/api/upload");try{const oe=er.getState().session?.accessToken;oe&&V.setRequestHeader("Authorization",`Bearer ${oe}`)}catch{}V.upload.onprogress=oe=>{if(oe.lengthComputable){const X=Math.round((u+oe.loaded)/d*100);ar(X),Ar(se=>{const Le=(se[a]||[]).map(ze=>({...ze,attachments:ze.attachments.map(mt=>({...mt}))})),Je=Le[Le.length-1];if(Je){const ze=Je.attachments.findIndex(mt=>mt.__pending&&mt.type===(v.type.startsWith("image/")?"IMAGE":"FILE")&&(!mt.width||mt.url.startsWith("blob:")));ze>=0&&(Je.attachments[ze].progress=X)}return{...se,[a]:Le}})}},V.onreadystatechange=()=>{if(V.readyState===4)if(V.status>=200&&V.status<300)try{const oe=JSON.parse(V.responseText);de(oe.url)}catch(oe){ue(oe)}else ue(new Error("upload failed"))},V.send(E)}),type:v.type.startsWith("image/")?"IMAGE":"FILE"},ce={};j&&j.type==="IMAGE"&&j.width&&j.height&&(ce.width=j.width,ce.height=j.height),b&&(ce.e2ee=b),Object.keys(ce).length>0&&(W.metadata=ce),f.push(W),u+=v.size,ar(Math.round(u/d*100))}const p=f.every(w=>w.type==="IMAGE")?"IMAGE":"FILE";await ie.post("/conversations/send",{conversationId:a,type:p,content:n,attachments:f,replyToId:r}),Ar(w=>{const j=(w[a]||[]).filter(C=>C.id!==c);if(j.length===0){const{[a]:C,...b}=w;return b}return{...w,[a]:j}}),F.invalidateQueries({queryKey:["messages",a]})}catch(c){console.error("Failed to upload attachments",c)}os(!1)}async function Co(t){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=t})}const So=async()=>{if(a&&!Hi)try{if(!(await Wa({audio:!0})).ok){alert("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹");return}Ft(),ei([]);const n=new Il({onStateChange:r=>{Js(r==="recording"),r!=="recording"&&lr.current&&(clearInterval(lr.current),lr.current=null)},onDurationUpdate:r=>{Zs(r)},onAmplitudeUpdate:r=>{ei(s=>{const c=I?60:_i,i=[...s,r];return i.length>c?i.slice(-c):i})},onError:r=>{console.error("Voice recording error:",r),alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"),fa()}});yn.current=n,await n.start()}catch(t){console.error("Failed to start voice recording:",t),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ")}},fa=()=>{if(!yn.current)return;const t=yn.current,n=t.getDuration(),r=t.stop();yn.current=null,Js(!1),Zs(0),r&&a&&Io(r,n)},ko=()=>{yn.current&&(yn.current.cancel(),yn.current=null),lr.current&&(clearInterval(lr.current),lr.current=null),Js(!1),Zs(0),ei([])},Io=async(t,n)=>{if(!a)return;const r=!!S?.isSecret;if(r){if(Ss){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!pr){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}os(!0),ar(0);try{const s=new File([t],"voice-message.webm",{type:t.type||"audio/webm"});let c=s,i;if(r&&S){const p=new Uint8Array(await s.arrayBuffer()),w=await hn.encryptBinary(S,p);c=new Blob([w.cipher],{type:"application/octet-stream"}),i={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:w.nonce,originalName:s.name,originalType:s.type,originalSize:s.size}}const d=new FormData;d.append("file",c,r?`${s.name}.enc`:s.name);const u={url:await new Promise((p,w)=>{const v=new XMLHttpRequest;v.open("POST","/api/upload");try{const j=er.getState().session?.accessToken;j&&v.setRequestHeader("Authorization",`Bearer ${j}`)}catch{}v.upload.onprogress=j=>{if(j.lengthComputable){const C=Math.round(j.loaded/j.total*100);ar(C)}},v.onreadystatechange=()=>{if(v.readyState===4)if(v.status>=200&&v.status<300)try{const j=JSON.parse(v.responseText);p(j.url)}catch(j){w(j)}else w(new Error("upload failed"))},v.send(d)}),type:"AUDIO",size:s.size,...i?{metadata:{e2ee:i}}:{}};await ie.post("/conversations/send",{conversationId:a,type:"AUDIO",metadata:{duration:n},attachments:[u],replyToId:Q?.id}),he(null),F.invalidateQueries({queryKey:["messages",a]})}catch(s){console.error("Failed to send voice message",s),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")}finally{os(!1),ar(0)}};o.useEffect(()=>()=>{yn.current&&yn.current.cleanup()},[]),o.useEffect(()=>{let t=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Fi(Math.round(performance.now()-r))}catch{Fi(null)}};return n(),t=window.setInterval(n,15e3),()=>{t&&clearInterval(t)}},[]),o.useEffect(()=>{let t=null;const n=()=>F.invalidateQueries({queryKey:["conversations"]});return t=window.setInterval(n,2e4),()=>{t&&clearInterval(t)}},[F]);const Mo=o.useMemo(()=>{const t=new Set;try{const n=re.data||[],r=new Map;for(const s of n){const c=s?.conversation;c?.id&&r.set(c.id,c)}for(const[s,c]of Object.entries(xn||{})){if(!c?.active)continue;const i=r.get(s);if(!!!(i&&(i.isGroup||(i.participants?.length??0)>2)))continue;const f=c.participants||[];for(const u of f)t.add(u)}}catch{}return t},[xn,re.data]),Ro=o.useMemo(()=>{const t={};try{const n=re.data||[];for(const r of n){const s=r?.conversation;if(!s?.isSecret)continue;const c=(s.secretStatus??"ACTIVE").toString().toUpperCase();if(c!=="ACTIVE"&&c!=="PENDING")continue;const d=(Array.isArray(s.participants)?s.participants:[]).filter(p=>qe?p?.user?.id!==qe:!0).map(p=>p?.user).filter(Boolean);if(d.length!==1)continue;const f=d[0]?.id;if(typeof f!="string")continue;(!t[f]||c==="ACTIVE")&&(t[f]=c)}}catch{}return t},[re.data,qe]),pa=o.useMemo(()=>{try{const t=S;return!t||t.isGroup||t.isSecret?null:(Array.isArray(t.participants)?t.participants:[]).filter(s=>qe?s?.user?.id!==qe:!0).map(s=>s?.user?.id).filter(s=>typeof s=="string")[0]??null}catch{return null}},[S,qe]);function As(t){const n=t?.id?Vn(t):t?.status??"OFFLINE",r=t.lastSeenAt?new Date(t.lastSeenAt):null;if(n==="ONLINE")return"ÐžÐÐ›ÐÐ™Ð";if(n==="BACKGROUND")return"Ð’ Ð¤ÐžÐÐ•";if(n==="IN_CALL"){const w=typeof t?.id=="string"?t.id:null;return w&&Mo.has(w)?"Ð’ Ð‘Ð•Ð¡Ð•Ð”Ð•":"Ð’ Ð—Ð’ÐžÐÐšÐ•"}if(!r)return"Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½";const c=new Date().getTime()-r.getTime(),i=Math.floor(c/6e4);if(i<1)return"Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";if(i<60)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${i} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;const d=Math.floor(i/60);if(d<24)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${d} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;const f={hour:"2-digit",minute:"2-digit"},u=r.toLocaleDateString(),p=r.toLocaleTimeString([],f);return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${u} Ð² ${p}`}function ga(t){const n=As(t);return n==="ÐžÐÐ›ÐÐ™Ð"?"Ð¾Ð½Ð»Ð°Ð¹Ð½":n==="Ð’ Ð¤ÐžÐÐ•"?"Ð² Ñ„Ð¾Ð½Ðµ":n==="Ð’ Ð—Ð’ÐžÐÐšÐ•"?"Ð² Ð·Ð²Ð¾Ð½ÐºÐµ":n==="Ð’ Ð‘Ð•Ð¡Ð•Ð”Ð•"?"Ð² Ð±ÐµÑÐµÐ´Ðµ":n}function di(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/3600),s=Math.floor(n%3600/60),c=n%60;return r>0?`${r}:${String(s).padStart(2,"0")}:${String(c).padStart(2,"0")}`:`${s}:${String(c).padStart(2,"0")}`}function ma(t){const n=t?"conversations-list slider-panel":"conversations-list";return e.jsxs("aside",{className:n,children:[e.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{className:"logo",children:[e.jsx("span",{children:"Ð•"}),e.jsx("span",{className:"b",children:"Ð‘"}),e.jsx("span",{children:"Ð»ÑƒÑˆÐ°"})]}),e.jsx("div",{className:"subtitle",children:"Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÐ¼ÑÑ"})]})}),e.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx("div",{ref:$e,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:re.data?.slice().sort((r,s)=>{const c=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(s.conversation.messages?.[0]?.createdAt?new Date(s.conversation.messages[0].createdAt).getTime():0)-c}).filter(r=>{const s=r.conversation;return!(s.isSecret&&(s.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const s=r.conversation,c=s.participants.filter(C=>qe?C.user.id!==qe:!0).map(C=>C.user),i=c.map(C=>C.displayName??C.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",d=s.title??i,f=s.isGroup||s.participants.length>2,u=!!s.isSecret;c.map(C=>C.displayName??C.username).join(", ");const p=a===s.id,v=!!xn[s.id]?.active,j=h===s.id;return e.jsxs("div",{onContextMenu:C=>{C.preventDefault(),C.stopPropagation(),!t&&qt({open:!0,x:C.clientX,y:C.clientY,conversationId:s.id})},onClick:()=>En(s.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...v?{background:j?"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)":"linear-gradient(135deg, rgba(217, 119, 6, 0.10) 0%, rgba(227, 139, 10, 0.12) 100%)",borderColor:"var(--brand-600)",...j?p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.22), 0 6px 16px rgba(227,139,10,0.14)"}:p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.16)"}}:{}},children:[f?e.jsx(nt,{name:d?.trim()?.charAt(0)||"Ð“",id:s.id,avatarUrl:s.avatarUrl&&s.avatarUrl.trim()?s.avatarUrl:void 0,presence:v?"IN_CALL":void 0}):e.jsx(nt,{name:c[0]?.displayName??c[0]?.username??"D",id:c[0]?.id??s.id,presence:v?"IN_CALL":Vn(c[0]),avatarUrl:c[0]?.avatarUrl&&c[0].avatarUrl.trim()?c[0].avatarUrl:void 0}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:d}),!f&&u&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:e.jsx(pi,{size:12,color:"#22c55e"})})]}),e.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…`:(()=>{const C=xn[s.id];if(C?.active){const b=C.startedAt?Date.now()-C.startedAt:typeof C.elapsedMs=="number"?C.elapsedMs:0;return e.jsx("span",{children:di(b)})}else if(C&&C.endedAt){const b=C.endedAt,H=Date.now()-b,W=Math.floor(H/6e4);if(W<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(W<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",W," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const ce=Math.floor(W/60);if(ce<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",ce," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const de=new Date(b),ue=de.toLocaleDateString(),V=de.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",ue," Ð² ",V]})}return f?null:As(c[0]??{})})()})]}),t&&e.jsx("button",{type:"button","aria-label":"ÐœÐµÐ½ÑŽ Ð±ÐµÑÐµÐ´Ñ‹",title:"ÐœÐµÐ½ÑŽ",onClick:C=>{C.preventDefault(),C.stopPropagation();const b=C.currentTarget.getBoundingClientRect();qt({open:!0,x:Math.round(b.right-8),y:Math.round(b.bottom+6),conversationId:s.id})},style:{flexShrink:0,width:36,height:36,borderRadius:10,border:"1px solid transparent",background:"transparent",color:"var(--text-muted)",display:"inline-flex",alignItems:"center",justifyContent:"center",marginLeft:8,WebkitTapHighlightColor:"transparent"},children:e.jsx(xr,{size:20})})]},s.id)})}),en&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),Ct&&e.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),e.jsxs("div",{className:"conv-footer",children:[e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:12},children:[e.jsxs("div",{onClick:()=>Sn(!0),className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(kc,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Ð‘ÐµÑÐµÐ´Ð°"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})]}),e.jsxs("div",{onClick:bo,className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:$t.data&&$t.data.length>0?e.jsx(mc,{size:22}):gt.data&&gt.data.length>0?e.jsx(el,{size:22}):e.jsx(Ha,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:$t.data&&$t.data.length>0?"ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ":gt.data&&gt.data.length>0?"Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})]})]}),e.jsxs("div",{className:"tile",onClick:()=>Vr(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const s=(()=>{const v=D?.id;if(x?.conversationId||h||m||Y.activeConvId)return!0;if(v)try{for(const j of Object.values(xn||{}))if(j?.active&&Array.isArray(j.participants)&&j.participants.includes(v))return!0}catch{}return!1})()?"IN_CALL":io??Qt.data?.status,c=so?"ONLINE":"OFFLINE",i=(s??c??"OFFLINE").toString().toUpperCase(),d=["ONLINE","AWAY","BACKGROUND","IN_CALL","OFFLINE"],f=i,u=c,p=d.includes(f)?f:u,w=Qt.data?.avatarUrl??D?.avatarUrl??void 0;return e.jsx(nt,{name:D?.displayName??D?.username??"Me",id:D?.id??"me",presence:p,avatarUrl:w})})(),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:D?.displayName??D?.username??"Ð¯"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Qt.data?.eblid??"â€” â€” â€” â€”"]})]})]})]})]})]})}function ya(t){const n=t?"messages-pane slider-panel":"messages-pane",r=Ss,s=pr;let c="";return S?.isSecret&&(r?c="Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°.":mo?c=ia?`Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Â«${ia}Â»`:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.":s||(c="Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...")),e.jsxs("section",{className:n,children:[e.jsxs("header",{style:{...a?xn[a]?.active||m===a?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:I?"column":"row",justifyContent:I?"flex-start":"space-between",alignItems:I?"stretch":"center",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:I?"100%":"auto",padding:I?"0 8px":"0"},children:[t&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:go,children:e.jsx(pc,{size:18})}),S?(()=>{const i=S.participants.filter(v=>qe?v.user.id!==qe:!0).map(v=>v.user),d=i.map(v=>v.displayName??v.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",f=S.title??d,u=S.isGroup||S.participants.length>2;S.isSecret;const p=xn[S.id],w=p?.active;return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>We(!0),style:{cursor:"pointer"},children:e.jsx(nt,{name:f?.trim()?.charAt(0)||"Ð“",id:S.id,size:60,avatarUrl:S.avatarUrl&&S.avatarUrl.trim()?S.avatarUrl:void 0,presence:w?"IN_CALL":void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0,order:I?1:2},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),I&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:v=>{q({open:!0,anchor:v.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(xr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:w?e.jsx(e.Fragment,{children:(()=>{const v=p.participants||[],j=S.participants||[],C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsxs(e.Fragment,{children:[p.active&&e.jsx("span",{children:di(C)}),j.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[p.startedAt&&" â€¢ ",j.map((b,E)=>{const H=b.user,W=v.length>0&&v.includes(H.id);return e.jsxs("span",{style:{fontWeight:W?700:400,color:W?"var(--brand-600)":"var(--text-muted)"},children:[E>0&&", ",H.displayName??H.username,W&&" âœ“"]},H.id)})]})]})})()}):p&&p.endedAt?(()=>{const v=p.endedAt,C=Date.now()-v,b=Math.floor(C/6e4);let E="";if(b<1)E="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";else if(b<60)E=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${b} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;else{const W=Math.floor(b/60);if(W<24)E=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${W} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;else{const ce=new Date(v),de=ce.toLocaleDateString(),ue=ce.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});E=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${de} Ð² ${ue}`}}const H=S.participants||[];return e.jsxs(e.Fragment,{children:[e.jsx("span",{children:E}),H.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" â€¢ ",H.map((W,ce)=>{const de=W.user;return e.jsxs("span",{children:[ce>0&&", ",de.displayName??de.username]},de.id)})]})]})})():i.map(v=>v.displayName??v.username).join(", ")})]})]}):(()=>{const v=i[0];return e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(nt,{name:v?.displayName??v?.username??"D",id:v?.id??S.id,avatarUrl:v?.avatarUrl&&v.avatarUrl.trim()?v.avatarUrl:void 0,presence:p?.active?"IN_CALL":Vn(v),size:60})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[e.jsx("span",{children:f}),I&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:j=>{q({open:!0,anchor:j.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(xr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const j=m===a;if((p?.active||j)&&p){const C=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsx("span",{children:di(C)})}if(p&&p.endedAt&&!j){const C=p.endedAt,E=Date.now()-C,H=Math.floor(E/6e4);if(H<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(H<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",H," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const W=Math.floor(H/60);if(W<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",W," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const ce=new Date(C),de=ce.toLocaleDateString(),ue=ce.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",de," Ð² ",ue]})}return v?As(v):""})()})]})]})})()})():e.jsx("div",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚"})]}),oo&&S&&!!S.isSecret&&(S.participants?.length??0)<=2&&typeof document<"u"&&br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:I?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Pr(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:I?16:20,borderRadius:I?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:I?"center":"left"},onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:I?"column":"row",gap:I?8:0},children:[e.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚?"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Pr(!1),style:{alignSelf:I?"flex-end":void 0},children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ñƒ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."}),e.jsxs("div",{style:{display:"flex",justifyContent:I?"center":"flex-end",alignItems:"center",flexDirection:I?"column":"row",gap:I?12:8},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>Pr(!1),style:I?{width:"100%"}:void 0,children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:I?"100%":void 0},onClick:async()=>{if(a)try{await ie.delete(`/conversations/${a}`),F.invalidateQueries({queryKey:["conversations"]}),F.removeQueries({queryKey:["messages",a]}),Pr(!1),l(null)}catch(i){console.error("Failed to end secret conversation:",i)}},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ"})]})]})}),document.body),a&&(()=>{const i=xn[a],d=i?.active,f=S?.isGroup||(S?.participants.length??0)>2,u=m===a,p=h===a&&!u,w=D?.id,v=f&&d&&w&&i?.participants?.includes(w),j=!f&&(u||h===a||Y.activeConvId===a||d&&(Y.activeConvId===a||h===a)),C=v||j,b={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:I?"8px 12px":"12px 16px",flex:I?1:"auto",minWidth:I?0:"auto",fontSize:I?"14px":"15px",fontWeight:I?500:600,height:I?"42px":"46px",minHeight:I?"42px":"46px",boxSizing:"border-box"},E={display:"flex",alignItems:"center",gap:8,width:I?"100%":"auto",padding:I?"0 8px":"0",justifyContent:I?"center":"flex-end",marginLeft:I?0:"auto"},H={display:"inline-flex",alignItems:"center",justifyContent:"center",width:I?42:44,height:I?42:44,minWidth:I?42:44,padding:0,margin:0,borderRadius:999},W=async()=>{if(a&&await bs(!1))try{vs(a),Ea(a,!1),Y.startOutgoing(a,!1),kt(X=>{const se=X[a],le=D?.id;return se?.active?le&&se.participants&&!se.participants.includes(le)?{...X,[a]:{...se,participants:[...se.participants,le]}}:X:{...X,[a]:{startedAt:Date.now(),active:!0,participants:le?[le]:[]}}});const V=re.data?.find(X=>X.conversation.id===a)?.conversation;if(V?.isGroup||(V?.participants?.length??0)>2)y(a),k(X=>X===a?null:X);else{const X=a;R({conversationId:X,startedAt:Date.now(),video:!1}),ua(),A.current&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{R(se=>se?.conversationId===X?(Kn(),Rs(),Or(X),kt(le=>{const Le=le[X];if(Le?.active)return{...le,[X]:{...Le,active:!1,endedAt:Date.now()}};const{[X]:Je,...ze}=le;return ze}),Y.endCall(),null):se),A.current=null},3e4)}}catch(V){console.error("Error starting call:",V)}},ce=async()=>{if(a&&await bs(!0))try{vs(a),Ea(a,!0),Y.startOutgoing(a,!0),kt(X=>{const se=X[a],le=D?.id;return se?.active?le&&se.participants&&!se.participants.includes(le)?{...X,[a]:{...se,participants:[...se.participants,le]}}:X:{...X,[a]:{startedAt:Date.now(),active:!0,participants:le?[le]:[]}}});const V=re.data?.find(X=>X.conversation.id===a)?.conversation;if(V?.isGroup||(V?.participants?.length??0)>2)y(a),k(X=>X===a?null:X);else{const X=a;R({conversationId:X,startedAt:Date.now(),video:!0}),ua(),A.current&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{R(se=>se?.conversationId===X?(Kn(),Rs(),Or(X),kt(le=>{const Le=le[X];if(Le?.active)return{...le,[X]:{...Le,active:!1,endedAt:Date.now()}};const{[X]:Je,...ze}=le;return ze}),Y.endCall(),null):se),A.current=null},3e4)}}catch(V){console.error("Error starting call:",V)}},de=()=>{a&&(y(a),k(null))},ue=()=>d||u?C?e.jsxs(e.Fragment,{children:[!p&&e.jsxs("button",{className:"btn btn-secondary",onClick:de,style:b,children:[e.jsx(Na,{size:I?16:18}),I?"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ":" Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"]}),e.jsxs("button",{className:"btn",onClick:()=>{const V=S?.participants?.length??0,oe=V<=2,X=S?.isGroup||V>2;if(oe&&h)Or(h),kt(se=>{const le=se[h];return le?.active?{...se,[h]:{...le,active:!1,endedAt:Date.now()}}:se});else if(X&&h){try{nc(h)}catch{}kt(se=>{const le=se[h];if(!le||!le.participants)return se;const Le=D?.id;return!Le||!le.participants.includes(Le)?se:{...se,[h]:{...le,participants:le.participants.filter(Je=>Je!==Le)}}})}y(null),k(null),Y.endCall(),Ft()},style:{...b,background:"#ef4444",color:"#fff"},children:[e.jsx(mi,{size:I?16:18}),I?"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ":" Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),!I&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:V=>{q({open:!0,anchor:V.currentTarget})},style:H,children:e.jsx(xr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){y(a),k(oe=>oe===a?null:oe),Y.startOutgoing(a,!1);try{Ra(a,!1)}catch{}}else y(a),k(oe=>oe===a?null:oe),Y.startOutgoing(a,!1)},style:b,children:[e.jsx(yi,{size:I?16:18}),I?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){y(a),k(oe=>oe===a?null:oe),Y.startOutgoing(a,!0);try{Ra(a,!0)}catch{}}else y(a),k(oe=>oe===a?null:oe),Y.startOutgoing(a,!0)},style:b,children:[e.jsx(xi,{size:I?16:18}),I?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾"]}),!I&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:V=>{q({open:!0,anchor:V.currentTarget})},style:H,children:e.jsx(xr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{W()},style:b,children:[e.jsx(yi,{size:I?16:18}),I?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº":" Ð—Ð²Ð¾Ð½Ð¾Ðº"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{ce()},style:b,children:[e.jsx(xi,{size:I?16:18}),I?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾":" Ð’Ð¸Ð´ÐµÐ¾"]}),!I&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:V=>{q({open:!0,anchor:V.currentTarget})},style:H,children:e.jsx(xr,{size:22})})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:E,children:ue()}),or&&e.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:I?"100%":420,width:I?"100%":"auto"},children:[e.jsx("span",{style:{flex:1},children:or}),e.jsx("button",{type:"button",onClick:()=>Er(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:e.jsx(Lt,{size:14})})]})]})})()]}),!S?.isSecret&&gr&&e.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:I?"column":"row",gap:12,alignItems:I?"stretch":"center"},children:gr.isInitiator?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1},children:"Ð–Ð´Ñ‘Ð¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚."}),e.jsx("div",{style:{display:"flex",gap:8},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>ra(gr.conversationId),disabled:ni,style:{color:"#f87171"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[gr.initiatorName," Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ."]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>uo(gr.conversationId),disabled:ni,children:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>ra(gr.conversationId),disabled:ni,style:{color:"#bae6fd"},children:"ÐžÑ‚ÐºÐ°Ð·Ð°Ñ‚ÑŒÑÑ"})]})]})}),e.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),e.jsx("div",{ref:pe,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:a?S?.isSecret&&(!s||r)?e.jsx("div",{className:"messages-empty",children:c}):(()=>{const i=(Ot?[...Ot]:[]).filter(u=>!u.deletedAt).sort((u,p)=>new Date(u.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),d=ms,f=[...i||[],...d];return f?f.map((u,p)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const w=f[p-1],v=f[p+1],j=!v||v.senderId!==u.senderId,C=!!w&&w.senderId===u.senderId,b=u.senderId===D?.id,W=`${rt?"msg left":b?"msg me":"msg them"} ${C?"compact":"gap"}`,ce=rt?"msg-bubble left":b?"msg-bubble me":"msg-bubble them",de=j?`${ce} ${b&&!rt?"tail-right":"tail-left"}`:ce,ue=ca[u.senderId],V=ue?.displayName??ue?.username??(b?D?.displayName??D?.username??"Me":"User"),oe=ue?.id??(b?D?.id??"me":"user"),X=b?"#303845":yo(u.senderId),se="#f1f3f6",le=rt&&j,Le=rt,Je=u.createdAt?new Date(u.createdAt):null,ze=Je?Je.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",mt=(S?.participants||[]).map($=>$.user.id).filter($=>qe?$!==qe:!0),vn=u.receipts||[],_r=b&&mt.some($=>vn.some(me=>me.userId===$&&(me.status==="READ"||me.status==="SEEN"))),bn=b&&_r?"âœ“":"",Ts=($,me)=>{J({open:!0,x:$,y:me,messageId:u.id})},Ao=$=>{$.preventDefault(),Ts($.clientX,$.clientY)},To=()=>{const $=u.replyTo?.id;if(!$)return;const me=Et.current.get($);me&&me.scrollIntoView({behavior:"smooth",block:"center"})},va=(u.attachments||[]).filter($=>$?.type==="IMAGE").map($=>ks($)).filter($=>!!$),ba=$=>{const me=va.findIndex(ot=>ot===$);Ks({open:!0,index:me>=0?me:0,items:va})},No=I?{}:{onContextMenu:Ao,...{onPointerDown:$=>{const me=window.setTimeout(()=>Ts($.clientX,$.clientY),450),ot=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",ot),window.removeEventListener("pointermove",An)},An=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",ot),window.removeEventListener("pointermove",An)};window.addEventListener("pointerup",ot,{passive:!0}),window.addEventListener("pointermove",An,{passive:!0})}}};return e.jsxs("div",{className:W,...No,children:[Le&&(le?e.jsx(nt,{name:V,id:oe,avatarUrl:(()=>{const $=ca[u.senderId]?.avatarUrl;return $&&$.trim()?$:void 0})()}):e.jsx("div",{className:"avatar-spacer"})),e.jsxs("div",{className:de,"data-mid":u.id,ref:$=>{if(!$){Et.current.delete(u.id);return}Et.current.set(u.id,$),Ht.current?.observe($)},style:{"--bubble-bg":X,"--bubble-fg":se},onClick:$=>{if(!I||$.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const ot=typeof window.getSelection=="function"?window.getSelection():null;ot&&ot.toString()||Ts($.clientX,$.clientY)},onContextMenu:$=>{if($.target.closest(".reaction-emoji")){$.preventDefault(),$.stopPropagation();return}Ts($.clientX,$.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const $={};for(const me of u.reactions)$[me.emoji]||($[me.emoji]={count:0,hasMine:!1}),$[me.emoji].count++,me.userId===D?.id&&($[me.emoji].hasMine=!0);return e.jsx("div",{style:{position:"absolute",bottom:-18,right:b?8:void 0,left:b?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries($).map(([me,ot],An)=>{const on=me==="â¤ï¸"?"#ef4444":"#ffc46b";return e.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async Qn=>{Qn.preventDefault(),Qn.stopPropagation();try{ot.hasMine?await ie.post("/messages/unreact",{messageId:u.id,emoji:me}):await ie.post("/messages/react",{messageId:u.id,emoji:me}),a&&F.invalidateQueries({queryKey:["messages",a]})}catch(ui){console.error("Error toggling reaction:",ui)}},onMouseDown:Qn=>{Qn.stopPropagation()},style:{fontSize:12,color:on,display:"inline-block",animation:`reactionBounce 0.6s ease ${An*.1}s`,cursor:"pointer",opacity:ot.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[me,ot.count>1?` ${ot.count}`:""]},me)})})})(),u.replyTo&&e.jsxs("div",{onClick:To,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:b?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°: ",u.replyTo.content??"ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(()=>{const $=u.attachments||[],me=$.filter(Ze=>Ze?.type==="IMAGE"),ot=typeof u.content=="string"?u.content.trim().length>0:!!u.content,An=$.some(Ze=>Ze?.type&&Ze.type!=="IMAGE"),Ns=me.length>0&&!ot&&!An,on=[];let Qn=!1;$.forEach((Ze,ve)=>{if(Ze?.type==="IMAGE"){Qn||(on.push({kind:"imageGroup",atts:me}),Qn=!0);return}on.push({kind:"single",att:Ze,idx:ve})});const ui=Ze=>{if(!Ze.length)return null;if(Ze.length===1){const te=Ze[0],tt=0,ct=te.metadata??{},Ye=ks(te),Ge=!!(S?.isSecret&&ct?.e2ee?.kind==="ciphertext"),lt=Ge?Yn[te.url]:void 0,It=Ge&&!Ye&&(!lt||lt.status==="pending"),Dt=Ge&&lt?.status==="error",Jn=typeof window<"u"?window.innerWidth:1280,Nn=Jn<=768?Math.max(320,Math.floor(Jn/2)):Math.min(600,Math.max(320,Math.floor(Jn/3))),Ds=`${te.url||tt}`,Br=Vi[Ds],Dn=Br?.width||te.width||te.metadata?.width||Nn,mr=Br?.height||te.height||te.metadata?.height||Math.round(Dn*.75),cn=mr/Dn||.75,wn=Nn;let Yt=Nn;cn<.5?Yt=Math.max(Math.round(Nn*.6),200):cn<.7&&(Yt=Math.max(Math.round(Nn*.75),200));const Do=Dn>wn?wn/Dn:1,Lo=mr>Yt?Yt/mr:1,wa=Math.min(Do,Lo,1);let Ln=Dn*wa,ln=mr*wa;Ln>wn&&(Ln=wn,ln=Ln*cn),ln>Yt&&(ln=Yt,Ln=ln/cn),Ln=Math.round(Ln),ln=Math.round(ln);const Zn=`${te.url||tt}`,hi=!!Gi[Zn],ja=!!qi[Zn],Ls=te.__pending||It||!hi&&!ja;return e.jsxs("div",{style:{maxWidth:"100%",maxHeight:ln,width:Ls?Math.min(Ln,typeof window<"u"?window.innerWidth-100:Ln):"fit-content",height:Ls?ln:"auto",minWidth:0,minHeight:Ls?ln:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Ns&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:ze}),!!bn&&e.jsx("span",{children:bn})]}),Ls&&e.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),It?e.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ..."}):typeof te.progress=="number"&&te.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[te.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Dt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"}),ja&&!Dt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"}),Ye&&!Dt&&e.jsx("img",{src:Ye,alt:"img",style:{maxWidth:"100%",maxHeight:ln,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:te.__pending?.85:1,display:hi?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:$r=>{const zs=$r.target;if(!te.width&&!ct?.width&&zs.naturalWidth&&zs.naturalHeight&&Ki(zn=>({...zn,[Zn]:{width:zs.naturalWidth,height:zs.naturalHeight}})),ps(zn=>({...zn,[Zn]:!1})),fs(zn=>({...zn,[Zn]:!0})),pe.current&&Wt.current){const zn=pe.current;zn.scrollTop=zn.scrollHeight}},onError:()=>{ps($r=>({...$r,[Zn]:!0})),fs($r=>({...$r,[Zn]:!0}))},onClick:()=>{!te.__pending&&!It&&Ye&&ba(Ye)}}),hi&&!It&&typeof te.progress=="number"&&te.progress<100&&e.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:e.jsx("div",{style:{width:`${te.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`images-single-${te.url||tt}`)}const ve=Ze.slice(0,4),et=Ze.length-ve.length,Nt=(te,tt)=>{const ct=te?.metadata??{},Ye=`${te?.url||tt}`,Ge=Vi[Ye],lt=Ge?.width||te?.width||ct?.width,It=Ge?.height||te?.height||ct?.height,Dt=typeof lt=="number"&&typeof It=="number"&&lt>0&&It>0?It/lt:1;return Math.max(.2,Math.min(5,Number.isFinite(Dt)?Dt:1))},Xt=(te,tt,ct)=>{const Ye=te.metadata??{},Ge=ks(te),lt=!!(S?.isSecret&&Ye?.e2ee?.kind==="ciphertext"),It=lt?Yn[te.url]:void 0,Dt=lt&&!Ge&&(!It||It.status==="pending"),Jn=lt&&It?.status==="error",Tn=`${te.url||tt}`,Nn=!!Gi[Tn],Ds=!!qi[Tn],Br=te.__pending||Dt||!Nn&&!Ds,Dn=te.__pending||Dt||Jn||!Ge,mr=Nt(te,tt);return e.jsxs("button",{type:"button",className:"msg-media-tile",style:{aspectRatio:1/mr},disabled:Dn,onClick:()=>{!Dn&&Ge&&ba(Ge)},children:[Ge&&e.jsx("img",{src:Ge,alt:"img",style:{opacity:Nn&&!Br?1:.001},onLoad:cn=>{const wn=cn.target;!te.width&&!Ye?.width&&wn.naturalWidth&&wn.naturalHeight&&Ki(Yt=>({...Yt,[Tn]:{width:wn.naturalWidth,height:wn.naturalHeight}})),ps(Yt=>({...Yt,[Tn]:!1})),fs(Yt=>({...Yt,[Tn]:!0}))},onError:()=>{ps(cn=>({...cn,[Tn]:!0})),fs(cn=>({...cn,[Tn]:!0}))}}),Br&&e.jsxs("div",{className:"msg-media-overlay",children:[e.jsx("div",{className:"msg-media-overlay-shimmer"}),Dt?e.jsx("div",{style:{position:"relative",zIndex:2,color:"var(--text-muted)",fontSize:12},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°..."}):typeof te.progress=="number"&&te.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[te.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),(Jn||Ds)&&e.jsx("div",{className:"msg-media-overlay",style:{background:"rgba(15, 23, 42, 0.55)"},children:e.jsx("div",{style:{position:"relative",zIndex:2,color:"#f87171",fontSize:12,padding:10,textAlign:"center"},children:Jn?"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸":"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"})}),ct&&e.jsxs("div",{className:"msg-media-more",children:["+",et]})]},`${te.url||tt}`)};return e.jsxs("div",{className:"msg-media-grid",children:[Ns&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:ze}),!!bn&&e.jsx("span",{children:bn})]}),ve.length===2&&(()=>{const te=Nt(ve[0],0),ct=Nt(ve[1],1),Ye=te;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${ct} 1 0`,minWidth:0},children:Xt(ve[0],0,!1)}),e.jsx("div",{style:{flex:`${Ye} 1 0`,minWidth:0},children:Xt(ve[1],1,et>0&&ve.length-1===1)})]})})(),ve.length===3&&(()=>{const te=Nt(ve[0],0),tt=Nt(ve[1],1),ct=Nt(ve[2],2),Ye=tt+ct,Ge=te;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${Ye} 1 0`,minWidth:0},children:Xt(ve[0],0,!1)}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${Ge} 1 0`},children:[Xt(ve[1],1,!1),Xt(ve[2],2,et>0&&ve.length-1===2)]})]})})(),ve.length>=4&&(()=>{const te=Nt(ve[0],0),tt=Nt(ve[1],1),ct=Nt(ve[2],2),Ye=Nt(ve[3],3),Ge=tt+Ye,lt=te+ct;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"msg-media-col",style:{flex:`${Ge} 1 0`},children:[Xt(ve[0],0,!1),Xt(ve[2],2,!1)]}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${lt} 1 0`},children:[Xt(ve[1],1,!1),Xt(ve[3],3,et>0)]})]})})()]},"images-mosaic")};return e.jsx(e.Fragment,{children:on.map((Ze,ve)=>{if(Ze.kind==="imageGroup")return e.jsx(o.Fragment,{children:ui(Ze.atts)},"images-group");const et=Ze.att,Nt=Ze.idx,Xt=et.metadata??{},te=ks(et),tt=!!(S?.isSecret&&Xt?.e2ee?.kind==="ciphertext"),ct=tt?Yn[et.url]:void 0,Ye=tt&&!te&&(!ct||ct.status==="pending"),Ge=tt&&ct?.status==="error",lt=Xt?.e2ee?.originalName||et.url?.split("/").pop()||"Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ";if(et.type==="AUDIO"){const It=u.metadata?.duration||0,Dt=te||et.url;return e.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:Ye?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[e.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{style:{fontSize:13},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð°ÑƒÐ´Ð¸Ð¾..."})]}):Ge?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°ÑƒÐ´Ð¸Ð¾"}):Dt?e.jsx(Dl,{url:Dt,duration:It}):e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})},`${et.url}-${Nt}-${ve}`)}return e.jsxs("div",{style:{marginTop:8},children:[et.__pending||Ye?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Ð¤Ð°Ð¹Ð»: ",lt,Ye&&" (Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°...)"]}):Ge?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»"}):e.jsxs("a",{href:te||et.url,target:"_blank",rel:"noreferrer",download:lt,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Ð¤Ð°Ð¹Ð»: ",lt]}),typeof et.progress=="number"&&et.progress<100&&e.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:e.jsx("div",{style:{width:`${et.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${et.url}-${Nt}-${ve}`)})})})()]}),(()=>{const $=u.attachments||[],me=typeof u.content=="string"?u.content.trim().length>0:!!u.content,ot=$.some(on=>on?.type&&on.type!=="IMAGE");return $.some(on=>on?.type==="IMAGE")&&!me&&!ot?null:e.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[ze," ",bn]})})()]})]},u.id)}):null})():e.jsx("div",{className:"messages-empty",children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ"})}),a&&e.jsx("button",{className:Kt?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{pe.current&&pe.current.scrollTo({top:pe.current.scrollHeight,behavior:"smooth"}),Wt.current=!0,Ve.current=!1,ke(!1)},children:"â†“"}),e.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:i=>{i.preventDefault(),Qs(!0)},onDragLeave:()=>Qs(!1),onDrop:async i=>{i.preventDefault(),Qs(!1);const d=Array.from(i.dataTransfer.files||[]);if(!d.length||!a)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>zr(p,"upload")),u.length&&await li(u)},children:S?.isSecret&&(!s||r)?e.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:c}):e.jsxs(e.Fragment,{children:[Q&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsx(Fc,{size:16,color:"var(--text-muted)"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°:"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:Q.preview}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>he(null),style:{marginLeft:"auto",flexShrink:0},children:e.jsx(Lt,{size:16})})]}),mn.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹"}),e.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:mn.map(i=>e.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[e.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{ls===i.id&&an(null),no(i.id)},"aria-label":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx(Lt,{size:14})}),e.jsx("button",{type:"button",onClick:()=>an(i.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx("img",{src:i.previewUrl,alt:i.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:i.fileName}),e.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>an(i.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),i.edited&&e.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"})]})]},i.id))})]}),e.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:G,onChange:async i=>{const d=Array.from(i.target.files||[]);if(!a||d.length===0)return;const f=d.filter(p=>p.type.startsWith("image/")),u=d.filter(p=>!p.type.startsWith("image/"));f.forEach(p=>zr(p,"upload")),u.length&&await li(u),i.target.value=""}}),Hi?e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),e.jsx("div",{ref:Lr,style:{width:"100%",...I?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const u=I?60:_i;return Dr.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(u).fill(0).map((p,w)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${w*.1}s`,flexShrink:0}},w))}):e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:Dr.length>u?`translateX(-${(Dr.length-u)*4}px)`:"translateX(0)",transition:"none"},children:Dr.slice(-u).map((p,w)=>{const v=Math.max(4,p/100*20);return e.jsx("div",{style:{width:2,height:`${v}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${Dr.length-u+w}-${w}`)})})})()}),e.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor(Wi/60),":",(Wi%60).toString().padStart(2,"0")]})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:ko,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ",children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:fa,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:e.jsx(La,{size:16})})]}):e.jsxs("form",{autoComplete:"off",onSubmit:async i=>{if(i.preventDefault(),!a)return;const d=O.trim();if(mn.length>0){const f=mn.map(u=>({file:u.file,previewUrl:u.previewUrl}));Nr([]),an(null),f.forEach(u=>Gn(u.previewUrl)),await li(f.map(u=>u.file),d||"",Q?.id),_(""),he(null)}else d&&(await sa(S,{type:"TEXT",content:d,replyToId:Q?.id}),_(""),he(null));F.invalidateQueries({queryKey:["messages",a]}),setTimeout(()=>{pe.current&&(pe.current.scrollTop=pe.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>G.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:I?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹",children:[e.jsx(_c,{size:16}),!I&&e.jsx("span",{children:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),e.jsx("input",{type:"text",placeholder:mn.length>0?"Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼...":"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...",value:O,onChange:i=>_(i.target.value),onPaste:i=>{if(!a)return;const d=i.clipboardData?.items;if(d)for(let f=0;f<d.length;f++){const u=d[f];if(u.type.indexOf("image")!==-1){i.preventDefault();const p=u.getAsFile();p&&zr(p,"paste");break}}},ref:T,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:So,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:I?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:[e.jsx(Pc,{size:16}),!I&&e.jsx("span",{children:"Ð“Ð¾Ð»Ð¾Ñ"})]}),e.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:I?0:6,height:46,minHeight:46,padding:"0 12px"},children:[e.jsx(La,{size:16}),!I&&e.jsx("span",{children:"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]}),eo&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:e.jsx("div",{style:{width:`${to}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),e.jsx(o.Suspense,{fallback:null,children:h&&e.jsx(El,{open:!!h,conversationId:h,minimized:m===h,peerAvatarUrl:(()=>{const d=(h?re.data?.find(f=>f.conversation.id===h)?.conversation:S)?.participants||[];return d.length===2?d.find(u=>qe?u.user.id!==qe:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const d=(h?re.data?.find(u=>u.conversation.id===h)?.conversation:S)?.participants||[],f={};for(const u of d){const p=u.user,w=p.displayName??p.username??p.id;f[w]=p.avatarUrl??null}return D&&(f[D.displayName??D.username??D.id]=Qt.data?.avatarUrl??D.avatarUrl??null),f})(),avatarsById:(()=>{const d=(h?re.data?.find(u=>u.conversation.id===h)?.conversation:S)?.participants||[],f={};for(const u of d){const p=u.user;f[p.id]=p.avatarUrl??null}return D&&(f[D.id]=Qt.data?.avatarUrl??D.avatarUrl??null),f})(),localUserId:D?.id??null,isGroup:!!(h?re.data?.find(d=>d.conversation.id===h)?.conversation:S)?.isGroup,onMinimize:()=>{if(h){const i=h;k(i);const d=xs(i);!!!(d?.isGroup||(d?.participants?.length??0)>2)&&Y.activeConvId!==i&&Y.startOutgoing(i,Y.initialVideo),h!==i&&y(i)}},onClose:i=>{const d=h??qn.current;if(!d||m===d)return;const f=()=>{const u=xs(d),p=u?.participants?.length??0,w=!!(u?.isGroup||p>2);!w&&Or(d),kt(j=>{const C=j[d];if(!C)return j;if(w){const b=(C.participants||[]).filter(E=>qe?E!==qe:!0);return{...j,[d]:{...C,participants:b}}}return C.active?{...j,[d]:{...C,active:!1,endedAt:Date.now()}}:j}),y(j=>j===d?null:j),k(j=>j===d?null:j),Y.endCall(),Ft()};!i?.manual&&ur(d)?si(d,f):(Rn(d),f())},initialVideo:Y.initialVideo,initialAudio:Y.initialAudio})}),e.jsx(il,{open:!!ys,image:ys,onClose:()=>an(null),onApply:({file:i,previewUrl:d})=>{ys&&(ro(ys.id,i,d),an(null))}}),x&&(()=>{const i=re.data?.find(b=>b.conversation.id===x.conversationId)?.conversation,d=i?.isGroup||(i?.participants?.length??0)>2;if(d)return null;let f="ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u,p=x.conversationId;if(d)f=i?.title??"Ð“Ñ€ÑƒÐ¿Ð¿Ð°",u=i?.avatarUrl,p=x.conversationId;else{const b=i?.participants?.find(E=>E.user.id!==D?.id)?.user;if(b)f=b.displayName??b.username??b.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u=b.avatarUrl,p=b.id;else{const E=gt.data?.find(H=>(H.conversationIds||[]).includes(x.conversationId));E?.friend&&(f=E.friend.displayName??E.friend.username??E.friend.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",u=E.friend.avatarUrl,p=E.friend.id)}}const w=Math.floor((Date.now()-x.startedAt)/1e3),v=Math.floor(w/60),j=w%60,C=`${v}:${j.toString().padStart(2,"0")}`;return br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700},children:x.video?"Ð’Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð—Ð²Ð¾Ð½Ð¾Ðº"}),!x.minimized&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{R(b=>b?{...b,minimized:!0}:null)},style:{padding:8},children:e.jsx(Hc,{size:18})})]}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[e.jsx(nt,{name:f,id:p,size:64,avatarUrl:u}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:f}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð´Ð¾Ð·Ð²Ð¾Ð½â€¦"})]}),e.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:C})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{A.current&&(window.clearTimeout(A.current),A.current=null),Kn(),Rs(),Or(x.conversationId),R(null),kt(b=>{const E=b[x.conversationId];if(E?.active)return{...b,[x.conversationId]:{...E,active:!1,endedAt:Date.now()}};const{[x.conversationId]:H,...W}=b;return W}),Y.endCall()},children:[e.jsx(mi,{size:18}),e.jsx("span",{children:"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"})]}),x.minimized&&e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{R(b=>b?{...b,minimized:!1}:null)},children:[e.jsx(Na,{size:18}),e.jsx("span",{children:"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"})]})]})]})}),document.body)})(),Y.incoming&&br.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:12},children:Y.incoming.video?"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð°ÑƒÐ´Ð¸Ð¾Ð·Ð²Ð¾Ð½Ð¾Ðº"}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[e.jsx(nt,{name:Y.incoming.from.name??Y.incoming.from.id,id:Y.incoming.from.id,size:64,avatarUrl:Y.incoming.from.avatarUrl??re.data?.find(i=>i.conversation.id===Y.incoming.conversationId)?.conversation?.participants?.find(i=>i.user.id===Y.incoming.from.id)?.user?.avatarUrl??gt.data?.find(i=>i.friend?.id===Y.incoming.from.id)?.friend?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:Y.incoming.from.name??Y.incoming.from.id}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð·Ð²Ð¾Ð½Ð¸Ñ‚â€¦"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{ws(!1)},children:[e.jsx(yi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ"})]}),e.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{ws(!0)},children:[e.jsx(xi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"})]})]}),e.jsx("div",{style:{display:"flex"},children:e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{ai()},children:[e.jsx(mi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})}),or&&e.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:or})]})]})}),document.body)]})}function xa(t,n){n&&F.setQueryData(["messages",t],r=>{const s=Array.isArray(r)?[...r]:[];return s.some(c=>c.id===n.id)||(s.push(n),s.sort((c,i)=>new Date(c.createdAt||0).getTime()-new Date(i.createdAt||0).getTime())),s})}function Eo(t,n){n&&F.setQueryData(["messages",t],r=>{if(!Array.isArray(r))return r;const s=r.findIndex(i=>i.id===n.id);if(s===-1)return r;const c=[...r];return c[s]={...c[s],...n},c})}return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:I?"chats-page mobile-slider":"chats-page",children:I?e.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${Ut==="conversation"?"-100vw":"0"})`},onTouchStart:t=>{const n=t.touches[0];vt.current={x:n.clientX,y:n.clientY},At.current=0},onTouchMove:t=>{if(!vt.current)return;const n=t.touches[0];At.current=n.clientX-vt.current.x},onTouchEnd:()=>{const t=At.current;vt.current=null,!(Math.abs(t)<50)&&(t<0&&a&&Be("conversation"),t>0&&Be("list"))},children:[ma(!0),ya(!0)]}):e.jsxs(e.Fragment,{children:[ma(!1),ya(!1)]})}),Za&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Vr(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(nt,{name:D?.displayName??D?.username??"Me",id:D?.id??"me",avatarUrl:_t??Qt.data?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:D?.displayName??D?.username}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Qt.data?.eblid??"â€” â€” â€” â€”"]})]})]}),e.jsx("input",{ref:Ni,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){Qr(n);try{Jr(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!_t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>Ni.current?.click(),onDragOver:t=>{t.preventDefault(),qs(!0)},onDragLeave:()=>qs(!1),onDrop:t=>{t.preventDefault(),qs(!1);const n=t.dataTransfer.files?.[0];if(n){Qr(n);try{Jr(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(zi?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:zi?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(fi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),_t&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:On,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Ie.scale*(1+n))),s=On.current?.getBoundingClientRect();if(s){const c=t.clientX-s.left,i=t.clientY-s.top,d=r/Ie.scale,f=c-(c-Ie.x)*d,u=i-(i-Ie.y)*d;In({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=On.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,c=r/2,i=s/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,w=u-c,v=p-i;if(w*w+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const j=t.clientX,C=t.clientY,b={...Ie},E=W=>{W.preventDefault();const ce=W.clientX-j,de=W.clientY-C;In({...b,x:b.x+ce,y:b.y+de})},H=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Ys,src:_t,alt:"preview",style:{position:"absolute",left:Ie.x,top:Ie.y,transform:`scale(${Ie.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=On.current;if(!r)return;const s=r.clientWidth,c=r.clientHeight,i=240,d=n.naturalWidth,f=n.naturalHeight,u=s/2,p=c/2,w=i/d,v=i/f,j=Math.max(w,v)*1.2,C=u-d*j/2,b=p-f*j/2;In({x:C,y:b,scale:j})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Ie.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>In(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.05,value:Ie.scale,onChange:t=>In(n=>({...n,scale:parseFloat(t.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>In(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:e.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:I?"Ð”Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°, Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ":"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾ Ð¼Ñ‹ÑˆÐ¸ Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°"})})]}),e.jsx("canvas",{ref:Zr,width:240,height:240,style:{display:"none"}})]}),Xs&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{Qr(null),_t&&URL.revokeObjectURL(_t),Jr(null)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:sr,onClick:async()=>{if(Xs){Kr(!0),es(0);try{let t=null;if(Zr.current&&_t){const s=await new Promise(b=>{const E=new Image;E.onload=()=>b(E),E.src=_t}),c=Zr.current.getContext("2d"),i=240;c.clearRect(0,0,i,i),c.save(),c.beginPath(),c.arc(i/2,i/2,i/2,0,Math.PI*2),c.closePath(),c.clip();const d=On.current?.clientWidth??320,f=On.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-i/2,y:u.y-i/2,w:i,h:i},w=(p.x-Ie.x)/Ie.scale,v=(p.y-Ie.y)/Ie.scale,j=p.w/Ie.scale,C=p.h/Ie.scale;c.drawImage(s,w,v,j,C,0,0,i,i),c.restore(),t=await new Promise(b=>Zr.current.toBlob(E=>b(E),"image/png"))}const n=new FormData;n.append("file",t??Xs);const r=await new Promise((s,c)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const d=er.getState().session?.accessToken;d&&i.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}i.upload.onprogress=d=>{d.lengthComputable&&es(Math.round(100*d.loaded/d.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const d=JSON.parse(i.responseText);s(d.url)}catch(d){c(d)}else c(new Error("upload failed"))},i.send(n)});await ie.patch("/status/me",{avatarUrl:r}),Qr(null),_t&&URL.revokeObjectURL(_t),Jr(null),Qt.refetch()}catch{}Kr(!1),ir("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ir(null),2200)}},children:sr?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),sr&&e.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Ti}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),as&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[e.jsx(Ta,{size:16}),e.jsx("span",{children:as})]}),e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:e.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await ie.post("/auth/logout")}catch{}er.getState().setSession(null),Vr(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[e.jsx(gi,{size:18}),e.jsx("span",{children:"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð•Ð±Ð»ÑƒÑˆÐ¸"})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Vr(!1),children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})}),Va&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>kn(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>kn(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(nt,{name:tn.trim()||"?",id:"new-group-avatar-preview",avatarUrl:nn??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:tn||"ÐÐ¾Ð²Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:Ws,type:"file",accept:"image/*",style:{display:"none"},onChange:t=>{const n=t.target.files?.[0];if(n){if(Ke(n),Xe)try{URL.revokeObjectURL(Xe)}catch{}try{const r=URL.createObjectURL(n);Tt(r)}catch{Tt(null)}rn({x:0,y:0,scale:1})}}}),!Xe&&e.jsx(e.Fragment,{children:e.jsxs("div",{onClick:()=>Ws.current?.click(),onDragOver:t=>{t.preventDefault(),Bs(!0)},onDragLeave:()=>Bs(!1),onDrop:t=>{t.preventDefault(),Bs(!1);const n=t.dataTransfer.files?.[0];if(n){if(Ke(n),Xe)try{URL.revokeObjectURL(Xe)}catch{}try{const r=URL.createObjectURL(n);Tt(r)}catch{Tt(null)}rn({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(Ai?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Ai?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(fi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})}),Xe&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:Wn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Qe.scale*(1+n))),s=Wn.current?.getBoundingClientRect();if(s){const c=t.clientX-s.left,i=t.clientY-s.top,d=r/Qe.scale,f=c-(c-Qe.x)*d,u=i-(i-Qe.y)*d;rn({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=Wn.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,c=r/2,i=s/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,w=u-c,v=p-i;if(w*w+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const j=t.clientX,C=t.clientY,b={...Qe},E=W=>{W.preventDefault();const ce=W.clientX-j,de=W.clientY-C;rn({...b,x:b.x+ce,y:b.y+de})},H=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Ka,src:Xe,alt:"preview",style:{position:"absolute",left:Qe.x,top:Qe.y,transform:`scale(${Qe.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=Wn.current;if(!r)return;const s=r.clientWidth,c=r.clientHeight,i=240,d=n.naturalWidth,f=n.naturalHeight,u=s/2,p=c/2,w=i/d,v=i/f,j=Math.max(w,v)*1.2,C=u-d*j/2,b=p-f*j/2;rn({x:C,y:b,scale:j})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>rn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Qe.scale,onChange:t=>{const n=parseFloat(t.target.value),r=Wn.current?.getBoundingClientRect();if(!r){rn(u=>({...u,scale:n}));return}const s=r.width/2,c=r.height/2,i=n/Qe.scale,d=s-(s-Qe.x)*i,f=c-(c-Qe.y)*i;rn({x:d,y:f,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>rn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:_s,width:240,height:240,style:{display:"none"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>{kn(!1)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:!Xe,onClick:async()=>{if(!Xe||!_s.current){kn(!1);return}try{const t=await new Promise(C=>{const b=new Image;b.onload=()=>C(b),b.src=Xe}),n=_s.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const s=240;r.clearRect(0,0,s,s),r.save(),r.beginPath(),r.arc(s/2,s/2,s/2,0,Math.PI*2),r.closePath(),r.clip();const c=Wn.current?.clientWidth??320,i=Wn.current?.clientHeight??320,d={x:c/2,y:i/2},f={x:d.x-s/2,y:d.y-s/2,w:s,h:s},u=(f.x-Qe.x)/Qe.scale,p=(f.y-Qe.y)/Qe.scale,w=f.w/Qe.scale,v=f.h/Qe.scale;r.drawImage(t,u,p,w,v,0,0,s,s),r.restore();const j=await new Promise(C=>n.toBlob(b=>C(b),"image/png"));if(j){if(nn)try{URL.revokeObjectURL(nn)}catch{}const C=URL.createObjectURL(j);Ei(j),Ir(C)}}catch{}finally{kn(!1)}},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]})]})}),Sr&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:oi,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700},children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:oi,children:e.jsx(Lt,{size:16})})]}),(()=>{const t=tn.trim(),n=t||"?";return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[e.jsx("input",{placeholder:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ",value:tn,onChange:r=>Gr(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),e.jsx("input",{ref:Ws,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const s=r.target.files?.[0];if(s){if(Ke(s),Xe)try{URL.revokeObjectURL(Xe)}catch{}try{const c=URL.createObjectURL(s);Tt(c)}catch{Tt(null)}kn(!0)}}}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>kn(!0),title:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:e.jsx(nt,{name:n,id:"new-group-avatar",avatarUrl:nn??void 0,size:40})})]})})(),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:gt.data?.map(t=>{const n=t.friend,r=nr.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>qr(s=>r?s.filter(c=>c!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[e.jsx(nt,{name:n.displayName??n.username,id:n.id,presence:Vn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾":"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},t.id)})}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:e.jsx("button",{className:"btn btn-primary",disabled:nr.length===0||kr,onClick:async()=>{if(!(nr.length===0||kr)){rr(!0);try{const t=await ie.post("/conversations",{participantIds:nr,title:tn||void 0,isGroup:!0}),n=t.data?.conversation?.id;if(n&&(Ri||St))try{const r=new FormData;r.append("file",Ri??St);const s=await new Promise((c,i)=>{const d=new XMLHttpRequest;d.open("POST","/api/upload");try{const f=er.getState().session?.accessToken;f&&d.setRequestHeader("Authorization",`Bearer ${f}`)}catch{}d.onreadystatechange=()=>{if(d.readyState===4)if(d.status>=200&&d.status<300)try{const f=JSON.parse(d.responseText);c(f.url)}catch(f){i(f)}else i(new Error(`upload failed: ${d.status} ${d.statusText}`))},d.onerror=()=>i(new Error("Network error during upload")),d.send(r)});await ie.patch(`/conversations/${n}`,{avatarUrl:s})}catch(r){console.error("Error setting group avatar:",r)}F.invalidateQueries({queryKey:["conversations"]}),t.data?.conversation?.id&&En(t.data.conversation.id),oi()}catch(t){console.error("Error creating group:",t),alert(t?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ")}finally{rr(!1)}}},children:kr?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...":"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"})})]})}),$s&&e.jsxs("div",{className:"contacts-overlay",onClick:()=>{if(ht.open){wt({open:!1,x:0,y:0,contactId:null,user:null});return}_n(!1)},role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"contacts-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"contacts-modal__header",children:[e.jsx("div",{className:"contacts-modal__title",children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{wt({open:!1,x:0,y:0,contactId:null,user:null}),_n(!1)},"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",children:e.jsx(Lt,{size:16})})]}),e.jsxs("div",{className:"contacts-modal__body",children:[$t.data&&$t.data.length>0&&e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"}),e.jsx("div",{className:"contacts-section__list",children:$t.data.map(t=>e.jsxs("div",{className:"tile",children:[e.jsx(nt,{name:t.friend.displayName??t.friend.username,id:t.friend.id,presence:t.friend.status,avatarUrl:t.friend.avatarUrl??void 0}),e.jsxs("div",{className:"contacts-tile__main",children:[e.jsx("div",{className:"contacts-tile__name",children:t.friend.displayName??t.friend.username}),e.jsx("div",{className:"contacts-tile__meta",children:"Ñ…Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ"})]}),e.jsxs("div",{className:"contacts-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ie.post("/contacts/respond",{contactId:t.id,action:"reject"}),$t.refetch()},children:"ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{await ie.post("/contacts/respond",{contactId:t.id,action:"accept"}),gt.refetch(),$t.refetch(),re.refetch()},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]},t.id))})]}),e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ EBLID"}),e.jsx("div",{className:"contacts-section__hint",children:"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 4 Ñ†Ð¸Ñ„Ñ€Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ."}),e.jsx("div",{className:"contacts-eblid__inputs",children:[0,1,2,3].map(t=>e.jsx("input",{ref:Rr[t],className:"contacts-eblid__digit",type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:Bn[t],onChange:n=>ha(t,n.target.value.replace(/\D/g,"").slice(0,1)),onKeyDown:n=>{if(/^\d$/.test(n.key)){n.preventDefault(),ha(t,n.key);return}if(n.key!=="Backspace")return;if(n.preventDefault(),Bn[t]!==""){const s=[...Bn];s[t]="",Mr(s),$n(null);return}if(t<=0)return;const r=[...Bn];r[t-1]="",Mr(r),$n(null),Rr[t-1].current?.focus()},maxLength:1},t))}),gn&&e.jsxs("div",{className:"tile contacts-found",style:{marginTop:12},children:[e.jsx(nt,{name:gn.displayName??gn.username,id:gn.id,presence:Vn(gn),avatarUrl:gn.avatarUrl??void 0}),e.jsxs("div",{className:"contacts-tile__main",children:[e.jsx("div",{className:"contacts-tile__name",children:gn.displayName??gn.username}),e.jsx("div",{className:"contacts-tile__meta",children:ga(gn)})]}),e.jsx("div",{className:"contacts-actions",children:e.jsx("button",{disabled:Qa,className:"btn btn-primary",onClick:wo,children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})})]}),e.jsxs("div",{className:"contacts-my-eblid",children:[e.jsx("div",{className:"contacts-my-eblid__label",children:"ÐœÐ¾Ð¹ EBLID:"}),e.jsx("div",{className:"contacts-my-eblid__value",children:Fs||"â€” â€” â€” â€”"}),e.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{Fs&&navigator.clipboard.writeText(Fs)},title:"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID","aria-label":"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID",children:e.jsx(Rc,{size:16})})]})]}),e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐœÐ¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ"}),e.jsx("div",{className:"contacts-friends__list",children:(gt.data||[]).length===0?e.jsx("div",{className:"contacts-empty",children:"ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð´Ñ€ÑƒÐ·ÐµÐ¹. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚ Ð¿Ð¾ EBLID."}):(gt.data||[]).map(t=>{const n=t.friend,r=typeof n?.id=="string"?Ro[n.id]:void 0,s=typeof n?.id=="string"&&pa?n.id===pa:!1,c=n.displayName??n.username;return e.jsxs("div",{className:`contacts-nav-item ${s?"is-active":""}`,role:"button",tabIndex:0,onContextMenu:i=>{i.preventDefault(),i.stopPropagation();const d=i.currentTarget.getBoundingClientRect(),p=Math.min(i.clientX,window.innerWidth-220-12),w=Math.min(d.bottom+6,window.innerHeight-180);wt({open:!0,x:p,y:w,contactId:t.id,user:n})},onKeyDown:async i=>{if(i.key!=="Enter"&&i.key!==" ")return;i.preventDefault();const d=await ie.post("/conversations",{participantIds:[n.id],isGroup:!1});wt({open:!1,x:0,y:0,contactId:null,user:null}),_n(!1),En(d.data.conversation.id),F.invalidateQueries({queryKey:["conversations"]})},onClick:async()=>{const i=await ie.post("/conversations",{participantIds:[n.id],isGroup:!1});wt({open:!1,x:0,y:0,contactId:null,user:null}),_n(!1),En(i.data.conversation.id),F.invalidateQueries({queryKey:["conversations"]})},children:[e.jsx(nt,{name:c,id:n.id,presence:Vn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{className:"contacts-nav-item__main",children:[e.jsxs("div",{className:"contacts-nav-item__name-row",children:[e.jsx("div",{className:"contacts-nav-item__name",title:c,children:c}),r&&e.jsx("div",{className:`contacts-secret-badge ${r==="PENDING"?"is-pending":""}`,title:r==="PENDING"?"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ (Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ)":"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚","aria-label":r==="PENDING"?"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ (Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ)":"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚",children:e.jsx(pi,{size:14})})]}),e.jsx("div",{className:"contacts-nav-item__status",children:ga(n)})]}),e.jsx("button",{type:"button",className:"contacts-menu-btn","aria-label":"ÐœÐµÐ½ÑŽ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°","aria-haspopup":"menu",onClick:i=>{i.preventDefault(),i.stopPropagation();const d=i.currentTarget.getBoundingClientRect(),p=Math.min(d.right,window.innerWidth-220-12),w=Math.min(d.bottom+6,window.innerHeight-180);wt({open:!0,x:p,y:w,contactId:t.id,user:n})},children:"â‹¯"})]},t.id)})})]})]})]}),ht.open&&ht.contactId&&ht.user&&e.jsx("div",{className:"contacts-menu-overlay",onClick:t=>{t.preventDefault(),t.stopPropagation(),wt({open:!1,x:0,y:0,contactId:null,user:null})},children:e.jsxs("div",{ref:z,className:"ctx-menu",style:{position:"fixed",left:ht.x,top:ht.y},onClick:t=>t.stopPropagation(),role:"menu",children:[e.jsx("button",{type:"button",role:"menuitem",onClick:async()=>{const t=ht.user.id,n=await ie.post("/conversations",{participantIds:[t],isGroup:!1});wt({open:!1,x:0,y:0,contactId:null,user:null}),_n(!1),En(n.data.conversation.id),F.invalidateQueries({queryKey:["conversations"]})},children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‡Ð°Ñ‚"}),e.jsx("button",{type:"button",role:"menuitem",onClick:async()=>{const t=ht.user.id;await na(t),wt({open:!1,x:0,y:0,contactId:null,user:null}),_n(!1),F.invalidateQueries({queryKey:["conversations"]})},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{type:"button",role:"menuitem",className:"ctx-menu__danger",onClick:async()=>{await ie.post("/contacts/remove",{contactId:ht.contactId}),wt({open:!1,x:0,y:0,contactId:null,user:null}),gt.refetch()},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})})]}),Re.open&&Re.messageId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>J({open:!1,x:0,y:0,messageId:null}),children:e.jsxs("div",{ref:ea,className:"msg-menu",style:{position:"absolute",left:Re.x,top:Re.y,color:"#ffffff"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["ðŸ‘","â¤ï¸","ðŸ‘Ž","ðŸ”¥","ðŸ¤","ðŸ˜†"].map((t,n)=>{const s=t==="â¤ï¸"?"#ef4444":"#ffffff";return e.jsx("button",{onClick:async()=>{try{const c=Re.messageId;((Ot||[]).find(f=>f.id===c)?.reactions||[]).some(f=>f.userId===D?.id&&f.emoji===t)?await ie.post("/messages/unreact",{messageId:c,emoji:t}):await ie.post("/messages/react",{messageId:c,emoji:t}),a&&F.invalidateQueries({queryKey:["messages",a]})}catch{}J({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:s,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${n*.05}s both`},onMouseEnter:c=>{c.currentTarget.style.transform="scale(1.2)"},onMouseLeave:c=>{c.currentTarget.style.transform="scale(1)"},children:t},t)})}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const t=Re.messageId,n=(Ot||[]).find(r=>r.id===t);he({id:t,preview:(n?.content??"").slice(0,100)}),J({open:!1,x:0,y:0,messageId:null})},children:"Ð¦Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),(()=>{const t=Re.messageId;return(Ot||[]).find(s=>s.id===t)?.senderId===D?.id?e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await ie.post("/messages/delete",{messageId:Re.messageId}),a&&F.invalidateQueries({queryKey:["messages",a]})}catch{}J({open:!1,x:0,y:0,messageId:null})},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}):null})(),e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const t=Re.messageId,n=(Ot||[]).find(r=>r.id===t);try{await navigator.clipboard.writeText(n?.content||"")}catch{}J({open:!1,x:0,y:0,messageId:null})},children:"ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{Vt({open:!0,messageId:Re.messageId}),J({open:!1,x:0,y:0,messageId:null})},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ"})]})}),e.jsx(al,{open:Vs.open,items:Vs.items,index:Vs.index,onClose:()=>Ks(t=>({...t,open:!1})),onIndexChange:t=>Ks(n=>({...n,index:t}))}),Pt.open&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>Vt({open:!1,messageId:null}),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"}),e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(re.data||[]).map(t=>{const n=t.conversation,s=n.participants.filter(i=>qe?i.user.id!==qe:!0).map(i=>i.user).map(i=>i.displayName??i.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",c=n.title??s;return e.jsx("div",{className:"tile",onClick:async()=>{const i=Pt.messageId,d=(Ot||[]).find(f=>f.id===i);d&&(await sa(n,{type:"TEXT",content:`â†ª ${d.content??""}`,replyToId:void 0}),Vt({open:!1,messageId:null}))},children:e.jsx("div",{style:{fontWeight:600},children:c})},n.id)})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>Vt({open:!1,messageId:null}),children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})})]})}),tr&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:hr,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:hr,children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Ð˜Ð· Ð´Ñ€ÑƒÐ·ÐµÐ¹"},{key:"eblid",label:"ÐŸÐ¾ EBLID"}].map(t=>{const n=M===t.key;return e.jsx("button",{className:"btn btn-ghost",onClick:()=>Z(t.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:t.label},t.key)})}),e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:M==="friends"?"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ Ð² ÑÑ‚Ñƒ Ð±ÐµÑÐµÐ´Ñƒ.":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ EBLID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±ÐµÑÐµÐ´Ñƒ."}),M==="friends"?e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:la.length===0?e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ."}):la.map(t=>{const n=t.friend,r=Hn.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Cr(s=>r?s.filter(c=>c!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[e.jsx(nt,{name:n.displayName??n.username,id:n.id,presence:Vn(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:As(n)})]}),e.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},t.id)})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(t=>e.jsx("input",{ref:ne[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:L[t],onChange:n=>po(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},t))}),De&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñâ€¦"}),P&&e.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[e.jsx(nt,{name:P.displayName??P.username,id:P.id,presence:P.status,avatarUrl:P.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:P.displayName??P.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Is.alreadyInChat?"Ð£Ð¶Ðµ Ð² Ð±ÐµÑÐµÐ´Ðµ":Is.isSelf?"Ð­Ñ‚Ð¾ Ð²Ñ‹":"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]})]}),!P&&Oe&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:Oe})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[e.jsx("button",{className:"btn btn-secondary",onClick:hr,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:g||(M==="friends"?Hn.length===0:!P||Is.alreadyInChat||Is.isSelf),onClick:M==="friends"?ho:fo,children:g?"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ...":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]})}),Ee.open&&Ee.conversationId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>qt({open:!1,x:0,y:0,conversationId:null}),children:e.jsx("div",{ref:Zt,className:"msg-menu",style:{position:"absolute",left:Ee.x,top:Ee.y},onClick:t=>t.stopPropagation(),children:(()=>{const n=(re.data||[]).find(c=>c.conversation.id===Ee.conversationId)?.conversation||(a===Ee.conversationId?S:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),s=async()=>{try{r?await ie.delete(`/conversations/${Ee.conversationId}/participants/me`):await ie.delete(`/conversations/${Ee.conversationId}`),F.invalidateQueries({queryKey:["conversations"]}),a===Ee.conversationId&&(l(null),I&&Be("list"))}catch{}qt({open:!1,x:0,y:0,conversationId:null})};return e.jsxs("button",{onClick:s,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?e.jsx(gi,{size:16}):e.jsx(Pa,{size:16}),r?"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ"]})})()})}),B.open&&B.anchor&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>q({open:!1,anchor:null}),children:e.jsx("div",{ref:ye,className:"msg-menu",style:{position:"fixed"},onClick:t=>t.stopPropagation(),children:(()=>{const t=S.isGroup||(S.participants?.length??0)>2,n=!!S.isSecret&&!t,r=!t&&S.participants?.find(s=>s.user.id!==qe)?.user;return t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{Cr([]),Z("friends"),ee(["","","",""]),we(null),je(null),_e(!1),jr(!0),q({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Ha,{size:16}),"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"]}),e.jsxs("button",{onClick:async()=>{if(a){try{await ie.delete(`/conversations/${a}/participants/me`),F.invalidateQueries({queryKey:["conversations"]}),l(null),I&&Be("list")}catch(s){console.error("Failed to leave conversation:",s)}q({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(gi,{size:16}),"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹"]})]}):e.jsxs(e.Fragment,{children:[n?e.jsxs("button",{onClick:()=>{Pr(!0),q({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Tc,{size:16}),"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}):e.jsxs("button",{onClick:async()=>{r?.id&&await na(r.id),q({open:!1,anchor:null})},disabled:Ji,style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(pi,{size:16}),"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}),e.jsxs("button",{onClick:async()=>{if(a){try{await ie.delete(`/conversations/${a}`),F.invalidateQueries({queryKey:["conversations"]}),F.removeQueries({queryKey:["messages",a]}),l(null),I&&Be("list")}catch(s){console.error("Failed to delete conversation:",s)}q({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(Pa,{size:16}),"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚"]})]})})()})}),Ae&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>We(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>We(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(nt,{name:S.title?.trim()?.charAt(0)||"Ð“",id:S.id,avatarUrl:Bt??S.avatarUrl??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:S.title||"Ð“Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:Di,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){is(n);try{rs(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Bt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>Di.current?.click(),onDragOver:t=>{t.preventDefault(),Gs(!0)},onDragLeave:()=>Gs(!1),onDrop:t=>{t.preventDefault(),Gs(!1);const n=t.dataTransfer.files?.[0];if(n){is(n);try{rs(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Li?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Li?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(fi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),Bt&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:Mn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Me.scale*(1+n))),s=Mn.current?.getBoundingClientRect();if(s){const c=t.clientX-s.left,i=t.clientY-s.top,d=r/Me.scale,f=c-(c-Me.x)*d,u=i-(i-Me.y)*d;sn({x:f,y:u,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=Mn.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,c=r/2,i=s/2,f=240/2,u=t.clientX-n.left,p=t.clientY-n.top,w=u-c,v=p-i;if(w*w+v*v>f*f)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const j=t.clientX,C=t.clientY,b={...Me},E=W=>{W.preventDefault();const ce=W.clientX-j,de=W.clientY-C;sn({...b,x:b.x+ce,y:b.y+de})},H=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:ts,src:Bt,alt:"preview",style:{position:"absolute",left:Me.x,top:Me.y,transform:`scale(${Me.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=Mn.current;if(!r)return;const s=r.clientWidth,c=r.clientHeight,i=240,d=n.naturalWidth,f=n.naturalHeight,u=s/2,p=c/2,w=i/d,v=i/f,j=Math.max(w,v)*1.2,C=u-d*j/2,b=p-f*j/2;sn({x:C,y:b,scale:j})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Me.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>sn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.01,value:Me.scale,onChange:t=>{const n=parseFloat(t.target.value);sn(r=>{const s=Mn.current?.getBoundingClientRect();if(!s)return{...r,scale:n};const c=s.width,i=s.height,d=c/2,f=i/2,u=ts.current;if(u){const p=u.naturalWidth,w=u.naturalHeight,v=r.x+p*r.scale/2,j=r.y+w*r.scale/2,C=v-d,b=j-f,E=n/r.scale,H=d+C*E,W=f+b*E,ce=H-p*n/2,de=W-w*n/2;return{x:ce,y:de,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>sn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:ns,width:240,height:240,style:{display:"none"}})]}),ss&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{is(null),Bt&&URL.revokeObjectURL(Bt),rs(null),sn({x:0,y:0,scale:1})},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:sr,onClick:async()=>{if(!(!ss||!S)){Kr(!0),es(0);try{let t=null;if(ns.current&&Bt){const s=await new Promise(b=>{const E=new Image;E.onload=()=>b(E),E.src=Bt}),c=ns.current.getContext("2d");if(!c)throw new Error("Could not get 2d context from canvas");const i=240;c.clearRect(0,0,i,i),c.save(),c.beginPath(),c.arc(i/2,i/2,i/2,0,Math.PI*2),c.closePath(),c.clip();const d=Mn.current?.clientWidth??320,f=Mn.current?.clientHeight??320,u={x:d/2,y:f/2},p={x:u.x-i/2,y:u.y-i/2,w:i,h:i},w=(p.x-Me.x)/Me.scale,v=(p.y-Me.y)/Me.scale,j=p.w/Me.scale,C=p.h/Me.scale;c.drawImage(s,w,v,j,C,0,0,i,i),c.restore(),t=await new Promise(b=>ns.current.toBlob(E=>b(E),"image/png"))}if(!t&&!ss)throw new Error("No file to upload");const n=new FormData;n.append("file",t??ss);const r=await new Promise((s,c)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const d=er.getState().session?.accessToken;d&&i.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}i.upload.onprogress=d=>{d.lengthComputable&&es(Math.round(100*d.loaded/d.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const d=JSON.parse(i.responseText);s(d.url)}catch(d){c(d)}else c(new Error(`upload failed: ${i.status} ${i.statusText}`))},i.onerror=()=>{c(new Error("Network error during upload"))},i.send(n)});await ie.patch(`/conversations/${S.id}`,{avatarUrl:r}),F.setQueryData(["conversations"],s=>Array.isArray(s)?s.map(c=>c.conversation?.id===S.id?{...c,conversation:{...c.conversation,avatarUrl:r}}:c):s),F.invalidateQueries({queryKey:["conversations"]}),await re.refetch(),is(null),Bt&&URL.revokeObjectURL(Bt),rs(null),sn({x:0,y:0,scale:1}),We(!1),ir("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ir(null),2200)}catch(t){console.error("Error uploading group avatar:",t),ir(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${t instanceof Error?t.message:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}`),setTimeout(()=>ir(null),3e3)}finally{Kr(!1)}}},children:sr?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),sr&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Ti}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),as&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[e.jsx(Ta,{size:16}),e.jsx("span",{children:as})]})]})})]})}function Fa(a){return(a??[]).map(l=>l.user.id).sort().join(",")}const Bl=Object.freeze(Object.defineProperty({__proto__:null,default:Ll},Symbol.toStringTag,{value:"Module"}));export{Bl as C,Lt as X};
