const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-DoRINUvM.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/index-VZSEfgNq.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/index-BGpmfXXY.js","assets/index-DqkCZ1FC.css"])))=>i.map(i=>d[i]);
import{d as qi,g as jt,e as Ds,n as xt,c as H,f as Vi,s as Q,u as vt,h as Qi,o as Ji,i as Zi,j as Ts,k as Ns,l as zs,m as ea,p as ta,q as na,t as ra,v as sa,w as ia,x as aa,y as oa,z as ca,A as la,B as da,D as ua,E as fa,F as ha,G as pa,H as ga,I as Us,J as Hs,K as Bs,L as Ps,M as ma,P as ya,Q as xa,R as va,S as ba,_ as wa,T as Os}from"./index-VZSEfgNq.js";import{r as c,j as t,b as bt,c as ja}from"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=a=>a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),ka=a=>a.replace(/^([A-Z])|[\s-_]+(\w)/g,(l,f,y)=>y?y.toUpperCase():f.toLowerCase()),Ws=a=>{const l=ka(a);return l.charAt(0).toUpperCase()+l.slice(1)},Qs=(...a)=>a.filter((l,f,y)=>!!l&&l.trim()!==""&&y.indexOf(l)===f).join(" ").trim(),Ca=a=>{for(const l in a)if(l.startsWith("aria-")||l==="role"||l==="title")return!0};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var Ia={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=c.forwardRef(({color:a="currentColor",size:l=24,strokeWidth:f=2,absoluteStrokeWidth:y,className:v="",children:w,iconNode:k,...L},U)=>c.createElement("svg",{ref:U,...Ia,width:l,height:l,stroke:a,strokeWidth:y?Number(f)*24/Number(l):f,className:Qs("lucide",v),...!w&&!Ca(L)&&{"aria-hidden":"true"},...L},[...k.map(([B,X])=>c.createElement(B,X)),...Array.isArray(w)?w:[w]]));/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=(a,l)=>{const f=c.forwardRef(({className:y,...v},w)=>c.createElement(Ea,{ref:w,iconNode:l,className:Qs(`lucide-${Sa(Ws(a))}`,`lucide-${a}`,y),...v}));return f.displayName=Ws(a),f};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Aa=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Ra=J("arrow-left",Aa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],La=J("bell-ring",Ma);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Fs=J("circle-check-big",Da);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ta=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],Na=J("circle-plus",Ta);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],wr=J("cloud-upload",za);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ua=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ha=J("copy",Ua);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ba=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],_s=J("lock-open",Ba);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pa=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],jr=J("lock",Pa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oa=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],Xs=J("log-out",Oa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wa=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Fa=J("maximize-2",Wa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],Xa=J("paperclip",_a);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ya=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],Ys=J("phone-off",Ya);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ga=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],Sr=J("phone",Ga);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Ka=J("reply",$a);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qa=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Va=J("trash-2",qa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qa=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],kr=J("user-plus",Qa);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ja=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Za=J("users",Ja);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eo=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],Cr=J("video",eo);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const to=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Me=J("x",to);function no(a){let l=0;for(let k=0;k<a.length;k++)l=a.charCodeAt(k)+((l<<5)-l);const f=Math.abs(l),y=24+f%18-9,v=60+f%15,w=30+f%12;return`hsl(${y} ${v}% ${w}%)`}function se({name:a,size:l=40,id:f=a,presence:y,avatarUrl:v}){const w=no(f),k=(a||"?").trim().charAt(0).toUpperCase(),L=!!v?.startsWith("emoji:"),U=L?v.slice(6):null,[B,X]=c.useState(!1),P=c.useMemo(()=>{if(!v||L)return v??null;if(v.startsWith("data:")||typeof window>"u")return v;try{if(v.startsWith("http://")||v.startsWith("https://"))return v;const de=window.location,me=new URL(v,de.origin);return me.host===de.host&&me.protocol!==de.protocol&&(me.protocol=de.protocol),me.toString()}catch{return v}},[v,L]),te=c.useMemo(()=>{if(!y)return null;switch(y){case"ONLINE":case"IN_CALL":return"#22c55e";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[y]);c.useEffect(()=>{X(!1)},[v]);const pe=P&&!L&&!B;return t.jsxs("div",{style:{width:l,height:l,borderRadius:"50%",background:w,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[pe?t.jsx("img",{src:P,alt:a,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:()=>X(!0)}):L?t.jsx("span",{style:{fontSize:Math.floor(l*.6)},children:U}):k,te&&t.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(l*.28)),height:Math.max(8,Math.floor(l*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:te}})]})}const Ir=qi(a=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:l=>a({incoming:l}),startOutgoing:(l,f)=>a({activeConvId:l,incoming:null,initialVideo:!!f,initialAudio:!0}),startIncoming:l=>a({incoming:l}),endCall:()=>a({activeConvId:null,incoming:null,initialVideo:!1})}));/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ro(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&a.constructor.name==="Uint8Array"}function Rr(a){if(!Number.isSafeInteger(a)||a<0)throw new Error("positive integer expected, got "+a)}function Nn(a,...l){if(!ro(a))throw new Error("Uint8Array expected");if(l.length>0&&!l.includes(a.length))throw new Error("Uint8Array expected of length "+l+", got length="+a.length)}function Mr(a){if(typeof a!="function"||typeof a.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Rr(a.outputLen),Rr(a.blockLen)}function Tn(a,l=!0){if(a.destroyed)throw new Error("Hash instance has been destroyed");if(l&&a.finished)throw new Error("Hash#digest() has already been called")}function so(a,l){Nn(a);const f=l.outputLen;if(a.length<f)throw new Error("digestInto() expects output buffer of length at least "+f)}function Ft(...a){for(let l=0;l<a.length;l++)a[l].fill(0)}function Er(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}function Le(a,l){return a<<32-l|a>>>l}function io(a){if(typeof a!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(a))}function _t(a){return typeof a=="string"&&(a=io(a)),Nn(a),a}class Js{}function ao(a){const l=y=>a().update(_t(y)).digest(),f=a();return l.outputLen=f.outputLen,l.blockLen=f.blockLen,l.create=()=>a(),l}class Zs extends Js{constructor(l,f){super(),this.finished=!1,this.destroyed=!1,Mr(l);const y=_t(f);if(this.iHash=l.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const v=this.blockLen,w=new Uint8Array(v);w.set(y.length>v?l.create().update(y).digest():y);for(let k=0;k<w.length;k++)w[k]^=54;this.iHash.update(w),this.oHash=l.create();for(let k=0;k<w.length;k++)w[k]^=106;this.oHash.update(w),Ft(w)}update(l){return Tn(this),this.iHash.update(l),this}digestInto(l){Tn(this),Nn(l,this.outputLen),this.finished=!0,this.iHash.digestInto(l),this.oHash.update(l),this.oHash.digestInto(l),this.destroy()}digest(){const l=new Uint8Array(this.oHash.outputLen);return this.digestInto(l),l}_cloneInto(l){l||(l=Object.create(Object.getPrototypeOf(this),{}));const{oHash:f,iHash:y,finished:v,destroyed:w,blockLen:k,outputLen:L}=this;return l=l,l.finished=v,l.destroyed=w,l.blockLen=k,l.outputLen=L,l.oHash=f._cloneInto(l.oHash),l.iHash=y._cloneInto(l.iHash),l}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Lr=(a,l,f)=>new Zs(a,l).update(f).digest();Lr.create=(a,l)=>new Zs(a,l);function oo(a,l,f){return Mr(a),f===void 0&&(f=new Uint8Array(a.outputLen)),Lr(a,_t(f),_t(l))}const Ar=Uint8Array.from([0]),Gs=Uint8Array.of();function co(a,l,f,y=32){Mr(a),Rr(y);const v=a.outputLen;if(y>255*v)throw new Error("Length should be <= 255*HashLen");const w=Math.ceil(y/v);f===void 0&&(f=Gs);const k=new Uint8Array(w*v),L=Lr.create(a,l),U=L._cloneInto(),B=new Uint8Array(L.outputLen);for(let X=0;X<w;X++)Ar[0]=X+1,U.update(X===0?Gs:B).update(f).update(Ar).digestInto(B),k.set(B,v*X),L._cloneInto(U);return L.destroy(),U.destroy(),Ft(B,Ar),k.slice(0,y)}const lo=(a,l,f,y,v)=>co(a,oo(a,l,f),y,v);function uo(a,l,f,y){if(typeof a.setBigUint64=="function")return a.setBigUint64(l,f,y);const v=BigInt(32),w=BigInt(4294967295),k=Number(f>>v&w),L=Number(f&w),U=y?4:0,B=y?0:4;a.setUint32(l+U,k,y),a.setUint32(l+B,L,y)}function fo(a,l,f){return a&l^~a&f}function ho(a,l,f){return a&l^a&f^l&f}class po extends Js{constructor(l,f,y,v){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=l,this.outputLen=f,this.padOffset=y,this.isLE=v,this.buffer=new Uint8Array(l),this.view=Er(this.buffer)}update(l){Tn(this),l=_t(l),Nn(l);const{view:f,buffer:y,blockLen:v}=this,w=l.length;for(let k=0;k<w;){const L=Math.min(v-this.pos,w-k);if(L===v){const U=Er(l);for(;v<=w-k;k+=v)this.process(U,k);continue}y.set(l.subarray(k,k+L),this.pos),this.pos+=L,k+=L,this.pos===v&&(this.process(f,0),this.pos=0)}return this.length+=l.length,this.roundClean(),this}digestInto(l){Tn(this),so(l,this),this.finished=!0;const{buffer:f,view:y,blockLen:v,isLE:w}=this;let{pos:k}=this;f[k++]=128,Ft(this.buffer.subarray(k)),this.padOffset>v-k&&(this.process(y,0),k=0);for(let P=k;P<v;P++)f[P]=0;uo(y,v-8,BigInt(this.length*8),w),this.process(y,0);const L=Er(l),U=this.outputLen;if(U%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const B=U/4,X=this.get();if(B>X.length)throw new Error("_sha2: outputLen bigger than state");for(let P=0;P<B;P++)L.setUint32(4*P,X[P],w)}digest(){const{buffer:l,outputLen:f}=this;this.digestInto(l);const y=l.slice(0,f);return this.destroy(),y}_cloneInto(l){l||(l=new this.constructor),l.set(...this.get());const{blockLen:f,buffer:y,length:v,finished:w,destroyed:k,pos:L}=this;return l.destroyed=k,l.finished=w,l.length=v,l.pos=L,v%f&&l.buffer.set(y),l}clone(){return this._cloneInto()}}const Ye=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),go=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ge=new Uint32Array(64);class mo extends po{constructor(l=32){super(64,l,8,!1),this.A=Ye[0]|0,this.B=Ye[1]|0,this.C=Ye[2]|0,this.D=Ye[3]|0,this.E=Ye[4]|0,this.F=Ye[5]|0,this.G=Ye[6]|0,this.H=Ye[7]|0}get(){const{A:l,B:f,C:y,D:v,E:w,F:k,G:L,H:U}=this;return[l,f,y,v,w,k,L,U]}set(l,f,y,v,w,k,L,U){this.A=l|0,this.B=f|0,this.C=y|0,this.D=v|0,this.E=w|0,this.F=k|0,this.G=L|0,this.H=U|0}process(l,f){for(let P=0;P<16;P++,f+=4)Ge[P]=l.getUint32(f,!1);for(let P=16;P<64;P++){const te=Ge[P-15],pe=Ge[P-2],de=Le(te,7)^Le(te,18)^te>>>3,me=Le(pe,17)^Le(pe,19)^pe>>>10;Ge[P]=me+Ge[P-7]+de+Ge[P-16]|0}let{A:y,B:v,C:w,D:k,E:L,F:U,G:B,H:X}=this;for(let P=0;P<64;P++){const te=Le(L,6)^Le(L,11)^Le(L,25),pe=X+te+fo(L,U,B)+go[P]+Ge[P]|0,me=(Le(y,2)^Le(y,13)^Le(y,22))+ho(y,v,w)|0;X=B,B=U,U=L,L=k+pe|0,k=w,w=v,v=y,y=pe+me|0}y=y+this.A|0,v=v+this.B|0,w=w+this.C|0,k=k+this.D|0,L=L+this.E|0,U=U+this.F|0,B=B+this.G|0,X=X+this.H|0,this.set(y,v,w,k,L,U,B,X)}roundClean(){Ft(Ge)}destroy(){this.set(0,0,0,0,0,0,0,0),Ft(this.buffer)}}const yo=ao(()=>new mo),xo=yo,vo=new TextEncoder,bo=new TextDecoder;function Ue(a){if(!a)return new Uint8Array;const l=a.replace(/-/g,"+").replace(/_/g,"/"),f=l.length%4===0?"":"=".repeat(4-l.length%4),y=atob(l+f),v=y.length,w=new Uint8Array(v);for(let k=0;k<v;k+=1)w[k]=y.charCodeAt(k);return w}function Wt(a){let l="";for(let f=0;f<a.length;f+=1)l+=String.fromCharCode(a[f]);return btoa(l).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function $s(a){return vo.encode(a)}function wo(a){return bo.decode(a)}const Ks="eb_e2ee_sessions_v1";class jo{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(l){return!!this.sessions[l]}getSession(l){return this.sessions[l]??null}async ensureSession(l){if(!l.isSecret||l.secretStatus!=="ACTIVE")return null;const f=this.sessions[l.id];if(f)return f;const y=jt(),v=Ds();if(!y||!v||!l.secretInitiatorDeviceId||!l.secretPeerDeviceId||!(l.secretInitiatorDeviceId===y.deviceId))return null;const k=l.secretPeerDeviceId;return k?this.createInitiatorSession(l,y.deviceId,k,v):null}processHandshakes(l,f){if(!l.isSecret||!f||f.length===0)return!1;const y=jt();if(!y)return!1;let v=!1;for(const w of f){const L=(w?.metadata??{}).e2ee;if(!L||L.kind!=="handshake")continue;const U=L.payload;if(!U||U.recipientDeviceId!==y.deviceId)continue;const B=this.sessions[l.id];if(B&&B.peerDeviceId===U.initiatorDeviceId&&B.prekeyId===U.prekeyId)continue;this.handlePeerHandshake(l,U)&&(v=!0)}return v&&this.bumpVersion(),v}transformMessage(l,f){if(!f)return f;const y=f.metadata??{},v=y.e2ee;if(!v||v.kind!=="ciphertext")return f;const w=this.sessions[l];if(!w)return{...f,content:"ðŸ” Ð—Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¾",metadata:{...y,e2ee:{...v,decrypted:!1}}};try{const k=Ue(w.key),L=Ue(v.nonce),U=Ue(f.content||""),B=xt.secretbox.open(U,L,k);if(!B)throw new Error("Failed to decrypt");return{...f,content:wo(B),metadata:{...y,e2ee:{...v,decrypted:!0}}}}catch(k){return console.warn("Failed to decrypt message",k),{...f,content:"ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸",metadata:{...y,e2ee:{...v,decrypted:!1,error:!0}}}}}async encryptPayload(l,f){const y=await this.ensureSession(l);if(!y)throw new Error("E2EE session is not ready");const v=Ue(y.key),w=xt.randomBytes(24),k=$s(f.content??""),L=xt.secretbox(k,w,v);return{conversationId:l.id,type:f.type,content:Wt(L),replyToId:f.replyToId,metadata:{...f.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:Wt(w)}}}}async createInitiatorSession(l,f,y,v){try{const w=await H.post("/devices/prekeys/claim",{deviceId:y}),k=w.data?.identityKey,L=w.data?.prekey;if(!k||!L?.publicKey||!L?.keyId)throw new Error("Invalid prekey response");const U=xt.scalarMult(Ue(v.secretKey),Ue(L.publicKey)),B=xt.randomBytes(32),X=`eblusha:e2ee:${l.id}:${f}->${y}:${L.keyId}`,P=this.deriveKey(U,B,X),te={conversationId:l.id,key:Wt(P),localDeviceId:f,peerDeviceId:y,role:"initiator",prekeyId:L.keyId,hkdfInfo:X,handshakeSalt:Wt(B),createdAt:Date.now()};return this.sessions[l.id]=te,this.persist(),await this.sendHandshakeMessage(l.id,{version:1,kind:"handshake",conversationId:l.id,initiatorDeviceId:f,recipientDeviceId:y,prekeyId:L.keyId,handshakeSalt:te.handshakeSalt,hkdfInfo:X,initiatorIdentityKey:v.publicKey,createdAt:Date.now()}),te}catch(w){return console.error("Failed to initialize E2EE session",w),delete this.sessions[l.id],this.persist(),null}}handlePeerHandshake(l,f){if(!f?.prekeyId||!f?.initiatorIdentityKey||!f.hkdfInfo||!f.handshakeSalt||!Ds())return!1;const v=jt();if(!v)return!1;const w=Vi(f.prekeyId);if(!w)return console.warn("Missing prekey secret for handshake",f.prekeyId),!1;try{const k=xt.scalarMult(Ue(w),Ue(f.initiatorIdentityKey)),L=this.deriveKey(k,Ue(f.handshakeSalt),f.hkdfInfo),U={conversationId:l.id,key:Wt(L),localDeviceId:v.deviceId,peerDeviceId:f.initiatorDeviceId,role:"peer",prekeyId:f.prekeyId,hkdfInfo:f.hkdfInfo,handshakeSalt:f.handshakeSalt,createdAt:Date.now()};return this.sessions[l.id]=U,this.persist(),!0}catch(k){return console.error("Failed to handle handshake payload",k),!1}}async sendHandshakeMessage(l,f){await H.post("/conversations/send",{conversationId:l,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:f}}})}deriveKey(l,f,y){return lo(xo,l,f,$s(y),32)}clearSession(l){this.sessions[l]&&(delete this.sessions[l],this.persist())}load(){try{const l=localStorage.getItem(Ks);l&&(this.sessions=JSON.parse(l))}catch{this.sessions={}}}persist(){try{localStorage.setItem(Ks,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const wt=new jo;async function So(a={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const l=a.audio!==!1,f=!!a.video;if(!l&&!f)return{ok:!0};const y={audio:l,video:f};let v=null;try{return v=await navigator.mediaDevices.getUserMedia(y),{ok:!0}}catch(w){return{ok:!1,error:w??new Error("Unknown media error")}}finally{v&&v.getTracks().forEach(w=>{try{w.stop()}catch{}})}}const ko=c.lazy(()=>wa(()=>import("./CallOverlay-DoRINUvM.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(a=>({default:a.CallOverlay}))),qs="eblusha:last-active-conversation",Co=3e4;function Bo(){const[a,l]=c.useState(null),[f,y]=c.useState(null),[v,w]=c.useState(null),[k,L]=c.useState(""),[U,B]=c.useState(null),X=c.useRef(null),P=c.useRef(null),te=c.useRef(null),pe=c.useRef(null),de=c.useRef(null),me=c.useRef(!1),V=c.useRef(null),ge=c.useRef(null),Xt=c.useRef(!1),[Dr,Tr]=c.useState(!1),[Io,ei]=c.useState(1),[St,Nr]=c.useState(!1),zn=c.useRef(null);c.useRef({pinTimer:null});const[Z,He]=c.useState(()=>({open:!1,x:0,y:0,messageId:null})),[ne,Yt]=c.useState(()=>({open:!1,x:0,y:0,conversationId:null})),zr=c.useRef(null),Ur=c.useRef(null),[ti,Gt]=c.useState(!1),[Eo,Ao]=c.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Hr,$t]=c.useState({open:!1,messageId:null}),[Un,Br]=c.useState(!1),[Kt,Hn]=c.useState([]),[Pr,kt]=c.useState(!1),[$e,Bn]=c.useState("friends"),[Or,Pn]=c.useState(["","","",""]),qt=[c.useRef(null),c.useRef(null),c.useRef(null),c.useRef(null)],[ie,Ct]=c.useState(null),[Wr,it]=c.useState(null),[ni,It]=c.useState(!1),Vt=c.useRef(0),[ri,si]=c.useState(!1),[ii,ai]=c.useState(!1),[R,oi]=c.useState(!1),Ke=c.useRef(R),[On,ke]=c.useState("list");c.useEffect(()=>{Ke.current=R},[R]);const[ci,Qt]=c.useState(!1),Wn=c.useRef(null);c.useRef(null);const Jt=c.useRef(new Map),qe=c.useRef(!0),Ve=c.useRef(!1),Zt=c.useRef(0),Fn=c.useRef(null),en=c.useRef(new Set),Et=c.useRef(null);c.useRef(null);const tn=c.useRef(null),_n=c.useRef(0),[li,Fr]=c.useState(!1),[At,_r]=c.useState(""),[nn,Xr]=c.useState([]),[Xn,Yn]=c.useState(!1),[Yr,rn]=c.useState(null),[at,Gr]=c.useState(null),[ue,Qe]=c.useState(null),[$r,Kr]=c.useState(null),[di,Be]=c.useState(!1),Gn=c.useRef(null),Je=c.useRef(null),ui=c.useRef(null),$n=c.useRef(null),[ee,Ce]=c.useState({x:0,y:0,scale:1}),[qr,Kn]=c.useState(!1),[fi,sn]=c.useState(!1),[qn,hi]=c.useState(["","","",""]),Vn=[c.useRef(null),c.useRef(null),c.useRef(null),c.useRef(null)],[Pe,Qn]=c.useState(null),[pi,Jn]=c.useState(!1),[Zn,gi]=c.useState(""),[mi,an]=c.useState(!1),[ot,on]=c.useState(!1),[er,cn]=c.useState(null),[ye,ln]=c.useState(null),dn=c.useRef(null),[Y,Oe]=c.useState({x:0,y:0,scale:1}),[Vr,un]=c.useState(0),Ze=c.useRef(null),tr=c.useRef(null),Qr=c.useRef(null),ae=c.useRef(null),et=c.useRef(null),We=c.useRef(null),fn=c.useRef(null),oe=c.useRef(null),tt=c.useRef(null),hn=c.useRef(null),Jr=c.useRef(null),[G,Ie]=c.useState({x:0,y:0,scale:1}),[xe,pn]=c.useState(null),[gn,mn]=c.useState(null),[Zr,nr]=c.useState(!1),[es,rr]=c.useState(!1),[yn,ct]=c.useState(null),[nt,Fe]=c.useState({open:!1,index:0,items:[]}),[yi,sr]=c.useState(1),[xi,ts]=c.useState(!1),[vi,ir]=c.useState(0),[Ro,ar]=c.useState(!1),[lt,Rt]=c.useState(null),[ns,Mt]=c.useState({}),[fe,rt]=c.useState(null),[xn,rs]=c.useState(0),ss=c.useRef(null);c.useEffect(()=>{ss.current=a},[a]);const is=c.useRef(null);c.useEffect(()=>{is.current=fe},[fe]);const as=bt({queryKey:["my-devices"],queryFn:async()=>(await H.get("/devices")).data.devices}),[Mo,os]=c.useState(null),[bi,vn]=c.useState(()=>Q.connected),[wi,cs]=c.useState(null),[ji,Si]=c.useState({}),[ki,Ci]=c.useState({}),[Ii,Lt]=c.useState(!1),[ls,Dt]=c.useState({}),[ds,us]=c.useState(!1),[or,bn]=c.useState(!1),fs=c.useRef(null),C=vt(e=>e.session?.user),Tt=c.useRef(null);if(Tt.current===null&&typeof window<"u")try{const e=localStorage.getItem("eb_user");if(e){const n=JSON.parse(e);n&&typeof n.id=="string"&&(Tt.current=n.id)}}catch{Tt.current=null}c.useEffect(()=>{C?.id&&(Tt.current=C.id)},[C?.id]);const ve=C?.id??Tt.current??null,O=Ir(),T=ja(),wn=c.useMemo(()=>a?ns[a]||[]:[],[a,ns]);c.useRef(null),c.useRef(null);const[dt,we]=c.useState({}),[Lo,Ei]=c.useState(0),Nt=c.useRef(null);c.useEffect(()=>{Nt.current=f},[f]);const Ai=c.useRef({}),cr=c.useRef({}),ut=c.useRef({});c.useEffect(()=>()=>{typeof window>"u"||Object.values(ut.current).forEach(e=>{typeof e=="number"&&window.clearTimeout(e)})},[]);const lr=c.useCallback(e=>{if(!e)return null;const n=T.getQueryData(["conversations"]);return Array.isArray(n)?n.find(s=>s?.conversation?.id===e)?.conversation??null:null},[T]),zt=c.useCallback(e=>{const n=lr(e);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[lr]),_e=c.useCallback(e=>{if(!e)return;const n=ut.current[e];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete ut.current[e]),delete cr.current[e]},[]),jn=c.useCallback(e=>{e&&zt(e)&&(cr.current[e]=Date.now()+Co)},[zt]),dr=c.useCallback((e,n,r)=>{if(!e){n();return}if(r?.force){_e(e),n();return}const s=cr.current[e];if(!s){n();return}const o=Date.now();if(o>=s){_e(e),n();return}const i=s-o,d=ut.current[e];if(typeof d=="number"&&typeof window<"u"&&window.clearTimeout(d),typeof window>"u"){n();return}ut.current[e]=window.setTimeout(()=>{delete ut.current[e],_e(e),n()},i)},[_e]),ur=c.useCallback((e,n)=>{const r=e?"ÐºÐ°Ð¼ÐµÑ€Ðµ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ":"Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ",s=typeof n=="object"&&n&&"name"in n?String(n.name):"";return s==="NotAllowedError"||s==="SecurityError"?`Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð°Ð´Ñ€ÐµÑÐ½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`:s==="NotFoundError"?e?"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":s==="NotReadableError"||s==="TrackStartError"?"ÐšÐ°Ð¼ÐµÑ€Ð° Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð»Ð¸ Ð²ÐºÐ»Ð°Ð´ÐºÐ¾Ð¹.":`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð° Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`},[]),Sn=c.useCallback(async e=>{try{const n=await So({audio:!0,video:e});return n.ok?(Rt(null),!0):(Rt(ur(e,n.error)),!1)}catch(n){return Rt(ur(e,n)),!1}},[ur]),hs=c.useCallback(async e=>{const n=O.incoming;if(!n||!await Sn(e))return;const r=n.conversationId;jn(r),Qi(r,e),O.startOutgoing(r,e),we(s=>{const o=s[r],i=C?.id;return o?.active?i&&o.participants&&!o.participants.includes(i)?{...s,[r]:{...o,participants:[...o.participants,i]}}:s:{...s,[r]:{startedAt:Date.now(),active:!0,participants:i?[i]:[]}}}),y(r),w(s=>s===r?null:s),O.setIncoming(null),De()},[jn,O,C?.id,Sn]);c.useEffect(()=>{const e=window.setInterval(()=>Ei(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(e)},[]),c.useEffect(()=>{if(!lt||typeof window>"u")return;const e=window.setTimeout(()=>Rt(null),9e3);return()=>window.clearTimeout(e)},[lt]),c.useEffect(()=>{const e=()=>{const n=window.innerWidth<=768;oi(n),Ke.current=n,n?a||ke("list"):ke("conversation")};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[a]),c.useEffect(()=>{R&&ke(a?"conversation":"list")},[R,a]),c.useEffect(()=>{const e=r=>{console.log("[CallStatus] Single:",r),we(s=>{const o=T.getQueryData(["conversations"]),i=Array.isArray(o)?o.find(m=>m.conversation.id===r.conversationId)?.conversation:null,d=s[r.conversationId],h=Ir.getState().activeConvId;if(!(!!(i&&(i.isGroup||(i.participants?.length??0)>2))||!!d&&(d.participants?d.participants.length>1:!0)||h===r.conversationId))return s;const p=r.participants||[];if(r.active){const m=typeof r.startedAt=="number"&&r.startedAt>0?r.startedAt:d?.startedAt??Date.now();return{...s,[r.conversationId]:{active:!0,startedAt:m,participants:p,endedAt:null,elapsedMs:typeof r.elapsedMs=="number"?r.elapsedMs:void 0}}}const x=d?.active?Date.now():d?.endedAt??null;return{...s,[r.conversationId]:{active:!1,startedAt:d?.startedAt??null,endedAt:x,participants:[],elapsedMs:void 0}}})},n=r=>{console.log("[CallStatus] Bulk:",r),we(s=>{const o={...s},i=T.getQueryData(["conversations"]);for(const[d,h]of Object.entries(r.statuses||{})){const u=Array.isArray(i)?i.find(b=>b.conversation.id===d)?.conversation:null,p=s[d],x=Ir.getState().activeConvId;if(!(!!(u&&(u.isGroup||(u.participants?.length??0)>2))||!!p&&(p.participants?p.participants.length>1:!0)||x===d))continue;const g=h.participants||[];if(h.active){const b=typeof h.startedAt=="number"&&h.startedAt>0?h.startedAt:p?.startedAt??Date.now();o[d]={active:!0,startedAt:b,participants:g,endedAt:null,elapsedMs:typeof h.elapsedMs=="number"?h.elapsedMs:void 0};continue}const I=p?.active?Date.now():p?.endedAt??null;o[d]={active:!1,startedAt:p?.startedAt??null,endedAt:I,participants:[],elapsedMs:void 0}}return o})};return Ji(e),Zi(n),()=>{Q.off("call:status",e),Q.off("call:status:bulk",n)}},[]),c.useEffect(()=>{if(!Z.open)return;const e=fs.current;if(!e)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=e.getBoundingClientRect();let o=Z.x,i=Z.y;o+s.width>n-8&&(o=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(o!==Z.x||i!==Z.y)&&He(d=>({...d,x:o,y:i}))},[Z.open,Z.x,Z.y]),c.useEffect(()=>{if(!ne.open)return;const e=zr.current;if(!e)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=e.getBoundingClientRect();let o=ne.x,i=ne.y;o+s.width>n-8&&(o=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(o!==ne.x||i!==ne.y)&&Yt(d=>({...d,x:o,y:i}))},[ne.open,ne.x,ne.y]);function ft(e){l(n=>{try{n&&n!==e&&(W.data||[]).find(o=>o.conversation.id===n)?.conversation?.isSecret&&T.removeQueries({queryKey:["messages",n]})}catch{}return e}),R&&ke("conversation"),fe&&(URL.revokeObjectURL(fe.preview),rt(null))}async function ps(){let e=jt();return e||(e=await xa()),e||null}async function gs(e){if(ds)return;us(!0);const n=2;let r=0;const s=async()=>{if(r>=n)throw new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");r+=1,await ya()};try{for(;;){const o=await ps();if(!o){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}try{const i={participantIds:[e],isGroup:!1,isSecret:!0,initiatorDeviceId:o.deviceId};console.log("[SecretChat] Creating with payload:",i),await H.post("/conversations",i),T.invalidateQueries({queryKey:["conversations"]});return}catch(i){console.error("[SecretChat] Creation error:",i?.response?.data||i);const d=i?.response?.data?.message,h=i?.response?.data?.errors;if(h&&console.error("[SecretChat] Validation errors:",h),i?.response?.status===400&&typeof d=="string"&&d.toLowerCase().includes("invalid initiator device")){await s();continue}const p=h?`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸: ${h.map(x=>`${x.path.join(".")}: ${x.message}`).join(", ")}`:d||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";throw new Error(p)}}}catch(o){console.error("Failed to start secret conversation:",o);const i=o?.message||o?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";alert(i)}finally{us(!1)}}const ms=async e=>{bn(!0);try{va(e),Dt(n=>{const r={...n};return delete r[e],r}),T.invalidateQueries({queryKey:["conversations"]})}finally{bn(!1)}},Ri=async e=>{bn(!0);try{const n=await ps();if(!n){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}ba(e,n.deviceId),T.invalidateQueries({queryKey:["conversations"]}),ft(e)}catch(n){console.error("Failed to accept secret chat:",n),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚")}finally{bn(!1)}};async function ys(e,n){if(e){if(e.isSecret){const r=await wt.encryptPayload(e,n);await H.post("/conversations/send",r);return}await H.post("/conversations/send",{conversationId:e.id,...n})}}const ht=()=>{Br(!1),Hn([]),kt(!1),Bn("friends"),Pn(["","","",""]),Ct(null),it(null),It(!1)},Mi=async()=>{if(!a||Kt.length===0){ht();return}kt(!0);try{await H.post(`/conversations/${a}/participants`,{participantIds:Kt}),T.invalidateQueries({queryKey:["conversations"]}),W.refetch(),ht()}catch(e){console.error("Error adding participants:",e),alert(e.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")}finally{kt(!1)}},Li=async()=>{if(!(!a||!ie)){kt(!0);try{await H.post(`/conversations/${a}/participants`,{participantIds:[ie.id]}),T.invalidateQueries({queryKey:["conversations"]}),W.refetch(),ht()}catch(e){console.error("Error adding participant by EBLID:",e),alert(e.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°")}finally{kt(!1)}}},Di=(e,n)=>{if(!/^\d?$/.test(n))return;const r=[...Or];r[e]=n,Pn(r),n&&e<3&&qt[e+1].current?.focus(),!n&&e>0&&qt[e-1].current?.focus();const s=r.join("");if(s.length===4&&/^\d{4}$/.test(s)){const o=Date.now();Vt.current=o,It(!0),it(null),H.get("/contacts/search",{params:{query:s}}).then(i=>{if(Vt.current!==o)return;const d=i.data.results?.[0]??null;Ct(d),it(d?null:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")}).catch(()=>{Vt.current===o&&(Ct(null),it("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº"))}).finally(()=>{Vt.current===o&&It(!1)})}else Ct(null),it(null),It(!1)};function Ti(){if(R){if(a)try{(W.data||[]).find(r=>r.conversation.id===a)?.conversation?.isSecret&&T.removeQueries({queryKey:["messages",a]})}catch{}ke("list"),l(null),Qt(!1)}fe&&(URL.revokeObjectURL(fe.preview),rt(null))}const je=bt({queryKey:["me-info"],queryFn:async()=>(await H.get("/status/me")).data.user}),W=bt({queryKey:["conversations"],queryFn:async()=>(await H.get("/conversations")).data.conversations}),K=bt({queryKey:["messages",a],enabled:!!a,queryFn:async()=>(await H.get(`/conversations/${a}/messages`)).data.messages,refetchInterval:a?15e3:!1});c.useEffect(()=>{K.error?.response?.status===403&&a&&(console.warn("[ChatsPage] Lost access to conversation, closing view",a),T.removeQueries({queryKey:["messages",a]}),l(null))},[K.error,a,T]);const he=bt({queryKey:["accepted-contacts"],queryFn:async()=>(await H.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),be=bt({queryKey:["incoming-contacts"],queryFn:async()=>(await H.get("/contacts",{params:{filter:"incoming"}})).data.contacts});c.useEffect(()=>{if(a&&!(typeof window>"u"))try{window.localStorage.setItem(qs,a)}catch{}},[a]),c.useEffect(()=>{if(typeof window>"u"||a)return;const e=W.data;if(!(!e||e.length===0)&&!(Ke.current&&On!=="conversation"))try{const n=window.localStorage.getItem(qs);if(!n)return;e.some(s=>s?.conversation?.id===n)&&ft(n)}catch{}},[a,W.data,On]);const fr=()=>{if(Fr(!1),_r(""),Xr([]),Yn(!1),at)try{URL.revokeObjectURL(at)}catch{}if(Gr(null),ue)try{URL.revokeObjectURL(ue)}catch{}Qe(null),rn(null),Kr(null),Ce({x:0,y:0,scale:1}),Be(!1)};c.useEffect(()=>{const e=Ur.current;if(!e)return;const n=()=>{const{scrollTop:r,scrollHeight:s,clientHeight:o}=e,i=r>2,d=s-r-o>2;si(i),ai(d)};return n(),e.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{e.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[W.data?.length]),c.useEffect(()=>{try{const e=(W.data||[]).map(n=>n.conversation.id);console.log("[CallStatus] Requesting statuses for:",e),e.length>0&&Ts(e);for(const n of e)try{Ns(n)}catch{}}catch{}},[W.data]);const j=c.useMemo(()=>W.data?.find(e=>e.conversation.id===a)?.conversation,[W.data,a]),Ut=c.useMemo(()=>jt()?.deviceId??null,[xn]),kn=c.useMemo(()=>{const e={};for(const n of as.data||[])e[n.id]=n;return e},[as.data]),Cn=c.useCallback(e=>{if(!e?.isSecret)return null;const n=[e.secretInitiatorDeviceId,e.secretPeerDeviceId];for(const r of n){if(!r)continue;const s=kn[r];if(s?.userId&&C?.id&&s.userId===C.id)return r}if(C?.id){if(e.createdById===C.id&&e.secretInitiatorDeviceId)return e.secretInitiatorDeviceId;if(e.createdById!==C.id&&e.secretPeerDeviceId)return e.secretPeerDeviceId}return null},[kn,C?.id]),pt=c.useMemo(()=>Cn(j),[j,Cn]),xs=c.useMemo(()=>{if(!pt)return;const e=kn[pt]?.name;if(e&&e.trim())return e;const n=jt();if(n&&n.deviceId===pt&&n.name)return n.name},[pt,kn,xn]),vs=c.useCallback(e=>{if(!e)return!1;const n=(W.data||[]).find(s=>s?.conversation?.id===e)?.conversation;if(!n?.isSecret)return!1;const r=Cn(n);return!!(r&&Ut&&r!==Ut)},[W.data,Ut,Cn]),bs=!!(j?.isSecret&&(j.secretStatus??"ACTIVE")!=="ACTIVE"),ws=c.useMemo(()=>j?.isSecret?wt.hasSession(j.id):!0,[j?.id,j?.isSecret,xn]),js=!!(j?.isSecret&&!bs&&!ws&&pt&&Ut&&pt!==Ut),Ni=js?"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð²ÐµÐ·Ð´Ðµ":"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";c.useEffect(()=>{if(!j?.isSecret||j.secretStatus!=="ACTIVE")return;let e=!1;return wt.ensureSession(j).then(n=>{!e&&n&&rs(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{e=!0}},[j?.id,j?.secretStatus,j?.isSecret]),c.useEffect(()=>{if(!j?.isSecret||!K.data||K.data.length===0)return;wt.processHandshakes(j,K.data)&&rs(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[K.data,j?.id,j?.isSecret,j?.secretStatus]);const Ee=c.useMemo(()=>K.data?j?.isSecret?K.data.filter(e=>{const r=(e?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(e=>wt.transformMessage(j.id,e)):K.data:[],[K.data,j?.id,j?.isSecret,xn]);c.useEffect(()=>{const e=new Set((W.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));Dt(n=>{let r=!1;const s={...n};for(const o of Object.keys(s))e.has(o)||(delete s[o],r=!0);return r?s:n})},[W.data]);const gt=c.useMemo(()=>{if(!j||j.isGroup||j.isSecret||!C?.id)return null;const e=Vs(j.participants||[]);if(!e)return null;const n=W.data||[];for(const r of n){const s=r.conversation;if(!s?.isSecret||(s.secretStatus??"ACTIVE")!=="PENDING"||Vs(s.participants||[])!==e)continue;const i=(s.participants||[]).find(h=>h.user.id===s.createdById)?.user,d=ls[s.id]?.from?.name??i?.displayName??i?.username??"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº";return{conversationId:s.id,isInitiator:s.createdById===C.id,initiatorName:d}}return null},[j,W.data,C?.id,ls]),Ss=c.useMemo(()=>{const e={};if(j)for(const n of j.participants)e[n.user.id]=n.user;return C&&!e[C.id]&&(e[C.id]=C),e},[j,C]),hr=c.useMemo(()=>j?(j.participants||[]).map(e=>e.user.id):[],[j]),ks=c.useMemo(()=>{if(!j||!he.data)return[];const e=new Set(hr);return he.data.filter(n=>!e.has(n.friend.id))},[j,he.data,hr]),In={alreadyInChat:ie?hr.includes(ie.id):!1,isSelf:ie?ie.id===C?.id:!1};c.useEffect(()=>{Un&&$e==="eblid"&&qt[0].current?.focus()},[Un,$e]),c.useEffect(()=>{const e=n=>{T.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(i=>i.user.id===n.userId?{...i,user:{...i.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="OFFLINE"?new Date().toISOString():i.user.lastSeenAt}}:i)}})))};return zs(e),()=>{Q.off("presence:update",e)}},[T]),c.useEffect(()=>{const e=()=>{try{const o=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",o+"px")}catch{}T.invalidateQueries({queryKey:["me-info"]}),vn(Q.connected)};window.addEventListener("focus",e);const n=()=>{vn(!0);try{const o=(W.data||[]).map(i=>i.conversation.id);for(const i of o)try{Ns(i)}catch{}o.length>0&&Ts(o)}catch{}},r=()=>vn(!1);Q.on("connect",n),Q.on("disconnect",r),vn(Q.connected);const s=()=>{T.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",s),()=>{Q.off("connect",n),Q.off("disconnect",r),document.removeEventListener("visibilitychange",s),window.removeEventListener("focus",e)}},[T]),c.useEffect(()=>{const e=n=>{if(C?.id&&n.userId===C.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="OFFLINE")&&cs(r)}};return zs(e),()=>{Q.off("presence:update",e)}},[C?.id]),c.useEffect(()=>{const e=(je.data?.status||"").toString().toUpperCase();(e==="ONLINE"||e==="AWAY"||e==="BACKGROUND"||e==="OFFLINE")&&cs(e)},[je.data]),c.useEffect(()=>{if(!nt.open)return;const e=n=>{n.key==="Escape"&&Fe(r=>({...r,open:!1})),n.key==="ArrowLeft"&&Fe(r=>({...r,index:(r.index-1+r.items.length)%r.items.length})),n.key==="ArrowRight"&&Fe(r=>({...r,index:(r.index+1)%r.items.length}))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[nt.open]),c.useEffect(()=>{const e=n=>{T.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(o=>o.user.id===n.userId?{...o,user:{...o.user,avatarUrl:n.avatarUrl??o.user.avatarUrl,displayName:n.displayName??o.user.displayName}}:o)}}))),n.userId===C?.id&&je.refetch()};return ea(e),()=>{Q.off("profile:update",e)}},[T,C?.id]);function zi(e){return"#191d23"}c.useEffect(()=>{if(!a)return;const e=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const s=n.clipboardData?.items;if(!s)return;let o=!1;for(let i=0;i<s.length;i++)if(s[i].type.indexOf("image")!==-1){o=!0;break}if(o)for(let i=0;i<s.length;i++){const d=s[i];if(d.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const h=d.getAsFile();if(h){const u=URL.createObjectURL(h);rt({file:h,preview:u})}break}}};return window.addEventListener("paste",e,!0),()=>{window.removeEventListener("paste",e,!0)}},[a]),c.useEffect(()=>{W.refetch(),ta(),na(()=>W.refetch()),ra(r=>{const s=r?.conversationId;if(!s){W.refetch();return}if(Dt(i=>{if(!i[s])return i;const d={...i};return delete d[s],d}),Mt(i=>{if(!i[s])return i;const d={...i};return delete d[s],d}),wt.clearSession(s),T.removeQueries({queryKey:["messages",s]}),T.setQueryData(["conversations"],i=>Array.isArray(i)?i.filter(d=>d?.conversation?.id!==s):i),ss.current===s){l(d=>d===s?null:d),Qt(!1);const i=is.current;i&&(URL.revokeObjectURL(i.preview),rt(null)),Ke.current&&ke("list")}W.refetch()}),sa(()=>{W.refetch()}),ia(()=>{W.refetch()});const e=aa(r=>{Dt(s=>({...s,[r.conversationId]:r})),W.refetch()}),n=oa(r=>{Dt(s=>{const o={...s};return delete o[r.conversationId],o}),T.invalidateQueries({queryKey:["conversations"]}),ft(r.conversationId)});ca(({conversationId:r,from:s,video:o})=>{if(!(pe.current&&pe.current===r)){De();try{const i=T.getQueryData(["conversations"]),d=Array.isArray(i)?i.find(p=>p.conversation.id===r)?.conversation:null,h=!!(d&&(d.isGroup||(d.participants?.length??0)>2));Ai.current[r]=s.id;const u=Nt.current===r;if(h||u||s?.id&&C?.id&&s.id===C.id)return}catch{}pe.current=r,O.startIncoming({conversationId:r,from:s,video:o});try{const i=Cs();i&&(i.currentTime=0,i.loop=!0,i.volume=.9,i.play().catch(()=>{}))}catch(i){console.error("Error starting ringtone:",i)}te.current=window.setTimeout(()=>{Hs(r),De(),O.setIncoming(null)},25e3)}}),la(({conversationId:r})=>{_e(r),we(s=>s[r]?.active?s:{...s,[r]:{startedAt:Date.now(),active:!0,participants:[C?.id||""].filter(Boolean)}}),y(r),w(s=>s===r?null:s),De()}),da(({conversationId:r})=>{const s=()=>{we(o=>{const i=o[r];if(i){if(i.active)return{...o,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:d,...h}=o;return h}return o}),Nt.current===r&&(y(o=>o===r?null:o),w(o=>o===r?null:o),O.endCall()),O.setIncoming(null),De(),_e(r)};zt(r)?dr(r,s,{force:!0}):s()}),ua(({conversationId:r})=>{try{const o=T.getQueryData(["conversations"]),i=Array.isArray(o)?o.find(h=>h.conversation.id===r)?.conversation:null;if(!!(i&&(i.isGroup||(i.participants?.length??0)>2)))return}catch{}const s=()=>{we(o=>{const i=o[r];if(i?.active)return{...o,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:d,...h}=o;return h}),Nt.current===r&&(y(o=>o===r?null:o),w(o=>o===r?null:o),O.endCall()),O.setIncoming(null),De(),_e(r)};zt(r)?dr(r,s,{force:!0}):s()}),fa(({conversationId:r})=>{T.invalidateQueries({queryKey:["messages",r]}),T.refetchQueries({queryKey:["messages",r]})});try{ge.current||(ge.current=new Audio("/notify.mp3"),ge.current.preload="auto",ge.current.volume=.9);const r=async()=>{try{if(ge.current&&!Xt.current&&(ge.current.volume=0,await ge.current.play(),ge.current.pause(),ge.current.currentTime=0,ge.current.volume=.9,Xt.current=!0),!me.current){const s=Cs();if(s){const o=s.volume;s.volume=0,await s.play().catch(()=>{}),s.pause(),s.currentTime=0,s.volume=o,me.current=!0}}}catch{}Xt.current&&me.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{e?.(),n?.()}},[]),c.useEffect(()=>{ha(()=>{be.refetch()}),pa(()=>{he.refetch(),W.refetch(),be.refetch()}),ga(()=>{he.refetch(),be.refetch()})},[]),c.useEffect(()=>{if(!ye)return;const e=Ze.current;if(!e)return;const n=(u,p)=>{const x=p.clientX-u.clientX,m=p.clientY-u.clientY;return Math.sqrt(x*x+m*m)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),s=240,o=(u,p,x,m,g)=>{const I=u-x,b=p-m;return I*I+b*b<=g*g},i=u=>{const p=e.getBoundingClientRect();if(!p)return;const x=p.width,m=p.height,g=x/2,I=m/2,b=s/2;if(u.touches.length===1){const E=u.touches[0],D=E.clientX-p.left,S=E.clientY-p.top;if(!o(D,S,g,I,b))return;ae.current={touches:[E],initialDistance:0,initialScale:Y.scale,initialX:Y.x,initialY:Y.y},u.preventDefault()}else if(u.touches.length===2){const E=u.touches[0],D=u.touches[1],S=r(E,D),M=S.x-p.left,N=S.y-p.top;if(!o(M,N,g,I,b))return;const z=n(E,D);ae.current={touches:[E,D],initialDistance:z,initialScale:Y.scale,initialX:Y.x,initialY:Y.y},u.preventDefault()}},d=u=>{ae.current&&(u.preventDefault(),et.current!==null&&cancelAnimationFrame(et.current),et.current=requestAnimationFrame(()=>{if(!ae.current)return;const p=e.getBoundingClientRect();if(!p)return;const x=p.width,m=p.height,g=x/2,I=m/2,b=u.touches.length,E=ae.current.touches.length;if(b===1&&E===1){const D=u.touches[0],S=ae.current.touches[0],M=D.clientX-S.clientX,N=D.clientY-S.clientY;Oe(z=>{let _=ae.current.initialX+M,$=ae.current.initialY+N;const q=tr.current;if(q){const re=z.scale,ce=q.naturalWidth*re,Te=q.naturalHeight*re,Ae=g+s/2,Se=g-s/2-ce,Ne=I+s/2,ze=I-s/2-Te;_=Math.max(Se,Math.min(Ae,_)),$=Math.max(ze,Math.min(Ne,$))}return{...z,x:_,y:$}})}else if(b===2&&E===2){const D=u.touches[0],S=u.touches[1],N=n(D,S)/ae.current.initialDistance,z=Math.max(.1,Math.min(10,ae.current.initialScale*N)),_=tr.current;if(_){const $=_.naturalWidth,q=_.naturalHeight,re=ae.current.initialX+$*ae.current.initialScale/2,ce=ae.current.initialY+q*ae.current.initialScale/2,Te=re-g,Ae=ce-I,Se=z/ae.current.initialScale,Ne=g+Te*Se,ze=I+Ae*Se,Ht=Ne-$*z/2,Bt=ze-q*z/2;Oe({x:Ht,y:Bt,scale:z})}}et.current=null}))},h=()=>{et.current!==null&&(cancelAnimationFrame(et.current),et.current=null),ae.current=null};return e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchmove",d,{passive:!1}),e.addEventListener("touchend",h,{passive:!0}),e.addEventListener("touchcancel",h,{passive:!0}),()=>{e.removeEventListener("touchstart",i),e.removeEventListener("touchmove",d),e.removeEventListener("touchend",h),e.removeEventListener("touchcancel",h)}},[ye,Y.scale,Y.x,Y.y]),c.useEffect(()=>{if(!xe)return;const e=We.current;if(!e)return;const n=(u,p)=>{const x=p.clientX-u.clientX,m=p.clientY-u.clientY;return Math.sqrt(x*x+m*m)},r=(u,p)=>({x:(u.clientX+p.clientX)/2,y:(u.clientY+p.clientY)/2}),s=240,o=(u,p,x,m,g)=>{const I=u-x,b=p-m;return I*I+b*b<=g*g},i=u=>{const p=e.getBoundingClientRect();if(!p)return;const x=p.width,m=p.height,g=x/2,I=m/2,b=s/2;if(u.touches.length===1){const E=u.touches[0],D=E.clientX-p.left,S=E.clientY-p.top;if(!o(D,S,g,I,b))return;oe.current={touches:[E],initialDistance:0,initialScale:G.scale,initialX:G.x,initialY:G.y},u.preventDefault()}else if(u.touches.length===2){const E=u.touches[0],D=u.touches[1],S=r(E,D),M=S.x-p.left,N=S.y-p.top;if(!o(M,N,g,I,b))return;const z=n(E,D);oe.current={touches:[E,D],initialDistance:z,initialScale:G.scale,initialX:G.x,initialY:G.y},u.preventDefault()}},d=u=>{oe.current&&(u.preventDefault(),tt.current!==null&&cancelAnimationFrame(tt.current),tt.current=requestAnimationFrame(()=>{if(!oe.current)return;const p=e.getBoundingClientRect();if(!p)return;const x=p.width,m=p.height,g=x/2,I=m/2,b=u.touches.length,E=oe.current.touches.length;if(b===1&&E===1){const D=u.touches[0],S=oe.current.touches[0],M=D.clientX-S.clientX,N=D.clientY-S.clientY;Ie(z=>{let _=oe.current.initialX+M,$=oe.current.initialY+N;const q=fn.current;if(q){const re=z.scale,ce=q.naturalWidth*re,Te=q.naturalHeight*re,Ae=g+s/2,Se=g-s/2-ce,Ne=I+s/2,ze=I-s/2-Te;_=Math.max(Se,Math.min(Ae,_)),$=Math.max(ze,Math.min(Ne,$))}return{...z,x:_,y:$}})}else if(b===2&&E===2){const D=u.touches[0],S=u.touches[1],N=n(D,S)/oe.current.initialDistance,z=Math.max(.1,Math.min(10,oe.current.initialScale*N)),_=fn.current;if(_){const $=_.naturalWidth,q=_.naturalHeight,re=oe.current.initialX+$*oe.current.initialScale/2,ce=oe.current.initialY+q*oe.current.initialScale/2,Te=re-g,Ae=ce-I,Se=z/oe.current.initialScale,Ne=g+Te*Se,ze=I+Ae*Se,Ht=Ne-$*z/2,Bt=ze-q*z/2;Ie({x:Ht,y:Bt,scale:z})}}tt.current=null}))},h=()=>{tt.current!==null&&(cancelAnimationFrame(tt.current),tt.current=null),oe.current=null};return e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("touchmove",d,{passive:!1}),e.addEventListener("touchend",h,{passive:!0}),e.addEventListener("touchcancel",h,{passive:!0}),()=>{e.removeEventListener("touchstart",i),e.removeEventListener("touchmove",d),e.removeEventListener("touchend",h),e.removeEventListener("touchcancel",h)}},[xe,G.scale,G.x,G.y]);const Cs=c.useCallback(()=>{if(typeof window>"u")return null;if(!de.current){const e=new Audio("/ring.mp3");e.preload="auto",e.loop=!0,e.volume=.9,de.current=e}return de.current},[]);function De(){try{if(te.current&&clearTimeout(te.current),te.current=null,de.current)try{de.current.pause(),de.current.currentTime=0}catch{}pe.current=null}catch{}}c.useEffect(()=>{const e=async s=>{if(!(s.conversationId===a)){T.invalidateQueries({queryKey:["conversations"]});return}if(!a)return;const d=s.message??s;d&&d.id&&(Mt(h=>{const u=h[a]||[];if(u.length===0)return h;const p=(d.attachments||[]).map(m=>m.url).sort(),x=u.filter(m=>{if(m.senderId!==d.senderId)return!0;const g=m.attachments.map(I=>I.url).sort();return g.length===p.length?!g.every((b,E)=>{const D=p[E];return b===D||b.startsWith("blob:")&&D&&!D.startsWith("blob:")}):!0});if(x.length===u.length)return h;if(x.length===0){const{[a]:m,...g}=h;return g}return{...h,[a]:x}}),As(a,d)),K.refetch()},n=s=>{s.conversationId===a&&(Tr(!0),zn.current&&window.clearTimeout(zn.current),zn.current=window.setTimeout(()=>Tr(!1),2e3))},r=s=>{if(!a||s.conversationId!==a){T.invalidateQueries({queryKey:["conversations"]});return}s.message?Wi(a,s.message):K.refetch()};return Q.on("message:new",e),Q.on("conversation:typing",n),Q.on("message:reaction",r),()=>{Q.off("message:new",e),Q.off("conversation:typing",n),Q.off("message:reaction",r)}},[a]),c.useEffect(()=>{const e=async n=>{if(vs(n.conversationId))return;const r=n.senderId===C?.id,s=n.conversationId===a,o=document.visibilityState==="visible";if(!r&&(!s||!o)&&ge.current&&Xt.current&&(ge.current.currentTime=0,ge.current.play().catch(()=>{})),s){n.message&&n.message.id&&As(a,n.message),K.refetch().catch(()=>{});return}};return Q.on("message:notify",e),()=>{Q.off("message:notify",e)}},[a,C?.id,K,vs]),c.useLayoutEffect(()=>{if(!a){Fn.current=null,Zt.current=0;return}Fn.current!==a&&(Fn.current=a,Zt.current=0);const e=(Ee?.length??0)+wn.length,n=Zt.current;if(Zt.current=e,!V.current||e===0||e<=n)return;const r=[...Ee||[],...wn],s=r[r.length-1],o=s?.senderId&&C?.id?s.senderId===C.id:!1;(o||!Ve.current||qe.current)&&requestAnimationFrame(()=>{const d=V.current;d&&(d.scrollTop=d.scrollHeight,qe.current=!0,o&&(Ve.current=!1))})},[a,wn,Ee,C?.id]),c.useEffect(()=>{if(!a)return;const e=V.current;if(!e)return;const n=()=>{e&&(e.scrollTop=e.scrollHeight,qe.current=!0,Ve.current=!1)};if(Ke.current){n();const r=window.setTimeout(n,50),s=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(s)}}n()},[a]),c.useEffect(()=>{if(!Ke.current)return;const e=V.current;if(!e)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===X.current&&(e.scrollTop=e.scrollHeight,qe.current=!0,Ve.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[a]),c.useEffect(()=>{},[]),c.useEffect(()=>{if(!Dr||!Ke.current)return;const e=V.current,n=window.setInterval(()=>{ei(r=>r%3+1),e&&e.scrollHeight-e.scrollTop-e.clientHeight<80&&(e.scrollTop=e.scrollHeight)},500);return()=>window.clearInterval(n)},[Dr]),c.useEffect(()=>{const e=V.current;if(!e)return;let n=0,r=e.scrollTop;const s=()=>{n&&cancelAnimationFrame(n);const o=e.scrollTop;Math.abs(o-r)>1&&(Ve.current=!0),n=requestAnimationFrame(()=>{const d=e.scrollHeight-e.scrollTop-e.clientHeight<8;qe.current=d,Qt(!d),d&&window.setTimeout(()=>{e.scrollHeight-e.scrollTop-e.clientHeight<40&&(Ve.current=!1)},100),r=e.scrollTop})};return e.addEventListener("scroll",s,{passive:!0}),s(),()=>{e.removeEventListener("scroll",s),n&&cancelAnimationFrame(n)}},[a]),c.useEffect(()=>{const e=()=>{if(!V.current)return;const n=V.current.clientWidth;Nr(n>=900)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[a]);function Ui(e,n){if(!/^\d?$/.test(n))return;const r=[...qn];r[e]=n,hi(r),n&&e<3&&Vn[e+1].current?.focus(),!n&&e>0&&Vn[e-1].current?.focus();const s=r.join("");s.length===4&&/^\d{4}$/.test(s)?(async()=>{try{const o=await H.get("/contacts/search",{params:{query:s}});Qn(o.data.results?.[0]??null)}catch{Qn(null)}})():Qn(null)}async function Hi(){sn(!0);try{const e=await H.get("/status/me");gi(e.data.user?.eblid??"")}catch{}}async function Bi(){const e=qn.join("");if(/^\d{4}$/.test(e)){Jn(!0);try{await H.post("/contacts/add",{identifier:e}),Jn(!1)}catch{Jn(!1)}}}function En(){if(!a||!K.data||!C?.id)return;const e=K.data.filter(n=>n.senderId!==C.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===C.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);e.length!==0&&H.post("/messages/receipts",{messageIds:e,status:"READ"}).then(()=>{T.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})}c.useEffect(()=>{document.hasFocus()&&En(),a&&(H.post("/messages/mark-conversation-read",{conversationId:a}).catch(()=>{}),T.setQueryData(["conversations"],e=>e&&e.map(n=>n.conversation.id===a?{...n,unreadCount:0}:n)))},[a]),c.useEffect(()=>{document.hasFocus()&&En()},[K.data]),c.useEffect(()=>{const e=()=>En(),n=()=>{document.visibilityState==="visible"&&En()};return window.addEventListener("focus",e),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",e),document.removeEventListener("visibilitychange",n)}},[a,K.data]);function Pi(){Et.current||(Et.current=window.setTimeout(()=>{const e=Array.from(en.current);en.current.clear(),Et.current&&clearTimeout(Et.current),Et.current=null,e.length&&H.post("/messages/receipts",{messageIds:e,status:"READ"}).then(()=>{a&&T.invalidateQueries({queryKey:["messages",a]})}).catch(()=>{})},250))}c.useEffect(()=>{if(!a||!K.data||!C?.id)return;Wn.current?.disconnect();const e=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const s=r.target,o=s.dataset.mid;if(!o)continue;const i=K.data.find(h=>h.id===o);!i||i.senderId===C.id||(i.receipts||[]).some(h=>h.userId===C.id&&(h.status==="READ"||h.status==="SEEN"))||(en.current.add(o),e.unobserve(s))}en.current.size&&Pi()},{root:V.current,threshold:[.25]});Wn.current=e;for(const n of K.data){if(n.senderId===C.id||(n.receipts||[]).some(o=>o.userId===C.id&&(o.status==="READ"||o.status==="SEEN")))continue;const s=Jt.current.get(n.id);s&&e.observe(s)}return()=>{e.disconnect()}},[a,K.data,C?.id]),c.useEffect(()=>{const e=()=>{if(!V.current)return;const n=V.current.clientWidth;Nr(n>=900)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[a]);async function pr(e,n="",r){if(!(!a||e.length===0)){if(j?.isSecret){alert("Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð² ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð±ÐµÑÐµÐ´Ð°Ñ… Ð¿Ð¾ÐºÐ° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹. Ð­Ñ‚Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¿Ð¾Ð·Ð¶Ðµ.");return}ts(!0),ir(0);try{const s=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,o=[],i=e.reduce((p,x)=>p+x.size,0);for(const p of e)if(p.type.startsWith("image/")){const x=URL.createObjectURL(p),{width:m,height:g}=await Oi(x);o.push({url:x,type:"IMAGE",width:m,height:g,progress:0,__pending:!0})}else o.push({url:p.name,type:"FILE",__pending:!0,progress:0});Mt(p=>({...p,[a]:[...p[a]||[],{id:s,createdAt:Date.now(),senderId:C?.id||"me",attachments:o,content:n}]}));const d=[];let h=0;for(let p=0;p<e.length;p++){const x=e[p],m=o[p],g=new FormData;g.append("file",x);const b={url:await new Promise((E,D)=>{const S=new XMLHttpRequest;S.open("POST","/api/upload");try{const M=vt.getState().session?.accessToken;M&&S.setRequestHeader("Authorization",`Bearer ${M}`)}catch{}S.upload.onprogress=M=>{if(M.lengthComputable){const N=Math.round((h+M.loaded)/i*100);ir(N),Mt(z=>{const $=(z[a]||[]).map(re=>({...re,attachments:re.attachments.map(ce=>({...ce}))})),q=$[$.length-1];if(q){const re=q.attachments.findIndex(ce=>ce.__pending&&ce.type===(x.type.startsWith("image/")?"IMAGE":"FILE")&&(!ce.width||ce.url.startsWith("blob:")));re>=0&&(q.attachments[re].progress=N)}return{...z,[a]:$}})}},S.onreadystatechange=()=>{if(S.readyState===4)if(S.status>=200&&S.status<300)try{const M=JSON.parse(S.responseText);E(M.url)}catch(M){D(M)}else D(new Error("upload failed"))},S.send(g)}),type:x.type.startsWith("image/")?"IMAGE":"FILE"};m&&m.type==="IMAGE"&&m.width&&m.height&&(b.metadata={width:m.width,height:m.height}),d.push(b),h+=x.size,ir(Math.round(h/e.reduce((E,D)=>E+D.size,0)*100))}const u=d.every(p=>p.type==="IMAGE")?"IMAGE":"FILE";await H.post("/conversations/send",{conversationId:a,type:u,content:n,attachments:d,replyToId:r}),Mt(p=>{const m=(p[a]||[]).filter(g=>g.id!==s);if(m.length===0){const{[a]:g,...I}=p;return I}return{...p,[a]:m}}),T.invalidateQueries({queryKey:["messages",a]})}catch{}ts(!1)}}async function Oi(e){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=e})}c.useEffect(()=>{let e=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),os(Math.round(performance.now()-r))}catch{os(null)}};return n(),e=window.setInterval(n,15e3),()=>{e&&clearInterval(e)}},[]),c.useEffect(()=>{let e=null;const n=()=>T.invalidateQueries({queryKey:["conversations"]});return e=window.setInterval(n,2e4),()=>{e&&clearInterval(e)}},[T]);function gr(e){const n=e.status,r=e.lastSeenAt?new Date(e.lastSeenAt):null;if(n==="ONLINE")return"ÐžÐÐ›ÐÐ™Ð";if(n==="BACKGROUND")return"Ð’ Ð¤ÐžÐÐ•";if(!r)return"Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½";const o=new Date().getTime()-r.getTime(),i=Math.floor(o/6e4);if(i<1)return"Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";if(i<60)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${i} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;const d=Math.floor(i/60);if(d<24)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${d} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;const h={hour:"2-digit",minute:"2-digit"},u=r.toLocaleDateString(),p=r.toLocaleTimeString([],h);return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${u} Ð² ${p}`}function mr(e){const n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/3600),s=Math.floor(n%3600/60),o=n%60;return r>0?`${r}:${String(s).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${s}:${String(o).padStart(2,"0")}`}function Is(e){const n=e?"conversations-list slider-panel":"conversations-list";return t.jsxs("aside",{className:n,children:[t.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[t.jsxs("div",{className:"logo",children:[t.jsx("span",{children:"Ð•"}),t.jsx("span",{className:"b",children:"Ð‘"}),t.jsx("span",{children:"Ð»ÑƒÑˆÐ°"})]}),t.jsx("div",{className:"subtitle",children:"Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÐ¼ÑÑ"})]})}),t.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[t.jsx("div",{ref:Ur,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:W.data?.slice().sort((r,s)=>{const o=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(s.conversation.messages?.[0]?.createdAt?new Date(s.conversation.messages[0].createdAt).getTime():0)-o}).filter(r=>{const s=r.conversation;return!(s.isSecret&&(s.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const s=r.conversation,o=s.participants.filter(m=>ve?m.user.id!==ve:!0).map(m=>m.user),i=o.map(m=>m.displayName??m.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",d=s.title??i,h=s.isGroup||s.participants.length>2,u=!!s.isSecret;o.map(m=>m.displayName??m.username).join(", ");const p=a===s.id,x=f===s.id;return t.jsxs("div",{onContextMenu:m=>{m.preventDefault(),m.stopPropagation(),Yt({open:!0,x:m.clientX,y:m.clientY,conversationId:s.id})},onClick:()=>ft(s.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...x?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)"}:{}},children:[h?(()=>{const g=dt[s.id]?.active;return t.jsx(se,{name:d?.trim()?.charAt(0)||"Ð“",id:s.id,avatarUrl:s.avatarUrl&&s.avatarUrl.trim()?s.avatarUrl:void 0,presence:g?"IN_CALL":void 0})})():(()=>{const g=dt[s.id]?.active;return t.jsx(se,{name:o[0]?.displayName??o[0]?.username??"D",id:o[0]?.id??s.id,presence:g?"IN_CALL":o[0]?.status??"OFFLINE",avatarUrl:o[0]?.avatarUrl&&o[0].avatarUrl.trim()?o[0].avatarUrl:void 0})})(),t.jsxs("div",{children:[t.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:d}),!h&&u&&t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:t.jsx(jr,{size:12,color:"#22c55e"})})]}),t.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…`:(()=>{const m=dt[s.id];if(m?.active){const g=m.startedAt?Date.now()-m.startedAt:typeof m.elapsedMs=="number"?m.elapsedMs:0;return t.jsx("span",{children:mr(g)})}else if(m&&m.endedAt){const g=m.endedAt,b=Date.now()-g,E=Math.floor(b/6e4);if(E<1)return t.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(E<60)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",E," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const D=Math.floor(E/60);if(D<24)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",D," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const S=new Date(g),M=S.toLocaleDateString(),N=S.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",M," Ð² ",N]})}return h?null:gr(o[0]??{})})()})]})]},s.id)})}),ri&&t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),ii&&t.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),t.jsxs("div",{className:"conv-footer",children:[t.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsxs("div",{style:{display:"flex",gap:12},children:[t.jsxs("div",{onClick:()=>Fr(!0),className:"tile",style:{marginTop:0,flex:1},children:[t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(Na,{size:22})}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:"Ð‘ÐµÑÐµÐ´Ð°"}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})]}),t.jsxs("div",{onClick:Hi,className:"tile",style:{marginTop:0,flex:1},children:[t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:be.data&&be.data.length>0?t.jsx(La,{size:22}):he.data&&he.data.length>0?t.jsx(Za,{size:22}):t.jsx(kr,{size:22})}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:be.data&&be.data.length>0?"ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ":he.data&&he.data.length>0?"Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})]})]}),t.jsxs("div",{className:"tile",onClick:()=>an(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const r=wi??je.data?.status,s=bi?"ONLINE":"OFFLINE",o=(r??s??"OFFLINE").toString().toUpperCase(),i=["ONLINE","AWAY","BACKGROUND","OFFLINE"],d=o,h=s,u=i.includes(d)?d:h,p=je.data?.avatarUrl??C?.avatarUrl??void 0;return t.jsx(se,{name:C?.displayName??C?.username??"Me",id:C?.id??"me",presence:u,avatarUrl:p})})(),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:700},children:C?.displayName??C?.username??"Ð¯"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",je.data?.eblid??"â€” â€” â€” â€”"]})]})]})]})]})]})}function Es(e){const n=e?"messages-pane slider-panel":"messages-pane",r=bs,s=ws;let o="";return j?.isSecret&&(r?o="Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°.":js?o=xs?`Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Â«${xs}Â»`:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.":s||(o="Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...")),t.jsxs("section",{className:n,children:[t.jsxs("header",{style:{...a?dt[a]?.active?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:R?"column":"row",justifyContent:R?"flex-start":"space-between",alignItems:R?"stretch":"center",flexShrink:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:R?"100%":"auto",padding:R?"0 8px":"0"},children:[e&&t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:Ti,children:t.jsx(Ra,{size:18})}),j?(()=>{const i=j.participants.filter(g=>ve?g.user.id!==ve:!0).map(g=>g.user),d=i.map(g=>g.displayName??g.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",h=j.title??d,u=j.isGroup||j.participants.length>2,p=!!j.isSecret&&!u,x=dt[j.id],m=x?.active;return u?t.jsxs(t.Fragment,{children:[t.jsx("div",{onClick:()=>Gt(!0),style:{cursor:"pointer"},children:t.jsx(se,{name:h?.trim()?.charAt(0)||"Ð“",id:j.id,size:60,avatarUrl:j.avatarUrl&&j.avatarUrl.trim()?j.avatarUrl:void 0,presence:m?"IN_CALL":void 0})}),t.jsxs("div",{style:{flex:1,minWidth:0,order:R?1:2},children:[t.jsx("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8},children:h}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:m?t.jsx(t.Fragment,{children:(()=>{const g=x.participants||[],I=j.participants||[],b=x.startedAt?Date.now()-x.startedAt:typeof x.elapsedMs=="number"?x.elapsedMs:0;return t.jsxs(t.Fragment,{children:[x.active&&t.jsx("span",{children:mr(b)}),I.length>0&&t.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[x.startedAt&&" â€¢ ",I.map((E,D)=>{const S=E.user,M=g.length>0&&g.includes(S.id);return t.jsxs("span",{style:{fontWeight:M?700:400,color:M?"var(--brand-600)":"var(--text-muted)"},children:[D>0&&", ",S.displayName??S.username,M&&" âœ“"]},S.id)})]})]})})()}):x&&x.endedAt?(()=>{const g=x.endedAt,b=Date.now()-g,E=Math.floor(b/6e4);let D="";if(E<1)D="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";else if(E<60)D=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${E} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;else{const M=Math.floor(E/60);if(M<24)D=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${M} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;else{const N=new Date(g),z=N.toLocaleDateString(),_=N.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});D=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${z} Ð² ${_}`}}const S=j.participants||[];return t.jsxs(t.Fragment,{children:[t.jsx("span",{children:D}),S.length>0&&t.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" â€¢ ",S.map((M,N)=>{const z=M.user;return t.jsxs("span",{children:[N>0&&", ",z.displayName??z.username]},z.id)})]})]})})():i.map(g=>g.displayName??g.username).join(", ")})]}),t.jsx("button",{className:R?"btn btn-secondary":"btn btn-icon btn-ghost",title:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²",onClick:()=>{Hn([]),Bn("friends"),Pn(["","","",""]),Ct(null),it(null),It(!1),Br(!0)},style:R?{padding:"8px 16px",height:42,borderRadius:999,fontSize:14,fontWeight:500,whiteSpace:"nowrap",flexShrink:0,marginLeft:"auto",order:2}:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:60,height:60,minWidth:60,minHeight:60,borderRadius:999,order:1},children:R?t.jsxs(t.Fragment,{children:[t.jsx(kr,{size:16}),t.jsx("span",{style:{marginLeft:6},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]}):t.jsx(kr,{size:20})})]}):(()=>{const g=i[0];return t.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[t.jsx("div",{style:{marginRight:10},children:t.jsx(se,{name:g?.displayName??g?.username??"D",id:g?.id??j.id,avatarUrl:g?.avatarUrl&&g.avatarUrl.trim()?g.avatarUrl:void 0,presence:x?.active?"IN_CALL":g?.status??"OFFLINE",size:60})}),t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{children:h}),i.length===1&&t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:999,background:p?"rgba(34,197,94,0.12)":"rgba(249,115,22,0.15)"},children:p?t.jsx(jr,{size:14,color:"#22c55e"}):t.jsx(_s,{size:14,color:"#f97316"})})]}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:x?.active?(()=>{const I=x.startedAt?Date.now()-x.startedAt:typeof x.elapsedMs=="number"?x.elapsedMs:0;return t.jsx("span",{children:mr(I)})})():x&&x.endedAt?(()=>{const I=x.endedAt,E=Date.now()-I,D=Math.floor(E/6e4);if(D<1)return t.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(D<60)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",D," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const S=Math.floor(D/60);if(S<24)return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",S," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const M=new Date(I),N=M.toLocaleDateString(),z=M.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",N," Ð² ",z]})})():g?g.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":g.status==="BACKGROUND"?"Ð’ Ð¤ÐžÐÐ•":gr(g):""})]}),i.length===1&&t.jsx("button",{title:p?Ni:"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚",disabled:!p&&ds,onClick:async()=>{if(p){Lt(!0);return}g?.id&&await gs(g.id)},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:R?42:44,height:R?42:44,minWidth:R?42:44,padding:0,margin:0,borderRadius:999,background:p?"#ef4444":"transparent",border:p?"1px solid #ef4444":"1px solid var(--surface-border)",color:p?"#fff":"var(--text-primary)",cursor:"pointer",fontSize:0,lineHeight:0,fontFamily:"inherit",fontWeight:"normal",textTransform:"none",letterSpacing:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"clip",marginLeft:"auto",alignSelf:"center"},children:t.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:0,lineHeight:0},children:p?t.jsx(jr,{size:R?20:22}):t.jsx(_s,{size:R?20:22})})})]})})()})():t.jsx("div",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚"})]}),Ii&&j&&!!j.isSecret&&(j.participants?.length??0)<=2&&typeof document<"u"&&Us.createPortal(t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:R?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Lt(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:R?16:20,borderRadius:R?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:R?"center":"left"},onClick:i=>i.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:R?"column":"row",gap:R?8:0},children:[t.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚?"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Lt(!1),style:{alignSelf:R?"flex-end":void 0},children:t.jsx(Me,{size:18})})]}),t.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ñƒ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."}),t.jsxs("div",{style:{display:"flex",justifyContent:R?"center":"flex-end",alignItems:"center",flexDirection:R?"column":"row",gap:R?12:8},children:[t.jsx("button",{className:"btn btn-ghost",onClick:()=>Lt(!1),style:R?{width:"100%"}:void 0,children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:R?"100%":void 0},onClick:async()=>{if(a)try{await H.delete(`/conversations/${a}`),T.invalidateQueries({queryKey:["conversations"]}),T.removeQueries({queryKey:["messages",a]}),Lt(!1),l(null)}catch(i){console.error("Failed to end secret conversation:",i)}},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ"})]})]})}),document.body),a&&(()=>{const d=dt[a]?.active;j?.isGroup||(j?.participants.length??0)>2;const h=d&&O.activeConvId===a,u=f===a,x=h&&(!u||v===a&&u),m={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:R?"8px 12px":"12px 16px",flex:R?1:"auto",minWidth:R?0:"auto",fontSize:R?"14px":"15px",fontWeight:R?500:600,height:R?"42px":"46px",minHeight:R?"42px":"46px",boxSizing:"border-box"},g={display:"flex",alignItems:"center",gap:8,width:R?"100%":"auto",padding:R?"0 8px":"0",justifyContent:R?"center":"flex-end",marginLeft:R?0:"auto"},I=async()=>{if(a&&await Sn(!1))try{jn(a),Os(a,!1),O.startOutgoing(a,!1),we(S=>{const M=S[a],N=C?.id;return M?.active?N&&M.participants&&!M.participants.includes(N)?{...S,[a]:{...M,participants:[...M.participants,N]}}:S:{...S,[a]:{startedAt:Date.now(),active:!0,participants:N?[N]:[]}}}),y(a),w(S=>S===a?null:S)}catch(S){console.error("Error starting call:",S)}},b=async()=>{if(a&&await Sn(!0))try{jn(a),Os(a,!0),O.startOutgoing(a,!0),we(S=>{const M=S[a],N=C?.id;return M?.active?N&&M.participants&&!M.participants.includes(N)?{...S,[a]:{...M,participants:[...M.participants,N]}}:S:{...S,[a]:{startedAt:Date.now(),active:!0,participants:N?[N]:[]}}}),y(a),w(S=>S===a?null:S)}catch(S){console.error("Error starting call:",S)}},E=()=>{a&&(y(a),w(null))},D=()=>d?h?t.jsxs(t.Fragment,{children:[x?t.jsxs("button",{className:"btn btn-secondary",onClick:E,style:m,children:[t.jsx(Fa,{size:R?16:18}),R?"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ":" Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"]}):!R&&t.jsx("div",{style:{flex:1}}),t.jsxs("button",{className:"btn",onClick:()=>{const S=j?.participants?.length??0,M=S<=2,N=j?.isGroup||S>2;if(M&&f)Ps(f),we(z=>{const _=z[f];return _?.active?{...z,[f]:{..._,active:!1,endedAt:Date.now()}}:z});else if(N&&f){try{ma(f)}catch{}we(z=>{const _=z[f];if(!_||!_.participants)return z;const $=C?.id;return!$||!_.participants.includes($)?z:{...z,[f]:{..._,participants:_.participants.filter(q=>q!==$)}}})}y(null),w(null),O.endCall(),De()},style:{...m,background:"#ef4444",color:"#fff"},children:[t.jsx(Ys,{size:R?16:18}),R?"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ":" Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(y(a),w(M=>M===a?null:M),O.startOutgoing(a,!1),j?.isGroup||(j?.participants?.length??0)>2)try{Bs(a,!1)}catch{}},style:m,children:[t.jsx(Sr,{size:R?16:18}),R?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"]}),t.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(y(a),w(M=>M===a?null:M),O.startOutgoing(a,!0),j?.isGroup||(j?.participants?.length??0)>2)try{Bs(a,!0)}catch{}},style:m,children:[t.jsx(Cr,{size:R?16:18}),R?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾"]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"btn btn-secondary",onClick:()=>{I()},style:m,children:[t.jsx(Sr,{size:R?16:18}),R?"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº":" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº"]}),t.jsxs("button",{className:"btn btn-primary",onClick:()=>{b()},style:m,children:[t.jsx(Cr,{size:R?16:18}),R?"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"]})]});return t.jsxs(t.Fragment,{children:[t.jsx("div",{style:g,children:D()}),lt&&t.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:R?"100%":420,width:R?"100%":"auto"},children:[t.jsx("span",{style:{flex:1},children:lt}),t.jsx("button",{type:"button",onClick:()=>Rt(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:t.jsx(Me,{size:14})})]})]})})()]}),!j?.isSecret&&gt&&t.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:R?"column":"row",gap:12,alignItems:R?"stretch":"center"},children:gt.isInitiator?t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{flex:1},children:"Ð–Ð´Ñ‘Ð¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚."}),t.jsx("div",{style:{display:"flex",gap:8},children:t.jsx("button",{className:"btn btn-ghost",onClick:()=>ms(gt.conversationId),disabled:or,style:{color:"#f87171"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{flex:1},children:[gt.initiatorName," Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ."]}),t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>Ri(gt.conversationId),disabled:or,children:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ"}),t.jsx("button",{className:"btn btn-ghost",onClick:()=>ms(gt.conversationId),disabled:or,style:{color:"#bae6fd"},children:"ÐžÑ‚ÐºÐ°Ð·Ð°Ñ‚ÑŒÑÑ"})]})]})}),t.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[t.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),t.jsx("div",{ref:V,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:a?j?.isSecret&&(!s||r)?t.jsx("div",{className:"messages-empty",children:o}):(()=>{const i=(Ee?[...Ee]:[]).filter(u=>!u.deletedAt).sort((u,p)=>new Date(u.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),d=wn,h=[...i||[],...d];return h?h.map((u,p)=>{if(u.deletedAt)return null;if(u.type==="SYSTEM")return t.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:u.content})},u.id);const x=h[p-1],m=h[p+1],g=!m||m.senderId!==u.senderId,I=!!x&&x.senderId===u.senderId,b=u.senderId===C?.id,S=`${St?"msg left":b?"msg me":"msg them"} ${I?"compact":"gap"}`,M=St?"msg-bubble left":b?"msg-bubble me":"msg-bubble them",N=g?`${M} ${b&&!St?"tail-right":"tail-left"}`:M,z=Ss[u.senderId],_=z?.displayName??z?.username??(b?C?.displayName??C?.username??"Me":"User"),$=z?.id??(b?C?.id??"me":"user"),q=b?"#303845":zi(u.senderId),re="#f1f3f6",ce=St&&g,Te=St,Ae=u.createdAt?new Date(u.createdAt):null,Se=Ae?Ae.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",Ne=(j?.participants||[]).map(A=>A.user.id).filter(A=>ve?A!==ve:!0),ze=u.receipts||[],Ht=b&&Ne.some(A=>ze.some(F=>F.userId===A&&(F.status==="READ"||F.status==="SEEN"))),Bt=b&&Ht?"âœ“":"",yr=(A,F)=>{He({open:!0,x:A,y:F,messageId:u.id})},Fi=A=>{A.preventDefault(),yr(A.clientX,A.clientY)},_i=()=>{const A=u.replyTo?.id;if(!A)return;const F=Jt.current.get(A);F&&F.scrollIntoView({behavior:"smooth",block:"center"})},Rs=h.filter(A=>(A.attachments||[]).some(F=>F.type==="IMAGE")).flatMap(A=>A.attachments.filter(F=>F.type==="IMAGE").map(F=>F.url)),Xi=A=>{const F=Rs.findIndex(le=>le===A);Fe({open:!0,index:F>=0?F:0,items:Rs})},Yi=R?{}:{onContextMenu:Fi,...{onPointerDown:A=>{const F=window.setTimeout(()=>yr(A.clientX,A.clientY),450),le=()=>{window.clearTimeout(F),window.removeEventListener("pointerup",le),window.removeEventListener("pointermove",An)},An=()=>{window.clearTimeout(F),window.removeEventListener("pointerup",le),window.removeEventListener("pointermove",An)};window.addEventListener("pointerup",le,{passive:!0}),window.addEventListener("pointermove",An,{passive:!0})}}};return t.jsxs("div",{className:S,...Yi,children:[Te&&(ce?t.jsx(se,{name:_,id:$,avatarUrl:(()=>{const A=Ss[u.senderId]?.avatarUrl;return A&&A.trim()?A:void 0})()}):t.jsx("div",{className:"avatar-spacer"})),t.jsxs("div",{className:N,"data-mid":u.id,ref:A=>{if(!A){Jt.current.delete(u.id);return}Jt.current.set(u.id,A),Wn.current?.observe(A)},style:{"--bubble-bg":q,"--bubble-fg":re},onClick:A=>{if(!R||A.target.closest("a, button, input, textarea, img, video"))return;const le=typeof window.getSelection=="function"?window.getSelection():null;le&&le.toString()||yr(A.clientX,A.clientY)},children:[u.reactions&&u.reactions.length>0&&(()=>{const A={};for(const F of u.reactions)A[F.emoji]=(A[F.emoji]||0)+1;return t.jsx("div",{style:{position:"absolute",bottom:-18,right:b?8:void 0,left:b?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(A).map(([F,le])=>t.jsxs("span",{style:{fontSize:12,color:"#ffc46b"},children:[F,le>1?` ${le}`:""]},F))})})(),u.replyTo&&t.jsxs("div",{onClick:_i,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:b?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°: ",u.replyTo.content??"ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"]}),t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:u.content}),(u.attachments||[]).map((A,F)=>{if(A.type==="IMAGE"){const le=typeof window<"u"?window.innerWidth:1280,Pt=le<=768?Math.max(320,Math.floor(le/2)):Math.min(600,Math.max(320,Math.floor(le/3))),Gi=`${A.url||F}`,Ms=ki[Gi],Ot=Ms?.width||A.width||A.metadata?.width||Pt,Rn=Ms?.height||A.height||A.metadata?.height||Math.round(Ot*.75),Mn=Rn/Ot||.75,Ln=Pt;let mt=Pt;Mn<.5?mt=Math.max(Math.round(Pt*.6),200):Mn<.7&&(mt=Math.max(Math.round(Pt*.75),200));const $i=Ot>Ln?Ln/Ot:1,Ki=Rn>mt?mt/Rn:1,Ls=Math.min($i,Ki,1);let Xe=Ot*Ls,Re=Rn*Ls;Xe>Ln&&(Xe=Ln,Re=Xe*Mn),Re>mt&&(Re=mt,Xe=Re/Mn),Xe=Math.round(Xe),Re=Math.round(Re);const xr=`${A.url||F}`,vr=!!ji[xr],Dn=A.__pending||!vr;return t.jsxs("div",{style:{maxWidth:"100%",maxHeight:Re,width:Dn?Math.min(Xe,typeof window<"u"?window.innerWidth-100:Xe):"fit-content",height:Dn?Re:"auto",minWidth:0,minHeight:Dn?Re:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Dn&&t.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[t.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),typeof A.progress=="number"&&A.progress<100?t.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[A.progress,"%"]})]}):t.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),t.jsx("img",{src:A.url,alt:"img",style:{maxWidth:"100%",maxHeight:Re,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:u.id?.startsWith("tmp-")?"default":"zoom-in",opacity:A.__pending?.85:1,display:vr?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:br=>{const st=br.target;if(!A.width&&!A.metadata?.width&&st.naturalWidth&&st.naturalHeight&&Ci(yt=>({...yt,[xr]:{width:st.naturalWidth,height:st.naturalHeight}})),Si(yt=>({...yt,[xr]:!0})),V.current&&qe.current){const yt=V.current;yt.scrollTop=yt.scrollHeight}},onError:br=>{const st=br.target;st&&(st.style.display="none")},onClick:()=>{A.__pending||Xi(A.url)}}),vr&&typeof A.progress=="number"&&A.progress<100&&t.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:t.jsx("div",{style:{width:`${A.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`${A.url}-${F}`)}return t.jsxs("div",{style:{marginTop:8},children:[A.__pending?t.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Ð¤Ð°Ð¹Ð»: ",A.url]}):t.jsxs("a",{href:A.url,target:"_blank",rel:"noreferrer",style:{display:"inline-flex",alignItems:"center",gap:6},children:["Ð¤Ð°Ð¹Ð»: ",A.url.split("/").pop()]}),typeof A.progress=="number"&&A.progress<100&&t.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:t.jsx("div",{style:{width:`${A.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${A.url}-${F}`)})]}),t.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[Se," ",Bt]})]})]},u.id)}):null})():t.jsx("div",{className:"messages-empty",children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ"})}),a&&t.jsx("button",{className:ci?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{V.current&&V.current.scrollTo({top:V.current.scrollHeight,behavior:"smooth"}),qe.current=!0,Ve.current=!1,Qt(!1)},children:"â†“"}),t.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:i=>{i.preventDefault(),ar(!0)},onDragLeave:()=>ar(!1),onDrop:i=>{i.preventDefault(),ar(!1);const d=Array.from(i.dataTransfer.files||[]);pr(d)},children:j?.isSecret&&(!s||r)?t.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:o}):t.jsxs(t.Fragment,{children:[U&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[t.jsx(Ka,{size:16,color:"var(--text-muted)"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°:"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:U.preview}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>B(null),style:{marginLeft:"auto",flexShrink:0},children:t.jsx(Me,{size:16})})]}),fe&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[t.jsx("img",{src:fe.preview,alt:"Preview",style:{width:48,height:48,objectFit:"cover",borderRadius:6}}),t.jsx("div",{style:{flex:1,fontSize:12,color:"var(--text-muted)"},children:"Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð±ÑƒÑ„ÐµÑ€Ð° Ð¾Ð±Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{fe&&URL.revokeObjectURL(fe.preview),rt(null)},style:{flexShrink:0},children:t.jsx(Me,{size:16})})]}),t.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:P,onChange:async i=>{const d=Array.from(i.target.files||[]);!a||d.length===0||await pr(d)}}),t.jsxs("form",{autoComplete:"off",onSubmit:async i=>{if(i.preventDefault(),!a)return;const d=k.trim();if(fe){const h=fe.file,u=fe.preview;URL.revokeObjectURL(u),rt(null),await pr([h],d||"",U?.id),L(""),B(null)}else d&&(await ys(j,{type:"TEXT",content:d,replyToId:U?.id}),L(""),B(null));T.invalidateQueries({queryKey:["messages",a]}),setTimeout(()=>{V.current&&(V.current.scrollTop=V.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:fe?"Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑŽ...":"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...",value:k,onChange:i=>L(i.target.value),onPaste:async i=>{if(!a)return;const d=i.clipboardData?.items;if(d)for(let h=0;h<d.length;h++){const u=d[h];if(u.type.indexOf("image")!==-1){i.preventDefault();const p=u.getAsFile();if(p){const x=URL.createObjectURL(p);rt({file:p,preview:x})}break}}},ref:X,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16}}),t.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>P.current?.click(),style:{flexShrink:0,whiteSpace:"nowrap"},children:R?t.jsx(Xa,{size:16}):"ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ"})]}),xi&&t.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:t.jsx("div",{style:{width:`${vi}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),t.jsx(c.Suspense,{fallback:null,children:f&&t.jsx(ko,{open:!!f,conversationId:f,minimized:v===f,peerAvatarUrl:(()=>{const i=j?.participants||[];return i.length===2?i.find(h=>ve?h.user.id!==ve:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const i=j?.participants||[],d={};for(const h of i){const u=h.user,p=u.displayName??u.username??u.id;d[p]=u.avatarUrl??null}return C&&(d[C.displayName??C.username??C.id]=je.data?.avatarUrl??C.avatarUrl??null),d})(),avatarsById:(()=>{const i=j?.participants||[],d={};for(const h of i){const u=h.user;d[u.id]=u.avatarUrl??null}return C&&(d[C.id]=je.data?.avatarUrl??C.avatarUrl??null),d})(),localUserId:C?.id??null,isGroup:(j?.participants,!!j?.isGroup),onMinimize:()=>{f&&w(f)},onClose:i=>{const d=f??Nt.current;if(!d)return;const h=()=>{const u=lr(d),p=u?.participants?.length??0,x=!!(u?.isGroup||p>2);!x&&Ps(d),we(g=>{const I=g[d];if(!I)return g;if(x){const b=(I.participants||[]).filter(E=>ve?E!==ve:!0);return{...g,[d]:{...I,participants:b}}}return I.active?{...g,[d]:{...I,active:!1,endedAt:Date.now()}}:g}),y(g=>g===d?null:g),w(g=>g===d?null:g),O.endCall(),De()};!i?.manual&&zt(d)?dr(d,h):(_e(d),h())},initialVideo:O.initialVideo,initialAudio:O.initialAudio})}),O.incoming&&Us.createPortal(t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:t.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:12},children:O.incoming.video?"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð°ÑƒÐ´Ð¸Ð¾Ð·Ð²Ð¾Ð½Ð¾Ðº"}),t.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[t.jsx(se,{name:O.incoming.from.name??O.incoming.from.id,id:O.incoming.from.id,size:64,avatarUrl:O.incoming.from.avatarUrl??W.data?.find(i=>i.conversation.id===O.incoming.conversationId)?.conversation?.participants?.find(i=>i.user.id===O.incoming.from.id)?.user?.avatarUrl??he.data?.find(i=>i.friend?.id===O.incoming.from.id)?.friend?.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,fontSize:16},children:O.incoming.from.name??O.incoming.from.id}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð·Ð²Ð¾Ð½Ð¸Ñ‚â€¦"})]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{hs(!1)},children:[t.jsx(Sr,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ"})]}),t.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{hs(!0)},children:[t.jsx(Cr,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"})]})]}),t.jsx("div",{style:{display:"flex"},children:t.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Hs(O.incoming.conversationId),O.setIncoming(null),De()},children:[t.jsx(Ys,{size:18}),t.jsx("span",{children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})}),lt&&t.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:lt})]})]})}),document.body)]})}function As(e,n){n&&T.setQueryData(["messages",e],r=>{const s=Array.isArray(r)?[...r]:[];return s.some(o=>o.id===n.id)||(s.push(n),s.sort((o,i)=>new Date(o.createdAt||0).getTime()-new Date(i.createdAt||0).getTime())),s})}function Wi(e,n){n&&T.setQueryData(["messages",e],r=>{if(!Array.isArray(r))return r;const s=r.findIndex(i=>i.id===n.id);if(s===-1)return r;const o=[...r];return o[s]={...o[s],...n},o})}return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:R?"chats-page mobile-slider":"chats-page",children:R?t.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${On==="conversation"?"-100vw":"0"})`},onTouchStart:e=>{const n=e.touches[0];tn.current={x:n.clientX,y:n.clientY},_n.current=0},onTouchMove:e=>{if(!tn.current)return;const n=e.touches[0];_n.current=n.clientX-tn.current.x},onTouchEnd:()=>{const e=_n.current;tn.current=null,!(Math.abs(e)<50)&&(e<0&&a&&ke("conversation"),e>0&&ke("list"))},children:[Is(!0),Es(!0)]}):t.jsxs(t.Fragment,{children:[Is(!1),Es(!1)]})}),mi&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>an(!1),children:t.jsx(Me,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:C?.displayName??C?.username??"Me",id:C?.id??"me",avatarUrl:ye??je.data?.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:C?.displayName??C?.username}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",je.data?.eblid??"â€” â€” â€” â€”"]})]})]}),t.jsx("input",{ref:Qr,type:"file",accept:"image/*",onChange:e=>{const n=e.target.files?.[0];if(n){cn(n);try{ln(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!ye&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{onClick:()=>Qr.current?.click(),onDragOver:e=>{e.preventDefault(),rr(!0)},onDragLeave:()=>rr(!1),onDrop:e=>{e.preventDefault(),rr(!1);const n=e.dataTransfer.files?.[0];if(n){cn(n);try{ln(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(es?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:es?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(wr,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),ye&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:Ze,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,r=Math.max(.1,Math.min(10,Y.scale*(1+n))),s=Ze.current?.getBoundingClientRect();if(s){const o=e.clientX-s.left,i=e.clientY-s.top,d=r/Y.scale,h=o-(o-Y.x)*d,u=i-(i-Y.y)*d;Oe({x:h,y:u,scale:r})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=Ze.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,o=r/2,i=s/2,h=240/2,u=e.clientX-n.left,p=e.clientY-n.top,x=u-o,m=p-i;if(x*x+m*m>h*h)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,I=e.clientY,b={...Y},E=S=>{S.preventDefault();const M=S.clientX-g,N=S.clientY-I;Oe({...b,x:b.x+M,y:b.y+N})},D=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",D)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",D,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:tr,src:ye,alt:"preview",style:{position:"absolute",left:Y.x,top:Y.y,transform:`scale(${Y.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,r=Ze.current;if(!r)return;const s=r.clientWidth,o=r.clientHeight,i=240,d=n.naturalWidth,h=n.naturalHeight,u=s/2,p=o/2,x=i/d,m=i/h,g=Math.max(x,m)*1.2,I=u-d*g/2,b=p-h*g/2;Oe({x:I,y:b,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Y.scale*100),"%"]})]}),t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Oe(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:10,step:.05,value:Y.scale,onChange:e=>Oe(n=>({...n,scale:parseFloat(e.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Oe(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]}),t.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:t.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:R?"Ð”Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°, Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ":"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾ Ð¼Ñ‹ÑˆÐ¸ Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°"})})]}),t.jsx("canvas",{ref:dn,width:240,height:240,style:{display:"none"}})]}),er&&t.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>{cn(null),ye&&URL.revokeObjectURL(ye),ln(null)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:ot,onClick:async()=>{if(er){on(!0),un(0);try{let e=null;if(dn.current&&ye){const s=await new Promise(b=>{const E=new Image;E.onload=()=>b(E),E.src=ye}),o=dn.current.getContext("2d"),i=240;o.clearRect(0,0,i,i),o.save(),o.beginPath(),o.arc(i/2,i/2,i/2,0,Math.PI*2),o.closePath(),o.clip();const d=Ze.current?.clientWidth??320,h=Ze.current?.clientHeight??320,u={x:d/2,y:h/2},p={x:u.x-i/2,y:u.y-i/2,w:i,h:i},x=(p.x-Y.x)/Y.scale,m=(p.y-Y.y)/Y.scale,g=p.w/Y.scale,I=p.h/Y.scale;o.drawImage(s,x,m,g,I,0,0,i,i),o.restore(),e=await new Promise(b=>dn.current.toBlob(E=>b(E),"image/png"))}const n=new FormData;n.append("file",e??er);const r=await new Promise((s,o)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const d=vt.getState().session?.accessToken;d&&i.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}i.upload.onprogress=d=>{d.lengthComputable&&un(Math.round(100*d.loaded/d.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const d=JSON.parse(i.responseText);s(d.url)}catch(d){o(d)}else o(new Error("upload failed"))},i.send(n)});await H.patch("/status/me",{avatarUrl:r}),cn(null),ye&&URL.revokeObjectURL(ye),ln(null),je.refetch()}catch{}on(!1),ct("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ct(null),2200)}},children:ot?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),ot&&t.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:t.jsx("div",{style:{width:`${Vr}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),yn&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[t.jsx(Fs,{size:16}),t.jsx("span",{children:yn})]}),t.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:t.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await H.post("/auth/logout")}catch{}vt.getState().setSession(null),an(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[t.jsx(Xs,{size:18}),t.jsx("span",{children:"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð•Ð±Ð»ÑƒÑˆÐ¸"})]})}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:t.jsx("button",{className:"btn btn-ghost",onClick:()=>an(!1),children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})}),di&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>Be(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Be(!1),children:t.jsx(Me,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:At.trim()||"?",id:"new-group-avatar-preview",avatarUrl:at??void 0,size:60}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:At||"ÐÐ¾Ð²Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),t.jsx("input",{ref:Gn,type:"file",accept:"image/*",style:{display:"none"},onChange:e=>{const n=e.target.files?.[0];if(n){if(rn(n),ue)try{URL.revokeObjectURL(ue)}catch{}try{const r=URL.createObjectURL(n);Qe(r)}catch{Qe(null)}Ce({x:0,y:0,scale:1})}}}),!ue&&t.jsx(t.Fragment,{children:t.jsxs("div",{onClick:()=>Gn.current?.click(),onDragOver:e=>{e.preventDefault(),Kn(!0)},onDragLeave:()=>Kn(!1),onDrop:e=>{e.preventDefault(),Kn(!1);const n=e.dataTransfer.files?.[0];if(n){if(rn(n),ue)try{URL.revokeObjectURL(ue)}catch{}try{const r=URL.createObjectURL(n);Qe(r)}catch{Qe(null)}Ce({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(qr?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:qr?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(wr,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})}),ue&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:Je,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,r=Math.max(.1,Math.min(10,ee.scale*(1+n))),s=Je.current?.getBoundingClientRect();if(s){const o=e.clientX-s.left,i=e.clientY-s.top,d=r/ee.scale,h=o-(o-ee.x)*d,u=i-(i-ee.y)*d;Ce({x:h,y:u,scale:r})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=Je.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,o=r/2,i=s/2,h=240/2,u=e.clientX-n.left,p=e.clientY-n.top,x=u-o,m=p-i;if(x*x+m*m>h*h)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,I=e.clientY,b={...ee},E=S=>{S.preventDefault();const M=S.clientX-g,N=S.clientY-I;Ce({...b,x:b.x+M,y:b.y+N})},D=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",D)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",D,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:ui,src:ue,alt:"preview",style:{position:"absolute",left:ee.x,top:ee.y,transform:`scale(${ee.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,r=Je.current;if(!r)return;const s=r.clientWidth,o=r.clientHeight,i=240,d=n.naturalWidth,h=n.naturalHeight,u=s/2,p=o/2,x=i/d,m=i/h,g=Math.max(x,m)*1.2,I=u-d*g/2,b=p-h*g/2;Ce({x:I,y:b,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ce(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:4,step:.01,value:ee.scale,onChange:e=>{const n=parseFloat(e.target.value),r=Je.current?.getBoundingClientRect();if(!r){Ce(u=>({...u,scale:n}));return}const s=r.width/2,o=r.height/2,i=n/ee.scale,d=s-(s-ee.x)*i,h=o-(o-ee.y)*i;Ce({x:d,y:h,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ce(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]})]}),t.jsx("canvas",{ref:$n,width:240,height:240,style:{display:"none"}})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[t.jsx("button",{className:"btn btn-ghost",onClick:()=>{Be(!1)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:!ue,onClick:async()=>{if(!ue||!$n.current){Be(!1);return}try{const e=await new Promise(I=>{const b=new Image;b.onload=()=>I(b),b.src=ue}),n=$n.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const s=240;r.clearRect(0,0,s,s),r.save(),r.beginPath(),r.arc(s/2,s/2,s/2,0,Math.PI*2),r.closePath(),r.clip();const o=Je.current?.clientWidth??320,i=Je.current?.clientHeight??320,d={x:o/2,y:i/2},h={x:d.x-s/2,y:d.y-s/2,w:s,h:s},u=(h.x-ee.x)/ee.scale,p=(h.y-ee.y)/ee.scale,x=h.w/ee.scale,m=h.h/ee.scale;r.drawImage(e,u,p,x,m,0,0,s,s),r.restore();const g=await new Promise(I=>n.toBlob(b=>I(b),"image/png"));if(g){if(at)try{URL.revokeObjectURL(at)}catch{}const I=URL.createObjectURL(g);Kr(g),Gr(I)}}catch{}finally{Be(!1)}},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]})]})}),li&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:fr,children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[t.jsx("div",{style:{fontWeight:700},children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:fr,children:t.jsx(Me,{size:16})})]}),(()=>{const e=At.trim(),n=e||"?";return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[t.jsx("input",{placeholder:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ",value:At,onChange:r=>_r(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),t.jsx("input",{ref:Gn,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const s=r.target.files?.[0];if(s){if(rn(s),ue)try{URL.revokeObjectURL(ue)}catch{}try{const o=URL.createObjectURL(s);Qe(o)}catch{Qe(null)}Be(!0)}}}),t.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>Be(!0),title:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:t.jsx(se,{name:n,id:"new-group-avatar",avatarUrl:at??void 0,size:40})})]})})(),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),t.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:he.data?.map(e=>{const n=e.friend,r=nn.includes(n.id);return t.jsxs("div",{className:"tile",onClick:()=>Xr(s=>r?s.filter(o=>o!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾":"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},e.id)})}),t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:t.jsx("button",{className:"btn btn-primary",disabled:nn.length===0||Xn,onClick:async()=>{if(!(nn.length===0||Xn)){Yn(!0);try{const e=await H.post("/conversations",{participantIds:nn,title:At||void 0,isGroup:!0}),n=e.data?.conversation?.id;if(n&&($r||Yr))try{const r=new FormData;r.append("file",$r??Yr);const s=await new Promise((o,i)=>{const d=new XMLHttpRequest;d.open("POST","/api/upload");try{const h=vt.getState().session?.accessToken;h&&d.setRequestHeader("Authorization",`Bearer ${h}`)}catch{}d.onreadystatechange=()=>{if(d.readyState===4)if(d.status>=200&&d.status<300)try{const h=JSON.parse(d.responseText);o(h.url)}catch(h){i(h)}else i(new Error(`upload failed: ${d.status} ${d.statusText}`))},d.onerror=()=>i(new Error("Network error during upload")),d.send(r)});await H.patch(`/conversations/${n}`,{avatarUrl:s})}catch(r){console.error("Error setting group avatar:",r)}T.invalidateQueries({queryKey:["conversations"]}),e.data?.conversation?.id&&ft(e.data.conversation.id),fr()}catch(e){console.error("Error creating group:",e),alert(e?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ")}finally{Yn(!1)}}},children:Xn?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...":"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"})})]})}),fi&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[t.jsx("div",{style:{fontWeight:700},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>sn(!1),children:t.jsx(Me,{size:16})})]}),be.data&&be.data.length>0&&t.jsxs("div",{style:{marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:be.data.map(e=>t.jsxs("div",{className:"tile",children:[t.jsx(se,{name:e.friend.displayName??e.friend.username,id:e.friend.id,presence:e.friend.status,avatarUrl:e.friend.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:e.friend.displayName??e.friend.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ñ…Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ"})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await H.post("/contacts/respond",{contactId:e.id,action:"reject"}),be.refetch()},children:"ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-primary",onClick:async()=>{await H.post("/contacts/respond",{contactId:e.id,action:"accept"}),he.refetch(),be.refetch(),W.refetch()},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]},e.id))})]}),t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ EBLID"}),t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(e=>t.jsx("input",{ref:Vn[e],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:qn[e],onChange:n=>Ui(e,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},e))}),Pe&&t.jsxs("div",{className:"tile",style:{marginBottom:12},children:[t.jsx(se,{name:Pe.displayName??Pe.username,id:Pe.id,presence:Pe.status,avatarUrl:Pe.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:Pe.displayName??Pe.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsx("button",{disabled:pi,className:"btn btn-primary",onClick:Bi,children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐœÐ¾Ð¹ EBLID:"}),t.jsx("div",{style:{fontWeight:700},children:Zn||"â€” â€” â€” â€”"}),t.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{Zn&&navigator.clipboard.writeText(Zn)},title:"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID",children:t.jsx(Ha,{size:16})})]}),t.jsx("div",{style:{marginTop:16,fontWeight:700},children:"ÐœÐ¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ"}),t.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(he.data||[]).map(e=>{const n=e.friend;return t.jsxs("div",{className:"tile",children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]}),t.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await H.post("/contacts/remove",{contactId:e.id}),he.refetch()},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}),t.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await gs(n.id),sn(!1),T.invalidateQueries({queryKey:["conversations"]})},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),t.jsx("button",{className:"btn btn-primary",onClick:async()=>{const r=await H.post("/conversations",{participantIds:[n.id],isGroup:!1});sn(!1),ft(r.data.conversation.id),T.invalidateQueries({queryKey:["conversations"]})},children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‡Ð°Ñ‚"})]})]},e.id)})})]})}),Z.open&&Z.messageId&&t.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>He({open:!1,x:0,y:0,messageId:null}),children:t.jsxs("div",{ref:fs,className:"msg-menu",style:{position:"absolute",left:Z.x,top:Z.y,color:"#ffffff"},onClick:e=>e.stopPropagation(),children:[t.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["ðŸ‘","â¤ï¸","ðŸ‘Ž","ðŸ”¥"].map(e=>t.jsx("button",{onClick:async()=>{try{const n=Z.messageId;((Ee||[]).find(o=>o.id===n)?.reactions||[]).some(o=>o.userId===C?.id&&o.emoji===e)?await H.post("/messages/unreact",{messageId:n,emoji:e}):await H.post("/messages/react",{messageId:n,emoji:e}),a&&T.invalidateQueries({queryKey:["messages",a]})}catch{}He({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:"#ffffff"},children:e},e))}),t.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const e=Z.messageId,n=(Ee||[]).find(r=>r.id===e);B({id:e,preview:(n?.content??"").slice(0,100)}),He({open:!1,x:0,y:0,messageId:null})},children:"Ð¦Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),(()=>{const e=Z.messageId;return(Ee||[]).find(s=>s.id===e)?.senderId===C?.id?t.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await H.post("/messages/delete",{messageId:Z.messageId}),a&&T.invalidateQueries({queryKey:["messages",a]})}catch{}He({open:!1,x:0,y:0,messageId:null})},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}):null})(),t.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const e=Z.messageId,n=(Ee||[]).find(r=>r.id===e);try{await navigator.clipboard.writeText(n?.content||"")}catch{}He({open:!1,x:0,y:0,messageId:null})},children:"ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),t.jsx("button",{style:{color:"#ffffff"},onClick:()=>{$t({open:!0,messageId:Z.messageId}),He({open:!1,x:0,y:0,messageId:null})},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ"})]})}),nt.open&&t.jsx("div",{className:"lightbox-backdrop",onClick:()=>Fe({...nt,open:!1}),children:t.jsxs("div",{className:"lightbox-content",onClick:e=>e.stopPropagation(),children:[t.jsx("button",{className:"lightbox-arrow",onClick:()=>Fe(e=>({...e,index:(e.index-1+e.items.length)%e.items.length})),children:"â€¹"}),t.jsx("img",{src:nt.items[nt.index],alt:"preview",style:{transform:`scale(${yi})`,transformOrigin:"center center"}}),t.jsx("button",{className:"lightbox-arrow",onClick:()=>Fe(e=>({...e,index:(e.index+1)%e.items.length})),children:"â€º"}),t.jsx("button",{className:"lightbox-close",onClick:()=>Fe({...nt,open:!1}),children:"âœ•"}),t.jsxs("div",{style:{position:"absolute",bottom:-48,left:"50%",transform:"translateX(-50%)",display:"flex",gap:8},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>sr(e=>Math.max(.25,e-.25)),children:"-"}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>sr(1),children:"100%"}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>sr(e=>Math.min(4,e+.25)),children:"+"})]})]})}),Hr.open&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>$t({open:!1,messageId:null}),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:e=>e.stopPropagation(),children:[t.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"}),t.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(W.data||[]).map(e=>{const n=e.conversation,s=n.participants.filter(i=>ve?i.user.id!==ve:!0).map(i=>i.user).map(i=>i.displayName??i.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",o=n.title??s;return t.jsx("div",{className:"tile",onClick:async()=>{const i=Hr.messageId,d=(Ee||[]).find(h=>h.id===i);d&&(await ys(n,{type:"TEXT",content:`â†ª ${d.content??""}`,replyToId:void 0}),$t({open:!1,messageId:null}))},children:t.jsx("div",{style:{fontWeight:600},children:o})},n.id)})}),t.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:t.jsx("button",{className:"btn btn-secondary",onClick:()=>$t({open:!1,messageId:null}),children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})})]})}),Un&&j&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:ht,children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:ht,children:t.jsx(Me,{size:18})})]}),t.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Ð˜Ð· Ð´Ñ€ÑƒÐ·ÐµÐ¹"},{key:"eblid",label:"ÐŸÐ¾ EBLID"}].map(e=>{const n=$e===e.key;return t.jsx("button",{className:"btn btn-ghost",onClick:()=>Bn(e.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:e.label},e.key)})}),t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:$e==="friends"?"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ Ð² ÑÑ‚Ñƒ Ð±ÐµÑÐµÐ´Ñƒ.":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ EBLID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±ÐµÑÐµÐ´Ñƒ."}),$e==="friends"?t.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:ks.length===0?t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ."}):ks.map(e=>{const n=e.friend,r=Kt.includes(n.id);return t.jsxs("div",{className:"tile",onClick:()=>Hn(s=>r?s.filter(o=>o!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[t.jsx(se,{name:n.displayName??n.username,id:n.id,presence:n.status,avatarUrl:n.avatarUrl??void 0}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:n.status==="ONLINE"?"ÐžÐÐ›ÐÐ™Ð":n.status==="BACKGROUND"?"Ð’ Ð¤ÐžÐÐ•":gr(n)})]}),t.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},e.id)})}):t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(e=>t.jsx("input",{ref:qt[e],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:Or[e],onChange:n=>Di(e,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},e))}),ni&&t.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñâ€¦"}),ie&&t.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[t.jsx(se,{name:ie.displayName??ie.username,id:ie.id,presence:ie.status,avatarUrl:ie.avatarUrl??void 0}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{style:{fontWeight:600},children:ie.displayName??ie.username}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:In.alreadyInChat?"Ð£Ð¶Ðµ Ð² Ð±ÐµÑÐµÐ´Ðµ":In.isSelf?"Ð­Ñ‚Ð¾ Ð²Ñ‹":"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]})]}),!ie&&Wr&&t.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:Wr})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[t.jsx("button",{className:"btn btn-secondary",onClick:ht,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:Pr||($e==="friends"?Kt.length===0:!ie||In.alreadyInChat||In.isSelf),onClick:$e==="friends"?Mi:Li,children:Pr?"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ...":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]})}),ne.open&&ne.conversationId&&t.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Yt({open:!1,x:0,y:0,conversationId:null}),children:t.jsx("div",{ref:zr,className:"msg-menu",style:{position:"absolute",left:ne.x,top:ne.y},onClick:e=>e.stopPropagation(),children:(()=>{const n=(W.data||[]).find(o=>o.conversation.id===ne.conversationId)?.conversation||(a===ne.conversationId?j:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),s=async()=>{try{r?await H.delete(`/conversations/${ne.conversationId}/participants/me`):await H.delete(`/conversations/${ne.conversationId}`),T.invalidateQueries({queryKey:["conversations"]}),a===ne.conversationId&&(l(null),R&&ke("list"))}catch{}Yt({open:!1,x:0,y:0,conversationId:null})};return t.jsxs("button",{onClick:s,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?t.jsx(Xs,{size:16}):t.jsx(Va,{size:16}),r?"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ"]})})()})}),ti&&j&&t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>Gt(!1),children:t.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[t.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),t.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Gt(!1),children:t.jsx(Me,{size:18})})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[t.jsx(se,{name:j.title?.trim()?.charAt(0)||"Ð“",id:j.id,avatarUrl:xe??j.avatarUrl??void 0,size:60}),t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:j.title||"Ð“Ñ€ÑƒÐ¿Ð¿Ð°"}),t.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),t.jsx("input",{ref:Jr,type:"file",accept:"image/*",onChange:e=>{const n=e.target.files?.[0];if(n){mn(n);try{pn(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!xe&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{onClick:()=>Jr.current?.click(),onDragOver:e=>{e.preventDefault(),nr(!0)},onDragLeave:()=>nr(!1),onDrop:e=>{e.preventDefault(),nr(!1);const n=e.dataTransfer.files?.[0];if(n){mn(n);try{pn(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Zr?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Zr?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[t.jsx(wr,{size:18,color:"var(--text-muted)"}),t.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),xe&&t.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[t.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),t.jsxs("div",{ref:We,onWheel:e=>{e.preventDefault();const n=-e.deltaY*.001,r=Math.max(.1,Math.min(10,G.scale*(1+n))),s=We.current?.getBoundingClientRect();if(s){const o=e.clientX-s.left,i=e.clientY-s.top,d=r/G.scale,h=o-(o-G.x)*d,u=i-(i-G.y)*d;Ie({x:h,y:u,scale:r})}},onPointerDown:e=>{if(e.pointerType==="touch")return;const n=We.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,o=r/2,i=s/2,h=240/2,u=e.clientX-n.left,p=e.clientY-n.top,x=u-o,m=p-i;if(x*x+m*m>h*h)return;try{e.currentTarget.setPointerCapture?.(e.pointerId)}catch{}const g=e.clientX,I=e.clientY,b={...G},E=S=>{S.preventDefault();const M=S.clientX-g,N=S.clientY-I;Ie({...b,x:b.x+M,y:b.y+N})},D=()=>{window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",D)};window.addEventListener("pointermove",E,{passive:!1}),window.addEventListener("pointerup",D,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[t.jsx("img",{ref:fn,src:xe,alt:"preview",style:{position:"absolute",left:G.x,top:G.y,transform:`scale(${G.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:e=>{const n=e.currentTarget,r=We.current;if(!r)return;const s=r.clientWidth,o=r.clientHeight,i=240,d=n.naturalWidth,h=n.naturalHeight,u=s/2,p=o/2,x=i/d,m=i/h,g=Math.max(x,m)*1.2,I=u-d*g/2,b=p-h*g/2;Ie({x:I,y:b,scale:g})}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),t.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),t.jsxs("div",{style:{marginTop:16},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[t.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),t.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(G.scale*100),"%"]})]}),t.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ie(e=>({...e,scale:Math.max(.1,e.scale-.1)})),children:"âˆ’"}),t.jsx("input",{type:"range",min:.1,max:10,step:.01,value:G.scale,onChange:e=>{const n=parseFloat(e.target.value);Ie(r=>{const s=We.current?.getBoundingClientRect();if(!s)return{...r,scale:n};const o=s.width,i=s.height,d=o/2,h=i/2,u=fn.current;if(u){const p=u.naturalWidth,x=u.naturalHeight,m=r.x+p*r.scale/2,g=r.y+x*r.scale/2,I=m-d,b=g-h,E=n/r.scale,D=d+I*E,S=h+b*E,M=D-p*n/2,N=S-x*n/2;return{x:M,y:N,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),t.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Ie(e=>({...e,scale:Math.min(10,e.scale+.1)})),children:"+"})]})]}),t.jsx("canvas",{ref:hn,width:240,height:240,style:{display:"none"}})]}),gn&&t.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[t.jsx("button",{className:"btn btn-secondary",onClick:()=>{mn(null),xe&&URL.revokeObjectURL(xe),pn(null),Ie({x:0,y:0,scale:1})},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),t.jsx("button",{className:"btn btn-primary",disabled:ot,onClick:async()=>{if(!(!gn||!j)){on(!0),un(0);try{let e=null;if(hn.current&&xe){const s=await new Promise(b=>{const E=new Image;E.onload=()=>b(E),E.src=xe}),o=hn.current.getContext("2d");if(!o)throw new Error("Could not get 2d context from canvas");const i=240;o.clearRect(0,0,i,i),o.save(),o.beginPath(),o.arc(i/2,i/2,i/2,0,Math.PI*2),o.closePath(),o.clip();const d=We.current?.clientWidth??320,h=We.current?.clientHeight??320,u={x:d/2,y:h/2},p={x:u.x-i/2,y:u.y-i/2,w:i,h:i},x=(p.x-G.x)/G.scale,m=(p.y-G.y)/G.scale,g=p.w/G.scale,I=p.h/G.scale;o.drawImage(s,x,m,g,I,0,0,i,i),o.restore(),e=await new Promise(b=>hn.current.toBlob(E=>b(E),"image/png"))}if(!e&&!gn)throw new Error("No file to upload");const n=new FormData;n.append("file",e??gn);const r=await new Promise((s,o)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const d=vt.getState().session?.accessToken;d&&i.setRequestHeader("Authorization",`Bearer ${d}`)}catch{}i.upload.onprogress=d=>{d.lengthComputable&&un(Math.round(100*d.loaded/d.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const d=JSON.parse(i.responseText);s(d.url)}catch(d){o(d)}else o(new Error(`upload failed: ${i.status} ${i.statusText}`))},i.onerror=()=>{o(new Error("Network error during upload"))},i.send(n)});await H.patch(`/conversations/${j.id}`,{avatarUrl:r}),T.setQueryData(["conversations"],s=>Array.isArray(s)?s.map(o=>o.conversation?.id===j.id?{...o,conversation:{...o.conversation,avatarUrl:r}}:o):s),T.invalidateQueries({queryKey:["conversations"]}),await W.refetch(),mn(null),xe&&URL.revokeObjectURL(xe),pn(null),Ie({x:0,y:0,scale:1}),Gt(!1),ct("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ct(null),2200)}catch(e){console.error("Error uploading group avatar:",e),ct(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${e instanceof Error?e.message:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}`),setTimeout(()=>ct(null),3e3)}finally{on(!1)}}},children:ot?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),ot&&t.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:t.jsx("div",{style:{width:`${Vr}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),yn&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[t.jsx(Fs,{size:16}),t.jsx("span",{children:yn})]})]})})]})}function Vs(a){return(a??[]).map(l=>l.user.id).sort().join(",")}export{Bo as default};
