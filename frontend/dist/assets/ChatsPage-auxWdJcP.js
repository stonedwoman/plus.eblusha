const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-CIEgrZ6s.js","assets/vendor-query-CNP5Hy5J.js","assets/vendor-react-BcTlWpV0.js","assets/index-DFPrICts.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-GGjuBpPe.js","assets/index-D79T7-hc.css","assets/index-BRAGuiMP.js","assets/index-DcBnOcQS.css","assets/ProfileOverlay-DV3fK1pB.js"])))=>i.map(i=>d[i]);
import{e as kr,f as Ho,g as Mr,h as Ea,n as wn,d as J,i as Wo,_ as Va,s as _e,u as ir,j as Bo,k as Aa,o as _o,l as Oo,m as Ta,p as Na,q as Da,t as Fo,v as $o,w as Xo,x as Yo,y as Go,z as qo,A as Ko,B as Vo,D as Qo,E as Jo,F as Zo,G as ec,H as tc,I as nc,J as rc,K as sc,L as Kr,M as La,P as ic,Q as ac,R as oc,S as cc,T as lc,U as za}from"./index-DFPrICts.js";import{r as o,j as e,c as Cr,d as dc}from"./vendor-query-CNP5Hy5J.js";import{c as De,X as Lt,e as Pa,a as Ei,A as qe,C as uc,L as xi,T as Ua,U as Ha,P as fc,b as vi}from"./ProfileOverlay-DV3fK1pB.js";import"./vendor-react-BcTlWpV0.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-GGjuBpPe.js";const hc=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],pc=De("arrow-left",hc);const gc=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],mc=De("bell-ring",gc);const yc=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],xc=De("check",yc);const vc=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],bc=De("chevron-left",vc);const wc=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],jc=De("chevron-right",wc);const Cc=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Wa=De("circle-check-big",Cc);const Sc=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],Ic=De("circle-plus",Sc);const kc=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],bi=De("cloud-upload",kc);const Mc=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],Sr=De("ellipsis-vertical",Mc);const Rc=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],Ec=De("lock-open",Rc);const Ac=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],wi=De("log-out",Ac);const Tc=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Ba=De("maximize-2",Tc);const Nc=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Dc=De("mic",Nc);const Lc=[["path",{d:"M5 12h14",key:"1ays0h"}]],zc=De("minus",Lc);const Pc=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],Uc=De("paperclip",Pc);const Hc=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],ji=De("phone-off",Hc);const Wc=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Bc=De("reply",Wc);const _c=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],_a=De("rotate-ccw",_c);const Oc=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Oa=De("send",Oc);const Fc=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Fa=De("square-pen",Fc);const $c=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Xc=De("square",$c);const Yc=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],$a=De("undo-2",Yc);const Gc=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],qc=De("users",Gc);const Kc=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],Ci=De("video",Kc),Si=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],Ii=[4,8,14],qt=24,ln=80;function Vc({open:c,image:u,onClose:f,onApply:b}){const[C,I]=o.useState(null),[v,L]=o.useState({width:0,height:0}),[Z,N]=o.useState(1),[G,F]=o.useState({x:0,y:0}),[ne,ge]=o.useState({width:0,height:0}),[z,re]=o.useState({x:0,y:0,width:0,height:0}),[$,ye]=o.useState("crop"),[Re,jt]=o.useState(Si[0]),[be,Oe]=o.useState(Ii[1]),[fe,He]=o.useState([]),[Le,ze]=o.useState(null),[zt,Ct]=o.useState(()=>typeof window<"u"&&window.innerWidth<=768),[we,nt]=o.useState(!1),rt=o.useRef(null),ft=o.useRef(null),Ee=o.useRef(null),K=o.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),Ae=o.useRef(null),Xt=o.useRef(null),Kt=o.useRef(null),ht=c&&!!u&&!!C&&v.width>0&&v.height>0;o.useEffect(()=>{const g=()=>Ct(window.innerWidth<=768);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[]);const St=async()=>{if(!C||!Ee.current||we)return;nt(!0);const g=z.width/z.height,D=Math.max(z.x,G.x),R=Math.max(z.y,G.y),Y=Math.min(z.x+z.width,G.x+ne.width),A=Math.min(z.y+z.height,G.y+ne.height),V=Y-D,ee=A-R,_=C.naturalWidth/ne.width,je=C.naturalHeight/ne.height;let he=(D-G.x)*_,Ce=(R-G.y)*je,Te=V*_,We=ee*je;Te/We>g?Te=We*g:We=Te/g;const It=C.naturalWidth,Pt=C.naturalHeight;let kt=Math.max(0,he),fn=Math.max(0,Ce),it=Math.max(1,Math.min(Te,It-kt)),at=Math.max(1,Math.min(We,Pt-fn));const M=it/at;Math.abs(M-g)>.01&&(M>g?it=at*g:at=it/g,it=Math.max(1,Math.min(it,It-kt)),at=Math.max(1,Math.min(at,Pt-fn)));const Qt=document.createElement("canvas"),pt=Math.max(1,Math.round(it)),At=Math.max(1,Math.round(at));Qt.width=pt,Qt.height=At;const pe=Qt.getContext("2d");if(!pe){nt(!1);return}pe.drawImage(C,kt,fn,it,at,0,0,pt,At);const Jt=pt/V,Tt=At/ee;pe.lineCap="round",pe.lineJoin="round";const Cn=[...fe,...Le?[Le]:[]];for(const Ve of Cn){if(!Ve.points.length)continue;pe.strokeStyle=Ve.color,pe.lineWidth=Ve.size*((Jt+Tt)/2),pe.beginPath();const Ge=Ve.points[0],Fe=(Ge.x-D)*Jt,Ie=(Ge.y-R)*Tt;pe.moveTo(Fe,Ie);for(let vt=1;vt<Ve.points.length;vt++){const bt=Ve.points[vt];pe.lineTo((bt.x-D)*Jt,(bt.y-R)*Tt)}pe.stroke()}const xt=new Image;xt.src=Qt.toDataURL(),await new Promise(Ve=>{xt.onload=()=>{I(xt);const Ge=xt.naturalWidth/xt.naturalHeight;let Fe,Ie;if(zt){const wt=window.innerWidth,Ut=window.innerHeight-200-60,In=wt;Ge>In/Ut?(Fe=In,Ie=In/Ge):(Ie=Ut,Fe=Ut*Ge)}else{const wt=Math.min(window.innerWidth-64,720),ot=Math.min(window.innerHeight-200,520);Ge>wt/ot?(Fe=Math.max(280,wt),Ie=Fe/Ge):(Ie=Math.max(220,ot),Fe=Ie*Ge)}L({width:Fe,height:Ie});const vt=Fe/xt.naturalWidth;N(vt),ge({width:Fe,height:Ie}),F({x:0,y:0});const bt=2,Sn=Math.max(ln,Fe-bt*2),hn=Math.max(ln,Ie-bt*2);re({x:bt,y:bt,width:Sn,height:hn});const or=Fe/pt,es=Ie/At,_n=Cn.map(wt=>({...wt,points:wt.points.map(ot=>{const lr=(ot.x-D)*Jt,On=(ot.y-R)*Tt,Ut=lr*or,In=On*es;return{x:Ut,y:In}})}));He(_n.filter(wt=>wt.points.every(ot=>ot.x>=0&&ot.x<=Fe&&ot.y>=0&&ot.y<=Ie))),ze(null),setTimeout(()=>{U()},0);const ts=performance.now(),cr=300,Er=wt=>{const ot=wt-ts;Math.min(ot/cr,1)<1?Kt.current=requestAnimationFrame(Er):(nt(!1),Kt.current=null,setTimeout(()=>{U()},0))};Kt.current=requestAnimationFrame(Er),Ve()}})};o.useEffect(()=>()=>{Kt.current&&cancelAnimationFrame(Kt.current)},[]),o.useEffect(()=>{if(!c||!u){I(null),He([]),ze(null),nt(!1);return}const g=new Image;return g.crossOrigin="anonymous",g.onload=()=>{if(I(g),zt){const D=window.innerWidth,V=window.innerHeight-200-60,ee=D;let _=g.naturalWidth,je=g.naturalHeight;const he=ee/_,Ce=V/je,Te=Math.min(he,Ce);_=g.naturalWidth*Te,je=g.naturalHeight*Te,L({width:ee,height:V}),N(Te),ge({width:_,height:je});const We={x:(ee-_)/2,y:(V-je)/2};F(We);const Yt=2;re({x:Yt,y:Yt,width:ee-Yt*2,height:V-Yt*2})}else{const D=Math.min(window.innerWidth-64,720),R=Math.min(window.innerHeight-200,520);let Y=g.naturalWidth,A=g.naturalHeight;if(Y>D){const Ce=D/Y;Y*=Ce,A*=Ce}if(A>R){const Ce=R/A;Y*=Ce,A*=Ce}Y=Math.max(280,Y),A=Math.max(220,A),L({width:Y,height:A});const V=Math.max(Y/g.naturalWidth,A/g.naturalHeight);N(V);const ee=g.naturalWidth*V,_=g.naturalHeight*V;ge({width:ee,height:_});const je={x:(Y-ee)/2,y:(A-_)/2};F(je);const he=2;re({x:he,y:he,width:Y-he*2,height:A-he*2})}He([]),ze(null),ye("crop"),nt(!1)},g.src=u.previewUrl,Xt.current=()=>{g.src=""},()=>{Xt.current?.(),Xt.current=null}},[c,u?.id,u?.previewUrl,zt]),o.useEffect(()=>{c||(He([]),ze(null),nt(!1))},[c]);const U=()=>{const g=ft.current;if(!g||v.width===0||v.height===0)return;const D=g.getContext("2d");if(!D)return;const R=window.devicePixelRatio||1;(g.width!==v.width*R||g.height!==v.height*R)&&(g.width=v.width*R,g.height=v.height*R,g.style.width=`${v.width}px`,g.style.height=`${v.height}px`),D.save(),D.scale(R,R),D.clearRect(0,0,v.width,v.height);const Y=Le?[...fe,Le]:fe;D.lineCap="round",D.lineJoin="round";for(const A of Y)if(A.points.length!==0){D.strokeStyle=A.color,D.lineWidth=A.size,D.beginPath(),D.moveTo(A.points[0].x,A.points[0].y);for(let V=1;V<A.points.length;V++)D.lineTo(A.points[V].x,A.points[V].y);D.stroke()}D.restore()};o.useEffect(()=>{U()},[fe,Le,v.width,v.height]),o.useEffect(()=>{const g=D=>{c&&D.key==="Escape"&&(D.preventDefault(),f())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[c,f]);const E=(g,D,R)=>{const A=qt/2;return Math.abs(g-R.x)<A&&Math.abs(D-R.y)<A?"nw":Math.abs(g-(R.x+R.width))<A&&Math.abs(D-R.y)<A?"ne":Math.abs(g-R.x)<A&&Math.abs(D-(R.y+R.height))<A?"sw":Math.abs(g-(R.x+R.width))<A&&Math.abs(D-(R.y+R.height))<A?"se":Math.abs(g-R.x)<A&&D>=R.y&&D<=R.y+R.height?"w":Math.abs(g-(R.x+R.width))<A&&D>=R.y&&D<=R.y+R.height?"e":Math.abs(D-R.y)<A&&g>=R.x&&g<=R.x+R.width?"n":Math.abs(D-(R.y+R.height))<A&&g>=R.x&&g<=R.x+R.width?"s":g>=R.x&&g<=R.x+R.width&&D>=R.y&&D<=R.y+R.height?"move":null},ie=g=>{const V=v.width-2,ee=v.height-2,_=Math.max(2,Math.min(V-g.width,g.x)),je=Math.max(2,Math.min(ee-g.height,g.y)),he=Math.max(ln,Math.min(V-_,g.width)),Ce=Math.max(ln,Math.min(ee-je,g.height));return{x:_,y:je,width:he,height:Ce}},ue=g=>{if($!=="crop"||we||!rt.current)return;g.preventDefault();const D=rt.current.getBoundingClientRect(),R=g.clientX-D.left,Y=g.clientY-D.top,A=E(R,Y,z);A&&(rt.current.setPointerCapture(g.pointerId),K.current={type:A==="move"?"move":"resize",handle:A!=="move"?A:void 0,startX:g.clientX,startY:g.clientY,initial:{...z}})},xe=g=>{if($!=="crop"||!K.current.type||we||(g.preventDefault(),!rt.current?.getBoundingClientRect()))return;const R=g.clientX-K.current.startX,Y=g.clientY-K.current.startY,A=R,V=Y;if(K.current.type==="move"){const ee={x:K.current.initial.x+A,y:K.current.initial.y+V,width:K.current.initial.width,height:K.current.initial.height};re(ie(ee))}else if(K.current.type==="resize"&&K.current.handle){const ee=K.current.handle;let _={...K.current.initial};ee==="nw"?(_.x=K.current.initial.x+A,_.y=K.current.initial.y+V,_.width=K.current.initial.width-A,_.height=K.current.initial.height-V):ee==="ne"?(_.y=K.current.initial.y+V,_.width=K.current.initial.width+A,_.height=K.current.initial.height-V):ee==="sw"?(_.x=K.current.initial.x+A,_.width=K.current.initial.width-A,_.height=K.current.initial.height+V):ee==="se"?(_.width=K.current.initial.width+A,_.height=K.current.initial.height+V):ee==="n"?(_.y=K.current.initial.y+V,_.height=K.current.initial.height-V):ee==="s"?_.height=K.current.initial.height+V:ee==="w"?(_.x=K.current.initial.x+A,_.width=K.current.initial.width-A):ee==="e"&&(_.width=K.current.initial.width+A),_.width<ln&&((ee==="nw"||ee==="w"||ee==="sw")&&(_.x=K.current.initial.x+K.current.initial.width-ln),_.width=ln),_.height<ln&&((ee==="nw"||ee==="n"||ee==="ne")&&(_.y=K.current.initial.y+K.current.initial.height-ln),_.height=ln),re(ie(_))}},Se=async g=>{const D=K.current.type!==null;K.current.type&&rt.current?.hasPointerCapture(g.pointerId)&&rt.current.releasePointerCapture(g.pointerId),K.current.type=null,D&&$==="crop"&&!we&&await St()},Ye=g=>{if($!=="draw"||!ft.current||we)return;g.preventDefault();const D=ft.current.getBoundingClientRect(),R={x:g.clientX-D.left,y:g.clientY-D.top},Y={color:Re,size:be,points:[R]};Ae.current=g.pointerId,ft.current.setPointerCapture(g.pointerId),ze(Y)},Ke=g=>{if($!=="draw"||Ae.current!==g.pointerId||!ft.current)return;g.preventDefault();const D=ft.current.getBoundingClientRect(),R={x:g.clientX-D.left,y:g.clientY-D.top};ze(Y=>!Y||Y.points.length&&Y.points[Y.points.length-1].x===R.x&&Y.points[Y.points.length-1].y===R.y?Y:{...Y,points:[...Y.points,R]})},st=g=>{$!=="draw"||Ae.current!==g.pointerId||(Ae.current=null,ft.current?.hasPointerCapture(g.pointerId)&&ft.current.releasePointerCapture(g.pointerId),ze(D=>{if(!D)return null;if(D.points.length<2){const R={...D,points:[...D.points,D.points[0]]};He(Y=>[...Y,R])}else He(R=>[...R,D]);return null}))},Vt=()=>{He(g=>g.slice(0,-1))},Wn=()=>{He([]),ze(null)},Rr=async()=>{if(!C||we)return;const g=new Image;g.crossOrigin="anonymous",await new Promise(D=>{g.onload=()=>{if(I(g),zt){const R=window.innerWidth,ee=window.innerHeight-200-60,_=R;let je=g.naturalWidth,he=g.naturalHeight;const Ce=_/je,Te=ee/he,We=Math.min(Ce,Te),Yt=je*We,It=he*We;L({width:_,height:ee}),N(We),ge({width:Yt,height:It});const Pt={x:(_-Yt)/2,y:(ee-It)/2};F(Pt);const kt=2;re({x:kt,y:kt,width:_-kt*2,height:ee-kt*2})}else{const R=Math.min(window.innerWidth-64,720),Y=Math.min(window.innerHeight-200,520);let A=g.naturalWidth,V=g.naturalHeight;if(A>R){const Te=R/A;A*=Te,V*=Te}if(V>Y){const Te=Y/V;A*=Te,V*=Te}A=Math.max(280,A),V=Math.max(220,V),L({width:A,height:V});const ee=Math.max(A/g.naturalWidth,V/g.naturalHeight);N(ee);const _=g.naturalWidth*ee,je=g.naturalHeight*ee;ge({width:_,height:je});const he={x:(A-_)/2,y:(V-je)/2};F(he);const Ce=2;re({x:Ce,y:Ce,width:A-Ce*2,height:V-Ce*2})}He([]),ze(null),D()},g.src=u.previewUrl})},Bn=async()=>{if(!u||!C)return;const g=z.width/z.height,D=Math.max(z.x,G.x),R=Math.max(z.y,G.y),Y=Math.min(z.x+z.width,G.x+ne.width),A=Math.min(z.y+z.height,G.y+ne.height),V=Y-D,ee=A-R,_=C.naturalWidth/ne.width,je=C.naturalHeight/ne.height,he=(D-G.x)*_,Ce=(R-G.y)*je;let Te=V*_,We=ee*je;Te/We>g?Te=We*g:We=Te/g;const It=C.naturalWidth,Pt=C.naturalHeight;let kt=Math.max(0,he),fn=Math.max(0,Ce),it=Math.max(1,Math.min(Te,It-kt)),at=Math.max(1,Math.min(We,Pt-fn));const M=it/at;Math.abs(M-g)>.01&&(M>g?it=at*g:at=it/g,it=Math.max(1,Math.min(it,It-kt)),at=Math.max(1,Math.min(at,Pt-fn)));const Qt=Math.max(1,Math.round(it)),pt=Math.max(1,Math.round(at)),At=document.createElement("canvas");At.width=Qt,At.height=pt;const pe=At.getContext("2d");if(!pe)return;pe.drawImage(C,kt,fn,it,at,0,0,Qt,pt);const Jt=Qt/V,Tt=pt/ee,Cn=[...fe,...Le?[Le]:[]];pe.lineCap="round",pe.lineJoin="round";for(const Ie of Cn){if(!Ie.points.length)continue;pe.strokeStyle=Ie.color,pe.lineWidth=Ie.size*((Jt+Tt)/2),pe.beginPath();const vt=Ie.points[0],bt=(vt.x-D)*Jt,Sn=(vt.y-R)*Tt;pe.moveTo(bt,Sn);for(let hn=1;hn<Ie.points.length;hn++){const or=Ie.points[hn];pe.lineTo((or.x-D)*Jt,(or.y-R)*Tt)}pe.stroke()}const xt=await new Promise(Ie=>At.toBlob(vt=>Ie(vt),"image/png",.96));if(!xt)return;const Ve=u.fileName?.replace(/\.[^.]+$/,"")||u.file.name.replace(/\.[^.]+$/,"")||"image",Ge=new File([xt],`${Ve}-edited.png`,{type:"image/png"}),Fe=URL.createObjectURL(xt);b({file:Ge,previewUrl:Fe})},ar=()=>{if($!=="crop"||we)return null;const{x:g,y:D,width:R,height:Y}=z,A={position:"absolute",width:qt,height:qt,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{...A,left:g-qt/2,top:D-qt/2,cursor:"nwse-resize"}}),e.jsx("div",{style:{...A,left:g+R-qt/2,top:D-qt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...A,left:g-qt/2,top:D+Y-qt/2,cursor:"nesw-resize"}}),e.jsx("div",{style:{...A,left:g+R-qt/2,top:D+Y-qt/2,cursor:"nwse-resize"}})]})};if(!c||!u)return null;if(zt)return kr.createPortal(e.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[e.jsx("button",{onClick:f,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"}),e.jsx("button",{onClick:Bn,disabled:!ht||we,style:{background:!ht||we?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:ht&&!we?"pointer":"not-allowed"},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]}),e.jsxs("div",{ref:rt,onPointerDown:ue,onPointerMove:xe,onPointerUp:Se,onPointerLeave:Se,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[C&&e.jsx("img",{src:C.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:G.x,top:G.y,width:ne.width,height:ne.height,userSelect:"none",pointerEvents:"none",transition:we?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ft,style:{position:"absolute",inset:0,pointerEvents:$==="draw"?"auto":"none"},onPointerDown:Ye,onPointerMove:Ke,onPointerUp:st,onPointerLeave:st}),e.jsx("canvas",{ref:Ee,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),$==="crop"&&!we&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${z.x}px 100%,
                    ${z.x}px ${z.y}px,
                    ${z.x+z.width}px ${z.y}px,
                    ${z.x+z.width}px ${z.y+z.height}px,
                    ${z.x}px ${z.y+z.height}px,
                    ${z.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:z.x,top:z.y,width:z.width,height:z.height,border:"2px solid #fff",pointerEvents:"none"}}),ar()]})]}),e.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>ye("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:$==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{onClick:()=>ye("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:$==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[e.jsx(Fa,{size:18}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]})]}),e.jsxs("button",{onClick:Rr,disabled:we,style:{padding:"10px",borderRadius:10,border:"none",background:we?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:we?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:we?"not-allowed":"pointer"},children:[e.jsx(_a,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),$==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:Si.map(g=>e.jsx("button",{onClick:()=>jt(g),style:{width:40,height:40,borderRadius:"50%",border:Re===g?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:g,cursor:"pointer",flexShrink:0},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:Ii.map(g=>e.jsx("button",{onClick:()=>Oe(g),style:{width:48,height:48,borderRadius:12,border:be===g?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:be===g?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Re,display:"inline-block"}})},g))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{onClick:Vt,disabled:fe.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:fe.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:fe.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:fe.length===0?"not-allowed":"pointer"},children:[e.jsx($a,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"]}),e.jsx("button",{onClick:Wn,disabled:fe.length===0&&!Le,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:fe.length===0&&!Le?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:fe.length===0&&!Le?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:fe.length===0&&!Le?"not-allowed":"pointer"},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ"})]})]})]})]}),document.body);const Zr=e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:e.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ",e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:u.fileName||u.file.name})]}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:f,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{ref:rt,onPointerDown:ue,onPointerMove:xe,onPointerUp:Se,onPointerLeave:Se,style:{position:"relative",width:v.width,height:v.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:$==="crop"?"default":"crosshair"},children:[C&&e.jsx("img",{src:C.src,draggable:!1,alt:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",style:{position:"absolute",left:G.x,top:G.y,width:ne.width,height:ne.height,userSelect:"none",pointerEvents:"none",transition:we?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),e.jsx("canvas",{ref:ft,style:{position:"absolute",inset:0,pointerEvents:$==="draw"?"auto":"none"},onPointerDown:Ye,onPointerMove:Ke,onPointerUp:st,onPointerLeave:st}),e.jsx("canvas",{ref:Ee,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),$==="crop"&&!we&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${z.x}px 100%,
                    ${z.x}px ${z.y}px,
                    ${z.x+z.width}px ${z.y}px,
                    ${z.x+z.width}px ${z.y+z.height}px,
                    ${z.x}px ${z.y+z.height}px,
                    ${z.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),e.jsx("div",{style:{position:"absolute",left:z.x,top:z.y,width:z.width,height:z.height,border:"2px solid #fff",pointerEvents:"none"}}),ar()]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:$==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>ye("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÐ±Ñ€ÐµÐ·Ð°Ñ‚ÑŒ"}),e.jsxs("button",{className:$==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>ye("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Fa,{size:16}),"Ð Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ"]}),e.jsxs("button",{className:"btn btn-ghost",onClick:Rr,disabled:we,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(_a,{size:16}),"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),$==="draw"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-ghost",onClick:Vt,disabled:fe.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx($a,{size:16}),"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…"]}),e.jsx("button",{className:"btn btn-ghost",onClick:Wn,disabled:fe.length===0&&!Le,style:{display:"inline-flex",alignItems:"center",gap:6},children:"ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº"})]})]}),$==="draw"&&e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¦Ð²ÐµÑ‚ ÐºÐ¸ÑÑ‚Ð¸"}),e.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:Si.map(g=>e.jsx("button",{onClick:()=>jt(g),style:{width:28,height:28,borderRadius:"50%",border:Re===g?"2px solid #fff":"2px solid transparent",background:g,cursor:"pointer"},"aria-label":`Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ ${g}`},g))})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð°"}),e.jsx("div",{style:{display:"flex",gap:8},children:Ii.map(g=>e.jsx("button",{onClick:()=>Oe(g),className:be===g?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{width:g,height:g,borderRadius:"50%",background:Re,display:"inline-block"}})},g))})]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[e.jsx("button",{className:"btn btn-ghost",onClick:f,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsxs("button",{className:"btn btn-primary",onClick:Bn,disabled:!ht||we,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[e.jsx(xc,{size:16}),"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"]})]})]})});return kr.createPortal(Zr,document.body)}function jn(c,u,f){return Math.min(f,Math.max(u,c))}function Qc({open:c,items:u,index:f,onClose:b,onIndexChange:C}){const I=o.useRef(null),v=o.useRef(null),[L,Z]=o.useState({}),[N,G]=o.useState({w:0,h:0}),[F,ne]=o.useState(1),[ge,z]=o.useState(0),[re,$]=o.useState(0),ye=o.useRef(null),Re=o.useRef(null),jt=o.useRef(0),be=o.useRef(0),Oe=o.useRef(null),fe=u.length,He=fe>1,Le=u[f]||"",ze=Le?L[Le]:void 0,zt=o.useMemo(()=>fe<=1?24:N.w<=768?72:Math.max(140,Math.round(N.h*.2)),[fe,N.w,N.h]),Ct=o.useMemo(()=>{if(!ze||!N.w||!N.h)return{scale:1,maxX:0,maxY:0};const U=56,E=zt,ie=28,ue=Math.max(0,N.w-ie*2),xe=Math.max(0,N.h-U-E-ie*2),Ye=Math.min(ue/ze.w,xe/ze.h,1)*F,Ke=ze.w*Ye,st=ze.h*Ye,Vt=Math.max(0,(Ke-ue)/2),Wn=Math.max(0,(st-xe)/2);return{scale:Ye,maxX:Vt,maxY:Wn}},[ze,N.w,N.h,F,zt]),we=()=>{He&&C((f-1+fe)%fe)},nt=()=>{He&&C((f+1)%fe)},rt=()=>{ne(1),z(0),$(0)};o.useEffect(()=>{if(!c)return;const U=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=U}},[c]),o.useLayoutEffect(()=>{if(!c)return;const U=()=>{const E=window.innerWidth,ie=window.innerHeight;G({w:E,h:ie})};return U(),window.addEventListener("resize",U),()=>window.removeEventListener("resize",U)},[c]),o.useEffect(()=>{c&&rt()},[c,Le]),o.useEffect(()=>{if(!c)return;const U=E=>{E.key==="Escape"&&b(),E.key==="ArrowLeft"&&we(),E.key==="ArrowRight"&&nt(),(E.key==="+"||E.key==="=")&&ne(ie=>jn(ie*1.15,1,6)),E.key==="-"&&ne(ie=>jn(ie/1.15,1,6)),E.key==="0"&&rt()};return window.addEventListener("keydown",U),()=>window.removeEventListener("keydown",U)},[c,f,fe,Le,b]),o.useEffect(()=>{c&&(z(U=>jn(U,-Ct.maxX,Ct.maxX)),$(U=>jn(U,-Ct.maxY,Ct.maxY)))},[c,Ct.maxX,Ct.maxY]);const ft=U=>{if(!c)return;U.preventDefault();const E=v.current?.getBoundingClientRect()??null,ie=!!E&&U.clientX>=E.left&&U.clientX<=E.right&&U.clientY>=E.top&&U.clientY<=E.bottom,ue=U.deltaMode===1?U.deltaY*16:U.deltaMode===2?U.deltaY*N.h:U.deltaY;if(!ie){if(!He)return;const Ke=performance.now(),st=260,Vt=90;if(jt.current+=ue,Ke-be.current<st||Math.abs(jt.current)<Vt)return;be.current=Ke;const Wn=jt.current>0?1:-1;jt.current=0,Wn>0?nt():we();return}const Se=Math.exp(-ue*9e-4),Ye=jn(Se,.8,1.25);ne(Ke=>jn(Ke*Ye,1,6))},Ee=U=>{if(U.button!==0)return;U.currentTarget.setPointerCapture(U.pointerId);const E=F>1.01,ie=v.current?.getBoundingClientRect()??null,ue=!!ie&&U.clientX>=ie.left&&U.clientX<=ie.right&&U.clientY>=ie.top&&U.clientY<=ie.bottom;ye.current={active:!0,startX:U.clientX,startY:U.clientY,startTx:ge,startTy:re,mode:E?"pan":"swipe",startedInsideImg:ue}},K=U=>{const E=ye.current;if(!E?.active)return;const ie=U.clientX-E.startX,ue=U.clientY-E.startY;if(E.mode==="pan"){z(jn(E.startTx+ie,-Ct.maxX,Ct.maxX)),$(jn(E.startTy+ue,-Ct.maxY,Ct.maxY));return}},Ae=U=>{const E=ye.current;if(ye.current=null,!E?.active)return;const ie=U.clientX-E.startX,ue=U.clientY-E.startY;if(E.mode==="swipe"){if(Math.abs(ue)>110&&Math.abs(ie)<90){b();return}if(Math.abs(ie)>70&&Math.abs(ue)<60){ie<0?nt():we();return}}const xe=8,Se=Math.abs(ie)<=xe&&Math.abs(ue)<=xe;if(Se&&E.startedInsideImg){const Ye=performance.now(),Ke=Oe.current,st=280,Vt=18;if(Ke&&Ye-Ke.ts<=st&&Math.abs(Ke.x-U.clientX)<=Vt&&Math.abs(Ke.y-U.clientY)<=Vt){Oe.current=null,F<=1.01?ne(2):rt();return}Oe.current={ts:Ye,x:U.clientX,y:U.clientY};return}Se&&!E.startedInsideImg&&(F>1.01?rt():b())},Xt=U=>{if(U.touches.length!==2){Re.current=null;return}U.preventDefault();const E=U.touches[0],ie=U.touches[1],ue=E.clientX-ie.clientX,xe=E.clientY-ie.clientY,Se=Math.sqrt(ue*ue+xe*xe),Ye=Re.current;if(Re.current=Se,!Ye)return;const Ke=Se>Ye?1.03:1/1.03;ne(st=>jn(st*Ke,1,6))},Kt=()=>{F<=1.01?ne(2):rt()};if(!c)return null;const ht=(()=>{if(fe<=13)return u.map((Se,Ye)=>({u:Se,i:Ye}));const E=Math.floor(13/2);let ie=f-E,ue=f+E;if(ie<0&&(ue+=-ie,ie=0),ue>fe-1){const Se=ue-(fe-1);ie=Math.max(0,ie-Se),ue=fe-1}const xe=[];for(let Se=ie;Se<=ue;Se++)xe.push({u:u[Se],i:Se});return xe})(),St=e.jsxs("div",{className:"imglb-root",ref:I,onWheel:ft,style:{"--imglb-thumbs-h":`${zt}px`},children:[e.jsx("div",{className:"imglb-backdrop",onClick:b}),e.jsxs("div",{className:"imglb-topbar",children:[e.jsx("div",{className:"imglb-spacer","aria-hidden":"true"}),e.jsxs("div",{className:"imglb-title",children:[f+1," / ",fe]}),e.jsx("button",{className:"imglb-btn",onClick:b,"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{className:"imglb-stage",onPointerDown:Ee,onPointerMove:K,onPointerUp:Ae,onPointerCancel:()=>{ye.current=null},onTouchMove:Xt,onDoubleClick:Kt,children:[He&&e.jsx("button",{className:"imglb-nav imglb-nav-left",onClick:we,"aria-label":"ÐÐ°Ð·Ð°Ð´",children:e.jsx(bc,{size:24})}),e.jsx("div",{className:"imglb-media",onClick:U=>U.stopPropagation(),children:e.jsx("div",{className:"imglb-pan",style:{transform:`translate3d(${ge}px, ${re}px, 0)`},children:e.jsx("img",{ref:v,className:"imglb-img",src:Le,alt:"preview",draggable:!1,style:{width:ze?.w?`${ze.w}px`:void 0,height:ze?.h?`${ze.h}px`:void 0,transform:`scale(${Ct.scale})`},onLoad:U=>{const E=U.currentTarget,ie=E.naturalWidth||1,ue=E.naturalHeight||1;Z(xe=>({...xe,[Le]:{w:ie,h:ue}}))}})})}),He&&e.jsx("button",{className:"imglb-nav imglb-nav-right",onClick:nt,"aria-label":"Ð’Ð¿ÐµÑ€Ñ‘Ð´",children:e.jsx(jc,{size:24})})]}),fe>1&&e.jsx("div",{className:"imglb-thumbs",onClick:U=>U.stopPropagation(),children:e.jsx("div",{className:"imglb-thumbs-inner",children:ht.map(({u:U,i:E})=>e.jsx("button",{type:"button",className:E===f?"imglb-thumb is-active":"imglb-thumb",onClick:()=>C(E),"aria-label":`ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ${E+1}`,children:e.jsx("img",{src:U,alt:"",draggable:!1})},`${U}-${E}`))})})]});return kr.createPortal(St,document.body)}const Vr=Ho(c=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:u=>c({incoming:u}),startOutgoing:(u,f)=>c({activeConvId:u,incoming:null,initialVideo:!!f,initialAudio:!0}),startIncoming:u=>c({incoming:u}),endCall:()=>c({activeConvId:null,incoming:null,initialVideo:!1})}));function Jc(c){return c instanceof Uint8Array||ArrayBuffer.isView(c)&&c.constructor.name==="Uint8Array"}function Ai(c){if(!Number.isSafeInteger(c)||c<0)throw new Error("positive integer expected, got "+c)}function Os(c,...u){if(!Jc(c))throw new Error("Uint8Array expected");if(u.length>0&&!u.includes(c.length))throw new Error("Uint8Array expected of length "+u+", got length="+c.length)}function Ti(c){if(typeof c!="function"||typeof c.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Ai(c.outputLen),Ai(c.blockLen)}function _s(c,u=!0){if(c.destroyed)throw new Error("Hash instance has been destroyed");if(u&&c.finished)throw new Error("Hash#digest() has already been called")}function Zc(c,u){Os(c);const f=u.outputLen;if(c.length<f)throw new Error("digestInto() expects output buffer of length at least "+f)}function Qr(...c){for(let u=0;u<c.length;u++)c[u].fill(0)}function ki(c){return new DataView(c.buffer,c.byteOffset,c.byteLength)}function dn(c,u){return c<<32-u|c>>>u}function el(c){if(typeof c!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(c))}function Jr(c){return typeof c=="string"&&(c=el(c)),Os(c),c}class Qa{}function tl(c){const u=b=>c().update(Jr(b)).digest(),f=c();return u.outputLen=f.outputLen,u.blockLen=f.blockLen,u.create=()=>c(),u}class Ja extends Qa{constructor(u,f){super(),this.finished=!1,this.destroyed=!1,Ti(u);const b=Jr(f);if(this.iHash=u.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const C=this.blockLen,I=new Uint8Array(C);I.set(b.length>C?u.create().update(b).digest():b);for(let v=0;v<I.length;v++)I[v]^=54;this.iHash.update(I),this.oHash=u.create();for(let v=0;v<I.length;v++)I[v]^=106;this.oHash.update(I),Qr(I)}update(u){return _s(this),this.iHash.update(u),this}digestInto(u){_s(this),Os(u,this.outputLen),this.finished=!0,this.iHash.digestInto(u),this.oHash.update(u),this.oHash.digestInto(u),this.destroy()}digest(){const u=new Uint8Array(this.oHash.outputLen);return this.digestInto(u),u}_cloneInto(u){u||(u=Object.create(Object.getPrototypeOf(this),{}));const{oHash:f,iHash:b,finished:C,destroyed:I,blockLen:v,outputLen:L}=this;return u=u,u.finished=C,u.destroyed=I,u.blockLen=v,u.outputLen=L,u.oHash=f._cloneInto(u.oHash),u.iHash=b._cloneInto(u.iHash),u}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ni=(c,u,f)=>new Ja(c,u).update(f).digest();Ni.create=(c,u)=>new Ja(c,u);function nl(c,u,f){return Ti(c),f===void 0&&(f=new Uint8Array(c.outputLen)),Ni(c,Jr(f),Jr(u))}const Mi=Uint8Array.from([0]),Xa=Uint8Array.of();function rl(c,u,f,b=32){Ti(c),Ai(b);const C=c.outputLen;if(b>255*C)throw new Error("Length should be <= 255*HashLen");const I=Math.ceil(b/C);f===void 0&&(f=Xa);const v=new Uint8Array(I*C),L=Ni.create(c,u),Z=L._cloneInto(),N=new Uint8Array(L.outputLen);for(let G=0;G<I;G++)Mi[0]=G+1,Z.update(G===0?Xa:N).update(f).update(Mi).digestInto(N),v.set(N,C*G),L._cloneInto(Z);return L.destroy(),Z.destroy(),Qr(N,Mi),v.slice(0,b)}const sl=(c,u,f,b,C)=>rl(c,nl(c,u,f),b,C);function il(c,u,f,b){if(typeof c.setBigUint64=="function")return c.setBigUint64(u,f,b);const C=BigInt(32),I=BigInt(4294967295),v=Number(f>>C&I),L=Number(f&I),Z=b?4:0,N=b?0:4;c.setUint32(u+Z,v,b),c.setUint32(u+N,L,b)}function al(c,u,f){return c&u^~c&f}function ol(c,u,f){return c&u^c&f^u&f}class cl extends Qa{constructor(u,f,b,C){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=u,this.outputLen=f,this.padOffset=b,this.isLE=C,this.buffer=new Uint8Array(u),this.view=ki(this.buffer)}update(u){_s(this),u=Jr(u),Os(u);const{view:f,buffer:b,blockLen:C}=this,I=u.length;for(let v=0;v<I;){const L=Math.min(C-this.pos,I-v);if(L===C){const Z=ki(u);for(;C<=I-v;v+=C)this.process(Z,v);continue}b.set(u.subarray(v,v+L),this.pos),this.pos+=L,v+=L,this.pos===C&&(this.process(f,0),this.pos=0)}return this.length+=u.length,this.roundClean(),this}digestInto(u){_s(this),Zc(u,this),this.finished=!0;const{buffer:f,view:b,blockLen:C,isLE:I}=this;let{pos:v}=this;f[v++]=128,Qr(this.buffer.subarray(v)),this.padOffset>C-v&&(this.process(b,0),v=0);for(let F=v;F<C;F++)f[F]=0;il(b,C-8,BigInt(this.length*8),I),this.process(b,0);const L=ki(u),Z=this.outputLen;if(Z%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const N=Z/4,G=this.get();if(N>G.length)throw new Error("_sha2: outputLen bigger than state");for(let F=0;F<N;F++)L.setUint32(4*F,G[F],I)}digest(){const{buffer:u,outputLen:f}=this;this.digestInto(u);const b=u.slice(0,f);return this.destroy(),b}_cloneInto(u){u||(u=new this.constructor),u.set(...this.get());const{blockLen:f,buffer:b,length:C,finished:I,destroyed:v,pos:L}=this;return u.destroyed=v,u.finished=I,u.length=C,u.pos=L,C%f&&u.buffer.set(b),u}clone(){return this._cloneInto()}}const Un=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ll=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Hn=new Uint32Array(64);class dl extends cl{constructor(u=32){super(64,u,8,!1),this.A=Un[0]|0,this.B=Un[1]|0,this.C=Un[2]|0,this.D=Un[3]|0,this.E=Un[4]|0,this.F=Un[5]|0,this.G=Un[6]|0,this.H=Un[7]|0}get(){const{A:u,B:f,C:b,D:C,E:I,F:v,G:L,H:Z}=this;return[u,f,b,C,I,v,L,Z]}set(u,f,b,C,I,v,L,Z){this.A=u|0,this.B=f|0,this.C=b|0,this.D=C|0,this.E=I|0,this.F=v|0,this.G=L|0,this.H=Z|0}process(u,f){for(let F=0;F<16;F++,f+=4)Hn[F]=u.getUint32(f,!1);for(let F=16;F<64;F++){const ne=Hn[F-15],ge=Hn[F-2],z=dn(ne,7)^dn(ne,18)^ne>>>3,re=dn(ge,17)^dn(ge,19)^ge>>>10;Hn[F]=re+Hn[F-7]+z+Hn[F-16]|0}let{A:b,B:C,C:I,D:v,E:L,F:Z,G:N,H:G}=this;for(let F=0;F<64;F++){const ne=dn(L,6)^dn(L,11)^dn(L,25),ge=G+ne+al(L,Z,N)+ll[F]+Hn[F]|0,re=(dn(b,2)^dn(b,13)^dn(b,22))+ol(b,C,I)|0;G=N,N=Z,Z=L,L=v+ge|0,v=I,I=C,C=b,b=ge+re|0}b=b+this.A|0,C=C+this.B|0,I=I+this.C|0,v=v+this.D|0,L=L+this.E|0,Z=Z+this.F|0,N=N+this.G|0,G=G+this.H|0,this.set(b,C,I,v,L,Z,N,G)}roundClean(){Qr(Hn)}destroy(){this.set(0,0,0,0,0,0,0,0),Qr(this.buffer)}}const ul=tl(()=>new dl),fl=ul,hl=new TextEncoder,pl=new TextDecoder;function $t(c){if(!c)return new Uint8Array;const u=c.replace(/-/g,"+").replace(/_/g,"/"),f=u.length%4===0?"":"=".repeat(4-u.length%4),b=atob(u+f),C=b.length,I=new Uint8Array(C);for(let v=0;v<C;v+=1)I[v]=b.charCodeAt(v);return I}function Ir(c){let u="";for(let f=0;f<c.length;f+=1)u+=String.fromCharCode(c[f]);return btoa(u).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function Ya(c){return hl.encode(c)}function gl(c){return pl.decode(c)}const Ga="eb_e2ee_sessions_v1";class ml{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(u){return!!this.sessions[u]}getSession(u){return this.sessions[u]??null}async ensureSession(u){if(!u.isSecret||u.secretStatus!=="ACTIVE")return null;const f=this.sessions[u.id];if(f)return f;const b=Mr(),C=Ea();if(!b||!C||!u.secretInitiatorDeviceId||!u.secretPeerDeviceId||!(u.secretInitiatorDeviceId===b.deviceId))return null;const v=u.secretPeerDeviceId;return v?this.createInitiatorSession(u,b.deviceId,v,C):null}processHandshakes(u,f){if(!u.isSecret||!f||f.length===0)return!1;const b=Mr();if(!b)return!1;let C=!1;for(const I of f){const L=(I?.metadata??{}).e2ee;if(!L||L.kind!=="handshake")continue;const Z=L.payload;if(!Z||Z.recipientDeviceId!==b.deviceId)continue;const N=this.sessions[u.id];if(N&&N.peerDeviceId===Z.initiatorDeviceId&&N.prekeyId===Z.prekeyId)continue;this.handlePeerHandshake(u,Z)&&(C=!0)}return C&&this.bumpVersion(),C}transformMessage(u,f){if(!f)return f;const b=f.metadata??{},C=b.e2ee;if(!C||C.kind!=="ciphertext")return f;const I=this.sessions[u];if(!I)return{...f,content:"ðŸ” Ð—Ð°ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¾",metadata:{...b,e2ee:{...C,decrypted:!1}}};try{const v=$t(I.key),L=$t(C.nonce),Z=$t(f.content||""),N=wn.secretbox.open(Z,L,v);if(!N)throw new Error("Failed to decrypt");return{...f,content:gl(N),metadata:{...b,e2ee:{...C,decrypted:!0}}}}catch(v){return console.warn("Failed to decrypt message",v),{...f,content:"ðŸ” ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸",metadata:{...b,e2ee:{...C,decrypted:!1,error:!0}}}}}async encryptPayload(u,f){const b=await this.ensureSession(u);if(!b)throw new Error("E2EE session is not ready");const C=$t(b.key),I=wn.randomBytes(24),v=Ya(f.content??""),L=wn.secretbox(v,I,C);return{conversationId:u.id,type:f.type,content:Ir(L),replyToId:f.replyToId,metadata:{...f.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:Ir(I)}}}}async encryptBinary(u,f){const b=await this.ensureSession(u);if(!b)throw new Error("E2EE session is not ready");const C=$t(b.key),I=wn.randomBytes(24);return{cipher:wn.secretbox(f,I,C),nonce:Ir(I)}}decryptBinary(u,f,b){const C=this.sessions[u];if(!C)throw new Error("E2EE session is not ready");const I=$t(C.key),v=$t(b);return wn.secretbox.open(f,v,I)}async createInitiatorSession(u,f,b,C){try{const I=await J.post("/devices/prekeys/claim",{deviceId:b}),v=I.data?.identityKey,L=I.data?.prekey;if(!v||!L?.publicKey||!L?.keyId)throw new Error("Invalid prekey response");const Z=wn.scalarMult($t(C.secretKey),$t(L.publicKey)),N=wn.randomBytes(32),G=`eblusha:e2ee:${u.id}:${f}->${b}:${L.keyId}`,F=this.deriveKey(Z,N,G),ne={conversationId:u.id,key:Ir(F),localDeviceId:f,peerDeviceId:b,role:"initiator",prekeyId:L.keyId,hkdfInfo:G,handshakeSalt:Ir(N),createdAt:Date.now()};return this.sessions[u.id]=ne,this.persist(),await this.sendHandshakeMessage(u.id,{version:1,kind:"handshake",conversationId:u.id,initiatorDeviceId:f,recipientDeviceId:b,prekeyId:L.keyId,handshakeSalt:ne.handshakeSalt,hkdfInfo:G,initiatorIdentityKey:C.publicKey,createdAt:Date.now()}),ne}catch(I){return console.error("Failed to initialize E2EE session",I),delete this.sessions[u.id],this.persist(),null}}handlePeerHandshake(u,f){if(!f?.prekeyId||!f?.initiatorIdentityKey||!f.hkdfInfo||!f.handshakeSalt||!Ea())return!1;const C=Mr();if(!C)return!1;const I=Wo(f.prekeyId);if(!I)return console.warn("Missing prekey secret for handshake",f.prekeyId),!1;try{const v=wn.scalarMult($t(I),$t(f.initiatorIdentityKey)),L=this.deriveKey(v,$t(f.handshakeSalt),f.hkdfInfo),Z={conversationId:u.id,key:Ir(L),localDeviceId:C.deviceId,peerDeviceId:f.initiatorDeviceId,role:"peer",prekeyId:f.prekeyId,hkdfInfo:f.hkdfInfo,handshakeSalt:f.handshakeSalt,createdAt:Date.now()};return this.sessions[u.id]=Z,this.persist(),!0}catch(v){return console.error("Failed to handle handshake payload",v),!1}}async sendHandshakeMessage(u,f){await J.post("/conversations/send",{conversationId:u,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:f}}})}deriveKey(u,f,b){return sl(fl,u,f,Ya(b),32)}clearSession(u){this.sessions[u]&&(delete this.sessions[u],this.persist())}load(){try{const u=localStorage.getItem(Ga);u&&(this.sessions=JSON.parse(u))}catch{this.sessions={}}}persist(){try{localStorage.setItem(Ga,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const un=new ml;class yl{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(u={}){this.callbacks=u}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const u={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,u),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const f=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,f.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(f){console.error("Failed to setup audio analysis:",f)}this.mediaRecorder.ondataavailable=f=>{f.data.size>0&&this.audioChunks.push(f.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(f=>f.stop())},this.mediaRecorder.onerror=f=>{const b=new Error("MediaRecorder error");this.callbacks.onError?.(b)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(u){const f=u instanceof Error?u:new Error("Failed to start recording");throw this.callbacks.onError?.(f),f}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(u=>u.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let u=0;const f=50,b=C=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(b));return}if(typeof C=="number"){if(C-u<f){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(b));return}u=C}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(ge){console.warn("Analyser error:",ge);return}let I=0,v=0;for(let ge=0;ge<this.dataArray.length;ge++){const z=Math.abs(this.dataArray[ge]-128);I=Math.max(I,z),v+=z}const L=v/this.dataArray.length,N=(I*.7+L*.3)/128*100,G=Math.min(100,N*2.5),ne=Math.max(15,G);this.callbacks.onAmplitudeUpdate?.(ne),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(b))};this.amplitudeTimer=window.requestAnimationFrame(b)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const u=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const f of u)if(MediaRecorder.isTypeSupported(f))return f;return""}cleanup(){this.cancel()}}async function xl(c,u=60){try{const b=await(await fetch(c)).arrayBuffer(),C=new(window.AudioContext||window.webkitAudioContext),v=(await C.decodeAudioData(b)).getChannelData(0),L=Math.floor(v.length/u),Z=[];for(let N=0;N<u;N++){let G=0,F=0;const ne=N*L,ge=Math.min(ne+L,v.length);for(let ye=ne;ye<ge;ye++){const Re=Math.abs(v[ye]);G+=Re,F=Math.max(F,Re)}const z=G/(ge-ne),re=Math.max(z,F*.7),$=Math.max(20,Math.min(100,re*200));Z.push($)}return C.close(),Z}catch(f){return console.error("Failed to generate waveform:",f),Array(u).fill(0).map(()=>Math.random()*40+30)}}const Ri=new Map;async function vl(c,u=60){const f=`${c}:${u}`;if(Ri.has(f))return Ri.get(f);const b=await xl(c,u);return Ri.set(f,b),b}const bl=o.lazy(()=>Va(()=>import("./CallOverlay-CIEgrZ6s.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(c=>({default:c.CallOverlay}))),wl=()=>Va(()=>import("./CallOverlay-CIEgrZ6s.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),qa="eblusha:last-active-conversation",jl=3e4,Cl=10;function Sl({url:c,duration:u}){const[f,b]=o.useState(!1),[C,I]=o.useState(0),[v,L]=o.useState([]),[Z,N]=o.useState(!0),G=o.useRef(null),F=Ei(c)||c;o.useEffect(()=>{let re=!1;return N(!0),vl(F,60).then($=>{re||(L($),N(!1))}).catch($=>{console.error("Failed to load waveform:",$),re||N(!1)}),()=>{re=!0}},[F]),o.useEffect(()=>{const re=G.current;if(!re)return;const $=()=>I(re.currentTime),ye=()=>{b(!1),I(0)},Re=()=>b(!0),jt=()=>b(!1);return re.addEventListener("timeupdate",$),re.addEventListener("ended",ye),re.addEventListener("play",Re),re.addEventListener("pause",jt),()=>{re.removeEventListener("timeupdate",$),re.removeEventListener("ended",ye),re.removeEventListener("play",Re),re.removeEventListener("pause",jt)}},[]);const ne=()=>{const re=G.current;re&&(f?re.pause():re.play().catch($=>{console.error("Failed to play audio:",$)}))},ge=re=>{const $=Math.floor(re/60),ye=Math.floor(re%60);return`${$}:${ye.toString().padStart(2,"0")}`},z=v.length>0?Math.floor(C/u*v.length):0;return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[e.jsx("audio",{ref:G,src:F,preload:"metadata"}),e.jsx("button",{type:"button",onClick:ne,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":f?"ÐŸÐ°ÑƒÐ·Ð°":"Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸",children:f?e.jsx(Xc,{size:16,fill:"currentColor"}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:e.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[Z?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map((re,$)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${$*.1}s`}},$))}):v.length>0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:v.map((re,$)=>{const ye=$<=z,Re=Math.max(4,re/100*20);return e.jsx("div",{style:{width:2,height:`${Re}px`,background:ye?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},$)})}):e.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."}),e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[ge(C)," / ",ge(u)]})})]})]})}function zl(){const[c,u]=o.useState(null),[f,b]=o.useState(null),[C,I]=o.useState(null),[v,L]=o.useState(null),Z=o.useRef(null);o.useEffect(()=>{Z.current=v},[v]);const N=o.useRef(null),[G,F]=o.useState(""),[ne,ge]=o.useState(null),z=o.useRef(null),re=o.useRef(null),$=o.useRef(null),ye=o.useRef(null),Re=o.useRef(null),jt=o.useRef(!1),be=o.useRef(null),Oe=o.useRef(null),fe=o.useRef(!1),He=o.useRef(null),Le=o.useRef(null),[ze,zt]=o.useState(!1),[Ct,we]=o.useState(1),[nt,rt]=o.useState(!1),ft=o.useRef(null);o.useRef({pinTimer:null});const[Ee,K]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Ae,Xt]=o.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Kt=o.useRef(null),[ht,St]=o.useState(()=>({open:!1,x:0,y:0,contactId:null,user:null})),U=o.useRef(null),[E,ie]=o.useState(()=>({open:!1,userId:null,user:null,contact:null})),[ue,xe]=o.useState(()=>({open:!1,anchor:null})),Se=o.useRef(null),Ye=o.useRef(null),[Ke,st]=o.useState(!1),[Vt,Wn]=o.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Rr,Bn]=o.useState({open:!1,messageId:null}),[ar,Zr]=o.useState(!1),[g,D]=o.useState([]),[R,Y]=o.useState(!1),[A,V]=o.useState("friends"),[ee,_]=o.useState(["","","",""]),je=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[he,Ce]=o.useState(null),[Te,We]=o.useState(null),[Yt,It]=o.useState(!1),Pt=o.useRef(0),[kt,fn]=o.useState(!1),[it,at]=o.useState(!1),[M,Qt]=o.useState(!1),pt=o.useRef(M),[At,pe]=o.useState("list");o.useEffect(()=>{pt.current=M},[M]);const[Jt,Tt]=o.useState(!1),Cn=o.useRef(null);o.useRef(null);const xt=o.useRef(new Map),Ve=o.useRef(!0),Ge=o.useRef(!1),Fe=o.useRef(0),Ie=o.useRef(null),vt=o.useRef(new Set),bt=o.useRef(null);o.useRef(null);const Sn=o.useRef(null),hn=o.useRef(0),[or,es]=o.useState(!1),[_n,ts]=o.useState(""),[cr,Er]=o.useState([]),[wt,ot]=o.useState(!1),[lr,On]=o.useState(null),[Ut,In]=o.useState(null),[Mt,Fn]=o.useState(null),[Di,Li]=o.useState(null),[Za,kn]=o.useState(!1),Fs=o.useRef(null),$n=o.useRef(null),eo=o.useRef(null),$s=o.useRef(null),[Qe,Zt]=o.useState({x:0,y:0,scale:1}),[zi,Xs]=o.useState(!1),[Ys,Xn]=o.useState(!1),[Yn,Ar]=o.useState(["","","",""]),Tr=[o.useRef(null),o.useRef(null),o.useRef(null),o.useRef(null)],[pn,Gn]=o.useState(null),[to,Gs]=o.useState(!1),[qs,no]=o.useState(""),[ro,Nr]=o.useState(!1),[dr,ns]=o.useState(!1),[Ks,rs]=o.useState(null),[Ht,ss]=o.useState(null),is=o.useRef(null),[ke,Mn]=o.useState({x:0,y:0,scale:1}),[Pi,as]=o.useState(0),qn=o.useRef(null),Vs=o.useRef(null),Ui=o.useRef(null),gt=o.useRef(null),Kn=o.useRef(null),Rn=o.useRef(null),os=o.useRef(null),mt=o.useRef(null),Vn=o.useRef(null),cs=o.useRef(null),Hi=o.useRef(null),[Me,en]=o.useState({x:0,y:0,scale:1}),[Wt,ls]=o.useState(null),[ds,us]=o.useState(null),[Wi,Qs]=o.useState(!1),[Bi,Js]=o.useState(!1),[fs,ur]=o.useState(null),[Zs,ei]=o.useState({open:!1,index:0,items:[]}),[so,hs]=o.useState(!1),[io,fr]=o.useState(0),[Il,ti]=o.useState(!1),[hr,Dr]=o.useState(null),[_i,Lr]=o.useState({}),[Qn,ps]=o.useState({}),zr=o.useRef(new Set),pr=o.useRef(new Set),[gn,Pr]=o.useState([]),[gs,tn]=o.useState(null),[ms,Oi]=o.useState(0),mn=o.useRef(null),[Fi,ni]=o.useState(!1),[$i,ri]=o.useState(0),[Ur,si]=o.useState([]),gr=o.useRef(null),Hr=o.useRef(null),[Xi,Yi]=o.useState(150);o.useEffect(()=>{if(M){Yi(60);return}const t=()=>{if(!Hr.current)return;const r=Hr.current.clientWidth,a=Math.floor(r/4);Yi(Math.max(100,a))};t();const n=new ResizeObserver(t);return Hr.current&&n.observe(Hr.current),()=>{n.disconnect()}},[M]),o.useEffect(()=>{wl().catch(()=>{})},[]);const Gi=o.useRef(null);o.useEffect(()=>{Gi.current=c},[c]);const ys=o.useRef([]);o.useEffect(()=>{ys.current=gn},[gn]);const Jn=o.useCallback(t=>{if(t)try{URL.revokeObjectURL(t)}catch{}},[]),ii=o.useCallback(()=>{tn(null),Pr(t=>t.length?(t.forEach(n=>Jn(n.previewUrl)),[]):t)},[Jn,tn]),Wr=o.useCallback((t,n)=>{!t||!t.type.startsWith("image/")||Pr(r=>{if(r.length>=Cl)return alert("ÐœÐ¾Ð¶Ð½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ðµ Ð±Ð¾Ð»ÐµÐµ 10 Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð·Ð° Ñ€Ð°Ð·."),r;const s=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,a=URL.createObjectURL(t),i={id:s,file:t,previewUrl:a,edited:!1,fileName:t.name||"image.png",source:n};return[...r,i]})},[]),ao=o.useCallback(t=>{Pr(n=>{const r=n.find(s=>s.id===t);return r&&Jn(r.previewUrl),n.filter(s=>s.id!==t)}),tn(n=>n===t?null:n)},[Jn,tn]),oo=o.useCallback((t,n,r)=>{Pr(s=>s.map(a=>a.id!==t?a:(Jn(a.previewUrl),{...a,file:n,previewUrl:r,edited:!0,fileName:n.name||a.fileName})))},[Jn]),qi=Cr({queryKey:["my-devices"],queryFn:async()=>(await J.get("/devices")).data.devices}),[kl,Ki]=o.useState(null),[co,xs]=o.useState(()=>_e.connected),[lo,Vi]=o.useState(null),[Qi,uo]=o.useState({}),[Ji,vs]=o.useState({}),[Zi,bs]=o.useState({}),[ea,ta]=o.useState({}),[fo,Br]=o.useState(!1),[na,_r]=o.useState({}),[ra,sa]=o.useState(!1),[ai,ws]=o.useState(!1),ia=o.useRef(null),T=ir(t=>t.session?.user),Or=o.useRef(null);if(Or.current===null&&typeof window<"u")try{const t=localStorage.getItem("eb_user");if(t){const n=JSON.parse(t);n&&typeof n.id=="string"&&(Or.current=n.id)}}catch{Or.current=null}o.useEffect(()=>{T?.id&&(Or.current=T.id)},[T?.id]);const Ne=T?.id??Or.current??null,X=Vr(),P=dc(),js=o.useMemo(()=>c?_i[c]||[]:[],[c,_i]),Cs=o.useMemo(()=>gs?gn.find(t=>t.id===gs)??null:null,[gn,gs]);o.useRef(null),o.useRef(null);const[yn,Rt]=o.useState({}),[Ml,ho]=o.useState(0),Zn=o.useRef(null);o.useEffect(()=>{Zn.current=f},[f]);const po=o.useRef({}),oi=o.useRef({}),mr=o.useRef({});o.useEffect(()=>()=>{typeof window>"u"||(Object.values(mr.current).forEach(t=>{typeof t=="number"&&window.clearTimeout(t)}),N.current&&window.clearTimeout(N.current),er())},[]),o.useEffect(()=>{if(!v)return;const t=setInterval(()=>{L(n=>n?{...n}:null)},1e3);return()=>clearInterval(t)},[v]);const Ss=o.useCallback(t=>{if(!t)return null;const n=P.getQueryData(["conversations"]);return Array.isArray(n)?n.find(s=>s?.conversation?.id===t)?.conversation??null:null},[P]),yr=o.useCallback(t=>{const n=Ss(t);if(!n)return!1;const r=n.participants?.length??0;return!n.isGroup&&r<=2},[Ss]),En=o.useCallback(t=>{if(!t)return;const n=mr.current[t];typeof n=="number"&&typeof window<"u"&&(window.clearTimeout(n),delete mr.current[t]),delete oi.current[t]},[]),Is=o.useCallback(t=>{t&&yr(t)&&(oi.current[t]=Date.now()+jl)},[yr]),ci=o.useCallback((t,n,r)=>{if(!t){n();return}if(r?.force){En(t),n();return}const s=oi.current[t];if(!s){n();return}const a=Date.now();if(a>=s){En(t),n();return}const i=s-a,l=mr.current[t];if(typeof l=="number"&&typeof window<"u"&&window.clearTimeout(l),typeof window>"u"){n();return}mr.current[t]=window.setTimeout(()=>{delete mr.current[t],En(t),n()},i)},[En]),li=o.useCallback((t,n)=>{const r=t?"ÐºÐ°Ð¼ÐµÑ€Ðµ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ":"Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ",s=typeof n=="object"&&n&&"name"in n?String(n.name):"";return s==="NotAllowedError"||s==="SecurityError"?`Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð² Ð°Ð´Ñ€ÐµÑÐ½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`:s==="NotFoundError"?t?"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":"Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð½Ð°ÑˆÑ‘Ð» Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·.":s==="NotReadableError"||s==="TrackStartError"?"ÐšÐ°Ð¼ÐµÑ€Ð° Ð¸Ð»Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð»Ð¸ Ð²ÐºÐ»Ð°Ð´ÐºÐ¾Ð¹.":`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ${r}. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð° Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.`},[]),ks=o.useCallback(async t=>{try{const n=await Pa({audio:!0,video:t});return n.ok?(Dr(null),!0):(Dr(li(t,n.error)),!1)}catch(n){return Dr(li(t,n)),!1}},[li]),Ms=o.useCallback(async t=>{const n=X.incoming;if(!n||!await ks(t))return;const r=n.conversationId;Is(r),Bo(r,t),X.startOutgoing(r,t),Rt(s=>{const a=s[r],i=T?.id;return a?.active?i&&a.participants&&!a.participants.includes(i)?{...s,[r]:{...a,participants:[...a.participants,i]}}:s:{...s,[r]:{startedAt:Date.now(),active:!0,participants:i?[i]:[]}}}),b(r),I(s=>s===r?null:s),X.setIncoming(null),_t()},[Is,X,T?.id,ks]),di=o.useCallback(()=>{const t=X.incoming;t&&(Aa(t.conversationId),X.setIncoming(null),_t())},[X]);o.useEffect(()=>{if(typeof window>"u")return;const t={accept:async(n,r)=>X.incoming?.conversationId!==n?!1:(await Ms(r),!0),decline:n=>X.incoming?.conversationId!==n?!1:(di(),!0)};return window.__nativeCallOverlayBridge=t,()=>{window.__nativeCallOverlayBridge===t&&delete window.__nativeCallOverlayBridge}},[X.incoming?.conversationId,Ms,di]),o.useEffect(()=>{const t=window.setInterval(()=>ho(n=>(n+1)%1e6),1e3);return()=>window.clearInterval(t)},[]),o.useEffect(()=>{if(!hr||typeof window>"u")return;const t=window.setTimeout(()=>Dr(null),9e3);return()=>window.clearTimeout(t)},[hr]),o.useEffect(()=>{const t=()=>{const n=window.innerWidth<=768;Qt(n),pt.current=n,n?c||pe("list"):pe("conversation")};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[c]),o.useEffect(()=>{M&&pe(c?"conversation":"list")},[M,c]),o.useEffect(()=>{const t=(()=>{try{const a=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(a==="1"||a==="true")return!0;const i=window.localStorage.getItem("lk-debug-callstatus");return i==="1"||i==="true"}catch{return!1}})(),n=s=>{t&&console.log("[CallStatus] Single:",s),Rt(a=>{const i=P.getQueryData(["conversations"]),l=Array.isArray(i)?i.find(x=>x.conversation.id===s.conversationId)?.conversation:null,h=a[s.conversationId],d=Vr.getState().activeConvId;if(!(!!(l&&(l.isGroup||(l.participants?.length??0)>2))||!!h&&(h.participants?h.participants.length>1:!0)||d===s.conversationId))return a;const w=s.participants||[];if(s.active){const x=typeof s.startedAt=="number"&&s.startedAt>0?s.startedAt:h?.startedAt??Date.now();return{...a,[s.conversationId]:{active:!0,startedAt:x,participants:w,endedAt:null,elapsedMs:typeof s.elapsedMs=="number"?s.elapsedMs:void 0}}}const m=h?.active?Date.now():h?.endedAt??null;return{...a,[s.conversationId]:{active:!1,startedAt:h?.startedAt??null,endedAt:m,participants:[],elapsedMs:void 0}}})},r=s=>{t&&console.log("[CallStatus] Bulk:",s),Rt(a=>{const i={...a},l=P.getQueryData(["conversations"]);for(const[h,d]of Object.entries(s.statuses||{})){const p=Array.isArray(l)?l.find(k=>k.conversation.id===h)?.conversation:null,w=a[h],m=Vr.getState().activeConvId;if(!(!!(p&&(p.isGroup||(p.participants?.length??0)>2))||!!w&&(w.participants?w.participants.length>1:!0)||m===h))continue;const j=d.participants||[];if(d.active){const k=typeof d.startedAt=="number"&&d.startedAt>0?d.startedAt:w?.startedAt??Date.now();i[h]={active:!0,startedAt:k,participants:j,endedAt:null,elapsedMs:typeof d.elapsedMs=="number"?d.elapsedMs:void 0};continue}const y=w?.active?Date.now():w?.endedAt??null;i[h]={active:!1,startedAt:w?.startedAt??null,endedAt:y,participants:[],elapsedMs:void 0}}return i})};return _o(n),Oo(r),()=>{_e.off("call:status",n),_e.off("call:status:bulk",r)}},[]),o.useEffect(()=>{if(!Ee.open)return;const t=ia.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=t.getBoundingClientRect();let a=Ee.x,i=Ee.y;a+s.width>n-8&&(a=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(a!==Ee.x||i!==Ee.y)&&K(l=>({...l,x:a,y:i}))},[Ee.open,Ee.x,Ee.y]),o.useEffect(()=>{if(!Ae.open)return;const t=Kt.current;if(!t)return;const n=window.innerWidth,r=window.visualViewport?window.visualViewport.height:window.innerHeight,s=t.getBoundingClientRect();let a=Ae.x,i=Ae.y;a+s.width>n-8&&(a=Math.max(8,n-s.width-8)),i+s.height>r-8&&(i=Math.max(8,r-s.height-8)),(a!==Ae.x||i!==Ae.y)&&Xt(l=>({...l,x:a,y:i}))},[Ae.open,Ae.x,Ae.y]),o.useEffect(()=>{if(!ue.open||!ue.anchor)return;const t=Se.current;if(!t)return;const n=ue.anchor.getBoundingClientRect(),r=window.innerWidth,s=window.visualViewport?window.visualViewport.height:window.innerHeight;t.style.display="flex";const a=t.getBoundingClientRect();let i=n.right-a.width,l=n.bottom+8;i<8&&(i=8),i+a.width>r-8&&(i=r-a.width-8),l+a.height>s-8&&(l=n.top-a.height-8),l<8&&(l=8),t.style.left=`${i}px`,t.style.top=`${l}px`},[ue.open,ue.anchor]),o.useEffect(()=>{c||xe({open:!1,anchor:null})},[c]);function nn(t){u(n=>{try{n&&n!==t&&(te.data||[]).find(a=>a.conversation.id===n)?.conversation?.isSecret&&P.removeQueries({queryKey:["messages",n]})}catch{}return t}),M&&pe("conversation"),ys.current.length&&ii()}async function aa(){let t=Mr();return t||(t=await oc()),t||null}async function ui(t){if(ra)return;sa(!0);const n=2;let r=0;const s=async()=>{if(r>=n)throw new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.");r+=1,await ac()};try{for(;;){const a=await aa();if(!a){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}try{const i={participantIds:[t],isGroup:!1,isSecret:!0,initiatorDeviceId:a.deviceId};console.log("[SecretChat] Creating with payload:",i),await J.post("/conversations",i),P.invalidateQueries({queryKey:["conversations"]});return}catch(i){console.error("[SecretChat] Creation error:",i?.response?.data||i);const l=i?.response?.data?.message,h=i?.response?.data?.errors;if(h&&console.error("[SecretChat] Validation errors:",h),i?.response?.status===400&&typeof l=="string"&&l.toLowerCase().includes("invalid initiator device")){await s();continue}const p=h?`ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸: ${h.map(w=>`${w.path.join(".")}: ${w.message}`).join(", ")}`:l||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";throw new Error(p)}}}catch(a){console.error("Failed to start secret conversation:",a);const i=a?.message||a?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚";alert(i)}finally{sa(!1)}}const oa=async t=>{ws(!0);try{cc(t),_r(n=>{const r={...n};return delete r[t],r}),P.invalidateQueries({queryKey:["conversations"]})}finally{ws(!1)}},go=async t=>{ws(!0);try{const n=await aa();if(!n){alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°");return}lc(t,n.deviceId),P.invalidateQueries({queryKey:["conversations"]}),nn(t)}catch(n){console.error("Failed to accept secret chat:",n),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚")}finally{ws(!1)}};async function ca(t,n){if(!t)return;const r={...n,content:n.content??void 0};if(t.isSecret){const s=await un.encryptPayload(t,r);await J.post("/conversations/send",s);return}await J.post("/conversations/send",{conversationId:t.id,...r})}const xr=()=>{Zr(!1),D([]),Y(!1),V("friends"),_(["","","",""]),Ce(null),We(null),It(!1)},mo=async()=>{if(!c||g.length===0){xr();return}Y(!0);try{await J.post(`/conversations/${c}/participants`,{participantIds:g}),P.invalidateQueries({queryKey:["conversations"]}),te.refetch(),xr()}catch(t){console.error("Error adding participants:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")}finally{Y(!1)}},yo=async()=>{if(!(!c||!he)){Y(!0);try{await J.post(`/conversations/${c}/participants`,{participantIds:[he.id]}),P.invalidateQueries({queryKey:["conversations"]}),te.refetch(),xr()}catch(t){console.error("Error adding participant by EBLID:",t),alert(t.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°")}finally{Y(!1)}}},xo=(t,n)=>{if(!/^\d?$/.test(n))return;const r=[...ee];r[t]=n,_(r),n&&t<3&&je[t+1].current?.focus(),!n&&t>0&&je[t-1].current?.focus();const s=r.join("");if(s.length===4&&/^\d{4}$/.test(s)){const a=Date.now();Pt.current=a,It(!0),We(null),J.get("/contacts/search",{params:{query:s}}).then(i=>{if(Pt.current!==a)return;const l=i.data.results?.[0]??null;Ce(l),We(l?null:"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½")}).catch(()=>{Pt.current===a&&(Ce(null),We("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¸ÑÐº"))}).finally(()=>{Pt.current===a&&It(!1)})}else Ce(null),We(null),It(!1)};function vo(){if(M){if(c)try{(te.data||[]).find(r=>r.conversation.id===c)?.conversation?.isSecret&&P.removeQueries({queryKey:["messages",c]})}catch{}pe("list"),u(null),Tt(!1)}ys.current.length&&ii()}const Gt=Cr({queryKey:["me-info"],queryFn:async()=>(await J.get("/status/me")).data.user}),te=Cr({queryKey:["conversations"],queryFn:async()=>(await J.get("/conversations")).data.conversations}),Be=Cr({queryKey:["messages",c],enabled:!!c,queryFn:async()=>(await J.get(`/conversations/${c}/messages`)).data.messages,refetchInterval:c?15e3:!1});o.useEffect(()=>{Be.error?.response?.status===403&&c&&(console.warn("[ChatsPage] Lost access to conversation, closing view",c),P.removeQueries({queryKey:["messages",c]}),u(null))},[Be.error,c,P]);const ct=Cr({queryKey:["accepted-contacts"],queryFn:async()=>(await J.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),rn=Cr({queryKey:["incoming-contacts"],queryFn:async()=>(await J.get("/contacts",{params:{filter:"incoming"}})).data.contacts});o.useEffect(()=>{if(c&&!(typeof window>"u"))try{window.localStorage.setItem(qa,c)}catch{}},[c]),o.useEffect(()=>{if(typeof window>"u"||c)return;const t=te.data;if(!(!t||t.length===0)&&!(pt.current&&At!=="conversation"))try{const n=window.localStorage.getItem(qa);if(!n)return;t.some(s=>s?.conversation?.id===n)&&nn(n)}catch{}},[c,te.data,At]);const fi=()=>{if(es(!1),ts(""),Er([]),ot(!1),Ut)try{URL.revokeObjectURL(Ut)}catch{}if(In(null),Mt)try{URL.revokeObjectURL(Mt)}catch{}Fn(null),On(null),Li(null),Zt({x:0,y:0,scale:1}),kn(!1)};o.useEffect(()=>{const t=Ye.current;if(!t)return;const n=()=>{const{scrollTop:r,scrollHeight:s,clientHeight:a}=t,i=r>2,l=s-r-a>2;fn(i),at(l)};return n(),t.addEventListener("scroll",n),window.addEventListener("resize",n),()=>{t.removeEventListener("scroll",n),window.removeEventListener("resize",n)}},[te.data?.length]),o.useEffect(()=>{try{const t=(te.data||[]).map(n=>n.conversation.id);try{const r=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(r==="1"||r==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",t)}catch{}t.length>0&&Ta(t);for(const n of t)try{Na(n)}catch{}}catch{}},[te.data]);const S=o.useMemo(()=>te.data?.find(t=>t.conversation.id===c)?.conversation,[te.data,c]);o.useEffect(()=>()=>{zr.current.forEach(t=>URL.revokeObjectURL(t)),zr.current.clear(),pr.current.clear()},[]),o.useEffect(()=>{zr.current.forEach(t=>URL.revokeObjectURL(t)),zr.current.clear(),pr.current.clear(),ps({})},[S?.id]);const Fr=o.useMemo(()=>Mr()?.deviceId??null,[ms]),Rs=o.useMemo(()=>{const t={};for(const n of qi.data||[])t[n.id]=n;return t},[qi.data]),Es=o.useCallback(t=>{if(!t?.isSecret)return null;const n=[t.secretInitiatorDeviceId,t.secretPeerDeviceId];for(const r of n){if(!r)continue;const s=Rs[r];if(s?.userId&&T?.id&&s.userId===T.id)return r}if(T?.id){if(t.createdById===T.id&&t.secretInitiatorDeviceId)return t.secretInitiatorDeviceId;if(t.createdById!==T.id&&t.secretPeerDeviceId)return t.secretPeerDeviceId}return null},[Rs,T?.id]),vr=o.useMemo(()=>Es(S),[S,Es]),la=o.useMemo(()=>{if(!vr)return;const t=Rs[vr]?.name;if(t&&t.trim())return t;const n=Mr();if(n&&n.deviceId===vr&&n.name)return n.name},[vr,Rs,ms]),da=o.useCallback(t=>{if(!t)return!1;const n=(te.data||[]).find(s=>s?.conversation?.id===t)?.conversation;if(!n?.isSecret)return!1;const r=Es(n);return!!(r&&Fr&&r!==Fr)},[te.data,Fr,Es]),As=!!(S?.isSecret&&(S.secretStatus??"ACTIVE")!=="ACTIVE"),br=o.useMemo(()=>S?.isSecret?un.hasSession(S.id):!0,[S?.id,S?.isSecret,ms]),bo=!!(S?.isSecret&&!As&&!br&&vr&&Fr&&vr!==Fr);o.useEffect(()=>{if(!S?.isSecret||S.secretStatus!=="ACTIVE")return;let t=!1;return un.ensureSession(S).then(n=>{!t&&n&&Oi(r=>(r+1)%Number.MAX_SAFE_INTEGER)}).catch(n=>{console.warn("Failed to ensure E2EE session",n)}),()=>{t=!0}},[S?.id,S?.secretStatus,S?.isSecret]),o.useEffect(()=>{if(!S?.isSecret||!Be.data||Be.data.length===0)return;un.processHandshakes(S,Be.data)&&Oi(n=>(n+1)%Number.MAX_SAFE_INTEGER)},[Be.data,S?.id,S?.isSecret,S?.secretStatus]);const Bt=o.useMemo(()=>Be.data?S?.isSecret?Be.data.filter(t=>{const r=(t?.metadata??{}).e2ee;return!(r&&r.kind==="handshake")}).map(t=>un.transformMessage(S.id,t)):Be.data:[],[Be.data,S?.id,S?.isSecret,ms]),ua=o.useCallback(t=>{if(!S?.id)return;const n=t?.metadata?.e2ee;!n||n.kind!=="ciphertext"||!n.nonce||!un.hasSession(S.id)||pr.current.has(t.url)||Qn[t.url]?.status==="ready"||(pr.current.add(t.url),ps(s=>({...s,[t.url]:{status:"pending"}})),(async()=>{try{const s=Ei(t.url)||t.url,a=await fetch(s,{credentials:"omit"});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const i=new Uint8Array(await a.arrayBuffer()),l=un.decryptBinary(S.id,i,n.nonce);if(!l)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const h=new Blob([l],{type:n.originalType||t.metadata?.mime||t.metadata?.contentType||"application/octet-stream"}),d=URL.createObjectURL(h);zr.current.add(d),pr.current.delete(t.url),ps(p=>({...p,[t.url]:{status:"ready",url:d}}))}catch(s){pr.current.delete(t.url),ps(a=>{const i={...a};return s?.message?.includes("E2EE session is not ready")?delete i[t.url]:i[t.url]={status:"error"},i})}})())},[S?.id,Qn]),Ts=o.useCallback(t=>{if(!t)return null;const n=Ei(t.url);if(!S?.isSecret)return n;const r=t.metadata?.e2ee;if(!r||r.kind!=="ciphertext")return n;const s=Qn[t.url];return s?.status==="ready"&&s.url?s.url:null},[Qn,S?.isSecret]);o.useEffect(()=>{if(!S?.isSecret||!br)return;(Bt||[]).flatMap(n=>n.attachments||[]).forEach(n=>{n?.metadata?.e2ee?.kind==="ciphertext"&&ua(n)})},[Bt,S?.id,S?.isSecret,br,ua]),o.useEffect(()=>{const t=new Set((te.data||[]).map(n=>n.conversation).filter(n=>n?.isSecret&&(n.secretStatus??"ACTIVE")==="PENDING").map(n=>n.id));_r(n=>{let r=!1;const s={...n};for(const a of Object.keys(s))t.has(a)||(delete s[a],r=!0);return r?s:n})},[te.data]);const wr=o.useMemo(()=>{if(!S||S.isGroup||S.isSecret||!T?.id)return null;const t=Ka(S.participants||[]);if(!t)return null;const n=te.data||[];for(const r of n){const s=r.conversation;if(!s?.isSecret||(s.secretStatus??"ACTIVE")!=="PENDING"||Ka(s.participants||[])!==t)continue;const i=(s.participants||[]).find(h=>h.user.id===s.createdById)?.user,l=na[s.id]?.from?.name??i?.displayName??i?.username??"Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº";return{conversationId:s.id,isInitiator:s.createdById===T.id,initiatorName:l}}return null},[S,te.data,T?.id,na]),fa=o.useMemo(()=>{const t={};if(S)for(const n of S.participants)t[n.user.id]=n.user;return T&&!t[T.id]&&(t[T.id]=T),t},[S,T]),hi=o.useMemo(()=>S?(S.participants||[]).map(t=>t.user.id):[],[S]),ha=o.useMemo(()=>{if(!S||!ct.data)return[];const t=new Set(hi);return ct.data.filter(n=>!t.has(n.friend.id))},[S,ct.data,hi]),Ns={alreadyInChat:he?hi.includes(he.id):!1,isSelf:he?he.id===T?.id:!1};o.useEffect(()=>{ar&&A==="eblid"&&je[0].current?.focus()},[ar,A]),o.useEffect(()=>{const t=n=>{uo(r=>{const s=(n.status||"").toString().toUpperCase();return r[n.userId]===s?r:{...r,[n.userId]:s}}),P.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(i=>i.user.id===n.userId?{...i,user:{...i.user,status:n.status,lastSeenAt:n.status==="ONLINE"||n.status==="BACKGROUND"||n.status==="IN_CALL"||n.status==="OFFLINE"?new Date().toISOString():i.user.lastSeenAt}}:i)}})))};return Da(t),()=>{_e.off("presence:update",t)}},[P]);const An=o.useCallback(t=>{const n=t?.id,r=typeof n=="string"?n:null,a=((r?Qi[r]:void 0)??t?.status??"OFFLINE").toString().toUpperCase();return a==="IN_CALL"?"IN_CALL":a==="ONLINE"?"ONLINE":a==="BACKGROUND"?"BACKGROUND":a==="AWAY"?"AWAY":"OFFLINE"},[Qi]),Ds=o.useRef(_e.connected);o.useEffect(()=>{const t=()=>{try{const a=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",a+"px")}catch{}P.invalidateQueries({queryKey:["me-info"]}),xs(_e.connected)};window.addEventListener("focus",t);const n=()=>{xs(!0);const a=Ds.current;if(Ds.current=!0,a)try{const i=(te.data||[]).map(l=>l.conversation.id);for(const l of i)try{Na(l)}catch{}i.length>0&&Ta(i)}catch{}},r=()=>{xs(!1),Ds.current=!1};_e.on("connect",n),_e.on("disconnect",r),xs(_e.connected),_e.connected&&(Ds.current=!0);const s=()=>{P.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",s),()=>{_e.off("connect",n),_e.off("disconnect",r),document.removeEventListener("visibilitychange",s),window.removeEventListener("focus",t)}},[P]),o.useEffect(()=>{const t=n=>{if(T?.id&&n.userId===T.id){const r=(n.status||"").toUpperCase();(r==="ONLINE"||r==="AWAY"||r==="BACKGROUND"||r==="IN_CALL"||r==="OFFLINE")&&Vi(r)}};return Da(t),()=>{_e.off("presence:update",t)}},[T?.id]),o.useEffect(()=>{const t=(Gt.data?.status||"").toString().toUpperCase();(t==="ONLINE"||t==="AWAY"||t==="BACKGROUND"||t==="IN_CALL"||t==="OFFLINE")&&Vi(t)},[Gt.data]),o.useEffect(()=>{const t=n=>{P.setQueryData(["conversations"],r=>r&&r.map(s=>({...s,conversation:{...s.conversation,participants:s.conversation.participants.map(a=>a.user.id===n.userId?{...a,user:{...a.user,avatarUrl:n.avatarUrl??a.user.avatarUrl,displayName:n.displayName??a.user.displayName}}:a)}}))),n.userId===T?.id&&Gt.refetch()};return Fo(t),()=>{_e.off("profile:update",t)}},[P,T?.id]);function wo(t){return"#191d23"}o.useEffect(()=>{if(!c)return;const t=async n=>{const r=n.target;if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return;const s=n.clipboardData?.items;if(s)for(let a=0;a<s.length;a++){const i=s[a];if(i.type.indexOf("image")!==-1){n.preventDefault(),n.stopPropagation();const l=i.getAsFile();l&&Wr(l,"paste");break}}};return window.addEventListener("paste",t,!0),()=>{window.removeEventListener("paste",t,!0)}},[c,Wr]),o.useEffect(()=>{te.refetch(),$o(),Xo(()=>te.refetch()),Yo(r=>{const s=r?.conversationId;if(!s){te.refetch();return}_r(i=>{if(!i[s])return i;const l={...i};return delete l[s],l}),Lr(i=>{if(!i[s])return i;const l={...i};return delete l[s],l}),un.clearSession(s),P.removeQueries({queryKey:["messages",s]}),P.setQueryData(["conversations"],i=>Array.isArray(i)?i.filter(l=>l?.conversation?.id!==s):i),Gi.current===s&&(u(i=>i===s?null:i),Tt(!1),ys.current.length&&ii(),pt.current&&pe("list")),te.refetch()}),Go(()=>{te.refetch()}),qo(()=>{te.refetch()});const t=Ko(r=>{_r(s=>({...s,[r.conversationId]:r})),te.refetch()}),n=Vo(r=>{_r(s=>{const a={...s};return delete a[r.conversationId],a}),P.invalidateQueries({queryKey:["conversations"]}),nn(r.conversationId)});Qo(({conversationId:r,from:s,video:a})=>{if(!(ye.current&&ye.current===r)){_t();try{const i=P.getQueryData(["conversations"]),l=Array.isArray(i)?i.find(p=>p.conversation.id===r)?.conversation:null,h=!!(l&&(l.isGroup||(l.participants?.length??0)>2));po.current[r]=s.id;const d=Zn.current===r;if(h||d||s?.id&&T?.id&&s.id===T.id)return}catch{}ye.current=r,X.startIncoming({conversationId:r,from:s,video:a});try{const i=pa();i&&(i.currentTime=0,i.loop=!0,i.volume=.9,i.play().catch(()=>{}))}catch(i){console.error("Error starting ringtone:",i)}$.current=window.setTimeout(()=>{Aa(r),_t(),X.setIncoming(null)},25e3)}}),Jo(({conversationId:r,by:s,video:a})=>{if(En(r),L(d=>d?.conversationId===r?(N.current&&(window.clearTimeout(N.current),N.current=null),er(),null):d),s?.id===T?.id){(X.incoming?.conversationId===r||ye.current===r)&&(_t(),X.setIncoming(null),$.current&&(window.clearTimeout($.current),$.current=null),ye.current=null);return}const i=Zn.current===r,l=Vr.getState().activeConvId===r,h=Z.current?.conversationId===r;if(!i&&!l&&!h){(Vr.getState().incoming?.conversationId===r||ye.current===r)&&(_t(),X.setIncoming(null),$.current&&(window.clearTimeout($.current),$.current=null),ye.current=null);return}if(Rt(d=>d[r]?.active?d:{...d,[r]:{startedAt:Date.now(),active:!0,participants:[T?.id||""].filter(Boolean)}}),X.activeConvId!==r){const d=!!a;X.startOutgoing(r,d)}b(r),I(d=>d===r?null:d),_t()}),Zo(({conversationId:r})=>{L(a=>a?.conversationId===r?(N.current&&(window.clearTimeout(N.current),N.current=null),er(),Ls(),null):a);const s=()=>{Rt(a=>{const i=a[r];if(i){if(i.active)return{...a,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:l,...h}=a;return h}return a}),Zn.current===r&&(b(a=>a===r?null:a),I(a=>a===r?null:a),X.endCall()),X.setIncoming(null),_t(),En(r)};yr(r)?ci(r,s,{force:!0}):s()}),ec(({conversationId:r})=>{try{const a=P.getQueryData(["conversations"]),i=Array.isArray(a)?a.find(h=>h.conversation.id===r)?.conversation:null;if(!!(i&&(i.isGroup||(i.participants?.length??0)>2)))return}catch{}if(C===r)return;if(yr(r)){const a=yn[r];if((Zn.current===r||X.activeConvId===r)&&a?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",r);return}}const s=()=>{L(a=>a?.conversationId===r?(N.current&&(window.clearTimeout(N.current),N.current=null),er(),null):a),Rt(a=>{const i=a[r];if(i?.active)return{...a,[r]:{...i,active:!1,endedAt:Date.now()}};const{[r]:l,...h}=a;return h}),Zn.current===r&&(b(a=>a===r?null:a),I(a=>a===r?null:a),X.endCall()),X.setIncoming(null),_t(),En(r)};yr(r)?ci(r,s,{force:!0}):s()}),tc(({conversationId:r})=>{P.invalidateQueries({queryKey:["messages",r]}),P.refetchQueries({queryKey:["messages",r]})});try{Oe.current||(Oe.current=new Audio("/notify.mp3"),Oe.current.preload="auto",Oe.current.volume=.9);const r=async()=>{try{if(Oe.current&&!fe.current&&(Oe.current.volume=0,await Oe.current.play(),Oe.current.pause(),Oe.current.currentTime=0,Oe.current.volume=.9,fe.current=!0),!jt.current){const s=pa();if(s){const a=s.volume;s.volume=0,await s.play().catch(()=>{}),s.pause(),s.currentTime=0,s.volume=a,jt.current=!0}}}catch{}fe.current&&jt.current&&(window.removeEventListener("click",r),window.removeEventListener("keydown",r),window.removeEventListener("touchstart",r))};window.addEventListener("click",r),window.addEventListener("keydown",r),window.addEventListener("touchstart",r)}catch{}return()=>{t?.(),n?.()}},[]),o.useEffect(()=>{nc(()=>{rn.refetch()}),rc(()=>{ct.refetch(),te.refetch(),rn.refetch()}),sc(()=>{ct.refetch(),rn.refetch()})},[]),o.useEffect(()=>{if(!Ht)return;const t=qn.current;if(!t)return;const n=(d,p)=>{const w=p.clientX-d.clientX,m=p.clientY-d.clientY;return Math.sqrt(w*w+m*m)},r=(d,p)=>({x:(d.clientX+p.clientX)/2,y:(d.clientY+p.clientY)/2}),s=240,a=(d,p,w,m,x)=>{const j=d-w,y=p-m;return j*j+y*y<=x*x},i=d=>{const p=t.getBoundingClientRect();if(!p)return;const w=p.width,m=p.height,x=w/2,j=m/2,y=s/2;if(d.touches.length===1){const k=d.touches[0],H=k.clientX-p.left,W=k.clientY-p.top;if(!a(H,W,x,j,y))return;gt.current={touches:[k],initialDistance:0,initialScale:ke.scale,initialX:ke.x,initialY:ke.y},d.preventDefault()}else if(d.touches.length===2){const k=d.touches[0],H=d.touches[1],W=r(k,H),oe=W.x-p.left,le=W.y-p.top;if(!a(oe,le,x,j,y))return;const de=n(k,H);gt.current={touches:[k,H],initialDistance:de,initialScale:ke.scale,initialX:ke.x,initialY:ke.y},d.preventDefault()}},l=d=>{gt.current&&(d.preventDefault(),Kn.current!==null&&cancelAnimationFrame(Kn.current),Kn.current=requestAnimationFrame(()=>{if(!gt.current)return;const p=t.getBoundingClientRect();if(!p)return;const w=p.width,m=p.height,x=w/2,j=m/2,y=d.touches.length,k=gt.current.touches.length;if(y===1&&k===1){const H=d.touches[0],W=gt.current.touches[0],oe=H.clientX-W.clientX,le=H.clientY-W.clientY;Mn(de=>{let q=gt.current.initialX+oe,ae=gt.current.initialY+le;const O=Vs.current;if(O){const se=de.scale,ce=O.naturalWidth*se,Pe=O.naturalHeight*se,Je=x+s/2,Ue=x-s/2-ce,yt=j+s/2,xn=j-s/2-Pe;q=Math.max(Ue,Math.min(Je,q)),ae=Math.max(xn,Math.min(yt,ae))}return{...de,x:q,y:ae}})}else if(y===2&&k===2){const H=d.touches[0],W=d.touches[1],le=n(H,W)/gt.current.initialDistance,de=Math.max(.1,Math.min(10,gt.current.initialScale*le)),q=Vs.current;if(q){const ae=q.naturalWidth,O=q.naturalHeight,se=gt.current.initialX+ae*gt.current.initialScale/2,ce=gt.current.initialY+O*gt.current.initialScale/2,Pe=se-x,Je=ce-j,Ue=de/gt.current.initialScale,yt=x+Pe*Ue,xn=j+Je*Ue,Yr=yt-ae*de/2,vn=xn-O*de/2;Mn({x:Yr,y:vn,scale:de})}}Kn.current=null}))},h=()=>{Kn.current!==null&&(cancelAnimationFrame(Kn.current),Kn.current=null),gt.current=null};return t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1}),t.addEventListener("touchend",h,{passive:!0}),t.addEventListener("touchcancel",h,{passive:!0}),()=>{t.removeEventListener("touchstart",i),t.removeEventListener("touchmove",l),t.removeEventListener("touchend",h),t.removeEventListener("touchcancel",h)}},[Ht,ke.scale,ke.x,ke.y]),o.useEffect(()=>{if(!Wt)return;const t=Rn.current;if(!t)return;const n=(d,p)=>{const w=p.clientX-d.clientX,m=p.clientY-d.clientY;return Math.sqrt(w*w+m*m)},r=(d,p)=>({x:(d.clientX+p.clientX)/2,y:(d.clientY+p.clientY)/2}),s=240,a=(d,p,w,m,x)=>{const j=d-w,y=p-m;return j*j+y*y<=x*x},i=d=>{const p=t.getBoundingClientRect();if(!p)return;const w=p.width,m=p.height,x=w/2,j=m/2,y=s/2;if(d.touches.length===1){const k=d.touches[0],H=k.clientX-p.left,W=k.clientY-p.top;if(!a(H,W,x,j,y))return;mt.current={touches:[k],initialDistance:0,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},d.preventDefault()}else if(d.touches.length===2){const k=d.touches[0],H=d.touches[1],W=r(k,H),oe=W.x-p.left,le=W.y-p.top;if(!a(oe,le,x,j,y))return;const de=n(k,H);mt.current={touches:[k,H],initialDistance:de,initialScale:Me.scale,initialX:Me.x,initialY:Me.y},d.preventDefault()}},l=d=>{mt.current&&(d.preventDefault(),Vn.current!==null&&cancelAnimationFrame(Vn.current),Vn.current=requestAnimationFrame(()=>{if(!mt.current)return;const p=t.getBoundingClientRect();if(!p)return;const w=p.width,m=p.height,x=w/2,j=m/2,y=d.touches.length,k=mt.current.touches.length;if(y===1&&k===1){const H=d.touches[0],W=mt.current.touches[0],oe=H.clientX-W.clientX,le=H.clientY-W.clientY;en(de=>{let q=mt.current.initialX+oe,ae=mt.current.initialY+le;const O=os.current;if(O){const se=de.scale,ce=O.naturalWidth*se,Pe=O.naturalHeight*se,Je=x+s/2,Ue=x-s/2-ce,yt=j+s/2,xn=j-s/2-Pe;q=Math.max(Ue,Math.min(Je,q)),ae=Math.max(xn,Math.min(yt,ae))}return{...de,x:q,y:ae}})}else if(y===2&&k===2){const H=d.touches[0],W=d.touches[1],le=n(H,W)/mt.current.initialDistance,de=Math.max(.1,Math.min(10,mt.current.initialScale*le)),q=os.current;if(q){const ae=q.naturalWidth,O=q.naturalHeight,se=mt.current.initialX+ae*mt.current.initialScale/2,ce=mt.current.initialY+O*mt.current.initialScale/2,Pe=se-x,Je=ce-j,Ue=de/mt.current.initialScale,yt=x+Pe*Ue,xn=j+Je*Ue,Yr=yt-ae*de/2,vn=xn-O*de/2;en({x:Yr,y:vn,scale:de})}}Vn.current=null}))},h=()=>{Vn.current!==null&&(cancelAnimationFrame(Vn.current),Vn.current=null),mt.current=null};return t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("touchmove",l,{passive:!1}),t.addEventListener("touchend",h,{passive:!0}),t.addEventListener("touchcancel",h,{passive:!0}),()=>{t.removeEventListener("touchstart",i),t.removeEventListener("touchmove",l),t.removeEventListener("touchend",h),t.removeEventListener("touchcancel",h)}},[Wt,Me.scale,Me.x,Me.y]);const pa=o.useCallback(()=>{if(typeof window>"u")return null;if(!Re.current){const t=new Audio("/ring.mp3");t.preload="auto",t.loop=!0,t.volume=.9,Re.current=t}return Re.current},[]);function _t(){try{if($.current&&clearTimeout($.current),$.current=null,Re.current)try{Re.current.pause(),Re.current.currentTime=0}catch{}ye.current=null}catch{}}const jo=o.useCallback(()=>{if(typeof window>"u")return null;if(!He.current){const t=new Audio("/dialing.mp3");t.preload="auto",t.loop=!0,t.volume=.7,He.current=t}return He.current},[]);function ga(){try{const t=jo();t&&(t.currentTime=0,t.loop=!0,t.volume=.7,t.play().catch(()=>{}))}catch(t){console.error("Error starting dialing sound:",t)}}function er(){try{if(He.current)try{He.current.pause(),He.current.currentTime=0}catch{}}catch{}}const Co=o.useCallback(()=>{if(typeof window>"u")return null;if(!Le.current){const t=new Audio("/notify.mp3");t.preload="auto",t.volume=.6,Le.current=t}return Le.current},[]);function Ls(){try{const t=Co();t&&(t.currentTime=0,t.volume=.6,t.play().catch(()=>{}))}catch(t){console.error("Error playing end call sound:",t)}}o.useEffect(()=>{const t=async s=>{if(!(s.conversationId===c)){P.invalidateQueries({queryKey:["conversations"]});return}if(!c)return;const l=s.message??s;l&&l.id&&(Lr(h=>{const d=h[c]||[];if(d.length===0)return h;const p=(l.attachments||[]).map(m=>m.url).sort(),w=d.filter(m=>{if(m.senderId!==l.senderId)return!0;const x=m.attachments.map(j=>j.url).sort();return x.length===p.length?!x.every((y,k)=>{const H=p[k];return y===H||y.startsWith("blob:")&&H&&!H.startsWith("blob:")}):!0});if(w.length===d.length)return h;if(w.length===0){const{[c]:m,...x}=h;return x}return{...h,[c]:w}}),Sa(c,l)),Be.refetch()},n=s=>{s.conversationId===c&&(zt(!0),ft.current&&window.clearTimeout(ft.current),ft.current=window.setTimeout(()=>zt(!1),2e3))},r=s=>{if(!c||s.conversationId!==c){P.invalidateQueries({queryKey:["conversations"]});return}s.message?No(c,s.message):Be.refetch()};return _e.on("message:new",t),_e.on("conversation:typing",n),_e.on("message:reaction",r),()=>{_e.off("message:new",t),_e.off("conversation:typing",n),_e.off("message:reaction",r)}},[c]),o.useEffect(()=>{const t=async n=>{if(da(n.conversationId))return;const r=n.senderId===T?.id,s=n.conversationId===c,a=document.visibilityState==="visible";if(!r&&(!s||!a)&&Oe.current&&fe.current&&(Oe.current.currentTime=0,Oe.current.play().catch(()=>{})),s){n.message&&n.message.id&&Sa(c,n.message),Be.refetch().catch(()=>{});return}};return _e.on("message:notify",t),()=>{_e.off("message:notify",t)}},[c,T?.id,Be,da]),o.useLayoutEffect(()=>{if(!c){Ie.current=null,Fe.current=0;return}Ie.current!==c&&(Ie.current=c,Fe.current=0);const t=(Bt?.length??0)+js.length,n=Fe.current;if(Fe.current=t,!be.current||t===0||t<=n)return;const r=[...Bt||[],...js],s=r[r.length-1],a=s?.senderId&&T?.id?s.senderId===T.id:!1;(a||!Ge.current||Ve.current)&&requestAnimationFrame(()=>{const l=be.current;l&&(l.scrollTop=l.scrollHeight,Ve.current=!0,a&&(Ge.current=!1))})},[c,js,Bt,T?.id]),o.useEffect(()=>{if(!c)return;const t=be.current;if(!t)return;const n=()=>{t&&(t.scrollTop=t.scrollHeight,Ve.current=!0,Ge.current=!1)};if(pt.current){n();const r=window.setTimeout(n,50),s=window.setTimeout(n,200);return()=>{window.clearTimeout(r),window.clearTimeout(s)}}n()},[c]),o.useEffect(()=>{if(!pt.current)return;const t=be.current;if(!t)return;const n=()=>{const r=typeof document<"u"?document.activeElement:null;r&&r===z.current&&(t.scrollTop=t.scrollHeight,Ve.current=!0,Ge.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",n,{passive:!0}),window.visualViewport.addEventListener("scroll",n,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",n),window.visualViewport.removeEventListener("scroll",n))}},[c]),o.useEffect(()=>{},[]),o.useEffect(()=>{if(!ze||!pt.current)return;const t=be.current,n=window.setInterval(()=>{we(r=>r%3+1),t&&t.scrollHeight-t.scrollTop-t.clientHeight<80&&(t.scrollTop=t.scrollHeight)},500);return()=>window.clearInterval(n)},[ze]),o.useEffect(()=>{const t=be.current;if(!t)return;let n=0,r=t.scrollTop;const s=()=>{n&&cancelAnimationFrame(n);const a=t.scrollTop;Math.abs(a-r)>1&&(Ge.current=!0),n=requestAnimationFrame(()=>{const l=t.scrollHeight-t.scrollTop-t.clientHeight<8;Ve.current=l,Tt(!l),l&&window.setTimeout(()=>{t.scrollHeight-t.scrollTop-t.clientHeight<40&&(Ge.current=!1)},100),r=t.scrollTop})};return t.addEventListener("scroll",s,{passive:!0}),s(),()=>{t.removeEventListener("scroll",s),n&&cancelAnimationFrame(n)}},[c]),o.useEffect(()=>{const t=()=>{if(!be.current)return;const n=be.current.clientWidth;rt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[c]);function ma(t,n){if(!/^\d?$/.test(n))return;if(t===0&&n&&Yn.some(Boolean)){Ar([n,"","",""]),Gn(null),Tr[1].current?.focus();return}const r=[...Yn];r[t]=n,Ar(r),n&&t<3&&Tr[t+1].current?.focus(),!n&&t>0&&Tr[t-1].current?.focus();const s=r.join("");s.length===4&&/^\d{4}$/.test(s)?(async()=>{try{const a=await J.get("/contacts/search",{params:{query:s}});Gn(a.data.results?.[0]??null)}catch{Gn(null)}})():Gn(null)}o.useEffect(()=>{Ys||(Ar(["","","",""]),Gn(null))},[Ys]);async function So(){Xn(!0);try{const t=await J.get("/status/me");no(t.data.user?.eblid??"")}catch{}}async function Io(){const t=Yn.join("");if(/^\d{4}$/.test(t)){Gs(!0);try{await J.post("/contacts/add",{identifier:t}),Gs(!1)}catch{Gs(!1)}}}function zs(){if(!c||!Be.data||!T?.id)return;const t=Be.data.filter(n=>n.senderId!==T.id).filter(n=>!(n.receipts||[]).some(r=>r.userId===T.id&&(r.status==="READ"||r.status==="SEEN"))).map(n=>n.id);t.length!==0&&J.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{P.invalidateQueries({queryKey:["messages",c]})}).catch(()=>{})}o.useEffect(()=>{document.hasFocus()&&zs(),c&&(J.post("/messages/mark-conversation-read",{conversationId:c}).catch(()=>{}),P.setQueryData(["conversations"],t=>t&&t.map(n=>n.conversation.id===c?{...n,unreadCount:0}:n)))},[c]),o.useEffect(()=>{document.hasFocus()&&zs()},[Be.data]),o.useEffect(()=>{const t=()=>zs(),n=()=>{document.visibilityState==="visible"&&zs()};return window.addEventListener("focus",t),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("focus",t),document.removeEventListener("visibilitychange",n)}},[c,Be.data]);function ko(){bt.current||(bt.current=window.setTimeout(()=>{const t=Array.from(vt.current);vt.current.clear(),bt.current&&clearTimeout(bt.current),bt.current=null,t.length&&J.post("/messages/receipts",{messageIds:t,status:"READ"}).then(()=>{c&&P.invalidateQueries({queryKey:["messages",c]})}).catch(()=>{})},250))}o.useEffect(()=>{if(!c||!Be.data||!T?.id)return;Cn.current?.disconnect();const t=new IntersectionObserver(n=>{for(const r of n){if(!r.isIntersecting||r.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const s=r.target,a=s.dataset.mid;if(!a)continue;const i=Be.data.find(h=>h.id===a);!i||i.senderId===T.id||(i.receipts||[]).some(h=>h.userId===T.id&&(h.status==="READ"||h.status==="SEEN"))||(vt.current.add(a),t.unobserve(s))}vt.current.size&&ko()},{root:be.current,threshold:[.25]});Cn.current=t;for(const n of Be.data){if(n.senderId===T.id||(n.receipts||[]).some(a=>a.userId===T.id&&(a.status==="READ"||a.status==="SEEN")))continue;const s=xt.current.get(n.id);s&&t.observe(s)}return()=>{t.disconnect()}},[c,Be.data,T?.id]),o.useEffect(()=>{const t=()=>{if(!be.current)return;const n=be.current.clientWidth;rt(n>=900)};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[c]);async function pi(t,n="",r){if(!c||t.length===0)return;const s=!!S?.isSecret;if(s){if(As){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!br){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}hs(!0),fr(0);try{const a=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,i=[],l=t.reduce((w,m)=>w+m.size,0);for(const w of t)if(w.type.startsWith("image/")){const m=URL.createObjectURL(w),{width:x,height:j}=await Mo(m);i.push({url:m,type:"IMAGE",width:x,height:j,progress:0,__pending:!0})}else i.push({url:w.name,type:"FILE",__pending:!0,progress:0});Lr(w=>({...w,[c]:[...w[c]||[],{id:a,createdAt:Date.now(),senderId:T?.id||"me",attachments:i,content:n}]}));const h=[];let d=0;for(let w=0;w<t.length;w++){const m=t[w],x=i[w];let j=m,y;if(s&&S){const le=new Uint8Array(await m.arrayBuffer()),de=await un.encryptBinary(S,le);j=new Blob([de.cipher],{type:"application/octet-stream"}),y={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:de.nonce,originalName:m.name,originalType:m.type,originalSize:m.size}}const k=new FormData;k.append("file",j,s?`${m.name||"file"}.enc`:m.name);const W={url:await new Promise((le,de)=>{const q=new XMLHttpRequest;q.open("POST","/api/upload");try{const ae=ir.getState().session?.accessToken;ae&&q.setRequestHeader("Authorization",`Bearer ${ae}`)}catch{}q.upload.onprogress=ae=>{if(ae.lengthComputable){const O=Math.round((d+ae.loaded)/l*100);fr(O),Lr(se=>{const Pe=(se[c]||[]).map(Ue=>({...Ue,attachments:Ue.attachments.map(yt=>({...yt}))})),Je=Pe[Pe.length-1];if(Je){const Ue=Je.attachments.findIndex(yt=>yt.__pending&&yt.type===(m.type.startsWith("image/")?"IMAGE":"FILE")&&(!yt.width||yt.url.startsWith("blob:")));Ue>=0&&(Je.attachments[Ue].progress=O)}return{...se,[c]:Pe}})}},q.onreadystatechange=()=>{if(q.readyState===4)if(q.status>=200&&q.status<300)try{const ae=JSON.parse(q.responseText);le(ae.url)}catch(ae){de(ae)}else de(new Error("upload failed"))},q.send(k)}),type:m.type.startsWith("image/")?"IMAGE":"FILE"},oe={};x&&x.type==="IMAGE"&&x.width&&x.height&&(oe.width=x.width,oe.height=x.height),y&&(oe.e2ee=y),Object.keys(oe).length>0&&(W.metadata=oe),h.push(W),d+=m.size,fr(Math.round(d/l*100))}const p=h.every(w=>w.type==="IMAGE")?"IMAGE":"FILE";await J.post("/conversations/send",{conversationId:c,type:p,content:n,attachments:h,replyToId:r}),Lr(w=>{const x=(w[c]||[]).filter(j=>j.id!==a);if(x.length===0){const{[c]:j,...y}=w;return y}return{...w,[c]:x}}),P.invalidateQueries({queryKey:["messages",c]})}catch(a){console.error("Failed to upload attachments",a)}hs(!1)}async function Mo(t){return new Promise(n=>{const r=new Image;r.onload=()=>n({width:r.naturalWidth,height:r.naturalHeight}),r.onerror=()=>n({width:320,height:200}),r.src=t})}const Ro=async()=>{if(c&&!Fi)try{if(!(await Pa({audio:!0})).ok){alert("ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹");return}_t(),si([]);const n=new yl({onStateChange:r=>{ni(r==="recording"),r!=="recording"&&gr.current&&(clearInterval(gr.current),gr.current=null)},onDurationUpdate:r=>{ri(r)},onAmplitudeUpdate:r=>{si(s=>{const a=M?60:Xi,i=[...s,r];return i.length>a?i.slice(-a):i})},onError:r=>{console.error("Voice recording error:",r),alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"),ya()}});mn.current=n,await n.start()}catch(t){console.error("Failed to start voice recording:",t),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ")}},ya=()=>{if(!mn.current)return;const t=mn.current,n=t.getDuration(),r=t.stop();mn.current=null,ni(!1),ri(0),r&&c&&Ao(r,n)},Eo=()=>{mn.current&&(mn.current.cancel(),mn.current=null),gr.current&&(clearInterval(gr.current),gr.current=null),ni(!1),ri(0),si([])},Ao=async(t,n)=>{if(!c)return;const r=!!S?.isSecret;if(r){if(As){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.");return}if(!br){alert("Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.");return}}hs(!0),fr(0);try{const s=new File([t],"voice-message.webm",{type:t.type||"audio/webm"});let a=s,i;if(r&&S){const p=new Uint8Array(await s.arrayBuffer()),w=await un.encryptBinary(S,p);a=new Blob([w.cipher],{type:"application/octet-stream"}),i={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:w.nonce,originalName:s.name,originalType:s.type,originalSize:s.size}}const l=new FormData;l.append("file",a,r?`${s.name}.enc`:s.name);const d={url:await new Promise((p,w)=>{const m=new XMLHttpRequest;m.open("POST","/api/upload");try{const x=ir.getState().session?.accessToken;x&&m.setRequestHeader("Authorization",`Bearer ${x}`)}catch{}m.upload.onprogress=x=>{if(x.lengthComputable){const j=Math.round(x.loaded/x.total*100);fr(j)}},m.onreadystatechange=()=>{if(m.readyState===4)if(m.status>=200&&m.status<300)try{const x=JSON.parse(m.responseText);p(x.url)}catch(x){w(x)}else w(new Error("upload failed"))},m.send(l)}),type:"AUDIO",size:s.size,...i?{metadata:{e2ee:i}}:{}};await J.post("/conversations/send",{conversationId:c,type:"AUDIO",metadata:{duration:n},attachments:[d],replyToId:ne?.id}),ge(null),P.invalidateQueries({queryKey:["messages",c]})}catch(s){console.error("Failed to send voice message",s),alert("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")}finally{hs(!1),fr(0)}};o.useEffect(()=>()=>{mn.current&&mn.current.cleanup()},[]),o.useEffect(()=>{let t=null;const n=async()=>{const r=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Ki(Math.round(performance.now()-r))}catch{Ki(null)}};return n(),t=window.setInterval(n,15e3),()=>{t&&clearInterval(t)}},[]),o.useEffect(()=>{let t=null;const n=()=>P.invalidateQueries({queryKey:["conversations"]});return t=window.setInterval(n,2e4),()=>{t&&clearInterval(t)}},[P]);const To=o.useMemo(()=>{const t=new Set;try{const n=te.data||[],r=new Map;for(const s of n){const a=s?.conversation;a?.id&&r.set(a.id,a)}for(const[s,a]of Object.entries(yn||{})){if(!a?.active)continue;const i=r.get(s);if(!!!(i&&(i.isGroup||(i.participants?.length??0)>2)))continue;const h=a.participants||[];for(const d of h)t.add(d)}}catch{}return t},[yn,te.data]),xa=o.useMemo(()=>{const t={};try{const n=te.data||[];for(const r of n){const s=r?.conversation;if(!s?.isSecret)continue;const a=(s.secretStatus??"ACTIVE").toString().toUpperCase();if(a!=="ACTIVE"&&a!=="PENDING")continue;const l=(Array.isArray(s.participants)?s.participants:[]).filter(p=>Ne?p?.user?.id!==Ne:!0).map(p=>p?.user).filter(Boolean);if(l.length!==1)continue;const h=l[0]?.id;if(typeof h!="string")continue;(!t[h]||a==="ACTIVE")&&(t[h]=a)}}catch{}return t},[te.data,Ne]),va=o.useMemo(()=>{const t={};try{const n=te.data||[];for(const r of n){const s=r?.conversation;if(!s?.isSecret||(s.secretStatus??"ACTIVE").toString().toUpperCase()!=="ACTIVE")continue;const l=(Array.isArray(s.participants)?s.participants:[]).filter(d=>Ne?d?.user?.id!==Ne:!0).map(d=>d?.user).filter(Boolean);if(l.length!==1)continue;const h=l[0]?.id;typeof h=="string"&&(t[h]=s.id)}}catch{}return t},[te.data,Ne]),tr=o.useMemo(()=>{const t={};try{for(const n of ct.data||[]){const r=n?.friend;r?.id&&(t[r.id]=n)}}catch{}return t},[ct.data]),$r=o.useCallback((t,n)=>{const r=t?.id;!r||typeof r!="string"||ie(s=>s.open&&s.userId===r?{open:!1,userId:null,user:null,contact:null}:{open:!0,userId:r,user:t??null,contact:n??null})},[]),sn=o.useCallback(()=>{ie({open:!1,userId:null,user:null,contact:null})},[]),ba=o.useMemo(()=>{try{const t=S;return!t||t.isGroup||t.isSecret?null:(Array.isArray(t.participants)?t.participants:[]).filter(s=>Ne?s?.user?.id!==Ne:!0).map(s=>s?.user?.id).filter(s=>typeof s=="string")[0]??null}catch{return null}},[S,Ne]);function Xr(t){const n=t?.id?An(t):t?.status??"OFFLINE",r=t.lastSeenAt?new Date(t.lastSeenAt):null;if(n==="ONLINE")return"ÐžÐÐ›ÐÐ™Ð";if(n==="BACKGROUND")return"Ð’ Ð¤ÐžÐÐ•";if(n==="IN_CALL"){const w=typeof t?.id=="string"?t.id:null;return w&&To.has(w)?"Ð’ Ð‘Ð•Ð¡Ð•Ð”Ð•":"Ð’ Ð—Ð’ÐžÐÐšÐ•"}if(!r)return"Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½";const a=new Date().getTime()-r.getTime(),i=Math.floor(a/6e4);if(i<1)return"Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";if(i<60)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${i} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;const l=Math.floor(i/60);if(l<24)return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${l} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;const h={hour:"2-digit",minute:"2-digit"},d=r.toLocaleDateString(),p=r.toLocaleTimeString([],h);return`Ð±Ñ‹Ð»(Ð°) Ð¾Ð½Ð»Ð°Ð¹Ð½ ${d} Ð² ${p}`}function wa(t){const n=Xr(t);return n==="ÐžÐÐ›ÐÐ™Ð"?"Ð¾Ð½Ð»Ð°Ð¹Ð½":n==="Ð’ Ð¤ÐžÐÐ•"?"Ð² Ñ„Ð¾Ð½Ðµ":n==="Ð’ Ð—Ð’ÐžÐÐšÐ•"?"Ð² Ð·Ð²Ð¾Ð½ÐºÐµ":n==="Ð’ Ð‘Ð•Ð¡Ð•Ð”Ð•"?"Ð² Ð±ÐµÑÐµÐ´Ðµ":n}function gi(t){const n=Math.max(0,Math.floor(t/1e3)),r=Math.floor(n/3600),s=Math.floor(n%3600/60),a=n%60;return r>0?`${r}:${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`:`${s}:${String(a).padStart(2,"0")}`}function ja(t){const n=t?"conversations-list slider-panel":"conversations-list";return e.jsxs("aside",{className:n,children:[e.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{className:"logo",children:[e.jsx("span",{children:"Ð•"}),e.jsx("span",{className:"b",children:"Ð‘"}),e.jsx("span",{children:"Ð»ÑƒÑˆÐ°"})]}),e.jsx("div",{className:"subtitle",children:"Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹ Ð¾Ð±Ñ‰Ð°ÐµÐ¼ÑÑ"})]})}),e.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx("div",{ref:Ye,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:te.data?.slice().sort((r,s)=>{const a=r.conversation.messages?.[0]?.createdAt?new Date(r.conversation.messages[0].createdAt).getTime():0;return(s.conversation.messages?.[0]?.createdAt?new Date(s.conversation.messages[0].createdAt).getTime():0)-a}).filter(r=>{const s=r.conversation;return!(s.isSecret&&(s.secretStatus??"ACTIVE")!=="ACTIVE")}).map(r=>{const s=r.conversation,a=s.participants.filter(j=>Ne?j.user.id!==Ne:!0).map(j=>j.user),i=a.map(j=>j.displayName??j.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",l=s.title??i,h=s.isGroup||s.participants.length>2,d=!!s.isSecret;a.map(j=>j.displayName??j.username).join(", ");const p=c===s.id,m=!!yn[s.id]?.active,x=f===s.id;return e.jsxs("div",{onContextMenu:j=>{j.preventDefault(),j.stopPropagation(),!t&&Xt({open:!0,x:j.clientX,y:j.clientY,conversationId:s.id})},onClick:()=>nn(s.id),className:"tile",style:{...r.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...p?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...m?{background:x?"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)":"linear-gradient(135deg, rgba(217, 119, 6, 0.10) 0%, rgba(227, 139, 10, 0.12) 100%)",borderColor:"var(--brand-600)",...x?p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.22), 0 6px 16px rgba(227,139,10,0.14)"}:p?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.16)"}}:{}},children:[h?e.jsx(qe,{name:l?.trim()?.charAt(0)||"Ð“",id:s.id,avatarUrl:s.avatarUrl&&s.avatarUrl.trim()?s.avatarUrl:void 0,presence:m?"IN_CALL":void 0}):e.jsx("button",{type:"button",onClick:j=>{j.preventDefault(),j.stopPropagation();const y=a[0],k=y?.id?tr[y.id]:null;$r(y,k?{id:k.id,status:k.status,direction:k.direction}:null)},style:{padding:0,border:0,background:"transparent",cursor:"pointer"},"aria-label":"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ",children:e.jsx(qe,{name:a[0]?.displayName??a[0]?.username??"D",id:a[0]?.id??s.id,presence:m?"IN_CALL":An(a[0]),avatarUrl:a[0]?.avatarUrl&&a[0].avatarUrl.trim()?a[0].avatarUrl:void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{children:l}),!h&&d&&e.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:e.jsx(xi,{size:12,color:"#22c55e"})})]}),e.jsx("div",{style:{fontSize:12,color:r.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:r.unreadCount>0?`${r.unreadCount} Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…`:(()=>{const j=yn[s.id];if(j?.active){const y=j.startedAt?Date.now()-j.startedAt:typeof j.elapsedMs=="number"?j.elapsedMs:0;return e.jsx("span",{children:gi(y)})}else if(j&&j.endedAt){const y=j.endedAt,H=Date.now()-y,W=Math.floor(H/6e4);if(W<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(W<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",W," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const oe=Math.floor(W/60);if(oe<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",oe," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const le=new Date(y),de=le.toLocaleDateString(),q=le.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",de," Ð² ",q]})}return h?null:Xr(a[0]??{})})()})]}),t&&e.jsx("button",{type:"button","aria-label":"ÐœÐµÐ½ÑŽ Ð±ÐµÑÐµÐ´Ñ‹",title:"ÐœÐµÐ½ÑŽ",onClick:j=>{j.preventDefault(),j.stopPropagation();const y=j.currentTarget.getBoundingClientRect();Xt({open:!0,x:Math.round(y.right-8),y:Math.round(y.bottom+6),conversationId:s.id})},style:{flexShrink:0,width:36,height:36,borderRadius:10,border:"1px solid transparent",background:"transparent",color:"var(--text-muted)",display:"inline-flex",alignItems:"center",justifyContent:"center",marginLeft:8,WebkitTapHighlightColor:"transparent"},children:e.jsx(Sr,{size:20})})]},s.id)})}),kt&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),it&&e.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),e.jsxs("div",{className:"conv-footer",children:[e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsxs("div",{style:{display:"flex",gap:12},children:[e.jsxs("div",{onClick:()=>es(!0),className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Ic,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"Ð‘ÐµÑÐµÐ´Ð°"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"})]})]}),e.jsxs("div",{onClick:So,className:"tile",style:{marginTop:0,flex:1},children:[e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:rn.data&&rn.data.length>0?e.jsx(mc,{size:22}):ct.data&&ct.data.length>0?e.jsx(qc,{size:22}):e.jsx(Ha,{size:22})}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:rn.data&&rn.data.length>0?"ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Ð´Ñ€ÑƒÐ·ÑŒÑ":ct.data&&ct.data.length>0?"Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})]})]}),e.jsxs("div",{className:"tile",onClick:()=>Nr(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const s=(()=>{const m=T?.id;if(v?.conversationId||f||C||X.activeConvId)return!0;if(m)try{for(const x of Object.values(yn||{}))if(x?.active&&Array.isArray(x.participants)&&x.participants.includes(m))return!0}catch{}return!1})()?"IN_CALL":lo??Gt.data?.status,a=co?"ONLINE":"OFFLINE",i=(s??a??"OFFLINE").toString().toUpperCase(),l=["ONLINE","AWAY","BACKGROUND","IN_CALL","OFFLINE"],h=i,d=a,p=l.includes(h)?h:d,w=Gt.data?.avatarUrl??T?.avatarUrl??void 0;return e.jsx(qe,{name:T?.displayName??T?.username??"Me",id:T?.id??"me",presence:p,avatarUrl:w})})(),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:T?.displayName??T?.username??"Ð¯"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Gt.data?.eblid??"â€” â€” â€” â€”"]})]})]})]})]})]})}function Ca(t){const n=t?"messages-pane slider-panel":"messages-pane",r=As,s=br;let a="";return S?.isSecret&&(r?a="Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°.":bo?a=la?`Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Â«${la}Â»`:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñ‘Ð½ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.":s||(a="Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...")),e.jsxs("section",{className:n,children:[e.jsxs("header",{style:{...c?yn[c]?.active||C===c?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:M?"column":"row",justifyContent:M?"flex-start":"space-between",alignItems:M?"stretch":"center",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:M?"100%":"auto",padding:M?"0 8px":"0"},children:[t&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:vo,children:e.jsx(pc,{size:18})}),S?(()=>{const i=S.participants.filter(m=>Ne?m.user.id!==Ne:!0).map(m=>m.user),l=i.map(m=>m.displayName??m.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",h=S.title??l,d=S.isGroup||S.participants.length>2;S.isSecret;const p=yn[S.id],w=p?.active;return d?e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>st(!0),style:{cursor:"pointer"},children:e.jsx(qe,{name:h?.trim()?.charAt(0)||"Ð“",id:S.id,size:60,avatarUrl:S.avatarUrl&&S.avatarUrl.trim()?S.avatarUrl:void 0,presence:w?"IN_CALL":void 0})}),e.jsxs("div",{style:{flex:1,minWidth:0,order:M?1:2},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[e.jsx("span",{children:h}),M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:m=>{xe({open:!0,anchor:m.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(Sr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:w?e.jsx(e.Fragment,{children:(()=>{const m=p.participants||[],x=S.participants||[],j=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsxs(e.Fragment,{children:[p.active&&e.jsx("span",{children:gi(j)}),x.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[p.startedAt&&" â€¢ ",x.map((y,k)=>{const H=y.user,W=m.length>0&&m.includes(H.id);return e.jsxs("span",{style:{fontWeight:W?700:400,color:W?"var(--brand-600)":"var(--text-muted)"},children:[k>0&&", ",H.displayName??H.username,W&&" âœ“"]},H.id)})]})]})})()}):p&&p.endedAt?(()=>{const m=p.endedAt,j=Date.now()-m,y=Math.floor(j/6e4);let k="";if(y<1)k="Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾";else if(y<60)k=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${y} Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´`;else{const W=Math.floor(y/60);if(W<24)k=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${W} Ñ‡ Ð½Ð°Ð·Ð°Ð´`;else{const oe=new Date(m),le=oe.toLocaleDateString(),de=oe.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});k=`Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ${le} Ð² ${de}`}}const H=S.participants||[];return e.jsxs(e.Fragment,{children:[e.jsx("span",{children:k}),H.length>0&&e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" â€¢ ",H.map((W,oe)=>{const le=W.user;return e.jsxs("span",{children:[oe>0&&", ",le.displayName??le.username]},le.id)})]})]})})():i.map(m=>m.displayName??m.username).join(", ")})]})]}):(()=>{const m=i[0];return e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx("button",{type:"button",onClick:x=>{x.preventDefault(),x.stopPropagation();const j=m?.id?tr[m.id]:null;$r(m,j?{id:j.id,status:j.status,direction:j.direction}:null)},style:{padding:0,border:0,background:"transparent",cursor:"pointer"},"aria-label":"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ",children:e.jsx(qe,{name:m?.displayName??m?.username??"D",id:m?.id??S.id,avatarUrl:m?.avatarUrl&&m.avatarUrl.trim()?m.avatarUrl:void 0,presence:p?.active?"IN_CALL":An(m),size:60})})}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[e.jsx("span",{children:h}),M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:x=>{xe({open:!0,anchor:x.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:e.jsx(Sr,{size:20})})]}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const x=C===c;if((p?.active||x)&&p){const j=p.startedAt?Date.now()-p.startedAt:typeof p.elapsedMs=="number"?p.elapsedMs:0;return e.jsx("span",{children:gi(j)})}if(p&&p.endedAt&&!x){const j=p.endedAt,k=Date.now()-j,H=Math.floor(k/6e4);if(H<1)return e.jsx("span",{children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾"});if(H<60)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",H," Ð¼Ð¸Ð½ Ð½Ð°Ð·Ð°Ð´"]});const W=Math.floor(H/60);if(W<24)return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",W," Ñ‡ Ð½Ð°Ð·Ð°Ð´"]});const oe=new Date(j),le=oe.toLocaleDateString(),de=oe.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("span",{children:["Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ",le," Ð² ",de]})}return m?Xr(m):""})()})]})]})})()})():e.jsx("div",{children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚"})]}),fo&&S&&!!S.isSecret&&(S.participants?.length??0)<=2&&typeof document<"u"&&kr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:M?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Br(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:M?16:20,borderRadius:M?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:M?"center":"left"},onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:M?"column":"row",gap:M?8:0},children:[e.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚?"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Br(!1),style:{alignSelf:M?"flex-end":void 0},children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹ Ñƒ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."}),e.jsxs("div",{style:{display:"flex",justifyContent:M?"center":"flex-end",alignItems:"center",flexDirection:M?"column":"row",gap:M?12:8},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>Br(!1),style:M?{width:"100%"}:void 0,children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:M?"100%":void 0},onClick:async()=>{if(c)try{await J.delete(`/conversations/${c}`),P.invalidateQueries({queryKey:["conversations"]}),P.removeQueries({queryKey:["messages",c]}),Br(!1),u(null)}catch(i){console.error("Failed to end secret conversation:",i)}},children:"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ"})]})]})}),document.body),c&&(()=>{const i=yn[c],l=i?.active,h=S?.isGroup||(S?.participants.length??0)>2,d=C===c,p=f===c&&!d,w=T?.id,m=h&&l&&w&&i?.participants?.includes(w),x=!h&&(d||f===c||X.activeConvId===c||l&&(X.activeConvId===c||f===c)),j=m||x,y={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:M?"8px 12px":"12px 16px",flex:M?1:"auto",minWidth:M?0:"auto",fontSize:M?"14px":"15px",fontWeight:M?500:600,height:M?"42px":"46px",minHeight:M?"42px":"46px",boxSizing:"border-box"},k={display:"flex",alignItems:"center",gap:8,width:M?"100%":"auto",padding:M?"0 8px":"0",justifyContent:M?"center":"flex-end",marginLeft:M?0:"auto"},H={display:"inline-flex",alignItems:"center",justifyContent:"center",width:M?42:44,height:M?42:44,minWidth:M?42:44,padding:0,margin:0,borderRadius:999},W=async()=>{if(c&&await ks(!1))try{Is(c),za(c,!1),X.startOutgoing(c,!1),Rt(O=>{const se=O[c],ce=T?.id;return se?.active?ce&&se.participants&&!se.participants.includes(ce)?{...O,[c]:{...se,participants:[...se.participants,ce]}}:O:{...O,[c]:{startedAt:Date.now(),active:!0,participants:ce?[ce]:[]}}});const q=te.data?.find(O=>O.conversation.id===c)?.conversation;if(q?.isGroup||(q?.participants?.length??0)>2)b(c),I(O=>O===c?null:O);else{const O=c;L({conversationId:O,startedAt:Date.now(),video:!1}),ga(),N.current&&window.clearTimeout(N.current),N.current=window.setTimeout(()=>{L(se=>se?.conversationId===O?(er(),Ls(),Kr(O),Rt(ce=>{const Pe=ce[O];if(Pe?.active)return{...ce,[O]:{...Pe,active:!1,endedAt:Date.now()}};const{[O]:Je,...Ue}=ce;return Ue}),X.endCall(),null):se),N.current=null},3e4)}}catch(q){console.error("Error starting call:",q)}},oe=async()=>{if(c&&await ks(!0))try{Is(c),za(c,!0),X.startOutgoing(c,!0),Rt(O=>{const se=O[c],ce=T?.id;return se?.active?ce&&se.participants&&!se.participants.includes(ce)?{...O,[c]:{...se,participants:[...se.participants,ce]}}:O:{...O,[c]:{startedAt:Date.now(),active:!0,participants:ce?[ce]:[]}}});const q=te.data?.find(O=>O.conversation.id===c)?.conversation;if(q?.isGroup||(q?.participants?.length??0)>2)b(c),I(O=>O===c?null:O);else{const O=c;L({conversationId:O,startedAt:Date.now(),video:!0}),ga(),N.current&&window.clearTimeout(N.current),N.current=window.setTimeout(()=>{L(se=>se?.conversationId===O?(er(),Ls(),Kr(O),Rt(ce=>{const Pe=ce[O];if(Pe?.active)return{...ce,[O]:{...Pe,active:!1,endedAt:Date.now()}};const{[O]:Je,...Ue}=ce;return Ue}),X.endCall(),null):se),N.current=null},3e4)}}catch(q){console.error("Error starting call:",q)}},le=()=>{c&&(b(c),I(null))},de=()=>l||d?j?e.jsxs(e.Fragment,{children:[!p&&e.jsxs("button",{className:"btn btn-secondary",onClick:le,style:y,children:[e.jsx(Ba,{size:M?16:18}),M?"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ":" Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"]}),e.jsxs("button",{className:"btn",onClick:()=>{const q=S?.participants?.length??0,ae=q<=2,O=S?.isGroup||q>2;if(ae&&f)Kr(f),Rt(se=>{const ce=se[f];return ce?.active?{...se,[f]:{...ce,active:!1,endedAt:Date.now()}}:se});else if(O&&f){try{ic(f)}catch{}Rt(se=>{const ce=se[f];if(!ce||!ce.participants)return se;const Pe=T?.id;return!Pe||!ce.participants.includes(Pe)?se:{...se,[f]:{...ce,participants:ce.participants.filter(Je=>Je!==Pe)}}})}b(null),I(null),X.endCall(),_t()},style:{...y,background:"#ef4444",color:"#fff"},children:[e.jsx(ji,{size:M?16:18}),M?"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ":" Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:q=>{xe({open:!0,anchor:q.currentTarget})},style:H,children:e.jsx(Sr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){b(c),I(ae=>ae===c?null:ae),X.startOutgoing(c,!1);try{La(c,!1)}catch{}}else b(c),I(ae=>ae===c?null:ae),X.startOutgoing(c,!1)},style:y,children:[e.jsx(vi,{size:M?16:18}),M?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(S?.isGroup||(S?.participants?.length??0)>2){b(c),I(ae=>ae===c?null:ae),X.startOutgoing(c,!0);try{La(c,!0)}catch{}}else b(c),I(ae=>ae===c?null:ae),X.startOutgoing(c,!0)},style:y,children:[e.jsx(Ci,{size:M?16:18}),M?"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾":" ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ Ð²Ð¸Ð´ÐµÐ¾"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:q=>{xe({open:!0,anchor:q.currentTarget})},style:H,children:e.jsx(Sr,{size:22})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{W()},style:y,children:[e.jsx(vi,{size:M?16:18}),M?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº":" Ð—Ð²Ð¾Ð½Ð¾Ðº"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>{oe()},style:y,children:[e.jsx(Ci,{size:M?16:18}),M?" ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾":" Ð’Ð¸Ð´ÐµÐ¾"]}),!M&&e.jsx("button",{className:"btn btn-icon btn-ghost",title:"ÐœÐµÐ½ÑŽ",onClick:q=>{xe({open:!0,anchor:q.currentTarget})},style:H,children:e.jsx(Sr,{size:22})})]});return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:k,children:de()}),hr&&e.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:M?"100%":420,width:M?"100%":"auto"},children:[e.jsx("span",{style:{flex:1},children:hr}),e.jsx("button",{type:"button",onClick:()=>Dr(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:e.jsx(Lt,{size:14})})]})]})})()]}),!S?.isSecret&&wr&&e.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:M?"column":"row",gap:12,alignItems:M?"stretch":"center"},children:wr.isInitiator?e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1},children:"Ð–Ð´Ñ‘Ð¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚."}),e.jsx("div",{style:{display:"flex",gap:8},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>oa(wr.conversationId),disabled:ai,style:{color:"#f87171"},children:"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{flex:1},children:[wr.initiatorName," Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÑ‚ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ."]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>go(wr.conversationId),disabled:ai,children:"ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ"}),e.jsx("button",{className:"btn btn-ghost",onClick:()=>oa(wr.conversationId),disabled:ai,style:{color:"#bae6fd"},children:"ÐžÑ‚ÐºÐ°Ð·Ð°Ñ‚ÑŒÑÑ"})]})]})}),e.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),e.jsx("div",{ref:be,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:c?S?.isSecret&&(!s||r)?e.jsx("div",{className:"messages-empty",children:a}):(()=>{const i=(Bt?[...Bt]:[]).filter(d=>!d.deletedAt).sort((d,p)=>new Date(d.createdAt||0).getTime()-new Date(p.createdAt||0).getTime()),l=js,h=[...i||[],...l];return h?h.map((d,p)=>{if(d.deletedAt)return null;if(d.type==="SYSTEM")return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:d.content})},d.id);const w=h[p-1],m=h[p+1],x=!m||m.senderId!==d.senderId,j=!!w&&w.senderId===d.senderId,y=d.senderId===T?.id,W=`${nt?"msg left":y?"msg me":"msg them"} ${j?"compact":"gap"}`,oe=nt?"msg-bubble left":y?"msg-bubble me":"msg-bubble them",le=x?`${oe} ${y&&!nt?"tail-right":"tail-left"}`:oe,de=fa[d.senderId],q=de?.displayName??de?.username??(y?T?.displayName??T?.username??"Me":"User"),ae=de?.id??(y?T?.id??"me":"user"),O=y?"#303845":wo(d.senderId),se="#f1f3f6",ce=nt&&x,Pe=nt,Je=d.createdAt?new Date(d.createdAt):null,Ue=Je?Je.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",yt=(S?.participants||[]).map(B=>B.user.id).filter(B=>Ne?B!==Ne:!0),xn=d.receipts||[],Yr=y&&yt.some(B=>xn.some(me=>me.userId===B&&(me.status==="READ"||me.status==="SEEN"))),vn=y&&Yr?"âœ“":"",Ps=(B,me)=>{K({open:!0,x:B,y:me,messageId:d.id})},Do=B=>{B.preventDefault(),Ps(B.clientX,B.clientY)},Lo=()=>{const B=d.replyTo?.id;if(!B)return;const me=xt.current.get(B);me&&me.scrollIntoView({behavior:"smooth",block:"center"})},Ia=(d.attachments||[]).filter(B=>B?.type==="IMAGE").map(B=>Ts(B)).filter(B=>!!B),ka=B=>{const me=Ia.findIndex(lt=>lt===B);ei({open:!0,index:me>=0?me:0,items:Ia})},zo=M?{}:{onContextMenu:Do,...{onPointerDown:B=>{const me=window.setTimeout(()=>Ps(B.clientX,B.clientY),450),lt=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",lt),window.removeEventListener("pointermove",Tn)},Tn=()=>{window.clearTimeout(me),window.removeEventListener("pointerup",lt),window.removeEventListener("pointermove",Tn)};window.addEventListener("pointerup",lt,{passive:!0}),window.addEventListener("pointermove",Tn,{passive:!0})}}};return e.jsxs("div",{className:W,...zo,children:[Pe&&(ce?e.jsx(qe,{name:q,id:ae,avatarUrl:(()=>{const B=fa[d.senderId]?.avatarUrl;return B&&B.trim()?B:void 0})()}):e.jsx("div",{className:"avatar-spacer"})),e.jsxs("div",{className:le,"data-mid":d.id,ref:B=>{if(!B){xt.current.delete(d.id);return}xt.current.set(d.id,B),Cn.current?.observe(B)},style:{"--bubble-bg":O,"--bubble-fg":se},onClick:B=>{if(!M||B.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const lt=typeof window.getSelection=="function"?window.getSelection():null;lt&&lt.toString()||Ps(B.clientX,B.clientY)},onContextMenu:B=>{if(B.target.closest(".reaction-emoji")){B.preventDefault(),B.stopPropagation();return}Ps(B.clientX,B.clientY)},children:[d.reactions&&d.reactions.length>0&&(()=>{const B={};for(const me of d.reactions)B[me.emoji]||(B[me.emoji]={count:0,hasMine:!1}),B[me.emoji].count++,me.userId===T?.id&&(B[me.emoji].hasMine=!0);return e.jsx("div",{style:{position:"absolute",bottom:-18,right:y?8:void 0,left:y?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(B).map(([me,lt],Tn)=>{const an=me==="â¤ï¸"?"#ef4444":"#ffc46b";return e.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async nr=>{nr.preventDefault(),nr.stopPropagation();try{lt.hasMine?await J.post("/messages/unreact",{messageId:d.id,emoji:me}):await J.post("/messages/react",{messageId:d.id,emoji:me}),c&&P.invalidateQueries({queryKey:["messages",c]})}catch(mi){console.error("Error toggling reaction:",mi)}},onMouseDown:nr=>{nr.stopPropagation()},style:{fontSize:12,color:an,display:"inline-block",animation:`reactionBounce 0.6s ease ${Tn*.1}s`,cursor:"pointer",opacity:lt.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[me,lt.count>1?` ${lt.count}`:""]},me)})})})(),d.replyTo&&e.jsxs("div",{onClick:Lo,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:y?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°: ",d.replyTo.content??"ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:d.content}),(()=>{const B=d.attachments||[],me=B.filter(Ze=>Ze?.type==="IMAGE"),lt=typeof d.content=="string"?d.content.trim().length>0:!!d.content,Tn=B.some(Ze=>Ze?.type&&Ze.type!=="IMAGE"),Us=me.length>0&&!lt&&!Tn,an=[];let nr=!1;B.forEach((Ze,ve)=>{if(Ze?.type==="IMAGE"){nr||(an.push({kind:"imageGroup",atts:me}),nr=!0);return}an.push({kind:"single",att:Ze,idx:ve})});const mi=Ze=>{if(!Ze.length)return null;if(Ze.length===1){const Q=Ze[0],tt=0,dt=Q.metadata??{},$e=Ts(Q),Xe=!!(S?.isSecret&&dt?.e2ee?.kind==="ciphertext"),ut=Xe?Qn[Q.url]:void 0,Et=Xe&&!$e&&(!ut||ut.status==="pending"),Dt=Xe&&ut?.status==="error",rr=typeof window<"u"?window.innerWidth:1280,Dn=rr<=768?Math.max(320,Math.floor(rr/2)):Math.min(600,Math.max(320,Math.floor(rr/3))),Hs=`${Q.url||tt}`,Gr=ea[Hs],Ln=Gr?.width||Q.width||Q.metadata?.width||Dn,jr=Gr?.height||Q.height||Q.metadata?.height||Math.round(Ln*.75),on=jr/Ln||.75,bn=Dn;let Ft=Dn;on<.5?Ft=Math.max(Math.round(Dn*.6),200):on<.7&&(Ft=Math.max(Math.round(Dn*.75),200));const Po=Ln>bn?bn/Ln:1,Uo=jr>Ft?Ft/jr:1,Ma=Math.min(Po,Uo,1);let zn=Ln*Ma,cn=jr*Ma;zn>bn&&(zn=bn,cn=zn*on),cn>Ft&&(cn=Ft,zn=cn/on),zn=Math.round(zn),cn=Math.round(cn);const sr=`${Q.url||tt}`,yi=!!Ji[sr],Ra=!!Zi[sr],Ws=Q.__pending||Et||!yi&&!Ra;return e.jsxs("div",{style:{maxWidth:"100%",maxHeight:cn,width:Ws?Math.min(zn,typeof window<"u"?window.innerWidth-100:zn):"fit-content",height:Ws?cn:"auto",minWidth:0,minHeight:Ws?cn:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Us&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:Ue}),!!vn&&e.jsx("span",{children:vn})]}),Ws&&e.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),Et?e.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ..."}):typeof Q.progress=="number"&&Q.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[Q.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Dt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"}),Ra&&!Dt&&e.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ"}),$e&&!Dt&&e.jsx("img",{src:$e,alt:"img",style:{maxWidth:"100%",maxHeight:cn,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:d.id?.startsWith("tmp-")?"default":"zoom-in",opacity:Q.__pending?.85:1,display:yi?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:qr=>{const Bs=qr.target;if(!Q.width&&!dt?.width&&Bs.naturalWidth&&Bs.naturalHeight&&ta(Pn=>({...Pn,[sr]:{width:Bs.naturalWidth,height:Bs.naturalHeight}})),bs(Pn=>({...Pn,[sr]:!1})),vs(Pn=>({...Pn,[sr]:!0})),be.current&&Ve.current){const Pn=be.current;Pn.scrollTop=Pn.scrollHeight}},onError:()=>{bs(qr=>({...qr,[sr]:!0})),vs(qr=>({...qr,[sr]:!0}))},onClick:()=>{!Q.__pending&&!Et&&$e&&ka($e)}}),yi&&!Et&&typeof Q.progress=="number"&&Q.progress<100&&e.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:e.jsx("div",{style:{width:`${Q.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`images-single-${Q.url||tt}`)}const ve=Ze.slice(0,4),et=Ze.length-ve.length,Nt=(Q,tt)=>{const dt=Q?.metadata??{},$e=`${Q?.url||tt}`,Xe=ea[$e],ut=Xe?.width||Q?.width||dt?.width,Et=Xe?.height||Q?.height||dt?.height,Dt=typeof ut=="number"&&typeof Et=="number"&&ut>0&&Et>0?Et/ut:1;return Math.max(.2,Math.min(5,Number.isFinite(Dt)?Dt:1))},Ot=(Q,tt,dt)=>{const $e=Q.metadata??{},Xe=Ts(Q),ut=!!(S?.isSecret&&$e?.e2ee?.kind==="ciphertext"),Et=ut?Qn[Q.url]:void 0,Dt=ut&&!Xe&&(!Et||Et.status==="pending"),rr=ut&&Et?.status==="error",Nn=`${Q.url||tt}`,Dn=!!Ji[Nn],Hs=!!Zi[Nn],Gr=Q.__pending||Dt||!Dn&&!Hs,Ln=Q.__pending||Dt||rr||!Xe,jr=Nt(Q,tt);return e.jsxs("button",{type:"button",className:"msg-media-tile",style:{aspectRatio:1/jr},disabled:Ln,onClick:()=>{!Ln&&Xe&&ka(Xe)},children:[Xe&&e.jsx("img",{src:Xe,alt:"img",style:{opacity:Dn&&!Gr?1:.001},onLoad:on=>{const bn=on.target;!Q.width&&!$e?.width&&bn.naturalWidth&&bn.naturalHeight&&ta(Ft=>({...Ft,[Nn]:{width:bn.naturalWidth,height:bn.naturalHeight}})),bs(Ft=>({...Ft,[Nn]:!1})),vs(Ft=>({...Ft,[Nn]:!0}))},onError:()=>{bs(on=>({...on,[Nn]:!0})),vs(on=>({...on,[Nn]:!0}))}}),Gr&&e.jsxs("div",{className:"msg-media-overlay",children:[e.jsx("div",{className:"msg-media-overlay-shimmer"}),Dt?e.jsx("div",{style:{position:"relative",zIndex:2,color:"var(--text-muted)",fontSize:12},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°..."}):typeof Q.progress=="number"&&Q.progress<100?e.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[Q.progress,"%"]})]}):e.jsx("div",{style:{position:"relative",zIndex:2,width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),(rr||Hs)&&e.jsx("div",{className:"msg-media-overlay",style:{background:"rgba(15, 23, 42, 0.55)"},children:e.jsx("div",{style:{position:"relative",zIndex:2,color:"#f87171",fontSize:12,padding:10,textAlign:"center"},children:rr?"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ¸":"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸"})}),dt&&e.jsxs("div",{className:"msg-media-more",children:["+",et]})]},`${Q.url||tt}`)};return e.jsxs("div",{className:"msg-media-grid",children:[Us&&e.jsxs("div",{className:"msg-media-meta",children:[e.jsx("span",{children:Ue}),!!vn&&e.jsx("span",{children:vn})]}),ve.length===2&&(()=>{const Q=Nt(ve[0],0),dt=Nt(ve[1],1),$e=Q;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${dt} 1 0`,minWidth:0},children:Ot(ve[0],0,!1)}),e.jsx("div",{style:{flex:`${$e} 1 0`,minWidth:0},children:Ot(ve[1],1,et>0&&ve.length-1===1)})]})})(),ve.length===3&&(()=>{const Q=Nt(ve[0],0),tt=Nt(ve[1],1),dt=Nt(ve[2],2),$e=tt+dt,Xe=Q;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:`${$e} 1 0`,minWidth:0},children:Ot(ve[0],0,!1)}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${Xe} 1 0`},children:[Ot(ve[1],1,!1),Ot(ve[2],2,et>0&&ve.length-1===2)]})]})})(),ve.length>=4&&(()=>{const Q=Nt(ve[0],0),tt=Nt(ve[1],1),dt=Nt(ve[2],2),$e=Nt(ve[3],3),Xe=tt+$e,ut=Q+dt;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"msg-media-col",style:{flex:`${Xe} 1 0`},children:[Ot(ve[0],0,!1),Ot(ve[2],2,!1)]}),e.jsxs("div",{className:"msg-media-col",style:{flex:`${ut} 1 0`},children:[Ot(ve[1],1,!1),Ot(ve[3],3,et>0)]})]})})()]},"images-mosaic")};return e.jsx(e.Fragment,{children:an.map((Ze,ve)=>{if(Ze.kind==="imageGroup")return e.jsx(o.Fragment,{children:mi(Ze.atts)},"images-group");const et=Ze.att,Nt=Ze.idx,Ot=et.metadata??{},Q=Ts(et),tt=!!(S?.isSecret&&Ot?.e2ee?.kind==="ciphertext"),dt=tt?Qn[et.url]:void 0,$e=tt&&!Q&&(!dt||dt.status==="pending"),Xe=tt&&dt?.status==="error",ut=Ot?.e2ee?.originalName||et.url?.split("/").pop()||"Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ";if(et.type==="AUDIO"){const Et=d.metadata?.duration||0,Dt=Q||et.url;return e.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:$e?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[e.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx("span",{style:{fontSize:13},children:"Ð Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ° Ð°ÑƒÐ´Ð¸Ð¾..."})]}):Xe?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°ÑƒÐ´Ð¸Ð¾"}):Dt?e.jsx(Sl,{url:Dt,duration:Et}):e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"})},`${et.url}-${Nt}-${ve}`)}return e.jsxs("div",{style:{marginTop:8},children:[et.__pending||$e?e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Ð¤Ð°Ð¹Ð»: ",ut,$e&&" (Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²ÐºÐ°...)"]}):Xe?e.jsx("div",{style:{color:"#f87171",fontSize:12},children:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»"}):e.jsxs("a",{href:Q||et.url,target:"_blank",rel:"noreferrer",download:ut,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Ð¤Ð°Ð¹Ð»: ",ut]}),typeof et.progress=="number"&&et.progress<100&&e.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:e.jsx("div",{style:{width:`${et.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${et.url}-${Nt}-${ve}`)})})})()]}),(()=>{const B=d.attachments||[],me=typeof d.content=="string"?d.content.trim().length>0:!!d.content,lt=B.some(an=>an?.type&&an.type!=="IMAGE");return B.some(an=>an?.type==="IMAGE")&&!me&&!lt?null:e.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[Ue," ",vn]})})()]})]},d.id)}):null})():e.jsx("div",{className:"messages-empty",children:"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ"})}),c&&e.jsx("button",{className:Jt?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{be.current&&be.current.scrollTo({top:be.current.scrollHeight,behavior:"smooth"}),Ve.current=!0,Ge.current=!1,Tt(!1)},children:"â†“"}),e.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:i=>{i.preventDefault(),ti(!0)},onDragLeave:()=>ti(!1),onDrop:async i=>{i.preventDefault(),ti(!1);const l=Array.from(i.dataTransfer.files||[]);if(!l.length||!c)return;const h=l.filter(p=>p.type.startsWith("image/")),d=l.filter(p=>!p.type.startsWith("image/"));h.forEach(p=>Wr(p,"upload")),d.length&&await pi(d)},children:S?.isSecret&&(!s||r)?e.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:a}):e.jsxs(e.Fragment,{children:[ne&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsx(Bc,{size:16,color:"var(--text-muted)"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð°:"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:ne.preview}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>ge(null),style:{marginLeft:"auto",flexShrink:0},children:e.jsx(Lt,{size:16})})]}),gn.length>0&&e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¾Ð¹"}),e.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:gn.map(i=>e.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[e.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{gs===i.id&&tn(null),ao(i.id)},"aria-label":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx(Lt,{size:14})}),e.jsx("button",{type:"button",onClick:()=>tn(i.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ",children:e.jsx("img",{src:i.previewUrl,alt:i.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:i.fileName}),e.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>tn(i.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),i.edited&&e.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"})]})]},i.id))})]}),e.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:re,onChange:async i=>{const l=Array.from(i.target.files||[]);if(!c||l.length===0)return;const h=l.filter(p=>p.type.startsWith("image/")),d=l.filter(p=>!p.type.startsWith("image/"));h.forEach(p=>Wr(p,"upload")),d.length&&await pi(d),i.target.value=""}}),Fi?e.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[e.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),e.jsx("div",{ref:Hr,style:{width:"100%",...M?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const d=M?60:Xi;return Ur.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(d).fill(0).map((p,w)=>e.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${w*.1}s`,flexShrink:0}},w))}):e.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:Ur.length>d?`translateX(-${(Ur.length-d)*4}px)`:"translateX(0)",transition:"none"},children:Ur.slice(-d).map((p,w)=>{const m=Math.max(4,p/100*20);return e.jsx("div",{style:{width:2,height:`${m}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${Ur.length-d+w}-${w}`)})})})()}),e.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor($i/60),":",($i%60).toString().padStart(2,"0")]})]}),e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:Eo,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ",children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:ya,style:{flexShrink:0},"aria-label":"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:e.jsx(Oa,{size:16})})]}):e.jsxs("form",{autoComplete:"off",onSubmit:async i=>{if(i.preventDefault(),!c)return;const l=G.trim();if(gn.length>0){const h=gn.map(d=>({file:d.file,previewUrl:d.previewUrl}));Pr([]),tn(null),h.forEach(d=>Jn(d.previewUrl)),await pi(h.map(d=>d.file),l||"",ne?.id),F(""),ge(null)}else l&&(await ca(S,{type:"TEXT",content:l,replyToId:ne?.id}),F(""),ge(null));P.invalidateQueries({queryKey:["messages",c]}),setTimeout(()=>{be.current&&(be.current.scrollTop=be.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>re.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹",children:[e.jsx(Uc,{size:16}),!M&&e.jsx("span",{children:"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),e.jsx("input",{type:"text",placeholder:gn.length>0?"Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼...":"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...",value:G,onChange:i=>F(i.target.value),onPaste:i=>{if(!c)return;const l=i.clipboardData?.items;if(l)for(let h=0;h<l.length;h++){const d=l[h];if(d.type.indexOf("image")!==-1){i.preventDefault();const p=d.getAsFile();p&&Wr(p,"paste");break}}},ref:z,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:Ro,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:[e.jsx(Dc,{size:16}),!M&&e.jsx("span",{children:"Ð“Ð¾Ð»Ð¾Ñ"})]}),e.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:M?0:6,height:46,minHeight:46,padding:"0 12px"},children:[e.jsx(Oa,{size:16}),!M&&e.jsx("span",{children:"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]}),so&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:e.jsx("div",{style:{width:`${io}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),e.jsx(o.Suspense,{fallback:null,children:f&&e.jsx(bl,{open:!!f,conversationId:f,minimized:C===f,peerAvatarUrl:(()=>{const l=(f?te.data?.find(h=>h.conversation.id===f)?.conversation:S)?.participants||[];return l.length===2?l.find(d=>Ne?d.user.id!==Ne:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const l=(f?te.data?.find(d=>d.conversation.id===f)?.conversation:S)?.participants||[],h={};for(const d of l){const p=d.user,w=p.displayName??p.username??p.id;h[w]=p.avatarUrl??null}return T&&(h[T.displayName??T.username??T.id]=Gt.data?.avatarUrl??T.avatarUrl??null),h})(),avatarsById:(()=>{const l=(f?te.data?.find(d=>d.conversation.id===f)?.conversation:S)?.participants||[],h={};for(const d of l){const p=d.user;h[p.id]=p.avatarUrl??null}return T&&(h[T.id]=Gt.data?.avatarUrl??T.avatarUrl??null),h})(),localUserId:T?.id??null,isGroup:!!(f?te.data?.find(l=>l.conversation.id===f)?.conversation:S)?.isGroup,onMinimize:()=>{if(f){const i=f;I(i);const l=Ss(i);!!!(l?.isGroup||(l?.participants?.length??0)>2)&&X.activeConvId!==i&&X.startOutgoing(i,X.initialVideo),f!==i&&b(i)}},onClose:i=>{const l=f??Zn.current;if(!l||C===l)return;const h=()=>{const d=Ss(l),p=d?.participants?.length??0,w=!!(d?.isGroup||p>2);!w&&Kr(l),Rt(x=>{const j=x[l];if(!j)return x;if(w){const y=(j.participants||[]).filter(k=>Ne?k!==Ne:!0);return{...x,[l]:{...j,participants:y}}}return j.active?{...x,[l]:{...j,active:!1,endedAt:Date.now()}}:x}),b(x=>x===l?null:x),I(x=>x===l?null:x),X.endCall(),_t()};!i?.manual&&yr(l)?ci(l,h):(En(l),h())},initialVideo:X.initialVideo,initialAudio:X.initialAudio})}),e.jsx(Vc,{open:!!Cs,image:Cs,onClose:()=>tn(null),onApply:({file:i,previewUrl:l})=>{Cs&&(oo(Cs.id,i,l),tn(null))}}),v&&(()=>{const i=te.data?.find(y=>y.conversation.id===v.conversationId)?.conversation,l=i?.isGroup||(i?.participants?.length??0)>2;if(l)return null;let h="ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",d,p=v.conversationId;if(l)h=i?.title??"Ð“Ñ€ÑƒÐ¿Ð¿Ð°",d=i?.avatarUrl,p=v.conversationId;else{const y=i?.participants?.find(k=>k.user.id!==T?.id)?.user;if(y)h=y.displayName??y.username??y.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",d=y.avatarUrl,p=y.id;else{const k=ct.data?.find(H=>(H.conversationIds||[]).includes(v.conversationId));k?.friend&&(h=k.friend.displayName??k.friend.username??k.friend.id??"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹",d=k.friend.avatarUrl,p=k.friend.id)}}const w=Math.floor((Date.now()-v.startedAt)/1e3),m=Math.floor(w/60),x=w%60,j=`${m}:${x.toString().padStart(2,"0")}`;return kr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700},children:v.video?"Ð’Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð—Ð²Ð¾Ð½Ð¾Ðº"}),!v.minimized&&e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{L(y=>y?{...y,minimized:!0}:null)},style:{padding:8},children:e.jsx(zc,{size:18})})]}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[e.jsx(qe,{name:h,id:p,size:64,avatarUrl:d}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:h}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð´Ð¾Ð·Ð²Ð¾Ð½â€¦"})]}),e.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:j})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{N.current&&(window.clearTimeout(N.current),N.current=null),er(),Ls(),Kr(v.conversationId),L(null),Rt(y=>{const k=y[v.conversationId];if(k?.active)return{...y,[v.conversationId]:{...k,active:!1,endedAt:Date.now()}};const{[v.conversationId]:H,...W}=y;return W}),X.endCall()},children:[e.jsx(ji,{size:18}),e.jsx("span",{children:"Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ"})]}),v.minimized&&e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{L(y=>y?{...y,minimized:!1}:null)},children:[e.jsx(Ba,{size:18}),e.jsx("span",{children:"Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ"})]})]})]})}),document.body)})(),X.incoming&&kr.createPortal(e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:e.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700,marginBottom:12},children:X.incoming.video?"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº":"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð°ÑƒÐ´Ð¸Ð¾Ð·Ð²Ð¾Ð½Ð¾Ðº"}),e.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[e.jsx(qe,{name:X.incoming.from.name??X.incoming.from.id,id:X.incoming.from.id,size:64,avatarUrl:X.incoming.from.avatarUrl??te.data?.find(i=>i.conversation.id===X.incoming.conversationId)?.conversation?.participants?.find(i=>i.user.id===X.incoming.from.id)?.user?.avatarUrl??ct.data?.find(i=>i.friend?.id===X.incoming.from.id)?.friend?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:16},children:X.incoming.from.name??X.incoming.from.id}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ð·Ð²Ð¾Ð½Ð¸Ñ‚â€¦"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ms(!1)},children:[e.jsx(vi,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ"})]}),e.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ms(!0)},children:[e.jsx(Ci,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ Ð²Ð¸Ð´ÐµÐ¾"})]})]}),e.jsx("div",{style:{display:"flex"},children:e.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{di()},children:[e.jsx(ji,{size:18}),e.jsx("span",{children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})]})}),hr&&e.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:hr})]})]})}),document.body)]})}function Sa(t,n){n&&P.setQueryData(["messages",t],r=>{const s=Array.isArray(r)?[...r]:[];return s.some(a=>a.id===n.id)||(s.push(n),s.sort((a,i)=>new Date(a.createdAt||0).getTime()-new Date(i.createdAt||0).getTime())),s})}function No(t,n){n&&P.setQueryData(["messages",t],r=>{if(!Array.isArray(r))return r;const s=r.findIndex(i=>i.id===n.id);if(s===-1)return r;const a=[...r];return a[s]={...a[s],...n},a})}return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:M?"chats-page mobile-slider":"chats-page",children:M?e.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${At==="conversation"?"-100vw":"0"})`},onTouchStart:t=>{const n=t.touches[0];Sn.current={x:n.clientX,y:n.clientY},hn.current=0},onTouchMove:t=>{if(!Sn.current)return;const n=t.touches[0];hn.current=n.clientX-Sn.current.x},onTouchEnd:()=>{const t=hn.current;Sn.current=null,!(Math.abs(t)<50)&&(t<0&&c&&pe("conversation"),t>0&&pe("list"))},children:[ja(!0),Ca(!0)]}):e.jsxs(e.Fragment,{children:[ja(!1),Ca(!1)]})}),ro&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Nr(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(qe,{name:T?.displayName??T?.username??"Me",id:T?.id??"me",avatarUrl:Ht??Gt.data?.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:T?.displayName??T?.username}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",Gt.data?.eblid??"â€” â€” â€” â€”"]})]})]}),e.jsx("input",{ref:Ui,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){rs(n);try{ss(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Ht&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>Ui.current?.click(),onDragOver:t=>{t.preventDefault(),Js(!0)},onDragLeave:()=>Js(!1),onDrop:t=>{t.preventDefault(),Js(!1);const n=t.dataTransfer.files?.[0];if(n){rs(n);try{ss(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Bi?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Bi?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(bi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),Ht&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:qn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,ke.scale*(1+n))),s=qn.current?.getBoundingClientRect();if(s){const a=t.clientX-s.left,i=t.clientY-s.top,l=r/ke.scale,h=a-(a-ke.x)*l,d=i-(i-ke.y)*l;Mn({x:h,y:d,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=qn.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,a=r/2,i=s/2,h=240/2,d=t.clientX-n.left,p=t.clientY-n.top,w=d-a,m=p-i;if(w*w+m*m>h*h)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const x=t.clientX,j=t.clientY,y={...ke},k=W=>{W.preventDefault();const oe=W.clientX-x,le=W.clientY-j;Mn({...y,x:y.x+oe,y:y.y+le})},H=()=>{window.removeEventListener("pointermove",k),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",k,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:Vs,src:Ht,alt:"preview",style:{position:"absolute",left:ke.x,top:ke.y,transform:`scale(${ke.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=qn.current;if(!r)return;const s=r.clientWidth,a=r.clientHeight,i=240,l=n.naturalWidth,h=n.naturalHeight,d=s/2,p=a/2,w=i/l,m=i/h,x=Math.max(w,m)*1.2,j=d-l*x/2,y=p-h*x/2;Mn({x:j,y,scale:x})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(ke.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Mn(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.05,value:ke.scale,onChange:t=>Mn(n=>({...n,scale:parseFloat(t.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Mn(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:e.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:M?"Ð”Ð²Ð° Ð¿Ð°Ð»ÑŒÑ†Ð° Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°, Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ":"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ, ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾ Ð¼Ñ‹ÑˆÐ¸ Ð´Ð»Ñ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð°"})})]}),e.jsx("canvas",{ref:is,width:240,height:240,style:{display:"none"}})]}),Ks&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{rs(null),Ht&&URL.revokeObjectURL(Ht),ss(null)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:dr,onClick:async()=>{if(Ks){ns(!0),as(0);try{let t=null;if(is.current&&Ht){const s=await new Promise(y=>{const k=new Image;k.onload=()=>y(k),k.src=Ht}),a=is.current.getContext("2d"),i=240;a.clearRect(0,0,i,i),a.save(),a.beginPath(),a.arc(i/2,i/2,i/2,0,Math.PI*2),a.closePath(),a.clip();const l=qn.current?.clientWidth??320,h=qn.current?.clientHeight??320,d={x:l/2,y:h/2},p={x:d.x-i/2,y:d.y-i/2,w:i,h:i},w=(p.x-ke.x)/ke.scale,m=(p.y-ke.y)/ke.scale,x=p.w/ke.scale,j=p.h/ke.scale;a.drawImage(s,w,m,x,j,0,0,i,i),a.restore(),t=await new Promise(y=>is.current.toBlob(k=>y(k),"image/png"))}const n=new FormData;n.append("file",t??Ks);const r=await new Promise((s,a)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const l=ir.getState().session?.accessToken;l&&i.setRequestHeader("Authorization",`Bearer ${l}`)}catch{}i.upload.onprogress=l=>{l.lengthComputable&&as(Math.round(100*l.loaded/l.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const l=JSON.parse(i.responseText);s(l.url)}catch(l){a(l)}else a(new Error("upload failed"))},i.send(n)});await J.patch("/status/me",{avatarUrl:r}),rs(null),Ht&&URL.revokeObjectURL(Ht),ss(null),Gt.refetch()}catch{}ns(!1),ur("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ur(null),2200)}},children:dr?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),dr&&e.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Pi}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),fs&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[e.jsx(Wa,{size:16}),e.jsx("span",{children:fs})]}),e.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:e.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await J.post("/auth/logout")}catch{}ir.getState().setSession(null),Nr(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[e.jsx(wi,{size:18}),e.jsx("span",{children:"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð•Ð±Ð»ÑƒÑˆÐ¸"})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:e.jsx("button",{className:"btn btn-ghost",onClick:()=>Nr(!1),children:"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"})})]})}),Za&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>kn(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"ÐÐ²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>kn(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(qe,{name:_n.trim()||"?",id:"new-group-avatar-preview",avatarUrl:Ut??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:_n||"ÐÐ¾Ð²Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:Fs,type:"file",accept:"image/*",style:{display:"none"},onChange:t=>{const n=t.target.files?.[0];if(n){if(On(n),Mt)try{URL.revokeObjectURL(Mt)}catch{}try{const r=URL.createObjectURL(n);Fn(r)}catch{Fn(null)}Zt({x:0,y:0,scale:1})}}}),!Mt&&e.jsx(e.Fragment,{children:e.jsxs("div",{onClick:()=>Fs.current?.click(),onDragOver:t=>{t.preventDefault(),Xs(!0)},onDragLeave:()=>Xs(!1),onDrop:t=>{t.preventDefault(),Xs(!1);const n=t.dataTransfer.files?.[0];if(n){if(On(n),Mt)try{URL.revokeObjectURL(Mt)}catch{}try{const r=URL.createObjectURL(n);Fn(r)}catch{Fn(null)}Zt({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(zi?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:zi?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(bi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})}),Mt&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:$n,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Qe.scale*(1+n))),s=$n.current?.getBoundingClientRect();if(s){const a=t.clientX-s.left,i=t.clientY-s.top,l=r/Qe.scale,h=a-(a-Qe.x)*l,d=i-(i-Qe.y)*l;Zt({x:h,y:d,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=$n.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,a=r/2,i=s/2,h=240/2,d=t.clientX-n.left,p=t.clientY-n.top,w=d-a,m=p-i;if(w*w+m*m>h*h)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const x=t.clientX,j=t.clientY,y={...Qe},k=W=>{W.preventDefault();const oe=W.clientX-x,le=W.clientY-j;Zt({...y,x:y.x+oe,y:y.y+le})},H=()=>{window.removeEventListener("pointermove",k),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",k,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:eo,src:Mt,alt:"preview",style:{position:"absolute",left:Qe.x,top:Qe.y,transform:`scale(${Qe.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=$n.current;if(!r)return;const s=r.clientWidth,a=r.clientHeight,i=240,l=n.naturalWidth,h=n.naturalHeight,d=s/2,p=a/2,w=i/l,m=i/h,x=Math.max(w,m)*1.2,j=d-l*x/2,y=p-h*x/2;Zt({x:j,y,scale:x})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Zt(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:4,step:.01,value:Qe.scale,onChange:t=>{const n=parseFloat(t.target.value),r=$n.current?.getBoundingClientRect();if(!r){Zt(d=>({...d,scale:n}));return}const s=r.width/2,a=r.height/2,i=n/Qe.scale,l=s-(s-Qe.x)*i,h=a-(a-Qe.y)*i;Zt({x:l,y:h,scale:n})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Zt(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:$s,width:240,height:240,style:{display:"none"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[e.jsx("button",{className:"btn btn-ghost",onClick:()=>{kn(!1)},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:!Mt,onClick:async()=>{if(!Mt||!$s.current){kn(!1);return}try{const t=await new Promise(j=>{const y=new Image;y.onload=()=>j(y),y.src=Mt}),n=$s.current,r=n.getContext("2d");if(!r)throw new Error("Could not get 2d context");const s=240;r.clearRect(0,0,s,s),r.save(),r.beginPath(),r.arc(s/2,s/2,s/2,0,Math.PI*2),r.closePath(),r.clip();const a=$n.current?.clientWidth??320,i=$n.current?.clientHeight??320,l={x:a/2,y:i/2},h={x:l.x-s/2,y:l.y-s/2,w:s,h:s},d=(h.x-Qe.x)/Qe.scale,p=(h.y-Qe.y)/Qe.scale,w=h.w/Qe.scale,m=h.h/Qe.scale;r.drawImage(t,d,p,w,m,0,0,s,s),r.restore();const x=await new Promise(j=>n.toBlob(y=>j(y),"image/png"));if(x){if(Ut)try{URL.revokeObjectURL(Ut)}catch{}const j=URL.createObjectURL(x);Li(x),In(j)}}catch{}finally{kn(!1)}},children:"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"})]})]})}),or&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:fi,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[e.jsx("div",{style:{fontWeight:700},children:"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:fi,children:e.jsx(Lt,{size:16})})]}),(()=>{const t=_n.trim(),n=t||"?";return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[e.jsx("input",{placeholder:"ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ",value:_n,onChange:r=>ts(r.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),e.jsx("input",{ref:Fs,type:"file",accept:"image/*",style:{display:"none"},onChange:r=>{const s=r.target.files?.[0];if(s){if(On(s),Mt)try{URL.revokeObjectURL(Mt)}catch{}try{const a=URL.createObjectURL(s);Fn(a)}catch{Fn(null)}kn(!0)}}}),e.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>kn(!0),title:"Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:e.jsx(qe,{name:n,id:"new-group-avatar",avatarUrl:Ut??void 0,size:40})})]})})(),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:ct.data?.map(t=>{const n=t.friend,r=cr.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>Er(s=>r?s.filter(a=>a!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0},children:[e.jsx(qe,{name:n.displayName??n.username,id:n.id,presence:An(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:r?"Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾":"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx("input",{type:"checkbox",readOnly:!0,checked:r})})]},t.id)})}),e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:e.jsx("button",{className:"btn btn-primary",disabled:cr.length===0||wt,onClick:async()=>{if(!(cr.length===0||wt)){ot(!0);try{const t=await J.post("/conversations",{participantIds:cr,title:_n||void 0,isGroup:!0}),n=t.data?.conversation?.id;if(n&&(Di||lr))try{const r=new FormData;r.append("file",Di??lr);const s=await new Promise((a,i)=>{const l=new XMLHttpRequest;l.open("POST","/api/upload");try{const h=ir.getState().session?.accessToken;h&&l.setRequestHeader("Authorization",`Bearer ${h}`)}catch{}l.onreadystatechange=()=>{if(l.readyState===4)if(l.status>=200&&l.status<300)try{const h=JSON.parse(l.responseText);a(h.url)}catch(h){i(h)}else i(new Error(`upload failed: ${l.status} ${l.statusText}`))},l.onerror=()=>i(new Error("Network error during upload")),l.send(r)});await J.patch(`/conversations/${n}`,{avatarUrl:s})}catch(r){console.error("Error setting group avatar:",r)}P.invalidateQueries({queryKey:["conversations"]}),t.data?.conversation?.id&&nn(t.data.conversation.id),fi()}catch(t){console.error("Error creating group:",t),alert(t?.response?.data?.message||"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ")}finally{ot(!1)}}},children:wt?"Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ...":"Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ"})})]})}),Ys&&e.jsxs("div",{className:"contacts-overlay",onClick:()=>{if(ht.open){St({open:!1,x:0,y:0,contactId:null,user:null});return}Xn(!1)},role:"dialog","aria-modal":"true",children:[e.jsxs("div",{className:"contacts-modal",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"contacts-modal__header",children:[e.jsx("div",{className:"contacts-modal__title",children:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{St({open:!1,x:0,y:0,contactId:null,user:null}),Xn(!1)},"aria-label":"Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",children:e.jsx(Lt,{size:16})})]}),e.jsxs("div",{className:"contacts-modal__body",children:[rn.data&&rn.data.length>0&&e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"}),e.jsx("div",{className:"contacts-section__list",children:rn.data.map(t=>e.jsxs("div",{className:"tile",onClick:()=>$r(t.friend,{id:t.id,status:t.status,direction:t.direction}),style:{cursor:"pointer"},children:[e.jsx(qe,{name:t.friend.displayName??t.friend.username,id:t.friend.id,presence:t.friend.status,avatarUrl:t.friend.avatarUrl??void 0}),e.jsxs("div",{className:"contacts-tile__main",children:[e.jsx("div",{className:"contacts-tile__name",children:t.friend.displayName??t.friend.username}),e.jsx("div",{className:"contacts-tile__meta",children:"Ñ…Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ"})]})]},t.id))})]}),e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ EBLID"}),e.jsx("div",{className:"contacts-section__hint",children:"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 4 Ñ†Ð¸Ñ„Ñ€Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ."}),e.jsx("div",{className:"contacts-eblid__inputs",children:[0,1,2,3].map(t=>e.jsx("input",{ref:Tr[t],className:"contacts-eblid__digit",type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:Yn[t],onChange:n=>ma(t,n.target.value.replace(/\D/g,"").slice(0,1)),onKeyDown:n=>{if(/^\d$/.test(n.key)){n.preventDefault(),ma(t,n.key);return}if(n.key!=="Backspace")return;if(n.preventDefault(),Yn[t]!==""){const s=[...Yn];s[t]="",Ar(s),Gn(null);return}if(t<=0)return;const r=[...Yn];r[t-1]="",Ar(r),Gn(null),Tr[t-1].current?.focus()},maxLength:1},t))}),pn&&e.jsxs("div",{className:"tile contacts-found",style:{marginTop:12},children:[e.jsx(qe,{name:pn.displayName??pn.username,id:pn.id,presence:An(pn),avatarUrl:pn.avatarUrl??void 0}),e.jsxs("div",{className:"contacts-tile__main",children:[e.jsx("div",{className:"contacts-tile__name",children:pn.displayName??pn.username}),e.jsx("div",{className:"contacts-tile__meta",children:wa(pn)})]}),e.jsx("div",{className:"contacts-actions",children:e.jsx("button",{disabled:to,className:"btn btn-primary",onClick:Io,children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})})]}),e.jsxs("div",{className:"contacts-my-eblid",children:[e.jsx("div",{className:"contacts-my-eblid__label",children:"ÐœÐ¾Ð¹ EBLID:"}),e.jsx("div",{className:"contacts-my-eblid__value",children:qs||"â€” â€” â€” â€”"}),e.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{qs&&navigator.clipboard.writeText(qs)},title:"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID","aria-label":"Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ EBLID",children:e.jsx(uc,{size:16})})]})]}),e.jsxs("section",{className:"contacts-section",children:[e.jsx("div",{className:"contacts-section__title",children:"ÐœÐ¾Ð¸ Ð´Ñ€ÑƒÐ·ÑŒÑ"}),e.jsx("div",{className:"contacts-friends__list",children:(ct.data||[]).length===0?e.jsx("div",{className:"contacts-empty",children:"ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð´Ñ€ÑƒÐ·ÐµÐ¹. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚ Ð¿Ð¾ EBLID."}):(ct.data||[]).map(t=>{const n=t.friend,r=typeof n?.id=="string"?xa[n.id]:void 0,s=typeof n?.id=="string"&&ba?n.id===ba:!1,a=n.displayName??n.username;return e.jsxs("div",{className:`contacts-nav-item ${s?"is-active":""}`,role:"button",tabIndex:0,onContextMenu:i=>{i.preventDefault(),i.stopPropagation();const l=i.currentTarget.getBoundingClientRect(),p=Math.min(i.clientX,window.innerWidth-220-12),w=Math.min(l.bottom+6,window.innerHeight-180);St({open:!0,x:p,y:w,contactId:t.id,user:n})},onKeyDown:async i=>{if(i.key!=="Enter"&&i.key!==" ")return;i.preventDefault();const l=await J.post("/conversations",{participantIds:[n.id],isGroup:!1});St({open:!1,x:0,y:0,contactId:null,user:null}),Xn(!1),nn(l.data.conversation.id),P.invalidateQueries({queryKey:["conversations"]})},onClick:async()=>{const i=await J.post("/conversations",{participantIds:[n.id],isGroup:!1});St({open:!1,x:0,y:0,contactId:null,user:null}),Xn(!1),nn(i.data.conversation.id),P.invalidateQueries({queryKey:["conversations"]})},children:[e.jsx("button",{type:"button",onClick:i=>{i.preventDefault(),i.stopPropagation(),$r(n,{id:t.id,status:t.status,direction:t.direction})},style:{padding:0,border:0,background:"transparent",cursor:"pointer"},"aria-label":"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ",children:e.jsx(qe,{name:a,id:n.id,presence:An(n),avatarUrl:n.avatarUrl??void 0})}),e.jsxs("div",{className:"contacts-nav-item__main",children:[e.jsxs("div",{className:"contacts-nav-item__name-row",children:[e.jsx("div",{className:"contacts-nav-item__name",title:a,children:a}),r&&e.jsx("div",{className:`contacts-secret-badge ${r==="PENDING"?"is-pending":""}`,title:r==="PENDING"?"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ (Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ)":"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚","aria-label":r==="PENDING"?"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ (Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ)":"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚",children:e.jsx(xi,{size:14})})]}),e.jsx("div",{className:"contacts-nav-item__status",children:wa(n)})]}),e.jsx("button",{type:"button",className:"contacts-menu-btn","aria-label":"ÐœÐµÐ½ÑŽ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°","aria-haspopup":"menu",onClick:i=>{i.preventDefault(),i.stopPropagation();const l=i.currentTarget.getBoundingClientRect(),p=Math.min(l.right,window.innerWidth-220-12),w=Math.min(l.bottom+6,window.innerHeight-180);St({open:!0,x:p,y:w,contactId:t.id,user:n})},children:"â‹¯"})]},t.id)})})]})]})]}),ht.open&&ht.contactId&&ht.user&&e.jsx("div",{className:"contacts-menu-overlay",onClick:t=>{t.preventDefault(),t.stopPropagation(),St({open:!1,x:0,y:0,contactId:null,user:null})},children:e.jsxs("div",{ref:U,className:"ctx-menu",style:{position:"fixed",left:ht.x,top:ht.y},onClick:t=>t.stopPropagation(),role:"menu",children:[e.jsx("button",{type:"button",role:"menuitem",onClick:async()=>{const t=ht.user.id,n=await J.post("/conversations",{participantIds:[t],isGroup:!1});St({open:!1,x:0,y:0,contactId:null,user:null}),Xn(!1),nn(n.data.conversation.id),P.invalidateQueries({queryKey:["conversations"]})},children:"ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ‡Ð°Ñ‚"}),e.jsx("button",{type:"button",role:"menuitem",onClick:async()=>{const t=ht.user.id;await ui(t),St({open:!1,x:0,y:0,contactId:null,user:null}),Xn(!1),P.invalidateQueries({queryKey:["conversations"]})},children:"Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"}),e.jsx("button",{type:"button",role:"menuitem",className:"ctx-menu__danger",onClick:async()=>{await J.post("/contacts/remove",{contactId:ht.contactId}),St({open:!1,x:0,y:0,contactId:null,user:null}),ct.refetch()},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚"})]})})]}),Ee.open&&Ee.messageId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>K({open:!1,x:0,y:0,messageId:null}),children:e.jsxs("div",{ref:ia,className:"msg-menu",style:{position:"absolute",left:Ee.x,top:Ee.y,color:"#ffffff"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["ðŸ‘","â¤ï¸","ðŸ‘Ž","ðŸ”¥","ðŸ¤","ðŸ˜†"].map((t,n)=>{const s=t==="â¤ï¸"?"#ef4444":"#ffffff";return e.jsx("button",{onClick:async()=>{try{const a=Ee.messageId;((Bt||[]).find(h=>h.id===a)?.reactions||[]).some(h=>h.userId===T?.id&&h.emoji===t)?await J.post("/messages/unreact",{messageId:a,emoji:t}):await J.post("/messages/react",{messageId:a,emoji:t}),c&&P.invalidateQueries({queryKey:["messages",c]})}catch{}K({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:s,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${n*.05}s both`},onMouseEnter:a=>{a.currentTarget.style.transform="scale(1.2)"},onMouseLeave:a=>{a.currentTarget.style.transform="scale(1)"},children:t},t)})}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const t=Ee.messageId,n=(Bt||[]).find(r=>r.id===t);ge({id:t,preview:(n?.content??"").slice(0,100)}),K({open:!1,x:0,y:0,messageId:null})},children:"Ð¦Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),(()=>{const t=Ee.messageId;return(Bt||[]).find(s=>s.id===t)?.senderId===T?.id?e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await J.post("/messages/delete",{messageId:Ee.messageId}),c&&P.invalidateQueries({queryKey:["messages",c]})}catch{}K({open:!1,x:0,y:0,messageId:null})},children:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"}):null})(),e.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const t=Ee.messageId,n=(Bt||[]).find(r=>r.id===t);try{await navigator.clipboard.writeText(n?.content||"")}catch{}K({open:!1,x:0,y:0,messageId:null})},children:"ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}),e.jsx("button",{style:{color:"#ffffff"},onClick:()=>{Bn({open:!0,messageId:Ee.messageId}),K({open:!1,x:0,y:0,messageId:null})},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ"})]})}),e.jsx(Qc,{open:Zs.open,items:Zs.items,index:Zs.index,onClose:()=>ei(t=>({...t,open:!1})),onIndexChange:t=>ei(n=>({...n,index:t}))}),Rr.open&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>Bn({open:!1,messageId:null}),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ"}),e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(te.data||[]).map(t=>{const n=t.conversation,s=n.participants.filter(i=>Ne?i.user.id!==Ne:!0).map(i=>i.user).map(i=>i.displayName??i.username).join(", ")||"Ð”Ð¸Ð°Ð»Ð¾Ð³",a=n.title??s;return e.jsx("div",{className:"tile",onClick:async()=>{const i=Rr.messageId,l=(Bt||[]).find(h=>h.id===i);l&&(await ca(n,{type:"TEXT",content:`â†ª ${l.content??""}`,replyToId:void 0}),Bn({open:!1,messageId:null}))},children:e.jsx("div",{style:{fontWeight:600},children:a})},n.id)})}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>Bn({open:!1,messageId:null}),children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"})})]})}),ar&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:xr,children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:xr,children:e.jsx(Lt,{size:18})})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Ð˜Ð· Ð´Ñ€ÑƒÐ·ÐµÐ¹"},{key:"eblid",label:"ÐŸÐ¾ EBLID"}].map(t=>{const n=A===t.key;return e.jsx("button",{className:"btn btn-ghost",onClick:()=>V(t.key),style:{flex:1,borderRadius:999,border:n?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:n?"var(--surface-100)":"transparent",color:n?"var(--text-primary)":"var(--text-muted)",fontWeight:n?600:500},children:t.label},t.key)})}),e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:A==="friends"?"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ Ð² ÑÑ‚Ñƒ Ð±ÐµÑÐµÐ´Ñƒ.":"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ EBLID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ð±ÐµÑÐµÐ´Ñƒ."}),A==="friends"?e.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:ha.length===0?e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ ÑƒÐ¶Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ."}):ha.map(t=>{const n=t.friend,r=g.includes(n.id);return e.jsxs("div",{className:"tile",onClick:()=>D(s=>r?s.filter(a=>a!==n.id):[...s,n.id]),style:{cursor:"pointer",borderColor:r?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[e.jsx(qe,{name:n.displayName??n.username,id:n.id,presence:An(n),avatarUrl:n.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:n.displayName??n.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Xr(n)})]}),e.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:r?"var(--brand-600)":"transparent"}})]},t.id)})}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[e.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(t=>e.jsx("input",{ref:je[t],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:ee[t],onChange:n=>xo(t,n.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},t))}),Yt&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñâ€¦"}),he&&e.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[e.jsx(qe,{name:he.displayName??he.username,id:he.id,presence:he.status,avatarUrl:he.avatarUrl??void 0}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600},children:he.displayName??he.username}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Ns.alreadyInChat?"Ð£Ð¶Ðµ Ð² Ð±ÐµÑÐµÐ´Ðµ":Ns.isSelf?"Ð­Ñ‚Ð¾ Ð²Ñ‹":"ÐÐ°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ EBLID"})]})]}),!he&&Te&&e.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:Te})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[e.jsx("button",{className:"btn btn-secondary",onClick:xr,children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:R||(A==="friends"?g.length===0:!he||Ns.alreadyInChat||Ns.isSelf),onClick:A==="friends"?mo:yo,children:R?"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ...":"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ"})]})]})}),Ae.open&&Ae.conversationId&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Xt({open:!1,x:0,y:0,conversationId:null}),children:e.jsx("div",{ref:Kt,className:"msg-menu",style:{position:"absolute",left:Ae.x,top:Ae.y},onClick:t=>t.stopPropagation(),children:(()=>{const n=(te.data||[]).find(a=>a.conversation.id===Ae.conversationId)?.conversation||(c===Ae.conversationId?S:null),r=!!(n&&(n.isGroup||(n.participants?.length??0)>2)),s=async()=>{try{r?await J.delete(`/conversations/${Ae.conversationId}/participants/me`):await J.delete(`/conversations/${Ae.conversationId}`),P.invalidateQueries({queryKey:["conversations"]}),c===Ae.conversationId&&(u(null),M&&pe("list"))}catch{}Xt({open:!1,x:0,y:0,conversationId:null})};return e.jsxs("button",{onClick:s,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r?e.jsx(wi,{size:16}):e.jsx(Ua,{size:16}),r?"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹":"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ"]})})()})}),ue.open&&ue.anchor&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>xe({open:!1,anchor:null}),children:e.jsx("div",{ref:Se,className:"msg-menu",style:{position:"fixed"},onClick:t=>t.stopPropagation(),children:(()=>{const t=S.isGroup||(S.participants?.length??0)>2,n=!!S.isSecret&&!t,r=!t&&S.participants?.find(s=>s.user.id!==Ne)?.user;return t?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{D([]),V("friends"),_(["","","",""]),Ce(null),We(null),It(!1),Zr(!0),xe({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Ha,{size:16}),"Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²"]}),e.jsxs("button",{onClick:async()=>{if(c){try{await J.delete(`/conversations/${c}/participants/me`),P.invalidateQueries({queryKey:["conversations"]}),u(null),M&&pe("list")}catch(s){console.error("Failed to leave conversation:",s)}xe({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(wi,{size:16}),"Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð±ÐµÑÐµÐ´Ñ‹"]}),e.jsx("div",{style:{height:8}}),e.jsx("div",{style:{padding:"6px 10px",color:"var(--text-muted)",fontSize:12,fontWeight:700},children:"Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¸"}),(S.participants||[]).map(s=>s.user).filter(s=>Ne?s.id!==Ne:!0).slice(0,30).map(s=>{const a=s.displayName??s.username??"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ";return e.jsxs("button",{type:"button",onClick:()=>{const i=s?.id?tr[s.id]:null;$r(s,i?{id:i.id,status:i.status,direction:i.direction}:null),xe({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:10},children:[e.jsx(qe,{name:a,id:s.id,avatarUrl:s.avatarUrl??void 0,presence:An(s)}),e.jsx("span",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a})]},s.id)})]}):e.jsxs(e.Fragment,{children:[n?e.jsxs("button",{onClick:()=>{Br(!0),xe({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(Ec,{size:16}),"Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}):e.jsxs("button",{onClick:async()=>{r?.id&&await ui(r.id),xe({open:!1,anchor:null})},disabled:ra,style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(xi,{size:16}),"ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚"]}),e.jsxs("button",{onClick:async()=>{if(c){try{await J.delete(`/conversations/${c}`),P.invalidateQueries({queryKey:["conversations"]}),P.removeQueries({queryKey:["messages",c]}),u(null),M&&pe("list")}catch(s){console.error("Failed to delete conversation:",s)}xe({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[e.jsx(Ua,{size:16}),"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚"]})]})})()})}),e.jsx(fc,{open:E.open,isMobile:M,user:E.user,meId:T?.id??null,statusText:E.user?Xr(E.user):"",idLabel:E.user?.eblid?"EBLID":"ID",idValue:(E.user?.eblid??E.user?.id??"").toString(),isContact:(()=>{const t=E.user?.id,n=E.contact??(t?tr[t]:null);return!!(n&&n.status==="ACCEPTED")})(),canBlock:(()=>{const t=E.user?.id;return!!(E.contact??(t?tr[t]:null))?.id})(),contactRequest:(()=>{const t=E.contact;return t&&t.status==="PENDING"&&t.direction==="incoming"?{incoming:!0}:null})(),secret:{enabled:!!(E.user?.id&&xa[E.user.id]==="ACTIVE"),canOpen:!!(E.user?.id&&va[E.user.id])},commonGroups:(()=>{const t=E.user?.id;if(!t)return[];const n=te.data||[],r=[];for(const s of n){const a=s?.conversation;if(!a||!!!(a.isGroup||(a.participants?.length??0)>2))continue;const l=Array.isArray(a.participants)?a.participants:[];if(!l.map(p=>p?.user?.id).filter(p=>typeof p=="string").includes(t))continue;const d=a.title??l.map(p=>p?.user?.displayName??p?.user?.username).filter(Boolean).join(", ")??"Ð“Ñ€ÑƒÐ¿Ð¿Ð°";r.push({id:a.id,title:d})}return r})(),onClose:sn,onAcceptContact:async()=>{const t=E.contact;t?.id&&(await J.post("/contacts/respond",{contactId:t.id,action:"accept"}),P.invalidateQueries({queryKey:["accepted-contacts"]}),P.invalidateQueries({queryKey:["incoming-contacts"]}),P.invalidateQueries({queryKey:["conversations"]}),sn())},onRejectContact:async()=>{const t=E.contact;t?.id&&(await J.post("/contacts/respond",{contactId:t.id,action:"reject"}),P.invalidateQueries({queryKey:["accepted-contacts"]}),P.invalidateQueries({queryKey:["incoming-contacts"]}),sn())},onCopyId:async()=>{const t=(E.user?.eblid??E.user?.id??"").toString();if(t)try{await navigator.clipboard.writeText(t)}catch{}},onWrite:async()=>{const t=E.user?.id;if(!t)return;const n=await J.post("/conversations",{participantIds:[t],isGroup:!1});P.invalidateQueries({queryKey:["conversations"]}),sn(),n?.data?.conversation?.id&&nn(n.data.conversation.id)},onStartSecretChat:async()=>{const t=E.user?.id;t&&(await ui(t),P.invalidateQueries({queryKey:["conversations"]}))},onOpenSecretChat:async()=>{const t=E.user?.id;if(!t)return;const n=va[t];n&&(sn(),nn(n))},onEditProfile:()=>{sn(),window.location.assign("/settings")},onChangeAvatar:()=>{sn(),Nr(!0)},onPrivacy:()=>{sn(),window.location.assign("/settings")},onAddContact:async()=>{const t=E.user,n=(t?.username??t?.eblid??"").toString();n&&(await J.post("/contacts/add",{identifier:n}),P.invalidateQueries({queryKey:["accepted-contacts"]}),P.invalidateQueries({queryKey:["incoming-contacts"]}))},onRemoveContact:async()=>{const t=E.user?.id;if(!t)return;const n=E.contact??tr[t];n?.id&&(await J.post("/contacts/remove",{contactId:n.id}),P.invalidateQueries({queryKey:["accepted-contacts"]}),P.invalidateQueries({queryKey:["incoming-contacts"]}),sn())},onBlock:async()=>{const t=E.user?.id;if(!t)return;const n=E.contact??tr[t];n?.id&&(await J.post("/contacts/respond",{contactId:n.id,action:"block"}),P.invalidateQueries({queryKey:["accepted-contacts"]}),P.invalidateQueries({queryKey:["incoming-contacts"]}),sn())},onReport:async()=>{}}),Ke&&S&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>st(!1),children:e.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹"}),e.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>st(!1),children:e.jsx(Lt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[e.jsx(qe,{name:S.title?.trim()?.charAt(0)||"Ð“",id:S.id,avatarUrl:Wt??S.avatarUrl??void 0,size:60}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:S.title||"Ð“Ñ€ÑƒÐ¿Ð¿Ð°"}),e.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€"})]})]}),e.jsx("input",{ref:Hi,type:"file",accept:"image/*",onChange:t=>{const n=t.target.files?.[0];if(n){us(n);try{ls(URL.createObjectURL(n))}catch{}}},style:{display:"none"}}),!Wt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{onClick:()=>Hi.current?.click(),onDragOver:t=>{t.preventDefault(),Qs(!0)},onDragLeave:()=>Qs(!1),onDrop:t=>{t.preventDefault(),Qs(!1);const n=t.dataTransfer.files?.[0];if(n){us(n);try{ls(URL.createObjectURL(n))}catch{}}},style:{border:"2px dashed "+(Wi?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Wi?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[e.jsx(bi,{size:18,color:"var(--text-muted)"}),e.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÑÑŽÐ´Ð° Ð¸Ð»Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ"})]})]}),Wt&&e.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°"}),e.jsxs("div",{ref:Rn,onWheel:t=>{t.preventDefault();const n=-t.deltaY*.001,r=Math.max(.1,Math.min(10,Me.scale*(1+n))),s=Rn.current?.getBoundingClientRect();if(s){const a=t.clientX-s.left,i=t.clientY-s.top,l=r/Me.scale,h=a-(a-Me.x)*l,d=i-(i-Me.y)*l;en({x:h,y:d,scale:r})}},onPointerDown:t=>{if(t.pointerType==="touch")return;const n=Rn.current?.getBoundingClientRect();if(!n)return;const r=n.width,s=n.height,a=r/2,i=s/2,h=240/2,d=t.clientX-n.left,p=t.clientY-n.top,w=d-a,m=p-i;if(w*w+m*m>h*h)return;try{t.currentTarget.setPointerCapture?.(t.pointerId)}catch{}const x=t.clientX,j=t.clientY,y={...Me},k=W=>{W.preventDefault();const oe=W.clientX-x,le=W.clientY-j;en({...y,x:y.x+oe,y:y.y+le})},H=()=>{window.removeEventListener("pointermove",k),window.removeEventListener("pointerup",H)};window.addEventListener("pointermove",k,{passive:!1}),window.addEventListener("pointerup",H,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[e.jsx("img",{ref:os,src:Wt,alt:"preview",style:{position:"absolute",left:Me.x,top:Me.y,transform:`scale(${Me.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:t=>{const n=t.currentTarget,r=Rn.current;if(!r)return;const s=r.clientWidth,a=r.clientHeight,i=240,l=n.naturalWidth,h=n.naturalHeight,d=s/2,p=a/2,w=i/l,m=i/h,x=Math.max(w,m)*1.2,j=d-l*x/2,y=p-h*x/2;en({x:j,y,scale:x})}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),e.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),e.jsxs("div",{style:{marginTop:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"ÐœÐ°ÑÑˆÑ‚Ð°Ð±"}),e.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(Me.scale*100),"%"]})]}),e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>en(t=>({...t,scale:Math.max(.1,t.scale-.1)})),children:"âˆ’"}),e.jsx("input",{type:"range",min:.1,max:10,step:.01,value:Me.scale,onChange:t=>{const n=parseFloat(t.target.value);en(r=>{const s=Rn.current?.getBoundingClientRect();if(!s)return{...r,scale:n};const a=s.width,i=s.height,l=a/2,h=i/2,d=os.current;if(d){const p=d.naturalWidth,w=d.naturalHeight,m=r.x+p*r.scale/2,x=r.y+w*r.scale/2,j=m-l,y=x-h,k=n/r.scale,H=l+j*k,W=h+y*k,oe=H-p*n/2,le=W-w*n/2;return{x:oe,y:le,scale:n}}return{...r,scale:n}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),e.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>en(t=>({...t,scale:Math.min(10,t.scale+.1)})),children:"+"})]})]}),e.jsx("canvas",{ref:cs,width:240,height:240,style:{display:"none"}})]}),ds&&e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{us(null),Wt&&URL.revokeObjectURL(Wt),ls(null),en({x:0,y:0,scale:1})},children:"ÐžÑ‚Ð¼ÐµÐ½Ð°"}),e.jsx("button",{className:"btn btn-primary",disabled:dr,onClick:async()=>{if(!(!ds||!S)){ns(!0),as(0);try{let t=null;if(cs.current&&Wt){const s=await new Promise(y=>{const k=new Image;k.onload=()=>y(k),k.src=Wt}),a=cs.current.getContext("2d");if(!a)throw new Error("Could not get 2d context from canvas");const i=240;a.clearRect(0,0,i,i),a.save(),a.beginPath(),a.arc(i/2,i/2,i/2,0,Math.PI*2),a.closePath(),a.clip();const l=Rn.current?.clientWidth??320,h=Rn.current?.clientHeight??320,d={x:l/2,y:h/2},p={x:d.x-i/2,y:d.y-i/2,w:i,h:i},w=(p.x-Me.x)/Me.scale,m=(p.y-Me.y)/Me.scale,x=p.w/Me.scale,j=p.h/Me.scale;a.drawImage(s,w,m,x,j,0,0,i,i),a.restore(),t=await new Promise(y=>cs.current.toBlob(k=>y(k),"image/png"))}if(!t&&!ds)throw new Error("No file to upload");const n=new FormData;n.append("file",t??ds);const r=await new Promise((s,a)=>{const i=new XMLHttpRequest;i.open("POST","/api/upload");try{const l=ir.getState().session?.accessToken;l&&i.setRequestHeader("Authorization",`Bearer ${l}`)}catch{}i.upload.onprogress=l=>{l.lengthComputable&&as(Math.round(100*l.loaded/l.total))},i.onreadystatechange=()=>{if(i.readyState===4)if(i.status>=200&&i.status<300)try{const l=JSON.parse(i.responseText);s(l.url)}catch(l){a(l)}else a(new Error(`upload failed: ${i.status} ${i.statusText}`))},i.onerror=()=>{a(new Error("Network error during upload"))},i.send(n)});await J.patch(`/conversations/${S.id}`,{avatarUrl:r}),P.setQueryData(["conversations"],s=>Array.isArray(s)?s.map(a=>a.conversation?.id===S.id?{...a,conversation:{...a.conversation,avatarUrl:r}}:a):s),P.invalidateQueries({queryKey:["conversations"]}),await te.refetch(),us(null),Wt&&URL.revokeObjectURL(Wt),ls(null),en({x:0,y:0,scale:1}),st(!1),ur("Ð“Ð¾Ñ‚Ð¾Ð²Ð¾"),setTimeout(()=>ur(null),2200)}catch(t){console.error("Error uploading group avatar:",t),ur(`ÐžÑˆÐ¸Ð±ÐºÐ°: ${t instanceof Error?t.message:"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}`),setTimeout(()=>ur(null),3e3)}finally{ns(!1)}}},children:dr?"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...":"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ"})]}),dr&&e.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:e.jsx("div",{style:{width:`${Pi}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),fs&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[e.jsx(Wa,{size:16}),e.jsx("span",{children:fs})]})]})})]})}function Ka(c){return(c??[]).map(u=>u.user.id).sort().join(",")}export{zl as default};
