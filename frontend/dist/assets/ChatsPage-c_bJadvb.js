const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallOverlay-D96AJnSH.js","assets/vendor-query-CNP5Hy5J.js","assets/vendor-react-BcTlWpV0.js","assets/index-BSnIWOU2.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-GGjuBpPe.js","assets/index-C7QPtc4M.css","assets/index-BRAGuiMP.js","assets/index-DcBnOcQS.css"])))=>i.map(i=>d[i]);
import{e as Il,d as ae,s as Pe,f as Ur,g as os,h as Mc,n as Yn,i as wu,_ as Ml,u as or,j as bu,k as Ec,o as ku,l as Su,m as Tc,p as Nc,q as Rc,t as Cu,v as ju,w as Iu,x as Mu,y as Eu,z as Tu,A as Nu,B as Ru,D as Du,E as Au,F as Ou,G as Lu,H as Uu,I as zu,J as Wu,K as Fu,L as Ds,M as Dc,P as $u,Q as Hu,R as Pu,S as Bu,T as Vu,U as Ac}from"./index-BSnIWOU2.js";import{r as d,j as r,c as es,d as Yu}from"./vendor-query-CNP5Hy5J.js";const _u=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),qu=t=>t.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,n,s)=>s?s.toUpperCase():n.toLowerCase()),Oc=t=>{const e=qu(t);return e.charAt(0).toUpperCase()+e.slice(1)},El=(...t)=>t.filter((e,n,s)=>!!e&&e.trim()!==""&&s.indexOf(e)===n).join(" ").trim(),Gu=t=>{for(const e in t)if(e.startsWith("aria-")||e==="role"||e==="title")return!0};var Xu={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const Zu=d.forwardRef(({color:t="currentColor",size:e=24,strokeWidth:n=2,absoluteStrokeWidth:s,className:a="",children:l,iconNode:u,...p},x)=>d.createElement("svg",{ref:x,...Xu,width:e,height:e,stroke:t,strokeWidth:s?Number(n)*24/Number(e):n,className:El("lucide",a),...!l&&!Gu(p)&&{"aria-hidden":"true"},...p},[...u.map(([w,N])=>d.createElement(w,N)),...Array.isArray(l)?l:[l]]));const Se=(t,e)=>{const n=d.forwardRef(({className:s,...a},l)=>d.createElement(Zu,{ref:l,iconNode:e,className:El(`lucide-${_u(Oc(t))}`,`lucide-${t}`,s),...a}));return n.displayName=Oc(t),n};const Ku=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Qu=Se("arrow-left",Ku);const Ju=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],ef=Se("bell-ring",Ju);const tf=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],nf=Se("calendar-days",tf);const rf=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],sf=Se("check",rf);const af=[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]],of=Se("chevron-left",af);const cf=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],lf=Se("chevron-right",cf);const df=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],io=Se("circle-check-big",df);const uf=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],ff=Se("circle-plus",uf);const hf=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]],mf=Se("circle-question-mark",hf);const pf=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],gf=Se("circle-x",pf);const yf=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],Ua=Se("cloud-upload",yf);const xf=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],vf=Se("copy",xf);const wf=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],ts=Se("ellipsis-vertical",wf);const bf=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],kf=Se("eye-off",bf);const Sf=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],Cf=Se("eye",Sf);const jf=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]],If=Se("lock-open",jf);const Mf=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Lc=Se("lock",Mf);const Ef=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],za=Se("log-out",Ef);const Tf=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],Uc=Se("maximize-2",Tf);const Nf=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Rf=Se("mic",Nf);const Df=[["path",{d:"M5 12h14",key:"1ays0h"}]],Af=Se("minus",Df);const Of=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],Lf=Se("paperclip",Of);const Uf=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],Wa=Se("phone-off",Uf);const zf=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],Fa=Se("phone",zf);const Wf=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Ff=Se("reply",Wf);const $f=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],zc=Se("rotate-ccw",$f);const Hf=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Wc=Se("send",Hf);const Pf=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Fc=Se("square-pen",Pf);const Bf=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Vf=Se("square",Bf);const Yf=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],ao=Se("trash-2",Yf);const _f=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],$c=Se("undo-2",_f);const qf=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Hc=Se("user-plus",qf);const Gf=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],Xf=Se("users",Gf);const Zf=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],$a=Se("video",Zf);const Kf=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Zt=Se("x",Kf),Ha=({onClick:t,title:e="Календарь доступности",className:n,style:s})=>r.jsx("button",{type:"button",className:n??"btn btn-icon btn-ghost",title:e,onClick:t,style:s,children:r.jsx(nf,{size:20})});class Fr extends Error{}class Qf extends Fr{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class Jf extends Fr{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class eh extends Fr{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class as extends Fr{}class Tl extends Fr{constructor(e){super(`Invalid unit ${e}`)}}class Ot extends Fr{}class cr extends Fr{constructor(){super("Zone is an abstract class")}}const _="numeric",kn="short",Jt="long",_i={year:_,month:_,day:_},Nl={year:_,month:kn,day:_},th={year:_,month:kn,day:_,weekday:kn},Rl={year:_,month:Jt,day:_},Dl={year:_,month:Jt,day:_,weekday:Jt},Al={hour:_,minute:_},Ol={hour:_,minute:_,second:_},Ll={hour:_,minute:_,second:_,timeZoneName:kn},Ul={hour:_,minute:_,second:_,timeZoneName:Jt},zl={hour:_,minute:_,hourCycle:"h23"},Wl={hour:_,minute:_,second:_,hourCycle:"h23"},Fl={hour:_,minute:_,second:_,hourCycle:"h23",timeZoneName:kn},$l={hour:_,minute:_,second:_,hourCycle:"h23",timeZoneName:Jt},Hl={year:_,month:_,day:_,hour:_,minute:_},Pl={year:_,month:_,day:_,hour:_,minute:_,second:_},Bl={year:_,month:kn,day:_,hour:_,minute:_},Vl={year:_,month:kn,day:_,hour:_,minute:_,second:_},nh={year:_,month:kn,day:_,weekday:kn,hour:_,minute:_},Yl={year:_,month:Jt,day:_,hour:_,minute:_,timeZoneName:kn},_l={year:_,month:Jt,day:_,hour:_,minute:_,second:_,timeZoneName:kn},ql={year:_,month:Jt,day:_,weekday:Jt,hour:_,minute:_,timeZoneName:Jt},Gl={year:_,month:Jt,day:_,weekday:Jt,hour:_,minute:_,second:_,timeZoneName:Jt};class Ys{get type(){throw new cr}get name(){throw new cr}get ianaName(){return this.name}get isUniversal(){throw new cr}offsetName(e,n){throw new cr}formatOffset(e,n){throw new cr}offset(e){throw new cr}equals(e){throw new cr}get isValid(){throw new cr}}let Pa=null;class Qi extends Ys{static get instance(){return Pa===null&&(Pa=new Qi),Pa}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:n,locale:s}){return id(e,n,s)}formatOffset(e,n){return Hs(this.offset(e),n)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}const oo=new Map;function rh(t){let e=oo.get(t);return e===void 0&&(e=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"}),oo.set(t,e)),e}const sh={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function ih(t,e){const n=t.format(e).replace(/\u200E/g,""),s=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(n),[,a,l,u,p,x,w,N]=s;return[u,a,l,p,x,w,N]}function ah(t,e){const n=t.formatToParts(e),s=[];for(let a=0;a<n.length;a++){const{type:l,value:u}=n[a],p=sh[l];l==="era"?s[p]=u:de(p)||(s[p]=parseInt(u,10))}return s}const Ba=new Map;class Gn extends Ys{static create(e){let n=Ba.get(e);return n===void 0&&Ba.set(e,n=new Gn(e)),n}static resetCache(){Ba.clear(),oo.clear()}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=Gn.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:n,locale:s}){return id(e,n,s,this.name)}formatOffset(e,n){return Hs(this.offset(e),n)}offset(e){if(!this.valid)return NaN;const n=new Date(e);if(isNaN(n))return NaN;const s=rh(this.name);let[a,l,u,p,x,w,N]=s.formatToParts?ah(s,n):ih(s,n);p==="BC"&&(a=-Math.abs(a)+1);const H=ea({year:a,month:l,day:u,hour:x===24?0:x,minute:w,second:N,millisecond:0});let W=+n;const L=W%1e3;return W-=L>=0?L:1e3+L,(H-W)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let Pc={};function oh(t,e={}){const n=JSON.stringify([t,e]);let s=Pc[n];return s||(s=new Intl.ListFormat(t,e),Pc[n]=s),s}const co=new Map;function lo(t,e={}){const n=JSON.stringify([t,e]);let s=co.get(n);return s===void 0&&(s=new Intl.DateTimeFormat(t,e),co.set(n,s)),s}const uo=new Map;function ch(t,e={}){const n=JSON.stringify([t,e]);let s=uo.get(n);return s===void 0&&(s=new Intl.NumberFormat(t,e),uo.set(n,s)),s}const fo=new Map;function lh(t,e={}){const{base:n,...s}=e,a=JSON.stringify([t,s]);let l=fo.get(a);return l===void 0&&(l=new Intl.RelativeTimeFormat(t,e),fo.set(a,l)),l}let zs=null;function dh(){return zs||(zs=new Intl.DateTimeFormat().resolvedOptions().locale,zs)}const ho=new Map;function Xl(t){let e=ho.get(t);return e===void 0&&(e=new Intl.DateTimeFormat(t).resolvedOptions(),ho.set(t,e)),e}const mo=new Map;function uh(t){let e=mo.get(t);if(!e){const n=new Intl.Locale(t);e="getWeekInfo"in n?n.getWeekInfo():n.weekInfo,"minimalDays"in e||(e={...Zl,...e}),mo.set(t,e)}return e}function fh(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const n=t.indexOf("-u-");if(n===-1)return[t];{let s,a;try{s=lo(t).resolvedOptions(),a=t}catch{const x=t.substring(0,n);s=lo(x).resolvedOptions(),a=x}const{numberingSystem:l,calendar:u}=s;return[a,l,u]}}function hh(t,e,n){return(n||e)&&(t.includes("-u-")||(t+="-u"),n&&(t+=`-ca-${n}`),e&&(t+=`-nu-${e}`)),t}function mh(t){const e=[];for(let n=1;n<=12;n++){const s=ee.utc(2009,n,1);e.push(t(s))}return e}function ph(t){const e=[];for(let n=1;n<=7;n++){const s=ee.utc(2016,11,13+n);e.push(t(s))}return e}function zi(t,e,n,s){const a=t.listingMode();return a==="error"?null:a==="en"?n(e):s(e)}function gh(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||Xl(t.locale).numberingSystem==="latn"}class yh{constructor(e,n,s){this.padTo=s.padTo||0,this.floor=s.floor||!1;const{padTo:a,floor:l,...u}=s;if(!n||Object.keys(u).length>0){const p={useGrouping:!1,...s};s.padTo>0&&(p.minimumIntegerDigits=s.padTo),this.inf=ch(e,p)}}format(e){if(this.inf){const n=this.floor?Math.floor(e):e;return this.inf.format(n)}else{const n=this.floor?Math.floor(e):jo(e,3);return ut(n,this.padTo)}}}class xh{constructor(e,n,s){this.opts=s,this.originalZone=void 0;let a;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const u=-1*(e.offset/60),p=u>=0?`Etc/GMT+${u}`:`Etc/GMT${u}`;e.offset!==0&&Gn.create(p).valid?(a=p,this.dt=e):(a="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,a=e.zone.name):(a="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const l={...this.opts};l.timeZone=l.timeZone||a,this.dtf=lo(n,l)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(n=>{if(n.type==="timeZoneName"){const s=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...n,value:s}}else return n}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class vh{constructor(e,n,s){this.opts={style:"long",...s},!n&&rd()&&(this.rtf=lh(e,s))}format(e,n){return this.rtf?this.rtf.format(e,n):Hh(n,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,n){return this.rtf?this.rtf.formatToParts(e,n):[]}}const Zl={firstDay:1,minimalDays:4,weekend:[6,7]};class Le{static fromOpts(e){return Le.create(e.locale,e.numberingSystem,e.outputCalendar,e.weekSettings,e.defaultToEN)}static create(e,n,s,a,l=!1){const u=e||rt.defaultLocale,p=u||(l?"en-US":dh()),x=n||rt.defaultNumberingSystem,w=s||rt.defaultOutputCalendar,N=go(a)||rt.defaultWeekSettings;return new Le(p,x,w,N,u)}static resetCache(){zs=null,co.clear(),uo.clear(),fo.clear(),ho.clear(),mo.clear()}static fromObject({locale:e,numberingSystem:n,outputCalendar:s,weekSettings:a}={}){return Le.create(e,n,s,a)}constructor(e,n,s,a,l){const[u,p,x]=fh(e);this.locale=u,this.numberingSystem=n||p||null,this.outputCalendar=s||x||null,this.weekSettings=a,this.intl=hh(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=l,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=gh(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),n=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&n?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:Le.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,go(e.weekSettings)||this.weekSettings,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,n=!1){return zi(this,e,cd,()=>{const s=this.intl==="ja"||this.intl.startsWith("ja-");n&=!s;const a=n?{month:e,day:"numeric"}:{month:e},l=n?"format":"standalone";if(!this.monthsCache[l][e]){const u=s?p=>this.dtFormatter(p,a).format():p=>this.extract(p,a,"month");this.monthsCache[l][e]=mh(u)}return this.monthsCache[l][e]})}weekdays(e,n=!1){return zi(this,e,ud,()=>{const s=n?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},a=n?"format":"standalone";return this.weekdaysCache[a][e]||(this.weekdaysCache[a][e]=ph(l=>this.extract(l,s,"weekday"))),this.weekdaysCache[a][e]})}meridiems(){return zi(this,void 0,()=>fd,()=>{if(!this.meridiemCache){const e={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[ee.utc(2016,11,13,9),ee.utc(2016,11,13,19)].map(n=>this.extract(n,e,"dayperiod"))}return this.meridiemCache})}eras(e){return zi(this,e,hd,()=>{const n={era:e};return this.eraCache[e]||(this.eraCache[e]=[ee.utc(-40,1,1),ee.utc(2017,1,1)].map(s=>this.extract(s,n,"era"))),this.eraCache[e]})}extract(e,n,s){const a=this.dtFormatter(e,n),l=a.formatToParts(),u=l.find(p=>p.type.toLowerCase()===s);return u?u.value:null}numberFormatter(e={}){return new yh(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,n={}){return new xh(e,this.intl,n)}relFormatter(e={}){return new vh(this.intl,this.isEnglish(),e)}listFormatter(e={}){return oh(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||Xl(this.intl).locale.startsWith("en-us")}getWeekSettings(){return this.weekSettings?this.weekSettings:sd()?uh(this.locale):Zl}getStartOfWeek(){return this.getWeekSettings().firstDay}getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays}getWeekendDays(){return this.getWeekSettings().weekend}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}toString(){return`Locale(${this.locale}, ${this.numberingSystem}, ${this.outputCalendar})`}}let Va=null;class Ht extends Ys{static get utcInstance(){return Va===null&&(Va=new Ht(0)),Va}static instance(e){return e===0?Ht.utcInstance:new Ht(e)}static parseSpecifier(e){if(e){const n=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(n)return new Ht(ta(n[1],n[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${Hs(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${Hs(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,n){return Hs(this.fixed,n)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class wh extends Ys{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function fr(t,e){if(de(t)||t===null)return e;if(t instanceof Ys)return t;if(Ih(t)){const n=t.toLowerCase();return n==="default"?e:n==="local"||n==="system"?Qi.instance:n==="utc"||n==="gmt"?Ht.utcInstance:Ht.parseSpecifier(n)||Gn.create(t)}else return hr(t)?Ht.instance(t):typeof t=="object"&&"offset"in t&&typeof t.offset=="function"?t:new wh(t)}const bo={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},Bc={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},bh=bo.hanidec.replace(/[\[|\]]/g,"").split("");function kh(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let n=0;n<t.length;n++){const s=t.charCodeAt(n);if(t[n].search(bo.hanidec)!==-1)e+=bh.indexOf(t[n]);else for(const a in Bc){const[l,u]=Bc[a];s>=l&&s<=u&&(e+=s-l)}}return parseInt(e,10)}else return e}const po=new Map;function Sh(){po.clear()}function xn({numberingSystem:t},e=""){const n=t||"latn";let s=po.get(n);s===void 0&&(s=new Map,po.set(n,s));let a=s.get(e);return a===void 0&&(a=new RegExp(`${bo[n]}${e}`),s.set(e,a)),a}let Vc=()=>Date.now(),Yc="system",_c=null,qc=null,Gc=null,Xc=60,Zc,Kc=null;class rt{static get now(){return Vc}static set now(e){Vc=e}static set defaultZone(e){Yc=e}static get defaultZone(){return fr(Yc,Qi.instance)}static get defaultLocale(){return _c}static set defaultLocale(e){_c=e}static get defaultNumberingSystem(){return qc}static set defaultNumberingSystem(e){qc=e}static get defaultOutputCalendar(){return Gc}static set defaultOutputCalendar(e){Gc=e}static get defaultWeekSettings(){return Kc}static set defaultWeekSettings(e){Kc=go(e)}static get twoDigitCutoffYear(){return Xc}static set twoDigitCutoffYear(e){Xc=e%100}static get throwOnInvalid(){return Zc}static set throwOnInvalid(e){Zc=e}static resetCaches(){Le.resetCache(),Gn.resetCache(),ee.resetCache(),Sh()}}class bn{constructor(e,n){this.reason=e,this.explanation=n}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const Kl=[0,31,59,90,120,151,181,212,243,273,304,334],Ql=[0,31,60,91,121,152,182,213,244,274,305,335];function hn(t,e){return new bn("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function ko(t,e,n){const s=new Date(Date.UTC(t,e-1,n));t<100&&t>=0&&s.setUTCFullYear(s.getUTCFullYear()-1900);const a=s.getUTCDay();return a===0?7:a}function Jl(t,e,n){return n+(_s(t)?Ql:Kl)[e-1]}function ed(t,e){const n=_s(t)?Ql:Kl,s=n.findIndex(l=>l<e),a=e-n[s];return{month:s+1,day:a}}function So(t,e){return(t-e+7)%7+1}function qi(t,e=4,n=1){const{year:s,month:a,day:l}=t,u=Jl(s,a,l),p=So(ko(s,a,l),n);let x=Math.floor((u-p+14-e)/7),w;return x<1?(w=s-1,x=Ps(w,e,n)):x>Ps(s,e,n)?(w=s+1,x=1):w=s,{weekYear:w,weekNumber:x,weekday:p,...na(t)}}function Qc(t,e=4,n=1){const{weekYear:s,weekNumber:a,weekday:l}=t,u=So(ko(s,1,e),n),p=cs(s);let x=a*7+l-u-7+e,w;x<1?(w=s-1,x+=cs(w)):x>p?(w=s+1,x-=cs(s)):w=s;const{month:N,day:O}=ed(w,x);return{year:w,month:N,day:O,...na(t)}}function Ya(t){const{year:e,month:n,day:s}=t,a=Jl(e,n,s);return{year:e,ordinal:a,...na(t)}}function Jc(t){const{year:e,ordinal:n}=t,{month:s,day:a}=ed(e,n);return{year:e,month:s,day:a,...na(t)}}function el(t,e){if(!de(t.localWeekday)||!de(t.localWeekNumber)||!de(t.localWeekYear)){if(!de(t.weekday)||!de(t.weekNumber)||!de(t.weekYear))throw new as("Cannot mix locale-based week fields with ISO-based week fields");return de(t.localWeekday)||(t.weekday=t.localWeekday),de(t.localWeekNumber)||(t.weekNumber=t.localWeekNumber),de(t.localWeekYear)||(t.weekYear=t.localWeekYear),delete t.localWeekday,delete t.localWeekNumber,delete t.localWeekYear,{minDaysInFirstWeek:e.getMinDaysInFirstWeek(),startOfWeek:e.getStartOfWeek()}}else return{minDaysInFirstWeek:4,startOfWeek:1}}function Ch(t,e=4,n=1){const s=Ji(t.weekYear),a=mn(t.weekNumber,1,Ps(t.weekYear,e,n)),l=mn(t.weekday,1,7);return s?a?l?!1:hn("weekday",t.weekday):hn("week",t.weekNumber):hn("weekYear",t.weekYear)}function jh(t){const e=Ji(t.year),n=mn(t.ordinal,1,cs(t.year));return e?n?!1:hn("ordinal",t.ordinal):hn("year",t.year)}function td(t){const e=Ji(t.year),n=mn(t.month,1,12),s=mn(t.day,1,Gi(t.year,t.month));return e?n?s?!1:hn("day",t.day):hn("month",t.month):hn("year",t.year)}function nd(t){const{hour:e,minute:n,second:s,millisecond:a}=t,l=mn(e,0,23)||e===24&&n===0&&s===0&&a===0,u=mn(n,0,59),p=mn(s,0,59),x=mn(a,0,999);return l?u?p?x?!1:hn("millisecond",a):hn("second",s):hn("minute",n):hn("hour",e)}function de(t){return typeof t>"u"}function hr(t){return typeof t=="number"}function Ji(t){return typeof t=="number"&&t%1===0}function Ih(t){return typeof t=="string"}function Mh(t){return Object.prototype.toString.call(t)==="[object Date]"}function rd(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function sd(){try{return typeof Intl<"u"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype)}catch{return!1}}function Eh(t){return Array.isArray(t)?t:[t]}function tl(t,e,n){if(t.length!==0)return t.reduce((s,a)=>{const l=[e(a),a];return s&&n(s[0],l[0])===s[0]?s:l},null)[1]}function Th(t,e){return e.reduce((n,s)=>(n[s]=t[s],n),{})}function ds(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function go(t){if(t==null)return null;if(typeof t!="object")throw new Ot("Week settings must be an object");if(!mn(t.firstDay,1,7)||!mn(t.minimalDays,1,7)||!Array.isArray(t.weekend)||t.weekend.some(e=>!mn(e,1,7)))throw new Ot("Invalid week settings");return{firstDay:t.firstDay,minimalDays:t.minimalDays,weekend:Array.from(t.weekend)}}function mn(t,e,n){return Ji(t)&&t>=e&&t<=n}function Nh(t,e){return t-e*Math.floor(t/e)}function ut(t,e=2){const n=t<0;let s;return n?s="-"+(""+-t).padStart(e,"0"):s=(""+t).padStart(e,"0"),s}function ur(t){if(!(de(t)||t===null||t===""))return parseInt(t,10)}function Dr(t){if(!(de(t)||t===null||t===""))return parseFloat(t)}function Co(t){if(!(de(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function jo(t,e,n="round"){const s=10**e;switch(n){case"expand":return t>0?Math.ceil(t*s)/s:Math.floor(t*s)/s;case"trunc":return Math.trunc(t*s)/s;case"round":return Math.round(t*s)/s;case"floor":return Math.floor(t*s)/s;case"ceil":return Math.ceil(t*s)/s;default:throw new RangeError(`Value rounding ${n} is out of range`)}}function _s(t){return t%4===0&&(t%100!==0||t%400===0)}function cs(t){return _s(t)?366:365}function Gi(t,e){const n=Nh(e-1,12)+1,s=t+(e-n)/12;return n===2?_s(s)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][n-1]}function ea(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function nl(t,e,n){return-So(ko(t,1,e),n)+e-1}function Ps(t,e=4,n=1){const s=nl(t,e,n),a=nl(t+1,e,n);return(cs(t)-s+a)/7}function yo(t){return t>99?t:t>rt.twoDigitCutoffYear?1900+t:2e3+t}function id(t,e,n,s=null){const a=new Date(t),l={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};s&&(l.timeZone=s);const u={timeZoneName:e,...l},p=new Intl.DateTimeFormat(n,u).formatToParts(a).find(x=>x.type.toLowerCase()==="timezonename");return p?p.value:null}function ta(t,e){let n=parseInt(t,10);Number.isNaN(n)&&(n=0);const s=parseInt(e,10)||0,a=n<0||Object.is(n,-0)?-s:s;return n*60+a}function ad(t){const e=Number(t);if(typeof t=="boolean"||t===""||!Number.isFinite(e))throw new Ot(`Invalid unit value ${t}`);return e}function Xi(t,e){const n={};for(const s in t)if(ds(t,s)){const a=t[s];if(a==null)continue;n[e(s)]=ad(a)}return n}function Hs(t,e){const n=Math.trunc(Math.abs(t/60)),s=Math.trunc(Math.abs(t%60)),a=t>=0?"+":"-";switch(e){case"short":return`${a}${ut(n,2)}:${ut(s,2)}`;case"narrow":return`${a}${n}${s>0?`:${s}`:""}`;case"techie":return`${a}${ut(n,2)}${ut(s,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function na(t){return Th(t,["hour","minute","second","millisecond"])}const Rh=["January","February","March","April","May","June","July","August","September","October","November","December"],od=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Dh=["J","F","M","A","M","J","J","A","S","O","N","D"];function cd(t){switch(t){case"narrow":return[...Dh];case"short":return[...od];case"long":return[...Rh];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const ld=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],dd=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Ah=["M","T","W","T","F","S","S"];function ud(t){switch(t){case"narrow":return[...Ah];case"short":return[...dd];case"long":return[...ld];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const fd=["AM","PM"],Oh=["Before Christ","Anno Domini"],Lh=["BC","AD"],Uh=["B","A"];function hd(t){switch(t){case"narrow":return[...Uh];case"short":return[...Lh];case"long":return[...Oh];default:return null}}function zh(t){return fd[t.hour<12?0:1]}function Wh(t,e){return ud(e)[t.weekday-1]}function Fh(t,e){return cd(e)[t.month-1]}function $h(t,e){return hd(e)[t.year<0?0:1]}function Hh(t,e,n="always",s=!1){const a={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},l=["hours","minutes","seconds"].indexOf(t)===-1;if(n==="auto"&&l){const O=t==="days";switch(e){case 1:return O?"tomorrow":`next ${a[t][0]}`;case-1:return O?"yesterday":`last ${a[t][0]}`;case 0:return O?"today":`this ${a[t][0]}`}}const u=Object.is(e,-0)||e<0,p=Math.abs(e),x=p===1,w=a[t],N=s?x?w[1]:w[2]||w[1]:x?a[t][0]:t;return u?`${p} ${N} ago`:`in ${p} ${N}`}function rl(t,e){let n="";for(const s of t)s.literal?n+=s.val:n+=e(s.val);return n}const Ph={D:_i,DD:Nl,DDD:Rl,DDDD:Dl,t:Al,tt:Ol,ttt:Ll,tttt:Ul,T:zl,TT:Wl,TTT:Fl,TTTT:$l,f:Hl,ff:Bl,fff:Yl,ffff:ql,F:Pl,FF:Vl,FFF:_l,FFFF:Gl};class Lt{static create(e,n={}){return new Lt(e,n)}static parseFormat(e){let n=null,s="",a=!1;const l=[];for(let u=0;u<e.length;u++){const p=e.charAt(u);p==="'"?((s.length>0||a)&&l.push({literal:a||/^\s+$/.test(s),val:s===""?"'":s}),n=null,s="",a=!a):a||p===n?s+=p:(s.length>0&&l.push({literal:/^\s+$/.test(s),val:s}),s=p,n=p)}return s.length>0&&l.push({literal:a||/^\s+$/.test(s),val:s}),l}static macroTokenToFormatOpts(e){return Ph[e]}constructor(e,n){this.opts=n,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,n){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...n}).format()}dtFormatter(e,n={}){return this.loc.dtFormatter(e,{...this.opts,...n})}formatDateTime(e,n){return this.dtFormatter(e,n).format()}formatDateTimeParts(e,n){return this.dtFormatter(e,n).formatToParts()}formatInterval(e,n){return this.dtFormatter(e.start,n).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,n){return this.dtFormatter(e,n).resolvedOptions()}num(e,n=0,s=void 0){if(this.opts.forceSimple)return ut(e,n);const a={...this.opts};return n>0&&(a.padTo=n),s&&(a.signDisplay=s),this.loc.numberFormatter(a).format(e)}formatDateTimeFromString(e,n){const s=this.loc.listingMode()==="en",a=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",l=(W,L)=>this.loc.extract(e,W,L),u=W=>e.isOffsetFixed&&e.offset===0&&W.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,W.format):"",p=()=>s?zh(e):l({hour:"numeric",hourCycle:"h12"},"dayperiod"),x=(W,L)=>s?Fh(e,W):l(L?{month:W}:{month:W,day:"numeric"},"month"),w=(W,L)=>s?Wh(e,W):l(L?{weekday:W}:{weekday:W,month:"long",day:"numeric"},"weekday"),N=W=>{const L=Lt.macroTokenToFormatOpts(W);return L?this.formatWithSystemDefault(e,L):W},O=W=>s?$h(e,W):l({era:W},"era"),H=W=>{switch(W){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return u({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return u({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return u({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return p();case"d":return a?l({day:"numeric"},"day"):this.num(e.day);case"dd":return a?l({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return w("short",!0);case"cccc":return w("long",!0);case"ccccc":return w("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return w("short",!1);case"EEEE":return w("long",!1);case"EEEEE":return w("narrow",!1);case"L":return a?l({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return a?l({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return x("short",!0);case"LLLL":return x("long",!0);case"LLLLL":return x("narrow",!0);case"M":return a?l({month:"numeric"},"month"):this.num(e.month);case"MM":return a?l({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return x("short",!1);case"MMMM":return x("long",!1);case"MMMMM":return x("narrow",!1);case"y":return a?l({year:"numeric"},"year"):this.num(e.year);case"yy":return a?l({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return a?l({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return a?l({year:"numeric"},"year"):this.num(e.year,6);case"G":return O("short");case"GG":return O("long");case"GGGGG":return O("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"n":return this.num(e.localWeekNumber);case"nn":return this.num(e.localWeekNumber,2);case"ii":return this.num(e.localWeekYear.toString().slice(-2),2);case"iiii":return this.num(e.localWeekYear,4);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return N(W)}};return rl(Lt.parseFormat(n),H)}formatDurationFromString(e,n){const s=this.opts.signMode==="negativeLargestOnly"?-1:1,a=N=>{switch(N[0]){case"S":return"milliseconds";case"s":return"seconds";case"m":return"minutes";case"h":return"hours";case"d":return"days";case"w":return"weeks";case"M":return"months";case"y":return"years";default:return null}},l=(N,O)=>H=>{const W=a(H);if(W){const L=O.isNegativeDuration&&W!==O.largestUnit?s:1;let q;return this.opts.signMode==="negativeLargestOnly"&&W!==O.largestUnit?q="never":this.opts.signMode==="all"?q="always":q="auto",this.num(N.get(W)*L,H.length,q)}else return H},u=Lt.parseFormat(n),p=u.reduce((N,{literal:O,val:H})=>O?N:N.concat(H),[]),x=e.shiftTo(...p.map(a).filter(N=>N)),w={isNegativeDuration:x<0,largestUnit:Object.keys(x.values)[0]};return rl(u,l(x,w))}}const md=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function us(...t){const e=t.reduce((n,s)=>n+s.source,"");return RegExp(`^${e}$`)}function fs(...t){return e=>t.reduce(([n,s,a],l)=>{const[u,p,x]=l(e,a);return[{...n,...u},p||s,x]},[{},null,1]).slice(0,2)}function hs(t,...e){if(t==null)return[null,null];for(const[n,s]of e){const a=n.exec(t);if(a)return s(a)}return[null,null]}function pd(...t){return(e,n)=>{const s={};let a;for(a=0;a<t.length;a++)s[t[a]]=ur(e[n+a]);return[s,null,n+a]}}const gd=/(?:([Zz])|([+-]\d\d)(?::?(\d\d))?)/,Bh=`(?:${gd.source}?(?:\\[(${md.source})\\])?)?`,Io=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,yd=RegExp(`${Io.source}${Bh}`),Mo=RegExp(`(?:[Tt]${yd.source})?`),Vh=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,Yh=/(\d{4})-?W(\d\d)(?:-?(\d))?/,_h=/(\d{4})-?(\d{3})/,qh=pd("weekYear","weekNumber","weekDay"),Gh=pd("year","ordinal"),Xh=/(\d{4})-(\d\d)-(\d\d)/,xd=RegExp(`${Io.source} ?(?:${gd.source}|(${md.source}))?`),Zh=RegExp(`(?: ${xd.source})?`);function ls(t,e,n){const s=t[e];return de(s)?n:ur(s)}function Kh(t,e){return[{year:ls(t,e),month:ls(t,e+1,1),day:ls(t,e+2,1)},null,e+3]}function ms(t,e){return[{hours:ls(t,e,0),minutes:ls(t,e+1,0),seconds:ls(t,e+2,0),milliseconds:Co(t[e+3])},null,e+4]}function qs(t,e){const n=!t[e]&&!t[e+1],s=ta(t[e+1],t[e+2]),a=n?null:Ht.instance(s);return[{},a,e+3]}function Gs(t,e){const n=t[e]?Gn.create(t[e]):null;return[{},n,e+1]}const Qh=RegExp(`^T?${Io.source}$`),Jh=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function em(t){const[e,n,s,a,l,u,p,x,w]=t,N=e[0]==="-",O=x&&x[0]==="-",H=(W,L=!1)=>W!==void 0&&(L||W&&N)?-W:W;return[{years:H(Dr(n)),months:H(Dr(s)),weeks:H(Dr(a)),days:H(Dr(l)),hours:H(Dr(u)),minutes:H(Dr(p)),seconds:H(Dr(x),x==="-0"),milliseconds:H(Co(w),O)}]}const tm={GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function Eo(t,e,n,s,a,l,u){const p={year:e.length===2?yo(ur(e)):ur(e),month:od.indexOf(n)+1,day:ur(s),hour:ur(a),minute:ur(l)};return u&&(p.second=ur(u)),t&&(p.weekday=t.length>3?ld.indexOf(t)+1:dd.indexOf(t)+1),p}const nm=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function rm(t){const[,e,n,s,a,l,u,p,x,w,N,O]=t,H=Eo(e,a,s,n,l,u,p);let W;return x?W=tm[x]:w?W=0:W=ta(N,O),[H,new Ht(W)]}function sm(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const im=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,am=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,om=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function sl(t){const[,e,n,s,a,l,u,p]=t;return[Eo(e,a,s,n,l,u,p),Ht.utcInstance]}function cm(t){const[,e,n,s,a,l,u,p]=t;return[Eo(e,p,n,s,a,l,u),Ht.utcInstance]}const lm=us(Vh,Mo),dm=us(Yh,Mo),um=us(_h,Mo),fm=us(yd),vd=fs(Kh,ms,qs,Gs),hm=fs(qh,ms,qs,Gs),mm=fs(Gh,ms,qs,Gs),pm=fs(ms,qs,Gs);function gm(t){return hs(t,[lm,vd],[dm,hm],[um,mm],[fm,pm])}function ym(t){return hs(sm(t),[nm,rm])}function xm(t){return hs(t,[im,sl],[am,sl],[om,cm])}function vm(t){return hs(t,[Jh,em])}const wm=fs(ms);function bm(t){return hs(t,[Qh,wm])}const km=us(Xh,Zh),Sm=us(xd),Cm=fs(ms,qs,Gs);function jm(t){return hs(t,[km,vd],[Sm,Cm])}const il="Invalid Duration",wd={weeks:{days:7,hours:168,minutes:10080,seconds:10080*60,milliseconds:10080*60*1e3},days:{hours:24,minutes:1440,seconds:1440*60,milliseconds:1440*60*1e3},hours:{minutes:60,seconds:3600,milliseconds:3600*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},Im={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:2184,minutes:2184*60,seconds:2184*60*60,milliseconds:2184*60*60*1e3},months:{weeks:4,days:30,hours:720,minutes:720*60,seconds:720*60*60,milliseconds:720*60*60*1e3},...wd},un=146097/400,ns=146097/4800,Mm={years:{quarters:4,months:12,weeks:un/7,days:un,hours:un*24,minutes:un*24*60,seconds:un*24*60*60,milliseconds:un*24*60*60*1e3},quarters:{months:3,weeks:un/28,days:un/4,hours:un*24/4,minutes:un*24*60/4,seconds:un*24*60*60/4,milliseconds:un*24*60*60*1e3/4},months:{weeks:ns/7,days:ns,hours:ns*24,minutes:ns*24*60,seconds:ns*24*60*60,milliseconds:ns*24*60*60*1e3},...wd},Lr=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],Em=Lr.slice(0).reverse();function _n(t,e,n=!1){const s={values:n?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new Ee(s)}function bd(t,e){let n=e.milliseconds??0;for(const s of Em.slice(1))e[s]&&(n+=e[s]*t[s].milliseconds);return n}function al(t,e){const n=bd(t,e)<0?-1:1;Lr.reduceRight((s,a)=>{if(de(e[a]))return s;if(s){const l=e[s]*n,u=t[a][s],p=Math.floor(l/u);e[a]+=p*n,e[s]-=p*u*n}return a},null),Lr.reduce((s,a)=>{if(de(e[a]))return s;if(s){const l=e[s]%1;e[s]-=l,e[a]+=l*t[s][a]}return a},null)}function ol(t){const e={};for(const[n,s]of Object.entries(t))s!==0&&(e[n]=s);return e}class Ee{constructor(e){const n=e.conversionAccuracy==="longterm"||!1;let s=n?Mm:Im;e.matrix&&(s=e.matrix),this.values=e.values,this.loc=e.loc||Le.create(),this.conversionAccuracy=n?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=s,this.isLuxonDuration=!0}static fromMillis(e,n){return Ee.fromObject({milliseconds:e},n)}static fromObject(e,n={}){if(e==null||typeof e!="object")throw new Ot(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new Ee({values:Xi(e,Ee.normalizeUnit),loc:Le.fromObject(n),conversionAccuracy:n.conversionAccuracy,matrix:n.matrix})}static fromDurationLike(e){if(hr(e))return Ee.fromMillis(e);if(Ee.isDuration(e))return e;if(typeof e=="object")return Ee.fromObject(e);throw new Ot(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,n){const[s]=vm(e);return s?Ee.fromObject(s,n):Ee.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,n){const[s]=bm(e);return s?Ee.fromObject(s,n):Ee.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,n=null){if(!e)throw new Ot("need to specify a reason the Duration is invalid");const s=e instanceof bn?e:new bn(e,n);if(rt.throwOnInvalid)throw new eh(s);return new Ee({invalid:s})}static normalizeUnit(e){const n={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!n)throw new Tl(e);return n}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,n={}){const s={...n,floor:n.round!==!1&&n.floor!==!1};return this.isValid?Lt.create(this.loc,s).formatDurationFromString(this,e):il}toHuman(e={}){if(!this.isValid)return il;const n=e.showZeros!==!1,s=Lr.map(a=>{const l=this.values[a];return de(l)||l===0&&!n?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:a.slice(0,-1)}).format(l)}).filter(a=>a);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(s)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=jo(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const n=this.toMillis();return n<0||n>=864e5?null:(e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e,includeOffset:!1},ee.fromMillis(n,{zone:"UTC"}).toISOTime(e))}toJSON(){return this.toISO()}toString(){return this.toISO()}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Duration { values: ${JSON.stringify(this.values)} }`:`Duration { Invalid, reason: ${this.invalidReason} }`}toMillis(){return this.isValid?bd(this.matrix,this.values):NaN}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const n=Ee.fromDurationLike(e),s={};for(const a of Lr)(ds(n.values,a)||ds(this.values,a))&&(s[a]=n.get(a)+this.get(a));return _n(this,{values:s},!0)}minus(e){if(!this.isValid)return this;const n=Ee.fromDurationLike(e);return this.plus(n.negate())}mapUnits(e){if(!this.isValid)return this;const n={};for(const s of Object.keys(this.values))n[s]=ad(e(this.values[s],s));return _n(this,{values:n},!0)}get(e){return this[Ee.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const n={...this.values,...Xi(e,Ee.normalizeUnit)};return _n(this,{values:n})}reconfigure({locale:e,numberingSystem:n,conversionAccuracy:s,matrix:a}={}){const u={loc:this.loc.clone({locale:e,numberingSystem:n}),matrix:a,conversionAccuracy:s};return _n(this,u)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return al(this.matrix,e),_n(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=ol(this.normalize().shiftToAll().toObject());return _n(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(u=>Ee.normalizeUnit(u));const n={},s={},a=this.toObject();let l;for(const u of Lr)if(e.indexOf(u)>=0){l=u;let p=0;for(const w in s)p+=this.matrix[w][u]*s[w],s[w]=0;hr(a[u])&&(p+=a[u]);const x=Math.trunc(p);n[u]=x,s[u]=(p*1e3-x*1e3)/1e3}else hr(a[u])&&(s[u]=a[u]);for(const u in s)s[u]!==0&&(n[l]+=u===l?s[u]:s[u]/this.matrix[l][u]);return al(this.matrix,n),_n(this,{values:n},!0)}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const n of Object.keys(this.values))e[n]=this.values[n]===0?0:-this.values[n];return _n(this,{values:e},!0)}removeZeros(){if(!this.isValid)return this;const e=ol(this.values);return _n(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function n(s,a){return s===void 0||s===0?a===void 0||a===0:s===a}for(const s of Lr)if(!n(this.values[s],e.values[s]))return!1;return!0}}const rs="Invalid Interval";function Tm(t,e){return!t||!t.isValid?nt.invalid("missing or invalid start"):!e||!e.isValid?nt.invalid("missing or invalid end"):e<t?nt.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class nt{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,n=null){if(!e)throw new Ot("need to specify a reason the Interval is invalid");const s=e instanceof bn?e:new bn(e,n);if(rt.throwOnInvalid)throw new Jf(s);return new nt({invalid:s})}static fromDateTimes(e,n){const s=As(e),a=As(n),l=Tm(s,a);return l??new nt({start:s,end:a})}static after(e,n){const s=Ee.fromDurationLike(n),a=As(e);return nt.fromDateTimes(a,a.plus(s))}static before(e,n){const s=Ee.fromDurationLike(n),a=As(e);return nt.fromDateTimes(a.minus(s),a)}static fromISO(e,n){const[s,a]=(e||"").split("/",2);if(s&&a){let l,u;try{l=ee.fromISO(s,n),u=l.isValid}catch{u=!1}let p,x;try{p=ee.fromISO(a,n),x=p.isValid}catch{x=!1}if(u&&x)return nt.fromDateTimes(l,p);if(u){const w=Ee.fromISO(a,n);if(w.isValid)return nt.after(l,w)}else if(x){const w=Ee.fromISO(s,n);if(w.isValid)return nt.before(p,w)}}return nt.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get lastDateTime(){return this.isValid&&this.e?this.e.minus(1):null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds",n){if(!this.isValid)return NaN;const s=this.start.startOf(e,n);let a;return n?.useLocaleWeeks?a=this.end.reconfigure({locale:s.locale}):a=this.end,a=a.startOf(e,n),Math.floor(a.diff(s,e).get(e))+(a.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:n}={}){return this.isValid?nt.fromDateTimes(e||this.s,n||this.e):this}splitAt(...e){if(!this.isValid)return[];const n=e.map(As).filter(u=>this.contains(u)).sort((u,p)=>u.toMillis()-p.toMillis()),s=[];let{s:a}=this,l=0;for(;a<this.e;){const u=n[l]||this.e,p=+u>+this.e?this.e:u;s.push(nt.fromDateTimes(a,p)),a=p,l+=1}return s}splitBy(e){const n=Ee.fromDurationLike(e);if(!this.isValid||!n.isValid||n.as("milliseconds")===0)return[];let{s}=this,a=1,l;const u=[];for(;s<this.e;){const p=this.start.plus(n.mapUnits(x=>x*a));l=+p>+this.e?this.e:p,u.push(nt.fromDateTimes(s,l)),s=l,a+=1}return u}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const n=this.s>e.s?this.s:e.s,s=this.e<e.e?this.e:e.e;return n>=s?null:nt.fromDateTimes(n,s)}union(e){if(!this.isValid)return this;const n=this.s<e.s?this.s:e.s,s=this.e>e.e?this.e:e.e;return nt.fromDateTimes(n,s)}static merge(e){const[n,s]=e.sort((a,l)=>a.s-l.s).reduce(([a,l],u)=>l?l.overlaps(u)||l.abutsStart(u)?[a,l.union(u)]:[a.concat([l]),u]:[a,u],[[],null]);return s&&n.push(s),n}static xor(e){let n=null,s=0;const a=[],l=e.map(x=>[{time:x.s,type:"s"},{time:x.e,type:"e"}]),u=Array.prototype.concat(...l),p=u.sort((x,w)=>x.time-w.time);for(const x of p)s+=x.type==="s"?1:-1,s===1?n=x.time:(n&&+n!=+x.time&&a.push(nt.fromDateTimes(n,x.time)),n=null);return nt.merge(a)}difference(...e){return nt.xor([this].concat(e)).map(n=>this.intersection(n)).filter(n=>n&&!n.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:rs}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`Interval { start: ${this.s.toISO()}, end: ${this.e.toISO()} }`:`Interval { Invalid, reason: ${this.invalidReason} }`}toLocaleString(e=_i,n={}){return this.isValid?Lt.create(this.s.loc.clone(n),e).formatInterval(this):rs}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:rs}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:rs}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:rs}toFormat(e,{separator:n=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${n}${this.e.toFormat(e)}`:rs}toDuration(e,n){return this.isValid?this.e.diff(this.s,e,n):Ee.invalid(this.invalidReason)}mapEndpoints(e){return nt.fromDateTimes(e(this.s),e(this.e))}}class Wi{static hasDST(e=rt.defaultZone){const n=ee.now().setZone(e).set({month:12});return!e.isUniversal&&n.offset!==n.set({month:6}).offset}static isValidIANAZone(e){return Gn.isValidZone(e)}static normalizeZone(e){return fr(e,rt.defaultZone)}static getStartOfWeek({locale:e=null,locObj:n=null}={}){return(n||Le.create(e)).getStartOfWeek()}static getMinimumDaysInFirstWeek({locale:e=null,locObj:n=null}={}){return(n||Le.create(e)).getMinDaysInFirstWeek()}static getWeekendWeekdays({locale:e=null,locObj:n=null}={}){return(n||Le.create(e)).getWeekendDays().slice()}static months(e="long",{locale:n=null,numberingSystem:s=null,locObj:a=null,outputCalendar:l="gregory"}={}){return(a||Le.create(n,s,l)).months(e)}static monthsFormat(e="long",{locale:n=null,numberingSystem:s=null,locObj:a=null,outputCalendar:l="gregory"}={}){return(a||Le.create(n,s,l)).months(e,!0)}static weekdays(e="long",{locale:n=null,numberingSystem:s=null,locObj:a=null}={}){return(a||Le.create(n,s,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:n=null,numberingSystem:s=null,locObj:a=null}={}){return(a||Le.create(n,s,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return Le.create(e).meridiems()}static eras(e="short",{locale:n=null}={}){return Le.create(n,null,"gregory").eras(e)}static features(){return{relative:rd(),localeWeek:sd()}}}function cl(t,e){const n=a=>a.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),s=n(e)-n(t);return Math.floor(Ee.fromMillis(s).as("days"))}function Nm(t,e,n){const s=[["years",(x,w)=>w.year-x.year],["quarters",(x,w)=>w.quarter-x.quarter+(w.year-x.year)*4],["months",(x,w)=>w.month-x.month+(w.year-x.year)*12],["weeks",(x,w)=>{const N=cl(x,w);return(N-N%7)/7}],["days",cl]],a={},l=t;let u,p;for(const[x,w]of s)n.indexOf(x)>=0&&(u=x,a[x]=w(t,e),p=l.plus(a),p>e?(a[x]--,t=l.plus(a),t>e&&(p=t,a[x]--,t=l.plus(a))):t=p);return[t,a,p,u]}function Rm(t,e,n,s){let[a,l,u,p]=Nm(t,e,n);const x=e-a,w=n.filter(O=>["hours","minutes","seconds","milliseconds"].indexOf(O)>=0);w.length===0&&(u<e&&(u=a.plus({[p]:1})),u!==a&&(l[p]=(l[p]||0)+x/(u-a)));const N=Ee.fromObject(l,s);return w.length>0?Ee.fromMillis(x,s).shiftTo(...w).plus(N):N}const Dm="missing Intl.DateTimeFormat.formatToParts support";function Ae(t,e=n=>n){return{regex:t,deser:([n])=>e(kh(n))}}const Am=" ",kd=`[ ${Am}]`,Sd=new RegExp(kd,"g");function Om(t){return t.replace(/\./g,"\\.?").replace(Sd,kd)}function ll(t){return t.replace(/\./g,"").replace(Sd," ").toLowerCase()}function vn(t,e){return t===null?null:{regex:RegExp(t.map(Om).join("|")),deser:([n])=>t.findIndex(s=>ll(n)===ll(s))+e}}function dl(t,e){return{regex:t,deser:([,n,s])=>ta(n,s),groups:e}}function Fi(t){return{regex:t,deser:([e])=>e}}function Lm(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Um(t,e){const n=xn(e),s=xn(e,"{2}"),a=xn(e,"{3}"),l=xn(e,"{4}"),u=xn(e,"{6}"),p=xn(e,"{1,2}"),x=xn(e,"{1,3}"),w=xn(e,"{1,6}"),N=xn(e,"{1,9}"),O=xn(e,"{2,4}"),H=xn(e,"{4,6}"),W=V=>({regex:RegExp(Lm(V.val)),deser:([ue])=>ue,literal:!0}),q=(V=>{if(t.literal)return W(V);switch(V.val){case"G":return vn(e.eras("short"),0);case"GG":return vn(e.eras("long"),0);case"y":return Ae(w);case"yy":return Ae(O,yo);case"yyyy":return Ae(l);case"yyyyy":return Ae(H);case"yyyyyy":return Ae(u);case"M":return Ae(p);case"MM":return Ae(s);case"MMM":return vn(e.months("short",!0),1);case"MMMM":return vn(e.months("long",!0),1);case"L":return Ae(p);case"LL":return Ae(s);case"LLL":return vn(e.months("short",!1),1);case"LLLL":return vn(e.months("long",!1),1);case"d":return Ae(p);case"dd":return Ae(s);case"o":return Ae(x);case"ooo":return Ae(a);case"HH":return Ae(s);case"H":return Ae(p);case"hh":return Ae(s);case"h":return Ae(p);case"mm":return Ae(s);case"m":return Ae(p);case"q":return Ae(p);case"qq":return Ae(s);case"s":return Ae(p);case"ss":return Ae(s);case"S":return Ae(x);case"SSS":return Ae(a);case"u":return Fi(N);case"uu":return Fi(p);case"uuu":return Ae(n);case"a":return vn(e.meridiems(),0);case"kkkk":return Ae(l);case"kk":return Ae(O,yo);case"W":return Ae(p);case"WW":return Ae(s);case"E":case"c":return Ae(n);case"EEE":return vn(e.weekdays("short",!1),1);case"EEEE":return vn(e.weekdays("long",!1),1);case"ccc":return vn(e.weekdays("short",!0),1);case"cccc":return vn(e.weekdays("long",!0),1);case"Z":case"ZZ":return dl(new RegExp(`([+-]${p.source})(?::(${s.source}))?`),2);case"ZZZ":return dl(new RegExp(`([+-]${p.source})(${s.source})?`),2);case"z":return Fi(/[a-z_+-/]{1,256}?/i);case" ":return Fi(/[^\S\n\r]/);default:return W(V)}})(t)||{invalidReason:Dm};return q.token=t,q}const zm={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Wm(t,e,n){const{type:s,value:a}=t;if(s==="literal"){const x=/^\s+$/.test(a);return{literal:!x,val:x?" ":a}}const l=e[s];let u=s;s==="hour"&&(e.hour12!=null?u=e.hour12?"hour12":"hour24":e.hourCycle!=null?e.hourCycle==="h11"||e.hourCycle==="h12"?u="hour12":u="hour24":u=n.hour12?"hour12":"hour24");let p=zm[u];if(typeof p=="object"&&(p=p[l]),p)return{literal:!1,val:p}}function Fm(t){return[`^${t.map(n=>n.regex).reduce((n,s)=>`${n}(${s.source})`,"")}$`,t]}function $m(t,e,n){const s=t.match(e);if(s){const a={};let l=1;for(const u in n)if(ds(n,u)){const p=n[u],x=p.groups?p.groups+1:1;!p.literal&&p.token&&(a[p.token.val[0]]=p.deser(s.slice(l,l+x))),l+=x}return[s,a]}else return[s,{}]}function Hm(t){const e=l=>{switch(l){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let n=null,s;return de(t.z)||(n=Gn.create(t.z)),de(t.Z)||(n||(n=new Ht(t.Z)),s=t.Z),de(t.q)||(t.M=(t.q-1)*3+1),de(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),de(t.u)||(t.S=Co(t.u)),[Object.keys(t).reduce((l,u)=>{const p=e(u);return p&&(l[p]=t[u]),l},{}),n,s]}let _a=null;function Pm(){return _a||(_a=ee.fromMillis(1555555555555)),_a}function Bm(t,e){if(t.literal)return t;const n=Lt.macroTokenToFormatOpts(t.val),s=Md(n,e);return s==null||s.includes(void 0)?t:s}function Cd(t,e){return Array.prototype.concat(...t.map(n=>Bm(n,e)))}class jd{constructor(e,n){if(this.locale=e,this.format=n,this.tokens=Cd(Lt.parseFormat(n),e),this.units=this.tokens.map(s=>Um(s,e)),this.disqualifyingUnit=this.units.find(s=>s.invalidReason),!this.disqualifyingUnit){const[s,a]=Fm(this.units);this.regex=RegExp(s,"i"),this.handlers=a}}explainFromTokens(e){if(this.isValid){const[n,s]=$m(e,this.regex,this.handlers),[a,l,u]=s?Hm(s):[null,null,void 0];if(ds(s,"a")&&ds(s,"H"))throw new as("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:this.tokens,regex:this.regex,rawMatches:n,matches:s,result:a,zone:l,specificOffset:u}}else return{input:e,tokens:this.tokens,invalidReason:this.invalidReason}}get isValid(){return!this.disqualifyingUnit}get invalidReason(){return this.disqualifyingUnit?this.disqualifyingUnit.invalidReason:null}}function Id(t,e,n){return new jd(t,n).explainFromTokens(e)}function Vm(t,e,n){const{result:s,zone:a,specificOffset:l,invalidReason:u}=Id(t,e,n);return[s,a,l,u]}function Md(t,e){if(!t)return null;const s=Lt.create(e,t).dtFormatter(Pm()),a=s.formatToParts(),l=s.resolvedOptions();return a.map(u=>Wm(u,t,l))}const qa="Invalid DateTime",ul=864e13;function Ws(t){return new bn("unsupported zone",`the zone "${t.name}" is not supported`)}function Ga(t){return t.weekData===null&&(t.weekData=qi(t.c)),t.weekData}function Xa(t){return t.localWeekData===null&&(t.localWeekData=qi(t.c,t.loc.getMinDaysInFirstWeek(),t.loc.getStartOfWeek())),t.localWeekData}function Ar(t,e){const n={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new ee({...n,...e,old:n})}function Ed(t,e,n){let s=t-e*60*1e3;const a=n.offset(s);if(e===a)return[s,e];s-=(a-e)*60*1e3;const l=n.offset(s);return a===l?[s,a]:[t-Math.min(a,l)*60*1e3,Math.max(a,l)]}function $i(t,e){t+=e*60*1e3;const n=new Date(t);return{year:n.getUTCFullYear(),month:n.getUTCMonth()+1,day:n.getUTCDate(),hour:n.getUTCHours(),minute:n.getUTCMinutes(),second:n.getUTCSeconds(),millisecond:n.getUTCMilliseconds()}}function Bi(t,e,n){return Ed(ea(t),e,n)}function fl(t,e){const n=t.o,s=t.c.year+Math.trunc(e.years),a=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,l={...t.c,year:s,month:a,day:Math.min(t.c.day,Gi(s,a))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},u=Ee.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),p=ea(l);let[x,w]=Ed(p,n,t.zone);return u!==0&&(x+=u,w=t.zone.offset(x)),{ts:x,o:w}}function ss(t,e,n,s,a,l){const{setZone:u,zone:p}=n;if(t&&Object.keys(t).length!==0||e){const x=e||p,w=ee.fromObject(t,{...n,zone:x,specificOffset:l});return u?w:w.setZone(p)}else return ee.invalid(new bn("unparsable",`the input "${a}" can't be parsed as ${s}`))}function Hi(t,e,n=!0){return t.isValid?Lt.create(Le.create("en-US"),{allowZ:n,forceSimple:!0}).formatDateTimeFromString(t,e):null}function Za(t,e,n){const s=t.c.year>9999||t.c.year<0;let a="";if(s&&t.c.year>=0&&(a+="+"),a+=ut(t.c.year,s?6:4),n==="year")return a;if(e){if(a+="-",a+=ut(t.c.month),n==="month")return a;a+="-"}else if(a+=ut(t.c.month),n==="month")return a;return a+=ut(t.c.day),a}function hl(t,e,n,s,a,l,u){let p=!n||t.c.millisecond!==0||t.c.second!==0,x="";switch(u){case"day":case"month":case"year":break;default:if(x+=ut(t.c.hour),u==="hour")break;if(e){if(x+=":",x+=ut(t.c.minute),u==="minute")break;p&&(x+=":",x+=ut(t.c.second))}else{if(x+=ut(t.c.minute),u==="minute")break;p&&(x+=ut(t.c.second))}if(u==="second")break;p&&(!s||t.c.millisecond!==0)&&(x+=".",x+=ut(t.c.millisecond,3))}return a&&(t.isOffsetFixed&&t.offset===0&&!l?x+="Z":t.o<0?(x+="-",x+=ut(Math.trunc(-t.o/60)),x+=":",x+=ut(Math.trunc(-t.o%60))):(x+="+",x+=ut(Math.trunc(t.o/60)),x+=":",x+=ut(Math.trunc(t.o%60)))),l&&(x+="["+t.zone.ianaName+"]"),x}const Td={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Ym={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},_m={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Vi=["year","month","day","hour","minute","second","millisecond"],qm=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Gm=["year","ordinal","hour","minute","second","millisecond"];function Yi(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new Tl(t);return e}function ml(t){switch(t.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return Yi(t)}}function Xm(t){if(Fs===void 0&&(Fs=rt.now()),t.type!=="iana")return t.offset(Fs);const e=t.name;let n=xo.get(e);return n===void 0&&(n=t.offset(Fs),xo.set(e,n)),n}function pl(t,e){const n=fr(e.zone,rt.defaultZone);if(!n.isValid)return ee.invalid(Ws(n));const s=Le.fromObject(e);let a,l;if(de(t.year))a=rt.now();else{for(const x of Vi)de(t[x])&&(t[x]=Td[x]);const u=td(t)||nd(t);if(u)return ee.invalid(u);const p=Xm(n);[a,l]=Bi(t,p,n)}return new ee({ts:a,zone:n,loc:s,o:l})}function gl(t,e,n){const s=de(n.round)?!0:n.round,a=de(n.rounding)?"trunc":n.rounding,l=(p,x)=>(p=jo(p,s||n.calendary?0:2,n.calendary?"round":a),e.loc.clone(n).relFormatter(n).format(p,x)),u=p=>n.calendary?e.hasSame(t,p)?0:e.startOf(p).diff(t.startOf(p),p).get(p):e.diff(t,p).get(p);if(n.unit)return l(u(n.unit),n.unit);for(const p of n.units){const x=u(p);if(Math.abs(x)>=1)return l(x,p)}return l(t>e?-0:0,n.units[n.units.length-1])}function yl(t){let e={},n;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],n=Array.from(t).slice(0,t.length-1)):n=Array.from(t),[e,n]}let Fs;const xo=new Map;class ee{constructor(e){const n=e.zone||rt.defaultZone;let s=e.invalid||(Number.isNaN(e.ts)?new bn("invalid input"):null)||(n.isValid?null:Ws(n));this.ts=de(e.ts)?rt.now():e.ts;let a=null,l=null;if(!s)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(n))[a,l]=[e.old.c,e.old.o];else{const p=hr(e.o)&&!e.old?e.o:n.offset(this.ts);a=$i(this.ts,p),s=Number.isNaN(a.year)?new bn("invalid input"):null,a=s?null:a,l=s?null:p}this._zone=n,this.loc=e.loc||Le.create(),this.invalid=s,this.weekData=null,this.localWeekData=null,this.c=a,this.o=l,this.isLuxonDateTime=!0}static now(){return new ee({})}static local(){const[e,n]=yl(arguments),[s,a,l,u,p,x,w]=n;return pl({year:s,month:a,day:l,hour:u,minute:p,second:x,millisecond:w},e)}static utc(){const[e,n]=yl(arguments),[s,a,l,u,p,x,w]=n;return e.zone=Ht.utcInstance,pl({year:s,month:a,day:l,hour:u,minute:p,second:x,millisecond:w},e)}static fromJSDate(e,n={}){const s=Mh(e)?e.valueOf():NaN;if(Number.isNaN(s))return ee.invalid("invalid input");const a=fr(n.zone,rt.defaultZone);return a.isValid?new ee({ts:s,zone:a,loc:Le.fromObject(n)}):ee.invalid(Ws(a))}static fromMillis(e,n={}){if(hr(e))return e<-ul||e>ul?ee.invalid("Timestamp out of range"):new ee({ts:e,zone:fr(n.zone,rt.defaultZone),loc:Le.fromObject(n)});throw new Ot(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,n={}){if(hr(e))return new ee({ts:e*1e3,zone:fr(n.zone,rt.defaultZone),loc:Le.fromObject(n)});throw new Ot("fromSeconds requires a numerical input")}static fromObject(e,n={}){e=e||{};const s=fr(n.zone,rt.defaultZone);if(!s.isValid)return ee.invalid(Ws(s));const a=Le.fromObject(n),l=Xi(e,ml),{minDaysInFirstWeek:u,startOfWeek:p}=el(l,a),x=rt.now(),w=de(n.specificOffset)?s.offset(x):n.specificOffset,N=!de(l.ordinal),O=!de(l.year),H=!de(l.month)||!de(l.day),W=O||H,L=l.weekYear||l.weekNumber;if((W||N)&&L)throw new as("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(H&&N)throw new as("Can't mix ordinal dates with month/day");const q=L||l.weekday&&!W;let V,ue,be=$i(x,w);q?(V=qm,ue=Ym,be=qi(be,u,p)):N?(V=Gm,ue=_m,be=Ya(be)):(V=Vi,ue=Td);let Xe=!1;for(const st of V){const Be=l[st];de(Be)?Xe?l[st]=ue[st]:l[st]=be[st]:Xe=!0}const ge=q?Ch(l,u,p):N?jh(l):td(l),Te=ge||nd(l);if(Te)return ee.invalid(Te);const ie=q?Qc(l,u,p):N?Jc(l):l,[Ze,ze]=Bi(ie,w,s),Ie=new ee({ts:Ze,zone:s,o:ze,loc:a});return l.weekday&&W&&e.weekday!==Ie.weekday?ee.invalid("mismatched weekday",`you can't specify both a weekday of ${l.weekday} and a date of ${Ie.toISO()}`):Ie.isValid?Ie:ee.invalid(Ie.invalid)}static fromISO(e,n={}){const[s,a]=gm(e);return ss(s,a,n,"ISO 8601",e)}static fromRFC2822(e,n={}){const[s,a]=ym(e);return ss(s,a,n,"RFC 2822",e)}static fromHTTP(e,n={}){const[s,a]=xm(e);return ss(s,a,n,"HTTP",n)}static fromFormat(e,n,s={}){if(de(e)||de(n))throw new Ot("fromFormat requires an input string and a format");const{locale:a=null,numberingSystem:l=null}=s,u=Le.fromOpts({locale:a,numberingSystem:l,defaultToEN:!0}),[p,x,w,N]=Vm(u,e,n);return N?ee.invalid(N):ss(p,x,s,`format ${n}`,e,w)}static fromString(e,n,s={}){return ee.fromFormat(e,n,s)}static fromSQL(e,n={}){const[s,a]=jm(e);return ss(s,a,n,"SQL",e)}static invalid(e,n=null){if(!e)throw new Ot("need to specify a reason the DateTime is invalid");const s=e instanceof bn?e:new bn(e,n);if(rt.throwOnInvalid)throw new Qf(s);return new ee({invalid:s})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,n={}){const s=Md(e,Le.fromObject(n));return s?s.map(a=>a?a.val:null).join(""):null}static expandFormat(e,n={}){return Cd(Lt.parseFormat(e),Le.fromObject(n)).map(a=>a.val).join("")}static resetCache(){Fs=void 0,xo.clear()}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?Ga(this).weekYear:NaN}get weekNumber(){return this.isValid?Ga(this).weekNumber:NaN}get weekday(){return this.isValid?Ga(this).weekday:NaN}get isWeekend(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday)}get localWeekday(){return this.isValid?Xa(this).weekday:NaN}get localWeekNumber(){return this.isValid?Xa(this).weekNumber:NaN}get localWeekYear(){return this.isValid?Xa(this).weekYear:NaN}get ordinal(){return this.isValid?Ya(this.c).ordinal:NaN}get monthShort(){return this.isValid?Wi.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Wi.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Wi.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Wi.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed)return[this];const e=864e5,n=6e4,s=ea(this.c),a=this.zone.offset(s-e),l=this.zone.offset(s+e),u=this.zone.offset(s-a*n),p=this.zone.offset(s-l*n);if(u===p)return[this];const x=s-u*n,w=s-p*n,N=$i(x,u),O=$i(w,p);return N.hour===O.hour&&N.minute===O.minute&&N.second===O.second&&N.millisecond===O.millisecond?[Ar(this,{ts:x}),Ar(this,{ts:w})]:[this]}get isInLeapYear(){return _s(this.year)}get daysInMonth(){return Gi(this.year,this.month)}get daysInYear(){return this.isValid?cs(this.year):NaN}get weeksInWeekYear(){return this.isValid?Ps(this.weekYear):NaN}get weeksInLocalWeekYear(){return this.isValid?Ps(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN}resolvedLocaleOptions(e={}){const{locale:n,numberingSystem:s,calendar:a}=Lt.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:n,numberingSystem:s,outputCalendar:a}}toUTC(e=0,n={}){return this.setZone(Ht.instance(e),n)}toLocal(){return this.setZone(rt.defaultZone)}setZone(e,{keepLocalTime:n=!1,keepCalendarTime:s=!1}={}){if(e=fr(e,rt.defaultZone),e.equals(this.zone))return this;if(e.isValid){let a=this.ts;if(n||s){const l=e.offset(this.ts),u=this.toObject();[a]=Bi(u,l,e)}return Ar(this,{ts:a,zone:e})}else return ee.invalid(Ws(e))}reconfigure({locale:e,numberingSystem:n,outputCalendar:s}={}){const a=this.loc.clone({locale:e,numberingSystem:n,outputCalendar:s});return Ar(this,{loc:a})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const n=Xi(e,ml),{minDaysInFirstWeek:s,startOfWeek:a}=el(n,this.loc),l=!de(n.weekYear)||!de(n.weekNumber)||!de(n.weekday),u=!de(n.ordinal),p=!de(n.year),x=!de(n.month)||!de(n.day),w=p||x,N=n.weekYear||n.weekNumber;if((w||u)&&N)throw new as("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(x&&u)throw new as("Can't mix ordinal dates with month/day");let O;l?O=Qc({...qi(this.c,s,a),...n},s,a):de(n.ordinal)?(O={...this.toObject(),...n},de(n.day)&&(O.day=Math.min(Gi(O.year,O.month),O.day))):O=Jc({...Ya(this.c),...n});const[H,W]=Bi(O,this.o,this.zone);return Ar(this,{ts:H,o:W})}plus(e){if(!this.isValid)return this;const n=Ee.fromDurationLike(e);return Ar(this,fl(this,n))}minus(e){if(!this.isValid)return this;const n=Ee.fromDurationLike(e).negate();return Ar(this,fl(this,n))}startOf(e,{useLocaleWeeks:n=!1}={}){if(!this.isValid)return this;const s={},a=Ee.normalizeUnit(e);switch(a){case"years":s.month=1;case"quarters":case"months":s.day=1;case"weeks":case"days":s.hour=0;case"hours":s.minute=0;case"minutes":s.second=0;case"seconds":s.millisecond=0;break}if(a==="weeks")if(n){const l=this.loc.getStartOfWeek(),{weekday:u}=this;u<l&&(s.weekNumber=this.weekNumber-1),s.weekday=l}else s.weekday=1;if(a==="quarters"){const l=Math.ceil(this.month/3);s.month=(l-1)*3+1}return this.set(s)}endOf(e,n){return this.isValid?this.plus({[e]:1}).startOf(e,n).minus(1):this}toFormat(e,n={}){return this.isValid?Lt.create(this.loc.redefaultToEN(n)).formatDateTimeFromString(this,e):qa}toLocaleString(e=_i,n={}){return this.isValid?Lt.create(this.loc.clone(n),e).formatDateTime(this):qa}toLocaleParts(e={}){return this.isValid?Lt.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:n=!1,suppressMilliseconds:s=!1,includeOffset:a=!0,extendedZone:l=!1,precision:u="milliseconds"}={}){if(!this.isValid)return null;u=Yi(u);const p=e==="extended";let x=Za(this,p,u);return Vi.indexOf(u)>=3&&(x+="T"),x+=hl(this,p,n,s,a,l,u),x}toISODate({format:e="extended",precision:n="day"}={}){return this.isValid?Za(this,e==="extended",Yi(n)):null}toISOWeekDate(){return Hi(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:n=!1,includeOffset:s=!0,includePrefix:a=!1,extendedZone:l=!1,format:u="extended",precision:p="milliseconds"}={}){return this.isValid?(p=Yi(p),(a&&Vi.indexOf(p)>=3?"T":"")+hl(this,u==="extended",n,e,s,l,p)):null}toRFC2822(){return Hi(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return Hi(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Za(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:n=!1,includeOffsetSpace:s=!0}={}){let a="HH:mm:ss.SSS";return(n||e)&&(s&&(a+=" "),n?a+="z":e&&(a+="ZZ")),Hi(this,a,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():qa}[Symbol.for("nodejs.util.inspect.custom")](){return this.isValid?`DateTime { ts: ${this.toISO()}, zone: ${this.zone.name}, locale: ${this.locale} }`:`DateTime { Invalid, reason: ${this.invalidReason} }`}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const n={...this.c};return e.includeConfig&&(n.outputCalendar=this.outputCalendar,n.numberingSystem=this.loc.numberingSystem,n.locale=this.loc.locale),n}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,n="milliseconds",s={}){if(!this.isValid||!e.isValid)return Ee.invalid("created by diffing an invalid DateTime");const a={locale:this.locale,numberingSystem:this.numberingSystem,...s},l=Eh(n).map(Ee.normalizeUnit),u=e.valueOf()>this.valueOf(),p=u?this:e,x=u?e:this,w=Rm(p,x,l,a);return u?w.negate():w}diffNow(e="milliseconds",n={}){return this.diff(ee.now(),e,n)}until(e){return this.isValid?nt.fromDateTimes(this,e):this}hasSame(e,n,s){if(!this.isValid)return!1;const a=e.valueOf(),l=this.setZone(e.zone,{keepLocalTime:!0});return l.startOf(n,s)<=a&&a<=l.endOf(n,s)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const n=e.base||ee.fromObject({},{zone:this.zone}),s=e.padding?this<n?-e.padding:e.padding:0;let a=["years","months","days","hours","minutes","seconds"],l=e.unit;return Array.isArray(e.unit)&&(a=e.unit,l=void 0),gl(n,this.plus(s),{...e,numeric:"always",units:a,unit:l})}toRelativeCalendar(e={}){return this.isValid?gl(e.base||ee.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(ee.isDateTime))throw new Ot("min requires all arguments be DateTimes");return tl(e,n=>n.valueOf(),Math.min)}static max(...e){if(!e.every(ee.isDateTime))throw new Ot("max requires all arguments be DateTimes");return tl(e,n=>n.valueOf(),Math.max)}static fromFormatExplain(e,n,s={}){const{locale:a=null,numberingSystem:l=null}=s,u=Le.fromOpts({locale:a,numberingSystem:l,defaultToEN:!0});return Id(u,e,n)}static fromStringExplain(e,n,s={}){return ee.fromFormatExplain(e,n,s)}static buildFormatParser(e,n={}){const{locale:s=null,numberingSystem:a=null}=n,l=Le.fromOpts({locale:s,numberingSystem:a,defaultToEN:!0});return new jd(l,e)}static fromFormatParser(e,n,s={}){if(de(e)||de(n))throw new Ot("fromFormatParser requires an input string and a format parser");const{locale:a=null,numberingSystem:l=null}=s,u=Le.fromOpts({locale:a,numberingSystem:l,defaultToEN:!0});if(!u.equals(n.locale))throw new Ot(`fromFormatParser called with a locale of ${u}, but the format parser was created for ${n.locale}`);const{result:p,zone:x,specificOffset:w,invalidReason:N}=n.explainFromTokens(e);return N?ee.invalid(N):ss(p,x,s,`format ${n.format}`,e,w)}static get DATE_SHORT(){return _i}static get DATE_MED(){return Nl}static get DATE_MED_WITH_WEEKDAY(){return th}static get DATE_FULL(){return Rl}static get DATE_HUGE(){return Dl}static get TIME_SIMPLE(){return Al}static get TIME_WITH_SECONDS(){return Ol}static get TIME_WITH_SHORT_OFFSET(){return Ll}static get TIME_WITH_LONG_OFFSET(){return Ul}static get TIME_24_SIMPLE(){return zl}static get TIME_24_WITH_SECONDS(){return Wl}static get TIME_24_WITH_SHORT_OFFSET(){return Fl}static get TIME_24_WITH_LONG_OFFSET(){return $l}static get DATETIME_SHORT(){return Hl}static get DATETIME_SHORT_WITH_SECONDS(){return Pl}static get DATETIME_MED(){return Bl}static get DATETIME_MED_WITH_SECONDS(){return Vl}static get DATETIME_MED_WITH_WEEKDAY(){return nh}static get DATETIME_FULL(){return Yl}static get DATETIME_FULL_WITH_SECONDS(){return _l}static get DATETIME_HUGE(){return ql}static get DATETIME_HUGE_WITH_SECONDS(){return Gl}}function As(t){if(ee.isDateTime(t))return t;if(t&&t.valueOf&&hr(t.valueOf()))return ee.fromJSDate(t);if(t&&typeof t=="object")return ee.fromObject(t);throw new Ot(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const To=0,Zm=24,zr=60,$s=(Zm-To)*60/zr,Nd="ru",Ka=()=>typeof Intl>"u"?"UTC":Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",Km=t=>ee.now().setZone(t).startOf("day"),Qm=(t,e=5)=>{const n=Km(t);return Array.from({length:e},(s,a)=>n.plus({days:a}))},Jm=t=>{const e=t.set({hour:To,minute:0,second:0,millisecond:0});return Array.from({length:$s},(n,s)=>e.plus({minutes:s*zr}))},Os=(t,e)=>{const s=t.set({hour:To,minute:0,second:0,millisecond:0}).plus({minutes:e*zr}),a=s.plus({minutes:zr});return{start:s,end:a}},Qa=(t,e)=>{const n=t.toUTC().toISO({suppressMilliseconds:!0})??t.toUTC().toISO(),s=e.toUTC().toISO({suppressMilliseconds:!0})??e.toUTC().toISO();return{startUtcISO:n??t.toUTC().toISO()??"",endUtcISO:s??e.toUTC().toISO()??""}},Wr=t=>`${t.startUtcISO}|${t.endUtcISO}`,ep=t=>{const e=ee.fromISO(t.startUtcISO,{zone:"utc"}).toMillis(),n=ee.fromISO(t.endUtcISO,{zone:"utc"}).toMillis();return{startUtc:e,endUtc:n}},Or=(t,e,n)=>{const{startUtc:s,endUtc:a}=ep(t);return s<n&&a>e},Rd=t=>t.setLocale(Nd).toFormat("ccc dd.MM"),vo=t=>t.setLocale(Nd).toFormat("HH:mm"),Pi=(t,e,n)=>{const s=ee.fromISO(t,{zone:"utc"}).setZone(n),a=ee.fromISO(e,{zone:"utc"}).setZone(n);return{dayLabel:Rd(s),startLabel:vo(s),endLabel:vo(a)}},xl=(t,e,n)=>{const s=t[e]??{},a=s[n]??[];return{conversation:s,intervals:a}},tp=(t,e)=>{const n=new Map(t.map(s=>[Wr(s),s]));for(const s of e)n.set(Wr(s),s);return Array.from(n.values())},np=(t,e)=>{const n=new Set(e.map(Wr));return t.filter(s=>!n.has(Wr(s)))},Ls=Il(t=>({availabilityByConversation:{},chatsByConversation:{},proposalsByConversation:{},addIntervals:(e,n,s)=>{t(a=>{const{conversation:l,intervals:u}=xl(a.availabilityByConversation,e,n),p=tp(u,s);return{availabilityByConversation:{...a.availabilityByConversation,[e]:{...l,[n]:p}}}})},removeIntervals:(e,n,s)=>{t(a=>{const{conversation:l,intervals:u}=xl(a.availabilityByConversation,e,n),p=np(u,s);return{availabilityByConversation:{...a.availabilityByConversation,[e]:{...l,[n]:p}}}})},setIntervals:(e,n,s)=>{t(a=>({availabilityByConversation:{...a.availabilityByConversation,[e]:{...a.availabilityByConversation[e]??{},[n]:s}}}))},addChatMessage:(e,n,s)=>{t(a=>{const l=a.chatsByConversation[e]??{},u=l[n]??[];return{chatsByConversation:{...a.chatsByConversation,[e]:{...l,[n]:[...u,s]}}}})},setProposals:(e,n)=>{t(s=>({proposalsByConversation:{...s.proposalsByConversation,[e]:n}}))},upsertProposal:(e,n)=>{t(s=>{const a=s.proposalsByConversation[e]??[],l=a.findIndex(p=>p.id===n.id),u=l>=0?[...a.slice(0,l),n,...a.slice(l+1)]:[n,...a];return{proposalsByConversation:{...s.proposalsByConversation,[e]:u}}})},removeProposal:(e,n)=>{t(s=>{const a=s.proposalsByConversation[e]??[];return{proposalsByConversation:{...s.proposalsByConversation,[e]:a.filter(l=>l.id!==n)}}})}})),vl={active:!1,mode:"add",didMove:!1,button:0},rp=({isOpen:t,conversationId:e,viewerId:n,peerId:s,viewerTimeZone:a,peerTimeZone:l,peerName:u,onClose:p})=>{const[x,w]=d.useState(0),[N,O]=d.useState(()=>new Set),[H,W]=d.useState(vl),[L,q]=d.useState(!1),[V,ue]=d.useState(null),[be,Xe]=d.useState(null),[ge,Te]=d.useState(null),ie=d.useRef(null),Ze=d.useRef(!1),ze=d.useRef(!1),Ie=d.useRef(null),st=d.useRef(null),Be=d.useRef({}),Ne=Ls(y=>y.availabilityByConversation),Et=Ls(y=>y.proposalsByConversation),Fe=Ls(y=>y.setIntervals),Ut=Ls(y=>y.setProposals),Un=Ls(y=>y.removeProposal),G=d.useMemo(()=>Qm(a,5),[a]),pn=d.useMemo(()=>Jm(G[0]),[G]),wt=Ne[e]?.[n]??[],Oe=Ne[e]?.[s]??[],mt=Et[e]??[],We=d.useMemo(()=>{const y=Date.now();return mt.filter(j=>{const S=Date.parse(j.maxEndUtcISO);return Number.isFinite(S)&&S>y})},[mt]);d.useEffect(()=>{if(!t)return;const y=window.setInterval(()=>w(j=>j+1),3e4);return()=>window.clearInterval(y)},[t]),d.useEffect(()=>{if(!t)return;const y=j=>{j.key==="Escape"&&O(new Set)};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[t]),d.useEffect(()=>{if(!t)return;const y=()=>W(vl);return window.addEventListener("mouseup",y),()=>window.removeEventListener("mouseup",y)},[t]),d.useEffect(()=>{t&&(Ze.current=!0,ae.get(`/conversations/${e}/availability`).then(y=>{const j=y?.data?.intervalsByUserId??{};Fe(e,n,j[n]??[]),Fe(e,s,j[s]??[])}).catch(y=>{console.error("[Availability] Failed to load",y)}).finally(()=>{Ze.current=!1}))},[t,e,n,s,Fe]);const Y=()=>ae.get(`/conversations/${e}/availability/proposals`).then(y=>{const S=(y?.data?.proposals??[]).map(M=>({id:M.id,createdAt:Date.parse(M.createdAt),createdById:M.createdById,maxEndUtcISO:M.maxEndUtcISO,note:M.note??null,ranges:M.ranges??[],reactionsByUserId:M.reactionsByUserId??{}}));Ut(e,S)}).catch(y=>{console.error("[Availability] Failed to load proposals",y)});d.useEffect(()=>{t&&Y()},[t,e]),d.useEffect(()=>{if(!t)return;const y=window.setInterval(()=>{Y()},5e3);return()=>window.clearInterval(y)},[t,e]),d.useEffect(()=>{if(!t)return;const y=window.setInterval(()=>{ae.get(`/conversations/${e}/availability`).then(j=>{const S=j?.data?.intervalsByUserId??{};Fe(e,s,S[s]??[])}).catch(()=>{})},3e3);return()=>window.clearInterval(y)},[t,e,n,s,Fe]),d.useEffect(()=>{if(!t)return;const y=j=>{j&&j.conversationId===e&&ae.get(`/conversations/${e}/availability`).then(S=>{const M=S?.data?.intervalsByUserId??{};Fe(e,s,M[s]??[])}).catch(()=>{})};return Pe.on("availability:updated",y),()=>{Pe.off("availability:updated",y)}},[t,e,n,s,Fe]),d.useEffect(()=>{if(!t)return;const y=j=>{j&&j.conversationId===e&&Y()};return Pe.on("availability:proposals:updated",y),()=>{Pe.off("availability:proposals:updated",y)}},[t,e]),d.useEffect(()=>{if(t&&!Ze.current)return ie.current&&window.clearTimeout(ie.current),ie.current=window.setTimeout(()=>{ae.put(`/conversations/${e}/availability/me`,{intervals:wt}).then(()=>{ze.current=!1}).catch(y=>console.error("[Availability] Failed to save",y))},500),()=>{ie.current&&window.clearTimeout(ie.current),ie.current=null}},[wt,t,e]),d.useEffect(()=>{if(!t)return;const y=new Set;N.forEach(j=>{const[S,M]=j.split(":").map(z=>Number(z));Number.isNaN(S)||Number.isNaN(M)||Q(S,M)&&y.add(j)}),y.size!==N.size&&O(y)},[wt,Oe]);const Q=(y,j)=>{const{startUtc:S,endUtc:M}=te(y,j),z=wt.some(X=>Or(X,S,M)),U=Oe.some(X=>Or(X,S,M));return z&&U},te=(y,j)=>{const{start:S,end:M}=Os(G[y],j),z=S.toUTC().toMillis(),U=M.toUTC().toMillis();return{startUtc:z,endUtc:U,startLocal:S,endLocal:M}},oe=d.useMemo(()=>{const y=ee.now().setZone(a),j=G.findIndex(le=>le.hasSame(y,"day"));if(j<0)return null;const S=y.diff(G[j].startOf("day"),"minutes").minutes;if(S<0||S>1440)return null;const M=28,z=36,U=z+S/zr*M,X=z+$s*M;return U<z||U>X?null:{top:U,label:y.setLocale("ru").toFormat("HH:mm")}},[G,x,a]);d.useEffect(()=>{if(!t)return;const y=Ie.current;if(!y||!oe)return;const j=Math.max(0,oe.top-160);y.scrollTop=j},[t,oe]);const Ke=(y,j,S)=>{const{startLocal:M,endLocal:z}=te(y,j),U=Qa(M,z);if(S==="add"){ze.current=!0;const he=new Map(wt.map(Re=>[Wr(Re),Re]));he.set(Wr(U),U),Fe(e,n,Array.from(he.values()));return}const{startUtc:X,endUtc:le}=te(y,j);ze.current=!0;const re=wt.filter(he=>!Or(he,X,le));Fe(e,n,re)},Ce=(y,j)=>{const S=`${y}:${j}`;O(M=>{const z=new Set(M);return z.has(S)?z.delete(S):z.add(S),z})},et=(y,j,S)=>{if(y.button!==0&&y.button!==2)return;y.preventDefault();const M=y.button===2?"remove":"add",z=Q(j,S),U=M==="remove"?!0:!z;W({active:!0,mode:M,didMove:!1,button:y.button,startCell:{dayIndex:j,rowIndex:S},paint:U}),U&&Ke(j,S,M)},it=(y,j)=>{H.active&&H.paint&&(W(S=>({...S,didMove:!0})),Ke(y,j,H.mode))},Tt=(y,j,S)=>{if(!H.didMove&&y.button===0&&Q(j,S)){Ce(j,S);return}},ot=d.useMemo(()=>{const y=new Map;N.forEach(S=>{const[M,z]=S.split(":").map(U=>Number(U));Number.isNaN(M)||Number.isNaN(z)||(y.has(M)||y.set(M,[]),y.get(M)?.push(z))});const j=[];for(const[S,M]of y.entries()){const z=Array.from(new Set(M)).sort((he,Re)=>he-Re);if(z.length===0)continue;let U=z[0],X=z[0];for(let he=1;he<z.length;he+=1){const Re=z[he];if(Re===X+1)X=Re;else{const Qe=Os(G[S],U).start,bt=Os(G[S],X).end;j.push(Qa(Qe,bt)),U=Re,X=Re}}const le=Os(G[S],U).start,re=Os(G[S],X).end;j.push(Qa(le,re))}return j.sort((S,M)=>S.startUtcISO.localeCompare(M.startUtcISO))},[N,G]),zn=()=>{ot.length!==0&&ae.post(`/conversations/${e}/availability/proposals`,{ranges:ot}).then(()=>{O(new Set),Y()}).catch(y=>console.error("[Availability] Failed to create proposal",y))},ps=y=>{ae.delete(`/conversations/${e}/availability/proposals/${y}`).then(()=>{Un(e,y)}).catch(j=>console.error("[Availability] Failed to delete proposal",j))},Wn=(y,j)=>{ae.put(`/conversations/${e}/availability/proposals/${y}/reaction`,{value:j}).then(()=>void Y()).catch(S=>console.error("[Availability] Failed to react",S))},gn=y=>{const j=y.reactionsByUserId[n]??null,S=y.reactionsByUserId[s]??null;return j==="NO"||S==="NO"?{kind:"DECLINED",label:"отклонено"}:j==="MAYBE"||S==="MAYBE"?{kind:"MAYBE",label:"под вопросом"}:j==="YES"&&S==="YES"?{kind:"AGREED",label:"договорились"}:y.createdById===n?{kind:"REQUESTED_BY_ME",label:"запросили мы"}:{kind:"REQUESTED_OF_ME",label:"запросили у нас"}},mr=d.useMemo(()=>{const y=[];for(const M of We){const z=gn(M);for(const U of M.ranges){const X=ee.fromISO(U.startUtcISO,{zone:"utc"}).setZone(a),le=ee.fromISO(U.endUtcISO,{zone:"utc"}).setZone(a);let re=X;for(;re<le;){const he=re.startOf("day"),Re=he.plus({days:1}),Qe=le<Re?le:Re,bt=G.findIndex(Ve=>Ve.hasSame(re,"day"));if(bt>=0){const Ve=Math.max(0,Math.floor(re.diff(he,"minutes").minutes)),ft=Math.min(1440,Math.ceil(Qe.diff(he,"minutes").minutes)),en=Math.max(0,Math.min($s-1,Math.floor(Ve/zr))),ct=Math.max(0,Math.min($s-1,Math.ceil(ft/zr)-1));ct>=en&&y.push({proposalId:M.id,dayIndex:bt,startRow:en,endRow:ct,kind:z.kind,label:z.label})}re=Qe}}}const j=new Map;for(const M of y){const z=`${M.proposalId}|${M.dayIndex}|${M.kind}`,U=j.get(z)??[];U.push(M),j.set(z,U)}const S=[];for(const M of j.values()){const z=M.sort((X,le)=>X.startRow-le.startRow);let U={...z[0]};for(let X=1;X<z.length;X+=1){const le=z[X];le.startRow<=U.endRow+1?U.endRow=Math.max(U.endRow,le.endRow):(S.push(U),U={...le})}S.push(U)}return S},[We,G,a,n,s]),C=(y,j)=>{const S={AGREED:5,DECLINED:4,MAYBE:3,REQUESTED_BY_ME:2,REQUESTED_OF_ME:1};let M=null;for(const z of We){if(!z.ranges.some(re=>Or(re,y,j)))continue;const X=gn(z).kind,le=S[X]*1e6+z.createdAt;(!M||le>M.score)&&(M={proposal:z,kind:X,score:le})}return M?{proposalId:M.proposal.id,kind:M.kind}:null};d.useEffect(()=>{if(!t)return;const y=new Set;N.forEach(j=>{const[S,M]=j.split(":").map(X=>Number(X));if(Number.isNaN(S)||Number.isNaN(M))return;const{startUtc:z,endUtc:U}=te(S,M);C(z,U)||y.add(j)}),y.size!==N.size&&O(y)},[We]);const B=(y,j)=>{const{startUtc:S,endUtc:M}=te(y,j),z=wt.some(Ve=>Or(Ve,S,M)),U=Oe.some(Ve=>Or(Ve,S,M)),X=z&&U,re=!!C(S,M),he=N.has(`${y}:${j}`),Qe=["availability-cell",[6,7].includes(G[y].weekday)?"weekend":"",z?"filled-me":"",U?"filled-peer":"",X&&!re?"overlap":"",re?"covered-by-proposal":"",he?"selected":"",L?"only-overlap":""].filter(Boolean).join(" "),bt=L&&!X;return r.jsx("div",{className:Qe,"data-hidden":bt?"true":"false",onMouseDown:Ve=>et(Ve,y,j),onMouseEnter:()=>it(y,j),onMouseMove:()=>Xe({dayIndex:y,rowIndex:j}),onMouseLeave:()=>Xe(null),onMouseUp:Ve=>Tt(Ve,y,j)},`cell-${y}-${j}`)};return t?Ur.createPortal(r.jsx("div",{className:"availability-overlay",onClick:p,children:r.jsxs("div",{className:"availability-panel",onClick:y=>y.stopPropagation(),onContextMenu:y=>y.preventDefault(),children:[r.jsxs("header",{className:"availability-header",children:[r.jsxs("div",{children:[r.jsx("div",{className:"availability-title",children:"Календарь доступности"}),r.jsxs("div",{className:"availability-subtitle",children:[a," · ",u??"Собеседник"," (",l,")"]})]}),r.jsx("button",{className:"btn btn-icon btn-ghost",type:"button",onClick:p,children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{className:"availability-content",children:[r.jsxs("section",{className:"availability-left",children:[r.jsx("div",{className:"availability-controls",children:r.jsxs("div",{className:"availability-hints",children:[r.jsx("span",{children:"ЛКМ — закрасить"}),r.jsx("span",{children:"ПКМ — стереть"}),r.jsx("span",{children:"Шаг — 1 час"}),r.jsx("span",{children:"Esc — очистить выбор"})]})}),r.jsxs("div",{className:"availability-legend",children:[r.jsxs("div",{children:[r.jsx("span",{className:"legend-swatch me"})," Моё"]}),r.jsxs("div",{children:[r.jsx("span",{className:"legend-swatch peer"})," Собеседник"]}),r.jsxs("div",{children:[r.jsx("span",{className:"legend-swatch overlap"})," Пересечение"]})]}),r.jsx("div",{className:"availability-grid-wrapper",ref:Ie,children:r.jsxs("div",{className:"availability-grid-inner",children:[oe&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"availability-now-label",style:{top:oe.top},children:["сейчас ",oe.label]}),r.jsx("div",{className:"availability-now-line",style:{top:oe.top}})]}),r.jsx("div",{className:"availability-proposal-layer",style:{gridTemplateColumns:`72px repeat(${G.length}, 1fr)`,gridTemplateRows:`36px repeat(${$s}, 28px)`},children:mr.map(y=>r.jsx("div",{className:["availability-proposal-block",`kind-${y.kind}`,V===y.proposalId||ge===y.proposalId?"focus":""].filter(Boolean).join(" "),style:{gridColumnStart:2+y.dayIndex,gridColumnEnd:2+y.dayIndex+1,gridRowStart:2+y.startRow,gridRowEnd:2+y.endRow+1},onMouseEnter:()=>ue(y.proposalId),onMouseLeave:()=>ue(null),onClick:()=>{Te(y.proposalId);const j=Be.current[y.proposalId];j&&j.scrollIntoView({block:"nearest",behavior:"smooth"})},children:r.jsx("div",{className:"availability-proposal-block-label",children:y.label})},`${y.proposalId}-${y.dayIndex}-${y.startRow}-${y.endRow}-${y.kind}`))}),r.jsxs("div",{className:"availability-grid",style:{gridTemplateColumns:`72px repeat(${G.length}, 1fr)`},children:[r.jsx("div",{className:"availability-corner"}),G.map((y,j)=>r.jsx("div",{className:`availability-day-label ${[6,7].includes(y.weekday)?"weekend":""}`,children:r.jsx("div",{children:Rd(y)})},`day-${j}`)),pn.map((y,j)=>r.jsxs("div",{className:"availability-row",children:[r.jsx("div",{className:"availability-time-label",children:vo(y)}),G.map((S,M)=>B(M,j))]},`row-${j}`))]})]})})]}),r.jsxs("aside",{className:"availability-right",children:[r.jsxs("div",{className:"availability-block",children:[r.jsx("div",{className:"availability-block-title",children:"Выбранное пересечение"}),ot.length===0?r.jsx("div",{className:"availability-empty",children:"Выберите оранжевые слоты, чтобы собрать диапазоны."}):r.jsx("div",{className:"availability-ranges",children:ot.map(y=>{const j=Pi(y.startUtcISO,y.endUtcISO,a),S=Pi(y.startUtcISO,y.endUtcISO,l);return r.jsxs("div",{className:"availability-range-card",children:[r.jsxs("div",{className:"availability-range-main",children:[j.dayLabel," · ",j.startLabel,"–",j.endLabel]}),r.jsxs("div",{className:"availability-range-sub",children:["у собеседника: ",S.startLabel,"–",S.endLabel]})]},`${y.startUtcISO}-${y.endUtcISO}`)})}),r.jsx("button",{type:"button",className:"btn btn-secondary availability-propose",onClick:zn,disabled:ot.length===0,children:"Предложить слот"})]}),r.jsxs("div",{className:"availability-block",children:[r.jsx("div",{className:"availability-block-title",children:"История предложений"}),We.length===0?r.jsx("div",{className:"availability-empty",children:"Пока нет предложений."}):r.jsx("div",{className:"availability-proposals",ref:st,children:We.map(y=>{const j=y.reactionsByUserId[n]??null,S=y.reactionsByUserId[s]??null,M=j==="YES"&&S==="YES",z=be&&(()=>{const{startUtc:U,endUtc:X}=te(be.dayIndex,be.rowIndex);return y.ranges.some(le=>Or(le,U,X))})();return r.jsxs("div",{className:["availability-proposal-card",`status-${gn(y).kind}`,M?"matched":"",V===y.id?"hovered":"",z?"linked":"",ge===y.id?"selected":""].filter(Boolean).join(" "),ref:U=>{Be.current[y.id]=U},onMouseEnter:()=>ue(y.id),onMouseLeave:()=>ue(null),onClick:()=>Te(y.id),children:[r.jsxs("div",{className:"availability-proposal-title",children:["Предложение · ",ee.fromMillis(y.createdAt).toLocaleString(ee.DATE_SHORT)]}),r.jsx("div",{className:"availability-proposal-body",children:y.ranges.map(U=>{const X=Pi(U.startUtcISO,U.endUtcISO,a),le=Pi(U.startUtcISO,U.endUtcISO,l);return r.jsxs("div",{className:"availability-range-card",children:[r.jsxs("div",{className:"availability-range-main",children:[X.dayLabel," · ",X.startLabel,"–",X.endLabel]}),r.jsxs("div",{className:"availability-range-sub",children:["у собеседника: ",le.startLabel,"–",le.endLabel]})]},Wr(U))})}),r.jsxs("div",{className:"availability-reactions",children:[r.jsx("button",{type:"button",className:`availability-reaction ${j==="YES"?"active":""}`,title:"Могу",onClick:()=>Wn(y.id,j==="YES"?null:"YES"),children:r.jsx(io,{size:16})}),r.jsx("button",{type:"button",className:`availability-reaction ${j==="MAYBE"?"active":""}`,title:"Возможно",onClick:()=>Wn(y.id,j==="MAYBE"?null:"MAYBE"),children:r.jsx(mf,{size:16})}),r.jsx("button",{type:"button",className:`availability-reaction ${j==="NO"?"active":""}`,title:"Не могу",onClick:()=>Wn(y.id,j==="NO"?null:"NO"),children:r.jsx(gf,{size:16})}),r.jsxs("span",{className:"availability-reaction-label",children:["вы: ",j??"—"," · ",u??"собеседник",": ",S??"—"]}),y.createdById===n&&r.jsx("button",{type:"button",className:"availability-reaction danger",title:"Удалить",onClick:()=>ps(y.id),children:r.jsx(ao,{size:16})})]})]},y.id)})})]}),r.jsx("div",{className:"availability-block availability-privacy",children:r.jsxs("button",{type:"button",className:"btn btn-ghost",onClick:()=>q(y=>!y),children:[L?r.jsx(kf,{size:16}):r.jsx(Cf,{size:16}),L?"Показывать все слоты":"Показывать только пересечения"]})})]})]})]})}),document.body):null};async function wl(t={}){if(typeof navigator>"u"||!navigator.mediaDevices?.getUserMedia)return{ok:!0};const e=t.audio!==!1,n=!!t.video;if(!e&&!n)return{ok:!0};const s={audio:e,video:n};let a=null;try{return a=await navigator.mediaDevices.getUserMedia(s),{ok:!0}}catch(l){return{ok:!1,error:l??new Error("Unknown media error")}}finally{a&&a.getTracks().forEach(l=>{try{l.stop()}catch{}})}}function Zi(t){if(!t)return null;if(t.startsWith("blob:")||t.startsWith("data:")||t.startsWith("/"))return t;let e;try{e=new URL(t)}catch{return t}if(e.pathname.startsWith("/api/files/"))return`${e.pathname}${e.search||""}${e.hash||""}`;const n=e.pathname.split("/").filter(Boolean).map(a=>encodeURIComponent(decodeURIComponent(a))).join("/");if(!n)return t;const s=`${e.search||""}${e.hash||""}`;return`/api/files/${n}${s}`}function sp(t){let e=0;for(let u=0;u<t.length;u++)e=t.charCodeAt(u)+((e<<5)-e);const n=Math.abs(e),s=24+n%18-9,a=60+n%15,l=30+n%12;return`hsl(${s} ${a}% ${l}%)`}const ip=3,Ja=[500,1500,3e3];function vt({name:t,size:e=40,id:n=t,presence:s,avatarUrl:a}){const l=sp(n),u=(t||"?").trim().charAt(0).toUpperCase(),p=!!a?.startsWith("emoji:"),x=p?a.slice(6):null,[w,N]=d.useState(!1),[O,H]=d.useState(0),[W,L]=d.useState(null),q=d.useRef(null),V=d.useMemo(()=>{if(!a||p)return a??null;if(a.startsWith("data:")||typeof window>"u")return a;const ge=Zi(a);if(ge&&ge!==a)return ge;try{if(a.startsWith("http://")||a.startsWith("https://"))return a;const Te=window.location,ie=new URL(a,Te.origin);return ie.host===Te.host&&ie.protocol!==Te.protocol&&(ie.protocol=Te.protocol),ie.toString()}catch{return a}},[a,p]),ue=d.useMemo(()=>{if(!s)return null;switch(s){case"ONLINE":return"#22c55e";case"IN_CALL":return"#ef4444";case"BACKGROUND":return"#facc15";case"AWAY":return"#f59e0b";default:return"#9ca3af"}},[s]);d.useEffect(()=>{N(!1),H(0),L(null),q.current&&(clearTimeout(q.current),q.current=null)},[a]),d.useEffect(()=>{V&&!p&&L(V)},[V,p]);const be=()=>{if(O<ip&&V&&!p){const ge=Ja[O]||Ja[Ja.length-1];q.current=setTimeout(()=>{try{if(V.startsWith("data:"))L(V);else{const Te=new URL(V,typeof window<"u"?window.location.origin:void 0);Te.searchParams.set("_retry",String(O+1)),Te.searchParams.set("_t",String(Date.now())),L(Te.toString())}H(Te=>Te+1)}catch(Te){console.warn("[Avatar] Failed to parse URL for retry:",V,Te),L(V),H(ie=>ie+1)}},ge)}else N(!0)};d.useEffect(()=>()=>{q.current&&clearTimeout(q.current)},[]);const Xe=W&&!p&&!w;return r.jsxs("div",{style:{width:e,height:e,borderRadius:"50%",background:l,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,position:"relative"},children:[Xe?r.jsx("img",{src:W,alt:t,style:{width:"100%",height:"100%",borderRadius:"50%",objectFit:"cover",objectPosition:"center"},onError:be,onLoad:()=>{O>0&&H(0)}}):p?r.jsx("span",{style:{fontSize:Math.floor(e*.6)},children:x}):u,ue&&r.jsx("span",{style:{position:"absolute",right:-2,bottom:-2,width:Math.max(8,Math.floor(e*.28)),height:Math.max(8,Math.floor(e*.28)),borderRadius:"50%",boxShadow:"0 0 0 2px var(--surface-200)",background:ue}})]})}const eo=["#ff4d4f","#ff9f0a","#ffd60a","#34c759","#0a84ff","#a855f7"],to=[4,8,14],wn=24,An=80;function ap({open:t,image:e,onClose:n,onApply:s}){const[a,l]=d.useState(null),[u,p]=d.useState({width:0,height:0}),[x,w]=d.useState(1),[N,O]=d.useState({x:0,y:0}),[H,W]=d.useState({width:0,height:0}),[L,q]=d.useState({x:0,y:0,width:0,height:0}),[V,ue]=d.useState("crop"),[be,Xe]=d.useState(eo[0]),[ge,Te]=d.useState(to[1]),[ie,Ze]=d.useState([]),[ze,Ie]=d.useState(null),[st,Be]=d.useState(()=>typeof window<"u"&&window.innerWidth<=768),[Ne,Et]=d.useState(!1),Fe=d.useRef(null),Ut=d.useRef(null),Un=d.useRef(null),G=d.useRef({type:null,startX:0,startY:0,initial:{x:0,y:0,width:0,height:0}}),pn=d.useRef(null),wt=d.useRef(null),Oe=d.useRef(null),mt=t&&!!e&&!!a&&u.width>0&&u.height>0;d.useEffect(()=>{const C=()=>Be(window.innerWidth<=768);return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]);const We=async()=>{if(!a||!Un.current||Ne)return;Et(!0);const C=L.width/L.height,B=Math.max(L.x,N.x),y=Math.max(L.y,N.y),j=Math.min(L.x+L.width,N.x+H.width),S=Math.min(L.y+L.height,N.y+H.height),M=j-B,z=S-y,U=a.naturalWidth/H.width,X=a.naturalHeight/H.height;let le=(B-N.x)*U,re=(y-N.y)*X,he=M*U,Re=z*X;he/Re>C?he=Re*C:Re=he/C;const bt=a.naturalWidth,Ve=a.naturalHeight;let ft=Math.max(0,le),en=Math.max(0,re),ct=Math.max(1,Math.min(he,bt-ft)),kt=Math.max(1,Math.min(Re,Ve-en));const pr=ct/kt;Math.abs(pr-C)>.01&&(pr>C?ct=kt*C:kt=ct/C,ct=Math.max(1,Math.min(ct,bt-ft)),kt=Math.max(1,Math.min(kt,Ve-en)));const F=document.createElement("canvas"),Sn=Math.max(1,Math.round(ct)),St=Math.max(1,Math.round(kt));F.width=Sn,F.height=St;const Ye=F.getContext("2d");if(!Ye){Et(!1);return}Ye.drawImage(a,ft,en,ct,kt,0,0,Sn,St);const at=Sn/M,Cn=St/z;Ye.lineCap="round",Ye.lineJoin="round";const Fn=[...ie,...ze?[ze]:[]];for(const zt of Fn){if(!zt.points.length)continue;Ye.strokeStyle=zt.color,Ye.lineWidth=zt.size*((at+Cn)/2),Ye.beginPath();const ht=zt.points[0],Je=(ht.x-B)*at,He=(ht.y-y)*Cn;Ye.moveTo(Je,He);for(let Bt=1;Bt<zt.points.length;Bt++){const Vt=zt.points[Bt];Ye.lineTo((Vt.x-B)*at,(Vt.y-y)*Cn)}Ye.stroke()}const Pt=new Image;Pt.src=F.toDataURL(),await new Promise(zt=>{Pt.onload=()=>{l(Pt);const ht=Pt.naturalWidth/Pt.naturalHeight;let Je,He;if(st){const Yt=window.innerWidth,In=window.innerHeight-200-60,tn=Yt;ht>tn/In?(Je=tn,He=tn/ht):(He=In,Je=In*ht)}else{const Yt=Math.min(window.innerWidth-64,720),Ct=Math.min(window.innerHeight-200,520);ht>Yt/Ct?(Je=Math.max(280,Yt),He=Je/ht):(He=Math.max(220,Ct),Je=He*ht)}p({width:Je,height:He});const Bt=Je/Pt.naturalWidth;w(Bt),W({width:Je,height:He}),O({x:0,y:0});const Vt=2,$n=Math.max(An,Je-Vt*2),jn=Math.max(An,He-Vt*2);q({x:Vt,y:Vt,width:$n,height:jn});const Xn=Je/Sn,sa=He/St,Xs=Fn.map(Yt=>({...Yt,points:Yt.points.map(Ct=>{const xr=(Ct.x-B)*at,gs=(Ct.y-y)*Cn,In=xr*Xn,tn=gs*sa;return{x:In,y:tn}})}));Ze(Xs.filter(Yt=>Yt.points.every(Ct=>Ct.x>=0&&Ct.x<=Je&&Ct.y>=0&&Ct.y<=He))),Ie(null),setTimeout(()=>{Y()},0);const gr=performance.now(),Zs=300,yr=Yt=>{const Ct=Yt-gr;Math.min(Ct/Zs,1)<1?Oe.current=requestAnimationFrame(yr):(Et(!1),Oe.current=null,setTimeout(()=>{Y()},0))};Oe.current=requestAnimationFrame(yr),zt()}})};d.useEffect(()=>()=>{Oe.current&&cancelAnimationFrame(Oe.current)},[]),d.useEffect(()=>{if(!t||!e){l(null),Ze([]),Ie(null),Et(!1);return}const C=new Image;return C.crossOrigin="anonymous",C.onload=()=>{if(l(C),st){const B=window.innerWidth,M=window.innerHeight-200-60,z=B;let U=C.naturalWidth,X=C.naturalHeight;const le=z/U,re=M/X,he=Math.min(le,re);U=C.naturalWidth*he,X=C.naturalHeight*he,p({width:z,height:M}),w(he),W({width:U,height:X});const Re={x:(z-U)/2,y:(M-X)/2};O(Re);const Qe=2;q({x:Qe,y:Qe,width:z-Qe*2,height:M-Qe*2})}else{const B=Math.min(window.innerWidth-64,720),y=Math.min(window.innerHeight-200,520);let j=C.naturalWidth,S=C.naturalHeight;if(j>B){const re=B/j;j*=re,S*=re}if(S>y){const re=y/S;j*=re,S*=re}j=Math.max(280,j),S=Math.max(220,S),p({width:j,height:S});const M=Math.max(j/C.naturalWidth,S/C.naturalHeight);w(M);const z=C.naturalWidth*M,U=C.naturalHeight*M;W({width:z,height:U});const X={x:(j-z)/2,y:(S-U)/2};O(X);const le=2;q({x:le,y:le,width:j-le*2,height:S-le*2})}Ze([]),Ie(null),ue("crop"),Et(!1)},C.src=e.previewUrl,wt.current=()=>{C.src=""},()=>{wt.current?.(),wt.current=null}},[t,e?.id,e?.previewUrl,st]),d.useEffect(()=>{t||(Ze([]),Ie(null),Et(!1))},[t]);const Y=()=>{const C=Ut.current;if(!C||u.width===0||u.height===0)return;const B=C.getContext("2d");if(!B)return;const y=window.devicePixelRatio||1;(C.width!==u.width*y||C.height!==u.height*y)&&(C.width=u.width*y,C.height=u.height*y,C.style.width=`${u.width}px`,C.style.height=`${u.height}px`),B.save(),B.scale(y,y),B.clearRect(0,0,u.width,u.height);const j=ze?[...ie,ze]:ie;B.lineCap="round",B.lineJoin="round";for(const S of j)if(S.points.length!==0){B.strokeStyle=S.color,B.lineWidth=S.size,B.beginPath(),B.moveTo(S.points[0].x,S.points[0].y);for(let M=1;M<S.points.length;M++)B.lineTo(S.points[M].x,S.points[M].y);B.stroke()}B.restore()};d.useEffect(()=>{Y()},[ie,ze,u.width,u.height]),d.useEffect(()=>{const C=B=>{t&&B.key==="Escape"&&(B.preventDefault(),n())};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[t,n]);const Q=(C,B,y)=>{const S=wn/2;return Math.abs(C-y.x)<S&&Math.abs(B-y.y)<S?"nw":Math.abs(C-(y.x+y.width))<S&&Math.abs(B-y.y)<S?"ne":Math.abs(C-y.x)<S&&Math.abs(B-(y.y+y.height))<S?"sw":Math.abs(C-(y.x+y.width))<S&&Math.abs(B-(y.y+y.height))<S?"se":Math.abs(C-y.x)<S&&B>=y.y&&B<=y.y+y.height?"w":Math.abs(C-(y.x+y.width))<S&&B>=y.y&&B<=y.y+y.height?"e":Math.abs(B-y.y)<S&&C>=y.x&&C<=y.x+y.width?"n":Math.abs(B-(y.y+y.height))<S&&C>=y.x&&C<=y.x+y.width?"s":C>=y.x&&C<=y.x+y.width&&B>=y.y&&B<=y.y+y.height?"move":null},te=C=>{const M=u.width-2,z=u.height-2,U=Math.max(2,Math.min(M-C.width,C.x)),X=Math.max(2,Math.min(z-C.height,C.y)),le=Math.max(An,Math.min(M-U,C.width)),re=Math.max(An,Math.min(z-X,C.height));return{x:U,y:X,width:le,height:re}},oe=C=>{if(V!=="crop"||Ne||!Fe.current)return;C.preventDefault();const B=Fe.current.getBoundingClientRect(),y=C.clientX-B.left,j=C.clientY-B.top,S=Q(y,j,L);S&&(Fe.current.setPointerCapture(C.pointerId),G.current={type:S==="move"?"move":"resize",handle:S!=="move"?S:void 0,startX:C.clientX,startY:C.clientY,initial:{...L}})},Ke=C=>{if(V!=="crop"||!G.current.type||Ne||(C.preventDefault(),!Fe.current?.getBoundingClientRect()))return;const y=C.clientX-G.current.startX,j=C.clientY-G.current.startY,S=y,M=j;if(G.current.type==="move"){const z={x:G.current.initial.x+S,y:G.current.initial.y+M,width:G.current.initial.width,height:G.current.initial.height};q(te(z))}else if(G.current.type==="resize"&&G.current.handle){const z=G.current.handle;let U={...G.current.initial};z==="nw"?(U.x=G.current.initial.x+S,U.y=G.current.initial.y+M,U.width=G.current.initial.width-S,U.height=G.current.initial.height-M):z==="ne"?(U.y=G.current.initial.y+M,U.width=G.current.initial.width+S,U.height=G.current.initial.height-M):z==="sw"?(U.x=G.current.initial.x+S,U.width=G.current.initial.width-S,U.height=G.current.initial.height+M):z==="se"?(U.width=G.current.initial.width+S,U.height=G.current.initial.height+M):z==="n"?(U.y=G.current.initial.y+M,U.height=G.current.initial.height-M):z==="s"?U.height=G.current.initial.height+M:z==="w"?(U.x=G.current.initial.x+S,U.width=G.current.initial.width-S):z==="e"&&(U.width=G.current.initial.width+S),U.width<An&&((z==="nw"||z==="w"||z==="sw")&&(U.x=G.current.initial.x+G.current.initial.width-An),U.width=An),U.height<An&&((z==="nw"||z==="n"||z==="ne")&&(U.y=G.current.initial.y+G.current.initial.height-An),U.height=An),q(te(U))}},Ce=async C=>{const B=G.current.type!==null;G.current.type&&Fe.current?.hasPointerCapture(C.pointerId)&&Fe.current.releasePointerCapture(C.pointerId),G.current.type=null,B&&V==="crop"&&!Ne&&await We()},et=C=>{if(V!=="draw"||!Ut.current||Ne)return;C.preventDefault();const B=Ut.current.getBoundingClientRect(),y={x:C.clientX-B.left,y:C.clientY-B.top},j={color:be,size:ge,points:[y]};pn.current=C.pointerId,Ut.current.setPointerCapture(C.pointerId),Ie(j)},it=C=>{if(V!=="draw"||pn.current!==C.pointerId||!Ut.current)return;C.preventDefault();const B=Ut.current.getBoundingClientRect(),y={x:C.clientX-B.left,y:C.clientY-B.top};Ie(j=>!j||j.points.length&&j.points[j.points.length-1].x===y.x&&j.points[j.points.length-1].y===y.y?j:{...j,points:[...j.points,y]})},Tt=C=>{V!=="draw"||pn.current!==C.pointerId||(pn.current=null,Ut.current?.hasPointerCapture(C.pointerId)&&Ut.current.releasePointerCapture(C.pointerId),Ie(B=>{if(!B)return null;if(B.points.length<2){const y={...B,points:[...B.points,B.points[0]]};Ze(j=>[...j,y])}else Ze(y=>[...y,B]);return null}))},ot=()=>{Ze(C=>C.slice(0,-1))},zn=()=>{Ze([]),Ie(null)},ps=async()=>{if(!a||Ne)return;const C=new Image;C.crossOrigin="anonymous",await new Promise(B=>{C.onload=()=>{if(l(C),st){const y=window.innerWidth,z=window.innerHeight-200-60,U=y;let X=C.naturalWidth,le=C.naturalHeight;const re=U/X,he=z/le,Re=Math.min(re,he),Qe=X*Re,bt=le*Re;p({width:U,height:z}),w(Re),W({width:Qe,height:bt});const Ve={x:(U-Qe)/2,y:(z-bt)/2};O(Ve);const ft=2;q({x:ft,y:ft,width:U-ft*2,height:z-ft*2})}else{const y=Math.min(window.innerWidth-64,720),j=Math.min(window.innerHeight-200,520);let S=C.naturalWidth,M=C.naturalHeight;if(S>y){const he=y/S;S*=he,M*=he}if(M>j){const he=j/M;S*=he,M*=he}S=Math.max(280,S),M=Math.max(220,M),p({width:S,height:M});const z=Math.max(S/C.naturalWidth,M/C.naturalHeight);w(z);const U=C.naturalWidth*z,X=C.naturalHeight*z;W({width:U,height:X});const le={x:(S-U)/2,y:(M-X)/2};O(le);const re=2;q({x:re,y:re,width:S-re*2,height:M-re*2})}Ze([]),Ie(null),B()},C.src=e.previewUrl})},Wn=async()=>{if(!e||!a)return;const C=L.width/L.height,B=Math.max(L.x,N.x),y=Math.max(L.y,N.y),j=Math.min(L.x+L.width,N.x+H.width),S=Math.min(L.y+L.height,N.y+H.height),M=j-B,z=S-y,U=a.naturalWidth/H.width,X=a.naturalHeight/H.height,le=(B-N.x)*U,re=(y-N.y)*X;let he=M*U,Re=z*X;he/Re>C?he=Re*C:Re=he/C;const bt=a.naturalWidth,Ve=a.naturalHeight;let ft=Math.max(0,le),en=Math.max(0,re),ct=Math.max(1,Math.min(he,bt-ft)),kt=Math.max(1,Math.min(Re,Ve-en));const pr=ct/kt;Math.abs(pr-C)>.01&&(pr>C?ct=kt*C:kt=ct/C,ct=Math.max(1,Math.min(ct,bt-ft)),kt=Math.max(1,Math.min(kt,Ve-en)));const F=Math.max(1,Math.round(ct)),Sn=Math.max(1,Math.round(kt)),St=document.createElement("canvas");St.width=F,St.height=Sn;const Ye=St.getContext("2d");if(!Ye)return;Ye.drawImage(a,ft,en,ct,kt,0,0,F,Sn);const at=F/M,Cn=Sn/z,Fn=[...ie,...ze?[ze]:[]];Ye.lineCap="round",Ye.lineJoin="round";for(const He of Fn){if(!He.points.length)continue;Ye.strokeStyle=He.color,Ye.lineWidth=He.size*((at+Cn)/2),Ye.beginPath();const Bt=He.points[0],Vt=(Bt.x-B)*at,$n=(Bt.y-y)*Cn;Ye.moveTo(Vt,$n);for(let jn=1;jn<He.points.length;jn++){const Xn=He.points[jn];Ye.lineTo((Xn.x-B)*at,(Xn.y-y)*Cn)}Ye.stroke()}const Pt=await new Promise(He=>St.toBlob(Bt=>He(Bt),"image/png",.96));if(!Pt)return;const zt=e.fileName?.replace(/\.[^.]+$/,"")||e.file.name.replace(/\.[^.]+$/,"")||"image",ht=new File([Pt],`${zt}-edited.png`,{type:"image/png"}),Je=URL.createObjectURL(Pt);s({file:ht,previewUrl:Je})},gn=()=>{if(V!=="crop"||Ne)return null;const{x:C,y:B,width:y,height:j}=L,S={position:"absolute",width:wn,height:wn,background:"#fff",border:"2px solid rgba(0,0,0,0.3)",borderRadius:"2px",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"};return r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{...S,left:C-wn/2,top:B-wn/2,cursor:"nwse-resize"}}),r.jsx("div",{style:{...S,left:C+y-wn/2,top:B-wn/2,cursor:"nesw-resize"}}),r.jsx("div",{style:{...S,left:C-wn/2,top:B+j-wn/2,cursor:"nesw-resize"}}),r.jsx("div",{style:{...S,left:C+y-wn/2,top:B+j-wn/2,cursor:"nwse-resize"}})]})};if(!t||!e)return null;if(st)return Ur.createPortal(r.jsxs("div",{style:{position:"fixed",inset:0,background:"#000",zIndex:1300,display:"flex",flexDirection:"column",touchAction:"none"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(0,0,0,0.8)",backdropFilter:"blur(10px)",borderBottom:"1px solid rgba(255,255,255,0.1)",zIndex:10},children:[r.jsx("button",{onClick:n,style:{background:"transparent",border:"none",color:"#fff",fontSize:16,padding:"8px 0",cursor:"pointer"},children:"Отмена"}),r.jsx("div",{style:{fontSize:16,fontWeight:600,color:"#fff"},children:"Редактирование"}),r.jsx("button",{onClick:Wn,disabled:!mt||Ne,style:{background:!mt||Ne?"rgba(255,255,255,0.2)":"#ff9f0a",border:"none",color:"#fff",fontSize:16,fontWeight:600,padding:"8px 16px",borderRadius:8,cursor:mt&&!Ne?"pointer":"not-allowed"},children:"Сохранить"})]}),r.jsxs("div",{ref:Fe,onPointerDown:oe,onPointerMove:Ke,onPointerUp:Ce,onPointerLeave:Ce,style:{position:"relative",flex:1,background:"#000",overflow:"hidden",touchAction:"none"},children:[a&&r.jsx("img",{src:a.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:N.x,top:N.y,width:H.width,height:H.height,userSelect:"none",pointerEvents:"none",transition:Ne?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),r.jsx("canvas",{ref:Ut,style:{position:"absolute",inset:0,pointerEvents:V==="draw"?"auto":"none"},onPointerDown:et,onPointerMove:it,onPointerUp:Tt,onPointerLeave:Tt}),r.jsx("canvas",{ref:Un,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),V==="crop"&&!Ne&&r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${L.x}px 100%,
                    ${L.x}px ${L.y}px,
                    ${L.x+L.width}px ${L.y}px,
                    ${L.x+L.width}px ${L.y+L.height}px,
                    ${L.x}px ${L.y+L.height}px,
                    ${L.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),r.jsx("div",{style:{position:"absolute",left:L.x,top:L.y,width:L.width,height:L.height,border:"2px solid #fff",pointerEvents:"none"}}),gn()]})]}),r.jsxs("div",{style:{background:"rgba(0,0,0,0.95)",backdropFilter:"blur(10px)",borderTop:"1px solid rgba(255,255,255,0.1)",padding:"16px",display:"flex",flexDirection:"column",gap:16,maxHeight:"40vh",overflowY:"auto"},children:[r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsx("button",{onClick:()=>ue("crop"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:V==="crop"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:"Обрезать"}),r.jsxs("button",{onClick:()=>ue("draw"),style:{flex:1,padding:"12px",borderRadius:12,border:"none",background:V==="draw"?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",color:"#fff",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:"pointer"},children:[r.jsx(Fc,{size:18}),"Рисовать"]})]}),r.jsxs("button",{onClick:ps,disabled:Ne,style:{padding:"10px",borderRadius:10,border:"none",background:Ne?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:Ne?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:8,cursor:Ne?"not-allowed":"pointer"},children:[r.jsx(zc,{size:16}),"Сбросить"]}),V==="draw"&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{children:[r.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Цвет кисти"}),r.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:eo.map(C=>r.jsx("button",{onClick:()=>Xe(C),style:{width:40,height:40,borderRadius:"50%",border:be===C?"3px solid #fff":"2px solid rgba(255,255,255,0.3)",background:C,cursor:"pointer",flexShrink:0},"aria-label":`Выбрать цвет ${C}`},C))})]}),r.jsxs("div",{children:[r.jsx("div",{style:{fontSize:12,color:"rgba(255,255,255,0.6)",marginBottom:8},children:"Толщина"}),r.jsx("div",{style:{display:"flex",gap:12,justifyContent:"center"},children:to.map(C=>r.jsx("button",{onClick:()=>Te(C),style:{width:48,height:48,borderRadius:12,border:ge===C?"2px solid #fff":"1px solid rgba(255,255,255,0.2)",background:ge===C?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.05)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},children:r.jsx("span",{style:{width:C,height:C,borderRadius:"50%",background:be,display:"inline-block"}})},C))})]}),r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsxs("button",{onClick:ot,disabled:ie.length===0,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:ie.length===0?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:ie.length===0?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:ie.length===0?"not-allowed":"pointer"},children:[r.jsx($c,{size:16}),"Отменить"]}),r.jsx("button",{onClick:zn,disabled:ie.length===0&&!ze,style:{flex:1,padding:"10px",borderRadius:10,border:"none",background:ie.length===0&&!ze?"rgba(255,255,255,0.05)":"rgba(255,255,255,0.1)",color:ie.length===0&&!ze?"rgba(255,255,255,0.4)":"#fff",fontSize:14,display:"flex",alignItems:"center",justifyContent:"center",gap:6,cursor:ie.length===0&&!ze?"not-allowed":"pointer"},children:"Очистить"})]})]})]})]}),document.body);const mr=r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(2,4,10,0.75)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1300,padding:16},children:r.jsxs("div",{style:{background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:16,width:"min(960px, 100%)",maxHeight:"90vh",display:"flex",flexDirection:"column",padding:20,gap:16,color:"var(--text-primary)",boxShadow:"var(--shadow-lg)"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[r.jsxs("div",{style:{fontWeight:600,fontSize:16},children:["Редактирование изображения",r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:2},children:e.fileName||e.file.name})]}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:n,"aria-label":"Закрыть редактор",children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{ref:Fe,onPointerDown:oe,onPointerMove:Ke,onPointerUp:Ce,onPointerLeave:Ce,style:{position:"relative",width:u.width,height:u.height,background:"#05070e",overflow:"hidden",margin:"0 auto",touchAction:"none",border:"1px solid rgba(255,255,255,0.08)",cursor:V==="crop"?"default":"crosshair"},children:[a&&r.jsx("img",{src:a.src,draggable:!1,alt:"Редактируемое изображение",style:{position:"absolute",left:N.x,top:N.y,width:H.width,height:H.height,userSelect:"none",pointerEvents:"none",transition:Ne?"width 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4, 0, 0.2, 1)":"none"}}),r.jsx("canvas",{ref:Ut,style:{position:"absolute",inset:0,pointerEvents:V==="draw"?"auto":"none"},onPointerDown:et,onPointerMove:it,onPointerUp:Tt,onPointerLeave:Tt}),r.jsx("canvas",{ref:Un,style:{position:"absolute",inset:0,pointerEvents:"none",opacity:0}}),V==="crop"&&!Ne&&r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.5)",clipPath:`polygon(
                    0% 0%, 0% 100%,
                    ${L.x}px 100%,
                    ${L.x}px ${L.y}px,
                    ${L.x+L.width}px ${L.y}px,
                    ${L.x+L.width}px ${L.y+L.height}px,
                    ${L.x}px ${L.y+L.height}px,
                    ${L.x}px 100%,
                    100% 100%, 100% 0%
                  )`,pointerEvents:"none"}}),r.jsx("div",{style:{position:"absolute",left:L.x,top:L.y,width:L.width,height:L.height,border:"2px solid #fff",pointerEvents:"none"}}),gn()]})]}),r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[r.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[r.jsx("button",{className:V==="crop"?"btn btn-secondary":"btn btn-ghost",onClick:()=>ue("crop"),style:{display:"inline-flex",alignItems:"center",gap:6},children:"Обрезать"}),r.jsxs("button",{className:V==="draw"?"btn btn-secondary":"btn btn-ghost",onClick:()=>ue("draw"),style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx(Fc,{size:16}),"Рисовать"]}),r.jsxs("button",{className:"btn btn-ghost",onClick:ps,disabled:Ne,style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx(zc,{size:16}),"Сбросить"]}),V==="draw"&&r.jsxs(r.Fragment,{children:[r.jsxs("button",{className:"btn btn-ghost",onClick:ot,disabled:ie.length===0,style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx($c,{size:16}),"Отменить штрих"]}),r.jsx("button",{className:"btn btn-ghost",onClick:zn,disabled:ie.length===0&&!ze,style:{display:"inline-flex",alignItems:"center",gap:6},children:"Очистить рисунок"})]})]}),V==="draw"&&r.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:20,alignItems:"center"},children:[r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Цвет кисти"}),r.jsx("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:eo.map(C=>r.jsx("button",{onClick:()=>Xe(C),style:{width:28,height:28,borderRadius:"50%",border:be===C?"2px solid #fff":"2px solid transparent",background:C,cursor:"pointer"},"aria-label":`Выбрать цвет ${C}`},C))})]}),r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Толщина"}),r.jsx("div",{style:{display:"flex",gap:8},children:to.map(C=>r.jsx("button",{onClick:()=>Te(C),className:ge===C?"btn btn-secondary":"btn btn-ghost",style:{width:44,height:36,display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx("span",{style:{width:C,height:C,borderRadius:"50%",background:be,display:"inline-block"}})},C))})]})]})]}),r.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12},children:[r.jsx("button",{className:"btn btn-ghost",onClick:n,children:"Отмена"}),r.jsxs("button",{className:"btn btn-primary",onClick:Wn,disabled:!mt||Ne,style:{display:"inline-flex",gap:6,alignItems:"center"},children:[r.jsx(sf,{size:16}),"Сохранить"]})]})]})});return Ur.createPortal(mr,document.body)}function qn(t,e,n){return Math.min(n,Math.max(e,t))}function op({open:t,items:e,index:n,onClose:s,onIndexChange:a}){const l=d.useRef(null),u=d.useRef(null),[p,x]=d.useState({}),[w,N]=d.useState({w:0,h:0}),[O,H]=d.useState(1),[W,L]=d.useState(0),[q,V]=d.useState(0),ue=d.useRef(null),be=d.useRef(null),Xe=d.useRef(0),ge=d.useRef(0),Te=d.useRef(null),ie=e.length,Ze=ie>1,ze=e[n]||"",Ie=ze?p[ze]:void 0,st=d.useMemo(()=>ie<=1?24:w.w<=768?72:Math.max(140,Math.round(w.h*.2)),[ie,w.w,w.h]),Be=d.useMemo(()=>{if(!Ie||!w.w||!w.h)return{scale:1,maxX:0,maxY:0};const Y=56,Q=st,te=28,oe=Math.max(0,w.w-te*2),Ke=Math.max(0,w.h-Y-Q-te*2),et=Math.min(oe/Ie.w,Ke/Ie.h,1)*O,it=Ie.w*et,Tt=Ie.h*et,ot=Math.max(0,(it-oe)/2),zn=Math.max(0,(Tt-Ke)/2);return{scale:et,maxX:ot,maxY:zn}},[Ie,w.w,w.h,O,st]),Ne=()=>{Ze&&a((n-1+ie)%ie)},Et=()=>{Ze&&a((n+1)%ie)},Fe=()=>{H(1),L(0),V(0)};d.useEffect(()=>{if(!t)return;const Y=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=Y}},[t]),d.useLayoutEffect(()=>{if(!t)return;const Y=()=>{const Q=window.innerWidth,te=window.innerHeight;N({w:Q,h:te})};return Y(),window.addEventListener("resize",Y),()=>window.removeEventListener("resize",Y)},[t]),d.useEffect(()=>{t&&Fe()},[t,ze]),d.useEffect(()=>{if(!t)return;const Y=Q=>{Q.key==="Escape"&&s(),Q.key==="ArrowLeft"&&Ne(),Q.key==="ArrowRight"&&Et(),(Q.key==="+"||Q.key==="=")&&H(te=>qn(te*1.15,1,6)),Q.key==="-"&&H(te=>qn(te/1.15,1,6)),Q.key==="0"&&Fe()};return window.addEventListener("keydown",Y),()=>window.removeEventListener("keydown",Y)},[t,n,ie,ze,s]),d.useEffect(()=>{t&&(L(Y=>qn(Y,-Be.maxX,Be.maxX)),V(Y=>qn(Y,-Be.maxY,Be.maxY)))},[t,Be.maxX,Be.maxY]);const Ut=Y=>{if(!t)return;Y.preventDefault();const Q=u.current?.getBoundingClientRect()??null,te=!!Q&&Y.clientX>=Q.left&&Y.clientX<=Q.right&&Y.clientY>=Q.top&&Y.clientY<=Q.bottom,oe=Y.deltaMode===1?Y.deltaY*16:Y.deltaMode===2?Y.deltaY*w.h:Y.deltaY;if(!te){if(!Ze)return;const it=performance.now(),Tt=260,ot=90;if(Xe.current+=oe,it-ge.current<Tt||Math.abs(Xe.current)<ot)return;ge.current=it;const zn=Xe.current>0?1:-1;Xe.current=0,zn>0?Et():Ne();return}const Ce=Math.exp(-oe*75e-5),et=qn(Ce,.85,1.18);H(it=>qn(it*et,1,6))},Un=Y=>{if(Y.button!==0)return;Y.currentTarget.setPointerCapture(Y.pointerId);const Q=O>1.01,te=u.current?.getBoundingClientRect()??null,oe=!!te&&Y.clientX>=te.left&&Y.clientX<=te.right&&Y.clientY>=te.top&&Y.clientY<=te.bottom;ue.current={active:!0,startX:Y.clientX,startY:Y.clientY,startTx:W,startTy:q,mode:Q?"pan":"swipe",startedInsideImg:oe}},G=Y=>{const Q=ue.current;if(!Q?.active)return;const te=Y.clientX-Q.startX,oe=Y.clientY-Q.startY;if(Q.mode==="pan"){L(qn(Q.startTx+te,-Be.maxX,Be.maxX)),V(qn(Q.startTy+oe,-Be.maxY,Be.maxY));return}},pn=Y=>{const Q=ue.current;if(ue.current=null,!Q?.active)return;const te=Y.clientX-Q.startX,oe=Y.clientY-Q.startY;if(Q.mode==="swipe"){if(Math.abs(oe)>110&&Math.abs(te)<90){s();return}if(Math.abs(te)>70&&Math.abs(oe)<60){te<0?Et():Ne();return}}const Ke=8,Ce=Math.abs(te)<=Ke&&Math.abs(oe)<=Ke;if(Ce&&Q.startedInsideImg){const et=performance.now(),it=Te.current,Tt=280,ot=18;if(it&&et-it.ts<=Tt&&Math.abs(it.x-Y.clientX)<=ot&&Math.abs(it.y-Y.clientY)<=ot){Te.current=null,O<=1.01?H(2):Fe();return}Te.current={ts:et,x:Y.clientX,y:Y.clientY};return}Ce&&!Q.startedInsideImg&&(O>1.01?Fe():s())},wt=Y=>{if(Y.touches.length!==2){be.current=null;return}Y.preventDefault();const Q=Y.touches[0],te=Y.touches[1],oe=Q.clientX-te.clientX,Ke=Q.clientY-te.clientY,Ce=Math.sqrt(oe*oe+Ke*Ke),et=be.current;if(be.current=Ce,!et)return;const it=Ce>et?1.03:1/1.03;H(Tt=>qn(Tt*it,1,6))},Oe=()=>{O<=1.01?H(2):Fe()};if(!t)return null;const mt=(()=>{if(ie<=13)return e.map((Ce,et)=>({u:Ce,i:et}));const Q=Math.floor(13/2);let te=n-Q,oe=n+Q;if(te<0&&(oe+=-te,te=0),oe>ie-1){const Ce=oe-(ie-1);te=Math.max(0,te-Ce),oe=ie-1}const Ke=[];for(let Ce=te;Ce<=oe;Ce++)Ke.push({u:e[Ce],i:Ce});return Ke})(),We=r.jsxs("div",{className:"imglb-root",ref:l,onWheel:Ut,style:{"--imglb-thumbs-h":`${st}px`},children:[r.jsx("div",{className:"imglb-backdrop",onClick:s}),r.jsxs("div",{className:"imglb-topbar",children:[r.jsx("div",{className:"imglb-spacer","aria-hidden":"true"}),r.jsxs("div",{className:"imglb-title",children:[n+1," / ",ie]}),r.jsx("button",{className:"imglb-btn",onClick:s,"aria-label":"Закрыть",children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{className:"imglb-stage",onPointerDown:Un,onPointerMove:G,onPointerUp:pn,onPointerCancel:()=>{ue.current=null},onTouchMove:wt,onDoubleClick:Oe,children:[Ze&&r.jsx("button",{className:"imglb-nav imglb-nav-left",onClick:Ne,"aria-label":"Назад",children:r.jsx(of,{size:24})}),r.jsx("div",{className:"imglb-media",onClick:Y=>Y.stopPropagation(),children:r.jsx("div",{className:"imglb-pan",style:{transform:`translate3d(${W}px, ${q}px, 0)`},children:r.jsx("img",{ref:u,className:"imglb-img",src:ze,alt:"preview",draggable:!1,style:{width:Ie?.w?`${Ie.w}px`:void 0,height:Ie?.h?`${Ie.h}px`:void 0,transform:`scale(${Be.scale})`},onLoad:Y=>{const Q=Y.currentTarget,te=Q.naturalWidth||1,oe=Q.naturalHeight||1;x(Ke=>({...Ke,[ze]:{w:te,h:oe}}))}})})}),Ze&&r.jsx("button",{className:"imglb-nav imglb-nav-right",onClick:Et,"aria-label":"Вперёд",children:r.jsx(lf,{size:24})})]}),ie>1&&r.jsx("div",{className:"imglb-thumbs",onClick:Y=>Y.stopPropagation(),children:r.jsx("div",{className:"imglb-thumbs-inner",children:mt.map(({u:Y,i:Q})=>r.jsx("button",{type:"button",className:Q===n?"imglb-thumb is-active":"imglb-thumb",onClick:()=>a(Q),"aria-label":`Открыть ${Q+1}`,children:r.jsx("img",{src:Y,alt:"",draggable:!1})},`${Y}-${Q}`))})})]});return Ur.createPortal(We,document.body)}const Us=Il(t=>({incoming:null,activeConvId:null,initialVideo:!1,initialAudio:!0,setIncoming:e=>t({incoming:e}),startOutgoing:(e,n)=>t({activeConvId:e,incoming:null,initialVideo:!!n,initialAudio:!0}),startIncoming:e=>t({incoming:e}),endCall:()=>t({activeConvId:null,incoming:null,initialVideo:!1})}));function cp(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function wo(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function ra(t,...e){if(!cp(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function No(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");wo(t.outputLen),wo(t.blockLen)}function Ki(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function lp(t,e){ra(t);const n=e.outputLen;if(t.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function Bs(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function no(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function On(t,e){return t<<32-e|t>>>e}function dp(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function Vs(t){return typeof t=="string"&&(t=dp(t)),ra(t),t}class Dd{}function up(t){const e=s=>t().update(Vs(s)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}class Ad extends Dd{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,No(e);const s=Vs(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const a=this.blockLen,l=new Uint8Array(a);l.set(s.length>a?e.create().update(s).digest():s);for(let u=0;u<l.length;u++)l[u]^=54;this.iHash.update(l),this.oHash=e.create();for(let u=0;u<l.length;u++)l[u]^=106;this.oHash.update(l),Bs(l)}update(e){return Ki(this),this.iHash.update(e),this}digestInto(e){Ki(this),ra(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:s,finished:a,destroyed:l,blockLen:u,outputLen:p}=this;return e=e,e.finished=a,e.destroyed=l,e.blockLen=u,e.outputLen=p,e.oHash=n._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ro=(t,e,n)=>new Ad(t,e).update(n).digest();Ro.create=(t,e)=>new Ad(t,e);function fp(t,e,n){return No(t),n===void 0&&(n=new Uint8Array(t.outputLen)),Ro(t,Vs(n),Vs(e))}const ro=Uint8Array.from([0]),bl=Uint8Array.of();function hp(t,e,n,s=32){No(t),wo(s);const a=t.outputLen;if(s>255*a)throw new Error("Length should be <= 255*HashLen");const l=Math.ceil(s/a);n===void 0&&(n=bl);const u=new Uint8Array(l*a),p=Ro.create(t,e),x=p._cloneInto(),w=new Uint8Array(p.outputLen);for(let N=0;N<l;N++)ro[0]=N+1,x.update(N===0?bl:w).update(n).update(ro).digestInto(w),u.set(w,a*N),p._cloneInto(x);return p.destroy(),x.destroy(),Bs(w,ro),u.slice(0,s)}const mp=(t,e,n,s,a)=>hp(t,fp(t,e,n),s,a);function pp(t,e,n,s){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,s);const a=BigInt(32),l=BigInt(4294967295),u=Number(n>>a&l),p=Number(n&l),x=s?4:0,w=s?0:4;t.setUint32(e+x,u,s),t.setUint32(e+w,p,s)}function gp(t,e,n){return t&e^~t&n}function yp(t,e,n){return t&e^t&n^e&n}class xp extends Dd{constructor(e,n,s,a){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=n,this.padOffset=s,this.isLE=a,this.buffer=new Uint8Array(e),this.view=no(this.buffer)}update(e){Ki(this),e=Vs(e),ra(e);const{view:n,buffer:s,blockLen:a}=this,l=e.length;for(let u=0;u<l;){const p=Math.min(a-this.pos,l-u);if(p===a){const x=no(e);for(;a<=l-u;u+=a)this.process(x,u);continue}s.set(e.subarray(u,u+p),this.pos),this.pos+=p,u+=p,this.pos===a&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ki(this),lp(e,this),this.finished=!0;const{buffer:n,view:s,blockLen:a,isLE:l}=this;let{pos:u}=this;n[u++]=128,Bs(this.buffer.subarray(u)),this.padOffset>a-u&&(this.process(s,0),u=0);for(let O=u;O<a;O++)n[O]=0;pp(s,a-8,BigInt(this.length*8),l),this.process(s,0);const p=no(e),x=this.outputLen;if(x%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const w=x/4,N=this.get();if(w>N.length)throw new Error("_sha2: outputLen bigger than state");for(let O=0;O<w;O++)p.setUint32(4*O,N[O],l)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const s=e.slice(0,n);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:s,length:a,finished:l,destroyed:u,pos:p}=this;return e.destroyed=u,e.finished=l,e.length=a,e.pos=p,a%n&&e.buffer.set(s),e}clone(){return this._cloneInto()}}const lr=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),vp=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),dr=new Uint32Array(64);class wp extends xp{constructor(e=32){super(64,e,8,!1),this.A=lr[0]|0,this.B=lr[1]|0,this.C=lr[2]|0,this.D=lr[3]|0,this.E=lr[4]|0,this.F=lr[5]|0,this.G=lr[6]|0,this.H=lr[7]|0}get(){const{A:e,B:n,C:s,D:a,E:l,F:u,G:p,H:x}=this;return[e,n,s,a,l,u,p,x]}set(e,n,s,a,l,u,p,x){this.A=e|0,this.B=n|0,this.C=s|0,this.D=a|0,this.E=l|0,this.F=u|0,this.G=p|0,this.H=x|0}process(e,n){for(let O=0;O<16;O++,n+=4)dr[O]=e.getUint32(n,!1);for(let O=16;O<64;O++){const H=dr[O-15],W=dr[O-2],L=On(H,7)^On(H,18)^H>>>3,q=On(W,17)^On(W,19)^W>>>10;dr[O]=q+dr[O-7]+L+dr[O-16]|0}let{A:s,B:a,C:l,D:u,E:p,F:x,G:w,H:N}=this;for(let O=0;O<64;O++){const H=On(p,6)^On(p,11)^On(p,25),W=N+H+gp(p,x,w)+vp[O]+dr[O]|0,q=(On(s,2)^On(s,13)^On(s,22))+yp(s,a,l)|0;N=w,w=x,x=p,p=u+W|0,u=l,l=a,a=s,s=W+q|0}s=s+this.A|0,a=a+this.B|0,l=l+this.C|0,u=u+this.D|0,p=p+this.E|0,x=x+this.F|0,w=w+this.G|0,N=N+this.H|0,this.set(s,a,l,u,p,x,w,N)}roundClean(){Bs(dr)}destroy(){this.set(0,0,0,0,0,0,0,0),Bs(this.buffer)}}const bp=up(()=>new wp),kp=bp,Sp=new TextEncoder,Cp=new TextDecoder;function fn(t){if(!t)return new Uint8Array;const e=t.replace(/-/g,"+").replace(/_/g,"/"),n=e.length%4===0?"":"=".repeat(4-e.length%4),s=atob(e+n),a=s.length,l=new Uint8Array(a);for(let u=0;u<a;u+=1)l[u]=s.charCodeAt(u);return l}function is(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")}function kl(t){return Sp.encode(t)}function jp(t){return Cp.decode(t)}const Sl="eb_e2ee_sessions_v1";class Ip{sessions={};version=0;constructor(){this.load()}getVersion(){return this.version}hasSession(e){return!!this.sessions[e]}getSession(e){return this.sessions[e]??null}async ensureSession(e){if(!e.isSecret||e.secretStatus!=="ACTIVE")return null;const n=this.sessions[e.id];if(n)return n;const s=os(),a=Mc();if(!s||!a||!e.secretInitiatorDeviceId||!e.secretPeerDeviceId||!(e.secretInitiatorDeviceId===s.deviceId))return null;const u=e.secretPeerDeviceId;return u?this.createInitiatorSession(e,s.deviceId,u,a):null}processHandshakes(e,n){if(!e.isSecret||!n||n.length===0)return!1;const s=os();if(!s)return!1;let a=!1;for(const l of n){const p=(l?.metadata??{}).e2ee;if(!p||p.kind!=="handshake")continue;const x=p.payload;if(!x||x.recipientDeviceId!==s.deviceId)continue;const w=this.sessions[e.id];if(w&&w.peerDeviceId===x.initiatorDeviceId&&w.prekeyId===x.prekeyId)continue;this.handlePeerHandshake(e,x)&&(a=!0)}return a&&this.bumpVersion(),a}transformMessage(e,n){if(!n)return n;const s=n.metadata??{},a=s.e2ee;if(!a||a.kind!=="ciphertext")return n;const l=this.sessions[e];if(!l)return{...n,content:"🔐 Зашифровано",metadata:{...s,e2ee:{...a,decrypted:!1}}};try{const u=fn(l.key),p=fn(a.nonce),x=fn(n.content||""),w=Yn.secretbox.open(x,p,u);if(!w)throw new Error("Failed to decrypt");return{...n,content:jp(w),metadata:{...s,e2ee:{...a,decrypted:!0}}}}catch(u){return console.warn("Failed to decrypt message",u),{...n,content:"🔐 Ошибка расшифровки",metadata:{...s,e2ee:{...a,decrypted:!1,error:!0}}}}}async encryptPayload(e,n){const s=await this.ensureSession(e);if(!s)throw new Error("E2EE session is not ready");const a=fn(s.key),l=Yn.randomBytes(24),u=kl(n.content??""),p=Yn.secretbox(u,l,a);return{conversationId:e.id,type:n.type,content:is(p),replyToId:n.replyToId,metadata:{...n.metadata??{},e2ee:{kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:is(l)}}}}async encryptBinary(e,n){const s=await this.ensureSession(e);if(!s)throw new Error("E2EE session is not ready");const a=fn(s.key),l=Yn.randomBytes(24);return{cipher:Yn.secretbox(n,l,a),nonce:is(l)}}decryptBinary(e,n,s){const a=this.sessions[e];if(!a)throw new Error("E2EE session is not ready");const l=fn(a.key),u=fn(s);return Yn.secretbox.open(n,u,l)}async createInitiatorSession(e,n,s,a){try{const l=await ae.post("/devices/prekeys/claim",{deviceId:s}),u=l.data?.identityKey,p=l.data?.prekey;if(!u||!p?.publicKey||!p?.keyId)throw new Error("Invalid prekey response");const x=Yn.scalarMult(fn(a.secretKey),fn(p.publicKey)),w=Yn.randomBytes(32),N=`eblusha:e2ee:${e.id}:${n}->${s}:${p.keyId}`,O=this.deriveKey(x,w,N),H={conversationId:e.id,key:is(O),localDeviceId:n,peerDeviceId:s,role:"initiator",prekeyId:p.keyId,hkdfInfo:N,handshakeSalt:is(w),createdAt:Date.now()};return this.sessions[e.id]=H,this.persist(),await this.sendHandshakeMessage(e.id,{version:1,kind:"handshake",conversationId:e.id,initiatorDeviceId:n,recipientDeviceId:s,prekeyId:p.keyId,handshakeSalt:H.handshakeSalt,hkdfInfo:N,initiatorIdentityKey:a.publicKey,createdAt:Date.now()}),H}catch(l){return console.error("Failed to initialize E2EE session",l),delete this.sessions[e.id],this.persist(),null}}handlePeerHandshake(e,n){if(!n?.prekeyId||!n?.initiatorIdentityKey||!n.hkdfInfo||!n.handshakeSalt||!Mc())return!1;const a=os();if(!a)return!1;const l=wu(n.prekeyId);if(!l)return console.warn("Missing prekey secret for handshake",n.prekeyId),!1;try{const u=Yn.scalarMult(fn(l),fn(n.initiatorIdentityKey)),p=this.deriveKey(u,fn(n.handshakeSalt),n.hkdfInfo),x={conversationId:e.id,key:is(p),localDeviceId:a.deviceId,peerDeviceId:n.initiatorDeviceId,role:"peer",prekeyId:n.prekeyId,hkdfInfo:n.hkdfInfo,handshakeSalt:n.handshakeSalt,createdAt:Date.now()};return this.sessions[e.id]=x,this.persist(),!0}catch(u){return console.error("Failed to handle handshake payload",u),!1}}async sendHandshakeMessage(e,n){await ae.post("/conversations/send",{conversationId:e,type:"SYSTEM",content:"",metadata:{e2ee:{kind:"handshake",payload:n}}})}deriveKey(e,n,s){return mp(kp,e,n,kl(s),32)}clearSession(e){this.sessions[e]&&(delete this.sessions[e],this.persist())}load(){try{const e=localStorage.getItem(Sl);e&&(this.sessions=JSON.parse(e))}catch{this.sessions={}}}persist(){try{localStorage.setItem(Sl,JSON.stringify(this.sessions))}catch{}this.bumpVersion()}bumpVersion(){this.version=(this.version+1)%Number.MAX_SAFE_INTEGER}}const Ln=new Ip;class Mp{mediaRecorder=null;audioChunks=[];stream=null;audioContext=null;analyser=null;dataArray=null;amplitudeTimer=null;state="idle";duration=0;durationTimer=null;startTime=0;callbacks={};constructor(e={}){this.callbacks=e}async start(){if(this.state!=="recording")try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const e={mimeType:this.getSupportedMimeType()};this.mediaRecorder=new MediaRecorder(this.stream,e),this.audioChunks=[];try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&this.audioContext.resume().catch(()=>{});const n=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.3,n.connect(this.analyser),this.dataArray=new Uint8Array(new ArrayBuffer(this.analyser.frequencyBinCount)),this.startAmplitudeAnalysis()}catch(n){console.error("Failed to setup audio analysis:",n)}this.mediaRecorder.ondataavailable=n=>{n.data.size>0&&this.audioChunks.push(n.data)},this.mediaRecorder.onstop=()=>{this.stopDurationTimer(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(n=>n.stop())},this.mediaRecorder.onerror=n=>{const s=new Error("MediaRecorder error");this.callbacks.onError?.(s)},this.mediaRecorder.start(100),this.state="recording",this.startTime=Date.now(),this.startDurationTimer(),this.callbacks.onStateChange?.(this.state)}catch(e){const n=e instanceof Error?e:new Error("Failed to start recording");throw this.callbacks.onError?.(n),n}}stop(){return this.state!=="recording"||(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.state="stopped",this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state),this.audioChunks.length===0)?null:new Blob(this.audioChunks,{type:this.getSupportedMimeType()||"audio/webm"})}cancel(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stopAmplitudeAnalysis(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.stream&&this.stream.getTracks().forEach(e=>e.stop()),this.audioChunks=[],this.state="idle",this.duration=0,this.stopDurationTimer(),this.callbacks.onStateChange?.(this.state)}getState(){return this.state}getDuration(){return this.duration}startDurationTimer(){this.stopDurationTimer(),this.durationTimer=window.setInterval(()=>{this.state==="recording"&&(this.duration=Math.floor((Date.now()-this.startTime)/1e3),this.callbacks.onDurationUpdate?.(this.duration))},1e3)}stopDurationTimer(){this.durationTimer!==null&&(clearInterval(this.durationTimer),this.durationTimer=null)}startAmplitudeAnalysis(){if(this.stopAmplitudeAnalysis(),!this.analyser||!this.dataArray||!this.audioContext)return;let e=0;const n=50,s=a=>{if(!this.analyser||!this.dataArray||this.state!=="recording"||!this.audioContext||this.audioContext.state==="closed")return;if(this.audioContext.state==="suspended"){this.audioContext.resume().catch(()=>{}),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(s));return}if(typeof a=="number"){if(a-e<n){this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(s));return}e=a}try{if(!this.analyser||!this.dataArray)return;this.analyser.getByteTimeDomainData(this.dataArray)}catch(W){console.warn("Analyser error:",W);return}let l=0,u=0;for(let W=0;W<this.dataArray.length;W++){const L=Math.abs(this.dataArray[W]-128);l=Math.max(l,L),u+=L}const p=u/this.dataArray.length,w=(l*.7+p*.3)/128*100,N=Math.min(100,w*2.5),H=Math.max(15,N);this.callbacks.onAmplitudeUpdate?.(H),this.state==="recording"&&(this.amplitudeTimer=window.requestAnimationFrame(s))};this.amplitudeTimer=window.requestAnimationFrame(s)}stopAmplitudeAnalysis(){this.amplitudeTimer!==null&&(window.cancelAnimationFrame(this.amplitudeTimer),this.amplitudeTimer=null)}getSupportedMimeType(){const e=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4","audio/mpeg"];for(const n of e)if(MediaRecorder.isTypeSupported(n))return n;return""}cleanup(){this.cancel()}}async function Ep(t,e=60){try{const s=await(await fetch(t)).arrayBuffer(),a=new(window.AudioContext||window.webkitAudioContext),u=(await a.decodeAudioData(s)).getChannelData(0),p=Math.floor(u.length/e),x=[];for(let w=0;w<e;w++){let N=0,O=0;const H=w*p,W=Math.min(H+p,u.length);for(let ue=H;ue<W;ue++){const be=Math.abs(u[ue]);N+=be,O=Math.max(O,be)}const L=N/(W-H),q=Math.max(L,O*.7),V=Math.max(20,Math.min(100,q*200));x.push(V)}return a.close(),x}catch(n){return console.error("Failed to generate waveform:",n),Array(e).fill(0).map(()=>Math.random()*40+30)}}const so=new Map;async function Tp(t,e=60){const n=`${t}:${e}`;if(so.has(n))return so.get(n);const s=await Ep(t,e);return so.set(n,s),s}const Np=d.lazy(()=>Ml(()=>import("./CallOverlay-D96AJnSH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(t=>({default:t.CallOverlay}))),Rp=()=>Ml(()=>import("./CallOverlay-D96AJnSH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])),Cl="eblusha:last-active-conversation",Dp=3e4,Ap=10;function Op({url:t,duration:e}){const[n,s]=d.useState(!1),[a,l]=d.useState(0),[u,p]=d.useState([]),[x,w]=d.useState(!0),N=d.useRef(null),O=Zi(t)||t;d.useEffect(()=>{let q=!1;return w(!0),Tp(O,60).then(V=>{q||(p(V),w(!1))}).catch(V=>{console.error("Failed to load waveform:",V),q||w(!1)}),()=>{q=!0}},[O]),d.useEffect(()=>{const q=N.current;if(!q)return;const V=()=>l(q.currentTime),ue=()=>{s(!1),l(0)},be=()=>s(!0),Xe=()=>s(!1);return q.addEventListener("timeupdate",V),q.addEventListener("ended",ue),q.addEventListener("play",be),q.addEventListener("pause",Xe),()=>{q.removeEventListener("timeupdate",V),q.removeEventListener("ended",ue),q.removeEventListener("play",be),q.removeEventListener("pause",Xe)}},[]);const H=()=>{const q=N.current;q&&(n?q.pause():q.play().catch(V=>{console.error("Failed to play audio:",V)}))},W=q=>{const V=Math.floor(q/60),ue=Math.floor(q%60);return`${V}:${ue.toString().padStart(2,"0")}`},L=u.length>0?Math.floor(a/e*u.length):0;return r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)"},children:[r.jsx("audio",{ref:N,src:O,preload:"metadata"}),r.jsx("button",{type:"button",onClick:H,style:{width:40,height:40,borderRadius:"50%",border:"none",background:"var(--brand)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0},"aria-label":n?"Пауза":"Воспроизвести",children:n?r.jsx(Vf,{size:16,fill:"currentColor"}):r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:r.jsx("path",{d:"M5 3l8 5-8 5V3z"})})}),r.jsxs("div",{style:{flex:1,minWidth:0},children:[x?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:4,height:24},children:Array(20).fill(0).map((q,V)=>r.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${V*.1}s`}},V))}):u.length>0?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,marginBottom:4},children:u.map((q,V)=>{const ue=V<=L,be=Math.max(4,q/100*20);return r.jsx("div",{style:{width:2,height:`${be}px`,background:ue?"var(--brand)":"var(--surface-border)",borderRadius:1,transition:"background 0.2s ease",alignSelf:"flex-end"}},V)})}):r.jsx("div",{style:{height:24,display:"flex",alignItems:"center",color:"var(--text-muted)",fontSize:12},children:"Загрузка..."}),r.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:4},children:r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[W(a)," / ",W(e)]})})]})]})}function Lp(){const[t,e]=d.useState(null),[n,s]=d.useState(null),[a,l]=d.useState(null),[u,p]=d.useState(null),x=d.useRef(null);d.useEffect(()=>{x.current=u},[u]);const w=d.useRef(null),[N,O]=d.useState(""),[H,W]=d.useState(null),L=d.useRef(null),q=d.useRef(null),V=d.useRef(null),ue=d.useRef(null),be=d.useRef(null),Xe=d.useRef(!1),ge=d.useRef(null),Te=d.useRef(null),ie=d.useRef(!1),[Ze,ze]=d.useState(!1),Ie=d.useRef(!1),st=d.useRef(null),Be=d.useRef(null),Ne=d.useRef(null),[Et,Fe]=d.useState(!1),[Ut,Un]=d.useState(1),[G,pn]=d.useState(!1),wt=d.useRef(null);d.useRef({pinTimer:null});const[Oe,mt]=d.useState(()=>({open:!1,x:0,y:0,messageId:null})),[We,Y]=d.useState(()=>({open:!1,x:0,y:0,conversationId:null})),Q=d.useRef(null),[te,oe]=d.useState(()=>({open:!1,anchor:null})),Ke=d.useRef(null),[Ce,et]=d.useState(null),it=d.useRef(null),[Tt,ot]=d.useState(!1),[zn,ps]=d.useState(()=>({open:!1,x:0,y:0,messageId:null})),[Wn,gn]=d.useState({open:!1,messageId:null}),[mr,C]=d.useState(!1),[B,y]=d.useState([]),[j,S]=d.useState(!1),[M,z]=d.useState("friends"),[U,X]=d.useState(["","","",""]),le=[d.useRef(null),d.useRef(null),d.useRef(null),d.useRef(null)],[re,he]=d.useState(null),[Re,Qe]=d.useState(null),[bt,Ve]=d.useState(!1),ft=d.useRef(0),[en,ct]=d.useState(!1),[kt,pr]=d.useState(!1),[F,Sn]=d.useState(!1),St=d.useRef(F),[Ye,at]=d.useState("list");d.useEffect(()=>{St.current=F},[F]);const[Cn,Fn]=d.useState(!1),Pt=d.useRef(null);d.useRef(null);const zt=d.useRef(new Map),ht=d.useRef(!0),Je=d.useRef(!1),He=d.useRef(0),Bt=d.useRef(null),Vt=d.useRef(new Set),$n=d.useRef(null);d.useRef(null);const jn=d.useRef(null),Xn=d.useRef(0),[sa,Xs]=d.useState(!1),[gr,Zs]=d.useState(""),[yr,Yt]=d.useState([]),[Ct,xr]=d.useState(!1),[gs,In]=d.useState(null),[tn,Do]=d.useState(null),[_t,vr]=d.useState(null),[Ao,Oo]=d.useState(null),[Od,Zn]=d.useState(!1),ia=d.useRef(null),wr=d.useRef(null),Ld=d.useRef(null),aa=d.useRef(null),[pt,Mn]=d.useState({x:0,y:0,scale:1}),[Lo,oa]=d.useState(!1),[Ud,Ks]=d.useState(!1),[ca,zd]=d.useState(["","","",""]),la=[d.useRef(null),d.useRef(null),d.useRef(null),d.useRef(null)],[Kn,da]=d.useState(null),[Wd,ua]=d.useState(!1),[fa,Fd]=d.useState(""),[$d,Qs]=d.useState(!1),[$r,Js]=d.useState(!1),[ha,ei]=d.useState(null),[nn,ti]=d.useState(null),ni=d.useRef(null),[_e,Qn]=d.useState({x:0,y:0,scale:1}),[Uo,ri]=d.useState(0),br=d.useRef(null),ma=d.useRef(null),zo=d.useRef(null),Nt=d.useRef(null),kr=d.useRef(null),Jn=d.useRef(null),si=d.useRef(null),Rt=d.useRef(null),Sr=d.useRef(null),ii=d.useRef(null),Wo=d.useRef(null),[qe,En]=d.useState({x:0,y:0,scale:1}),[rn,ai]=d.useState(null),[oi,ci]=d.useState(null),[Fo,pa]=d.useState(!1),[$o,ga]=d.useState(!1),[li,Hr]=d.useState(null),[ya,xa]=d.useState({open:!1,index:0,items:[]}),[Hd,di]=d.useState(!1),[Pd,Pr]=d.useState(0),[Up,va]=d.useState(!1),[Br,ys]=d.useState(null),[Ho,xs]=d.useState({}),[Cr,ui]=d.useState({}),vs=d.useRef(new Set),Vr=d.useRef(new Set),[Hn,ws]=d.useState([]),[fi,Tn]=d.useState(null),[hi,Po]=d.useState(0),Pn=d.useRef(null),[Bo,wa]=d.useState(!1),[Vo,ba]=d.useState(0),[bs,ka]=d.useState([]),Yr=d.useRef(null),ks=d.useRef(null),[Yo,_o]=d.useState(150);d.useEffect(()=>{if(F){_o(60);return}const i=()=>{if(!ks.current)return;const f=ks.current.clientWidth,m=Math.floor(f/4);_o(Math.max(100,m))};i();const o=new ResizeObserver(i);return ks.current&&o.observe(ks.current),()=>{o.disconnect()}},[F]),d.useEffect(()=>{Rp().catch(()=>{})},[]);const qo=d.useRef(null);d.useEffect(()=>{qo.current=t},[t]),d.useEffect(()=>{Ce&&Ce.conversationId!==t&&et(null)},[Ce,t]);const mi=d.useRef([]);d.useEffect(()=>{mi.current=Hn},[Hn]);const jr=d.useCallback(i=>{if(i)try{URL.revokeObjectURL(i)}catch{}},[]),Sa=d.useCallback(()=>{Tn(null),ws(i=>i.length?(i.forEach(o=>jr(o.previewUrl)),[]):i)},[jr,Tn]),Ss=d.useCallback((i,o)=>{!i||!i.type.startsWith("image/")||ws(f=>{if(f.length>=Ap)return alert("Можно редактировать не более 10 изображений за раз."),f;const c=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`img-${Date.now()}-${Math.random().toString(36).slice(2)}`,m=URL.createObjectURL(i),h={id:c,file:i,previewUrl:m,edited:!1,fileName:i.name||"image.png",source:o};return[...f,h]})},[]),Bd=d.useCallback(i=>{ws(o=>{const f=o.find(c=>c.id===i);return f&&jr(f.previewUrl),o.filter(c=>c.id!==i)}),Tn(o=>o===i?null:o)},[jr,Tn]),Vd=d.useCallback((i,o,f)=>{ws(c=>c.map(m=>m.id!==i?m:(jr(m.previewUrl),{...m,file:o,previewUrl:f,edited:!0,fileName:o.name||m.fileName})))},[jr]),Go=es({queryKey:["my-devices"],queryFn:async()=>(await ae.get("/devices")).data.devices}),[zp,Xo]=d.useState(null),[Yd,pi]=d.useState(()=>Pe.connected),[_d,Zo]=d.useState(null),[Ko,qd]=d.useState({}),[Qo,gi]=d.useState({}),[Jo,yi]=d.useState({}),[ec,tc]=d.useState({}),[Gd,Cs]=d.useState(!1),[nc,js]=d.useState({}),[rc,sc]=d.useState(!1),[Ca,xi]=d.useState(!1),ic=d.useRef(null),P=or(i=>i.session?.user),Is=d.useRef(null);if(Is.current===null&&typeof window<"u")try{const i=localStorage.getItem("eb_user");if(i){const o=JSON.parse(i);o&&typeof o.id=="string"&&(Is.current=o.id)}}catch{Is.current=null}d.useEffect(()=>{P?.id&&(Is.current=P.id)},[P?.id]);const Wt=P?.id??Is.current??null,se=Us(),ne=Yu(),vi=d.useMemo(()=>t?Ho[t]||[]:[],[t,Ho]),wi=d.useMemo(()=>fi?Hn.find(i=>i.id===fi)??null:null,[Hn,fi]);d.useRef(null),d.useRef(null);const[Bn,qt]=d.useState({}),[Wp,Xd]=d.useState(0),Ir=d.useRef(null);d.useEffect(()=>{Ir.current=n},[n]);const Zd=d.useRef({}),ja=d.useRef({}),_r=d.useRef({});d.useEffect(()=>()=>{typeof window>"u"||(Object.values(_r.current).forEach(i=>{typeof i=="number"&&window.clearTimeout(i)}),w.current&&window.clearTimeout(w.current),Er())},[]),d.useEffect(()=>{if(!u)return;const i=setInterval(()=>{p(o=>o?{...o}:null)},1e3);return()=>clearInterval(i)},[u]);const bi=d.useCallback(i=>{if(!i)return null;const o=ne.getQueryData(["conversations"]);return Array.isArray(o)?o.find(c=>c?.conversation?.id===i)?.conversation??null:null},[ne]),qr=d.useCallback(i=>{const o=bi(i);if(!o)return!1;const f=o.participants?.length??0;return!o.isGroup&&f<=2},[bi]),er=d.useCallback(i=>{if(!i)return;const o=_r.current[i];typeof o=="number"&&typeof window<"u"&&(window.clearTimeout(o),delete _r.current[i]),delete ja.current[i]},[]),ki=d.useCallback(i=>{i&&qr(i)&&(ja.current[i]=Date.now()+Dp)},[qr]),Ia=d.useCallback((i,o,f)=>{if(!i){o();return}if(f?.force){er(i),o();return}const c=ja.current[i];if(!c){o();return}const m=Date.now();if(m>=c){er(i),o();return}const h=c-m,g=_r.current[i];if(typeof g=="number"&&typeof window<"u"&&window.clearTimeout(g),typeof window>"u"){o();return}_r.current[i]=window.setTimeout(()=>{delete _r.current[i],er(i),o()},h)},[er]),Ma=d.useCallback((i,o)=>{const f=i?"камере и микрофону":"микрофону",c=typeof o=="object"&&o&&"name"in o?String(o.name):"";return c==="NotAllowedError"||c==="SecurityError"?`Браузер запретил доступ к ${f}. Разрешите его в адресной строке и попробуйте снова.`:c==="NotFoundError"?i?"Браузер не нашёл камеру или микрофон. Подключите устройство и попробуйте ещё раз.":"Браузер не нашёл микрофон. Подключите устройство и попробуйте ещё раз.":c==="NotReadableError"||c==="TrackStartError"?"Камера или микрофон уже используются другим приложением или вкладкой.":`Не удалось получить доступ к ${f}. Проверьте настройки браузера и попробуйте снова.`},[]),Si=d.useCallback(async i=>{try{const o=await wl({audio:!0,video:i});return o.ok?(ys(null),!0):(ys(Ma(i,o.error)),!1)}catch(o){return ys(Ma(i,o)),!1}},[Ma]),Ci=d.useCallback(async i=>{const o=se.incoming;if(!o||!await Si(i))return;const f=o.conversationId;ki(f),bu(f,i),se.startOutgoing(f,i),qt(c=>{const m=c[f],h=P?.id;return m?.active?h&&m.participants&&!m.participants.includes(h)?{...c,[f]:{...m,participants:[...m.participants,h]}}:c:{...c,[f]:{startedAt:Date.now(),active:!0,participants:h?[h]:[]}}}),s(f),l(c=>c===f?null:c),se.setIncoming(null),on()},[ki,se,P?.id,Si]),Ea=d.useCallback(()=>{const i=se.incoming;i&&(Ec(i.conversationId),se.setIncoming(null),on())},[se]);d.useEffect(()=>{if(typeof window>"u")return;const i={accept:async(o,f)=>se.incoming?.conversationId!==o?!1:(await Ci(f),!0),decline:o=>se.incoming?.conversationId!==o?!1:(Ea(),!0)};return window.__nativeCallOverlayBridge=i,()=>{window.__nativeCallOverlayBridge===i&&delete window.__nativeCallOverlayBridge}},[se.incoming?.conversationId,Ci,Ea]),d.useEffect(()=>{const i=window.setInterval(()=>Xd(o=>(o+1)%1e6),1e3);return()=>window.clearInterval(i)},[]),d.useEffect(()=>{if(!Br||typeof window>"u")return;const i=window.setTimeout(()=>ys(null),9e3);return()=>window.clearTimeout(i)},[Br]),d.useEffect(()=>{const i=()=>{const o=window.innerWidth<=768;Sn(o),St.current=o,o?t||at("list"):at("conversation")};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[t]),d.useEffect(()=>{F&&at(t?"conversation":"list")},[F,t]),d.useEffect(()=>{const i=(()=>{try{const m=new URLSearchParams(window.location.search).get("lkDebugCallStatus");if(m==="1"||m==="true")return!0;const h=window.localStorage.getItem("lk-debug-callstatus");return h==="1"||h==="true"}catch{return!1}})(),o=c=>{i&&console.log("[CallStatus] Single:",c),qt(m=>{const h=ne.getQueryData(["conversations"]),g=Array.isArray(h)?h.find(E=>E.conversation.id===c.conversationId)?.conversation:null,b=m[c.conversationId],v=Us.getState().activeConvId;if(!(!!(g&&(g.isGroup||(g.participants?.length??0)>2))||!!b&&(b.participants?b.participants.length>1:!0)||v===c.conversationId))return m;const R=c.participants||[];if(c.active){const E=typeof c.startedAt=="number"&&c.startedAt>0?c.startedAt:b?.startedAt??Date.now();return{...m,[c.conversationId]:{active:!0,startedAt:E,participants:R,endedAt:null,elapsedMs:typeof c.elapsedMs=="number"?c.elapsedMs:void 0}}}const I=b?.active?Date.now():b?.endedAt??null;return{...m,[c.conversationId]:{active:!1,startedAt:b?.startedAt??null,endedAt:I,participants:[],elapsedMs:void 0}}})},f=c=>{i&&console.log("[CallStatus] Bulk:",c),qt(m=>{const h={...m},g=ne.getQueryData(["conversations"]);for(const[b,v]of Object.entries(c.statuses||{})){const k=Array.isArray(g)?g.find($=>$.conversation.id===b)?.conversation:null,R=m[b],I=Us.getState().activeConvId;if(!(!!(k&&(k.isGroup||(k.participants?.length??0)>2))||!!R&&(R.participants?R.participants.length>1:!0)||I===b))continue;const D=v.participants||[];if(v.active){const $=typeof v.startedAt=="number"&&v.startedAt>0?v.startedAt:R?.startedAt??Date.now();h[b]={active:!0,startedAt:$,participants:D,endedAt:null,elapsedMs:typeof v.elapsedMs=="number"?v.elapsedMs:void 0};continue}const T=R?.active?Date.now():R?.endedAt??null;h[b]={active:!1,startedAt:R?.startedAt??null,endedAt:T,participants:[],elapsedMs:void 0}}return h})};return ku(o),Su(f),()=>{Pe.off("call:status",o),Pe.off("call:status:bulk",f)}},[]),d.useEffect(()=>{if(!Oe.open)return;const i=ic.current;if(!i)return;const o=window.innerWidth,f=window.visualViewport?window.visualViewport.height:window.innerHeight,c=i.getBoundingClientRect();let m=Oe.x,h=Oe.y;m+c.width>o-8&&(m=Math.max(8,o-c.width-8)),h+c.height>f-8&&(h=Math.max(8,f-c.height-8)),(m!==Oe.x||h!==Oe.y)&&mt(g=>({...g,x:m,y:h}))},[Oe.open,Oe.x,Oe.y]),d.useEffect(()=>{if(!We.open)return;const i=Q.current;if(!i)return;const o=window.innerWidth,f=window.visualViewport?window.visualViewport.height:window.innerHeight,c=i.getBoundingClientRect();let m=We.x,h=We.y;m+c.width>o-8&&(m=Math.max(8,o-c.width-8)),h+c.height>f-8&&(h=Math.max(8,f-c.height-8)),(m!==We.x||h!==We.y)&&Y(g=>({...g,x:m,y:h}))},[We.open,We.x,We.y]),d.useEffect(()=>{if(!te.open||!te.anchor)return;const i=Ke.current;if(!i)return;const o=te.anchor.getBoundingClientRect(),f=window.innerWidth,c=window.visualViewport?window.visualViewport.height:window.innerHeight;i.style.display="flex";const m=i.getBoundingClientRect();let h=o.right-m.width,g=o.bottom+8;h<8&&(h=8),h+m.width>f-8&&(h=f-m.width-8),g+m.height>c-8&&(g=o.top-m.height-8),g<8&&(g=8),i.style.left=`${h}px`,i.style.top=`${g}px`},[te.open,te.anchor]),d.useEffect(()=>{t||oe({open:!1,anchor:null})},[t]);function Gr(i){e(o=>{try{o&&o!==i&&(pe.data||[]).find(m=>m.conversation.id===o)?.conversation?.isSecret&&ne.removeQueries({queryKey:["messages",o]})}catch{}return i}),F&&at("conversation"),mi.current.length&&Sa()}async function ac(){let i=os();return i||(i=await Pu()),i||null}async function oc(i){if(rc)return;sc(!0);const o=2;let f=0;const c=async()=>{if(f>=o)throw new Error("Не удалось подготовить устройство для секретного чата. Попробуйте позже.");f+=1,await Hu()};try{for(;;){const m=await ac();if(!m){alert("Не удалось инициализировать устройство для секретного чата");return}try{const h={participantIds:[i],isGroup:!1,isSecret:!0,initiatorDeviceId:m.deviceId};console.log("[SecretChat] Creating with payload:",h),await ae.post("/conversations",h),ne.invalidateQueries({queryKey:["conversations"]});return}catch(h){console.error("[SecretChat] Creation error:",h?.response?.data||h);const g=h?.response?.data?.message,b=h?.response?.data?.errors;if(b&&console.error("[SecretChat] Validation errors:",b),h?.response?.status===400&&typeof g=="string"&&g.toLowerCase().includes("invalid initiator device")){await c();continue}const k=b?`Ошибка валидации: ${b.map(R=>`${R.path.join(".")}: ${R.message}`).join(", ")}`:g||"Не удалось отправить запрос на секретный чат";throw new Error(k)}}}catch(m){console.error("Failed to start secret conversation:",m);const h=m?.message||m?.response?.data?.message||"Не удалось отправить запрос на секретный чат";alert(h)}finally{sc(!1)}}const cc=async i=>{xi(!0);try{Bu(i),js(o=>{const f={...o};return delete f[i],f}),ne.invalidateQueries({queryKey:["conversations"]})}finally{xi(!1)}},Kd=async i=>{xi(!0);try{const o=await ac();if(!o){alert("Не удалось инициализировать устройство для секретного чата");return}Vu(i,o.deviceId),ne.invalidateQueries({queryKey:["conversations"]}),Gr(i)}catch(o){console.error("Failed to accept secret chat:",o),alert("Не удалось принять секретный чат")}finally{xi(!1)}};async function lc(i,o){if(!i)return;const f={...o,content:o.content??void 0};if(i.isSecret){const c=await Ln.encryptPayload(i,f);await ae.post("/conversations/send",c);return}await ae.post("/conversations/send",{conversationId:i.id,...f})}const Xr=()=>{C(!1),y([]),S(!1),z("friends"),X(["","","",""]),he(null),Qe(null),Ve(!1)},Qd=async()=>{if(!t||B.length===0){Xr();return}S(!0);try{await ae.post(`/conversations/${t}/participants`,{participantIds:B}),ne.invalidateQueries({queryKey:["conversations"]}),pe.refetch(),Xr()}catch(i){console.error("Error adding participants:",i),alert(i.response?.data?.message||"Не удалось добавить участников")}finally{S(!1)}},Jd=async()=>{if(!(!t||!re)){S(!0);try{await ae.post(`/conversations/${t}/participants`,{participantIds:[re.id]}),ne.invalidateQueries({queryKey:["conversations"]}),pe.refetch(),Xr()}catch(i){console.error("Error adding participant by EBLID:",i),alert(i.response?.data?.message||"Не удалось добавить участника")}finally{S(!1)}}},eu=(i,o)=>{if(!/^\d?$/.test(o))return;const f=[...U];f[i]=o,X(f),o&&i<3&&le[i+1].current?.focus(),!o&&i>0&&le[i-1].current?.focus();const c=f.join("");if(c.length===4&&/^\d{4}$/.test(c)){const m=Date.now();ft.current=m,Ve(!0),Qe(null),ae.get("/contacts/search",{params:{query:c}}).then(h=>{if(ft.current!==m)return;const g=h.data.results?.[0]??null;he(g),Qe(g?null:"Пользователь не найден")}).catch(()=>{ft.current===m&&(he(null),Qe("Не удалось выполнить поиск"))}).finally(()=>{ft.current===m&&Ve(!1)})}else he(null),Qe(null),Ve(!1)};function tu(){if(F){if(t)try{(pe.data||[]).find(f=>f.conversation.id===t)?.conversation?.isSecret&&ne.removeQueries({queryKey:["messages",t]})}catch{}at("list"),e(null),Fn(!1)}mi.current.length&&Sa()}const yn=es({queryKey:["me-info"],queryFn:async()=>(await ae.get("/status/me")).data.user}),pe=es({queryKey:["conversations"],queryFn:async()=>(await ae.get("/conversations")).data.conversations}),tt=es({queryKey:["messages",t],enabled:!!t,queryFn:async()=>(await ae.get(`/conversations/${t}/messages`)).data.messages,refetchInterval:t?15e3:!1});d.useEffect(()=>{tt.error?.response?.status===403&&t&&(console.warn("[ChatsPage] Lost access to conversation, closing view",t),ne.removeQueries({queryKey:["messages",t]}),e(null))},[tt.error,t,ne]);const Ft=es({queryKey:["accepted-contacts"],queryFn:async()=>(await ae.get("/contacts",{params:{filter:"accepted"}})).data.contacts}),sn=es({queryKey:["incoming-contacts"],queryFn:async()=>(await ae.get("/contacts",{params:{filter:"incoming"}})).data.contacts});d.useEffect(()=>{if(t&&!(typeof window>"u"))try{window.localStorage.setItem(Cl,t)}catch{}},[t]),d.useEffect(()=>{if(typeof window>"u"||t)return;const i=pe.data;if(!(!i||i.length===0)&&!(St.current&&Ye!=="conversation"))try{const o=window.localStorage.getItem(Cl);if(!o)return;i.some(c=>c?.conversation?.id===o)&&Gr(o)}catch{}},[t,pe.data,Ye]);const Ta=()=>{if(Xs(!1),Zs(""),Yt([]),xr(!1),tn)try{URL.revokeObjectURL(tn)}catch{}if(Do(null),_t)try{URL.revokeObjectURL(_t)}catch{}vr(null),In(null),Oo(null),Mn({x:0,y:0,scale:1}),Zn(!1)};d.useEffect(()=>{const i=it.current;if(!i)return;const o=()=>{const{scrollTop:f,scrollHeight:c,clientHeight:m}=i,h=f>2,g=c-f-m>2;ct(h),pr(g)};return o(),i.addEventListener("scroll",o),window.addEventListener("resize",o),()=>{i.removeEventListener("scroll",o),window.removeEventListener("resize",o)}},[pe.data?.length]),d.useEffect(()=>{try{const i=(pe.data||[]).map(o=>o.conversation.id);try{const f=new URLSearchParams(window.location.search).get("lkDebugCallStatus");(f==="1"||f==="true"||window.localStorage.getItem("lk-debug-callstatus")==="1"||window.localStorage.getItem("lk-debug-callstatus")==="true")&&console.log("[CallStatus] Requesting statuses for:",i)}catch{}i.length>0&&Tc(i);for(const o of i)try{Nc(o)}catch{}}catch{}},[pe.data]);const A=d.useMemo(()=>pe.data?.find(i=>i.conversation.id===t)?.conversation,[pe.data,t]);d.useEffect(()=>()=>{vs.current.forEach(i=>URL.revokeObjectURL(i)),vs.current.clear(),Vr.current.clear()},[]),d.useEffect(()=>{vs.current.forEach(i=>URL.revokeObjectURL(i)),vs.current.clear(),Vr.current.clear(),ui({})},[A?.id]);const Ms=d.useMemo(()=>os()?.deviceId??null,[hi]),ji=d.useMemo(()=>{const i={};for(const o of Go.data||[])i[o.id]=o;return i},[Go.data]),Ii=d.useCallback(i=>{if(!i?.isSecret)return null;const o=[i.secretInitiatorDeviceId,i.secretPeerDeviceId];for(const f of o){if(!f)continue;const c=ji[f];if(c?.userId&&P?.id&&c.userId===P.id)return f}if(P?.id){if(i.createdById===P.id&&i.secretInitiatorDeviceId)return i.secretInitiatorDeviceId;if(i.createdById!==P.id&&i.secretPeerDeviceId)return i.secretPeerDeviceId}return null},[ji,P?.id]),Zr=d.useMemo(()=>Ii(A),[A,Ii]),dc=d.useMemo(()=>{if(!Zr)return;const i=ji[Zr]?.name;if(i&&i.trim())return i;const o=os();if(o&&o.deviceId===Zr&&o.name)return o.name},[Zr,ji,hi]),uc=d.useCallback(i=>{if(!i)return!1;const o=(pe.data||[]).find(c=>c?.conversation?.id===i)?.conversation;if(!o?.isSecret)return!1;const f=Ii(o);return!!(f&&Ms&&f!==Ms)},[pe.data,Ms,Ii]),Mi=!!(A?.isSecret&&(A.secretStatus??"ACTIVE")!=="ACTIVE"),Kr=d.useMemo(()=>A?.isSecret?Ln.hasSession(A.id):!0,[A?.id,A?.isSecret,hi]),nu=!!(A?.isSecret&&!Mi&&!Kr&&Zr&&Ms&&Zr!==Ms);d.useEffect(()=>{if(!A?.isSecret||A.secretStatus!=="ACTIVE")return;let i=!1;return Ln.ensureSession(A).then(o=>{!i&&o&&Po(f=>(f+1)%Number.MAX_SAFE_INTEGER)}).catch(o=>{console.warn("Failed to ensure E2EE session",o)}),()=>{i=!0}},[A?.id,A?.secretStatus,A?.isSecret]),d.useEffect(()=>{if(!A?.isSecret||!tt.data||tt.data.length===0)return;Ln.processHandshakes(A,tt.data)&&Po(o=>(o+1)%Number.MAX_SAFE_INTEGER)},[tt.data,A?.id,A?.isSecret,A?.secretStatus]);const an=d.useMemo(()=>tt.data?A?.isSecret?tt.data.filter(i=>{const f=(i?.metadata??{}).e2ee;return!(f&&f.kind==="handshake")}).map(i=>Ln.transformMessage(A.id,i)):tt.data:[],[tt.data,A?.id,A?.isSecret,hi]),fc=d.useCallback(i=>{if(!A?.id)return;const o=i?.metadata?.e2ee;!o||o.kind!=="ciphertext"||!o.nonce||!Ln.hasSession(A.id)||Vr.current.has(i.url)||Cr[i.url]?.status==="ready"||(Vr.current.add(i.url),ui(c=>({...c,[i.url]:{status:"pending"}})),(async()=>{try{const c=Zi(i.url)||i.url,m=await fetch(c,{credentials:"omit"});if(!m.ok)throw new Error(`HTTP ${m.status}: ${m.statusText}`);const h=new Uint8Array(await m.arrayBuffer()),g=Ln.decryptBinary(A.id,h,o.nonce);if(!g)throw new Error("Failed to decrypt attachment: decryptBinary returned null");const b=new Blob([g],{type:o.originalType||i.metadata?.mime||i.metadata?.contentType||"application/octet-stream"}),v=URL.createObjectURL(b);vs.current.add(v),Vr.current.delete(i.url),ui(k=>({...k,[i.url]:{status:"ready",url:v}}))}catch(c){Vr.current.delete(i.url),ui(m=>{const h={...m};return c?.message?.includes("E2EE session is not ready")?delete h[i.url]:h[i.url]={status:"error"},h})}})())},[A?.id,Cr]),Ei=d.useCallback(i=>{if(!i)return null;const o=Zi(i.url);if(!A?.isSecret)return o;const f=i.metadata?.e2ee;if(!f||f.kind!=="ciphertext")return o;const c=Cr[i.url];return c?.status==="ready"&&c.url?c.url:null},[Cr,A?.isSecret]);d.useEffect(()=>{if(!A?.isSecret||!Kr)return;(an||[]).flatMap(o=>o.attachments||[]).forEach(o=>{o?.metadata?.e2ee?.kind==="ciphertext"&&fc(o)})},[an,A?.id,A?.isSecret,Kr,fc]),d.useEffect(()=>{const i=new Set((pe.data||[]).map(o=>o.conversation).filter(o=>o?.isSecret&&(o.secretStatus??"ACTIVE")==="PENDING").map(o=>o.id));js(o=>{let f=!1;const c={...o};for(const m of Object.keys(c))i.has(m)||(delete c[m],f=!0);return f?c:o})},[pe.data]);const Qr=d.useMemo(()=>{if(!A||A.isGroup||A.isSecret||!P?.id)return null;const i=jl(A.participants||[]);if(!i)return null;const o=pe.data||[];for(const f of o){const c=f.conversation;if(!c?.isSecret||(c.secretStatus??"ACTIVE")!=="PENDING"||jl(c.participants||[])!==i)continue;const h=(c.participants||[]).find(b=>b.user.id===c.createdById)?.user,g=nc[c.id]?.from?.name??h?.displayName??h?.username??"Собеседник";return{conversationId:c.id,isInitiator:c.createdById===P.id,initiatorName:g}}return null},[A,pe.data,P?.id,nc]),hc=d.useMemo(()=>{const i={};if(A)for(const o of A.participants)i[o.user.id]=o.user;return P&&!i[P.id]&&(i[P.id]=P),i},[A,P]),Na=d.useMemo(()=>A?(A.participants||[]).map(i=>i.user.id):[],[A]),mc=d.useMemo(()=>{if(!A||!Ft.data)return[];const i=new Set(Na);return Ft.data.filter(o=>!i.has(o.friend.id))},[A,Ft.data,Na]),Ti={alreadyInChat:re?Na.includes(re.id):!1,isSelf:re?re.id===P?.id:!1};d.useEffect(()=>{mr&&M==="eblid"&&le[0].current?.focus()},[mr,M]),d.useEffect(()=>{const i=o=>{qd(f=>{const c=(o.status||"").toString().toUpperCase();return f[o.userId]===c?f:{...f,[o.userId]:c}}),ne.setQueryData(["conversations"],f=>f&&f.map(c=>({...c,conversation:{...c.conversation,participants:c.conversation.participants.map(h=>h.user.id===o.userId?{...h,user:{...h.user,status:o.status,lastSeenAt:o.status==="ONLINE"||o.status==="BACKGROUND"||o.status==="IN_CALL"||o.status==="OFFLINE"?new Date().toISOString():h.user.lastSeenAt}}:h)}})))};return Rc(i),()=>{Pe.off("presence:update",i)}},[ne]);const Mr=d.useCallback(i=>{const o=i?.id,f=typeof o=="string"?o:null,m=((f?Ko[f]:void 0)??i?.status??"OFFLINE").toString().toUpperCase();return m==="IN_CALL"?"IN_CALL":m==="ONLINE"?"ONLINE":m==="BACKGROUND"?"BACKGROUND":m==="AWAY"?"AWAY":"OFFLINE"},[Ko]),Ni=d.useRef(Pe.connected);d.useEffect(()=>{const i=()=>{try{const m=(window.visualViewport?window.visualViewport.height:window.innerHeight)*.01;document.documentElement.style.setProperty("--vh",m+"px")}catch{}ne.invalidateQueries({queryKey:["me-info"]}),pi(Pe.connected)};window.addEventListener("focus",i);const o=()=>{pi(!0);const m=Ni.current;if(Ni.current=!0,m)try{const h=(pe.data||[]).map(g=>g.conversation.id);for(const g of h)try{Nc(g)}catch{}h.length>0&&Tc(h)}catch{}},f=()=>{pi(!1),Ni.current=!1};Pe.on("connect",o),Pe.on("disconnect",f),pi(Pe.connected),Pe.connected&&(Ni.current=!0);const c=()=>{ne.invalidateQueries({queryKey:["me-info"]})};return document.addEventListener("visibilitychange",c),()=>{Pe.off("connect",o),Pe.off("disconnect",f),document.removeEventListener("visibilitychange",c),window.removeEventListener("focus",i)}},[ne]),d.useEffect(()=>{const i=o=>{if(P?.id&&o.userId===P.id){const f=(o.status||"").toUpperCase();(f==="ONLINE"||f==="AWAY"||f==="BACKGROUND"||f==="IN_CALL"||f==="OFFLINE")&&Zo(f)}};return Rc(i),()=>{Pe.off("presence:update",i)}},[P?.id]),d.useEffect(()=>{const i=(yn.data?.status||"").toString().toUpperCase();(i==="ONLINE"||i==="AWAY"||i==="BACKGROUND"||i==="IN_CALL"||i==="OFFLINE")&&Zo(i)},[yn.data]),d.useEffect(()=>{const i=o=>{ne.setQueryData(["conversations"],f=>f&&f.map(c=>({...c,conversation:{...c.conversation,participants:c.conversation.participants.map(m=>m.user.id===o.userId?{...m,user:{...m.user,avatarUrl:o.avatarUrl??m.user.avatarUrl,displayName:o.displayName??m.user.displayName}}:m)}}))),o.userId===P?.id&&yn.refetch()};return Cu(i),()=>{Pe.off("profile:update",i)}},[ne,P?.id]);function ru(i){return"#191d23"}d.useEffect(()=>{if(!t)return;const i=async o=>{const f=o.target;if(f&&(f.tagName==="INPUT"||f.tagName==="TEXTAREA"))return;const c=o.clipboardData?.items;if(c)for(let m=0;m<c.length;m++){const h=c[m];if(h.type.indexOf("image")!==-1){o.preventDefault(),o.stopPropagation();const g=h.getAsFile();g&&Ss(g,"paste");break}}};return window.addEventListener("paste",i,!0),()=>{window.removeEventListener("paste",i,!0)}},[t,Ss]),d.useEffect(()=>{pe.refetch(),ju(),Iu(()=>pe.refetch()),Mu(c=>{const m=c?.conversationId;if(!m){pe.refetch();return}js(g=>{if(!g[m])return g;const b={...g};return delete b[m],b}),xs(g=>{if(!g[m])return g;const b={...g};return delete b[m],b}),Ln.clearSession(m),ne.removeQueries({queryKey:["messages",m]}),ne.setQueryData(["conversations"],g=>Array.isArray(g)?g.filter(b=>b?.conversation?.id!==m):g),qo.current===m&&(e(g=>g===m?null:g),Fn(!1),mi.current.length&&Sa(),St.current&&at("list")),pe.refetch()}),Eu(()=>{pe.refetch()}),Tu(()=>{pe.refetch()});const i=Nu(c=>{js(m=>({...m,[c.conversationId]:c})),pe.refetch()}),o=Ru(c=>{js(m=>{const h={...m};return delete h[c.conversationId],h}),ne.invalidateQueries({queryKey:["conversations"]}),Gr(c.conversationId)});Du(({conversationId:c,from:m,video:h})=>{if(!(ue.current&&ue.current===c)){on();try{const g=ne.getQueryData(["conversations"]),b=Array.isArray(g)?g.find(R=>R.conversation.id===c)?.conversation:null,v=!!(b&&(b.isGroup||(b.participants?.length??0)>2));Zd.current[c]=m.id;const k=Ir.current===c;if(v||k||m?.id&&P?.id&&m.id===P.id)return}catch{}ue.current=c,se.startIncoming({conversationId:c,from:m,video:h});try{const g=gc();g&&(g.currentTime=0,g.loop=!0,g.volume=.9,g.play().catch(()=>{}))}catch(g){console.error("Error starting ringtone:",g)}V.current=window.setTimeout(()=>{Ec(c),on(),se.setIncoming(null)},25e3)}}),Au(({conversationId:c,by:m,video:h})=>{if(er(c),p(k=>k?.conversationId===c?(w.current&&(window.clearTimeout(w.current),w.current=null),Er(),null):k),m?.id===P?.id){(se.incoming?.conversationId===c||ue.current===c)&&(on(),se.setIncoming(null),V.current&&(window.clearTimeout(V.current),V.current=null),ue.current=null);return}const g=Ir.current===c,b=Us.getState().activeConvId===c,v=x.current?.conversationId===c;if(!g&&!b&&!v){(Us.getState().incoming?.conversationId===c||ue.current===c)&&(on(),se.setIncoming(null),V.current&&(window.clearTimeout(V.current),V.current=null),ue.current=null);return}if(qt(k=>k[c]?.active?k:{...k,[c]:{startedAt:Date.now(),active:!0,participants:[P?.id||""].filter(Boolean)}}),se.activeConvId!==c){const k=!!h;se.startOutgoing(c,k)}s(c),l(k=>k===c?null:k),on()}),Ou(({conversationId:c})=>{p(h=>h?.conversationId===c?(w.current&&(window.clearTimeout(w.current),w.current=null),Er(),Ri(),null):h);const m=()=>{qt(h=>{const g=h[c];if(g){if(g.active)return{...h,[c]:{...g,active:!1,endedAt:Date.now()}};const{[c]:b,...v}=h;return v}return h}),Ir.current===c&&(s(h=>h===c?null:h),l(h=>h===c?null:h),se.endCall()),se.setIncoming(null),on(),er(c)};qr(c)?Ia(c,m,{force:!0}):m()}),Lu(({conversationId:c})=>{try{const h=ne.getQueryData(["conversations"]),g=Array.isArray(h)?h.find(v=>v.conversation.id===c)?.conversation:null;if(!!(g&&(g.isGroup||(g.participants?.length??0)>2)))return}catch{}if(a===c)return;if(qr(c)){const h=Bn[c];if((Ir.current===c||se.activeConvId===c)&&h?.active){console.log("[ChatsPage] Ignoring call:ended for active 1:1 call where user is participating",c);return}}const m=()=>{p(h=>h?.conversationId===c?(w.current&&(window.clearTimeout(w.current),w.current=null),Er(),null):h),qt(h=>{const g=h[c];if(g?.active)return{...h,[c]:{...g,active:!1,endedAt:Date.now()}};const{[c]:b,...v}=h;return v}),Ir.current===c&&(s(h=>h===c?null:h),l(h=>h===c?null:h),se.endCall()),se.setIncoming(null),on(),er(c)};qr(c)?Ia(c,m,{force:!0}):m()}),Uu(({conversationId:c})=>{ne.invalidateQueries({queryKey:["messages",c]}),ne.refetchQueries({queryKey:["messages",c]})});let f=null;try{pc(),window.innerWidth<=768&&or.getState().session?.user&&(!ie.current||!Xe.current)&&ze(!0);const m=async()=>{await yc()&&f&&(f(),f=null)};window.addEventListener("click",m),window.addEventListener("keydown",m),window.addEventListener("touchstart",m),f=()=>{window.removeEventListener("click",m),window.removeEventListener("keydown",m),window.removeEventListener("touchstart",m)}}catch{}return()=>{f?.(),i?.(),o?.()}},[]),d.useEffect(()=>{zu(()=>{sn.refetch()}),Wu(()=>{Ft.refetch(),pe.refetch(),sn.refetch()}),Fu(()=>{Ft.refetch(),sn.refetch()})},[]),d.useEffect(()=>{if(!nn)return;const i=br.current;if(!i)return;const o=(v,k)=>{const R=k.clientX-v.clientX,I=k.clientY-v.clientY;return Math.sqrt(R*R+I*I)},f=(v,k)=>({x:(v.clientX+k.clientX)/2,y:(v.clientY+k.clientY)/2}),c=240,m=(v,k,R,I,E)=>{const D=v-R,T=k-I;return D*D+T*T<=E*E},h=v=>{const k=i.getBoundingClientRect();if(!k)return;const R=k.width,I=k.height,E=R/2,D=I/2,T=c/2;if(v.touches.length===1){const $=v.touches[0],K=$.clientX-k.left,Z=$.clientY-k.top;if(!m(K,Z,E,D,T))return;Nt.current={touches:[$],initialDistance:0,initialScale:_e.scale,initialX:_e.x,initialY:_e.y},v.preventDefault()}else if(v.touches.length===2){const $=v.touches[0],K=v.touches[1],Z=f($,K),ye=Z.x-k.left,xe=Z.y-k.top;if(!m(ye,xe,E,D,T))return;const we=o($,K);Nt.current={touches:[$,K],initialDistance:we,initialScale:_e.scale,initialX:_e.x,initialY:_e.y},v.preventDefault()}},g=v=>{Nt.current&&(v.preventDefault(),kr.current!==null&&cancelAnimationFrame(kr.current),kr.current=requestAnimationFrame(()=>{if(!Nt.current)return;const k=i.getBoundingClientRect();if(!k)return;const R=k.width,I=k.height,E=R/2,D=I/2,T=v.touches.length,$=Nt.current.touches.length;if(T===1&&$===1){const K=v.touches[0],Z=Nt.current.touches[0],ye=K.clientX-Z.clientX,xe=K.clientY-Z.clientY;Qn(we=>{let ke=Nt.current.initialX+ye,$e=Nt.current.initialY+xe;const Ge=ma.current;if(Ge){const Dt=we.scale,cn=Ge.naturalWidth*Dt,$t=Ge.naturalHeight*Dt,At=E+c/2,me=E-c/2-cn,De=D+c/2,fe=D-c/2-$t;ke=Math.max(me,Math.min(At,ke)),$e=Math.max(fe,Math.min(De,$e))}return{...we,x:ke,y:$e}})}else if(T===2&&$===2){const K=v.touches[0],Z=v.touches[1],xe=o(K,Z)/Nt.current.initialDistance,we=Math.max(.1,Math.min(10,Nt.current.initialScale*xe)),ke=ma.current;if(ke){const $e=ke.naturalWidth,Ge=ke.naturalHeight,Dt=Nt.current.initialX+$e*Nt.current.initialScale/2,cn=Nt.current.initialY+Ge*Nt.current.initialScale/2,$t=Dt-E,At=cn-D,me=we/Nt.current.initialScale,De=E+$t*me,fe=D+At*me,je=De-$e*we/2,ve=fe-Ge*we/2;Qn({x:je,y:ve,scale:we})}}kr.current=null}))},b=()=>{kr.current!==null&&(cancelAnimationFrame(kr.current),kr.current=null),Nt.current=null};return i.addEventListener("touchstart",h,{passive:!1}),i.addEventListener("touchmove",g,{passive:!1}),i.addEventListener("touchend",b,{passive:!0}),i.addEventListener("touchcancel",b,{passive:!0}),()=>{i.removeEventListener("touchstart",h),i.removeEventListener("touchmove",g),i.removeEventListener("touchend",b),i.removeEventListener("touchcancel",b)}},[nn,_e.scale,_e.x,_e.y]),d.useEffect(()=>{if(!rn)return;const i=Jn.current;if(!i)return;const o=(v,k)=>{const R=k.clientX-v.clientX,I=k.clientY-v.clientY;return Math.sqrt(R*R+I*I)},f=(v,k)=>({x:(v.clientX+k.clientX)/2,y:(v.clientY+k.clientY)/2}),c=240,m=(v,k,R,I,E)=>{const D=v-R,T=k-I;return D*D+T*T<=E*E},h=v=>{const k=i.getBoundingClientRect();if(!k)return;const R=k.width,I=k.height,E=R/2,D=I/2,T=c/2;if(v.touches.length===1){const $=v.touches[0],K=$.clientX-k.left,Z=$.clientY-k.top;if(!m(K,Z,E,D,T))return;Rt.current={touches:[$],initialDistance:0,initialScale:qe.scale,initialX:qe.x,initialY:qe.y},v.preventDefault()}else if(v.touches.length===2){const $=v.touches[0],K=v.touches[1],Z=f($,K),ye=Z.x-k.left,xe=Z.y-k.top;if(!m(ye,xe,E,D,T))return;const we=o($,K);Rt.current={touches:[$,K],initialDistance:we,initialScale:qe.scale,initialX:qe.x,initialY:qe.y},v.preventDefault()}},g=v=>{Rt.current&&(v.preventDefault(),Sr.current!==null&&cancelAnimationFrame(Sr.current),Sr.current=requestAnimationFrame(()=>{if(!Rt.current)return;const k=i.getBoundingClientRect();if(!k)return;const R=k.width,I=k.height,E=R/2,D=I/2,T=v.touches.length,$=Rt.current.touches.length;if(T===1&&$===1){const K=v.touches[0],Z=Rt.current.touches[0],ye=K.clientX-Z.clientX,xe=K.clientY-Z.clientY;En(we=>{let ke=Rt.current.initialX+ye,$e=Rt.current.initialY+xe;const Ge=si.current;if(Ge){const Dt=we.scale,cn=Ge.naturalWidth*Dt,$t=Ge.naturalHeight*Dt,At=E+c/2,me=E-c/2-cn,De=D+c/2,fe=D-c/2-$t;ke=Math.max(me,Math.min(At,ke)),$e=Math.max(fe,Math.min(De,$e))}return{...we,x:ke,y:$e}})}else if(T===2&&$===2){const K=v.touches[0],Z=v.touches[1],xe=o(K,Z)/Rt.current.initialDistance,we=Math.max(.1,Math.min(10,Rt.current.initialScale*xe)),ke=si.current;if(ke){const $e=ke.naturalWidth,Ge=ke.naturalHeight,Dt=Rt.current.initialX+$e*Rt.current.initialScale/2,cn=Rt.current.initialY+Ge*Rt.current.initialScale/2,$t=Dt-E,At=cn-D,me=we/Rt.current.initialScale,De=E+$t*me,fe=D+At*me,je=De-$e*we/2,ve=fe-Ge*we/2;En({x:je,y:ve,scale:we})}}Sr.current=null}))},b=()=>{Sr.current!==null&&(cancelAnimationFrame(Sr.current),Sr.current=null),Rt.current=null};return i.addEventListener("touchstart",h,{passive:!1}),i.addEventListener("touchmove",g,{passive:!1}),i.addEventListener("touchend",b,{passive:!0}),i.addEventListener("touchcancel",b,{passive:!0}),()=>{i.removeEventListener("touchstart",h),i.removeEventListener("touchmove",g),i.removeEventListener("touchend",b),i.removeEventListener("touchcancel",b)}},[rn,qe.scale,qe.x,qe.y]);const pc=d.useCallback(()=>{if(typeof window>"u")return null;if(!Te.current){const i=new Audio("/notify.mp3");i.preload="auto",i.volume=.9,Te.current=i}return Te.current},[]),gc=d.useCallback(()=>{if(typeof window>"u")return null;if(!be.current){const i=new Audio("/ring.mp3");i.preload="auto",i.loop=!0,i.volume=.9,be.current=i}return be.current},[]),su=d.useCallback(()=>{if(typeof window>"u")return null;if(!st.current){const i=new Audio("/silent.wav");i.preload="auto",st.current=i}return st.current},[]),yc=async()=>{if(Ie.current)return ie.current&&Xe.current;Ie.current=!0;const i=async o=>{try{const f=o.play();return f&&typeof f.then=="function"&&await f,!0}catch{return!1}};try{pc(),gc();let o=!1;const f=su();if(f){o=await i(f);try{f.pause(),f.currentTime=0}catch{}}o&&(ie.current=!0,Xe.current=!0,ze(!1))}catch{}return Ie.current=!1,ie.current&&Xe.current};function on(){try{if(V.current&&clearTimeout(V.current),V.current=null,be.current)try{be.current.pause(),be.current.currentTime=0}catch{}ue.current=null}catch{}}const iu=d.useCallback(()=>{if(typeof window>"u")return null;if(!Be.current){const i=new Audio("/dialing.mp3");i.preload="auto",i.loop=!0,i.volume=.7,Be.current=i}return Be.current},[]);function xc(){try{const i=iu();i&&(i.currentTime=0,i.loop=!0,i.volume=.7,i.play().catch(()=>{}))}catch(i){console.error("Error starting dialing sound:",i)}}function Er(){try{if(Be.current)try{Be.current.pause(),Be.current.currentTime=0}catch{}}catch{}}const au=d.useCallback(()=>{if(typeof window>"u")return null;if(!Ne.current){const i=new Audio("/notify.mp3");i.preload="auto",i.volume=.6,Ne.current=i}return Ne.current},[]);function Ri(){try{const i=au();i&&(i.currentTime=0,i.volume=.6,i.play().catch(()=>{}))}catch(i){console.error("Error playing end call sound:",i)}}d.useEffect(()=>{const i=async c=>{if(!(c.conversationId===t)){ne.invalidateQueries({queryKey:["conversations"]});return}if(!t)return;const g=c.message??c;g&&g.id&&(xs(b=>{const v=b[t]||[];if(v.length===0)return b;const k=(g.attachments||[]).map(I=>I.url).sort(),R=v.filter(I=>{if(I.senderId!==g.senderId)return!0;const E=I.attachments.map(D=>D.url).sort();return E.length===k.length?!E.every((T,$)=>{const K=k[$];return T===K||T.startsWith("blob:")&&K&&!K.startsWith("blob:")}):!0});if(R.length===v.length)return b;if(R.length===0){const{[t]:I,...E}=b;return E}return{...b,[t]:R}}),kc(t,g)),tt.refetch()},o=c=>{c.conversationId===t&&(Fe(!0),wt.current&&window.clearTimeout(wt.current),wt.current=window.setTimeout(()=>Fe(!1),2e3))},f=c=>{if(!t||c.conversationId!==t){ne.invalidateQueries({queryKey:["conversations"]});return}c.message?gu(t,c.message):tt.refetch()};return Pe.on("message:new",i),Pe.on("conversation:typing",o),Pe.on("message:reaction",f),()=>{Pe.off("message:new",i),Pe.off("conversation:typing",o),Pe.off("message:reaction",f)}},[t]),d.useEffect(()=>{const i=async o=>{if(uc(o.conversationId))return;const f=o.senderId===P?.id,c=o.conversationId===t,m=document.visibilityState==="visible";if(!f&&(!c||!m)&&Te.current&&ie.current&&(Te.current.currentTime=0,Te.current.play().catch(()=>{})),c){o.message&&o.message.id&&kc(t,o.message),tt.refetch().catch(()=>{});return}};return Pe.on("message:notify",i),()=>{Pe.off("message:notify",i)}},[t,P?.id,tt,uc]),d.useLayoutEffect(()=>{if(!t){Bt.current=null,He.current=0;return}Bt.current!==t&&(Bt.current=t,He.current=0);const i=(an?.length??0)+vi.length,o=He.current;if(He.current=i,!ge.current||i===0||i<=o)return;const f=[...an||[],...vi],c=f[f.length-1],m=c?.senderId&&P?.id?c.senderId===P.id:!1;(m||!Je.current||ht.current)&&requestAnimationFrame(()=>{const g=ge.current;g&&(g.scrollTop=g.scrollHeight,ht.current=!0,m&&(Je.current=!1))})},[t,vi,an,P?.id]),d.useEffect(()=>{if(!t)return;const i=ge.current;if(!i)return;const o=()=>{i&&(i.scrollTop=i.scrollHeight,ht.current=!0,Je.current=!1)};if(St.current){o();const f=window.setTimeout(o,50),c=window.setTimeout(o,200);return()=>{window.clearTimeout(f),window.clearTimeout(c)}}o()},[t]),d.useEffect(()=>{if(!St.current)return;const i=ge.current;if(!i)return;const o=()=>{const f=typeof document<"u"?document.activeElement:null;f&&f===L.current&&(i.scrollTop=i.scrollHeight,ht.current=!0,Je.current=!1)};return window.visualViewport&&(window.visualViewport.addEventListener("resize",o,{passive:!0}),window.visualViewport.addEventListener("scroll",o,{passive:!0})),()=>{window.visualViewport&&(window.visualViewport.removeEventListener("resize",o),window.visualViewport.removeEventListener("scroll",o))}},[t]),d.useEffect(()=>{},[]),d.useEffect(()=>{if(!Et||!St.current)return;const i=ge.current,o=window.setInterval(()=>{Un(f=>f%3+1),i&&i.scrollHeight-i.scrollTop-i.clientHeight<80&&(i.scrollTop=i.scrollHeight)},500);return()=>window.clearInterval(o)},[Et]),d.useEffect(()=>{const i=ge.current;if(!i)return;let o=0,f=i.scrollTop;const c=()=>{o&&cancelAnimationFrame(o);const m=i.scrollTop;Math.abs(m-f)>1&&(Je.current=!0),o=requestAnimationFrame(()=>{const g=i.scrollHeight-i.scrollTop-i.clientHeight<8;ht.current=g,Fn(!g),g&&window.setTimeout(()=>{i.scrollHeight-i.scrollTop-i.clientHeight<40&&(Je.current=!1)},100),f=i.scrollTop})};return i.addEventListener("scroll",c,{passive:!0}),c(),()=>{i.removeEventListener("scroll",c),o&&cancelAnimationFrame(o)}},[t]),d.useEffect(()=>{const i=()=>{if(!ge.current)return;const o=ge.current.clientWidth;pn(o>=900)};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[t]);function ou(i,o){if(!/^\d?$/.test(o))return;const f=[...ca];f[i]=o,zd(f),o&&i<3&&la[i+1].current?.focus(),!o&&i>0&&la[i-1].current?.focus();const c=f.join("");c.length===4&&/^\d{4}$/.test(c)?(async()=>{try{const m=await ae.get("/contacts/search",{params:{query:c}});da(m.data.results?.[0]??null)}catch{da(null)}})():da(null)}async function cu(){Ks(!0);try{const i=await ae.get("/status/me");Fd(i.data.user?.eblid??"")}catch{}}async function lu(){const i=ca.join("");if(/^\d{4}$/.test(i)){ua(!0);try{await ae.post("/contacts/add",{identifier:i}),ua(!1)}catch{ua(!1)}}}function Di(){if(!t||!tt.data||!P?.id)return;const i=tt.data.filter(o=>o.senderId!==P.id).filter(o=>!(o.receipts||[]).some(f=>f.userId===P.id&&(f.status==="READ"||f.status==="SEEN"))).map(o=>o.id);i.length!==0&&ae.post("/messages/receipts",{messageIds:i,status:"READ"}).then(()=>{ne.invalidateQueries({queryKey:["messages",t]})}).catch(()=>{})}d.useEffect(()=>{document.hasFocus()&&Di(),t&&(ae.post("/messages/mark-conversation-read",{conversationId:t}).catch(()=>{}),ne.setQueryData(["conversations"],i=>i&&i.map(o=>o.conversation.id===t?{...o,unreadCount:0}:o)))},[t]),d.useEffect(()=>{document.hasFocus()&&Di()},[tt.data]),d.useEffect(()=>{const i=()=>Di(),o=()=>{document.visibilityState==="visible"&&Di()};return window.addEventListener("focus",i),document.addEventListener("visibilitychange",o),()=>{window.removeEventListener("focus",i),document.removeEventListener("visibilitychange",o)}},[t,tt.data]);function du(){$n.current||($n.current=window.setTimeout(()=>{const i=Array.from(Vt.current);Vt.current.clear(),$n.current&&clearTimeout($n.current),$n.current=null,i.length&&ae.post("/messages/receipts",{messageIds:i,status:"READ"}).then(()=>{t&&ne.invalidateQueries({queryKey:["messages",t]})}).catch(()=>{})},250))}d.useEffect(()=>{if(!t||!tt.data||!P?.id)return;Pt.current?.disconnect();const i=new IntersectionObserver(o=>{for(const f of o){if(!f.isIntersecting||f.intersectionRatio<.6||!(document.hasFocus()||document.visibilityState==="visible"))continue;const c=f.target,m=c.dataset.mid;if(!m)continue;const h=tt.data.find(b=>b.id===m);!h||h.senderId===P.id||(h.receipts||[]).some(b=>b.userId===P.id&&(b.status==="READ"||b.status==="SEEN"))||(Vt.current.add(m),i.unobserve(c))}Vt.current.size&&du()},{root:ge.current,threshold:[.25]});Pt.current=i;for(const o of tt.data){if(o.senderId===P.id||(o.receipts||[]).some(m=>m.userId===P.id&&(m.status==="READ"||m.status==="SEEN")))continue;const c=zt.current.get(o.id);c&&i.observe(c)}return()=>{i.disconnect()}},[t,tt.data,P?.id]),d.useEffect(()=>{const i=()=>{if(!ge.current)return;const o=ge.current.clientWidth;pn(o>=900)};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[t]);async function Ra(i,o="",f){if(!t||i.length===0)return;const c=!!A?.isSecret;if(c){if(Mi){alert("Секретный чат больше не активен, отправка вложений отключена.");return}if(!Kr){alert("Секретный чат ещё не готов к вложениям, подождите установления защищённой сессии.");return}}di(!0),Pr(0);try{const m=`tmp-${Date.now()}-${Math.random().toString(36).slice(2)}`,h=[],g=i.reduce((R,I)=>R+I.size,0);for(const R of i)if(R.type.startsWith("image/")){const I=URL.createObjectURL(R),{width:E,height:D}=await uu(I);h.push({url:I,type:"IMAGE",width:E,height:D,progress:0,__pending:!0})}else h.push({url:R.name,type:"FILE",__pending:!0,progress:0});xs(R=>({...R,[t]:[...R[t]||[],{id:m,createdAt:Date.now(),senderId:P?.id||"me",attachments:h,content:o}]}));const b=[];let v=0;for(let R=0;R<i.length;R++){const I=i[R],E=h[R];let D=I,T;if(c&&A){const xe=new Uint8Array(await I.arrayBuffer()),we=await Ln.encryptBinary(A,xe);D=new Blob([we.cipher],{type:"application/octet-stream"}),T={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:we.nonce,originalName:I.name,originalType:I.type,originalSize:I.size}}const $=new FormData;$.append("file",D,c?`${I.name||"file"}.enc`:I.name);const Z={url:await new Promise((xe,we)=>{const ke=new XMLHttpRequest;ke.open("POST","/api/upload");try{const $e=or.getState().session?.accessToken;$e&&ke.setRequestHeader("Authorization",`Bearer ${$e}`)}catch{}ke.upload.onprogress=$e=>{if($e.lengthComputable){const Ge=Math.round((v+$e.loaded)/g*100);Pr(Ge),xs(Dt=>{const $t=(Dt[t]||[]).map(me=>({...me,attachments:me.attachments.map(De=>({...De}))})),At=$t[$t.length-1];if(At){const me=At.attachments.findIndex(De=>De.__pending&&De.type===(I.type.startsWith("image/")?"IMAGE":"FILE")&&(!De.width||De.url.startsWith("blob:")));me>=0&&(At.attachments[me].progress=Ge)}return{...Dt,[t]:$t}})}},ke.onreadystatechange=()=>{if(ke.readyState===4)if(ke.status>=200&&ke.status<300)try{const $e=JSON.parse(ke.responseText);xe($e.url)}catch($e){we($e)}else we(new Error("upload failed"))},ke.send($)}),type:I.type.startsWith("image/")?"IMAGE":"FILE"},ye={};E&&E.type==="IMAGE"&&E.width&&E.height&&(ye.width=E.width,ye.height=E.height),T&&(ye.e2ee=T),Object.keys(ye).length>0&&(Z.metadata=ye),b.push(Z),v+=I.size,Pr(Math.round(v/g*100))}const k=b.every(R=>R.type==="IMAGE")?"IMAGE":"FILE";await ae.post("/conversations/send",{conversationId:t,type:k,content:o,attachments:b,replyToId:f}),xs(R=>{const E=(R[t]||[]).filter(D=>D.id!==m);if(E.length===0){const{[t]:D,...T}=R;return T}return{...R,[t]:E}}),ne.invalidateQueries({queryKey:["messages",t]})}catch(m){console.error("Failed to upload attachments",m)}di(!1)}async function uu(i){return new Promise(o=>{const f=new Image;f.onload=()=>o({width:f.naturalWidth,height:f.naturalHeight}),f.onerror=()=>o({width:320,height:200}),f.src=i})}const fu=async()=>{if(t&&!Bo)try{if(!(await wl({audio:!0})).ok){alert("Необходимо разрешение на использование микрофона для записи голосовых сообщений");return}on(),ka([]);const o=new Mp({onStateChange:f=>{wa(f==="recording"),f!=="recording"&&Yr.current&&(clearInterval(Yr.current),Yr.current=null)},onDurationUpdate:f=>{ba(f)},onAmplitudeUpdate:f=>{ka(c=>{const m=F?60:Yo,h=[...c,f];return h.length>m?h.slice(-m):h})},onError:f=>{console.error("Voice recording error:",f),alert("Ошибка записи голосового сообщения"),vc()}});Pn.current=o,await o.start()}catch(i){console.error("Failed to start voice recording:",i),alert("Не удалось начать запись голосового сообщения")}},vc=()=>{if(!Pn.current)return;const i=Pn.current,o=i.getDuration(),f=i.stop();Pn.current=null,wa(!1),ba(0),f&&t&&mu(f,o)},hu=()=>{Pn.current&&(Pn.current.cancel(),Pn.current=null),Yr.current&&(clearInterval(Yr.current),Yr.current=null),wa(!1),ba(0),ka([])},mu=async(i,o)=>{if(!t)return;const f=!!A?.isSecret;if(f){if(Mi){alert("Секретный чат больше не активен, отправка голосовых сообщений отключена.");return}if(!Kr){alert("Секретный чат ещё не готов к голосовым сообщениям, подождите установления защищённой сессии.");return}}di(!0),Pr(0);try{const c=new File([i],"voice-message.webm",{type:i.type||"audio/webm"});let m=c,h;if(f&&A){const k=new Uint8Array(await c.arrayBuffer()),R=await Ln.encryptBinary(A,k);m=new Blob([R.cipher],{type:"application/octet-stream"}),h={kind:"ciphertext",version:1,algorithm:"xsalsa20_poly1305",nonce:R.nonce,originalName:c.name,originalType:c.type,originalSize:c.size}}const g=new FormData;g.append("file",m,f?`${c.name}.enc`:c.name);const v={url:await new Promise((k,R)=>{const I=new XMLHttpRequest;I.open("POST","/api/upload");try{const E=or.getState().session?.accessToken;E&&I.setRequestHeader("Authorization",`Bearer ${E}`)}catch{}I.upload.onprogress=E=>{if(E.lengthComputable){const D=Math.round(E.loaded/E.total*100);Pr(D)}},I.onreadystatechange=()=>{if(I.readyState===4)if(I.status>=200&&I.status<300)try{const E=JSON.parse(I.responseText);k(E.url)}catch(E){R(E)}else R(new Error("upload failed"))},I.send(g)}),type:"AUDIO",size:c.size,...h?{metadata:{e2ee:h}}:{}};await ae.post("/conversations/send",{conversationId:t,type:"AUDIO",metadata:{duration:o},attachments:[v],replyToId:H?.id}),W(null),ne.invalidateQueries({queryKey:["messages",t]})}catch(c){console.error("Failed to send voice message",c),alert("Не удалось отправить голосовое сообщение")}finally{di(!1),Pr(0)}};d.useEffect(()=>()=>{Pn.current&&Pn.current.cleanup()},[]),d.useEffect(()=>{let i=null;const o=async()=>{const f=performance.now();try{await fetch("https://eblusha.org/",{mode:"no-cors"}),Xo(Math.round(performance.now()-f))}catch{Xo(null)}};return o(),i=window.setInterval(o,15e3),()=>{i&&clearInterval(i)}},[]),d.useEffect(()=>{let i=null;const o=()=>ne.invalidateQueries({queryKey:["conversations"]});return i=window.setInterval(o,2e4),()=>{i&&clearInterval(i)}},[ne]);const pu=d.useMemo(()=>{const i=new Set;try{const o=pe.data||[],f=new Map;for(const c of o){const m=c?.conversation;m?.id&&f.set(m.id,m)}for(const[c,m]of Object.entries(Bn||{})){if(!m?.active)continue;const h=f.get(c);if(!!!(h&&(h.isGroup||(h.participants?.length??0)>2)))continue;const b=m.participants||[];for(const v of b)i.add(v)}}catch{}return i},[Bn,pe.data]);function Da(i){const o=i?.id?Mr(i):i?.status??"OFFLINE",f=i.lastSeenAt?new Date(i.lastSeenAt):null;if(o==="ONLINE")return"ОНЛАЙН";if(o==="BACKGROUND")return"В ФОНЕ";if(o==="IN_CALL"){const R=typeof i?.id=="string"?i.id:null;return R&&pu.has(R)?"В БЕСЕДЕ":"В ЗВОНКЕ"}if(!f)return"оффлайн";const m=new Date().getTime()-f.getTime(),h=Math.floor(m/6e4);if(h<1)return"был(а) онлайн только что";if(h<60)return`был(а) онлайн ${h} мин назад`;const g=Math.floor(h/60);if(g<24)return`был(а) онлайн ${g} ч назад`;const b={hour:"2-digit",minute:"2-digit"},v=f.toLocaleDateString(),k=f.toLocaleTimeString([],b);return`был(а) онлайн ${v} в ${k}`}function Aa(i){const o=Math.max(0,Math.floor(i/1e3)),f=Math.floor(o/3600),c=Math.floor(o%3600/60),m=o%60;return f>0?`${f}:${String(c).padStart(2,"0")}:${String(m).padStart(2,"0")}`:`${c}:${String(m).padStart(2,"0")}`}function wc(i){const o=i?"conversations-list slider-panel":"conversations-list";return r.jsxs("aside",{className:o,children:[r.jsx("header",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsxs("div",{style:{display:"inline-flex",flexDirection:"column",alignItems:"center"},children:[r.jsxs("div",{className:"logo",children:[r.jsx("span",{children:"Е"}),r.jsx("span",{className:"b",children:"Б"}),r.jsx("span",{children:"луша"})]}),r.jsx("div",{className:"subtitle",children:"Здесь мы общаемся"})]})}),r.jsxs("div",{style:{position:"relative",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[r.jsx("div",{ref:it,className:"conversations-scroll-container",style:{display:"flex",flexDirection:"column",gap:8,flex:1,overflow:"auto",paddingTop:"10px"},children:pe.data?.slice().sort((f,c)=>{const m=f.conversation.messages?.[0]?.createdAt?new Date(f.conversation.messages[0].createdAt).getTime():0;return(c.conversation.messages?.[0]?.createdAt?new Date(c.conversation.messages[0].createdAt).getTime():0)-m}).filter(f=>{const c=f.conversation;return!(c.isSecret&&(c.secretStatus??"ACTIVE")!=="ACTIVE")}).map(f=>{const c=f.conversation,m=c.participants.filter(D=>Wt?D.user.id!==Wt:!0).map(D=>D.user),h=m.map(D=>D.displayName??D.username).join(", ")||"Диалог",g=c.title??h,b=c.isGroup||c.participants.length>2,v=!!c.isSecret;m.map(D=>D.displayName??D.username).join(", ");const k=t===c.id,I=!!Bn[c.id]?.active,E=n===c.id;return r.jsxs("div",{onContextMenu:D=>{D.preventDefault(),D.stopPropagation(),!i&&Y({open:!0,x:D.clientX,y:D.clientY,conversationId:c.id})},onClick:()=>Gr(c.id),className:"tile",style:{...f.unreadCount>0?{borderColor:"var(--brand-600)",boxShadow:"0 3px 10px rgba(227,139,10,0.15)"}:{},...k?{borderColor:"var(--brand-600)",boxShadow:"0 4px 12px rgba(227,139,10,0.14)"}:{},...I?{background:E?"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)":"linear-gradient(135deg, rgba(217, 119, 6, 0.10) 0%, rgba(227, 139, 10, 0.12) 100%)",borderColor:"var(--brand-600)",...E?k?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.22), 0 6px 16px rgba(227,139,10,0.14)"}:k?{}:{boxShadow:"0 0 0 1px rgba(227,139,10,0.16)"}}:{}},children:[b?r.jsx(vt,{name:g?.trim()?.charAt(0)||"Г",id:c.id,avatarUrl:c.avatarUrl&&c.avatarUrl.trim()?c.avatarUrl:void 0,presence:I?"IN_CALL":void 0}):r.jsx(vt,{name:m[0]?.displayName??m[0]?.username??"D",id:m[0]?.id??c.id,presence:I?"IN_CALL":Mr(m[0]),avatarUrl:m[0]?.avatarUrl&&m[0].avatarUrl.trim()?m[0].avatarUrl:void 0}),r.jsxs("div",{style:{flex:1,minWidth:0},children:[r.jsxs("div",{style:{fontWeight:600,display:"flex",alignItems:"center",gap:6},children:[r.jsx("span",{children:g}),!b&&v&&r.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:18,height:18,borderRadius:999,background:"rgba(34,197,94,0.12)"},children:r.jsx(Lc,{size:12,color:"#22c55e"})})]}),r.jsx("div",{style:{fontSize:12,color:f.unreadCount>0?"var(--brand-600)":"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:f.unreadCount>0?`${f.unreadCount} непрочитанных`:(()=>{const D=Bn[c.id];if(D?.active){const T=D.startedAt?Date.now()-D.startedAt:typeof D.elapsedMs=="number"?D.elapsedMs:0;return r.jsx("span",{children:Aa(T)})}else if(D&&D.endedAt){const T=D.endedAt,K=Date.now()-T,Z=Math.floor(K/6e4);if(Z<1)return r.jsx("span",{children:"Завершен только что"});if(Z<60)return r.jsxs("span",{children:["Завершен ",Z," мин назад"]});const ye=Math.floor(Z/60);if(ye<24)return r.jsxs("span",{children:["Завершен ",ye," ч назад"]});const xe=new Date(T),we=xe.toLocaleDateString(),ke=xe.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return r.jsxs("span",{children:["Завершен ",we," в ",ke]})}return b?null:Da(m[0]??{})})()})]}),i&&r.jsx("button",{type:"button","aria-label":"Меню беседы",title:"Меню",onClick:D=>{D.preventDefault(),D.stopPropagation();const T=D.currentTarget.getBoundingClientRect();Y({open:!0,x:Math.round(T.right-8),y:Math.round(T.bottom+6),conversationId:c.id})},style:{flexShrink:0,width:36,height:36,borderRadius:10,border:"1px solid transparent",background:"transparent",color:"var(--text-muted)",display:"inline-flex",alignItems:"center",justifyContent:"center",marginLeft:8,WebkitTapHighlightColor:"transparent"},children:r.jsx(ts,{size:20})})]},c.id)})}),en&&r.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),kt&&r.jsx("div",{style:{position:"absolute",bottom:0,left:0,right:0,height:"24px",background:"linear-gradient(to top, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}})]}),r.jsxs("div",{className:"conv-footer",children:[r.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:8,marginBottom:8}}),r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[r.jsxs("div",{style:{display:"flex",gap:12},children:[r.jsxs("div",{onClick:()=>Xs(!0),className:"tile",style:{marginTop:0,flex:1},children:[r.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#10b981",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(ff,{size:22})}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:"Беседа"}),r.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Групповой чат"})]})]}),r.jsxs("div",{onClick:cu,className:"tile",style:{marginTop:0,flex:1},children:[r.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"#6366f1",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center"},children:sn.data&&sn.data.length>0?r.jsx(ef,{size:22}):Ft.data&&Ft.data.length>0?r.jsx(Xf,{size:22}):r.jsx(Hc,{size:22})}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:"Контакты"}),r.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:sn.data&&sn.data.length>0?"Новый запрос в друзья":Ft.data&&Ft.data.length>0?"Список контактов":"Добавить контакт"})]})]})]}),r.jsxs("div",{className:"tile",onClick:()=>Qs(!0),style:{cursor:"pointer",marginTop:0},children:[(()=>{const c=(()=>{const I=P?.id;if(u?.conversationId||n||a||se.activeConvId)return!0;if(I)try{for(const E of Object.values(Bn||{}))if(E?.active&&Array.isArray(E.participants)&&E.participants.includes(I))return!0}catch{}return!1})()?"IN_CALL":_d??yn.data?.status,m=Yd?"ONLINE":"OFFLINE",h=(c??m??"OFFLINE").toString().toUpperCase(),g=["ONLINE","AWAY","BACKGROUND","IN_CALL","OFFLINE"],b=h,v=m,k=g.includes(b)?b:v,R=yn.data?.avatarUrl??P?.avatarUrl??void 0;return r.jsx(vt,{name:P?.displayName??P?.username??"Me",id:P?.id??"me",presence:k,avatarUrl:R})})(),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:700},children:P?.displayName??P?.username??"Я"}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",yn.data?.eblid??"— — — —"]})]})]})]})]})]})}function bc(i){const o=i?"messages-pane slider-panel":"messages-pane",f=Mi,c=Kr;let m="";return A?.isSecret&&(f?m="Секретный чат станет доступен после подтверждения собеседника.":nu?m=dc?`Секретный чат подключён на устройстве «${dc}»`:"Секретный чат подключён на другом устройстве.":c||(m="Готовим защищённое подключение...")),r.jsxs("section",{className:o,children:[r.jsxs("header",{style:{...t?Bn[t]?.active||a===t?{background:"linear-gradient(135deg, rgba(217, 119, 6, 0.15) 0%, rgba(227, 139, 10, 0.2) 100%)",borderBottom:"2px solid var(--brand)"}:{}:{},display:"flex",flexDirection:F?"column":"row",justifyContent:F?"flex-start":"space-between",alignItems:F?"stretch":"center",flexShrink:0},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,width:F?"100%":"auto",padding:F?"0 8px":"0"},children:[i&&r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:tu,children:r.jsx(Qu,{size:18})}),A?(()=>{const h=A.participants.filter(I=>Wt?I.user.id!==Wt:!0).map(I=>I.user),g=h.map(I=>I.displayName??I.username).join(", ")||"Диалог",b=A.title??g,v=A.isGroup||A.participants.length>2;A.isSecret;const k=Bn[A.id],R=k?.active;return v?r.jsxs(r.Fragment,{children:[r.jsx("div",{onClick:()=>ot(!0),style:{cursor:"pointer"},children:r.jsx(vt,{name:b?.trim()?.charAt(0)||"Г",id:A.id,size:60,avatarUrl:A.avatarUrl&&A.avatarUrl.trim()?A.avatarUrl:void 0,presence:R?"IN_CALL":void 0})}),r.jsxs("div",{style:{flex:1,minWidth:0,order:F?1:2},children:[r.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:8,justifyContent:"space-between"},children:[r.jsx("span",{children:b}),F&&r.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:I=>{oe({open:!0,anchor:I.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:r.jsx(ts,{size:20})})]}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"},children:R?r.jsx(r.Fragment,{children:(()=>{const I=k.participants||[],E=A.participants||[],D=k.startedAt?Date.now()-k.startedAt:typeof k.elapsedMs=="number"?k.elapsedMs:0;return r.jsxs(r.Fragment,{children:[k.active&&r.jsx("span",{children:Aa(D)}),E.length>0&&r.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[k.startedAt&&" • ",E.map((T,$)=>{const K=T.user,Z=I.length>0&&I.includes(K.id);return r.jsxs("span",{style:{fontWeight:Z?700:400,color:Z?"var(--brand-600)":"var(--text-muted)"},children:[$>0&&", ",K.displayName??K.username,Z&&" ✓"]},K.id)})]})]})})()}):k&&k.endedAt?(()=>{const I=k.endedAt,D=Date.now()-I,T=Math.floor(D/6e4);let $="";if(T<1)$="Завершен только что";else if(T<60)$=`Завершен ${T} мин назад`;else{const Z=Math.floor(T/60);if(Z<24)$=`Завершен ${Z} ч назад`;else{const ye=new Date(I),xe=ye.toLocaleDateString(),we=ye.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});$=`Завершен ${xe} в ${we}`}}const K=A.participants||[];return r.jsxs(r.Fragment,{children:[r.jsx("span",{children:$}),K.length>0&&r.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[" • ",K.map((Z,ye)=>{const xe=Z.user;return r.jsxs("span",{children:[ye>0&&", ",xe.displayName??xe.username]},xe.id)})]})]})})():h.map(I=>I.displayName??I.username).join(", ")})]})]}):(()=>{const I=h[0];return r.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[r.jsx("div",{style:{marginRight:10},children:r.jsx(vt,{name:I?.displayName??I?.username??"D",id:I?.id??A.id,avatarUrl:I?.avatarUrl&&I.avatarUrl.trim()?I.avatarUrl:void 0,presence:k?.active?"IN_CALL":Mr(I),size:60})}),r.jsxs("div",{style:{flex:1,minWidth:0},children:[r.jsxs("div",{style:{fontWeight:700,display:"flex",alignItems:"center",gap:6,justifyContent:"space-between"},children:[r.jsx("span",{children:b}),F&&r.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:E=>{oe({open:!0,anchor:E.currentTarget})},style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:42,height:42,minWidth:42,padding:0,margin:0,borderRadius:999,flexShrink:0},children:r.jsx(ts,{size:20})})]}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",display:"flex",alignItems:"center",gap:6},children:(()=>{const E=a===t;if((k?.active||E)&&k){const D=k.startedAt?Date.now()-k.startedAt:typeof k.elapsedMs=="number"?k.elapsedMs:0;return r.jsx("span",{children:Aa(D)})}if(k&&k.endedAt&&!E){const D=k.endedAt,$=Date.now()-D,K=Math.floor($/6e4);if(K<1)return r.jsx("span",{children:"Завершен только что"});if(K<60)return r.jsxs("span",{children:["Завершен ",K," мин назад"]});const Z=Math.floor(K/60);if(Z<24)return r.jsxs("span",{children:["Завершен ",Z," ч назад"]});const ye=new Date(D),xe=ye.toLocaleDateString(),we=ye.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return r.jsxs("span",{children:["Завершен ",xe," в ",we]})}return I?Da(I):""})()})]})]})})()})():r.jsx("div",{children:"Выберите чат"})]}),Gd&&A&&!!A.isSecret&&(A.participants?.length??0)<=2&&typeof document<"u"&&Ur.createPortal(r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.6)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",padding:F?"0 16px":0,boxSizing:"border-box",zIndex:80},onClick:()=>Cs(!1),children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:F?16:20,borderRadius:F?20:16,width:"100%",maxWidth:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)",textAlign:F?"center":"left"},onClick:h=>h.stopPropagation(),children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexDirection:F?"column":"row",gap:F?8:0},children:[r.jsx("div",{style:{fontWeight:700,fontSize:18,width:"100%"},children:"Завершить секретный чат?"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Cs(!1),style:{alignSelf:F?"flex-end":void 0},children:r.jsx(Zt,{size:18})})]}),r.jsx("div",{style:{fontSize:14,color:"var(--text-muted)",marginBottom:16,lineHeight:1.5},children:"Сообщения этого секретного чата будут удалены у всех участников. Это действие необратимо."}),r.jsxs("div",{style:{display:"flex",justifyContent:F?"center":"flex-end",alignItems:"center",flexDirection:F?"column":"row",gap:F?12:8},children:[r.jsx("button",{className:"btn btn-ghost",onClick:()=>Cs(!1),style:F?{width:"100%"}:void 0,children:"Отменить"}),r.jsx("button",{className:"btn btn-primary",style:{background:"#ef4444",borderColor:"#ef4444",width:F?"100%":void 0},onClick:async()=>{if(t)try{await ae.delete(`/conversations/${t}`),ne.invalidateQueries({queryKey:["conversations"]}),ne.removeQueries({queryKey:["messages",t]}),Cs(!1),e(null)}catch(h){console.error("Failed to end secret conversation:",h)}},children:"Завершить"})]})]})}),document.body),t&&(()=>{const h=Bn[t],g=h?.active,b=A?.isGroup||(A?.participants.length??0)>2,k=(A?.participants?.filter(me=>Wt?me.user.id!==Wt:!0).map(me=>me.user)??[])[0],R=Ka(),I=k?.timezone??k?.timeZone??R,E=k?.displayName??k?.username??"Собеседник",D=!b&&!!k?.id,T=()=>{!A||!k?.id||et({conversationId:A.id,peerId:k.id,peerName:E,peerTimeZone:I})},$=a===t,K=n===t&&!$,Z=P?.id,ye=b&&g&&Z&&h?.participants?.includes(Z),xe=!b&&($||n===t||se.activeConvId===t||g&&(se.activeConvId===t||n===t)),we=ye||xe,ke={display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:F?"8px 12px":"12px 16px",flex:F?1:"auto",minWidth:F?0:"auto",fontSize:F?"14px":"15px",fontWeight:F?500:600,height:F?"42px":"46px",minHeight:F?"42px":"46px",boxSizing:"border-box"},$e={display:"flex",alignItems:"center",gap:8,width:F?"100%":"auto",padding:F?"0 8px":"0",justifyContent:F?"center":"flex-end",marginLeft:F?0:"auto"},Ge={display:"inline-flex",alignItems:"center",justifyContent:"center",width:F?42:44,height:F?42:44,minWidth:F?42:44,padding:0,margin:0,borderRadius:999},Dt=async()=>{if(t&&await Si(!1))try{ki(t),Ac(t,!1),se.startOutgoing(t,!1),qt(fe=>{const je=fe[t],ve=P?.id;return je?.active?ve&&je.participants&&!je.participants.includes(ve)?{...fe,[t]:{...je,participants:[...je.participants,ve]}}:fe:{...fe,[t]:{startedAt:Date.now(),active:!0,participants:ve?[ve]:[]}}});const me=pe.data?.find(fe=>fe.conversation.id===t)?.conversation;if(me?.isGroup||(me?.participants?.length??0)>2)s(t),l(fe=>fe===t?null:fe);else{const fe=t;p({conversationId:fe,startedAt:Date.now(),video:!1}),xc(),w.current&&window.clearTimeout(w.current),w.current=window.setTimeout(()=>{p(je=>je?.conversationId===fe?(Er(),Ri(),Ds(fe),qt(ve=>{const Gt=ve[fe];if(Gt?.active)return{...ve,[fe]:{...Gt,active:!1,endedAt:Date.now()}};const{[fe]:Es,...Ts}=ve;return Ts}),se.endCall(),null):je),w.current=null},3e4)}}catch(me){console.error("Error starting call:",me)}},cn=async()=>{if(t&&await Si(!0))try{ki(t),Ac(t,!0),se.startOutgoing(t,!0),qt(fe=>{const je=fe[t],ve=P?.id;return je?.active?ve&&je.participants&&!je.participants.includes(ve)?{...fe,[t]:{...je,participants:[...je.participants,ve]}}:fe:{...fe,[t]:{startedAt:Date.now(),active:!0,participants:ve?[ve]:[]}}});const me=pe.data?.find(fe=>fe.conversation.id===t)?.conversation;if(me?.isGroup||(me?.participants?.length??0)>2)s(t),l(fe=>fe===t?null:fe);else{const fe=t;p({conversationId:fe,startedAt:Date.now(),video:!0}),xc(),w.current&&window.clearTimeout(w.current),w.current=window.setTimeout(()=>{p(je=>je?.conversationId===fe?(Er(),Ri(),Ds(fe),qt(ve=>{const Gt=ve[fe];if(Gt?.active)return{...ve,[fe]:{...Gt,active:!1,endedAt:Date.now()}};const{[fe]:Es,...Ts}=ve;return Ts}),se.endCall(),null):je),w.current=null},3e4)}}catch(me){console.error("Error starting call:",me)}},$t=()=>{t&&(s(t),l(null))},At=()=>g||$?we?r.jsxs(r.Fragment,{children:[!K&&r.jsxs("button",{className:"btn btn-secondary",onClick:$t,style:ke,children:[r.jsx(Uc,{size:F?16:18}),F?"Развернуть":" Развернуть"]}),r.jsxs("button",{className:"btn",onClick:()=>{const me=A?.participants?.length??0,De=me<=2,fe=A?.isGroup||me>2;if(De&&n)Ds(n),qt(je=>{const ve=je[n];return ve?.active?{...je,[n]:{...ve,active:!1,endedAt:Date.now()}}:je});else if(fe&&n){try{$u(n)}catch{}qt(je=>{const ve=je[n];if(!ve||!ve.participants)return je;const Gt=P?.id;return!Gt||!ve.participants.includes(Gt)?je:{...je,[n]:{...ve,participants:ve.participants.filter(Es=>Es!==Gt)}}})}s(null),l(null),se.endCall(),on()},style:{...ke,background:"#ef4444",color:"#fff"},children:[r.jsx(Wa,{size:F?16:18}),F?"Сбросить":" Сбросить"]}),D&&r.jsx(Ha,{onClick:T,style:Ge}),!F&&r.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:me=>{oe({open:!0,anchor:me.currentTarget})},style:Ge,children:r.jsx(ts,{size:22})})]}):r.jsxs(r.Fragment,{children:[r.jsxs("button",{className:"btn btn-secondary",onClick:()=>{if(A?.isGroup||(A?.participants?.length??0)>2){s(t),l(De=>De===t?null:De),se.startOutgoing(t,!1);try{Dc(t,!1)}catch{}}else s(t),l(De=>De===t?null:De),se.startOutgoing(t,!1)},style:ke,children:[r.jsx(Fa,{size:F?16:18}),F?"Подключиться":" Подключиться"]}),r.jsxs("button",{className:"btn btn-primary",onClick:()=>{if(A?.isGroup||(A?.participants?.length??0)>2){s(t),l(De=>De===t?null:De),se.startOutgoing(t,!0);try{Dc(t,!0)}catch{}}else s(t),l(De=>De===t?null:De),se.startOutgoing(t,!0)},style:ke,children:[r.jsx($a,{size:F?16:18}),F?"Подключиться с видео":" Подключиться с видео"]}),D&&r.jsx(Ha,{onClick:T,style:Ge}),!F&&r.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:me=>{oe({open:!0,anchor:me.currentTarget})},style:Ge,children:r.jsx(ts,{size:22})})]}):r.jsxs(r.Fragment,{children:[r.jsxs("button",{className:"btn btn-secondary",onClick:()=>{Dt()},style:ke,children:[r.jsx(Fa,{size:F?16:18}),F?" Начать звонок":" Звонок"]}),r.jsxs("button",{className:"btn btn-primary",onClick:()=>{cn()},style:ke,children:[r.jsx($a,{size:F?16:18}),F?" Начать с видео":" Видео"]}),D&&r.jsx(Ha,{onClick:T,style:Ge}),!F&&r.jsx("button",{className:"btn btn-icon btn-ghost",title:"Меню",onClick:me=>{oe({open:!0,anchor:me.currentTarget})},style:Ge,children:r.jsx(ts,{size:22})})]});return r.jsxs(r.Fragment,{children:[r.jsx("div",{style:$e,children:At()}),Br&&r.jsxs("div",{style:{marginTop:8,padding:"8px 12px",borderRadius:10,border:"1px solid var(--surface-border)",background:"rgba(239,68,68,0.08)",color:"#fca5a5",display:"flex",alignItems:"center",gap:8,fontSize:13,maxWidth:F?"100%":420,width:F?"100%":"auto"},children:[r.jsx("span",{style:{flex:1},children:Br}),r.jsx("button",{type:"button",onClick:()=>ys(null),style:{background:"transparent",border:"none",color:"inherit",cursor:"pointer",padding:4},children:r.jsx(Zt,{size:14})})]})]})})()]}),!A?.isSecret&&Qr&&r.jsx("div",{style:{margin:"12px 12px 0",padding:"12px 16px",borderRadius:12,border:"1px solid rgba(20,184,166,0.4)",background:"linear-gradient(135deg, rgba(13,148,136,0.15), rgba(6,95,70,0.25))",color:"#ccfbf1",display:"flex",flexDirection:F?"column":"row",gap:12,alignItems:F?"stretch":"center"},children:Qr.isInitiator?r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{flex:1},children:"Ждём подтверждения собеседника, чтобы начать секретный чат."}),r.jsx("div",{style:{display:"flex",gap:8},children:r.jsx("button",{className:"btn btn-ghost",onClick:()=>cc(Qr.conversationId),disabled:Ca,style:{color:"#f87171"},children:"Отменить"})})]}):r.jsxs(r.Fragment,{children:[r.jsxs("div",{style:{flex:1},children:[Qr.initiatorName," предлагает начать секретный чат на этом устройстве."]}),r.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[r.jsx("button",{className:"btn btn-secondary",onClick:()=>Kd(Qr.conversationId),disabled:Ca,children:"Принять"}),r.jsx("button",{className:"btn btn-ghost",onClick:()=>cc(Qr.conversationId),disabled:Ca,style:{color:"#bae6fd"},children:"Отказаться"})]})]})}),r.jsxs("div",{className:"messages-container",style:{display:"flex",flexDirection:"column",flex:1,minHeight:0,position:"relative"},children:[r.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,height:"24px",background:"linear-gradient(to bottom, var(--surface-200) 0%, rgba(35, 39, 49, 0) 100%)",pointerEvents:"none",zIndex:10}}),r.jsx("div",{ref:ge,style:{flex:1,minHeight:0,overflow:"auto",padding:16,display:"block"},children:t?A?.isSecret&&(!c||f)?r.jsx("div",{className:"messages-empty",children:m}):(()=>{const h=(an?[...an]:[]).filter(v=>!v.deletedAt).sort((v,k)=>new Date(v.createdAt||0).getTime()-new Date(k.createdAt||0).getTime()),g=vi,b=[...h||[],...g];return b?b.map((v,k)=>{if(v.deletedAt)return null;if(v.type==="SYSTEM")return r.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"12px 16px",marginTop:8},children:r.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",textAlign:"center",fontStyle:"italic",opacity:.8},children:v.content})},v.id);const R=b[k-1],I=b[k+1],E=!I||I.senderId!==v.senderId,D=!!R&&R.senderId===v.senderId,T=v.senderId===P?.id,Z=`${G?"msg left":T?"msg me":"msg them"} ${D?"compact":"gap"}`,ye=G?"msg-bubble left":T?"msg-bubble me":"msg-bubble them",xe=E?`${ye} ${T&&!G?"tail-right":"tail-left"}`:ye,we=hc[v.senderId],ke=we?.displayName??we?.username??(T?P?.displayName??P?.username??"Me":"User"),$e=we?.id??(T?P?.id??"me":"user"),Ge=T?"#303845":ru(v.senderId),Dt="#f1f3f6",cn=G&&E,$t=G,At=v.createdAt?new Date(v.createdAt):null,me=At?At.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",De=(A?.participants||[]).map(J=>J.user.id).filter(J=>Wt?J!==Wt:!0),fe=v.receipts||[],je=T&&De.some(J=>fe.some(Me=>Me.userId===J&&(Me.status==="READ"||Me.status==="SEEN"))),ve=T&&je?"✓":"",Gt=(J,Me)=>{mt({open:!0,x:J,y:Me,messageId:v.id})},Es=J=>{J.preventDefault(),Gt(J.clientX,J.clientY)},Ts=()=>{const J=v.replyTo?.id;if(!J)return;const Me=zt.current.get(J);Me&&Me.scrollIntoView({behavior:"smooth",block:"center"})},Sc=(v.attachments||[]).filter(J=>J?.type==="IMAGE").map(J=>Ei(J)).filter(J=>!!J),Cc=J=>{const Me=Sc.findIndex(jt=>jt===J);xa({open:!0,index:Me>=0?Me:0,items:Sc})},yu=F?{}:{onContextMenu:Es,...{onPointerDown:J=>{const Me=window.setTimeout(()=>Gt(J.clientX,J.clientY),450),jt=()=>{window.clearTimeout(Me),window.removeEventListener("pointerup",jt),window.removeEventListener("pointermove",tr)},tr=()=>{window.clearTimeout(Me),window.removeEventListener("pointerup",jt),window.removeEventListener("pointermove",tr)};window.addEventListener("pointerup",jt,{passive:!0}),window.addEventListener("pointermove",tr,{passive:!0})}}};return r.jsxs("div",{className:Z,...yu,children:[$t&&(cn?r.jsx(vt,{name:ke,id:$e,avatarUrl:(()=>{const J=hc[v.senderId]?.avatarUrl;return J&&J.trim()?J:void 0})()}):r.jsx("div",{className:"avatar-spacer"})),r.jsxs("div",{className:xe,"data-mid":v.id,ref:J=>{if(!J){zt.current.delete(v.id);return}zt.current.set(v.id,J),Pt.current?.observe(J)},style:{"--bubble-bg":Ge,"--bubble-fg":Dt},onClick:J=>{if(!F||J.target.closest("a, button, input, textarea, img, video, .reaction-emoji"))return;const jt=typeof window.getSelection=="function"?window.getSelection():null;jt&&jt.toString()||Gt(J.clientX,J.clientY)},onContextMenu:J=>{if(J.target.closest(".reaction-emoji")){J.preventDefault(),J.stopPropagation();return}Gt(J.clientX,J.clientY)},children:[v.reactions&&v.reactions.length>0&&(()=>{const J={};for(const Me of v.reactions)J[Me.emoji]||(J[Me.emoji]={count:0,hasMine:!1}),J[Me.emoji].count++,Me.userId===P?.id&&(J[Me.emoji].hasMine=!0);return r.jsx("div",{style:{position:"absolute",bottom:-18,right:T?8:void 0,left:T?void 0:8,display:"flex",gap:6,background:"var(--surface-200)",border:"1px solid var(--surface-border)",borderRadius:12,padding:"2px 6px",zIndex:5,pointerEvents:"auto"},children:Object.entries(J).map(([Me,jt],tr)=>{const Nn=Me==="❤️"?"#ef4444":"#ffc46b";return r.jsxs("button",{type:"button",className:"reaction-emoji",onClick:async Tr=>{Tr.preventDefault(),Tr.stopPropagation();try{jt.hasMine?await ae.post("/messages/unreact",{messageId:v.id,emoji:Me}):await ae.post("/messages/react",{messageId:v.id,emoji:Me}),t&&ne.invalidateQueries({queryKey:["messages",t]})}catch(Oa){console.error("Error toggling reaction:",Oa)}},onMouseDown:Tr=>{Tr.stopPropagation()},style:{fontSize:12,color:Nn,display:"inline-block",animation:`reactionBounce 0.6s ease ${tr*.1}s`,cursor:"pointer",opacity:jt.hasMine?1:.8,background:"transparent",border:"none",padding:0,margin:0,font:"inherit"},children:[Me,jt.count>1?` ${jt.count}`:""]},Me)})})})(),v.replyTo&&r.jsxs("div",{onClick:Ts,style:{cursor:"pointer",fontSize:12,padding:"6px 8px",borderRadius:8,marginBottom:6,background:T?"#303845":"#191d23",color:"#f1f3f6",borderLeft:"3px solid #ff9e1a"},children:["Ответ на: ",v.replyTo.content??"сообщение"]}),r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{wordBreak:"break-word",overflowWrap:"break-word"},children:v.content}),(()=>{const J=v.attachments||[],Me=J.filter(gt=>gt?.type==="IMAGE"),jt=typeof v.content=="string"?v.content.trim().length>0:!!v.content,tr=J.some(gt=>gt?.type&&gt.type!=="IMAGE"),Ai=Me.length>0&&!jt&&!tr,Nn=[];let Tr=!1;J.forEach((gt,Ue)=>{if(gt?.type==="IMAGE"){Tr||(Nn.push({kind:"imageGroup",atts:Me}),Tr=!0);return}Nn.push({kind:"single",att:gt,idx:Ue})});const Oa=gt=>{if(!gt.length)return null;if(gt.length===1){const ce=gt[0],xt=0,It=ce.metadata??{},lt=Ei(ce),dt=!!(A?.isSecret&&It?.e2ee?.kind==="ciphertext"),Mt=dt?Cr[ce.url]:void 0,Xt=dt&&!lt&&(!Mt||Mt.status==="pending"),Qt=dt&&Mt?.status==="error",Nr=typeof window<"u"?window.innerWidth:1280,rr=Nr<=768?Math.max(320,Math.floor(Nr/2)):Math.min(600,Math.max(320,Math.floor(Nr/3))),Oi=`${ce.url||xt}`,Ns=ec[Oi],sr=Ns?.width||ce.width||ce.metadata?.width||rr,Jr=Ns?.height||ce.height||ce.metadata?.height||Math.round(sr*.75),Rn=Jr/sr||.75,Vn=rr;let dn=rr;Rn<.5?dn=Math.max(Math.round(rr*.6),200):Rn<.7&&(dn=Math.max(Math.round(rr*.75),200));const xu=sr>Vn?Vn/sr:1,vu=Jr>dn?dn/Jr:1,jc=Math.min(xu,vu,1);let ir=sr*jc,Dn=Jr*jc;ir>Vn&&(ir=Vn,Dn=ir*Rn),Dn>dn&&(Dn=dn,ir=Dn/Rn),ir=Math.round(ir),Dn=Math.round(Dn);const Rr=`${ce.url||xt}`,La=!!Qo[Rr],Ic=!!Jo[Rr],Li=ce.__pending||Xt||!La&&!Ic;return r.jsxs("div",{style:{maxWidth:"100%",maxHeight:Dn,width:Li?Math.min(ir,typeof window<"u"?window.innerWidth-100:ir):"fit-content",height:Li?Dn:"auto",minWidth:0,minHeight:Li?Dn:0,marginTop:8,position:"relative",borderRadius:10,overflow:"hidden",display:"inline-block",lineHeight:0,boxSizing:"border-box"},children:[Ai&&r.jsxs("div",{className:"msg-media-meta",children:[r.jsx("span",{children:me}),!!ve&&r.jsx("span",{children:ve})]}),Li&&r.jsxs("div",{style:{position:"absolute",inset:0,width:"100%",height:"100%",borderRadius:10,background:"var(--surface-100)",border:"1px solid var(--surface-border)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1},children:[r.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.1) 37%, transparent 63%)",backgroundSize:"400% 100%",animation:"eb-shimmer 1.2s ease-in-out infinite"}}),Xt?r.jsx("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8,color:"var(--text-muted)",fontSize:12},children:"Расшифровка изображения..."}):typeof ce.progress=="number"&&ce.progress<100?r.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[r.jsx("div",{style:{width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ce.progress,"%"]})]}):r.jsx("div",{style:{position:"relative",zIndex:2,width:40,height:40,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),Qt&&r.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось расшифровать изображение"}),Ic&&!Qt&&r.jsx("div",{style:{marginTop:8,color:"#f87171",fontSize:12},children:"Не удалось загрузить изображение"}),lt&&!Qt&&r.jsx("img",{src:lt,alt:"img",style:{maxWidth:"100%",maxHeight:Dn,width:"auto",height:"auto",objectFit:"contain",borderRadius:10,cursor:v.id?.startsWith("tmp-")?"default":"zoom-in",opacity:ce.__pending?.85:1,display:La?"block":"none",position:"relative",zIndex:0,background:"var(--surface-100)",verticalAlign:"top"},onLoad:Rs=>{const Ui=Rs.target;if(!ce.width&&!It?.width&&Ui.naturalWidth&&Ui.naturalHeight&&tc(ar=>({...ar,[Rr]:{width:Ui.naturalWidth,height:Ui.naturalHeight}})),yi(ar=>({...ar,[Rr]:!1})),gi(ar=>({...ar,[Rr]:!0})),ge.current&&ht.current){const ar=ge.current;ar.scrollTop=ar.scrollHeight}},onError:()=>{yi(Rs=>({...Rs,[Rr]:!0})),gi(Rs=>({...Rs,[Rr]:!0}))},onClick:()=>{!ce.__pending&&!Xt&&lt&&Cc(lt)}}),La&&!Xt&&typeof ce.progress=="number"&&ce.progress<100&&r.jsx("div",{style:{position:"absolute",left:0,right:0,bottom:0,height:6,background:"rgba(0,0,0,0.15)",borderRadius:"0 0 10px 10px",overflow:"hidden",zIndex:3},children:r.jsx("div",{style:{width:`${ce.progress}%`,height:"100%",background:"rgba(255,255,255,0.9)"}})})]},`images-single-${ce.url||xt}`)}const Ue=gt.slice(0,4),yt=gt.length-Ue.length,Kt=(ce,xt)=>{const It=ce?.metadata??{},lt=`${ce?.url||xt}`,dt=ec[lt],Mt=dt?.width||ce?.width||It?.width,Xt=dt?.height||ce?.height||It?.height,Qt=typeof Mt=="number"&&typeof Xt=="number"&&Mt>0&&Xt>0?Xt/Mt:1;return Math.max(.2,Math.min(5,Number.isFinite(Qt)?Qt:1))},ln=(ce,xt,It)=>{const lt=ce.metadata??{},dt=Ei(ce),Mt=!!(A?.isSecret&&lt?.e2ee?.kind==="ciphertext"),Xt=Mt?Cr[ce.url]:void 0,Qt=Mt&&!dt&&(!Xt||Xt.status==="pending"),Nr=Mt&&Xt?.status==="error",nr=`${ce.url||xt}`,rr=!!Qo[nr],Oi=!!Jo[nr],Ns=ce.__pending||Qt||!rr&&!Oi,sr=ce.__pending||Qt||Nr||!dt,Jr=Kt(ce,xt);return r.jsxs("button",{type:"button",className:"msg-media-tile",style:{aspectRatio:1/Jr},disabled:sr,onClick:()=>{!sr&&dt&&Cc(dt)},children:[dt&&r.jsx("img",{src:dt,alt:"img",style:{opacity:rr&&!Ns?1:.001},onLoad:Rn=>{const Vn=Rn.target;!ce.width&&!lt?.width&&Vn.naturalWidth&&Vn.naturalHeight&&tc(dn=>({...dn,[nr]:{width:Vn.naturalWidth,height:Vn.naturalHeight}})),yi(dn=>({...dn,[nr]:!1})),gi(dn=>({...dn,[nr]:!0}))},onError:()=>{yi(Rn=>({...Rn,[nr]:!0})),gi(Rn=>({...Rn,[nr]:!0}))}}),Ns&&r.jsxs("div",{className:"msg-media-overlay",children:[r.jsx("div",{className:"msg-media-overlay-shimmer"}),Qt?r.jsx("div",{style:{position:"relative",zIndex:2,color:"var(--text-muted)",fontSize:12},children:"Расшифровка..."}):typeof ce.progress=="number"&&ce.progress<100?r.jsxs("div",{style:{position:"relative",zIndex:2,display:"flex",flexDirection:"column",alignItems:"center",gap:8},children:[r.jsx("div",{style:{width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",fontWeight:500},children:[ce.progress,"%"]})]}):r.jsx("div",{style:{position:"relative",zIndex:2,width:34,height:34,border:"3px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}})]}),(Nr||Oi)&&r.jsx("div",{className:"msg-media-overlay",style:{background:"rgba(15, 23, 42, 0.55)"},children:r.jsx("div",{style:{position:"relative",zIndex:2,color:"#f87171",fontSize:12,padding:10,textAlign:"center"},children:Nr?"Ошибка расшифровки":"Ошибка загрузки"})}),It&&r.jsxs("div",{className:"msg-media-more",children:["+",yt]})]},`${ce.url||xt}`)};return r.jsxs("div",{className:"msg-media-grid",children:[Ai&&r.jsxs("div",{className:"msg-media-meta",children:[r.jsx("span",{children:me}),!!ve&&r.jsx("span",{children:ve})]}),Ue.length===2&&(()=>{const ce=Kt(Ue[0],0),It=Kt(Ue[1],1),lt=ce;return r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{flex:`${It} 1 0`,minWidth:0},children:ln(Ue[0],0,!1)}),r.jsx("div",{style:{flex:`${lt} 1 0`,minWidth:0},children:ln(Ue[1],1,yt>0&&Ue.length-1===1)})]})})(),Ue.length===3&&(()=>{const ce=Kt(Ue[0],0),xt=Kt(Ue[1],1),It=Kt(Ue[2],2),lt=xt+It,dt=ce;return r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{flex:`${lt} 1 0`,minWidth:0},children:ln(Ue[0],0,!1)}),r.jsxs("div",{className:"msg-media-col",style:{flex:`${dt} 1 0`},children:[ln(Ue[1],1,!1),ln(Ue[2],2,yt>0&&Ue.length-1===2)]})]})})(),Ue.length>=4&&(()=>{const ce=Kt(Ue[0],0),xt=Kt(Ue[1],1),It=Kt(Ue[2],2),lt=Kt(Ue[3],3),dt=xt+lt,Mt=ce+It;return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"msg-media-col",style:{flex:`${dt} 1 0`},children:[ln(Ue[0],0,!1),ln(Ue[2],2,!1)]}),r.jsxs("div",{className:"msg-media-col",style:{flex:`${Mt} 1 0`},children:[ln(Ue[1],1,!1),ln(Ue[3],3,yt>0)]})]})})()]},"images-mosaic")};return r.jsx(r.Fragment,{children:Nn.map((gt,Ue)=>{if(gt.kind==="imageGroup")return r.jsx(d.Fragment,{children:Oa(gt.atts)},"images-group");const yt=gt.att,Kt=gt.idx,ln=yt.metadata??{},ce=Ei(yt),xt=!!(A?.isSecret&&ln?.e2ee?.kind==="ciphertext"),It=xt?Cr[yt.url]:void 0,lt=xt&&!ce&&(!It||It.status==="pending"),dt=xt&&It?.status==="error",Mt=ln?.e2ee?.originalName||yt.url?.split("/").pop()||"вложение";if(yt.type==="AUDIO"){const Xt=v.metadata?.duration||0,Qt=ce||yt.url;return r.jsx("div",{style:{marginTop:8,minWidth:200,maxWidth:300},children:lt?r.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:8,padding:"12px 16px",background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:[r.jsx("div",{style:{width:16,height:16,border:"2px solid var(--surface-border)",borderTopColor:"var(--brand)",borderRadius:"50%",animation:"spin 1s linear infinite"}}),r.jsx("span",{style:{fontSize:13},children:"Расшифровка аудио..."})]}):dt?r.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать аудио"}):Qt?r.jsx(Op,{url:Qt,duration:Xt}):r.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:"Голосовое сообщение"})},`${yt.url}-${Kt}-${Ue}`)}return r.jsxs("div",{style:{marginTop:8},children:[yt.__pending||lt?r.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,color:"#6b7280"},children:["Файл: ",Mt,lt&&" (расшифровка...)"]}):dt?r.jsx("div",{style:{color:"#f87171",fontSize:12},children:"Не удалось расшифровать файл"}):r.jsxs("a",{href:ce||yt.url,target:"_blank",rel:"noreferrer",download:Mt,style:{display:"inline-flex",alignItems:"center",gap:6},children:["Файл: ",Mt]}),typeof yt.progress=="number"&&yt.progress<100&&r.jsx("div",{style:{height:6,background:"#e5e7eb",borderRadius:6,overflow:"hidden",marginTop:6},children:r.jsx("div",{style:{width:`${yt.progress}%`,height:"100%",background:"var(--brand)"}})})]},`${yt.url}-${Kt}-${Ue}`)})})})()]}),(()=>{const J=v.attachments||[],Me=typeof v.content=="string"?v.content.trim().length>0:!!v.content,jt=J.some(Nn=>Nn?.type&&Nn.type!=="IMAGE");return J.some(Nn=>Nn?.type==="IMAGE")&&!Me&&!jt?null:r.jsxs("div",{className:"msg-meta",style:{color:"#9aa0a8"},children:[me," ",ve]})})()]})]},v.id)}):null})():r.jsx("div",{className:"messages-empty",children:"Сообщения появятся здесь"})}),t&&r.jsx("button",{className:Cn?"jump-bottom jump-bottom--visible":"jump-bottom",onClick:()=>{ge.current&&ge.current.scrollTo({top:ge.current.scrollHeight,behavior:"smooth"}),ht.current=!0,Je.current=!1,Fn(!1)},children:"↓"}),r.jsx("div",{className:"msg-input-bar",style:{flexShrink:0},onDragOver:h=>{h.preventDefault(),va(!0)},onDragLeave:()=>va(!1),onDrop:async h=>{h.preventDefault(),va(!1);const g=Array.from(h.dataTransfer.files||[]);if(!g.length||!t)return;const b=g.filter(k=>k.type.startsWith("image/")),v=g.filter(k=>!k.type.startsWith("image/"));b.forEach(k=>Ss(k,"upload")),v.length&&await Ra(v)},children:A?.isSecret&&(!c||f)?r.jsx("div",{style:{padding:12,borderRadius:8,background:"var(--surface-200)",border:"1px solid var(--surface-border)",color:"var(--text-muted)"},children:m}):r.jsxs(r.Fragment,{children:[H&&r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10,background:"var(--surface-100)",padding:"8px 12px",borderRadius:8,border:"1px solid var(--surface-border)"},children:[r.jsx(Ff,{size:16,color:"var(--text-muted)"}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Ответ на:"}),r.jsx("div",{style:{fontSize:12,color:"var(--text-primary)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:H.preview}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>W(null),style:{marginLeft:"auto",flexShrink:0},children:r.jsx(Zt,{size:16})})]}),Hn.length>0&&r.jsxs("div",{style:{marginBottom:12},children:[r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Изображения перед отправкой"}),r.jsx("div",{style:{display:"flex",gap:12,overflowX:"auto",paddingBottom:4},children:Hn.map(h=>r.jsxs("div",{style:{position:"relative",flexShrink:0,width:132,background:"var(--surface-100)",borderRadius:12,border:"1px solid var(--surface-border)",padding:8,display:"flex",flexDirection:"column",gap:6},children:[r.jsx("button",{className:"btn btn-icon btn-ghost",style:{position:"absolute",top:4,right:4},onClick:()=>{fi===h.id&&Tn(null),Bd(h.id)},"aria-label":"Удалить изображение",children:r.jsx(Zt,{size:14})}),r.jsx("button",{type:"button",onClick:()=>Tn(h.id),style:{border:"none",padding:0,borderRadius:8,overflow:"hidden",cursor:"pointer",background:"transparent"},"aria-label":"Редактировать изображение",children:r.jsx("img",{src:h.previewUrl,alt:h.fileName,style:{width:"100%",height:90,objectFit:"cover",display:"block"}})}),r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[r.jsx("div",{style:{fontSize:11,color:"var(--text-muted)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:h.fileName}),r.jsx("button",{type:"button",className:"btn btn-ghost",onClick:()=>Tn(h.id),style:{fontSize:12,padding:"4px 6px",justifyContent:"center"},children:"Редактировать"}),h.edited&&r.jsx("div",{style:{fontSize:10,color:"#34d399",textTransform:"uppercase",letterSpacing:.5},children:"Отредактировано"})]})]},h.id))})]}),r.jsx("input",{type:"file",multiple:!0,style:{display:"none"},ref:q,onChange:async h=>{const g=Array.from(h.target.files||[]);if(!t||g.length===0)return;const b=g.filter(k=>k.type.startsWith("image/")),v=g.filter(k=>!k.type.startsWith("image/"));b.forEach(k=>Ss(k,"upload")),v.length&&await Ra(v),h.target.value=""}}),Bo?r.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",padding:"12px 16px",background:"var(--surface-100)",borderRadius:8,border:"1px solid var(--surface-border)"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flex:1},children:[r.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#ef4444",animation:"pulse 1.5s ease-in-out infinite",flexShrink:0}}),r.jsx("div",{ref:ks,style:{width:"100%",...F?{maxWidth:200}:{},height:24,overflow:"hidden",position:"relative",flex:1,minWidth:0},children:(()=>{const v=F?60:Yo;return bs.length===0?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24},children:Array(v).fill(0).map((k,R)=>r.jsx("div",{style:{width:2,height:12,background:"var(--surface-border)",borderRadius:1,animation:"pulse 1.5s ease-in-out infinite",animationDelay:`${R*.1}s`,flexShrink:0}},R))}):r.jsx("div",{style:{display:"flex",alignItems:"center",gap:2,height:24,position:"absolute",right:0,transform:bs.length>v?`translateX(-${(bs.length-v)*4}px)`:"translateX(0)",transition:"none"},children:bs.slice(-v).map((k,R)=>{const I=Math.max(4,k/100*20);return r.jsx("div",{style:{width:2,height:`${I}px`,background:"var(--brand)",borderRadius:1,alignSelf:"flex-end",flexShrink:0}},`${bs.length-v+R}-${R}`)})})})()}),r.jsxs("div",{style:{fontSize:14,color:"var(--text-primary)",fontWeight:500,whiteSpace:"nowrap",flexShrink:0},children:[Math.floor(Vo/60),":",(Vo%60).toString().padStart(2,"0")]})]}),r.jsx("button",{type:"button",className:"btn btn-secondary",onClick:hu,style:{flexShrink:0},"aria-label":"Отменить запись",children:r.jsx(Zt,{size:16})}),r.jsx("button",{type:"button",className:"btn btn-primary",onClick:vc,style:{flexShrink:0},"aria-label":"Отправить голосовое сообщение",children:r.jsx(Wc,{size:16})})]}):r.jsxs("form",{autoComplete:"off",onSubmit:async h=>{if(h.preventDefault(),!t)return;const g=N.trim();if(Hn.length>0){const b=Hn.map(v=>({file:v.file,previewUrl:v.previewUrl}));ws([]),Tn(null),b.forEach(v=>jr(v.previewUrl)),await Ra(b.map(v=>v.file),g||"",H?.id),O(""),W(null)}else g&&(await lc(A,{type:"TEXT",content:g,replyToId:H?.id}),O(""),W(null));ne.invalidateQueries({queryKey:["messages",t]}),setTimeout(()=>{ge.current&&(ge.current.scrollTop=ge.current.scrollHeight)},0)},style:{display:"flex",gap:10,alignItems:"center"},children:[r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>q.current?.click(),style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:F?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Прикрепить файлы",children:[r.jsx(Lf,{size:16}),!F&&r.jsx("span",{children:"Загрузить"})]}),r.jsx("input",{type:"text",placeholder:Hn.length>0?"Добавьте подпись к изображениям...":"Напишите сообщение...",value:N,onChange:h=>O(h.target.value),onPaste:h=>{if(!t)return;const g=h.clipboardData?.items;if(g)for(let b=0;b<g.length;b++){const v=g[b];if(v.type.indexOf("image")!==-1){h.preventDefault();const k=v.getAsFile();k&&Ss(k,"paste");break}}},ref:L,style:{flex:1,minWidth:0,padding:"12px 16px",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontSize:16,height:46,minHeight:46,lineHeight:"20px"}}),r.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:fu,style:{flexShrink:0,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:F?0:6,whiteSpace:"nowrap",height:46,minHeight:46,padding:"0 12px"},"aria-label":"Записать голосовое сообщение",children:[r.jsx(Rf,{size:16}),!F&&r.jsx("span",{children:"Голос"})]}),r.jsxs("button",{type:"submit",className:"btn btn-primary",style:{flexShrink:0,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:F?0:6,height:46,minHeight:46,padding:"0 12px"},children:[r.jsx(Wc,{size:16}),!F&&r.jsx("span",{children:"Отправить"})]})]}),Hd&&r.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:10},children:r.jsx("div",{style:{width:`${Pd}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})})]})})]}),r.jsx(d.Suspense,{fallback:null,children:n&&r.jsx(Np,{open:!!n,conversationId:n,minimized:a===n,peerAvatarUrl:(()=>{const g=(n?pe.data?.find(b=>b.conversation.id===n)?.conversation:A)?.participants||[];return g.length===2?g.find(v=>Wt?v.user.id!==Wt:!0)?.user?.avatarUrl??null:null})(),avatarsByName:(()=>{const g=(n?pe.data?.find(v=>v.conversation.id===n)?.conversation:A)?.participants||[],b={};for(const v of g){const k=v.user,R=k.displayName??k.username??k.id;b[R]=k.avatarUrl??null}return P&&(b[P.displayName??P.username??P.id]=yn.data?.avatarUrl??P.avatarUrl??null),b})(),avatarsById:(()=>{const g=(n?pe.data?.find(v=>v.conversation.id===n)?.conversation:A)?.participants||[],b={};for(const v of g){const k=v.user;b[k.id]=k.avatarUrl??null}return P&&(b[P.id]=yn.data?.avatarUrl??P.avatarUrl??null),b})(),localUserId:P?.id??null,isGroup:!!(n?pe.data?.find(g=>g.conversation.id===n)?.conversation:A)?.isGroup,onMinimize:()=>{if(n){const h=n;l(h);const g=bi(h);!!!(g?.isGroup||(g?.participants?.length??0)>2)&&se.activeConvId!==h&&se.startOutgoing(h,se.initialVideo),n!==h&&s(h)}},onClose:h=>{const g=n??Ir.current;if(!g||a===g)return;const b=()=>{const v=bi(g),k=v?.participants?.length??0,R=!!(v?.isGroup||k>2);!R&&Ds(g),qt(E=>{const D=E[g];if(!D)return E;if(R){const T=(D.participants||[]).filter($=>Wt?$!==Wt:!0);return{...E,[g]:{...D,participants:T}}}return D.active?{...E,[g]:{...D,active:!1,endedAt:Date.now()}}:E}),s(E=>E===g?null:E),l(E=>E===g?null:E),se.endCall(),on()};!h?.manual&&qr(g)?Ia(g,b):(er(g),b())},initialVideo:se.initialVideo,initialAudio:se.initialAudio})}),r.jsx(ap,{open:!!wi,image:wi,onClose:()=>Tn(null),onApply:({file:h,previewUrl:g})=>{wi&&(Vd(wi.id,h,g),Tn(null))}}),u&&(()=>{const h=pe.data?.find(T=>T.conversation.id===u.conversationId)?.conversation,g=h?.isGroup||(h?.participants?.length??0)>2;if(g)return null;let b="Неизвестный",v,k=u.conversationId;if(g)b=h?.title??"Группа",v=h?.avatarUrl,k=u.conversationId;else{const T=h?.participants?.find($=>$.user.id!==P?.id)?.user;if(T)b=T.displayName??T.username??T.id??"Неизвестный",v=T.avatarUrl,k=T.id;else{const $=Ft.data?.find(K=>(K.conversationIds||[]).includes(u.conversationId));$?.friend&&(b=$.friend.displayName??$.friend.username??$.friend.id??"Неизвестный",v=$.friend.avatarUrl,k=$.friend.id)}}const R=Math.floor((Date.now()-u.startedAt)/1e3),I=Math.floor(R/60),E=R%60,D=`${I}:${E.toString().padStart(2,"0")}`;return Ur.createPortal(r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:r.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[r.jsx("div",{style:{fontWeight:700},children:u.video?"Видеозвонок":"Звонок"}),!u.minimized&&r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>{p(T=>T?{...T,minimized:!0}:null)},style:{padding:8},children:r.jsx(Af,{size:18})})]}),r.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:16},children:[r.jsx(vt,{name:b,id:k,size:64,avatarUrl:v}),r.jsxs("div",{style:{flex:1},children:[r.jsx("div",{style:{fontWeight:600,fontSize:16},children:b}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"дозвон…"})]}),r.jsx("div",{style:{fontSize:18,fontWeight:600,color:"var(--text-primary)",fontVariantNumeric:"tabular-nums"},children:D})]}),r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{w.current&&(window.clearTimeout(w.current),w.current=null),Er(),Ri(),Ds(u.conversationId),p(null),qt(T=>{const $=T[u.conversationId];if($?.active)return{...T,[u.conversationId]:{...$,active:!1,endedAt:Date.now()}};const{[u.conversationId]:K,...Z}=T;return Z}),se.endCall()},children:[r.jsx(Wa,{size:18}),r.jsx("span",{children:"Сбросить"})]}),u.minimized&&r.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{p(T=>T?{...T,minimized:!1}:null)},children:[r.jsx(Uc,{size:18}),r.jsx("span",{children:"Развернуть"})]})]})]})}),document.body)})(),se.incoming&&Ur.createPortal(r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1001},children:r.jsxs("div",{style:{background:"var(--surface-200)",borderRadius:16,border:"1px solid var(--surface-border)",padding:24,width:"min(92vw, 440px)",boxShadow:"var(--shadow-sharp)",transform:"translateY(-4vh)",color:"var(--text-primary)"},children:[r.jsx("div",{style:{fontWeight:700,marginBottom:12},children:se.incoming.video?"Входящий видеозвонок":"Входящий аудиозвонок"}),r.jsxs("div",{className:"caller-tile",style:{display:"flex",alignItems:"center",gap:12,padding:12,background:"var(--surface-100)",border:"1px solid var(--surface-border)",borderRadius:12,marginBottom:12},children:[r.jsx(vt,{name:se.incoming.from.name??se.incoming.from.id,id:se.incoming.from.id,size:64,avatarUrl:se.incoming.from.avatarUrl??pe.data?.find(h=>h.conversation.id===se.incoming.conversationId)?.conversation?.participants?.find(h=>h.user.id===se.incoming.from.id)?.user?.avatarUrl??Ft.data?.find(h=>h.friend?.id===se.incoming.from.id)?.friend?.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600,fontSize:16},children:se.incoming.from.name??se.incoming.from.id}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"звонит…"})]})]}),r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[r.jsxs("div",{style:{display:"flex",gap:8},children:[r.jsxs("button",{className:"btn btn-primary",style:{flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ci(!1)},children:[r.jsx(Fa,{size:18}),r.jsx("span",{children:"Ответить"})]}),r.jsxs("button",{className:"btn",style:{background:"var(--brand)",color:"#fff",flex:1,display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ci(!0)},children:[r.jsx($a,{size:18}),r.jsx("span",{children:"Ответить с видео"})]})]}),r.jsx("div",{style:{display:"flex"},children:r.jsxs("button",{className:"btn",style:{background:"#ef4444",color:"#fff",width:"100%",display:"inline-flex",alignItems:"center",justifyContent:"center",gap:8,padding:"14px 16px",minHeight:48,borderRadius:12},onClick:()=>{Ea()},children:[r.jsx(Wa,{size:18}),r.jsx("span",{children:"Отмена"})]})}),Br&&r.jsx("div",{style:{marginTop:12,fontSize:13,color:"#fca5a5",textAlign:"center",lineHeight:1.4},children:Br})]})]})}),document.body)]})}function kc(i,o){o&&ne.setQueryData(["messages",i],f=>{const c=Array.isArray(f)?[...f]:[];return c.some(m=>m.id===o.id)||(c.push(o),c.sort((m,h)=>new Date(m.createdAt||0).getTime()-new Date(h.createdAt||0).getTime())),c})}function gu(i,o){o&&ne.setQueryData(["messages",i],f=>{if(!Array.isArray(f))return f;const c=f.findIndex(h=>h.id===o.id);if(c===-1)return f;const m=[...f];return m[c]={...m[c],...o},m})}return r.jsxs(r.Fragment,{children:[Ze&&r.jsxs("div",{className:"audio-unlock-overlay",children:[r.jsx("button",{type:"button",className:"audio-unlock-button",onClick:()=>{yc()},children:"Войти"}),r.jsx("div",{className:"audio-unlock-hint",children:"Включить звук сообщений и звонков"})]}),r.jsx("div",{className:F?"chats-page mobile-slider":"chats-page",children:F?r.jsxs("div",{className:"slider-inner",style:{transform:`translateX(${Ye==="conversation"?"-100vw":"0"})`},onTouchStart:i=>{const o=i.touches[0];jn.current={x:o.clientX,y:o.clientY},Xn.current=0},onTouchMove:i=>{if(!jn.current)return;const o=i.touches[0];Xn.current=o.clientX-jn.current.x},onTouchEnd:()=>{const i=Xn.current;jn.current=null,!(Math.abs(i)<50)&&(i<0&&t&&at("conversation"),i>0&&at("list"))},children:[wc(!0),bc(!0)]}):r.jsxs(r.Fragment,{children:[wc(!1),bc(!1)]})}),$d&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[r.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Профиль"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Qs(!1),children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[r.jsx(vt,{name:P?.displayName??P?.username??"Me",id:P?.id??"me",avatarUrl:nn??yn.data?.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:P?.displayName??P?.username}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["EBLID: ",yn.data?.eblid??"— — — —"]})]})]}),r.jsx("input",{ref:zo,type:"file",accept:"image/*",onChange:i=>{const o=i.target.files?.[0];if(o){ei(o);try{ti(URL.createObjectURL(o))}catch{}}},style:{display:"none"}}),!nn&&r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),r.jsxs("div",{onClick:()=>zo.current?.click(),onDragOver:i=>{i.preventDefault(),ga(!0)},onDragLeave:()=>ga(!1),onDrop:i=>{i.preventDefault(),ga(!1);const o=i.dataTransfer.files?.[0];if(o){ei(o);try{ti(URL.createObjectURL(o))}catch{}}},style:{border:"2px dashed "+($o?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:$o?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[r.jsx(Ua,{size:18,color:"var(--text-muted)"}),r.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),nn&&r.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[r.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),r.jsxs("div",{ref:br,onWheel:i=>{i.preventDefault();const o=-i.deltaY*.001,f=Math.max(.1,Math.min(10,_e.scale*(1+o))),c=br.current?.getBoundingClientRect();if(c){const m=i.clientX-c.left,h=i.clientY-c.top,g=f/_e.scale,b=m-(m-_e.x)*g,v=h-(h-_e.y)*g;Qn({x:b,y:v,scale:f})}},onPointerDown:i=>{if(i.pointerType==="touch")return;const o=br.current?.getBoundingClientRect();if(!o)return;const f=o.width,c=o.height,m=f/2,h=c/2,b=240/2,v=i.clientX-o.left,k=i.clientY-o.top,R=v-m,I=k-h;if(R*R+I*I>b*b)return;try{i.currentTarget.setPointerCapture?.(i.pointerId)}catch{}const E=i.clientX,D=i.clientY,T={..._e},$=Z=>{Z.preventDefault();const ye=Z.clientX-E,xe=Z.clientY-D;Qn({...T,x:T.x+ye,y:T.y+xe})},K=()=>{window.removeEventListener("pointermove",$),window.removeEventListener("pointerup",K)};window.addEventListener("pointermove",$,{passive:!1}),window.addEventListener("pointerup",K,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[r.jsx("img",{ref:ma,src:nn,alt:"preview",style:{position:"absolute",left:_e.x,top:_e.y,transform:`scale(${_e.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:i=>{const o=i.currentTarget,f=br.current;if(!f)return;const c=f.clientWidth,m=f.clientHeight,h=240,g=o.naturalWidth,b=o.naturalHeight,v=c/2,k=m/2,R=h/g,I=h/b,E=Math.max(R,I)*1.2,D=v-g*E/2,T=k-b*E/2;Qn({x:D,y:T,scale:E})}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),r.jsxs("div",{style:{marginTop:16},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[r.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(_e.scale*100),"%"]})]}),r.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Qn(i=>({...i,scale:Math.max(.1,i.scale-.1)})),children:"−"}),r.jsx("input",{type:"range",min:.1,max:10,step:.05,value:_e.scale,onChange:i=>Qn(o=>({...o,scale:parseFloat(i.target.value)})),style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Qn(i=>({...i,scale:Math.min(10,i.scale+.1)})),children:"+"})]}),r.jsx("div",{style:{display:"flex",gap:8,marginTop:12,fontSize:11,color:"var(--text-muted)"},children:r.jsx("div",{style:{flex:1,textAlign:"center",padding:"6px",background:"var(--surface-200)",borderRadius:6},children:F?"Два пальца для масштаба, один для перемещения":"Перетащите для перемещения, колесико мыши для масштаба"})})]}),r.jsx("canvas",{ref:ni,width:240,height:240,style:{display:"none"}})]}),ha&&r.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:[r.jsx("button",{className:"btn btn-secondary",onClick:()=>{ei(null),nn&&URL.revokeObjectURL(nn),ti(null)},children:"Отмена"}),r.jsx("button",{className:"btn btn-primary",disabled:$r,onClick:async()=>{if(ha){Js(!0),ri(0);try{let i=null;if(ni.current&&nn){const c=await new Promise(T=>{const $=new Image;$.onload=()=>T($),$.src=nn}),m=ni.current.getContext("2d"),h=240;m.clearRect(0,0,h,h),m.save(),m.beginPath(),m.arc(h/2,h/2,h/2,0,Math.PI*2),m.closePath(),m.clip();const g=br.current?.clientWidth??320,b=br.current?.clientHeight??320,v={x:g/2,y:b/2},k={x:v.x-h/2,y:v.y-h/2,w:h,h},R=(k.x-_e.x)/_e.scale,I=(k.y-_e.y)/_e.scale,E=k.w/_e.scale,D=k.h/_e.scale;m.drawImage(c,R,I,E,D,0,0,h,h),m.restore(),i=await new Promise(T=>ni.current.toBlob($=>T($),"image/png"))}const o=new FormData;o.append("file",i??ha);const f=await new Promise((c,m)=>{const h=new XMLHttpRequest;h.open("POST","/api/upload");try{const g=or.getState().session?.accessToken;g&&h.setRequestHeader("Authorization",`Bearer ${g}`)}catch{}h.upload.onprogress=g=>{g.lengthComputable&&ri(Math.round(100*g.loaded/g.total))},h.onreadystatechange=()=>{if(h.readyState===4)if(h.status>=200&&h.status<300)try{const g=JSON.parse(h.responseText);c(g.url)}catch(g){m(g)}else m(new Error("upload failed"))},h.send(o)});await ae.patch("/status/me",{avatarUrl:f}),ei(null),nn&&URL.revokeObjectURL(nn),ti(null),yn.refetch()}catch{}Js(!1),Hr("Готово"),setTimeout(()=>Hr(null),2200)}},children:$r?"Загрузка...":"Загрузить"})]}),$r&&r.jsx("div",{style:{height:8,background:"var(--surface-100)",borderRadius:6,overflow:"hidden",marginTop:12},children:r.jsx("div",{style:{width:`${Uo}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),li&&r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a",fontSize:14},children:[r.jsx(io,{size:16}),r.jsx("span",{children:li})]}),r.jsx("div",{style:{borderTop:"1px solid var(--surface-border)",marginTop:24,paddingTop:20},children:r.jsxs("button",{className:"btn btn-secondary",onClick:async()=>{try{await ae.post("/auth/logout")}catch{}or.getState().setSession(null),Qs(!1)},style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,color:"#f87171"},children:[r.jsx(za,{size:18}),r.jsx("span",{children:"Выйти из Еблуши"})]})}),r.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:r.jsx("button",{className:"btn btn-ghost",onClick:()=>Qs(!1),children:"Закрыть"})})]})}),Od&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:85},onClick:()=>Zn(!1),children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:i=>i.stopPropagation(),children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[r.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Аватар группы"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Zn(!1),children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[r.jsx(vt,{name:gr.trim()||"?",id:"new-group-avatar-preview",avatarUrl:tn??void 0,size:60}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:gr||"Новая группа"}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),r.jsx("input",{ref:ia,type:"file",accept:"image/*",style:{display:"none"},onChange:i=>{const o=i.target.files?.[0];if(o){if(In(o),_t)try{URL.revokeObjectURL(_t)}catch{}try{const f=URL.createObjectURL(o);vr(f)}catch{vr(null)}Mn({x:0,y:0,scale:1})}}}),!_t&&r.jsx(r.Fragment,{children:r.jsxs("div",{onClick:()=>ia.current?.click(),onDragOver:i=>{i.preventDefault(),oa(!0)},onDragLeave:()=>oa(!1),onDrop:i=>{i.preventDefault(),oa(!1);const o=i.dataTransfer.files?.[0];if(o){if(In(o),_t)try{URL.revokeObjectURL(_t)}catch{}try{const f=URL.createObjectURL(o);vr(f)}catch{vr(null)}Mn({x:0,y:0,scale:1})}},style:{border:"2px dashed "+(Lo?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Lo?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[r.jsx(Ua,{size:18,color:"var(--text-muted)"}),r.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})}),_t&&r.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[r.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),r.jsxs("div",{ref:wr,onWheel:i=>{i.preventDefault();const o=-i.deltaY*.001,f=Math.max(.1,Math.min(10,pt.scale*(1+o))),c=wr.current?.getBoundingClientRect();if(c){const m=i.clientX-c.left,h=i.clientY-c.top,g=f/pt.scale,b=m-(m-pt.x)*g,v=h-(h-pt.y)*g;Mn({x:b,y:v,scale:f})}},onPointerDown:i=>{if(i.pointerType==="touch")return;const o=wr.current?.getBoundingClientRect();if(!o)return;const f=o.width,c=o.height,m=f/2,h=c/2,b=240/2,v=i.clientX-o.left,k=i.clientY-o.top,R=v-m,I=k-h;if(R*R+I*I>b*b)return;try{i.currentTarget.setPointerCapture?.(i.pointerId)}catch{}const E=i.clientX,D=i.clientY,T={...pt},$=Z=>{Z.preventDefault();const ye=Z.clientX-E,xe=Z.clientY-D;Mn({...T,x:T.x+ye,y:T.y+xe})},K=()=>{window.removeEventListener("pointermove",$),window.removeEventListener("pointerup",K)};window.addEventListener("pointermove",$,{passive:!1}),window.addEventListener("pointerup",K,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[r.jsx("img",{ref:Ld,src:_t,alt:"preview",style:{position:"absolute",left:pt.x,top:pt.y,transform:`scale(${pt.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:i=>{const o=i.currentTarget,f=wr.current;if(!f)return;const c=f.clientWidth,m=f.clientHeight,h=240,g=o.naturalWidth,b=o.naturalHeight,v=c/2,k=m/2,R=h/g,I=h/b,E=Math.max(R,I)*1.2,D=v-g*E/2,T=k-b*E/2;Mn({x:D,y:T,scale:E})}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                      radial-gradient(circle at center, transparent 55%, rgba(17,24,39,0.9) 60%),
                      linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                    `,backgroundSize:"100% 100%, 16px 16px, 16px 16px",mixBlendMode:"soft-light"}})]}),r.jsxs("div",{style:{marginTop:16},children:[r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Масштаб"}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Mn(i=>({...i,scale:Math.max(.1,i.scale-.1)})),children:"−"}),r.jsx("input",{type:"range",min:.1,max:4,step:.01,value:pt.scale,onChange:i=>{const o=parseFloat(i.target.value),f=wr.current?.getBoundingClientRect();if(!f){Mn(v=>({...v,scale:o}));return}const c=f.width/2,m=f.height/2,h=o/pt.scale,g=c-(c-pt.x)*h,b=m-(m-pt.y)*h;Mn({x:g,y:b,scale:o})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>Mn(i=>({...i,scale:Math.min(10,i.scale+.1)})),children:"+"})]})]}),r.jsx("canvas",{ref:aa,width:240,height:240,style:{display:"none"}})]}),r.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:16},children:[r.jsx("button",{className:"btn btn-ghost",onClick:()=>{Zn(!1)},children:"Отмена"}),r.jsx("button",{className:"btn btn-primary",disabled:!_t,onClick:async()=>{if(!_t||!aa.current){Zn(!1);return}try{const i=await new Promise(D=>{const T=new Image;T.onload=()=>D(T),T.src=_t}),o=aa.current,f=o.getContext("2d");if(!f)throw new Error("Could not get 2d context");const c=240;f.clearRect(0,0,c,c),f.save(),f.beginPath(),f.arc(c/2,c/2,c/2,0,Math.PI*2),f.closePath(),f.clip();const m=wr.current?.clientWidth??320,h=wr.current?.clientHeight??320,g={x:m/2,y:h/2},b={x:g.x-c/2,y:g.y-c/2,w:c,h:c},v=(b.x-pt.x)/pt.scale,k=(b.y-pt.y)/pt.scale,R=b.w/pt.scale,I=b.h/pt.scale;f.drawImage(i,v,k,R,I,0,0,c,c),f.restore();const E=await new Promise(D=>o.toBlob(T=>D(T),"image/png"));if(E){if(tn)try{URL.revokeObjectURL(tn)}catch{}const D=URL.createObjectURL(E);Oo(E),Do(D)}}catch{}finally{Zn(!1)}},children:"Сохранить"})]})]})}),sa&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:60},onClick:Ta,children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:10,width:520,border:"1px solid var(--surface-border)"},onClick:i=>i.stopPropagation(),children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,color:"var(--text-primary)"},children:[r.jsx("div",{style:{fontWeight:700},children:"Создать групповой чат"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:Ta,children:r.jsx(Zt,{size:16})})]}),(()=>{const i=gr.trim(),o=i||"?";return r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:12},children:[r.jsx("input",{placeholder:"Название",value:gr,onChange:f=>Zs(f.target.value),style:{flex:1,width:"100%",padding:10,borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}}),r.jsx("input",{ref:ia,type:"file",accept:"image/*",style:{display:"none"},onChange:f=>{const c=f.target.files?.[0];if(c){if(In(c),_t)try{URL.revokeObjectURL(_t)}catch{}try{const m=URL.createObjectURL(c);vr(m)}catch{vr(null)}Zn(!0)}}}),r.jsx("button",{type:"button",className:"btn btn-icon btn-ghost",onClick:()=>Zn(!0),title:"Выбрать аватар группы",style:{borderRadius:"50%",padding:0,width:44,height:44,flexShrink:0},children:r.jsx(vt,{name:o,id:"new-group-avatar",avatarUrl:tn??void 0,size:40})})]})})(),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:6},children:"Выберите участников"}),r.jsx("div",{style:{maxHeight:280,overflow:"auto",display:"grid",gridTemplateColumns:"1fr",gap:8},children:Ft.data?.map(i=>{const o=i.friend,f=yr.includes(o.id);return r.jsxs("div",{className:"tile",onClick:()=>Yt(c=>f?c.filter(m=>m!==o.id):[...c,o.id]),style:{cursor:"pointer",borderColor:f?"var(--brand-600)":void 0},children:[r.jsx(vt,{name:o.displayName??o.username,id:o.id,presence:Mr(o),avatarUrl:o.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:o.displayName??o.username}),r.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:f?"Выбрано":"Нажмите, чтобы выбрать"})]}),r.jsx("div",{style:{marginLeft:"auto"},children:r.jsx("input",{type:"checkbox",readOnly:!0,checked:f})})]},i.id)})}),r.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12},children:r.jsx("button",{className:"btn btn-primary",disabled:yr.length===0||Ct,onClick:async()=>{if(!(yr.length===0||Ct)){xr(!0);try{const i=await ae.post("/conversations",{participantIds:yr,title:gr||void 0,isGroup:!0}),o=i.data?.conversation?.id;if(o&&(Ao||gs))try{const f=new FormData;f.append("file",Ao??gs);const c=await new Promise((m,h)=>{const g=new XMLHttpRequest;g.open("POST","/api/upload");try{const b=or.getState().session?.accessToken;b&&g.setRequestHeader("Authorization",`Bearer ${b}`)}catch{}g.onreadystatechange=()=>{if(g.readyState===4)if(g.status>=200&&g.status<300)try{const b=JSON.parse(g.responseText);m(b.url)}catch(b){h(b)}else h(new Error(`upload failed: ${g.status} ${g.statusText}`))},g.onerror=()=>h(new Error("Network error during upload")),g.send(f)});await ae.patch(`/conversations/${o}`,{avatarUrl:c})}catch(f){console.error("Error setting group avatar:",f)}ne.invalidateQueries({queryKey:["conversations"]}),i.data?.conversation?.id&&Gr(i.data.conversation.id),Ta()}catch(i){console.error("Error creating group:",i),alert(i?.response?.data?.message||"Не удалось создать беседу")}finally{xr(!1)}}},children:Ct?"Создание...":"Создать"})})]})}),Ud&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:16,width:520,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[r.jsx("div",{style:{fontWeight:700},children:"Контакты"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>Ks(!1),children:r.jsx(Zt,{size:16})})]}),sn.data&&sn.data.length>0&&r.jsxs("div",{style:{marginBottom:12},children:[r.jsx("div",{style:{fontWeight:700,marginBottom:6},children:"Новые запросы"}),r.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:sn.data.map(i=>r.jsxs("div",{className:"tile",children:[r.jsx(vt,{name:i.friend.displayName??i.friend.username,id:i.friend.id,presence:i.friend.status,avatarUrl:i.friend.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:i.friend.displayName??i.friend.username}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"хочет добавить вас"})]}),r.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8},children:[r.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ae.post("/contacts/respond",{contactId:i.id,action:"reject"}),sn.refetch()},children:"Отклонить"}),r.jsx("button",{className:"btn btn-primary",onClick:async()=>{await ae.post("/contacts/respond",{contactId:i.id,action:"accept"}),Ft.refetch(),sn.refetch(),pe.refetch()},children:"Добавить"})]})]},i.id))})]}),r.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)"},children:"Поиск по EBLID"}),r.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginBottom:12},children:[0,1,2,3].map(i=>r.jsx("input",{ref:la[i],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:ca[i],onChange:o=>ou(i,o.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:52,height:56,fontSize:22,textAlign:"center",borderRadius:8,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)"}},i))}),Kn&&r.jsxs("div",{className:"tile",style:{marginBottom:12},children:[r.jsx(vt,{name:Kn.displayName??Kn.username,id:Kn.id,presence:Mr(Kn),avatarUrl:Kn.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:Kn.displayName??Kn.username}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Найден по EBLID"})]}),r.jsx("div",{style:{marginLeft:"auto"},children:r.jsx("button",{disabled:Wd,className:"btn btn-primary",onClick:lu,children:"Добавить"})})]}),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12},children:[r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Мой EBLID:"}),r.jsx("div",{style:{fontWeight:700},children:fa||"— — — —"}),r.jsx("button",{className:"btn btn-secondary btn-icon",onClick:()=>{fa&&navigator.clipboard.writeText(fa)},title:"Скопировать EBLID",children:r.jsx(vf,{size:16})})]}),r.jsx("div",{style:{marginTop:16,fontWeight:700},children:"Мои друзья"}),r.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8,display:"flex",flexDirection:"column",gap:8},children:(Ft.data||[]).map(i=>{const o=i.friend;return r.jsxs("div",{className:"tile",children:[r.jsx(vt,{name:o.displayName??o.username,id:o.id,presence:Mr(o),avatarUrl:o.avatarUrl??void 0}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600},children:o.displayName??o.username}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Контакт"})]}),r.jsxs("div",{style:{marginLeft:"auto",display:"flex",gap:8,flexWrap:"wrap",justifyContent:"flex-end"},children:[r.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await ae.post("/contacts/remove",{contactId:i.id}),Ft.refetch()},children:"Удалить"}),r.jsx("button",{className:"btn btn-secondary",onClick:async()=>{await oc(o.id),Ks(!1),ne.invalidateQueries({queryKey:["conversations"]})},children:"Секретный чат"}),r.jsx("button",{className:"btn btn-primary",onClick:async()=>{const f=await ae.post("/conversations",{participantIds:[o.id],isGroup:!1});Ks(!1),Gr(f.data.conversation.id),ne.invalidateQueries({queryKey:["conversations"]})},children:"Открыть чат"})]})]},i.id)})})]})}),Oe.open&&Oe.messageId&&r.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>mt({open:!1,x:0,y:0,messageId:null}),children:r.jsxs("div",{ref:ic,className:"msg-menu",style:{position:"absolute",left:Oe.x,top:Oe.y,color:"#ffffff"},onClick:i=>i.stopPropagation(),children:[r.jsx("div",{style:{display:"flex",gap:6,padding:6,borderBottom:"1px solid var(--surface-border)"},children:["👍","❤️","👎","🔥","🤝","😆"].map((i,o)=>{const c=i==="❤️"?"#ef4444":"#ffffff";return r.jsx("button",{onClick:async()=>{try{const m=Oe.messageId;((an||[]).find(b=>b.id===m)?.reactions||[]).some(b=>b.userId===P?.id&&b.emoji===i)?await ae.post("/messages/unreact",{messageId:m,emoji:i}):await ae.post("/messages/react",{messageId:m,emoji:i}),t&&ne.invalidateQueries({queryKey:["messages",t]})}catch{}mt({open:!1,x:0,y:0,messageId:null})},style:{fontSize:16,color:c,cursor:"pointer",transition:"transform 0.2s ease",animation:`reactionPop 0.3s ease ${o*.05}s both`},onMouseEnter:m=>{m.currentTarget.style.transform="scale(1.2)"},onMouseLeave:m=>{m.currentTarget.style.transform="scale(1)"},children:i},i)})}),r.jsx("button",{style:{color:"#ffffff"},onClick:()=>{const i=Oe.messageId,o=(an||[]).find(f=>f.id===i);W({id:i,preview:(o?.content??"").slice(0,100)}),mt({open:!1,x:0,y:0,messageId:null})},children:"Цитировать"}),(()=>{const i=Oe.messageId;return(an||[]).find(c=>c.id===i)?.senderId===P?.id?r.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{try{await ae.post("/messages/delete",{messageId:Oe.messageId}),t&&ne.invalidateQueries({queryKey:["messages",t]})}catch{}mt({open:!1,x:0,y:0,messageId:null})},children:"Удалить"}):null})(),r.jsx("button",{style:{color:"#ffffff"},onClick:async()=>{const i=Oe.messageId,o=(an||[]).find(f=>f.id===i);try{await navigator.clipboard.writeText(o?.content||"")}catch{}mt({open:!1,x:0,y:0,messageId:null})},children:"Копировать"}),r.jsx("button",{style:{color:"#ffffff"},onClick:()=>{gn({open:!0,messageId:Oe.messageId}),mt({open:!1,x:0,y:0,messageId:null})},children:"Переслать"})]})}),r.jsx(op,{open:ya.open,items:ya.items,index:ya.index,onClose:()=>xa(i=>({...i,open:!1})),onIndexChange:i=>xa(o=>({...o,index:i}))}),Wn.open&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>gn({open:!1,messageId:null}),children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:16,borderRadius:12,width:420,border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-sharp)",color:"var(--text-primary)"},onClick:i=>i.stopPropagation(),children:[r.jsx("div",{style:{fontWeight:700,marginBottom:8},children:"Переслать сообщение"}),r.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:8},children:(pe.data||[]).map(i=>{const o=i.conversation,c=o.participants.filter(h=>Wt?h.user.id!==Wt:!0).map(h=>h.user).map(h=>h.displayName??h.username).join(", ")||"Диалог",m=o.title??c;return r.jsx("div",{className:"tile",onClick:async()=>{const h=Wn.messageId,g=(an||[]).find(b=>b.id===h);g&&(await lc(o,{type:"TEXT",content:`↪ ${g.content??""}`,replyToId:void 0}),gn({open:!1,messageId:null}))},children:r.jsx("div",{style:{fontWeight:600},children:m})},o.id)})}),r.jsx("div",{style:{display:"flex",justifyContent:"flex-end",marginTop:10},children:r.jsx("button",{className:"btn btn-secondary",onClick:()=>gn({open:!1,messageId:null}),children:"Отмена"})})]})}),mr&&A&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:70},onClick:Xr,children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)",color:"var(--text-primary)"},onClick:i=>i.stopPropagation(),children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[r.jsx("div",{style:{fontWeight:700,fontSize:20},children:"Добавить участников"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:Xr,children:r.jsx(Zt,{size:18})})]}),r.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:[{key:"friends",label:"Из друзей"},{key:"eblid",label:"По EBLID"}].map(i=>{const o=M===i.key;return r.jsx("button",{className:"btn btn-ghost",onClick:()=>z(i.key),style:{flex:1,borderRadius:999,border:o?"1px solid var(--brand-500)":"1px solid var(--surface-border)",background:o?"var(--surface-100)":"transparent",color:o?"var(--text-primary)":"var(--text-muted)",fontWeight:o?600:500},children:i.label},i.key)})}),r.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",marginBottom:16},children:M==="friends"?"Выберите контакты, которых нужно пригласить в эту беседу.":"Введите EBLID пользователя, чтобы пригласить его в беседу."}),M==="friends"?r.jsx("div",{style:{maxHeight:320,overflow:"auto",display:"flex",flexDirection:"column",gap:10},children:mc.length===0?r.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Все ваши контакты уже находятся в этой беседе."}):mc.map(i=>{const o=i.friend,f=B.includes(o.id);return r.jsxs("div",{className:"tile",onClick:()=>y(c=>f?c.filter(m=>m!==o.id):[...c,o.id]),style:{cursor:"pointer",borderColor:f?"var(--brand-600)":void 0,display:"flex",alignItems:"center",gap:12},children:[r.jsx(vt,{name:o.displayName??o.username,id:o.id,presence:Mr(o),avatarUrl:o.avatarUrl??void 0}),r.jsxs("div",{style:{flex:1},children:[r.jsx("div",{style:{fontWeight:600},children:o.displayName??o.username}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Da(o)})]}),r.jsx("div",{style:{width:18,height:18,borderRadius:4,border:"2px solid var(--surface-border)",background:f?"var(--brand-600)":"transparent"}})]},i.id)})}):r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[r.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center"},children:[0,1,2,3].map(i=>r.jsx("input",{ref:le[i],type:"tel",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",enterKeyHint:"done",value:U[i],onChange:o=>eu(i,o.target.value.replace(/\D/g,"").slice(0,1)),maxLength:1,style:{width:56,height:60,fontSize:24,textAlign:"center",borderRadius:10,border:"1px solid var(--surface-border)",background:"var(--surface-100)",color:"var(--text-primary)",fontWeight:600}},i))}),bt&&r.jsx("div",{style:{textAlign:"center",fontSize:13,color:"var(--text-muted)"},children:"Ищем пользователя…"}),re&&r.jsxs("div",{className:"tile",style:{alignItems:"center",gap:12},children:[r.jsx(vt,{name:re.displayName??re.username,id:re.id,presence:re.status,avatarUrl:re.avatarUrl??void 0}),r.jsxs("div",{style:{flex:1},children:[r.jsx("div",{style:{fontWeight:600},children:re.displayName??re.username}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:Ti.alreadyInChat?"Уже в беседе":Ti.isSelf?"Это вы":"Найден по EBLID"})]})]}),!re&&Re&&r.jsx("div",{style:{textAlign:"center",fontSize:13,color:"#f87171"},children:Re})]}),r.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:12,marginTop:20},children:[r.jsx("button",{className:"btn btn-secondary",onClick:Xr,children:"Отмена"}),r.jsx("button",{className:"btn btn-primary",disabled:j||(M==="friends"?B.length===0:!re||Ti.alreadyInChat||Ti.isSelf),onClick:M==="friends"?Qd:Jd,children:j?"Добавление...":"Добавить"})]})]})}),We.open&&We.conversationId&&r.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>Y({open:!1,x:0,y:0,conversationId:null}),children:r.jsx("div",{ref:Q,className:"msg-menu",style:{position:"absolute",left:We.x,top:We.y},onClick:i=>i.stopPropagation(),children:(()=>{const o=(pe.data||[]).find(m=>m.conversation.id===We.conversationId)?.conversation||(t===We.conversationId?A:null),f=!!(o&&(o.isGroup||(o.participants?.length??0)>2)),c=async()=>{try{f?await ae.delete(`/conversations/${We.conversationId}/participants/me`):await ae.delete(`/conversations/${We.conversationId}`),ne.invalidateQueries({queryKey:["conversations"]}),t===We.conversationId&&(e(null),F&&at("list"))}catch{}Y({open:!1,x:0,y:0,conversationId:null})};return r.jsxs("button",{onClick:c,style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[f?r.jsx(za,{size:16}):r.jsx(ao,{size:16}),f?"Выйти из беседы":"Удалить беседу"]})})()})}),te.open&&te.anchor&&A&&r.jsx("div",{style:{position:"fixed",inset:0,background:"transparent",zIndex:45},onClick:()=>oe({open:!1,anchor:null}),children:r.jsx("div",{ref:Ke,className:"msg-menu",style:{position:"fixed"},onClick:i=>i.stopPropagation(),children:(()=>{const i=A.isGroup||(A.participants?.length??0)>2,o=!!A.isSecret&&!i,f=!i&&A.participants?.find(c=>c.user.id!==Wt)?.user;return i?r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:()=>{y([]),z("friends"),X(["","","",""]),he(null),Qe(null),Ve(!1),C(!0),oe({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[r.jsx(Hc,{size:16}),"Добавить участников"]}),r.jsxs("button",{onClick:async()=>{if(t){try{await ae.delete(`/conversations/${t}/participants/me`),ne.invalidateQueries({queryKey:["conversations"]}),e(null),F&&at("list")}catch(c){console.error("Failed to leave conversation:",c)}oe({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r.jsx(za,{size:16}),"Выйти из беседы"]})]}):r.jsxs(r.Fragment,{children:[o?r.jsxs("button",{onClick:()=>{Cs(!0),oe({open:!1,anchor:null})},style:{display:"flex",alignItems:"center",gap:8},children:[r.jsx(If,{size:16}),"Завершить секретный чат"]}):r.jsxs("button",{onClick:async()=>{f?.id&&await oc(f.id),oe({open:!1,anchor:null})},disabled:rc,style:{display:"flex",alignItems:"center",gap:8},children:[r.jsx(Lc,{size:16}),"Начать секретный чат"]}),r.jsxs("button",{onClick:async()=>{if(t){try{await ae.delete(`/conversations/${t}`),ne.invalidateQueries({queryKey:["conversations"]}),ne.removeQueries({queryKey:["messages",t]}),e(null),F&&at("list")}catch(c){console.error("Failed to delete conversation:",c)}oe({open:!1,anchor:null})}},style:{display:"flex",alignItems:"center",gap:8,color:"#ef4444"},children:[r.jsx(ao,{size:16}),"Удалить чат"]})]})})()})}),Tt&&A&&r.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(10,12,16,0.55)",backdropFilter:"blur(4px) saturate(110%)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:80},onClick:()=>ot(!1),children:r.jsxs("div",{style:{background:"var(--surface-200)",padding:24,borderRadius:16,width:440,maxWidth:"90vw",border:"1px solid var(--surface-border)",boxShadow:"var(--shadow-medium)"},onClick:i=>i.stopPropagation(),children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[r.jsx("div",{style:{fontWeight:700,fontSize:20,color:"var(--text-primary)"},children:"Изменить аватар группы"}),r.jsx("button",{className:"btn btn-icon btn-ghost",onClick:()=>ot(!1),children:r.jsx(Zt,{size:18})})]}),r.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20,alignItems:"center"},children:[r.jsx(vt,{name:A.title?.trim()?.charAt(0)||"Г",id:A.id,avatarUrl:rn??A.avatarUrl??void 0,size:60}),r.jsxs("div",{children:[r.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)"},children:A.title||"Группа"}),r.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Нажмите, чтобы изменить аватар"})]})]}),r.jsx("input",{ref:Wo,type:"file",accept:"image/*",onChange:i=>{const o=i.target.files?.[0];if(o){ci(o);try{ai(URL.createObjectURL(o))}catch{}}},style:{display:"none"}}),!rn&&r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{marginBottom:8,color:"var(--text-muted)",fontSize:12,fontWeight:500},children:"Загрузка аватара"}),r.jsxs("div",{onClick:()=>Wo.current?.click(),onDragOver:i=>{i.preventDefault(),pa(!0)},onDragLeave:()=>pa(!1),onDrop:i=>{i.preventDefault(),pa(!1);const o=i.dataTransfer.files?.[0];if(o){ci(o);try{ai(URL.createObjectURL(o))}catch{}}},style:{border:"2px dashed "+(Fo?"var(--brand-600)":"var(--surface-border)"),borderRadius:12,padding:20,display:"flex",alignItems:"center",justifyContent:"center",gap:10,cursor:"pointer",background:Fo?"rgba(217,119,6,0.1)":"var(--surface-100)",transition:"all .2s ease",marginBottom:16},children:[r.jsx(Ua,{size:18,color:"var(--text-muted)"}),r.jsx("div",{style:{color:"var(--text-muted)",fontSize:14},children:"Перетащите файл сюда или нажмите, чтобы выбрать"})]})]}),rn&&r.jsxs("div",{style:{border:"1px solid var(--surface-border)",borderRadius:16,padding:16,marginTop:16,background:"var(--surface-100)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[r.jsx("div",{style:{fontSize:14,color:"var(--text-primary)",marginBottom:12,fontWeight:600},children:"Настройка аватара"}),r.jsxs("div",{ref:Jn,onWheel:i=>{i.preventDefault();const o=-i.deltaY*.001,f=Math.max(.1,Math.min(10,qe.scale*(1+o))),c=Jn.current?.getBoundingClientRect();if(c){const m=i.clientX-c.left,h=i.clientY-c.top,g=f/qe.scale,b=m-(m-qe.x)*g,v=h-(h-qe.y)*g;En({x:b,y:v,scale:f})}},onPointerDown:i=>{if(i.pointerType==="touch")return;const o=Jn.current?.getBoundingClientRect();if(!o)return;const f=o.width,c=o.height,m=f/2,h=c/2,b=240/2,v=i.clientX-o.left,k=i.clientY-o.top,R=v-m,I=k-h;if(R*R+I*I>b*b)return;try{i.currentTarget.setPointerCapture?.(i.pointerId)}catch{}const E=i.clientX,D=i.clientY,T={...qe},$=Z=>{Z.preventDefault();const ye=Z.clientX-E,xe=Z.clientY-D;En({...T,x:T.x+ye,y:T.y+xe})},K=()=>{window.removeEventListener("pointermove",$),window.removeEventListener("pointerup",K)};window.addEventListener("pointermove",$,{passive:!1}),window.addEventListener("pointerup",K,{passive:!0})},style:{position:"relative",width:"100%",height:320,background:"var(--surface-200)",overflow:"hidden",borderRadius:12,touchAction:"none",border:"1px solid var(--surface-border)",boxShadow:"inset 0 2px 8px rgba(0,0,0,0.1)",cursor:"move"},children:[r.jsx("img",{ref:si,src:rn,alt:"preview",style:{position:"absolute",left:qe.x,top:qe.y,transform:`scale(${qe.scale})`,transformOrigin:"top left",willChange:"transform",pointerEvents:"none"},draggable:!1,onLoad:i=>{const o=i.currentTarget,f=Jn.current;if(!f)return;const c=f.clientWidth,m=f.clientHeight,h=240,g=o.naturalWidth,b=o.naturalHeight,v=c/2,k=m/2,R=h/g,I=h/b,E=Math.max(R,I)*1.2,D=v-g*E/2,T=k-b*E/2;En({x:D,y:T,scale:E})}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",boxShadow:"0 0 0 9999px rgba(0,0,0,0.65)",width:240,height:240,margin:"auto",border:"2px solid rgba(255,255,255,0.3)",boxSizing:"border-box"}}),r.jsx("div",{style:{position:"absolute",inset:0,pointerEvents:"none",borderRadius:"50%",width:240,height:240,margin:"auto",background:`
                    linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px)
                  `,backgroundSize:"60px 60px",opacity:.5}})]}),r.jsxs("div",{style:{marginTop:16},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[r.jsx("div",{style:{fontSize:13,color:"var(--text-muted)",fontWeight:500},children:"Масштаб"}),r.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",background:"var(--surface-200)",padding:"4px 8px",borderRadius:6},children:[Math.round(qe.scale*100),"%"]})]}),r.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",gap:12},children:[r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>En(i=>({...i,scale:Math.max(.1,i.scale-.1)})),children:"−"}),r.jsx("input",{type:"range",min:.1,max:10,step:.01,value:qe.scale,onChange:i=>{const o=parseFloat(i.target.value);En(f=>{const c=Jn.current?.getBoundingClientRect();if(!c)return{...f,scale:o};const m=c.width,h=c.height,g=m/2,b=h/2,v=si.current;if(v){const k=v.naturalWidth,R=v.naturalHeight,I=f.x+k*f.scale/2,E=f.y+R*f.scale/2,D=I-g,T=E-b,$=o/f.scale,K=g+D*$,Z=b+T*$,ye=K-k*o/2,xe=Z-R*o/2;return{x:ye,y:xe,scale:o}}return{...f,scale:o}})},style:{flex:1,height:6,background:"var(--surface-200)",borderRadius:3,outline:"none",cursor:"pointer"}}),r.jsx("div",{style:{fontSize:18,color:"var(--text-muted)",cursor:"pointer",userSelect:"none"},onClick:()=>En(i=>({...i,scale:Math.min(10,i.scale+.1)})),children:"+"})]})]}),r.jsx("canvas",{ref:ii,width:240,height:240,style:{display:"none"}})]}),oi&&r.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16},children:[r.jsx("button",{className:"btn btn-secondary",onClick:()=>{ci(null),rn&&URL.revokeObjectURL(rn),ai(null),En({x:0,y:0,scale:1})},children:"Отмена"}),r.jsx("button",{className:"btn btn-primary",disabled:$r,onClick:async()=>{if(!(!oi||!A)){Js(!0),ri(0);try{let i=null;if(ii.current&&rn){const c=await new Promise(T=>{const $=new Image;$.onload=()=>T($),$.src=rn}),m=ii.current.getContext("2d");if(!m)throw new Error("Could not get 2d context from canvas");const h=240;m.clearRect(0,0,h,h),m.save(),m.beginPath(),m.arc(h/2,h/2,h/2,0,Math.PI*2),m.closePath(),m.clip();const g=Jn.current?.clientWidth??320,b=Jn.current?.clientHeight??320,v={x:g/2,y:b/2},k={x:v.x-h/2,y:v.y-h/2,w:h,h},R=(k.x-qe.x)/qe.scale,I=(k.y-qe.y)/qe.scale,E=k.w/qe.scale,D=k.h/qe.scale;m.drawImage(c,R,I,E,D,0,0,h,h),m.restore(),i=await new Promise(T=>ii.current.toBlob($=>T($),"image/png"))}if(!i&&!oi)throw new Error("No file to upload");const o=new FormData;o.append("file",i??oi);const f=await new Promise((c,m)=>{const h=new XMLHttpRequest;h.open("POST","/api/upload");try{const g=or.getState().session?.accessToken;g&&h.setRequestHeader("Authorization",`Bearer ${g}`)}catch{}h.upload.onprogress=g=>{g.lengthComputable&&ri(Math.round(100*g.loaded/g.total))},h.onreadystatechange=()=>{if(h.readyState===4)if(h.status>=200&&h.status<300)try{const g=JSON.parse(h.responseText);c(g.url)}catch(g){m(g)}else m(new Error(`upload failed: ${h.status} ${h.statusText}`))},h.onerror=()=>{m(new Error("Network error during upload"))},h.send(o)});await ae.patch(`/conversations/${A.id}`,{avatarUrl:f}),ne.setQueryData(["conversations"],c=>Array.isArray(c)?c.map(m=>m.conversation?.id===A.id?{...m,conversation:{...m.conversation,avatarUrl:f}}:m):c),ne.invalidateQueries({queryKey:["conversations"]}),await pe.refetch(),ci(null),rn&&URL.revokeObjectURL(rn),ai(null),En({x:0,y:0,scale:1}),ot(!1),Hr("Готово"),setTimeout(()=>Hr(null),2200)}catch(i){console.error("Error uploading group avatar:",i),Hr(`Ошибка: ${i instanceof Error?i.message:"Неизвестная ошибка"}`),setTimeout(()=>Hr(null),3e3)}finally{Js(!1)}}},children:$r?"Загрузка...":"Загрузить"})]}),$r&&r.jsx("div",{style:{height:6,background:"var(--surface-100)",borderRadius:3,overflow:"hidden",marginTop:12},children:r.jsx("div",{style:{width:`${Uo}%`,height:"100%",background:"var(--brand)",transition:"width 0.2s ease"}})}),li&&r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:12,color:"#16a34a"},children:[r.jsx(io,{size:16}),r.jsx("span",{children:li})]})]})}),Ce&&r.jsx(rp,{isOpen:!!Ce,conversationId:Ce.conversationId,viewerId:P?.id??"me",peerId:Ce.peerId,peerName:Ce.peerName,viewerTimeZone:P?.timezone??P?.timeZone??Ka(),peerTimeZone:Ce.peerTimeZone??Ka(),onClose:()=>et(null)})]})}function jl(t){return(t??[]).map(e=>e.user.id).sort().join(",")}const Pp=Object.freeze(Object.defineProperty({__proto__:null,default:Lp},Symbol.toStringTag,{value:"Module"}));export{Pp as C,Zt as X,Zi as c};
