import{r as n,j as L}from"./vendor-query-D8-W16Rz.js";import{u as J,K as ae,i as H,H as oe,c as le,I as se}from"./index-BsoneBeU.js";import{W as ce,a as ie,z as ue,d as de}from"./index-CD81hMhF.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-socket-CA1CrNgP.js";import"./vendor-crypto-C7xP7Q7Y.js";if(typeof window<"u"&&typeof navigator<"u"&&navigator.mediaDevices&&!window.__eblushaEnumeratePatched){const p=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=async()=>{const a=await p(),C=navigator.userAgent||"";if(!/iP(ad|hone|od)/i.test(C))return a;const l=[],u=[],k=[],E=(t,c)=>{const y=t.toLowerCase();return/(front|перед|selfie|true depth|ultra wide front)/.test(y)?"front":/(back|rear|зад|tele|wide|камера на задней панели|камера на задней|задняя)/.test(y)||/(back|rear)/.test(c.toLowerCase())?"back":"other"};a.forEach(t=>{if(t.kind!=="videoinput"){k.push(t);return}const c=E(t.label||"",t.deviceId||"");c==="front"?l.push(t):u.push(t)});const m=[];if(l.length>0&&m.push(l[0]),u.length>0&&m.push(u[0]),m.length===0&&a.some(t=>t.kind==="videoinput")){const t=a.find(c=>c.kind==="videoinput");t&&m.push(t)}return k.forEach(t=>{t.kind!=="videoinput"&&m.push(t)}),m},window.__eblushaEnumeratePatched=!0}function fe({conversationId:p,isGroup:a,onPeerDisconnected:C}){const i=ue(),l=de(),u=J(c=>c.session?.user),k=n.useRef(!1),E=n.useRef(!1),m=n.useRef(null),t=n.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null)},[]);return n.useEffect(()=>{if(!i||!u)return;const c=()=>{k.current=!0,E.current=!1},y=()=>{k.current=!1,E.current=!1};return i.on("connected",c),i.on("disconnected",y),()=>{i.off("connected",c),i.off("disconnected",y)}},[i,u]),n.useEffect(()=>{if(!i||!k.current||!u)return;const c=i.localParticipant;if(!c)return;const y=l.filter(A=>{if(A.identity===c.identity||A.sid===c.sid)return!1;try{return(A.metadata?JSON.parse(A.metadata):{}).userId!==u.id}catch{return!0}});y.length>0&&(E.current=!0,t()),y.length===0&&l.length>0&&i.state==="connected"&&E.current&&(a||l.length===1&&(m.current||(m.current=window.setTimeout(()=>{m.current=null;try{Array.from(i.remoteParticipants.values()).filter(R=>{const q=i.localParticipant;if(!q)return!0;if(R.sid===q.sid||R.identity===q.identity)return!1;try{return(R.metadata?JSON.parse(R.metadata):{}).userId!==u.id}catch{return!0}}).length===0&&(console.log("[CallOverlay] Peer disconnected in 1:1 call, ending call after grace period"),E.current=!1,C())}catch{console.log("[CallOverlay] Peer disconnect timer fired but room metadata unavailable"),C()}},4e3))))},[l,i,u,a,C,t]),n.useEffect(()=>()=>{t()},[t]),null}function we({open:p,conversationId:a,onClose:C,onMinimize:i,minimized:l=!1,initialVideo:u=!1,initialAudio:k=!0,peerAvatarUrl:E=null,avatarsByName:m={},avatarsById:t={},localUserId:c=null,isGroup:y=!1}){const[A,T]=n.useState(null),[R,q]=n.useState(null),[B,K]=n.useState(!k),[X,Q]=n.useState(!!u),[he,Y]=n.useState(()=>typeof window<"u"?window.innerWidth>768:!0),[F,_]=n.useState(!1),N=J(e=>e.session?.user),M=n.useRef(!1),W=n.useMemo(()=>N?.avatarUrl??null,[N?.avatarUrl]),O=n.useCallback(()=>{if(M.current||(M.current=!0),a&&y){try{ae(a)}catch(e){console.error("Error leaving call room:",e)}try{H([a])}catch(e){console.error("Error requesting call status update:",e)}}C()},[a,y,C]),Z=`
    /* Force videos to fit tile without cropping on all layouts */
    .call-container video { object-fit: contain !important; background: #000 !important; }
    .call-container .lk-participant-tile video,
    .call-container .lk-participant-media video,
    .call-container .lk-video-tile video,
    .call-container .lk-stage video,
    .call-container .lk-grid-stage video { object-fit: contain !important; background: #000 !important; }
  `;if(n.useEffect(()=>{let e=!0;async function v(){if(!p||!a)return;const w=`conv-${a}`,S=await le.post("/livekit/token",{room:w,participantMetadata:{app:"eblusha",userId:N?.id,displayName:N?.displayName??N?.username,avatarUrl:W}});e&&(T(S.data.token),q(S.data.url))}return v(),()=>{e=!1,T(null),q(null)}},[p,a]),n.useEffect(()=>{p&&(Q(!!u),K(!k),_(!1))},[p,u,k]),n.useEffect(()=>{if(!p)return;if(typeof window<"u"&&window.innerWidth<=768){const v=document.body.style.overflow,w=document.body.style.touchAction;return document.body.style.overflow="hidden",document.body.style.touchAction="none",()=>{document.body.style.overflow=v,document.body.style.touchAction=w}}},[p]),n.useEffect(()=>{p||(M.current=!1)},[p]),n.useEffect(()=>{const e=()=>Y(typeof window<"u"?window.innerWidth>768:!0);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{if(!p)return;const e=document.body;if(!e)return;const v=()=>{e.querySelectorAll(".call-container [aria-label], .call-container [title]").forEach(r=>{const d=r.getAttribute("aria-label")||r.getAttribute("title")||"";let s="";const f=d.toLowerCase();f.includes("microphone")?s=d.includes("mute")?"Выключить микрофон":"Включить микрофон":f.includes("camera")?s=d.includes("disable")||f.includes("off")?"Выключить камеру":"Включить камеру":f.includes("screen")?s=f.includes("stop")?"Остановить показ экрана":"Поделиться экраном":f.includes("flip")?s="Сменить камеру":f.includes("participants")?s="Участники":f.includes("settings")?s="Настройки":f.includes("leave")||f.includes("hang")?s="Выйти":f.includes("chat")&&(s="Чат"),s&&(r.setAttribute("aria-label",s),r.setAttribute("title",s))}),e.querySelectorAll('.call-container .lk-chat, .call-container [data-lk-chat], .call-container [data-lk-chat-toggle], .call-container .lk-chat-toggle, .call-container .lk-button.lk-chat-toggle, .call-container button.lk-chat-toggle, .call-container [aria-label*="chat" i], .call-container [title*="chat" i]').forEach(r=>{const d=r;d.style.display="none";try{d.remove()}catch{}});const P=e.querySelector(".call-container .lk-control-bar, .call-container [data-lk-control-bar]");if(P&&i){let r=P.querySelector(".eb-minimize-btn");if(!r){r=document.createElement("button"),r.className="eb-minimize-btn lk-button",r.setAttribute("aria-label","Свернуть"),r.setAttribute("title","Свернуть"),r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',r.style.cssText="display: flex; align-items: center; justify-content: center; background: var(--surface-100); color: var(--text-primary); border: 1px solid var(--surface-border); border-radius: 8px; padding: 8px; cursor: pointer; transition: background 0.2s ease;",r.onmouseenter=()=>{r.style.background="var(--surface-200)"},r.onmouseleave=()=>{r.style.background="var(--surface-100)"},r.onclick=s=>{s.stopPropagation(),i()};const d=P.querySelector('[aria-label*="Выйти" i], [title*="Выйти" i], [aria-label*="leave" i], [title*="leave" i]');if(d&&d.parentNode){if(!d.__ebLeaveBound){const s=()=>{setTimeout(()=>O(),0)};d.addEventListener("click",s),d.__ebLeaveBound=s}d.parentNode.insertBefore(r,d)}else P.appendChild(r)}}},w=new MutationObserver(()=>v());return w.observe(e,{childList:!0,subtree:!0,attributes:!0}),v(),()=>w.disconnect()},[p,i,O]),n.useEffect(()=>{if(!p)return;const e=document.body;if(!e)return;const v=m||{},w=t||{},S=c||null,I=W||null,P=f=>{let h=0;for(let o=0;o<f.length;o++)h=f.charCodeAt(o)+((h<<5)-h);return`hsl(${Math.abs(h)%360} 70% 45%)`},r=(f,h)=>{const U=P(h),o=f.trim().charAt(0).toUpperCase(),D=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><defs/><rect width="256" height="256" rx="128" fill="${U}"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="140" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif" fill="#ffffff">${o}</text></svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(D)}`},d=()=>{e.querySelectorAll(".call-container .lk-participant-tile, .call-container [data-participant]").forEach(h=>{const U=h.querySelector(".lk-participant-name, [data-lk-participant-name]"),o=h.querySelector(".lk-participant-placeholder");if(!U||!o)return;const D=h.getAttribute("data-lk-participant-identity")?h:h.querySelector("[data-lk-participant-identity]"),j=D?(D.getAttribute("data-lk-participant-identity")||"").trim():"";let x=(U.textContent||U.getAttribute("data-lk-participant-name")||"").trim();if(!x){const g=h.querySelector(".lk-participant-metadata");g?.textContent?.trim()&&(x=g.textContent.trim())}x||(x=j||"");const V=j?w[j]??null:null,$=Object.keys(v).find(g=>g.toLowerCase()===x.toLowerCase()),G=$?v[$]:null,ee=I,te=!!(h.hasAttribute("data-lk-local-participant")||h.hasAttribute("data-lk-local")||h.classList.contains("lk-local-participant")||h.querySelector(".lk-local-indicator")||/\b(you|вы)\b/i.test(x)||j&&S&&j===S);let re=V??G??(te?ee||(S?w[S]??null:null):null);const ne=r(x||j||"U",j||x||"U");o.querySelectorAll("svg").forEach(g=>g.remove()),o.querySelectorAll("svg").forEach(g=>g.style.display="none");let b=o.querySelector("img.eb-ph");b||(b=document.createElement("img"),b.className="eb-ph",o.appendChild(b)),b.src=re||ne,b.alt=x,b.style.width="auto",b.style.height="auto",b.style.maxWidth="85%",b.style.maxHeight="85%",b.style.objectFit="cover",b.style.borderRadius="50%",b.style.display="block",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background="transparent",o.style.backgroundImage="none",o.style.color="transparent",o.style.fontSize="0",o.style.overflow="hidden";try{o.style.borderRadius="50%"}catch{}Array.from(o.childNodes).forEach(g=>{g.nodeType===Node.TEXT_NODE&&(g.textContent="")})})},s=new MutationObserver(d);return s.observe(e,{childList:!0,subtree:!0}),d(),()=>s.disconnect()},[p,m,t,c,W]),!p||!a||!A||!R)return null;const z=L.jsx("div",{className:"call-overlay",style:{position:"fixed",inset:0,background:l?"transparent":"rgba(10,12,16,0.55)",backdropFilter:l?"none":"blur(4px) saturate(110%)",display:l?"none":"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,pointerEvents:l?"none":"auto"},children:L.jsxs("div",{"data-lk-theme":"default",style:{width:l?0:"90vw",height:l?0:"80vh",maxWidth:l?0:1200,background:"var(--surface-200)",borderRadius:16,overflow:"hidden",position:"relative",border:"1px solid var(--surface-border)",boxShadow:l?"none":"var(--shadow-sharp)",opacity:l?0:1,visibility:l?"hidden":"visible"},className:"call-container",children:[L.jsx("style",{children:Z}),L.jsxs(ce,{serverUrl:R,token:A,connect:!0,video:X,audio:!B,onConnected:()=>{_(!0);try{a&&y&&(console.log("[CallOverlay] joinCallRoom emit",{conversationId:a,video:u}),se(a,u),H([a]))}catch(e){console.error("Error joining call room:",e)}},onDisconnected:e=>{console.log("[CallOverlay] onDisconnected:",e,"wasConnected:",F,"isGroup:",y);const v=F;_(!1),v?O():y||O()},children:[L.jsx(fe,{conversationId:a,isGroup:y,onPeerDisconnected:()=>{O()}}),L.jsx("div",{style:{width:"100%",height:"100%"},children:L.jsx(ie,{})})]})]})});return oe.createPortal(z,document.body)}export{we as CallOverlay};
