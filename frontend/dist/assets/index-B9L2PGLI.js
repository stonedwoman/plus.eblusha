const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-kshTkOc2.js","assets/index-R_ngyLch.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/web-A7cFZfch.js","assets/incoming-call-plugin.web-CZ3R_KSb.js"])))=>i.map(i=>d[i]);
import{l as A}from"./vendor-socket-CA1CrNgP.js";import{r as m,_ as p,C as r}from"./index-R_ngyLch.js";import"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-crypto-C7xP7Q7Y.js";class b{socket=null;wsUrl;accessToken=null;reconnectAttempts=0;maxReconnectAttempts=10;isManuallyDisconnected=!1;constructor(e){this.wsUrl=e}connect(e){if(this.socket?.connected){console.log("[SocketService] Already connected");return}if(this.socket&&!this.socket.connected&&(console.log("[SocketService] Reconnecting existing socket..."),this.socket.disconnect(),this.socket=null),this.accessToken=e,this.isManuallyDisconnected=!1,console.log("[SocketService] Connecting to:",this.wsUrl),console.log("[SocketService] Token length:",e?.length||0),this.socket=A(this.wsUrl,{autoConnect:!1,transports:["websocket","polling"],auth:{token:e},query:{token:e},reconnection:!0,reconnectionAttempts:this.maxReconnectAttempts,reconnectionDelay:1e3,reconnectionDelayMax:1e4,randomizationFactor:.5,timeout:2e4}),this.socket.io){const t=this.socket.io;t.opts&&(t.opts.pingTimeout=6e4,t.opts.pingInterval=25e3)}this.setupEventHandlers(),this.socket.connect(),console.log("[SocketService] Connection initiated")}disconnect(){this.isManuallyDisconnected=!0,this.socket&&(this.socket.disconnect(),this.socket=null),this.accessToken=null,this.reconnectAttempts=0}reconnect(){if(!this.accessToken){console.warn("[SocketService] Cannot reconnect: no access token");return}if(this.socket?.connected){console.log("[SocketService] Already connected, skipping reconnect");return}console.log("[SocketService] Manual reconnect requested"),this.isManuallyDisconnected=!1,this.socket?this.socket.connect():this.connect(this.accessToken)}updateToken(e){this.accessToken=e,this.socket&&(this.socket.auth={token:e},this.socket.io.opts.query={token:e})}isConnected(){return this.socket?.connected??!1}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{console.log("[SocketService] ‚úÖ Connected successfully"),this.reconnectAttempts=0}),this.socket.on("disconnect",e=>{console.log("[SocketService] ‚ùå Disconnected:",e),!this.isManuallyDisconnected&&e!=="io server disconnect"&&console.log("[SocketService] Will attempt to reconnect...")}),this.socket.on("connect_error",e=>{console.error("[SocketService] ‚ùå Connection error:",e),console.error("[SocketService] Error message:",e.message),this.isManuallyDisconnected||(this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&console.error("[SocketService] Max reconnect attempts reached"))}),this.socket.io.on("reconnect",e=>{console.log(`[SocketService] ‚úÖ Reconnected after ${e} attempts`),this.reconnectAttempts=0}),this.socket.io.on("reconnect_attempt",e=>{console.log(`[SocketService] üîÑ Reconnect attempt ${e}/${this.maxReconnectAttempts}`),this.accessToken&&(this.socket.auth={token:this.accessToken},this.socket.io.opts.query={token:this.accessToken})}),this.socket.io.on("reconnect_error",e=>{console.error("[SocketService] ‚ùå Reconnect error:",e)}),this.socket.io.on("reconnect_failed",()=>{console.error("[SocketService] ‚ùå Reconnect failed after all attempts")}))}onMessageNew(e){return this.socket?(this.socket.on("message:new",e),()=>this.socket?.off("message:new",e)):()=>{}}onMessageNotify(e){return this.socket?(this.socket.on("message:notify",e),()=>this.socket?.off("message:notify",e)):()=>{}}onConversationTyping(e){return this.socket?(this.socket.on("conversation:typing",e),()=>this.socket?.off("conversation:typing",e)):()=>{}}onMessageReaction(e){return this.socket?(this.socket.on("message:reaction",e),()=>this.socket?.off("message:reaction",e)):()=>{}}onReceiptsUpdate(e){return this.socket?(this.socket.on("receipts:update",e),()=>this.socket?.off("receipts:update",e)):()=>{}}onConversationNew(e){return this.socket?(this.socket.on("conversations:new",e),()=>this.socket?.off("conversations:new",e)):()=>{}}onConversationUpdated(e){return this.socket?(this.socket.on("conversations:updated",e),()=>this.socket?.off("conversations:updated",e)):()=>{}}onConversationDeleted(e){return this.socket?(this.socket.on("conversations:deleted",e),()=>this.socket?.off("conversations:deleted",e)):()=>{}}onConversationMemberRemoved(e){return this.socket?(this.socket.on("conversations:member:removed",e),()=>this.socket?.off("conversations:member:removed",e)):()=>{}}onPresenceUpdate(e){return this.socket?(this.socket.on("presence:update",e),()=>this.socket?.off("presence:update",e)):()=>{}}onContactRequest(e){return this.socket?(this.socket.on("contacts:request:new",e),()=>this.socket?.off("contacts:request:new",e)):()=>{}}onContactAccepted(e){return this.socket?(this.socket.on("contacts:request:accepted",e),()=>this.socket?.off("contacts:request:accepted",e)):()=>{}}onContactRemoved(e){return this.socket?(this.socket.on("contacts:removed",e),()=>this.socket?.off("contacts:removed",e)):()=>{}}onProfileUpdate(e){return this.socket?(this.socket.on("profile:update",e),()=>this.socket?.off("profile:update",e)):()=>{}}onCallIncoming(e){return this.socket?(this.socket.on("call:incoming",e),()=>this.socket?.off("call:incoming",e)):()=>{}}onCallAccepted(e){return this.socket?(this.socket.on("call:accepted",e),()=>this.socket?.off("call:accepted",e)):()=>{}}onCallDeclined(e){return this.socket?(this.socket.on("call:declined",e),()=>this.socket?.off("call:declined",e)):()=>{}}onCallEnded(e){return this.socket?(this.socket.on("call:ended",e),()=>this.socket?.off("call:ended",e)):()=>{}}onCallStatus(e){return this.socket?(this.socket.on("call:status",e),()=>this.socket?.off("call:status",e)):()=>{}}onCallStatusBulk(e){return this.socket?(this.socket.on("call:status:bulk",e),()=>this.socket?.off("call:status:bulk",e)):()=>{}}emitConversationTyping(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:typing");return}this.socket.emit("conversation:typing",e)}emitCallInvite(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:invite");return}this.socket.emit("call:invite",e)}emitCallAccept(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:accept");return}this.socket.emit("call:accept",e)}emitCallDecline(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:decline");return}this.socket.emit("call:decline",e)}emitCallEnd(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:end");return}this.socket.emit("call:end",e)}emitCallRoomJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:join");return}this.socket.emit("call:room:join",e)}emitCallRoomLeave(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:leave");return}this.socket.emit("call:room:leave",e)}emitCallStatusRequest(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:status:request");return}this.socket.emit("call:status:request",e)}emitConversationJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:join");return}this.socket.emit("conversation:join",e)}}let S=null;function k(n){if(!S){if(!n)throw new Error("SocketService requires wsUrl for first initialization");S=new b(n)}return S}var w;(function(n){n[n.Sunday=1]="Sunday",n[n.Monday=2]="Monday",n[n.Tuesday=3]="Tuesday",n[n.Wednesday=4]="Wednesday",n[n.Thursday=5]="Thursday",n[n.Friday=6]="Friday",n[n.Saturday=7]="Saturday"})(w||(w={}));const d=m("LocalNotifications",{web:()=>p(()=>import("./web-kshTkOc2.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(n=>new n.LocalNotificationsWeb)}),f=m("App",{web:()=>p(()=>import("./web-A7cFZfch.js"),__vite__mapDeps([7,1,2,3,4,5,6])).then(n=>new n.AppWeb)}),N=m("MessageNotification",{web:()=>p(()=>import("./message-notification-plugin.web-JILA9b5W.js"),[]).then(n=>new n.MessageNotificationWeb)});class T{notificationIds=new Set;notificationSources=new Map;conversationNotifications=new Map;isAppActive=!0;isDocumentVisible=typeof document>"u"?!0:!document.hidden;useMessagePlugin=!1;appStateWarningLogged=!1;hasInitialAppState=!1;async initialize(){console.log("[NotificationService] üöÄ Initializing notification service...");const e=await d.checkPermissions();if(console.log("[NotificationService] Current permission:",e.display),e.display!=="granted"){console.log("[NotificationService] Requesting notification permission...");const a=await d.requestPermissions();if(console.log("[NotificationService] Permission result:",a.display),a.display!=="granted"){console.warn("[NotificationService] ‚ùå Notification permission not granted");return}}console.log("[NotificationService] ‚úÖ Notification permission granted");const t=typeof r.getPlatform=="function"?r.getPlatform():"web",o=typeof r.isNativePlatform=="function"?r.isNativePlatform():t!=="web",c=typeof r.isPluginAvailable=="function"?r.isPluginAvailable("MessageNotification"):!1;this.useMessagePlugin=o&&c,console.log("[NotificationService] MessageNotification plugin available:",this.useMessagePlugin),t==="android"&&await this.configureChannels();try{const a=await f.getState();this.isAppActive=a.isActive,this.hasInitialAppState=!0,console.log("[NotificationService] Initial app state:",a.isActive?"active":"background")}catch(a){this.hasInitialAppState=!0,console.warn('[NotificationService] Failed to read initial app state, using default "active" state',a)}typeof document<"u"&&(this.isDocumentVisible=!document.hidden,document.addEventListener("visibilitychange",()=>{this.isDocumentVisible=!document.hidden,console.log("[NotificationService] Document visibility changed:",this.isDocumentVisible?"visible":"hidden"),this.isDocumentVisible&&this.isAppActive&&this.onAppBecameActive()})),f.addListener("appStateChange",a=>{this.isAppActive=a.isActive,this.hasInitialAppState=!0,console.log("[NotificationService] appStateChange event:",a.isActive?"active":"background"),a.isActive&&this.onAppBecameActive()}),f.addListener("pause",()=>{this.isAppActive=!1,this.hasInitialAppState=!0,console.log("[NotificationService] pause event received, marking app as background")}),f.addListener("resume",()=>{this.isAppActive=!0,this.hasInitialAppState=!0,console.log("[NotificationService] resume event received, marking app as active"),this.onAppBecameActive()}),d.addListener("localNotificationActionPerformed",a=>{const u=a.notification.extra;u?.conversationId&&console.log("[NotificationService] Notification clicked, opening conversation:",u.conversationId)})}async showMessageNotification(e,t,o,c){console.log("[NotificationService] üì® showMessageNotification called:",{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,messageText:t,senderName:o});const a=await this.isInForeground();if(console.log("[NotificationService] Foreground status:",a?"active":"background",JSON.stringify({appActive:this.isAppActive,documentVisible:this.isDocumentVisible})),a){console.log("[NotificationService] App is active, skipping notification");return}const u=e.conversationId,s=Date.now()%2147483647,i=this.conversationNotifications.get(u);i&&await this.cancelMessageNotifications([i]);const l=o||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",h=t||"–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";console.log("[NotificationService] üì§ Scheduling notification:",{notificationId:s,title:l,body:h,conversationId:u}),await this.pushNativeNotification({id:s,conversationId:u,senderId:e.senderId,messageId:e.messageId,title:l,body:h,avatarUrl:c})}async showIncomingCallNotification(e,t,o,c){const a=Date.now()%2147483647,u=o?"–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫":"–∑–≤–æ–Ω–æ–∫";return await d.schedule({notifications:[{title:`–í—Ö–æ–¥—è—â–∏–π ${u}`,body:`${t} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`,id:a,channelId:"calls",sound:"ring.mp3",ongoing:!0,extra:{conversationId:e,callType:o?"video":"audio",callerName:t,avatarUrl:c},actionTypeId:"INCOMING_CALL"}]}),this.notificationIds.add(a),this.notificationSources.set(a,"call"),a}async cancelCallNotification(e){await d.cancel({notifications:[{id:e}]}),this.notificationIds.delete(e),this.notificationSources.delete(e)}async cancelConversationNotifications(e){const t=this.conversationNotifications.get(e);t&&(await this.cancelMessageNotifications([t]),this.notificationIds.delete(t),this.notificationSources.delete(t),this.conversationNotifications.delete(e))}async clearAll(){const e=[],t=[];for(const o of this.notificationIds)this.notificationSources.get(o)==="call"?t.push(o):e.push(o);await this.cancelMessageNotifications(e),t.length>0&&await d.cancel({notifications:t.map(o=>({id:o}))}),this.notificationIds.clear(),this.notificationSources.clear(),this.conversationNotifications.clear()}handleNotificationClick(e){console.log("[NotificationService] Notification clicked:",e)}onAppBecameActive(){console.log("[NotificationService] App became active")}async pushNativeNotification(e){try{const t=await this.scheduleMessageNotification(e);this.notificationIds.add(e.id),this.notificationSources.set(e.id,t==="plugin"?"message-plugin":"message-local"),this.conversationNotifications.set(e.conversationId,e.id),console.log("[NotificationService] ‚úÖ Native notification shown via",t==="plugin"?"MessageNotification plugin":"LocalNotifications")}catch(t){console.error("[NotificationService] ‚ùå Failed to show native notification:",t)}}async scheduleMessageNotification(e){if(this.useMessagePlugin)try{return await N.show({id:e.id,conversationId:e.conversationId,senderName:e.title,messageText:e.body,avatarUrl:e.avatarUrl}),"plugin"}catch(t){console.warn("[NotificationService] ‚ö†Ô∏è MessageNotification plugin failed, falling back to LocalNotifications",t),this.useMessagePlugin=!1}return await this.scheduleViaLocalNotifications(e),"local"}async scheduleViaLocalNotifications(e){await d.schedule({notifications:[{title:e.title,body:e.body,largeBody:e.body.length>120?e.body:void 0,id:e.id,channelId:"messages",sound:void 0,ongoing:!1,autoCancel:!0,extra:{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,avatarUrl:e.avatarUrl},actionTypeId:"MESSAGE"}]})}async configureChannels(){if((typeof r.getPlatform=="function"?r.getPlatform():"web")==="android")try{await d.createChannel({id:"messages",name:"–°–æ–æ–±—â–µ–Ω–∏—è",description:"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö",importance:4,visibility:1,lights:!0,vibration:!0}),await d.createChannel({id:"calls",name:"–ó–≤–æ–Ω–∫–∏",description:"–í—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏",importance:5,visibility:1,sound:"ring.mp3",vibration:!0}),console.log("[NotificationService] ‚úÖ Notification channels configured")}catch(t){console.warn("[NotificationService] ‚ö†Ô∏è Failed to configure notification channels",t)}}async cancelMessageNotifications(e){if(e.length===0)return;const t=[],o=[];if(e.forEach(c=>{this.notificationSources.get(c)==="message-plugin"?t.push(c):o.push(c)}),t.length>0)try{await N.cancel({ids:t})}catch(c){console.warn("[NotificationService] ‚ö†Ô∏è Failed to cancel plugin notifications",c)}o.length>0&&await d.cancel({notifications:o.map(c=>({id:c}))})}async isInForeground(){try{const e=await f.getState();this.isAppActive=e.isActive,this.hasInitialAppState=!0,this.appStateWarningLogged=!1}catch(e){this.appStateWarningLogged||(console.warn("[NotificationService] ‚ö†Ô∏è Failed to get current App state, falling back to cached value",e),this.appStateWarningLogged=!0),this.hasInitialAppState=!0}return typeof document<"u"&&(this.isDocumentVisible=!document.hidden),this.isAppActive&&this.isDocumentVisible}}let C=null;function I(){return C||(C=new T),C}class M{socketService=k();notificationService=I();callbacks;typingTimers=new Map;constructor(e){this.callbacks=e}initialize(){console.log("[MessageHandler] üöÄ Initializing message handlers...");const e=[],t=this.socketService.onMessageNew(async s=>{console.log("[MessageHandler] üì® message:new:",s),this.callbacks.isConversationActive?.(s.conversationId)??!1?this.callbacks.onMessageReceived?.(s):this.callbacks.onConversationUpdated?.(s.conversationId)});e.push(t);const o=this.socketService.onMessageNotify(async s=>{console.log("[MessageHandler] üîî message:notify:",s);const i=this.callbacks.isConversationActive?.(s.conversationId)??!1;i||await this.handleMessageNotification(s),i&&s.message&&this.callbacks.onMessageReceived?.(s),this.callbacks.onConversationUpdated?.(s.conversationId)});e.push(o);const c=this.socketService.onConversationTyping(s=>{console.log("[MessageHandler] conversation:typing:",s);const i=`${s.conversationId}_${s.userId}`,l=this.typingTimers.get(i);if(l&&clearTimeout(l),s.typing){this.callbacks.onTypingUpdate?.(s.conversationId,s.userId,!0);const h=setTimeout(()=>{this.callbacks.onTypingUpdate?.(s.conversationId,s.userId,!1),this.typingTimers.delete(i)},2e3);this.typingTimers.set(i,h)}else this.callbacks.onTypingUpdate?.(s.conversationId,s.userId,!1),this.typingTimers.delete(i)});e.push(c);const a=this.socketService.onMessageReaction(async s=>{console.log("[MessageHandler] message:reaction:",s),this.callbacks.isConversationActive?.(s.conversationId)??!1?s.message&&this.callbacks.onMessageReceived?.(s):this.callbacks.onConversationUpdated?.(s.conversationId)});e.push(a);const u=this.socketService.onReceiptsUpdate(s=>{console.log("[MessageHandler] receipts:update:",s),this.callbacks.isConversationActive?.(s.conversationId)});return e.push(u),console.log("[MessageHandler] ‚úÖ All handlers subscribed, total:",e.length),()=>{console.log("[MessageHandler] Unsubscribing all handlers"),e.forEach(s=>s()),this.typingTimers.forEach(s=>clearTimeout(s)),this.typingTimers.clear()}}async handleMessageNotification(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId,{senderId:e.senderId,messageId:e.messageId});let o=this.getMessagePreview(e);o||(o=t?.messageText||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");const c=t?.senderName||t?.title||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",a=t?.avatarUrl;await this.notificationService.showMessageNotification(e,o,c,a)}catch(t){console.error("[MessageHandler] Error handling message notification:",t)}}sendTyping(e,t){this.socketService.emitConversationTyping({conversationId:e,typing:t})}getMessagePreview(e){if(e.message){if(e.message.content)return e.message.content;if(e.message.attachments?.length)return e.message.attachments[0].type==="IMAGE"?"üì∑ –§–æ—Ç–æ":"üìé –í–ª–æ–∂–µ–Ω–∏–µ"}return null}}const g=m("IncomingCall",{web:()=>p(()=>import("./incoming-call-plugin.web-CZ3R_KSb.js"),__vite__mapDeps([8,1,2,3,4,5,6])).then(n=>new n.IncomingCallWeb)});class y{socketService=k();notificationService=I();callbacks;activeIncomingCalls=new Map;callNotificationIds=new Map;autoDeclineTimers=new Map;useNativeIncomingCallUi;constructor(e){this.callbacks=e;const t=typeof r.isNativePlatform=="function"?r.isNativePlatform():r.getPlatform()!=="web",o=typeof r.isPluginAvailable=="function"?r.isPluginAvailable("IncomingCall"):!1;this.useNativeIncomingCallUi=t&&o}initialize(){r.isNativePlatform()&&typeof g.ensurePermissions=="function"&&(g.ensurePermissions().catch(i=>{console.warn("[CallHandler] Failed to ensure call permissions",i)}),typeof g.ensureBackgroundExecution=="function"&&g.ensureBackgroundExecution().catch(i=>{console.warn("[CallHandler] Failed to ensure background execution permission",i)}));const e=[],t=this.socketService.onCallIncoming(async i=>{console.log("[CallHandler] üìû call:incoming:",i),this.activeIncomingCalls.set(i.conversationId,i),await this.handleIncomingCall(i);const l=setTimeout(()=>{console.log("[CallHandler] Auto-declining call after 25 seconds"),this.declineCall(i.conversationId)},25e3);this.autoDeclineTimers.set(i.conversationId,l),this.callbacks.onIncomingCall?.(i)});e.push(t);const o=this.socketService.onCallAccepted(i=>{console.log("[CallHandler] call:accepted:",i);const l=this.autoDeclineTimers.get(i.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallAccepted?.(i)});e.push(o);const c=this.socketService.onCallDeclined(i=>{console.log("[CallHandler] call:declined:",i);const l=this.autoDeclineTimers.get(i.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallDeclined?.(i)});e.push(c);const a=this.socketService.onCallEnded(i=>{console.log("[CallHandler] call:ended:",i);const l=this.autoDeclineTimers.get(i.conversationId);l&&(clearTimeout(l),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallEnded?.(i)});e.push(a);const u=this.socketService.onCallStatus(i=>{console.log("[CallHandler] call:status:",i),this.callbacks.onCallStatusUpdate?.(i.conversationId,i)});e.push(u);const s=this.socketService.onCallStatusBulk(i=>{console.log("[CallHandler] call:status:bulk:",i);for(const[l,h]of Object.entries(i.statuses))this.callbacks.onCallStatusUpdate?.(l,h)});return e.push(s),()=>{e.forEach(i=>i()),this.autoDeclineTimers.forEach(i=>clearTimeout(i)),this.autoDeclineTimers.clear()}}async handleIncomingCall(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId),o=e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",c=t?.avatarUrl;let a=!1;if(this.useNativeIncomingCallUi&&(a=await this.openIncomingCallScreen(e,o,c)),!a){const u=await this.notificationService.showIncomingCallNotification(e.conversationId,o,e.video,c);this.callNotificationIds.set(e.conversationId,u)}}catch(t){console.error("[CallHandler] Error handling incoming call:",t)}}async openIncomingCallScreen(e,t,o){if(!this.useNativeIncomingCallUi)return!1;try{return await g.showIncomingCall({conversationId:e.conversationId,callerName:t||e.from.name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",isVideo:e.video,avatarUrl:o}),!0}catch(c){return console.error("[CallHandler] Error opening incoming call screen:",c),!1}}async closeIncomingCallScreen(e){const t=this.callNotificationIds.get(e);if(t&&(await this.notificationService.cancelCallNotification(t),this.callNotificationIds.delete(e)),this.activeIncomingCalls.delete(e),r.isNativePlatform())try{await g.closeIncomingCall()}catch(o){console.error("[CallHandler] Error closing incoming call screen:",o)}}acceptCall(e,t){if(!this.activeIncomingCalls.get(e)){console.warn("[CallHandler] No active incoming call for:",e);return}const c=this.autoDeclineTimers.get(e);c&&(clearTimeout(c),this.autoDeclineTimers.delete(e)),this.socketService.emitCallAccept({conversationId:e,video:t}),this.closeIncomingCallScreen(e)}declineCall(e){const t=this.autoDeclineTimers.get(e);t&&(clearTimeout(t),this.autoDeclineTimers.delete(e)),this.socketService.emitCallDecline({conversationId:e}),this.closeIncomingCallScreen(e)}endCall(e){this.socketService.emitCallEnd({conversationId:e})}joinCallRoom(e,t){this.socketService.emitCallRoomJoin({conversationId:e,video:t})}leaveCallRoom(e){this.socketService.emitCallRoomLeave({conversationId:e})}requestCallStatuses(e){this.socketService.emitCallStatusRequest({conversationIds:e})}}typeof window<"u"&&r.isNativePlatform()?(console.log("[Capacitor] ‚úÖ Native platform detected, initializing services..."),console.log("[Capacitor] Platform:",r.getPlatform()),console.log("[Capacitor] Plugins:",r.Plugins?Object.keys(r.Plugins):"not loaded"),I().initialize().then(()=>{console.log("[Capacitor] ‚úÖ Notification service initialized successfully")}).catch(e=>{console.error("[Capacitor] ‚ùå Failed to initialize notification service:",e),console.error("[Capacitor] Error stack:",e?.stack)})):console.log("[Capacitor] Web platform detected, skipping native initialization");async function U(n,e){if(console.log("[Capacitor] initializeSocketConnection called, isNative:",r.isNativePlatform()),!r.isNativePlatform()){console.warn("[Capacitor] initializeSocketConnection called on web platform");return}console.log("[Capacitor] Creating SocketService with URL:",n);const t=k(n);console.log("[Capacitor] Connecting socket with token length:",e?.length||0),t.connect(e),console.log("[Capacitor] socketService.connect() called, now setting up lifecycle handlers"),console.log("[Capacitor] About to call setupAppLifecycleHandlers...");try{console.log("[Capacitor] Calling setupAppLifecycleHandlers now..."),await P(t),console.log("[Capacitor] ‚úÖ setupAppLifecycleHandlers completed successfully")}catch(o){console.error("[Capacitor] ‚ùå setupAppLifecycleHandlers failed:",o),console.error("[Capacitor] Error stack:",o instanceof Error?o.stack:String(o))}console.log("[Capacitor] initializeSocketConnection finished")}let v=[];async function P(n){console.log("[Capacitor] Setting up app lifecycle handlers..."),v.forEach(e=>e.remove().catch(()=>{})),v=[];try{const e=await f.addListener("appStateChange",c=>{console.log("[Capacitor] üîÑ App state changed:",c.isActive?"active":"background"),c.isActive?(console.log("[Capacitor] ‚úÖ App resumed, checking socket connection..."),setTimeout(()=>{const a=n.isConnected();console.log("[Capacitor] Socket connection status:",a),a?console.log("[Capacitor] ‚úÖ Socket already connected"):(console.log("[Capacitor] üîå Socket not connected, attempting to reconnect..."),n.reconnect())},1500)):console.log("[Capacitor] ‚è∏Ô∏è App paused, maintaining socket connection in background")});v.push(e),console.log("[Capacitor] ‚úÖ appStateChange listener registered and saved");const t=await f.addListener("resume",()=>{console.log("[Capacitor] üîÑ App resumed event received"),setTimeout(()=>{const c=n.isConnected();console.log("[Capacitor] Socket connection status after resume:",c),c?console.log("[Capacitor] ‚úÖ Socket still connected after resume"):(console.log("[Capacitor] üîå Socket not connected after resume, reconnecting..."),n.reconnect())},1500)});v.push(t),console.log("[Capacitor] ‚úÖ resume listener registered and saved");const o=await f.addListener("pause",()=>{console.log("[Capacitor] ‚è∏Ô∏è App paused event received - maintaining background connection")});v.push(o),console.log("[Capacitor] ‚úÖ pause listener registered and saved"),console.log("[Capacitor] ‚úÖ All app lifecycle handlers registered successfully (3 listeners)")}catch(e){console.error("[Capacitor] ‚ùå Failed to register app lifecycle handlers:",e)}}function _(n){if(console.log("[Capacitor] initializeMessageHandlers called, isNative:",r.isNativePlatform()),!r.isNativePlatform())return console.warn("[Capacitor] initializeMessageHandlers called on web platform"),()=>{};console.log("[Capacitor] Creating MessageHandler");const t=new M(n).initialize();return console.log("[Capacitor] ‚úÖ MessageHandler initialized"),t}function z(n){return r.isNativePlatform()?new y(n).initialize():(console.warn("[Capacitor] initializeCallHandlers called on web platform"),()=>{})}function x(n){if(!r.isNativePlatform()){console.warn("[Capacitor] updateSocketToken called on web platform");return}k().updateToken(n)}export{I as getNotificationService,k as getSocketService,z as initializeCallHandlers,_ as initializeMessageHandlers,U as initializeSocketConnection,x as updateSocketToken};
