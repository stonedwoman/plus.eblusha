const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/web-cmF1vo3c.js","assets/index-C0JN-Z03.js","assets/vendor-query-D8-W16Rz.js","assets/vendor-react-DyfnzrEv.js","assets/vendor-socket-CA1CrNgP.js","assets/vendor-crypto-C7xP7Q7Y.js","assets/index-BbyFlYpY.css","assets/web-CDF8y3Es.js","assets/incoming-call-plugin.web-DWmsuMTR.js"])))=>i.map(i=>d[i]);
import{l as N}from"./vendor-socket-CA1CrNgP.js";import{r as f,_ as v,C as l}from"./index-C0JN-Z03.js";import"./vendor-query-D8-W16Rz.js";import"./vendor-react-DyfnzrEv.js";import"./vendor-crypto-C7xP7Q7Y.js";class b{socket=null;wsUrl;accessToken=null;reconnectAttempts=0;maxReconnectAttempts=5;constructor(e){this.wsUrl=e}connect(e){if(this.socket?.connected){console.log("[SocketService] Already connected");return}this.accessToken=e,console.log("[SocketService] Connecting to:",this.wsUrl),console.log("[SocketService] Token length:",e?.length||0),this.socket=N(this.wsUrl,{autoConnect:!1,transports:["websocket","polling"],auth:{token:e},query:{token:e}}),this.setupEventHandlers(),this.socket.connect(),console.log("[SocketService] Connection initiated")}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.accessToken=null,this.reconnectAttempts=0}updateToken(e){this.accessToken=e,this.socket&&(this.socket.auth={token:e},this.socket.io.opts.query={token:e})}isConnected(){return this.socket?.connected??!1}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{console.log("[SocketService] ‚úÖ Connected successfully"),this.reconnectAttempts=0}),this.socket.on("disconnect",e=>{console.log("[SocketService] ‚ùå Disconnected:",e)}),this.socket.on("connect_error",e=>{console.error("[SocketService] ‚ùå Connection error:",e),console.error("[SocketService] Error message:",e.message),this.reconnectAttempts++,this.reconnectAttempts>=this.maxReconnectAttempts&&console.error("[SocketService] Max reconnect attempts reached")}),this.socket.io.on("reconnect_attempt",()=>{this.accessToken&&(this.socket.auth={token:this.accessToken},this.socket.io.opts.query={token:this.accessToken})}))}onMessageNew(e){return this.socket?(this.socket.on("message:new",e),()=>this.socket?.off("message:new",e)):()=>{}}onMessageNotify(e){return this.socket?(this.socket.on("message:notify",e),()=>this.socket?.off("message:notify",e)):()=>{}}onConversationTyping(e){return this.socket?(this.socket.on("conversation:typing",e),()=>this.socket?.off("conversation:typing",e)):()=>{}}onMessageReaction(e){return this.socket?(this.socket.on("message:reaction",e),()=>this.socket?.off("message:reaction",e)):()=>{}}onReceiptsUpdate(e){return this.socket?(this.socket.on("receipts:update",e),()=>this.socket?.off("receipts:update",e)):()=>{}}onConversationNew(e){return this.socket?(this.socket.on("conversations:new",e),()=>this.socket?.off("conversations:new",e)):()=>{}}onConversationUpdated(e){return this.socket?(this.socket.on("conversations:updated",e),()=>this.socket?.off("conversations:updated",e)):()=>{}}onConversationDeleted(e){return this.socket?(this.socket.on("conversations:deleted",e),()=>this.socket?.off("conversations:deleted",e)):()=>{}}onConversationMemberRemoved(e){return this.socket?(this.socket.on("conversations:member:removed",e),()=>this.socket?.off("conversations:member:removed",e)):()=>{}}onPresenceUpdate(e){return this.socket?(this.socket.on("presence:update",e),()=>this.socket?.off("presence:update",e)):()=>{}}onContactRequest(e){return this.socket?(this.socket.on("contacts:request:new",e),()=>this.socket?.off("contacts:request:new",e)):()=>{}}onContactAccepted(e){return this.socket?(this.socket.on("contacts:request:accepted",e),()=>this.socket?.off("contacts:request:accepted",e)):()=>{}}onContactRemoved(e){return this.socket?(this.socket.on("contacts:removed",e),()=>this.socket?.off("contacts:removed",e)):()=>{}}onProfileUpdate(e){return this.socket?(this.socket.on("profile:update",e),()=>this.socket?.off("profile:update",e)):()=>{}}onCallIncoming(e){return this.socket?(this.socket.on("call:incoming",e),()=>this.socket?.off("call:incoming",e)):()=>{}}onCallAccepted(e){return this.socket?(this.socket.on("call:accepted",e),()=>this.socket?.off("call:accepted",e)):()=>{}}onCallDeclined(e){return this.socket?(this.socket.on("call:declined",e),()=>this.socket?.off("call:declined",e)):()=>{}}onCallEnded(e){return this.socket?(this.socket.on("call:ended",e),()=>this.socket?.off("call:ended",e)):()=>{}}onCallStatus(e){return this.socket?(this.socket.on("call:status",e),()=>this.socket?.off("call:status",e)):()=>{}}onCallStatusBulk(e){return this.socket?(this.socket.on("call:status:bulk",e),()=>this.socket?.off("call:status:bulk",e)):()=>{}}emitConversationTyping(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:typing");return}this.socket.emit("conversation:typing",e)}emitCallInvite(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:invite");return}this.socket.emit("call:invite",e)}emitCallAccept(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:accept");return}this.socket.emit("call:accept",e)}emitCallDecline(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:decline");return}this.socket.emit("call:decline",e)}emitCallEnd(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:end");return}this.socket.emit("call:end",e)}emitCallRoomJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:join");return}this.socket.emit("call:room:join",e)}emitCallRoomLeave(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:room:leave");return}this.socket.emit("call:room:leave",e)}emitCallStatusRequest(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit call:status:request");return}this.socket.emit("call:status:request",e)}emitConversationJoin(e){if(!this.socket?.connected){console.warn("[SocketService] Socket not connected, cannot emit conversation:join");return}this.socket.emit("conversation:join",e)}}let m=null;function g(o){if(!m){if(!o)throw new Error("SocketService requires wsUrl for first initialization");m=new b(o)}return m}var p;(function(o){o[o.Sunday=1]="Sunday",o[o.Monday=2]="Monday",o[o.Tuesday=3]="Tuesday",o[o.Wednesday=4]="Wednesday",o[o.Thursday=5]="Thursday",o[o.Friday=6]="Friday",o[o.Saturday=7]="Saturday"})(p||(p={}));const k=f("LocalNotifications",{web:()=>v(()=>import("./web-cmF1vo3c.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(o=>new o.LocalNotificationsWeb)}),I=f("App",{web:()=>v(()=>import("./web-CDF8y3Es.js"),__vite__mapDeps([7,1,2,3,4,5,6])).then(o=>new o.AppWeb)}),u=f("MessageNotification",{web:()=>v(()=>import("./message-notification-plugin.web-JILA9b5W.js"),[]).then(o=>new o.MessageNotificationWeb)});class T{notificationIds=new Set;conversationNotifications=new Map;async initialize(){console.log("[NotificationService] üöÄ Initializing notification service...");const e=await k.checkPermissions();if(console.log("[NotificationService] Current permission:",e.display),e.display!=="granted"){console.log("[NotificationService] Requesting notification permission...");const t=await k.requestPermissions();if(console.log("[NotificationService] Permission result:",t.display),t.display!=="granted"){console.warn("[NotificationService] ‚ùå Notification permission not granted");return}}console.log("[NotificationService] ‚úÖ Notification permission granted"),I.addListener("appStateChange",t=>{t.isActive&&this.onAppBecameActive()})}async showMessageNotification(e,t,s,a){console.log("[NotificationService] üì® showMessageNotification called:",{conversationId:e.conversationId,messageId:e.messageId,senderId:e.senderId,messageText:t,senderName:s});const r=await I.getState();if(console.log("[NotificationService] App state:",r.isActive?"active":"background"),r.isActive){console.log("[NotificationService] App is active, skipping notification");return}const h=Date.now()%2147483647,n=e.conversationId,i=this.conversationNotifications.get(n);if(i){await this.updateConversationNotification(i,n,t||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",s||"–ö—Ç–æ-—Ç–æ",a);return}const c=s||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",d=t||"–£ –≤–∞—Å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";console.log("[NotificationService] üì§ Scheduling notification:",{notificationId:h,title:c,body:d,conversationId:n}),await this.pushNativeNotification({id:h,conversationId:n,senderId:e.senderId,messageId:e.messageId,title:c,body:d,avatarUrl:a})}async updateConversationNotification(e,t,s,a,r){await this.pushNativeNotification({id:e,conversationId:t,senderId:void 0,messageId:void 0,title:a,body:s,avatarUrl:r})}async showIncomingCallNotification(e,t,s,a){const r=Date.now()%2147483647,h=s?"–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫":"–∑–≤–æ–Ω–æ–∫";return await k.schedule({notifications:[{title:`–í—Ö–æ–¥—è—â–∏–π ${h}`,body:`${t} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`,id:r,sound:"ring.mp3",ongoing:!0,extra:{conversationId:e,callType:s?"video":"audio",callerName:t,avatarUrl:a},actionTypeId:"INCOMING_CALL"}]}),this.notificationIds.add(r),r}async cancelCallNotification(e){await u.cancel({ids:[e]}),this.notificationIds.delete(e)}async cancelConversationNotifications(e){const t=this.conversationNotifications.get(e);t&&(await u.cancel({ids:[t]}),this.notificationIds.delete(t),this.conversationNotifications.delete(e))}async clearAll(){const e=Array.from(this.notificationIds);e.length>0&&await u.cancel({ids:e}),this.notificationIds.clear(),this.conversationNotifications.clear()}handleNotificationClick(e){console.log("[NotificationService] Notification clicked:",e)}onAppBecameActive(){console.log("[NotificationService] App became active")}async pushNativeNotification(e){try{await u.show({id:e.id,conversationId:e.conversationId,senderName:e.title,messageText:e.body,avatarUrl:e.avatarUrl}),this.notificationIds.add(e.id),this.conversationNotifications.set(e.conversationId,e.id),console.log("[NotificationService] ‚úÖ Native notification shown")}catch(t){console.error("[NotificationService] ‚ùå Failed to show native notification:",t)}}}let C=null;function S(){return C||(C=new T),C}class A{socketService=g();notificationService=S();callbacks;typingTimers=new Map;constructor(e){this.callbacks=e}initialize(){console.log("[MessageHandler] üöÄ Initializing message handlers...");const e=[],t=this.socketService.onMessageNew(async n=>{console.log("[MessageHandler] üì® message:new:",n),this.callbacks.isConversationActive?.(n.conversationId)??!1?this.callbacks.onMessageReceived?.(n):this.callbacks.onConversationUpdated?.(n.conversationId)});e.push(t);const s=this.socketService.onMessageNotify(async n=>{console.log("[MessageHandler] üîî message:notify:",n);const i=this.callbacks.isConversationActive?.(n.conversationId)??!1;i||await this.handleMessageNotification(n),i&&n.message&&this.callbacks.onMessageReceived?.(n),this.callbacks.onConversationUpdated?.(n.conversationId)});e.push(s);const a=this.socketService.onConversationTyping(n=>{console.log("[MessageHandler] conversation:typing:",n);const i=`${n.conversationId}_${n.userId}`,c=this.typingTimers.get(i);if(c&&clearTimeout(c),n.typing){this.callbacks.onTypingUpdate?.(n.conversationId,n.userId,!0);const d=setTimeout(()=>{this.callbacks.onTypingUpdate?.(n.conversationId,n.userId,!1),this.typingTimers.delete(i)},2e3);this.typingTimers.set(i,d)}else this.callbacks.onTypingUpdate?.(n.conversationId,n.userId,!1),this.typingTimers.delete(i)});e.push(a);const r=this.socketService.onMessageReaction(async n=>{console.log("[MessageHandler] message:reaction:",n),this.callbacks.isConversationActive?.(n.conversationId)??!1?n.message&&this.callbacks.onMessageReceived?.(n):this.callbacks.onConversationUpdated?.(n.conversationId)});e.push(r);const h=this.socketService.onReceiptsUpdate(n=>{console.log("[MessageHandler] receipts:update:",n),this.callbacks.isConversationActive?.(n.conversationId)});return e.push(h),console.log("[MessageHandler] ‚úÖ All handlers subscribed, total:",e.length),()=>{console.log("[MessageHandler] Unsubscribing all handlers"),e.forEach(n=>n()),this.typingTimers.forEach(n=>clearTimeout(n)),this.typingTimers.clear()}}async handleMessageNotification(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId,{senderId:e.senderId,messageId:e.messageId});let s=this.getMessagePreview(e);s||(s=t?.messageText||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");const a=t?.senderName||t?.title||"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",r=t?.avatarUrl;await this.notificationService.showMessageNotification(e,s,a,r)}catch(t){console.error("[MessageHandler] Error handling message notification:",t)}}sendTyping(e,t){this.socketService.emitConversationTyping({conversationId:e,typing:t})}getMessagePreview(e){if(e.message){if(e.message.content)return e.message.content;if(e.message.attachments?.length)return e.message.attachments[0].type==="IMAGE"?"üì∑ –§–æ—Ç–æ":"üìé –í–ª–æ–∂–µ–Ω–∏–µ"}return null}}const w=f("IncomingCall",{web:()=>v(()=>import("./incoming-call-plugin.web-DWmsuMTR.js"),__vite__mapDeps([8,1,2,3,4,5,6])).then(o=>new o.IncomingCallWeb)});class M{socketService=g();notificationService=S();callbacks;activeIncomingCalls=new Map;callNotificationIds=new Map;autoDeclineTimers=new Map;constructor(e){this.callbacks=e}initialize(){const e=[],t=this.socketService.onCallIncoming(async i=>{console.log("[CallHandler] üìû call:incoming:",i),this.activeIncomingCalls.set(i.conversationId,i),await this.handleIncomingCall(i);const c=setTimeout(()=>{console.log("[CallHandler] Auto-declining call after 25 seconds"),this.declineCall(i.conversationId)},25e3);this.autoDeclineTimers.set(i.conversationId,c),this.callbacks.onIncomingCall?.(i)});e.push(t);const s=this.socketService.onCallAccepted(i=>{console.log("[CallHandler] call:accepted:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallAccepted?.(i)});e.push(s);const a=this.socketService.onCallDeclined(i=>{console.log("[CallHandler] call:declined:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallDeclined?.(i)});e.push(a);const r=this.socketService.onCallEnded(i=>{console.log("[CallHandler] call:ended:",i);const c=this.autoDeclineTimers.get(i.conversationId);c&&(clearTimeout(c),this.autoDeclineTimers.delete(i.conversationId)),this.closeIncomingCallScreen(i.conversationId),this.callbacks.onCallEnded?.(i)});e.push(r);const h=this.socketService.onCallStatus(i=>{console.log("[CallHandler] call:status:",i),this.callbacks.onCallStatusUpdate?.(i.conversationId,i)});e.push(h);const n=this.socketService.onCallStatusBulk(i=>{console.log("[CallHandler] call:status:bulk:",i);for(const[c,d]of Object.entries(i.statuses))this.callbacks.onCallStatusUpdate?.(c,d)});return e.push(n),()=>{e.forEach(i=>i()),this.autoDeclineTimers.forEach(i=>clearTimeout(i)),this.autoDeclineTimers.clear()}}async handleIncomingCall(e){try{const t=await this.callbacks.getConversationInfo?.(e.conversationId),s=await this.notificationService.showIncomingCallNotification(e.conversationId,e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",e.video,t?.avatarUrl);this.callNotificationIds.set(e.conversationId,s),await this.openIncomingCallScreen(e)}catch(t){console.error("[CallHandler] Error handling incoming call:",t)}}async openIncomingCallScreen(e){if(l.isNativePlatform())try{const t=await this.callbacks.getConversationInfo?.(e.conversationId);await w.showIncomingCall({conversationId:e.conversationId,callerName:e.from.name||t?.title||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π",isVideo:e.video,avatarUrl:t?.avatarUrl})}catch(t){console.error("[CallHandler] Error opening incoming call screen:",t)}}async closeIncomingCallScreen(e){const t=this.callNotificationIds.get(e);if(t&&(await this.notificationService.cancelCallNotification(t),this.callNotificationIds.delete(e)),this.activeIncomingCalls.delete(e),l.isNativePlatform())try{await w.closeIncomingCall()}catch(s){console.error("[CallHandler] Error closing incoming call screen:",s)}}acceptCall(e,t){if(!this.activeIncomingCalls.get(e)){console.warn("[CallHandler] No active incoming call for:",e);return}const a=this.autoDeclineTimers.get(e);a&&(clearTimeout(a),this.autoDeclineTimers.delete(e)),this.socketService.emitCallAccept({conversationId:e,video:t}),this.closeIncomingCallScreen(e)}declineCall(e){const t=this.autoDeclineTimers.get(e);t&&(clearTimeout(t),this.autoDeclineTimers.delete(e)),this.socketService.emitCallDecline({conversationId:e}),this.closeIncomingCallScreen(e)}endCall(e){this.socketService.emitCallEnd({conversationId:e})}joinCallRoom(e,t){this.socketService.emitCallRoomJoin({conversationId:e,video:t})}leaveCallRoom(e){this.socketService.emitCallRoomLeave({conversationId:e})}requestCallStatuses(e){this.socketService.emitCallStatusRequest({conversationIds:e})}}typeof window<"u"&&l.isNativePlatform()?(console.log("[Capacitor] ‚úÖ Native platform detected, initializing services..."),console.log("[Capacitor] Platform:",l.getPlatform()),console.log("[Capacitor] Plugins:",l.Plugins?Object.keys(l.Plugins):"not loaded"),S().initialize().then(()=>{console.log("[Capacitor] ‚úÖ Notification service initialized successfully")}).catch(e=>{console.error("[Capacitor] ‚ùå Failed to initialize notification service:",e),console.error("[Capacitor] Error stack:",e?.stack)})):console.log("[Capacitor] Web platform detected, skipping native initialization");function _(o,e){if(console.log("[Capacitor] initializeSocketConnection called, isNative:",l.isNativePlatform()),!l.isNativePlatform()){console.warn("[Capacitor] initializeSocketConnection called on web platform");return}console.log("[Capacitor] Creating SocketService with URL:",o);const t=g(o);console.log("[Capacitor] Connecting socket with token length:",e?.length||0),t.connect(e)}function U(o){if(console.log("[Capacitor] initializeMessageHandlers called, isNative:",l.isNativePlatform()),!l.isNativePlatform())return console.warn("[Capacitor] initializeMessageHandlers called on web platform"),()=>{};console.log("[Capacitor] Creating MessageHandler");const t=new A(o).initialize();return console.log("[Capacitor] ‚úÖ MessageHandler initialized"),t}function z(o){return l.isNativePlatform()?new M(o).initialize():(console.warn("[Capacitor] initializeCallHandlers called on web platform"),()=>{})}function q(o){if(!l.isNativePlatform()){console.warn("[Capacitor] updateSocketToken called on web platform");return}g().updateToken(o)}export{S as getNotificationService,g as getSocketService,z as initializeCallHandlers,U as initializeMessageHandlers,_ as initializeSocketConnection,q as updateSocketToken};
