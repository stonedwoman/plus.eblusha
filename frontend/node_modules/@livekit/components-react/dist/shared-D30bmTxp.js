"use strict";const U=require("react"),v=require("./shared-CVy2Ouqp.js"),M=require("./shared-DoNgw2-D.js"),f=require("livekit-client");function Ce(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:()=>e[n]})}}return t.default=e,Object.freeze(t)}const r=Ce(U),Y=r.createContext(void 0);function Se(){const e=r.useContext(Y);if(!e)throw Error("tried to access session context outside of SessionProvider component");return e}function X(){return r.useContext(Y)}function ue(e){const t=X(),n=e??t;if(!n)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");return n}function Te(e){const t=v.useEnsureRoom(e),n=r.useCallback(async()=>{await t.startAudio()},[t]),i=r.useMemo(()=>v.roomAudioPlaybackAllowedObservable(t),[t]),{canPlayAudio:d}=M.useObservableState(i,{canPlayAudio:t.canPlaybackAudio});return{canPlayAudio:d,startAudio:n}}function Ee(e){const{state:t,dispatch:n}=M.useLayoutContext().pin;return{buttonProps:r.useMemo(()=>{const{className:d}=v.setupClearPinButton();return M.mergeProps(e,{className:d,disabled:!(t!=null&&t.length),onClick:()=>{n&&n({msg:"clear_pin"})}})},[e,n,t])}}function ke(e,t){const n=typeof e=="function"?e:t,i=typeof e=="string"?e:void 0,d=v.useRoomContext(),{send:a,messageObservable:o,isSendingObservable:p}=r.useMemo(()=>v.setupDataMessageHandler(d,i,n),[d,i,n]),T=M.useObservableState(o,void 0),E=M.useObservableState(p,!1);return{message:T,send:a,isSending:E}}const ye={connect:!0,audio:!1,video:!1};function we(e){const{token:t,serverUrl:n,options:i,room:d,connectOptions:a,connect:o,audio:p,video:T,screen:E,onConnected:b,onDisconnected:m,onError:u,onMediaDeviceFailure:k,onEncryptionError:P,simulateParticipants:x,...O}={...ye,...e};i&&d&&v.log.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[A,I]=r.useState(),D=r.useRef(o);r.useEffect(()=>{I(d??new f.Room(i))},[d,JSON.stringify(i,M.roomOptionsStringifyReplacer)]);const c=r.useMemo(()=>{const{className:s}=v.setupLiveKitRoom();return M.mergeProps(O,{className:s})},[O]);return r.useEffect(()=>{if(!A)return;const s=()=>{const S=A.localParticipant;v.log.debug("trying to publish local tracks"),Promise.all([S.setMicrophoneEnabled(!!p,typeof p!="boolean"?p:void 0),S.setCameraEnabled(!!T,typeof T!="boolean"?T:void 0),S.setScreenShareEnabled(!!E,typeof E!="boolean"?E:void 0)]).catch(w=>{v.log.warn(w),u==null||u(w)})},l=(S,w)=>{const _=f.MediaDeviceFailure.getFailure(S);k==null||k(_,w)},h=S=>{P==null||P(S)},C=S=>{m==null||m(S)},y=()=>{b==null||b()};return A.on(f.RoomEvent.SignalConnected,s).on(f.RoomEvent.MediaDevicesError,l).on(f.RoomEvent.EncryptionError,h).on(f.RoomEvent.Disconnected,C).on(f.RoomEvent.Connected,y),()=>{A.off(f.RoomEvent.SignalConnected,s).off(f.RoomEvent.MediaDevicesError,l).off(f.RoomEvent.EncryptionError,h).off(f.RoomEvent.Disconnected,C).off(f.RoomEvent.Connected,y)}},[A,p,T,E,u,P,k,b,m]),r.useEffect(()=>{if(A){if(x){A.simulateParticipants({participants:{count:x},publish:{audio:!0,useRealTracks:!0}});return}if(o){if(D.current=!0,v.log.debug("connecting"),!t){v.log.debug("no token yet");return}if(!n){v.log.warn("no livekit url provided"),u==null||u(Error("no livekit url provided"));return}A.connect(n,t,a).catch(s=>{v.log.warn(s),D.current===!0&&(u==null||u(s))})}else v.log.debug("disconnecting because connect is false"),D.current=!1,A.disconnect()}},[o,t,JSON.stringify(a),A,u,n,x]),r.useEffect(()=>{if(A)return()=>{v.log.info("disconnecting on onmount"),A.disconnect()}},[A]),{room:A,htmlProps:c}}function Pe(e={}){let t=M.useMaybeParticipantContext();e.participant&&(t=e.participant);const n=r.useMemo(()=>v.participantInfoObserver(t),[t]),{identity:i,name:d,metadata:a}=M.useObservableState(n,{name:t==null?void 0:t.name,identity:t==null?void 0:t.identity,metadata:t==null?void 0:t.metadata});return{identity:i,name:d,metadata:a}}function Re(e={}){const t=M.useEnsureParticipant(e.participant),n=r.useMemo(()=>v.participantPermissionObserver(t),[t]);return M.useObservableState(n,t.permissions)}function Q(e={}){const t=v.useEnsureRoom(e.room),[n,i]=r.useState([]);return r.useEffect(()=>{const d=v.connectedParticipantsObserver(t,{additionalRoomEvents:e.updateOnlyOn}).subscribe(i);return()=>d.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn)]),n}function le(e={}){const t=Q(e),{localParticipant:n}=v.useLocalParticipant(e);return r.useMemo(()=>[n,...t],[n,t])}function Me(e,t={}){const n=v.useRoomContext(),[i]=r.useState(t.updateOnlyOn),d=r.useMemo(()=>typeof e=="string"?v.connectedParticipantObserver(n,e,{additionalEvents:i}):v.participantByIdentifierObserver(n,e,{additionalEvents:i}),[n,JSON.stringify(e),i]),[a,o]=r.useState({p:void 0});return r.useEffect(()=>{const p=d.subscribe(T=>o({p:T}));return()=>p.unsubscribe()},[d]),a.p}function Ae(e={}){const t=v.useEnsureRoom(e.room),n=r.useMemo(()=>v.roomInfoObserver(t),[t]),{name:i,metadata:d}=M.useObservableState(n,{name:t.name,metadata:t.metadata});return{name:i,metadata:d}}function fe(e){const t=v.useEnsureRoom(e==null?void 0:e.room),n=r.useMemo(()=>v.activeSpeakerObserver(t),[t]);return M.useObservableState(n,t.activeSpeakers)}function Le(e){const[t,n]=r.useState(v.sortParticipants(e)),i=fe();return r.useEffect(()=>{n(v.sortParticipants(e))},[i,e]),t}function Oe(e,t,n={}){const[i,d]=r.useState(void 0);return r.useEffect(()=>{var o;if(e===void 0)throw Error("token endpoint needs to be defined");if(((o=n.userInfo)==null?void 0:o.identity)===void 0)return;(async()=>{v.log.debug("fetching token");const p=new URLSearchParams({...n.userInfo,roomName:t}),T=await fetch(`${e}?${p.toString()}`);if(!T.ok){v.log.error(`Could not fetch token. Server responded with status ${T.status}: ${T.statusText}`);return}const{accessToken:E}=await T.json();d(E)})()},[e,t,JSON.stringify(n)]),i}function xe(e){const[t,n]=r.useState(v.getTrackByIdentifier(e)),{trackObserver:i}=r.useMemo(()=>v.setupMediaTrack(e),[e.participant.sid??e.participant.identity,e.source]);return r.useEffect(()=>{const d=i.subscribe(a=>{n(a)});return()=>d==null?void 0:d.unsubscribe()},[i]),{participant:e.participant,source:e.source??f.Track.Source.Unknown,publication:t}}function De(e,t){const n=M.useEnsureParticipant(t);return xe({name:e,participant:n})}function J(e,t={}){let n,i;typeof t=="string"?n=t:(n=t==null?void 0:t.participantIdentity,i=t==null?void 0:t.room);const d=M.useMaybeParticipantContext(),a=le({room:i,updateOnlyOn:[]}),o=r.useMemo(()=>n?a.find(E=>E.identity===n):d,[n,a,d]),p=r.useMemo(()=>{if(o)return v.participantTracksObservable(o,{sources:e})},[o,JSON.stringify(e)]);return M.useObservableState(p,[])}function _e(e){var n,i,d;const t=r.useMemo(()=>{var a;return(a=e==null?void 0:e.publication)!=null&&a.track?v.trackSyncTimeObserver(e==null?void 0:e.publication.track):void 0},[(n=e==null?void 0:e.publication)==null?void 0:n.track]);return M.useObservableState(t,{timestamp:Date.now(),rtpTimestamp:(d=(i=e==null?void 0:e.publication)==null?void 0:i.track)==null?void 0:d.rtpTimestamp})}const Ne={bufferSize:100};function de(e,t){const n={...Ne,...t},[i,d]=r.useState([]),a=_e(e),o=p=>{var T;(T=n.onTranscription)==null||T.call(n,p),d(E=>v.dedupeSegments(E,p.map(b=>v.addMediaTimestampToTranscription(b,a)),n.bufferSize))};return r.useEffect(()=>{if(!(e!=null&&e.publication))return;const p=v.trackTranscriptionObserver(e.publication).subscribe(T=>{o(...T)});return()=>{p.unsubscribe()}},[e&&v.getTrackReferenceId(e),o]),{segments:i}}function me(e={}){const t=M.useMaybeParticipantContext(),n=e.participant??t,i=r.useMemo(()=>v.participantAttributesObserver(n),[n]);return M.useObservableState(i,{attributes:n==null?void 0:n.attributes})}function Ie(e,t={}){const n=M.useEnsureParticipant(t.participant),[i,d]=r.useState(n.attributes[e]);return r.useEffect(()=>{if(!n)return;const a=v.participantAttributesObserver(n).subscribe(o=>{o.changed[e]!==void 0&&d(o.attributes[e])});return()=>{a.unsubscribe()}},[n,e]),i}const re=v.ParticipantAgentAttributes.AgentState;function Fe(){const e=Q(),t=e.find(m=>m.kind===f.ParticipantKind.AGENT&&!(v.ParticipantAgentAttributes.PublishOnBehalf in m.attributes)),n=e.find(m=>m.kind===f.ParticipantKind.AGENT&&m.attributes[v.ParticipantAgentAttributes.PublishOnBehalf]===(t==null?void 0:t.identity)),i=J([f.Track.Source.Microphone,f.Track.Source.Camera],t==null?void 0:t.identity),d=J([f.Track.Source.Microphone,f.Track.Source.Camera],n==null?void 0:n.identity),a=i.find(m=>m.source===f.Track.Source.Microphone)??d.find(m=>m.source===f.Track.Source.Microphone),o=i.find(m=>m.source===f.Track.Source.Camera)??d.find(m=>m.source===f.Track.Source.Camera),{segments:p}=de(a),T=M.useConnectionState(),{attributes:E}=me({participant:t}),b=r.useMemo(()=>T===f.ConnectionState.Disconnected?"disconnected":T===f.ConnectionState.Connecting||!t||!(E!=null&&E[re])?"connecting":E[re],[E,t,T]);return{agent:t,state:b,audioTrack:a,videoTrack:o,agentTranscriptions:p,agentAttributes:E}}function Ue(e){const t=v.useEnsureRoom(e),n=M.useConnectionState(t),i=r.useMemo(()=>v.recordingStatusObservable(t),[t,n]);return M.useObservableState(i,t.isRecording)}function pe(e,t){const n=v.useEnsureRoom(t==null?void 0:t.room),d=M.useConnectionState(n)===f.ConnectionState.Disconnected,a=r.useMemo(()=>v.setupTextStream(n,e),[n,e]),o=d?void 0:a;return{textStreams:M.useObservableState(o,[])}}function he(e){const{participantIdentities:t,trackSids:n}=e??{},{textStreams:i}=pe(v.DataTopic.TRANSCRIPTION,{room:e==null?void 0:e.room});return r.useMemo(()=>i.filter(a=>t?t.includes(a.participantInfo.identity):!0).filter(a=>{var o;return n?n.includes(((o=a.streamInfo.attributes)==null?void 0:o[v.ParticipantAgentAttributes.TranscribedTrackId])??""):!0}),[i,t,n])}const oe=2,se=400,ie=3,ce=1e3;function je(e){const t=U.useRef([]),n=U.useMemo(()=>new f.Mutex,[]),i=U.useCallback(async()=>n.lock().then(async b=>{for(;;){const m=t.current.pop();if(!m){b();break}switch(m.type){case"connect":await m.room.connect(...m.args).then(m.resolve).catch(m.reject);break;case"disconnect":await m.room.disconnect(...m.args).then(m.resolve).catch(m.reject);break}}}),[]),d=U.useRef([]),a=U.useCallback(b=>{let m=0;d.current=d.current.filter(u=>{const k=b.getTime()-u.getTime()<ce;return k&&(m+=1),k}),m>ie&&v.log.warn(`useSequentialRoomConnectDisconnect: room changed reference rapidly (over ${ie}x in ${ce}ms). This is not recommended.`)},[]);U.useEffect(()=>{t.current=[];const b=new Date;d.current.push(b),a(b)},[e,a]);const o=U.useRef([]),p=U.useCallback(b=>{let m=0;o.current=o.current.filter(u=>{const k=b.getTime()-u.getTime()<se;return k&&(m+=1),k}),m>oe&&v.log.warn(`useSequentialRoomConnectDisconnect: room connect / disconnect occurring in rapid sequence (over ${oe}x in ${se}ms). This is not recommended and may be the sign of a bug like a useEffect dependency changing every render.`)},[]),T=U.useCallback(async(...b)=>new Promise((m,u)=>{if(!e)throw new Error("Called connect(), but room was unset");const k=new Date;p(k),t.current.push({type:"connect",room:e,args:b,resolve:m,reject:u}),o.current.push(k),i()}),[e,p,i]),E=U.useCallback(async(...b)=>new Promise((m,u)=>{if(!e)throw new Error("Called discconnect(), but room was unset");const k=new Date;p(k),t.current.push({type:"disconnect",room:e,args:b,resolve:m,reject:u}),o.current.push(k),i()}),[e,p,i]);return{connect:e?T:null,disconnect:e?E:null}}var V={exports:{}},ae;function He(){if(ae)return V.exports;ae=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(s,l,h){return Function.prototype.apply.call(s,l,h)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:n=function(s){return Object.getOwnPropertyNames(s)};function i(c){console&&console.warn&&console.warn(c)}var d=Number.isNaN||function(s){return s!==s};function a(){a.init.call(this)}V.exports=a,V.exports.once=A,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var o=10;function p(c){if(typeof c!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof c)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(c){if(typeof c!="number"||c<0||d(c))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+c+".");o=c}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||d(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function T(c){return c._maxListeners===void 0?a.defaultMaxListeners:c._maxListeners}a.prototype.getMaxListeners=function(){return T(this)},a.prototype.emit=function(s){for(var l=[],h=1;h<arguments.length;h++)l.push(arguments[h]);var C=s==="error",y=this._events;if(y!==void 0)C=C&&y.error===void 0;else if(!C)return!1;if(C){var S;if(l.length>0&&(S=l[0]),S instanceof Error)throw S;var w=new Error("Unhandled error."+(S?" ("+S.message+")":""));throw w.context=S,w}var _=y[s];if(_===void 0)return!1;if(typeof _=="function")t(_,this,l);else for(var j=_.length,q=P(_,j),h=0;h<j;++h)t(q[h],this,l);return!0};function E(c,s,l,h){var C,y,S;if(p(l),y=c._events,y===void 0?(y=c._events=Object.create(null),c._eventsCount=0):(y.newListener!==void 0&&(c.emit("newListener",s,l.listener?l.listener:l),y=c._events),S=y[s]),S===void 0)S=y[s]=l,++c._eventsCount;else if(typeof S=="function"?S=y[s]=h?[l,S]:[S,l]:h?S.unshift(l):S.push(l),C=T(c),C>0&&S.length>C&&!S.warned){S.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+S.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning",w.emitter=c,w.type=s,w.count=S.length,i(w)}return c}a.prototype.addListener=function(s,l){return E(this,s,l,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(s,l){return E(this,s,l,!0)};function b(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(c,s,l){var h={fired:!1,wrapFn:void 0,target:c,type:s,listener:l},C=b.bind(h);return C.listener=l,h.wrapFn=C,C}a.prototype.once=function(s,l){return p(l),this.on(s,m(this,s,l)),this},a.prototype.prependOnceListener=function(s,l){return p(l),this.prependListener(s,m(this,s,l)),this},a.prototype.removeListener=function(s,l){var h,C,y,S,w;if(p(l),C=this._events,C===void 0)return this;if(h=C[s],h===void 0)return this;if(h===l||h.listener===l)--this._eventsCount===0?this._events=Object.create(null):(delete C[s],C.removeListener&&this.emit("removeListener",s,h.listener||l));else if(typeof h!="function"){for(y=-1,S=h.length-1;S>=0;S--)if(h[S]===l||h[S].listener===l){w=h[S].listener,y=S;break}if(y<0)return this;y===0?h.shift():x(h,y),h.length===1&&(C[s]=h[0]),C.removeListener!==void 0&&this.emit("removeListener",s,w||l)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(s){var l,h,C;if(h=this._events,h===void 0)return this;if(h.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):h[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete h[s]),this;if(arguments.length===0){var y=Object.keys(h),S;for(C=0;C<y.length;++C)S=y[C],S!=="removeListener"&&this.removeAllListeners(S);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(l=h[s],typeof l=="function")this.removeListener(s,l);else if(l!==void 0)for(C=l.length-1;C>=0;C--)this.removeListener(s,l[C]);return this};function u(c,s,l){var h=c._events;if(h===void 0)return[];var C=h[s];return C===void 0?[]:typeof C=="function"?l?[C.listener||C]:[C]:l?O(C):P(C,C.length)}a.prototype.listeners=function(s){return u(this,s,!0)},a.prototype.rawListeners=function(s){return u(this,s,!1)},a.listenerCount=function(c,s){return typeof c.listenerCount=="function"?c.listenerCount(s):k.call(c,s)},a.prototype.listenerCount=k;function k(c){var s=this._events;if(s!==void 0){var l=s[c];if(typeof l=="function")return 1;if(l!==void 0)return l.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function P(c,s){for(var l=new Array(s),h=0;h<s;++h)l[h]=c[h];return l}function x(c,s){for(;s+1<c.length;s++)c[s]=c[s+1];c.pop()}function O(c){for(var s=new Array(c.length),l=0;l<s.length;++l)s[l]=c[l].listener||c[l];return s}function A(c,s){return new Promise(function(l,h){function C(S){c.removeListener(s,y),h(S)}function y(){typeof c.removeListener=="function"&&c.removeListener("error",C),l([].slice.call(arguments))}D(c,s,y,{once:!0}),s!=="error"&&I(c,C,{once:!0})})}function I(c,s,l){typeof c.on=="function"&&D(c,"error",s,l)}function D(c,s,l,h){if(typeof c.on=="function")h.once?c.once(s,l):c.on(s,l);else if(typeof c.addEventListener=="function")c.addEventListener(s,function C(y){h.once&&c.removeEventListener(s,C),l(y)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof c)}return V.exports}var Z=He();const Be=2e4;var be=(e=>(e.CameraChanged="cameraChanged",e.MicrophoneChanged="microphoneChanged",e.StateChanged="stateChanged",e))(be||{});const F=e=>({isConnected:e==="listening"||e==="thinking"||e==="speaking",canListen:e==="pre-connect-buffering"||e==="listening"||e==="thinking"||e==="speaking",isFinished:e==="disconnected"||e==="failed",isPending:e==="connecting"||e==="initializing"||e==="idle"}),We=()=>{const[e,t]=r.useState(null),[n,i]=r.useState(null),d=r.useRef("connecting"),a=r.useRef(!1),o=p=>setTimeout(()=>{if(!a.current){t("Agent did not join the room.");return}const{isConnected:T}=F(d.current);if(!T){t("Agent joined the room but did not complete initializing.");return}},p??Be);return{agentTimeoutFailureReason:e,startAgentTimeout:r.useCallback(p=>{n&&clearTimeout(n),t(null),i(o(p)),d.current="connecting",a.current=!1},[n]),clearAgentTimeout:r.useCallback(()=>{n&&clearTimeout(n),t(null),i(null),d.current="connecting",a.current=!1},[n]),clearAgentTimeoutFailureReason:r.useCallback(()=>{t(null)},[]),updateAgentTimeoutState:r.useCallback(p=>{d.current=p},[]),updateAgentTimeoutParticipantExists:r.useCallback(p=>{a.current=p},[])}};function qe(e,t){const n=r.useRef(t);r.useEffect(()=>{n.current=t},[t]);const i=r.useCallback(async o=>{const{isConnected:p}=F(n.current);if(!p)return new Promise((T,E)=>{const b=k=>{const{isConnected:P}=F(k);P&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilConnected - signal aborted"))},u=()=>{e.off("stateChanged",b),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",b),o==null||o.addEventListener("abort",m)})},[e]),d=r.useCallback(async o=>{const{canListen:p}=F(n.current);if(!p)return new Promise((T,E)=>{const b=k=>{const{canListen:P}=F(k);P&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilCouldBeListening - signal aborted"))},u=()=>{e.off("stateChanged",b),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",b),o==null||o.addEventListener("abort",m)})},[e]),a=r.useCallback(async o=>{const{isFinished:p}=F(n.current);if(!p)return new Promise((T,E)=>{const b=k=>{const{isFinished:P}=F(k);P&&(u(),T())},m=()=>{u(),E(new Error("useAgent(/* ... */).waitUntilFinished - signal aborted"))},u=()=>{e.off("stateChanged",b),o==null||o.removeEventListener("abort",m)};e.on("stateChanged",b),o==null||o.addEventListener("abort",m)})},[e]);return{waitUntilConnected:i,waitUntilCouldBeListening:d,waitUntilFinished:a}}function ee(e){const t=X();if(e=e??t,!e)throw new Error("No session provided, make sure you are inside a Session context or pass the session explicitly");const{room:n,internal:{agentConnectTimeoutMilliseconds:i,agentTimeoutFailureReason:d,startAgentTimeout:a,clearAgentTimeout:o,clearAgentTimeoutFailureReason:p,updateAgentTimeoutState:T,updateAgentTimeoutParticipantExists:E}}=e,b=r.useMemo(()=>new Z.EventEmitter,[]),m=Q({room:n}),u=r.useMemo(()=>m.find(g=>g.kind===f.ParticipantKind.AGENT&&!(v.ParticipantAgentAttributes.PublishOnBehalf in g.attributes))??null,[m]),k=r.useMemo(()=>u?m.find(g=>g.kind===f.ParticipantKind.AGENT&&g.attributes[v.ParticipantAgentAttributes.PublishOnBehalf]===u.identity)??null:null,[u,m]),[P,x]=r.useState({});r.useEffect(()=>{if(!u)return;const g=N=>{x(N)};return u.on(f.ParticipantEvent.AttributesChanged,g),()=>{u.off(f.ParticipantEvent.AttributesChanged,g)}},[u,b]);const O=J([f.Track.Source.Camera,f.Track.Source.Microphone],{room:n,participantIdentity:u==null?void 0:u.identity}),A=J([f.Track.Source.Camera,f.Track.Source.Microphone],{room:n,participantIdentity:k==null?void 0:k.identity}),I=r.useMemo(()=>O.find(g=>g.source===f.Track.Source.Camera)??A.find(g=>g.source===f.Track.Source.Camera),[O,A]);r.useEffect(()=>{b.emit("cameraChanged",I)},[b,I]);const D=r.useMemo(()=>O.find(g=>g.source===f.Track.Source.Microphone)??A.find(g=>g.source===f.Track.Source.Microphone),[O,A]);r.useEffect(()=>{b.emit("microphoneChanged",D)},[b,D]);const[c,s]=r.useState(n.state);r.useEffect(()=>{const g=N=>{s(N)};return n.on(f.RoomEvent.ConnectionStateChanged,g),()=>{n.off(f.RoomEvent.ConnectionStateChanged,g)}},[n]),r.useEffect(()=>{u&&p()},[u]);const[l,h]=r.useState(null);r.useEffect(()=>{if(!u)return;const g=N=>{N.identity===(u==null?void 0:u.identity)&&h("Agent left the room unexpectedly.")};return n.on(f.RoomEvent.ParticipantDisconnected,g),()=>{n.off(f.RoomEvent.ParticipantDisconnected,g)}},[u,n]),r.useEffect(()=>{c===f.ConnectionState.Disconnected&&h(null)},[c]);const[C,y]=r.useState(()=>n.localParticipant.getTrackPublication(f.Track.Source.Microphone)??null);r.useEffect(()=>{const g=()=>{y(n.localParticipant.getTrackPublication(f.Track.Source.Microphone)??null)},N=()=>{y(null)};return n.localParticipant.on(f.ParticipantEvent.LocalTrackPublished,g),n.localParticipant.on(f.ParticipantEvent.LocalTrackUnpublished,N),()=>{n.localParticipant.off(f.ParticipantEvent.LocalTrackPublished,g),n.localParticipant.off(f.ParticipantEvent.LocalTrackUnpublished,N)}},[n.localParticipant]);const S=r.useMemo(()=>{const g=[];return d&&g.push(d),l&&g.push(l),g},[d,l]),w=r.useMemo(()=>{if(S.length>0)return"failed";let g="disconnected";return c!==f.ConnectionState.Disconnected&&(g="connecting"),C&&(g="pre-connect-buffering"),u&&P[v.ParticipantAgentAttributes.AgentState]&&(g=P[v.ParticipantAgentAttributes.AgentState]),g},[S,c,C,u,P]);r.useEffect(()=>{b.emit("stateChanged",w),T(w)},[b,w]),r.useEffect(()=>{E(u!==null)},[u]);const _=e.connectionState==="disconnected";r.useEffect(()=>{if(!_)return a(i),()=>{o()}},[_,i]);const j=r.useMemo(()=>{const g={attributes:P,internal:{agentParticipant:u,workerParticipant:k,emitter:b}};switch(w){case"disconnected":return{...g,state:w,...F(w),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"connecting":return{...g,state:w,...F(w),failureReasons:null,cameraTrack:void 0,microphoneTrack:void 0};case"initializing":case"idle":return{...g,state:w,...F(w),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"pre-connect-buffering":return{...g,state:w,...F(w),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"listening":case"thinking":case"speaking":return{...g,state:w,...F(w),failureReasons:null,cameraTrack:I,microphoneTrack:D};case"failed":return{...g,state:"failed",...F("failed"),failureReasons:S,cameraTrack:void 0,microphoneTrack:void 0}}},[P,b,u,w,I,D]),{waitUntilConnected:q,waitUntilCouldBeListening:K,waitUntilFinished:R}=qe(b,w),L=r.useCallback(g=>new Promise((N,$)=>{const H=W=>{W&&(G(),N(W))},B=()=>{G(),$(new Error("useAgent(/* ... */).waitUntilCamera - signal aborted"))},G=()=>{b.off("cameraChanged",H),g==null||g.removeEventListener("abort",B)};b.on("cameraChanged",H),g==null||g.addEventListener("abort",B)}),[b]),z=r.useCallback(g=>new Promise((N,$)=>{const H=W=>{W&&(G(),N(W))},B=()=>{G(),$(new Error("useAgent(/* ... */).waitUntilMicrophone - signal aborted"))},G=()=>{b.off("microphoneChanged",H),g==null||g.removeEventListener("abort",B)};b.on("microphoneChanged",H),g==null||g.addEventListener("abort",B)}),[b]);return r.useMemo(()=>({...j,waitUntilConnected:q,waitUntilCouldBeListening:K,waitUntilFinished:R,waitUntilCamera:L,waitUntilMicrophone:z}),[j,q,K,R,L,z])}var ve=(e=>(e.ConnectionStateChanged="connectionStateChanged",e.MediaDevicesError="mediaDevicesError",e.EncryptionError="encryptionError",e))(ve||{});function Ge(e,t){const n=new Set([...Object.keys(e),...Object.keys(t)]);for(const i of n)switch(i){case"roomName":case"participantName":case"participantIdentity":case"participantMetadata":case"participantAttributes":case"agentName":case"agentMetadata":if(e[i]!==t[i])return!1;break;default:const d=i;throw new Error(`Options key ${d} not being checked for equality!`)}return!0}function Ke(e,t){const n=r.useRef(t);return r.useEffect(()=>{n.current=t},[t]),r.useCallback(async(d,a)=>{if(n.current!==d)return new Promise((o,p)=>{const T=m=>{m===d&&(b(),o())},E=()=>{b(),p(new Error(`useSession(/* ... */).waitUntilConnectionState(${d}, /* signal */) - signal aborted`))},b=()=>{e.off("connectionStateChanged",T),a==null||a.removeEventListener("abort",E)};e.on("connectionStateChanged",T),a==null||a.addEventListener("abort",E)})},[e])}function $e(e,t){const n=e instanceof f.TokenSourceConfigurable,i=r.useRef(n?t:null);return r.useEffect(()=>{if(!n){i.current=null;return}i.current!==null&&Ge(i.current,t)||(i.current=t)},[n,t]),r.useCallback(async()=>{if(n){if(!i.current)throw new Error("AgentSession - memoized token fetch options are not set, but the passed tokenSource was an instance of TokenSourceConfigurable. If you are seeing this please make a new GitHub issue!");return e.fetch(i.current)}else return e.fetch()},[n,e])}function ze(e,t={}){const{room:n,agentConnectTimeoutMilliseconds:i,...d}=t,a=v.useMaybeRoomContext(),o=r.useMemo(()=>a??n??new f.Room,[a,n]),p=r.useMemo(()=>new Z.EventEmitter,[]),T=r.useCallback(R=>({isConnected:R===f.ConnectionState.Connected||R===f.ConnectionState.Reconnecting||R===f.ConnectionState.SignalReconnecting}),[]),[E,b]=r.useState(o.state);r.useEffect(()=>{const R=L=>{b(L)};return o.on(f.RoomEvent.ConnectionStateChanged,R),()=>{o.off(f.RoomEvent.ConnectionStateChanged,R)}},[o]),r.useEffect(()=>{const R=async L=>{p.emit("mediaDevicesError",L)};return o.on(f.RoomEvent.MediaDevicesError,R),()=>{o.off(f.RoomEvent.MediaDevicesError,R)}},[o,p]),r.useEffect(()=>{const R=async L=>{p.emit("encryptionError",L)};return o.on(f.RoomEvent.EncryptionError,R),()=>{o.off(f.RoomEvent.EncryptionError,R)}},[o,p]);const{localParticipant:m}=v.useLocalParticipant({room:o}),u=m.getTrackPublication(f.Track.Source.Camera),k=r.useMemo(()=>!u||u.isMuted?null:{source:f.Track.Source.Camera,participant:m,publication:u},[m,u,u==null?void 0:u.isMuted]),P=m.getTrackPublication(f.Track.Source.Microphone),x=r.useMemo(()=>!P||P.isMuted?null:{source:f.Track.Source.Microphone,participant:m,publication:P},[m,P,P==null?void 0:P.isMuted]),{agentTimeoutFailureReason:O,startAgentTimeout:A,clearAgentTimeout:I,clearAgentTimeoutFailureReason:D,updateAgentTimeoutState:c,updateAgentTimeoutParticipantExists:s}=We(),l=r.useMemo(()=>({emitter:p,tokenSource:e,agentConnectTimeoutMilliseconds:i,agentTimeoutFailureReason:O,startAgentTimeout:A,clearAgentTimeout:I,clearAgentTimeoutFailureReason:D,updateAgentTimeoutState:c,updateAgentTimeoutParticipantExists:s}),[p,i,e,O,A,I,D,c,s]),h=r.useMemo(()=>{const R={room:o,internal:l};switch(E){case f.ConnectionState.Connecting:return{...R,connectionState:f.ConnectionState.Connecting,...T(f.ConnectionState.Connecting),local:{cameraTrack:null,microphoneTrack:null}};case f.ConnectionState.Connected:case f.ConnectionState.Reconnecting:case f.ConnectionState.SignalReconnecting:return{...R,connectionState:E,...T(E),local:{cameraTrack:k,microphoneTrack:x}};case f.ConnectionState.Disconnected:return{...R,connectionState:f.ConnectionState.Disconnected,...T(f.ConnectionState.Disconnected),local:{cameraTrack:null,microphoneTrack:null}}}},[l,o,E,k,x,T]);r.useEffect(()=>{p.emit("connectionStateChanged",h.connectionState)},[p,h.connectionState]);const C=Ke(p,h.connectionState),y=r.useCallback(async R=>C(f.ConnectionState.Connected,R),[C]),S=r.useCallback(async R=>C(f.ConnectionState.Disconnected,R),[C]),w=ee(r.useMemo(()=>({connectionState:h.connectionState,room:o,internal:l}),[h,o,l])),_=$e(e,d),j=r.useCallback(async(R={})=>{var H,B;const{signal:L,tracks:z={microphone:{enabled:!0,publishOptions:{preConnectBuffer:!0}}},roomConnectOptions:g}=R;await S(L);const N=()=>{o.disconnect()};L==null||L.addEventListener("abort",N);let $=!1;await Promise.all([_().then(({serverUrl:G,participantToken:W})=>{var te,ne;return $=(((ne=(te=f.decodeTokenPayload(W).roomConfig)==null?void 0:te.agents)==null?void 0:ne.length)??0)>0,o.connect(G,W,g)}),(H=z.microphone)!=null&&H.enabled?o.localParticipant.setMicrophoneEnabled(!0,void 0,((B=z.microphone)==null?void 0:B.publishOptions)??{}):Promise.resolve()]),await y(L),$&&await w.waitUntilConnected(L),L==null||L.removeEventListener("abort",N)},[o,S,_,y,w.waitUntilConnected]),q=r.useCallback(async()=>{await o.disconnect()},[o]),K=r.useCallback(async()=>{const R=await _();await o.prepareConnection(R.serverUrl,R.participantToken)},[_,o]);return r.useEffect(()=>{K().catch(R=>{console.warn("WARNING: Room.prepareConnection failed:",R)})},[]),r.useMemo(()=>({...h,waitUntilConnected:y,waitUntilDisconnected:S,prepareConnection:K,start:j,end:q}),[h,y,S,K,j,q])}function Je(e,t,n,i){const d=r.useMemo(()=>()=>{},[]),a=r.useCallback(n??d,i??[]),o=i?a:n,p=r.useMemo(()=>e?"internal"in e?e.internal.emitter:e:null,[e]);r.useEffect(()=>{if(!(!p||!o))return p.on(t,o),()=>{p.off(t,o)}},[p,t,o])}var ge=(e=>(e.MessageReceived="messageReceived",e))(ge||{});function Ve(e){const{room:t}=ue(e),n=r.useMemo(()=>new Z.EventEmitter,[]),i=ee(e),d=he({room:t}),a=r.useMemo(()=>({room:t}),[t]),o=M.useChat(a),p=r.useMemo(()=>d.map(u=>{var k,P,x;switch(u.participantInfo.identity){case t.localParticipant.identity:return{type:"userTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:t.localParticipant};case((k=i.internal.agentParticipant)==null?void 0:k.identity):case((P=i.internal.workerParticipant)==null?void 0:P.identity):return{type:"agentTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:((x=i.internal.agentParticipant)==null?void 0:x.identity)===u.participantInfo.identity?i.internal.agentParticipant:i.internal.workerParticipant};default:return{type:"agentTranscript",message:u.text,id:u.streamInfo.id,timestamp:u.streamInfo.timestamp,from:Array.from(t.remoteParticipants.values()).find(O=>O.identity===u.participantInfo.identity)}}}),[d,t]),T=r.useMemo(()=>[...p,...o.chatMessages],[p,o.chatMessages]),E=r.useRef(new Map),b=r.useMemo(()=>{const u=new Date;for(const k of T)E.current.has(k.id)||E.current.set(k.id,u);return T.sort((k,P)=>{const x=E.current.get(k.id),O=E.current.get(P.id);return typeof x>"u"||typeof O>"u"?0:x.getTime()-O.getTime()})},[T]),m=r.useRef(new Set);return r.useEffect(()=>{for(const u of b)m.current.has(u.id)||(m.current.add(u.id),n.emit("messageReceived",u))},[b]),r.useMemo(()=>({messages:b,send:o.send,isSending:o.isSending,internal:{emitter:n}}),[b,o.send,o.isSending])}exports.AgentEvent=be;exports.MessagesEvent=ge;exports.SessionContext=Y;exports.SessionEvent=ve;exports.useAgent=ee;exports.useAudioPlayback=Te;exports.useClearPinButton=Ee;exports.useDataChannel=ke;exports.useEnsureSession=ue;exports.useEvents=Je;exports.useIsRecording=Ue;exports.useLiveKitRoom=we;exports.useMaybeSessionContext=X;exports.useParticipantAttribute=Ie;exports.useParticipantAttributes=me;exports.useParticipantInfo=Pe;exports.useParticipantPermissions=Re;exports.useParticipantTracks=J;exports.useParticipants=le;exports.useRemoteParticipant=Me;exports.useRemoteParticipants=Q;exports.useRoomInfo=Ae;exports.useSequentialRoomConnectDisconnect=je;exports.useSession=ze;exports.useSessionContext=Se;exports.useSessionMessages=Ve;exports.useSortedParticipants=Le;exports.useSpeakingParticipants=fe;exports.useTextStream=pe;exports.useToken=Oe;exports.useTrackByName=De;exports.useTrackTranscription=de;exports.useTranscriptions=he;exports.useVoiceAssistant=Fe;
//# sourceMappingURL=shared-D30bmTxp.js.map
